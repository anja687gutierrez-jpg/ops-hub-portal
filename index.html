

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA STAP Operations Portal - Secure</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tesseract.js for OCR (Text Recognition) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <!-- PDF.js for PDF parsing and rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Leaflet Map (FREE - OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- jsPDF for PDF Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Shared Base Styles */
        body { margin: 0; background-color: #f9fafb; font-family: 'Inter', sans-serif; overflow-x: hidden; } /* bg-gray-50 equivalent */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile fallback background when Three.js fails */
        .login-fallback-bg {
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
            position: absolute;
            inset: 0;
            z-index: -1;
        }
        .login-fallback-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        }
        
        /* --- LOGIN SPECIFIC STYLES --- */
        .ghost-panel {
            background: rgba(15, 23, 42, 0.15);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .ghost-panel:hover {
            background: rgba(15, 23, 42, 0.25);
            border-color: rgba(56, 189, 248, 0.2);
        }
        .input-ghost {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }
        .input-ghost:focus {
            border-bottom-color: #38bdf8;
            background: linear-gradient(to bottom, transparent, rgba(56, 189, 248, 0.05));
            outline: none;
        }
        .input-ghost::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        .btn-modern {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: #38bdf8;
            position: relative; overflow: hidden;
            transition: all 0.3s ease;
        }
        .btn-modern:hover {
            background: rgba(56, 189, 248, 0.2);
            border-color: #38bdf8;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
            color: white;
        }
        .animate-float { animation: float 8s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        /* --- DASHBOARD SPECIFIC ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        
        /* AI Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .ai-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f3f4f6 4%, #e5e7eb 25%, #f3f4f6 36%);
            background-size: 1000px 100%;
        }
        
        /* Sidebar responsive margin classes */
        @media (min-width: 768px) {
            .main-content-expanded { margin-left: 320px; }
            .main-content-collapsed { margin-left: 64px; }
        }
        
        /* Custom Scrollbar Styling for Tables */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Always show scrollbar for table containers with max-height */
        .max-h-\[600px\].overflow-y-auto,
        .max-h-\[500px\].overflow-y-auto,
        .max-h-\[400px\].overflow-y-auto,
        .max-h-\[350px\].overflow-y-auto,
        .max-h-\[300px\].overflow-y-auto,
        .max-h-96.overflow-y-auto {
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- External Component Modules (use React.createElement, no Babel needed) -->
    <!-- CRITICAL: icon.js must load FIRST - other modules depend on window.STAP_Icon -->
    <script src="icon.js"></script>
    <script src="demo.js"></script>
    <script src="impressionsDashboard.js"></script>

    <!-- Async Module Loader with Resilience -->
    <script>
        window.STAPModuleLoader = {
            loaded: {},
            pending: {},

            // Load a script with timeout and retry
            loadScript: function(src, timeout, retries) {
                timeout = timeout || 5000;
                retries = retries || 2;
                var self = this;

                if (this.loaded[src]) return Promise.resolve();
                if (this.pending[src]) return this.pending[src];

                this.pending[src] = new Promise(function(resolve, reject) {
                    var attempts = 0;

                    function tryLoad() {
                        attempts++;
                        var script = document.createElement('script');
                        var timer = setTimeout(function() {
                            script.remove();
                            if (attempts < retries) {
                                console.warn('‚è±Ô∏è Script timeout, retrying:', src, '(attempt ' + attempts + ')');
                                tryLoad();
                            } else {
                                reject(new Error('Script load timeout: ' + src));
                            }
                        }, timeout);

                        script.onload = function() {
                            clearTimeout(timer);
                            self.loaded[src] = true;
                            console.log('‚úÖ Module loaded:', src);
                            resolve();
                        };

                        script.onerror = function() {
                            clearTimeout(timer);
                            if (attempts < retries) {
                                console.warn('‚ùå Script error, retrying:', src);
                                tryLoad();
                            } else {
                                reject(new Error('Script load failed: ' + src));
                            }
                        };

                        script.src = src + '?v=' + Date.now(); // Cache bust on retry
                        document.head.appendChild(script);
                    }

                    tryLoad();
                });

                return this.pending[src];
            },

            // Wait for a window export with polling
            waitForExport: function(exportName, timeout) {
                timeout = timeout || 3000;
                return new Promise(function(resolve, reject) {
                    var start = Date.now();
                    function check() {
                        if (window[exportName]) {
                            resolve(window[exportName]);
                        } else if (Date.now() - start > timeout) {
                            reject(new Error('Export not found: ' + exportName));
                        } else {
                            setTimeout(check, 50);
                        }
                    }
                    check();
                });
            }
        };

        // Pre-check module availability for debugging
        window.addEventListener('load', function() {
            var modules = ['STAP_Icon', 'STAP_ProductionIcon', 'STAPImpressions', 'STAPDemo'];
            modules.forEach(function(m) {
                if (window[m]) {
                    console.log('‚úÖ ' + m + ' available');
                } else {
                    console.warn('‚ö†Ô∏è ' + m + ' not loaded - using fallback');
                }
            });
        });
    </script>

    <!-- External JSX Components (compiled by Babel) -->
    <script type="text/babel" src="availability.js" data-presets="react"></script>
    <script type="text/babel" src="canvasGearSidebar.js" data-presets="react"></script>
    <script type="text/babel" src="detailModal.js" data-presets="react"></script>
    <!-- digestModal.js is lazy-loaded on demand - see loadDigestModal() -->
    <script type="text/babel" src="riskCommandCenter.js" data-presets="react"></script>
    <script type="text/babel" src="materialReceivers.js" data-presets="react"></script>
    <script type="text/babel" src="popGallery.js" data-presets="react"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        // üîí SECURITY: Credentials
        const ACCESS_EMAIL = "admin@vectormedia.com";
        const ACCESS_PASSWORD = "secret123";

        // --- PDF REPORT GENERATION UTILITIES ---
        // Strip emojis and special characters for clean export
        const stripEmojis = (str) => {
            if (typeof str !== 'string') return str;
            return str
                .replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2300}-\u{23FF}]|[\u{2B50}]|[\u{1FA00}-\u{1FAFF}]|[\u{FE00}-\u{FE0F}]|[\u200D]/gu, '')
                .replace(/\s+/g, ' ')
                .trim();
        };

        // Abbreviate product names for compact table display
        // Full names preserved in title attributes for hover tooltips
        const abbreviateProduct = (product) => {
            if (!product) return '-';
            const p = product.toLowerCase();

            // DIGITAL PRODUCTS - check FIRST to separate from statics
            if (p.includes('digital')) {
                if (p.includes('network') && p.includes('spot')) return 'Digi-Net-Spot';
                if (p.includes('network') && p.includes('quarter')) return 'Digi-Net-Qtr';
                if (p.includes('network')) return 'Digi-Network';
                if (p.includes('panel') && p.includes('spot')) return 'Digi-Panel';
                if (p.includes('domination')) return 'Digi-Dom';
                if (p.includes('billboard')) return 'Digi-BB';
                if (p.includes('kiosk')) return 'Digi-Kiosk';
                if (p.includes('spectacular')) return 'Digi-Spec';
                if (p.includes('playlist')) return 'Digi-Playlist';
                return 'Digital';
            }

            // Transit Shelters variants (STATIC only - digital already caught above)
            if (p.includes('transit shelter') || p.includes('shelter')) {
                if (p.includes('domination')) return 'T-Shelter-Dom';
                if (p.includes('full wrap')) return 'T-Shelter-FW';
                if (p.includes('icon')) return 'T-Shelter-Icon';
                if (p.includes('targeted')) return 'T-Shelter-TGT';
                if (p.includes('network')) return 'T-Shelter-Net';
                if (p.includes('panel')) return 'T-Shelter-Panel';
                return 'T-Shelter';
            }

            // Transit Buses variants
            if (p.includes('transit bus') || p.includes('bus wrap')) {
                if (p.includes('full wrap')) return 'Bus-FW';
                if (p.includes('king')) return 'Bus-King';
                if (p.includes('queen')) return 'Bus-Queen';
                if (p.includes('tail')) return 'Bus-Tail';
                return 'Bus';
            }

            // Other products
            if (p.includes('bus bench')) return 'Bench';
            if (p.includes('bus king')) return 'Bus-King';
            if (p.includes('bus queen')) return 'Bus-Queen';
            if (p.includes('urban panel')) return 'Urban';
            if (p.includes('kiosk')) return 'Kiosk';
            if (p.includes('interior card')) return 'Interior';
            if (p.includes('wallscape')) return 'Wallscape';
            if (p.includes('billboard')) return 'Billboard';
            if (p.includes('poster')) return 'Poster';
            if (p.includes('spectacular')) return 'Spectacular';

            // If no match, take first word and limit length
            const firstWord = product.split(/[-\s]/)[0];
            return firstWord.length > 10 ? firstWord.substring(0, 8) + '..' : firstWord;
        };

        const generatePDFReport = (data, options = {}) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: options.orientation || 'landscape',
                unit: 'mm',
                format: 'letter'
            });

            const title = stripEmojis(options.title || 'Operations Report');
            const subtitle = stripEmojis(options.subtitle || `Generated ${new Date().toLocaleDateString()}`);
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Header
            doc.setFillColor(30, 41, 59); // slate-800
            doc.rect(0, 0, pageWidth, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('VECTOR MEDIA', 10, 12);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Operations Portal', 10, 18);

            // Title section
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 10, 35);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 116, 139);
            doc.text(subtitle, 10, 42);

            // Summary stats if provided
            if (options.stats) {
                let xPos = pageWidth - 100;
                doc.setFontSize(9);
                Object.entries(options.stats).forEach(([label, value], idx) => {
                    doc.setTextColor(100, 116, 139);
                    doc.text(label + ':', xPos, 33 + (idx * 6));
                    doc.setTextColor(30, 41, 59);
                    doc.setFont('helvetica', 'bold');
                    doc.text(String(value), xPos + 35, 33 + (idx * 6));
                    doc.setFont('helvetica', 'normal');
                });
            }

            // Table
            if (data && data.length > 0) {
                const columns = options.columns || [
                    { header: 'Date', dataKey: 'date' },
                    { header: 'ID', dataKey: 'id' },
                    { header: 'Advertiser', dataKey: 'advertiser' },
                    { header: 'Campaign', dataKey: 'name' },
                    { header: 'Product', dataKey: 'product' },
                    { header: 'Stage', dataKey: 'stage' },
                    { header: 'Progress', dataKey: 'progress' }
                ];

                doc.autoTable({
                    startY: 48,
                    head: [columns.map(c => c.header)],
                    body: data.map(row => columns.map(c => {
                        let val = row[c.dataKey] || '-';
                        // Strip emojis for clean PDF output
                        val = stripEmojis(String(val));
                        if (typeof val === 'string' && val.length > 30) {
                            val = val.substring(0, 27) + '...';
                        }
                        return val;
                    })),
                    theme: 'grid',
                    headStyles: {
                        fillColor: [51, 65, 85],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold',
                        halign: 'left'
                    },
                    bodyStyles: {
                        fontSize: 7,
                        textColor: [51, 65, 85],
                        cellPadding: 2
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: options.columnStyles || {
                        0: { cellWidth: 22 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 35 },
                        3: { cellWidth: 45 },
                        4: { cellWidth: 35 },
                        5: { cellWidth: 30 },
                        6: { cellWidth: 20 }
                    },
                    margin: { left: 10, right: 10 },
                    didDrawPage: (hookData) => {
                        // Footer on each page
                        const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(`Page ${pageNum}`, pageWidth - 25, pageHeight - 10);
                        doc.text('LA STAP Operations Portal', 10, pageHeight - 10);
                    }
                });
            }

            // Download
            const filename = options.filename || `Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            return true;
        };

        // Quick PDF export for different report types
        const exportToPDF = (reportType, data, customOptions = {}) => {
            const reportConfigs = {
                installations: {
                    title: 'Master Installation Report',
                    subtitle: `${data.length} Active Campaigns | ${new Date().toLocaleDateString()}`,
                    columns: [
                        { header: 'Product Start', dataKey: 'date' },
                        { header: 'Campaign ID', dataKey: 'id' },
                        { header: 'Market', dataKey: 'market' },
                        { header: 'Advertiser', dataKey: 'advertiser' },
                        { header: 'Campaign', dataKey: 'name' },
                        { header: 'Product', dataKey: 'product' },
                        { header: 'Stage', dataKey: 'stage' },
                        { header: 'Progress', dataKey: 'progress' }
                    ],
                    columnStyles: {
                        0: { cellWidth: 20 },
                        1: { cellWidth: 22 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 30 },
                        4: { cellWidth: 40 },
                        5: { cellWidth: 30 },
                        6: { cellWidth: 25 },
                        7: { cellWidth: 18 }
                    },
                    filename: `Installations_${new Date().toISOString().split('T')[0]}.pdf`
                },
                campaigns: {
                    title: 'Campaign Status Report',
                    subtitle: `${data.length} Campaigns | ${new Date().toLocaleDateString()}`,
                    columns: [
                        { header: 'Date', dataKey: 'date' },
                        { header: 'Advertiser', dataKey: 'advertiser' },
                        { header: 'Campaign', dataKey: 'name' },
                        { header: 'Product', dataKey: 'product' },
                        { header: 'Qty', dataKey: 'quantity' },
                        { header: 'Stage', dataKey: 'stage' }
                    ],
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 55 },
                        3: { cellWidth: 40 },
                        4: { cellWidth: 15 },
                        5: { cellWidth: 30 }
                    },
                    filename: `Campaigns_${new Date().toISOString().split('T')[0]}.pdf`
                },
                holds: {
                    title: 'Hold Report',
                    subtitle: `${data.length} Items on Hold | ${new Date().toLocaleDateString()}`,
                    columns: [
                        { header: 'Date', dataKey: 'date' },
                        { header: 'Advertiser', dataKey: 'advertiser' },
                        { header: 'Campaign', dataKey: 'name' },
                        { header: 'Reason', dataKey: 'holdReason' },
                        { header: 'Status', dataKey: 'holdStatus' }
                    ],
                    filename: `Holds_${new Date().toISOString().split('T')[0]}.pdf`
                },
                expired: {
                    title: 'Removal Schedule',
                    subtitle: `${data.length} Pending Removals | ${new Date().toLocaleDateString()}`,
                    columns: [
                        { header: 'End Date', dataKey: 'endDate' },
                        { header: 'Advertiser', dataKey: 'advertiser' },
                        { header: 'Campaign', dataKey: 'name' },
                        { header: 'Product', dataKey: 'product' },
                        { header: 'Qty', dataKey: 'quantity' }
                    ],
                    filename: `Removals_${new Date().toISOString().split('T')[0]}.pdf`
                },
                summary: {
                    title: 'Weekly Operations Summary',
                    orientation: 'portrait',
                    filename: `Weekly_Summary_${new Date().toISOString().split('T')[0]}.pdf`
                }
            };

            const config = { ...reportConfigs[reportType], ...customOptions };
            return generatePDFReport(data, config);
        };

        // --- 3D "GRAND CHRONOS" SCENE (The Core Engine) ---
        const ChronosScene = ({ isHyperSpeed }) => {
            const mountRef = useRef(null);
            const targetRotationRef = useRef(0);
            const currentRotationRef = useRef(0);

            useEffect(() => {
                // 1. Setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color('#020617'); // Deep Slate
                scene.fog = new THREE.Fog('#020617', 15, 80);

                const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 42);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.1;
                
                // Safety check for mount
                if (mountRef.current) {
                    mountRef.current.appendChild(renderer.domElement);
                }

                // 2. Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                scene.add(ambientLight);
                const keyLight = new THREE.SpotLight(0x38bdf8, 4);
                keyLight.position.set(25, 25, 30);
                keyLight.castShadow = true;
                scene.add(keyLight);
                const fillLight = new THREE.PointLight(0x6366f1, 2);
                fillLight.position.set(-25, -10, 10);
                scene.add(fillLight);
                const rimLight = new THREE.DirectionalLight(0xffffff, 1.5);
                rimLight.position.set(0, 20, -10);
                scene.add(rimLight);

                // 3. Materials & Gears
                const matDarkMetal = new THREE.MeshStandardMaterial({ color: 0x0f172a, metalness: 0.8, roughness: 0.3 });
                const matChrome = new THREE.MeshStandardMaterial({ color: 0xe2e8f0, metalness: 1.0, roughness: 0.15 });
                const matAccent = new THREE.MeshStandardMaterial({ color: 0x0ea5e9, metalness: 0.7, roughness: 0.2, emissive: 0x0284c7, emissiveIntensity: 0.3 });

                const createGearRing = (radius, width, thickness, teethCount, material, toothHeight = 0.8) => {
                    const group = new THREE.Group();
                    const tubeGeo = new THREE.TorusGeometry(radius, width/2, 24, 120);
                    const ring = new THREE.Mesh(tubeGeo, material);
                    ring.castShadow = true; ring.receiveShadow = true;
                    group.add(ring);
                    const toothGeo = new THREE.BoxGeometry(width, thickness, toothHeight);
                    const teethMesh = new THREE.InstancedMesh(toothGeo, material, teethCount);
                    const dummy = new THREE.Object3D();
                    for(let i=0; i<teethCount; i++){
                        const angle = (i/teethCount) * Math.PI * 2;
                        const x = Math.cos(angle) * (radius + (width/4));
                        const y = Math.sin(angle) * (radius + (width/4));
                        dummy.position.set(x, y, 0);
                        dummy.rotation.z = angle;
                        dummy.rotation.x = Math.PI/2;
                        dummy.updateMatrix();
                        teethMesh.setMatrixAt(i, dummy.matrix);
                    }
                    teethMesh.castShadow = true; teethMesh.receiveShadow = true;
                    group.add(teethMesh);
                    return group;
                };

                const chronosGroup = new THREE.Group();
                scene.add(chronosGroup);
                chronosGroup.rotation.x = 0.25; chronosGroup.rotation.y = -0.15;

                const ring1 = createGearRing(22, 2.5, 1.5, 120, matDarkMetal, 1.5); ring1.position.z = -5; chronosGroup.add(ring1);
                const ring2 = createGearRing(16, 1.2, 1.0, 96, matChrome, 1.0); ring2.position.z = -1; chronosGroup.add(ring2);
                const ring3 = createGearRing(13.5, 1.0, 1.0, 80, matDarkMetal, 0.8); ring3.position.z = 1; chronosGroup.add(ring3);
                const ring4 = createGearRing(9, 1.5, 1.2, 48, matAccent, 1.2); ring4.position.z = 3.5; chronosGroup.add(ring4);

                // Interaction
                const onWheel = (e) => { targetRotationRef.current += e.deltaY * 0.001; };
                window.addEventListener('wheel', onWheel);
                let mouseX = 0, mouseY = 0;
                const onMove = (e) => { mouseX = (e.clientX - window.innerWidth/2) * 0.0005; mouseY = (e.clientY - window.innerHeight/2) * 0.0005; };
                document.addEventListener('mousemove', onMove);

                const animate = () => {
                    requestAnimationFrame(animate);
                    currentRotationRef.current += (targetRotationRef.current - currentRotationRef.current) * 0.05;
                    const t = currentRotationRef.current;
                    const time = Date.now() * 0.0002;

                    ring1.rotation.z = (t * 0.2) + (time * 0.1);
                    ring2.rotation.z = t + (time * 0.3);
                    ring3.rotation.z = -(t * 1.2) - (time * 0.3);
                    ring4.rotation.z = (t * 2.0) + (time * 0.8);
                    
                    chronosGroup.rotation.y = -0.15 + (mouseX * 0.8);
                    chronosGroup.rotation.x = 0.25 + (-mouseY * 0.8);

                    if(isHyperSpeed) { camera.position.z -= 0.5; ring4.rotation.z += 0.3; }
                    renderer.render(scene, camera);
                };
                animate();

                const onResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', onResize);

                return () => {
                    window.removeEventListener('resize', onResize);
                    window.removeEventListener('wheel', onWheel);
                    document.removeEventListener('mousemove', onMove);
                    if(mountRef.current) mountRef.current.innerHTML = '';
                };
            }, [isHyperSpeed]);

            return <div ref={mountRef} className="absolute inset-0 z-0" />;
        };

        // --- COMPONENT: LOGIN SCREEN (Ghost UI) ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [code, setCode] = useState('');
            const [isLaunching, setIsLaunching] = useState(false);
            const [launchingMobile, setLaunchingMobile] = useState(false);
            const [error, setError] = useState('');
            const [threeJsLoaded, setThreeJsLoaded] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            // Auto-detect mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

            // Auto-redirect authenticated mobile users to mobile app
            useEffect(() => {
                if (isMobile) {
                    const savedUser = localStorage.getItem('opshub_user');
                    if (savedUser) {
                        // Already logged in on mobile - redirect to mobile app
                        window.location.replace('./mobile.html');
                    }
                }
            }, [isMobile]);

            // Check if Three.js is available
            useEffect(() => {
                if (typeof THREE !== 'undefined') {
                    setThreeJsLoaded(true);
                }
            }, []);
            
            // Navigation to mobile app (only after auth)
            const goToMobileApp = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                setLaunchingMobile(true);
                // Save user session before redirecting to mobile
                localStorage.setItem('opshub_user', JSON.stringify({ email, role: 'user' }));
                setTimeout(() => {
                    window.location.replace('./mobile.html');
                }, 1500);
            };

            // Handle login form - just validates, doesn't launch yet
            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (email !== ACCESS_EMAIL || code !== ACCESS_PASSWORD) {
                    setError('Invalid Credentials');
                    return;
                }
                // Credentials valid - show app choice
                setIsAuthenticated(true);
            };
            
            // Launch desktop app
            const launchDesktop = () => {
                setIsLaunching(true);
                setTimeout(() => { onLogin({ email }); }, 1500);
            };

            const isAnimating = isLaunching || launchingMobile;

            return (
                <div className="relative w-full h-screen overflow-hidden text-white bg-slate-900 font-sans">
                    {/* Fallback gradient background */}
                    <div className="login-fallback-bg"></div>
                    
                    {/* Three.js on desktop only */}
                    {threeJsLoaded && !isMobile && (
                        <ChronosScene isHyperSpeed={isAnimating} />
                    )}
                    
                    {/* Mobile animated background */}
                    {isMobile && (
                        <div className="absolute inset-0 overflow-hidden">
                            <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-sky-500/10 rounded-full blur-3xl animate-pulse"></div>
                            <div className="absolute bottom-1/4 right-1/4 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                        </div>
                    )}
                    
                    <div className="relative z-10 w-full h-full flex flex-col justify-between p-4 sm:p-8 md:p-12 pointer-events-none overflow-y-auto">
                        {/* Header */}
                        <div className={`flex justify-between items-start transition-opacity duration-500 ${isAnimating ? 'opacity-0' : 'opacity-100'}`}>
                            <div className="pointer-events-auto">
                                <h1 className="text-2xl sm:text-3xl font-extrabold tracking-tight text-white mb-1">VECTOR<span className="text-sky-400">MEDIA</span></h1>
                                <p className="text-xs sm:text-sm text-slate-400 font-medium tracking-widest uppercase">Operations Portal</p>
                            </div>
                        </div>
                        
                        {/* Main Panel */}
                        <div className={`flex justify-center items-center flex-1 py-4 transition-all duration-700 ${isAnimating ? 'scale-110 opacity-0' : 'scale-100 opacity-100'}`}>
                            <div className={`ghost-panel w-full max-w-[400px] p-6 sm:p-8 rounded-2xl pointer-events-auto ${isMobile ? '' : 'animate-float'}`}>
                                
                                {/* ===== AUTHENTICATED: Show Desktop/Mobile Choice ===== */}
                                {isAuthenticated ? (
                                    <>
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-green-500/20 flex items-center justify-center">
                                                <svg className="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <h2 className="text-xl font-bold text-white">Welcome Back</h2>
                                            <p className="text-slate-400 text-xs mt-1">Choose your experience</p>
                                        </div>
                                        
                                        {/* Desktop App Button */}
                                        <button 
                                            type="button"
                                            onClick={launchDesktop}
                                            className="mb-3 w-full py-4 rounded-xl font-bold text-sm uppercase tracking-widest transition-all
                                                bg-gradient-to-r from-sky-500 to-blue-600 
                                                text-white shadow-lg shadow-sky-500/30
                                                hover:shadow-sky-500/50 hover:scale-[1.02]
                                                flex items-center justify-center gap-3 active:scale-[0.98]
                                                cursor-pointer"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            <span>Desktop App</span>
                                        </button>
                                        
                                        {/* Mobile App Button */}
                                        <button 
                                            type="button"
                                            onClick={goToMobileApp}
                                            className="mb-4 w-full py-4 rounded-xl font-bold text-sm uppercase tracking-widest transition-all
                                                bg-gradient-to-r from-orange-500 to-amber-500 
                                                text-white shadow-lg shadow-orange-500/30
                                                hover:shadow-orange-500/50 hover:scale-[1.02]
                                                flex items-center justify-center gap-3 active:scale-[0.98]
                                                cursor-pointer"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                            </svg>
                                            <span>Mobile App</span>
                                        </button>
                                        
                                        {/* Back link */}
                                        <button 
                                            type="button"
                                            onClick={() => setIsAuthenticated(false)}
                                            className="w-full py-2 text-slate-500 text-xs hover:text-slate-300 transition-colors"
                                        >
                                            ‚Üê Back to login
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        {/* ===== NOT AUTHENTICATED: Show Login Form ===== */}
                                        <div className="text-center mb-6 sm:mb-8">
                                            <h2 className="text-2xl font-bold text-white mb-1">Identify</h2>
                                            <p className="text-slate-400 text-xs tracking-wide">Scroll to wind mechanism.</p>
                                        </div>
                                        
                                        <form onSubmit={handleSubmit} className="space-y-4 sm:space-y-6">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Operative Email</label>
                                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full input-ghost py-2 text-sm" placeholder="admin@vectormedia.com" required />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Password</label>
                                                <input type="password" value={code} onChange={e => setCode(e.target.value)} className="w-full input-ghost py-2 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                                            </div>
                                            {error && <div className="text-red-400 text-xs font-bold text-center pt-2">{error}</div>}
                                            <button type="submit" className="w-full btn-modern py-3 rounded-lg font-bold text-xs uppercase tracking-widest mt-4">Authenticate</button>
                                        </form>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        {/* Bottom padding for mobile safe area */}
                        <div className="h-4 sm:h-0"></div>
                    </div>
                </div>
            );
        };

        // --- DATE UTILITIES (Required for Availability Chart) ---
        const getDatesInRange = (startDate, endDate) => {
            const date = new Date(startDate);
            const dates = [];
            while (date <= endDate) {
                dates.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return dates;
        };

        const isDateInRange = (checkDate, start, end) => {
            const d = new Date(checkDate).setHours(0,0,0,0);
            const s = new Date(start).setHours(0,0,0,0);
            const e = new Date(end).setHours(0,0,0,0);
            return d >= s && d <= e;
        };

        // Check if date is start of posting week (Monday = 1)
        const isPostingDay = (date) => date.getDay() === 1;

        // --- REAL AI AGENT (DIRECT CALL FOR INTERNAL USE ONLY) ---
        // =============================================
        // GROQ API CONFIGURATION (Llama 3.3 70B)
        // =============================================
        // API key stored in localStorage - configure via Settings modal (triple-click logo)
        const getGroqApiKey = () => localStorage.getItem('stap_groq_api_key') || '';

        const callGroq = async (prompt, maxTokens = 1024) => {
            const GROQ_API_KEY = getGroqApiKey();
            if (!GROQ_API_KEY) {
                return "‚ö†Ô∏è Configuration Error: Please add your Groq API Key in Settings (triple-click logo).";
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { 
                                role: "system", 
                                content: "You are an expert operations analyst for an out-of-home advertising company. Provide concise, actionable insights using bullet points and specific numbers. Be direct and executive-level in your communication."
                            },
                            { role: "user", content: prompt }
                        ],
                        max_tokens: maxTokens,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices?.[0]?.message?.content || "Error: No response generated.";

            } catch (error) {
                console.error("Groq AI Failed:", error);
                return `Analysis Failed: ${error.message}. Please check your API Key and connection.`;
            }
        };

        // =============================================
        // LIVE WEATHER API (Open-Meteo - Free, No Key)
        // =============================================
        const MARKET_COORDINATES = {
            'Los Angeles, CA': { lat: 34.05, lon: -118.24 },
            'Dallas, TX': { lat: 32.78, lon: -96.80 },
            'Miami, FL': { lat: 25.76, lon: -80.19 },
            'Chicago, IL': { lat: 41.88, lon: -87.63 },
            'Boston, MA': { lat: 42.36, lon: -71.06 },
            'New York, NY': { lat: 40.71, lon: -74.01 },
            'Seattle, WA': { lat: 47.61, lon: -122.33 },
            'San Francisco, CA': { lat: 37.77, lon: -122.42 },
            'Orlando, FL': { lat: 28.54, lon: -81.38 },
            'Las Vegas, NV': { lat: 36.17, lon: -115.14 },
            'Baltimore, MD': { lat: 39.29, lon: -76.61 },
            'Philadelphia, PA': { lat: 39.95, lon: -75.17 },
            'Washington D.C., DC': { lat: 38.91, lon: -77.04 }
        };
        // Export for external components
        window.STAP_MARKET_COORDINATES = MARKET_COORDINATES;

        const fetchLiveWeather = async (market) => {
            // Find coordinates for market (fuzzy match)
            const marketKey = Object.keys(MARKET_COORDINATES).find(k => 
                market?.toLowerCase().includes(k.split(',')[0].toLowerCase())
            ) || 'Los Angeles, CA';
            
            const coords = MARKET_COORDINATES[marketKey];
            
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&daily=temperature_2m_max,precipitation_probability_max,weathercode&timezone=auto&forecast_days=7&temperature_unit=fahrenheit`
                );
                
                if (!response.ok) throw new Error('Weather API failed');
                
                const data = await response.json();
                
                // Map weather codes to conditions and icons
                const weatherCodeMap = {
                    0: { condition: 'Clear', icon: 'Sun' },
                    1: { condition: 'Mostly Clear', icon: 'Sun' },
                    2: { condition: 'Partly Cloudy', icon: 'Cloud' },
                    3: { condition: 'Overcast', icon: 'Cloud' },
                    45: { condition: 'Foggy', icon: 'Cloud' },
                    48: { condition: 'Icy Fog', icon: 'Cloud' },
                    51: { condition: 'Light Drizzle', icon: 'CloudRain' },
                    53: { condition: 'Drizzle', icon: 'CloudRain' },
                    55: { condition: 'Heavy Drizzle', icon: 'CloudRain' },
                    61: { condition: 'Light Rain', icon: 'CloudRain' },
                    63: { condition: 'Rain', icon: 'CloudRain' },
                    65: { condition: 'Heavy Rain', icon: 'CloudRain' },
                    71: { condition: 'Light Snow', icon: 'Snowflake' },
                    73: { condition: 'Snow', icon: 'Snowflake' },
                    75: { condition: 'Heavy Snow', icon: 'Snowflake' },
                    80: { condition: 'Rain Showers', icon: 'CloudRain' },
                    81: { condition: 'Moderate Showers', icon: 'CloudRain' },
                    82: { condition: 'Heavy Showers', icon: 'CloudRain' },
                    95: { condition: 'Thunderstorm', icon: 'CloudLightning' },
                    96: { condition: 'Thunderstorm w/ Hail', icon: 'CloudLightning' },
                    99: { condition: 'Severe Thunderstorm', icon: 'CloudLightning' }
                };

                return data.daily.time.map((date, i) => {
                    const code = data.daily.weathercode[i];
                    const weather = weatherCodeMap[code] || { condition: 'Unknown', icon: 'Cloud' };
                    // Fix timezone issue: append T12:00:00 to avoid UTC midnight shifting the day
                    const dayName = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                    return {
                        day: dayName,
                        date: date,
                        temp: Math.round(data.daily.temperature_2m_max[i]),
                        rainChance: data.daily.precipitation_probability_max[i] || 0,
                        condition: weather.condition,
                        icon: weather.icon
                    };
                });
            } catch (error) {
                console.error('Weather fetch failed:', error);
                // Return fallback static data
                return [
                    { day: 'Today', temp: 72, rainChance: 10, condition: 'Clear', icon: 'Sun' },
                    { day: 'Tue', temp: 74, rainChance: 5, condition: 'Sunny', icon: 'Sun' },
                    { day: 'Wed', temp: 71, rainChance: 15, condition: 'Partly Cloudy', icon: 'Cloud' },
                    { day: 'Thu', temp: 68, rainChance: 30, condition: 'Cloudy', icon: 'Cloud' },
                    { day: 'Fri', temp: 70, rainChance: 20, condition: 'Partly Cloudy', icon: 'Cloud' }
                ];
            }
        };
        // Export for external components
        window.STAP_fetchLiveWeather = fetchLiveWeather;

        // Temperature unit conversion utilities
        const getTempUnit = () => localStorage.getItem('STAP_TEMP_UNIT') || 'F';
        const setTempUnit = (unit) => localStorage.setItem('STAP_TEMP_UNIT', unit);
        const convertTemp = (tempF, unit) => {
            if (unit === 'C') {
                return Math.round((tempF - 32) * 5 / 9);
            }
            return Math.round(tempF);
        };
        const formatTemp = (tempF, unit) => `${convertTemp(tempF, unit || getTempUnit())}¬∞${unit || getTempUnit()}`;

        window.STAP_getTempUnit = getTempUnit;
        window.STAP_setTempUnit = setTempUnit;
        window.STAP_convertTemp = convertTemp;
        window.STAP_formatTemp = formatTemp;

        // Weather location utilities
        const getWeatherLocation = () => localStorage.getItem('STAP_WEATHER_LOCATION') || 'Los Angeles, CA';
        const setWeatherLocation = (location) => localStorage.setItem('STAP_WEATHER_LOCATION', location);

        window.STAP_getWeatherLocation = getWeatherLocation;
        window.STAP_setWeatherLocation = setWeatherLocation;

        // Legacy wrapper for backward compatibility
        const callGemini = async (prompt) => {
            return await callGroq(prompt);
        };

        // --- ICONS (loaded from icon.js) ---
        // Icon and ProductionIcon are loaded from external icon.js module
        // They are available as window.STAP_Icon and window.STAP_ProductionIcon
        const Icon = window.STAP_Icon || (({ name }) => <span title={name}>?</span>);
        const ProductionIcon = window.STAP_ProductionIcon || (() => <span>?</span>);
        const ICON_MAP = window.STAP_ICON_MAP || {};

        // ============================================
        // IMPRESSIONS DASHBOARD (loaded from impressionsDashboard.js)
        // ============================================
        const ImpressionsDashboard = window.STAPImpressions?.ImpressionsDashboard || (() => {
            return React.createElement('div', { className: 'p-8 text-center text-gray-500' },
                'Loading Impressions Dashboard...',
                React.createElement('div', { className: 'text-xs mt-2' }, 'If this persists, check that impressionsDashboard.js is loaded.')
            );
        });
        const getProductImpressions = window.STAPImpressions?.getProductImpressions || ((type) => ({ weekly: 20000, multiplier: 1.0 }));
        const estimateZipImpressions = window.STAPImpressions?.estimateZipImpressions || (() => ({}));
        const LA_ZIP_DATA_EXT = window.STAPImpressions?.LA_ZIP_DATA || {};
        const PRODUCT_FORMATS = window.STAPImpressions?.PRODUCT_FORMATS || {};

        // ============================================
        // DETAIL MODAL (loaded from detailModal.js)
        // Will use internal fallback if external not loaded
        // ============================================
        // Note: DetailModal from external file uses window.STAPDetailModal
        // The internal version is kept as fallback below in the code

        // ============================================
        // DIGEST MODAL (loaded from digestModal.js)
        // Will use internal fallback if external not loaded
        // ============================================
        // Note: DigestModal from external file uses window.STAPDigestModal
        // The internal version is kept as fallback below in the code

        // --- EMAIL DIGEST GENERATION LOGIC ---
        
        const generateDigestHtml = (processedData, weatherForecast, settings) => {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Font size based on compact mode
            const fontSize = settings.compactMode ? '10px' : '12px';
            const headerSize = settings.compactMode ? '11px' : '13px';
            const padding = settings.compactMode ? '4px 6px' : '8px 10px';
            
            // --- Helper: Create Table Row ---
            const createHtmlTable = (data, headers, columnWidths, rowMapper) => {
                if (!data || data.length === 0) {
                    return "<p style='font-style: italic; color: #666;'>No flights are currently in this category.</p>";
                }
                let table = `<table class="data-table" style="font-size: ${fontSize};"><tr>`;
                headers.forEach((header, index) => {
                    const widthAttr = columnWidths[index] ? ` width="${columnWidths[index]}"` : '';
                    table += `<th${widthAttr} style="font-size: ${headerSize}; padding: ${padding};">${header}</th>`;
                });
                table += '</tr>';
                data.forEach(item => {
                    const rowValues = rowMapper(item);
                    table += '<tr>';
                    rowValues.forEach(val => {
                        table += `<td style="padding: ${padding};">${val || ''}</td>`;
                    });
                    table += '</tr>';
                });
                return table + '</table>';
            };

            // --- Helper: Weather HTML (UPDATED FOR COLOR) ---
            const getWeatherHtml = () => {
                const days = weatherForecast.slice(0, 4); // First 4 days
                const tempUnit = settings.tempUnit || getTempUnit();
                let html = '<table border="0" cellpadding="0" cellspacing="0" style="width: 100%; border-collapse: collapse;"><tbody><tr>';
                days.forEach((day, i) => {
                    const dayName = i === 0 ? "Today" : day.day;
                    const iconEmoji = day.icon === 'Sun' ? '&#9728;' : day.icon === 'Cloud' ? '&#9729;' : '&#127783;';
                    const displayTemp = convertTemp(day.temp, tempUnit);
                    html += `
                        <td style="width: 25%; text-align: center; padding: 0 2px; vertical-align: top;">
                            <h4 style="margin: 0; font-size: 10px; color: #ffffff; font-family: sans-serif; font-weight: bold; padding-bottom: 2px;">${dayName}</h4>
                            <p style="font-size: 20px; line-height: 1; margin: 0; display: block; padding-bottom: 2px; font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;">${iconEmoji}</p>
                            <p style="margin: 0; font-size: 9px; font-family: sans-serif; color: #ffffff; line-height: 1.2;">
                                <span style="font-weight: bold;">${displayTemp}¬∞${tempUnit}</span>
                            </p>
                        </td>
                    `;
                });
                html += '</tr></tbody></table>';
                return html;
            };

            // --- Generate Tables ---
            // Helper for formatting Client/Campaign cell (with optional in-house icon)
            const formatClient = (client, campaign, productionProof) => {
                const inHouseIcon = (settings.showProductionIcon && productionProof === 'in-house')
                    ? '<span style="margin-left:4px;" title="In-House Production">&#127968;</span>'
                    : '';
                return `<strong>${client}</strong>${inHouseIcon}<br/><span style="font-size:11px;color:#666;">${campaign}</span>`;
            };
            
            // Helper to shorten product names
            const formatProduct = (product) => {
                if (!product) return '-';
                return product.replace('Transit Shelter-', '').replace('Transit Shelters-', '').replace('Transit Buses-', '');
            };
            
            // Helper to shorten market names
            const formatMarket = (market) => {
                if (!market) return '-';
                return market.split(',')[0].replace(' - STAP', '');
            };
            
            // Helper to abbreviate dates (1/2/25 instead of 1/2/2025)
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                // Convert various date formats to short format
                const parts = dateStr.split('/');
                if (parts.length === 3 && parts[2].length === 4) {
                    return `${parts[0]}/${parts[1]}/${parts[2].slice(-2)}`;
                }
                return dateStr;
            };

            // Dynamic column building based on settings
            const buildTableConfig = (baseHeaders, baseWidths, baseMapper, options = {}) => {
                let headers = [...baseHeaders];
                let widths = [...baseWidths];
                let mapper = baseMapper;
                
                // Add optional columns
                if (settings.showMarketColumn && options.includeMarket) {
                    headers.splice(options.marketPosition || 2, 0, 'Market');
                    widths.splice(options.marketPosition || 2, 0, '12%');
                }
                if (settings.showProductColumn && options.includeProduct) {
                    headers.splice(options.productPosition || 3, 0, 'Media');
                    widths.splice(options.productPosition || 3, 0, '15%');
                }
                
                return { headers, widths };
            };

            const tables = {
                delayed: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Late'); base.widths.push('7%', '5%');
                    
                    return createHtmlTable(processedData.delayedFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        // Calculate days overdue
                        const daysLate = item.dateObj ? Math.floor((new Date() - item.dateObj) / (1000 * 60 * 60 * 24)) : '-';
                        const daysLateDisplay = daysLate > 0 ? `<span style="color: ${daysLate > 7 ? '#d32f2f' : '#f57c00'}; font-weight: bold;">${daysLate}d</span>` : '-';
                        row.push(formatDate(item.date), daysLateDisplay);
                        return row;
                    });
                })(),
                
                inProgress: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '45%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('15%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Progress'); base.widths.push('7%', '22%');
                    
                    return createHtmlTable(processedData.inProgressFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);

                        // Build visual progress bar - use adjustedQty if set for charted qty override
                        const totalQty = item.adjustedQty || item.quantity || item.totalQty || 0;
                        const installedQty = item.installed || item.totalInstalled || 0;
                        const pendingQty = item.pending || item.totalPending || (totalQty - installedQty);
                        const pct = totalQty > 0 ? Math.round((installedQty / totalQty) * 100) : 0;
                        const barColor = pct >= 75 ? '#4caf50' : pct >= 50 ? '#ff9800' : '#f44336';

                        // Add adjusted qty badge if applicable
                        const adjustedBadge = item.hasQtyAdjustment ? `<span style="background: #2196f3; color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">ADJ</span>` : '';

                        const progressHtml = totalQty > 0 ? `
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="flex: 1; background: #e0e0e0; border-radius: 4px; height: 8px; min-width: 80px;">
                                    <div style="width: ${pct}%; background: ${barColor}; height: 100%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 11px; white-space: nowrap; color: #333;">
                                    <strong>${installedQty}</strong>/${totalQty}${adjustedBadge}
                                </span>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${pct}% ‚Ä¢ ${pendingQty} pending</div>
                        ` : '-';

                        row.push(formatDate(item.date), progressHtml);
                        return row;
                    });
                })(),
                
                upcoming: (() => {
                    const base = { headers: ["Stage", "Campaign #", "Client / Campaign"], widths: ['18%', '10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('20%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start'); base.widths.push('7%');
                    
                    return createHtmlTable(processedData.upcoming, base.headers, base.widths, item => {
                        const row = [item.stage, item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        row.push(formatDate(item.date));
                        return row;
                    });
                })(),
                
                installed: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Units'); base.widths.push('7%', '10%');
                    
                    return createHtmlTable(processedData.fullyInstalledThisWeek, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        
                        // Show installed count with checkmark
                        const totalQty = item.quantity || item.totalQty || 0;
                        const installedQty = item.installed || item.totalInstalled || totalQty;
                        const unitsHtml = totalQty > 0 ? `
                            <span style="color: #4caf50; font-weight: bold;">‚úì ${installedQty}</span>
                            <span style="color: #666; font-size: 11px;">/ ${totalQty}</span>
                        ` : '-';
                        
                        row.push(formatDate(item.date), unitsHtml);
                        return row;
                    });
                })(),
                
                recentCompleted: (() => {
                    const base = { headers: ["Stage", "Campaign #", "Advertiser / Campaign"], widths: ['18%', '10%', '55%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('20%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    
                    return createHtmlTable(processedData.recentInstalls, base.headers, base.widths, item => {
                        const row = [item.stage, item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        return row;
                    });
                })(),
                
                pipeline: (() => {
                    // Count unique campaigns (by ID) for each category
                    const countUniqueCampaigns = (arr) => {
                        if (!arr || arr.length === 0) return 0;
                        const uniqueIds = new Set(arr.map(item => item.id));
                        return uniqueIds.size;
                    };
                    
                    // Match dashboard stat cards - count unique campaigns
                    const dashboardStats = [
                        { stage: 'Delayed / Overdue', count: countUniqueCampaigns(processedData.delayedFlights) },
                        { stage: 'In-Progress', count: countUniqueCampaigns(processedData.inProgressFlights) },
                        { stage: 'Upcoming (7 Days)', count: countUniqueCampaigns(processedData.upcoming) },
                        { stage: 'Installed This Week', count: countUniqueCampaigns(processedData.fullyInstalledThisWeek) },
                        { stage: 'Ready for Removal', count: countUniqueCampaigns(processedData.expiredFlights) },
                        { stage: 'Rotations', count: countUniqueCampaigns(processedData.rotations) },
                        { stage: 'On Hold', count: countUniqueCampaigns(processedData.onHoldCampaigns) }
                    ].filter(s => s.count > 0);
                    
                    return createHtmlTable(
                        dashboardStats,
                        ["Category", "Campaigns"],
                        ['80%', '20%'],
                        item => [item.stage, `<strong>${item.count}</strong>`]
                    );
                })(),
                
                removal: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('End', 'Ago'); base.widths.push('7%', '5%');
                    
                    return createHtmlTable(processedData.expiredFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name, item.productionProof)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        // Calculate days since expired
                        const daysAgo = item.endDateObj ? Math.floor((new Date() - item.endDateObj) / (1000 * 60 * 60 * 24)) : '-';
                        const daysDisplay = daysAgo > 0 ? `${daysAgo}d` : '-';
                        row.push(formatDate(item.endDate), daysDisplay);
                        return row;
                    });
                })()
            };

            const weatherHtml = getWeatherHtml();

            // Dynamic Sections based on settings
            let sectionsHtml = '';
            
            // Calculate production breakdown (used by both summary and production breakdown sections)
            const allCampaigns = processedData.all || [];
            const productionBreakdown = {
                inHouse: allCampaigns.filter(c => c.productionProof === 'in-house').length,
                client: allCampaigns.filter(c => c.productionProof === 'client').length,
                mixed: allCampaigns.filter(c => c.productionProof === 'mixed').length,
                unset: allCampaigns.filter(c => !c.productionProof).length
            };
            const hasProductionData = productionBreakdown.inHouse > 0 || productionBreakdown.client > 0 || productionBreakdown.mixed > 0;

            if (settings.sections.summary) {
                sectionsHtml += `
                <tr><td class="summary-section">
                <h2>THIS WEEK AT A GLANCE</h2>
                <div class="summary-grid">
                    <div class="summary-item"><div class="count" style="color: ${processedData.delayedFlights.length > 0 ? '#d32f2f' : '#4caf50'};">${processedData.delayedFlights.length}</div><div class="label">DELAYED</div></div>
                    <div class="summary-item"><div class="count normal">${processedData.inProgressFlights.length}</div><div class="label">IN-PROGRESS</div></div>
                    <div class="summary-item"><div class="count normal">${processedData.upcoming.length}</div><div class="label">UPCOMING</div></div>
                    <div class="summary-item"><div class="count" style="color: #4caf50;">${processedData.fullyInstalledThisWeek.length}</div><div class="label">INSTALLED</div></div>
                </div>
                </td></tr>`;
            }

            // Production Source Breakdown - now independent section
            if (settings.sections.productionBreakdown) {
                sectionsHtml += `
                <tr><td class="summary-section" style="padding-top: 15px; padding-bottom: 15px;">
                <h3 style="margin: 0 0 10px; font-size: 14px; color: #666; text-align: center;">PRODUCTION SOURCE BREAKDOWN</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="count" style="font-size: 20px; color: #7c3aed;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            ${productionBreakdown.inHouse}
                        </div>
                        <div class="label" style="font-size: 10px;">IN-HOUSE</div>
                    </div>
                    <div class="summary-item">
                        <div class="count" style="font-size: 20px; color: #2563eb;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            ${productionBreakdown.client}
                        </div>
                        <div class="label" style="font-size: 10px;">CLIENT</div>
                    </div>
                    <div class="summary-item">
                        <div class="count" style="font-size: 20px; color: #d97706;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                            ${productionBreakdown.mixed}
                        </div>
                        <div class="label" style="font-size: 10px;">MIXED</div>
                    </div>
                    ${productionBreakdown.unset > 0 ? `<div class="summary-item"><div class="count" style="font-size: 20px; color: #9ca3af;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>${productionBreakdown.unset}</div><div class="label" style="font-size: 10px;">NOT SET</div></div>` : ''}
                </div>
                </td></tr>`;
            }

            if (settings.sections.delayed) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.delayed}</h2>${tables.delayed}</td></tr>`;
            }
            if (settings.sections.inProgress) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.inProgress}</h2>${tables.inProgress}</td></tr>`;
            }
            if (settings.sections.upcoming) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.upcoming}</h2>${tables.upcoming}</td></tr>`;
            }
            if (settings.sections.installed) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.installed}</h2>${tables.installed}</td></tr>`;
            }
            if (settings.sections.recent) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.recent}</h2>${tables.recentCompleted}</td></tr>`;
            }
            if (settings.sections.pipeline) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.pipeline}</h2>${tables.pipeline}</td></tr>`;
            }
            if (settings.sections.removal) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.removal}</h2>${tables.removal}</td></tr>`;
            }

            return `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f4f8; margin: 0; padding: 15px; color: #333333; }
            .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
            .header { background-color: #00C9FF; background-image: linear-gradient(to right, #00C9FF, #6E6AFF); padding: 15px 20px; color: #ffffff; }
            .header h1 { margin: 0; font-size: 26px; font-weight: 600; line-height: 1.2; color: #ffffff; }
            .header p { margin: 4px 0 0; font-size: 16px; opacity: 0.9; color: #ffffff; }
            .logo { max-width: 80px; height: auto; display: block; }
            .summary-section { padding: 25px 30px; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e8; }
            .summary-section h2 { margin: 0 0 15px; font-size: 20px; color: #0d47a1; text-align: center;}
            .summary-grid { display: table; width: 100%; border-collapse: collapse; }
            .summary-item { display: table-cell; text-align: center; padding: 10px; }
            .summary-item .count { font-size: 28px; font-weight: 600; color: #d32f2f; line-height: 1.1; }
            .summary-item .count.normal { color: #2979ff; }
            .summary-item .label { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
            .section { padding: 25px 30px; border-bottom: 1px solid #e0e0e8; }
            .section:last-of-type { border-bottom: none; }
            .section h2 { margin: 0 0 15px; font-size: 20px; color: #0d47a1; }
            table.data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            .data-table th, .data-table td { padding: 9px 8px; text-align: left; border-bottom: 1px solid #eeeeee; font-size: 13px; vertical-align: top; word-break: break-word; }
            .data-table th { font-weight: 600; color: #555; background-color: #f8f9fa; }
            .data-table tr:last-child td { border-bottom: none; }
            .footer { padding: 30px; text-align: center; font-size: 14px; background-color: #f0f4f8; }
            .footer a { background-color: #2979ff; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; }
            </style></head><body>
            <table class="container" align="center" cellpadding="0" cellspacing="0">
                <tr>
                <td class="header">
                    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                    <tr>
                        <td width="100" align="left" valign="middle">
                        <img src="https://drive.google.com/thumbnail?id=1Z8ZtHCnM5MT06YFAsokHxBXV70JsD3c7" alt="Vector Logo" class="logo">
                        </td>
                        <td align="center" valign="middle" style="padding: 0 10px;">
                        <h1 style="margin: 0; font-size: 26px; font-weight: 600; line-height: 1.2;">${settings.mainTitle}</h1>
                        <p style="margin: 4px 0 0; font-size: 16px; opacity: 0.9;">${today}</p>
                        </td>
                        <td width="200" align="right" valign="middle">${settings.showWeather ? weatherHtml : ''}</td>
                    </tr>
                    </table>
                </td>
                </tr>
                ${sectionsHtml}
                <tr><td class="footer">
                    <a href="#">View Full Dashboard</a>
                    <p style="margin-top: 15px; font-size: 11px; color: #999;">
                        Report generated: ${new Date().toLocaleString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        })} ‚Ä¢ LA STAP Operations Portal
                    </p>
                </td></tr>
            </table>
            </body></html>`;
        };
        // Export for external components
        window.STAP_generateDigestHtml = generateDigestHtml;

        // --- CONFIGURATION & HELPER FUNCTIONS ---
        
        const ALL_STAGES = [
            'RFP',
            'Initial Proposal',
            'Client Feedback',
            'Pending Hold',
            'On Hold',
            'Pending Client Approval',
            'Pending Finance Approval',
            'Contracted',
            'Proofs Approved',
            'Working On It',
            'Proofs Out For Approval',
            'Artwork Received',
            'Material Ready For Install',
            'Installed',
            'Photos Taken',
            'POP Completed',
            'Takedown Complete',
            'Lost Opportunity',
            'Canceled'
        ];
        // Export for external components
        window.STAP_ALL_STAGES = ALL_STAGES;

        const SPECIALTY_KEYWORDS = [
            'embellishment',
            'domination',
            'full wrap',
            'icon',
            'spectacular',
            'wallscape',
            'custom',
            'premium',
            'takeover',
            'wrap',
            'mural',
            'vinyl'
        ];

        // --- MOCK DATA FOR LANDING PAGE ---
        const WEATHER_FORECAST = [
            { day: 'Mon', temp: 72, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Tue', temp: 75, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Wed', temp: 68, icon: 'Cloud', status: 'Cloudy', rain: 10 },
            { day: 'Thu', temp: 70, icon: 'Sun', status: 'Clear', rain: 0 },
            { day: 'Fri', temp: 74, icon: 'Sun', status: 'Sunny', rain: 5 },
            { day: 'Sat', temp: 71, icon: 'CloudRain', status: 'Showers', rain: 60 },
            { day: 'Sun', temp: 69, icon: 'Cloud', status: 'Partly Cloudy', rain: 20 },
            // Week 2
            { day: 'Mon', temp: 70, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Tue', temp: 73, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Wed', temp: 66, icon: 'Cloud', status: 'Cloudy', rain: 15 },
            { day: 'Thu', temp: 68, icon: 'CloudRain', status: 'Rain', rain: 40 },
            { day: 'Fri', temp: 71, icon: 'Sun', status: 'Clear', rain: 5 },
            { day: 'Sat', temp: 75, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Sun', temp: 77, icon: 'Sun', status: 'Sunny', rain: 0 },
        ];
        // Export for external components
        window.STAP_WEATHER_FORECAST = WEATHER_FORECAST;

        const UPCOMING_HOLIDAYS = [
            { date: 'Dec 14', name: 'Hanukkah', type: 'Jewish' },
            { date: 'Dec 25', name: 'Christmas Day', type: 'Federal' },
            { date: 'Jan 01', name: 'New Year\'s Day', type: 'Federal' },
            { date: 'Jan 15', name: 'Martin Luther King Jr. Day', type: 'Federal' },
            { date: 'Feb 02', name: 'Tu BiShvat', type: 'Jewish' },
            { date: 'Feb 19', name: 'Presidents\' Day', type: 'Federal' }
        ];

        // --- GLOBAL CITY DATA (MOVED TO GLOBAL SCOPE FOR AI ACCESS) ---
        const CITY_DATA = {
            'Los Angeles': [
                { rainChance: 0, temp: 78, condition: 'Sunny' }, { rainChance: 0, temp: 80, condition: 'Sunny' },
                { rainChance: 0, temp: 79, condition: 'Sunny' }, { rainChance: 0, temp: 77, condition: 'Sunny' },
                { rainChance: 5, temp: 75, condition: 'Partly Cloudy' },
            ],
            'Seattle': [
                { rainChance: 88, temp: 48, condition: 'Heavy Rain' }, { rainChance: 92, temp: 46, condition: 'Storms' },
                { rainChance: 65, temp: 49, condition: 'Showers' }, { rainChance: 40, temp: 51, condition: 'Cloudy' },
                { rainChance: 75, temp: 47, condition: 'Rain' },
            ],
            'New York': [
                { rainChance: 10, temp: 35, condition: 'Partly Cloudy' }, { rainChance: 20, temp: 32, condition: 'Overcast' },
                { rainChance: 0, temp: 30, condition: 'Clear' }, { rainChance: 5, temp: 34, condition: 'Sunny' },
                { rainChance: 40, temp: 38, condition: 'Light Snow' },
            ],
            'Miami': [
                { rainChance: 30, temp: 82, condition: 'Scattered T-Storms' }, { rainChance: 50, temp: 84, condition: 'Partly Cloudy' },
                { rainChance: 20, temp: 81, condition: 'Sunny' }, { rainChance: 80, temp: 79, condition: 'Thunderstorms' },
                { rainChance: 10, temp: 80, condition: 'Sunny' },
            ]
        };

        const parseCSV = (text) => {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const parseLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') { inQuotes = !inQuotes; }
                    else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                    else { current += char; }
                }
                result.push(current.trim());
                return result;
            };
            const headers = parseLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = parseLine(line);
                const entry = {};
                headers.forEach((h, i) => { entry[h] = values[i] || ''; });
                return entry;
            });
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const clean = dateStr.trim().split(' ')[0]; 

            // Handle MM/DD/YYYY (Standard US CSV)
            const usParts = clean.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if (usParts) {
                let year = parseInt(usParts[3], 10);
                if (year < 100) year += 2000;
                return new Date(year, parseInt(usParts[1], 10) - 1, parseInt(usParts[2], 10));
            }

            // Handle YYYY-MM-DD (ISO / Google API)
            const isoParts = clean.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (isoParts) {
                return new Date(parseInt(isoParts[1], 10), parseInt(isoParts[2], 10) - 1, parseInt(isoParts[3], 10));
            }

            const d = new Date(dateStr);
            return isNaN(d) ? null : d;
        };

        const getStatusColor = (stage, date) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            if (!stage || stage === '') return "bg-gray-200 text-gray-500 border-gray-300 italic";
            if (!date) return "bg-gray-100 text-gray-800";

            // 7-day grace period - only mark as past due if 7+ days past start date
            const gracePeriodDate = new Date(today);
            gracePeriodDate.setDate(today.getDate() - 7);
            const isPastDue = date < gracePeriodDate && !['Installed', 'Photos Taken', 'POP Completed', 'Takedown Complete', 'Canceled', 'Lost Opportunity'].includes(stage);

            if (stage === 'Lost Opportunity') return "bg-gray-200 text-gray-500 border-gray-300";
            if (stage === 'Takedown Complete') return "bg-slate-200 text-slate-600 border-slate-300";
            if (isPastDue) return "bg-red-100 text-red-800 border-red-200 font-bold";
            if (stage?.includes('Installed')) return "bg-blue-100 text-blue-800 border-blue-200";
            if (stage?.includes('Material Ready')) return "bg-green-100 text-green-800 border-green-200";
            if (stage?.includes('Contracted')) return "bg-yellow-100 text-yellow-800 border-yellow-200";
            if (stage?.includes('Pending')) return "bg-orange-50 text-orange-600 border-orange-200";
            return "bg-gray-100 text-gray-600 border-gray-200";
        };
        // Export for external components
        window.STAP_getStatusColor = getStatusColor;

        const findCol = (headers, keywords, exclude = []) => headers.find(h => {
            const low = h.toLowerCase();
            if (!keywords.some(k => low.includes(k))) return false;
            if (exclude.some(e => low.includes(e))) return false;
            return true;
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üß† SMART COLUMN MATCHER - Fuzzy matching for flexible CSV imports
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Levenshtein distance for fuzzy string matching
        const levenshteinDistance = (str1, str2) => {
            const m = str1.length, n = str2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    dp[i][j] = str1[i-1] === str2[j-1] 
                        ? dp[i-1][j-1] 
                        : Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
                }
            }
            return dp[m][n];
        };

        // Similarity score (0-1, higher = more similar)
        const similarityScore = (str1, str2) => {
            const s1 = str1.toLowerCase().replace(/[^a-z0-9]/g, '');
            const s2 = str2.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (s1 === s2) return 1;
            if (s1.includes(s2) || s2.includes(s1)) return 0.9;
            const maxLen = Math.max(s1.length, s2.length);
            if (maxLen === 0) return 0;
            return 1 - (levenshteinDistance(s1, s2) / maxLen);
        };

        // Smart column mapping with synonyms and variations
        const COLUMN_SYNONYMS = {
            // Campaign ID variations
            'campaign_id': ['campaign number', 'campaign id', 'campaign #', 'campaign no', 'campaignnumber', 'campaign_number', 'id', 'campaign-id', 'booking id', 'booking number', 'order id', 'order number', 'opp id', 'opportunity id'],
            
            // Product Start Date - THIS IS THE KEY DATE FOR ROTATIONS/COPY CHANGES
            // IMPORTANT: Must NOT match "program start date" - that's the contract date
            'start_date': ['product start date', 'product start', 'flight start date', 'flight start', 'posting start', 'posting date', 'install start', 'media start date', 'media start', 'product_start_date', 'flight_start_date', 'prod start', 'prod start date'],
            
            // Product End Date - When the specific flight/rotation ends
            'product_end_date': ['product end date', 'product end', 'flight end date', 'flight end', 'posting end', 'removal date', 'takedown date', 'media end date', 'media end', 'product_end_date', 'flight_end_date', 'prod end', 'prod end date'],
            
            // Program End Date - Overall contract end (informational)
            'program_end_date': ['program end date', 'program end', 'contract end date', 'contract end', 'agreement end', 'final contract end', 'program_end_date'],
            
            // Market variations
            'market': ['market', 'dma', 'region', 'city', 'location', 'territory', 'area', 'metro', 'geo', 'geography', 'market name', 'market_name'],
            
            // Owner variations
            'owner': ['opportunity owner', 'owner', 'sales rep', 'sales owner', 'account exec', 'ae', 'rep', 'salesperson', 'account manager', 'am', 'assigned to', 'assigned', 'sales_rep', 'account_exec'],
            
            // Advertiser variations
            'advertiser': ['advertiser', 'client', 'customer', 'account', 'brand', 'company', 'advertiser name', 'client name', 'account name', 'buyer', 'agency'],
            
            // Campaign Name variations
            'campaign': ['campaign', 'campaign name', 'flight name', 'order name', 'booking name', 'description', 'title', 'name', 'campaign_name', 'flight'],
            
            // Product/Media variations
            'product': ['product', 'media', 'media type', 'format', 'unit type', 'inventory', 'asset', 'product type', 'product name', 'media_type', 'unit', 'ad type', 'ad format', 'placement'],
            
            // Stage/Status variations
            'stage': ['inventory opportunity stage', 'stage', 'status', 'workflow stage', 'current stage', 'opp stage', 'opportunity stage', 'workflow status', 'state', 'phase', 'step'],
            
            // Progress variations
            'progress': ['progress', 'completion', 'install progress', 'pct complete', 'percent complete', '% complete', 'installed/total', 'progress_pct'],
            
            // Quantity variations
            'quantity': ['quantity', 'qty', 'total qty', 'total quantity', 'units', 'faces', 'spots', 'panels', 'count', 'num units', 'total units', 'total', 'ordered', 'booked'],
            
            // Installed count variations
            'installed': ['installed', 'posted', 'live', 'completed', 'installed qty', 'installed quantity', 'posted qty', 'up', 'active'],
            
            // Pending variations
            'pending': ['pending', 'remaining', 'left', 'to install', 'outstanding', 'not installed', 'pending qty'],
            
            // First Install Date variations
            'first_install': ['first install date', 'first install', 'first posted', 'first up date', 'initial install', '1st install'],
            
            // Completion Date variations
            'completion': ['completion date', 'completed date', 'finish date', 'done date', 'last install', 'final install'],
            
            // Production Proof variations (In-House vs Client-Produced)
            'production_proof': ['production proof', 'production source', 'produced by', 'print source', 'material source', 'production type', 'in-house', 'inhouse production', 'production']
        };

        // Find best matching column with fuzzy logic
        // usedHeaders: Set of headers already claimed by other fields (to prevent collisions)
        const smartFindColumn = (headers, targetField, minScore = 0.6, usedHeaders = new Set()) => {
            const synonyms = COLUMN_SYNONYMS[targetField] || [targetField];
            let bestMatch = null;
            let bestScore = 0;

            for (const header of headers) {
                // Skip headers already claimed by other fields
                if (usedHeaders.has(header)) continue;

                const headerClean = header.toLowerCase().trim();

                for (const synonym of synonyms) {
                    // Exact match (highest priority)
                    if (headerClean === synonym.toLowerCase()) {
                        return header;
                    }

                    // Check similarity (raised threshold to 0.7 to reduce false positives)
                    const score = similarityScore(headerClean, synonym);
                    if (score > bestScore && score >= minScore) {
                        bestScore = score;
                        bestMatch = header;
                    }
                }
            }

            return bestMatch;
        };

        // Build complete column mapping from headers
        const buildSmartColumnMap = (headers) => {
            const colMap = {};
            const mappingResults = []; // Track results for user feedback
            const usedHeaders = new Set(); // Track claimed headers to prevent collisions

            // Field mappings with clear distinction between Product (flight) and Program (contract) dates
            // IMPORTANT: Order matters! More specific/critical fields should be matched first
            const fieldMappings = [
                { field: 'id', target: 'campaign_id', fallback: 'Campaign Number', required: true, description: 'Unique campaign identifier' },
                { field: 'owner', target: 'owner', fallback: 'Opportunity Owner', required: false, description: 'Sales rep/owner' },
                { field: 'advertiser', target: 'advertiser', fallback: 'Advertiser', required: true, description: 'Client/Advertiser name' },
                { field: 'startDate', target: 'start_date', fallback: 'Product Start Date', required: true, description: 'Product/Flight start (for rotations/copy changes)' },
                { field: 'productEndDate', target: 'product_end_date', fallback: 'Product End Date', required: false, description: 'Product/Flight end date' },
                { field: 'programEndDate', target: 'program_end_date', fallback: 'Program End Date', required: false, description: 'Program/Contract end date' },
                { field: 'market', target: 'market', fallback: 'Market', required: false, description: 'Market/DMA' },
                { field: 'campaign', target: 'campaign', fallback: 'Campaign', required: false, description: 'Campaign name' },
                { field: 'product', target: 'product', fallback: 'Product', required: false, description: 'Media type/Product' },
                { field: 'stage', target: 'stage', fallback: 'Inventory Opportunity Stage', required: true, description: 'Workflow stage/status' },
                { field: 'progress', target: 'progress', fallback: 'Progress', required: false, description: 'Install progress' },
                { field: 'qty', target: 'quantity', fallback: 'Quantity', required: false, description: 'Total quantity' },
                { field: 'installed', target: 'installed', fallback: 'Installed', required: false, description: 'Installed count' },
                { field: 'pending', target: 'pending', fallback: 'Pending', required: false, description: 'Pending count' },
                { field: 'firstInstall', target: 'first_install', fallback: 'First Install Date', required: false, description: 'First install date' },
                { field: 'completion', target: 'completion', fallback: 'Completion Date', required: false, description: 'Completion date' },
                { field: 'productionProof', target: 'production_proof', fallback: 'Production Proof', required: false, description: 'In-House or Client production' }
            ];

            fieldMappings.forEach(({ field, target, fallback, required }) => {
                // Pass usedHeaders to prevent column collisions
                const match = smartFindColumn(headers, target, 0.6, usedHeaders);
                const found = match && headers.includes(match);

                colMap[field] = match || fallback;

                // Claim this header so other fields can't use it
                if (match) {
                    usedHeaders.add(match);
                }

                mappingResults.push({
                    field,
                    mappedTo: match || fallback,
                    found,
                    required,
                    status: found ? 'matched' : (required ? 'missing' : 'optional')
                });
            });

            // Log mapping results for debugging
            console.log('üìä Smart Column Mapping Results:');
            console.log('Headers found:', headers.length);
            mappingResults.forEach(({ field, mappedTo, found, status }) => {
                const icon = status === 'matched' ? '‚úÖ' : (status === 'missing' ? '‚ùå' : '‚ö†Ô∏è');
                console.log(`  ${icon} ${field} ‚Üí "${mappedTo}"`);
            });

            // Store mapping results globally for UI feedback
            window.__lastColumnMapping = {
                headers,
                mappingResults,
                matched: mappingResults.filter(r => r.found).length,
                total: mappingResults.length,
                missingRequired: mappingResults.filter(r => r.status === 'missing').map(r => r.field)
            };

            return colMap;
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // --- DATA PROCESSING LOGIC ---

        // üß† UNIFIED PROCESSOR: Single Source of Truth (Master_Tracking_Export)
        // Handles aggregation, ghost detection, and all data transformation
        const processMasterExport = (rawRows) => {
            if (!rawRows || rawRows.length === 0) return { regular: [], specialty: [], lost: [], ghosts: [] };
            
            const headers = Object.keys(rawRows[0]);
            
            // üß† USE SMART COLUMN MAPPING - handles position changes and name variations
            const colMap = buildSmartColumnMap(headers);

            // Aggregation Map: Key = CampaignID | StartDate | Product
            const aggregationMap = new Map();
            const ghostItems = [];
            const currentYear = new Date().getFullYear();
            const maxYear = currentYear + 3; // Allow up to 3 years ahead for planning

            rawRows.forEach(row => {
                const id = (row[colMap.id] || '').toString().trim();
                if (!id) return;

                const rawStartDate = row[colMap.startDate] || '';
                const startDateObj = parseDate(rawStartDate);
                if (!startDateObj) return;

                // Year filter: Include past year through 3 years ahead
                const rowYear = startDateObj.getFullYear();
                if (rowYear < currentYear - 1 || rowYear > maxYear) return;

                const owner = (row[colMap.owner] || '').trim();
                const advertiser = (row[colMap.advertiser] || '').trim();
                const campaignName = (row[colMap.campaign] || '').trim();
                const product = (row[colMap.product] || '').trim();
                const market = (row[colMap.market] || '').trim();
                const stage = (row[colMap.stage] || '').trim();
                
                // Parse dates
                const rawProductEndDate = row[colMap.productEndDate] || '';
                const rawProgramEndDate = row[colMap.programEndDate] || '';
                const productEndDateObj = parseDate(rawProductEndDate);
                const programEndDateObj = parseDate(rawProgramEndDate);
                
                // Product End Date used for filtering (when this specific flight ends)
                // Program End Date is when the entire campaign ends (informational only)
                const effectiveEndDate = rawProductEndDate || rawProgramEndDate;
                const effectiveEndDateObj = productEndDateObj || programEndDateObj;

                // Parse metrics
                const qty = parseFloat(row[colMap.qty]) || 0;
                const installed = parseFloat(row[colMap.installed]) || 0;
                const pending = parseFloat(row[colMap.pending]) || 0;
                const progressStr = row[colMap.progress] || `${installed} / ${qty}`;
                
                // Parse install dates
                const firstInstallStr = row[colMap.firstInstall] || '';
                const completionStr = row[colMap.completion] || '';
                const firstInstallDate = parseDate(firstInstallStr);
                const completionDate = parseDate(completionStr);
                
                // Parse Production Proof (In-House vs Client-Produced)
                // If there's a link/value ‚Üí In-House production (proofs only exist for in-house)
                // If empty ‚Üí Client-produced or unknown
                const rawProductionProof = (row[colMap.productionProof] || '').toString().trim();
                let productionProof = null;
                let proofLink = null;
                
                // Check if it's a link (Google Drive, Dropbox, etc.)
                const isLink = rawProductionProof.startsWith('http') || 
                               rawProductionProof.includes('drive.google.com') || 
                               rawProductionProof.includes('dropbox.com') ||
                               rawProductionProof.includes('.pdf') ||
                               rawProductionProof.includes('.png') ||
                               rawProductionProof.includes('.jpg');
                
                if (isLink) {
                    // Has a proof link ‚Üí definitely in-house production
                    productionProof = 'in-house';
                    proofLink = rawProductionProof;
                } else if (rawProductionProof) {
                    // Has text value - check what it says
                    const valueLower = rawProductionProof.toLowerCase();
                    if (valueLower.includes('in-house') || valueLower.includes('inhouse') || valueLower === 'in house' || valueLower === 'yes' || valueLower === 'true') {
                        productionProof = 'in-house';
                    } else if (valueLower.includes('client') || valueLower.includes('external') || valueLower === 'no' || valueLower === 'false') {
                        productionProof = 'client';
                    } else if (valueLower.includes('mixed') || valueLower.includes('both')) {
                        productionProof = 'mixed';
                    } else {
                        // Has some value but not recognized - treat as in-house (likely a filename or reference)
                        productionProof = 'in-house';
                        proofLink = rawProductionProof; // Could be a filename
                    }
                }
                // If empty, productionProof stays null (unknown/client)

                // üëª GHOST DETECTION: No owner OR no stage = Ghost booking from SF
                const noOwner = !owner || owner.toLowerCase() === 'n/a' || owner === '-';
                const noStage = !stage || stage.trim() === '' || stage.toLowerCase() === 'n/a' || stage === '-';
                const isGhost = noOwner || noStage;
                const ghostReason = noOwner ? 'No Owner' : (noStage ? 'No Stage' : null);

                // Build base item
                const baseItem = {
                    id,
                    name: campaignName,
                    advertiser: advertiser || 'Unknown',
                    rawName: `${advertiser} | ${campaignName}`,
                    owner: owner || 'üëª NO OWNER',
                    market,
                    date: rawStartDate,
                    dateObj: startDateObj,
                    productEndDate: rawProductEndDate,
                    productEndDateObj,
                    programEndDate: rawProgramEndDate,
                    programEndDateObj,
                    // Effective end date for filtering (Product End Date = when this flight ends)
                    endDate: effectiveEndDate,
                    endDateObj: effectiveEndDateObj,
                    product,
                    media: product, // Alias
                    stage,
                    productionProof, // In-House, Client, Mixed, or null
                    proofLink, // URL to proof PDF/image if in-house
                    isGhost,
                    ghostReason
                };

                // If ghost, collect separately and SKIP from main aggregation
                // Ghosts should ONLY appear in Ghost Bookings, not Master Tracking
                if (isGhost) {
                    ghostItems.push({
                        ...baseItem,
                        quantity: qty,
                        totalQty: qty,
                        installed,
                        totalInstalled: installed,
                        pending,
                        progress: progressStr,
                        isComplete: pending === 0 && qty > 0,
                        firstInstall: firstInstallStr,
                        completion: completionStr
                    });
                    return; // ‚Üê SKIP from main aggregation - goes ONLY to Ghost Bookings
                }

                // AGGREGATION KEY: CampaignID + StartDate + Product + Market
                // This combines bonus lines (same campaign, date, product, market) into one row
                // But keeps different markets as separate rows
                const dateKey = startDateObj.toISOString().split('T')[0];
                const aggKey = `${id}|${dateKey}|${product}|${market}`;

                if (!aggregationMap.has(aggKey)) {
                    aggregationMap.set(aggKey, {
                        ...baseItem,
                        totalQty: 0,
                        totalInstalled: 0,
                        totalPending: 0,
                        lineCount: 0, // Track bonus lines
                        firstInstallDate: null,
                        rawFirstInstall: null,
                        completionDate: null,
                        rawCompletion: null
                    });
                }

                const item = aggregationMap.get(aggKey);
                item.totalQty += qty;
                item.totalInstalled += installed;
                item.totalPending += pending;
                item.lineCount += 1;

                // Track earliest first install and latest completion
                if (firstInstallDate) {
                    if (!item.firstInstallDate || firstInstallDate < item.firstInstallDate) {
                        item.firstInstallDate = firstInstallDate;
                        item.rawFirstInstall = firstInstallStr;
                    }
                }
                if (completionDate) {
                    if (!item.completionDate || completionDate > item.completionDate) {
                        item.completionDate = completionDate;
                        item.rawCompletion = completionStr;
                    }
                }
            });

            // Finalize aggregated items
            const regularItems = [];
            const specialtyItems = [];
            const lostItems = [];

            aggregationMap.forEach(item => {
                const finalItem = {
                    ...item,
                    quantity: item.totalQty,
                    installed: item.totalInstalled,
                    pending: item.totalPending,
                    progress: `${item.totalInstalled} / ${item.totalQty}`,
                    isComplete: item.totalPending === 0 && item.totalQty > 0,
                    firstInstall: item.rawFirstInstall,
                    completion: item.rawCompletion,
                    // Bonus indicator: Show if multiple lines were combined
                    hasBonus: item.lineCount > 1,
                    bonusNote: item.lineCount > 1 ? `(${item.lineCount} lines combined)` : ''
                };

                const stageLower = (finalItem.stage || '').toLowerCase().trim();
                
                // Route to appropriate category
                if (stageLower === 'lost opportunity' || stageLower === '- none -' || stageLower === '-none-') {
                    lostItems.push(finalItem);
                } else if (SPECIALTY_KEYWORDS.some(k => (finalItem.product || '').toLowerCase().includes(k))) {
                    specialtyItems.push(finalItem);
                } else {
                    regularItems.push(finalItem);
                }
            });

            return { 
                regular: regularItems, 
                specialty: specialtyItems, 
                lost: lostItems,
                ghosts: ghostItems
            };
        };

        // LEGACY: Keep processHoldReport as wrapper for backward compatibility
        const processHoldReport = (rawRows, installMap) => {
            // Now just delegates to the unified processor
            return processMasterExport(rawRows);
        };

        // LEGACY: Keep processInstallReport as wrapper for backward compatibility  
        const processInstallReport = (rawRows) => {
            const result = processMasterExport(rawRows);
            return { regular: result.regular };
        }

        // --- COMPONENTS ---
        
        // --- IMPRESSIONS LOOKUP MODAL ---
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GOOGLE SHEET SETTINGS MODAL (Hidden Feature - Triple-click on logo)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const GoogleSheetSettingsModal = ({ isOpen, onClose, currentSheetUrl, onSave }) => {
            const [sheetUrl, setSheetUrl] = useState(currentSheetUrl || '');
            const [testStatus, setTestStatus] = useState(null); // null, 'testing', 'success', 'error'
            const [testMessage, setTestMessage] = useState('');

            // Groq API Key state
            const [groqApiKey, setGroqApiKey] = useState('');
            const [groqKeyVisible, setGroqKeyVisible] = useState(false);
            const [groqSaveStatus, setGroqSaveStatus] = useState(null); // null, 'saved', 'error', 'invalid'

            // Weather settings
            const [weatherTempUnit, setWeatherTempUnit] = useState('F');
            const [weatherLocation, setWeatherLocationState] = useState('Los Angeles, CA');
            const availableCities = Object.keys(MARKET_COORDINATES).sort();

            useEffect(() => {
                if (isOpen) {
                    // Load saved URL from localStorage
                    const saved = localStorage.getItem('stap_google_sheet_url');
                    if (saved) setSheetUrl(saved);
                    // Load saved Groq API key
                    const savedKey = localStorage.getItem('stap_groq_api_key');
                    if (savedKey) setGroqApiKey(savedKey);
                    // Load weather settings
                    setWeatherTempUnit(getTempUnit());
                    setWeatherLocationState(getWeatherLocation());
                    // Reset save status
                    setGroqSaveStatus(null);
                }
            }, [isOpen]);

            const validateGroqKey = (key) => {
                if (!key || key.trim() === '') return 'empty';
                if (!key.startsWith('gsk_')) return 'invalid';
                if (key.length < 20) return 'too_short';
                return 'valid';
            };

            const handleSaveGroqKey = () => {
                const validation = validateGroqKey(groqApiKey);
                if (validation === 'empty') {
                    // Allow clearing the key
                    localStorage.removeItem('stap_groq_api_key');
                    setGroqSaveStatus('cleared');
                    setTimeout(() => setGroqSaveStatus(null), 3000);
                    return;
                }
                if (validation === 'invalid') {
                    setGroqSaveStatus('invalid');
                    setTimeout(() => setGroqSaveStatus(null), 3000);
                    return;
                }
                if (validation === 'too_short') {
                    setGroqSaveStatus('too_short');
                    setTimeout(() => setGroqSaveStatus(null), 3000);
                    return;
                }
                // Valid key - save it
                localStorage.setItem('stap_groq_api_key', groqApiKey.trim());
                setGroqSaveStatus('saved');
                setTimeout(() => setGroqSaveStatus(null), 3000);
            };
            
            const handleSave = () => {
                localStorage.setItem('stap_google_sheet_url', sheetUrl);
                if (onSave) onSave(sheetUrl);
                onClose();
            };
            
            const handleTest = async () => {
                if (!sheetUrl) {
                    setTestStatus('error');
                    setTestMessage('Please enter a Google Sheet URL');
                    return;
                }
                
                setTestStatus('testing');
                setTestMessage('Testing connection...');
                
                try {
                    // Extract sheet ID from URL
                    const sheetIdMatch = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (!sheetIdMatch) {
                        throw new Error('Invalid Google Sheet URL format');
                    }
                    
                    const sheetId = sheetIdMatch[1];
                    
                    // Extract gid (tab ID) if present
                    const gidMatch = sheetUrl.match(/gid=(\d+)/);
                    const gid = gidMatch ? gidMatch[1] : '0';
                    
                    // Build CSV export URL with gid
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    
                    // Try multiple CORS proxies
                    const proxies = [
                        (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                        (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                        (url) => url // Direct fetch as last resort
                    ];
                    
                    let text = null;
                    let lastError = null;
                    
                    for (const proxyFn of proxies) {
                        try {
                            const proxyUrl = proxyFn(csvUrl);
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 8000);
                            
                            const response = await fetch(proxyUrl, { 
                                signal: controller.signal,
                                headers: { 'Accept': 'text/csv,*/*' }
                            });
                            clearTimeout(timeoutId);
                            
                            text = await response.text();
                            
                            // Check if it looks like CSV data (not HTML error page)
                            if (!text.includes('<!DOCTYPE') && !text.includes('<html') && text.trim().length > 0) {
                                break; // Success!
                            }
                            text = null; // Reset and try next proxy
                        } catch (e) {
                            lastError = e;
                            continue;
                        }
                    }
                    
                    if (!text) {
                        throw new Error('Sheet not accessible. Make sure:\n1. Sharing is set to "Anyone with the link"\n2. The URL is correct');
                    }
                    
                    // Count rows
                    const rows = text.split('\n').filter(r => r.trim()).length;
                    
                    // Check first row for headers
                    const firstRow = text.split('\n')[0] || '';
                    const hasHeaders = firstRow.toLowerCase().includes('campaign') || 
                                      firstRow.toLowerCase().includes('advertiser') ||
                                      firstRow.toLowerCase().includes('date');
                    
                    setTestStatus('success');
                    setTestMessage(`‚úÖ Connected! Found ${rows} rows${gid !== '0' ? ` (tab gid=${gid})` : ''}.${hasHeaders ? ' Headers detected.' : ''}`);
                    
                } catch (err) {
                    setTestStatus('error');
                    setTestMessage(`‚ùå ${err.message || 'Connection failed'}`);
                }
            };
            
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-900 rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden border border-slate-700" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="px-6 py-4 border-b border-slate-700 bg-slate-800 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-500/20 rounded-lg">
                                    <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold text-white">Live Sync Settings</h2>
                                    <p className="text-xs text-slate-400">Configure Google Sheet connection</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        {/* Body */}
                        <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                            {/* Sheet URL Input */}
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Google Sheet URL</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text"
                                        value={sheetUrl}
                                        onChange={(e) => setSheetUrl(e.target.value)}
                                        placeholder="https://docs.google.com/spreadsheets/d/..."
                                        className="flex-1 px-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                    />
                                    <button 
                                        onClick={handleTest}
                                        disabled={testStatus === 'testing'}
                                        className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors disabled:opacity-50"
                                    >
                                        {testStatus === 'testing' ? 'Testing...' : 'Test'}
                                    </button>
                                </div>
                                {testMessage && (
                                    <p className={`mt-2 text-sm ${testStatus === 'success' ? 'text-green-400' : testStatus === 'error' ? 'text-red-400' : 'text-slate-400'}`}>
                                        {testMessage}
                                    </p>
                                )}
                            </div>
                            
                            {/* Required Google Sheet Settings */}
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                                    <span className="text-yellow-400">‚öôÔ∏è</span> Required Google Sheet Settings
                                </h3>
                                <ol className="space-y-2 text-sm text-slate-300">
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">1.</span>
                                        <span>Open your Google Sheet and click <strong className="text-white">Share</strong> (top right)</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">2.</span>
                                        <span>Under "General access", change from "Restricted" to <strong className="text-green-400">"Anyone with the link"</strong></span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">3.</span>
                                        <span>Set role to <strong className="text-white">"Viewer"</strong> (read-only is fine)</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">4.</span>
                                        <span>Click <strong className="text-white">Copy link</strong> and paste it above</span>
                                    </li>
                                </ol>
                            </div>
                            
                            {/* Required Columns */}
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                                    <span className="text-green-400">üìã</span> Required Columns
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">Your Google Sheet must have these column headers (case-insensitive):</p>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Campaign ID</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Advertiser</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Campaign Name</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Product Start Date</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Product End Date</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Install Stage</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Market</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Quantity</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Installed</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Product</span>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-2"><span className="text-red-400">*</span> = Required, <span className="text-slate-500">‚óã</span> = Optional</p>
                            </div>
                            
                            {/* Tips */}
                            <div className="bg-blue-500/10 rounded-xl p-4 border border-blue-500/30">
                                <h3 className="font-bold text-blue-400 mb-2 flex items-center gap-2">
                                    <span>üí°</span> Pro Tips
                                </h3>
                                <ul className="space-y-1 text-xs text-slate-300">
                                    <li>‚Ä¢ The first row must contain column headers</li>
                                    <li>‚Ä¢ Dates should be in MM/DD/YYYY or YYYY-MM-DD format</li>
                                    <li>‚Ä¢ The system auto-detects similar column names (e.g., "Start Date" ‚Üí "Product Start Date")</li>
                                    <li>‚Ä¢ Sheet must have at least one data row below headers</li>
                                    <li>‚Ä¢ If sync fails, it will fall back to your last uploaded CSV data</li>
                                </ul>
                            </div>

                            {/* Groq API Key */}
                            <div className="bg-gradient-to-r from-orange-500/10 to-red-500/10 rounded-xl p-4 border border-orange-500/30">
                                <h3 className="font-bold text-orange-400 mb-3 flex items-center gap-2">
                                    <span>ü§ñ</span> AI Features (Groq API)
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    Power AI analysis features with Groq's Llama 3.3 70B model. Get a free API key at <a href="https://console.groq.com/keys" target="_blank" rel="noopener" className="text-orange-400 hover:underline">console.groq.com/keys</a>
                                </p>
                                <div>
                                    <label className="block text-xs font-medium text-slate-400 mb-1">API Key</label>
                                    <div className="relative">
                                        <input
                                            type={groqKeyVisible ? 'text' : 'password'}
                                            value={groqApiKey}
                                            onChange={(e) => setGroqApiKey(e.target.value)}
                                            placeholder="gsk_..."
                                            className={`w-full px-3 py-2 pr-20 bg-slate-800 border rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none font-mono ${
                                                groqSaveStatus === 'invalid' || groqSaveStatus === 'too_short'
                                                    ? 'border-red-500'
                                                    : groqSaveStatus === 'saved'
                                                        ? 'border-green-500'
                                                        : 'border-slate-600'
                                            }`}
                                        />
                                        <button
                                            type="button"
                                            onClick={() => setGroqKeyVisible(!groqKeyVisible)}
                                            className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white text-xs px-2 py-1 rounded"
                                        >
                                            {groqKeyVisible ? 'üôà Hide' : 'üëÅÔ∏è Show'}
                                        </button>
                                    </div>
                                    <div className="flex items-center justify-between mt-2">
                                        <p className="text-xs text-slate-500">üîí Stored locally in your browser only</p>
                                        <button
                                            onClick={handleSaveGroqKey}
                                            className="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs font-medium rounded-lg transition-colors"
                                        >
                                            Save Key
                                        </button>
                                    </div>
                                    {/* Status Messages */}
                                    {groqSaveStatus === 'saved' && (
                                        <div className="mt-2 px-3 py-2 bg-green-500/20 border border-green-500/50 rounded-lg text-green-400 text-xs flex items-center gap-2">
                                            <span>‚úì</span> API key saved successfully!
                                        </div>
                                    )}
                                    {groqSaveStatus === 'cleared' && (
                                        <div className="mt-2 px-3 py-2 bg-blue-500/20 border border-blue-500/50 rounded-lg text-blue-400 text-xs flex items-center gap-2">
                                            <span>‚ÑπÔ∏è</span> API key cleared
                                        </div>
                                    )}
                                    {groqSaveStatus === 'invalid' && (
                                        <div className="mt-2 px-3 py-2 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-xs flex items-center gap-2">
                                            <span>‚úï</span> Invalid key format. Must start with "gsk_"
                                        </div>
                                    )}
                                    {groqSaveStatus === 'too_short' && (
                                        <div className="mt-2 px-3 py-2 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-xs flex items-center gap-2">
                                            <span>‚úï</span> API key appears too short
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Production Proof Webhook Sync */}
                            <div className="bg-gradient-to-r from-teal-500/10 to-emerald-500/10 rounded-xl p-4 border border-teal-500/30">
                                <h3 className="font-bold text-teal-400 mb-3 flex items-center gap-2">
                                    <span>üîÑ</span> Production Proof Sync (Optional)
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    Sync production proof changes (In-House/Client/Mixed) back to your Google Sheet in real-time using Apps Script.
                                </p>
                                <div className="mb-3">
                                    <label className="block text-xs font-medium text-slate-400 mb-1">Webhook URL</label>
                                    <input
                                        type="text"
                                        defaultValue={localStorage.getItem('stap_proof_webhook') || ''}
                                        onChange={(e) => localStorage.setItem('stap_proof_webhook', e.target.value)}
                                        placeholder="https://script.google.com/macros/s/..."
                                        className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
                                    />
                                </div>
                                <details className="text-xs">
                                    <summary className="cursor-pointer text-teal-400 hover:text-teal-300 font-medium">
                                        üìã Apps Script Setup Instructions
                                    </summary>
                                    <div className="mt-3 p-3 bg-slate-900/70 rounded-lg border border-slate-700 space-y-2 text-slate-300">
                                        <p><strong className="text-white">1.</strong> Open your Google Sheet ‚Üí Extensions ‚Üí Apps Script</p>
                                        <p><strong className="text-white">2.</strong> Paste this code:</p>
                                        <pre className="bg-black/50 p-2 rounded text-[10px] overflow-x-auto font-mono text-green-400">{`function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  if (data.action === 'updateProof') {
    const sheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName('Master Export'); // Change to your sheet name
    const dataRange = sheet.getDataRange().getValues();
    const headers = dataRange[0];

    // Find column indices
    const idCol = headers.findIndex(h =>
      h.toLowerCase().includes('campaign id'));
    const proofCol = headers.findIndex(h =>
      h.toLowerCase().includes('production'));

    if (idCol === -1 || proofCol === -1) {
      return ContentService.createTextOutput(
        JSON.stringify({success: false, error: 'Columns not found'})
      );
    }

    // Find row and update
    const [campaignId, date] = data.campaignKey.split('_');
    for (let i = 1; i < dataRange.length; i++) {
      if (dataRange[i][idCol] == campaignId) {
        sheet.getRange(i + 1, proofCol + 1)
          .setValue(data.productionProof);
        break;
      }
    }

    return ContentService.createTextOutput(
      JSON.stringify({success: true})
    ).setMimeType(ContentService.MimeType.JSON);
  }
}`}</pre>
                                        <p><strong className="text-white">3.</strong> Deploy ‚Üí New deployment ‚Üí Web app</p>
                                        <p><strong className="text-white">4.</strong> Set "Execute as" = <span className="text-amber-400">Me</span>, "Who has access" = <span className="text-amber-400">Anyone</span></p>
                                        <p><strong className="text-white">5.</strong> Copy the deployment URL and paste above</p>
                                    </div>
                                </details>
                            </div>

                            {/* Backup & Restore Settings */}
                            <div className="bg-gradient-to-r from-purple-500/10 to-indigo-500/10 rounded-xl p-4 border border-purple-500/30">
                                <h3 className="font-bold text-purple-400 mb-3 flex items-center gap-2">
                                    <span>üíæ</span> Backup & Restore Settings
                                </h3>
                                <p className="text-xs text-slate-400 mb-4">
                                    Export your settings (Sheet URLs, Webhook, etc.) to a file. Restore them after clearing cache or on a new device.
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            // Gather all settings from localStorage
                                            const settings = {
                                                version: '1.0',
                                                exportDate: new Date().toISOString(),
                                                settings: {
                                                    // Main data source
                                                    googleSheetUrl: localStorage.getItem('stap_google_sheet_url') || '',
                                                    // Material Receiver
                                                    materialSheetUrl: localStorage.getItem('stap_material_sheet_url') || '',
                                                    materialWebhook: localStorage.getItem('stap_material_webhook') || '',
                                                    // POP Gallery
                                                    popSheetUrl: localStorage.getItem('stap_pop_sheet_url') || '',
                                                    // Mobile
                                                    mobileSheetUrl: localStorage.getItem('stap_mobile_sheet_url') || '',
                                                    // Production Proof Sync
                                                    proofWebhook: localStorage.getItem('stap_proof_webhook') || '',
                                                    // AI Features
                                                    groqApiKey: localStorage.getItem('stap_groq_api_key') || '',
                                                    // Weather Settings
                                                    tempUnit: localStorage.getItem('STAP_TEMP_UNIT') || 'F',
                                                    weatherLocation: localStorage.getItem('STAP_WEATHER_LOCATION') || 'Los Angeles, CA',
                                                }
                                            };
                                            
                                            // Create and download file
                                            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `stap-settings-backup-${new Date().toISOString().split('T')[0]}.json`;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            URL.revokeObjectURL(url);
                                        }}
                                        className="flex-1 px-4 py-2.5 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Export Settings
                                    </button>
                                    <label className="flex-1 px-4 py-2.5 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                        </svg>
                                        Import Settings
                                        <input 
                                            type="file" 
                                            accept=".json"
                                            className="hidden"
                                            onChange={(e) => {
                                                const file = e.target.files?.[0];
                                                if (!file) return;
                                                
                                                const reader = new FileReader();
                                                reader.onload = (event) => {
                                                    try {
                                                        const data = JSON.parse(event.target.result);
                                                        
                                                        if (!data.settings) {
                                                            alert('Invalid settings file format');
                                                            return;
                                                        }
                                                        
                                                        // Restore settings to localStorage
                                                        const s = data.settings;
                                                        if (s.googleSheetUrl) localStorage.setItem('stap_google_sheet_url', s.googleSheetUrl);
                                                        if (s.materialSheetUrl) localStorage.setItem('stap_material_sheet_url', s.materialSheetUrl);
                                                        if (s.materialWebhook) localStorage.setItem('stap_material_webhook', s.materialWebhook);
                                                        if (s.popSheetUrl) localStorage.setItem('stap_pop_sheet_url', s.popSheetUrl);
                                                        if (s.mobileSheetUrl) localStorage.setItem('stap_mobile_sheet_url', s.mobileSheetUrl);
                                                        if (s.proofWebhook) localStorage.setItem('stap_proof_webhook', s.proofWebhook);
                                                        if (s.groqApiKey) localStorage.setItem('stap_groq_api_key', s.groqApiKey);
                                                        // Weather settings
                                                        if (s.tempUnit) localStorage.setItem('STAP_TEMP_UNIT', s.tempUnit);
                                                        if (s.weatherLocation) localStorage.setItem('STAP_WEATHER_LOCATION', s.weatherLocation);

                                                        // Update current modal's sheet URL
                                                        if (s.googleSheetUrl) setSheetUrl(s.googleSheetUrl);
                                                        
                                                        alert(`‚úÖ Settings restored from ${data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'backup'}!\n\nPlease refresh the page to apply all settings.`);
                                                    } catch (err) {
                                                        alert('Failed to parse settings file: ' + err.message);
                                                    }
                                                };
                                                reader.readAsText(file);
                                                e.target.value = ''; // Reset input
                                            }}
                                        />
                                    </label>
                                </div>
                                <p className="text-xs text-slate-500 mt-2">
                                    üìÅ Settings saved: Sheets, Webhooks, Groq API Key, Weather
                                </p>
                            </div>

                            {/* Weather Settings */}
                            <div className="bg-gradient-to-r from-sky-500/10 to-cyan-500/10 rounded-xl p-4 border border-sky-500/30">
                                <h3 className="font-bold text-sky-400 mb-3 flex items-center gap-2">
                                    <span>üå§Ô∏è</span> Weather Display Settings
                                </h3>
                                <p className="text-xs text-slate-400 mb-4">
                                    Configure the temperature unit and default location for weather widgets and email digest.
                                </p>
                                <div className="space-y-4">
                                    {/* Temperature Unit */}
                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Temperature Unit</label>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    setWeatherTempUnit('F');
                                                    setTempUnit('F');
                                                }}
                                                className={`flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${
                                                    weatherTempUnit === 'F'
                                                        ? 'bg-sky-600 text-white'
                                                        : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                }`}
                                            >
                                                ¬∞F Fahrenheit
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setWeatherTempUnit('C');
                                                    setTempUnit('C');
                                                }}
                                                className={`flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${
                                                    weatherTempUnit === 'C'
                                                        ? 'bg-sky-600 text-white'
                                                        : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                }`}
                                            >
                                                ¬∞C Celsius
                                            </button>
                                        </div>
                                    </div>
                                    {/* Weather Location */}
                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Default Location</label>
                                        <select
                                            value={weatherLocation}
                                            onChange={(e) => {
                                                setWeatherLocationState(e.target.value);
                                                setWeatherLocation(e.target.value);
                                            }}
                                            className="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-sky-500 focus:border-transparent outline-none"
                                        >
                                            {availableCities.map(city => (
                                                <option key={city} value={city}>{city}</option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-slate-500 mt-1">
                                            This location will be used for the weather widget and email digest.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t border-slate-700 bg-slate-800 flex justify-between items-center">
                            <p className="text-xs text-slate-500">
                                üîí Your sheet URL is stored locally in your browser
                            </p>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-400 hover:text-white transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleSave}
                                    className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // --- DIGEST MODAL (External - loaded from digestModal.js) ---
        const DigestModal = (window.STAPDigestModal && window.STAPDigestModal.DigestModal) || (props => null);


        const WeatherWidget = () => {
            const [weatherData, setWeatherData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedCity, setSelectedCity] = useState(getWeatherLocation());
            const [currentCondition, setCurrentCondition] = useState({ temp: 72, condition: 'Clear', icon: 'Sun' });
            const [tempUnit, setTempUnitState] = useState(getTempUnit());
            const [showCityDropdown, setShowCityDropdown] = useState(false);

            // Available cities from MARKET_COORDINATES
            const availableCities = Object.keys(MARKET_COORDINATES).sort();

            const toggleTempUnit = () => {
                const newUnit = tempUnit === 'F' ? 'C' : 'F';
                setTempUnit(newUnit);
                setTempUnitState(newUnit);
            };

            const handleCityChange = (city) => {
                setSelectedCity(city);
                setWeatherLocation(city);
                setShowCityDropdown(false);
            };

            useEffect(() => {
                const loadWeather = async () => {
                    setIsLoading(true);
                    try {
                        const data = await fetchLiveWeather(selectedCity);
                        setWeatherData(data);
                        if (data && data.length > 0) {
                            setCurrentCondition({
                                temp: data[0].temp,
                                condition: data[0].condition,
                                icon: data[0].icon
                            });
                        }
                    } catch (e) {
                        console.error('Weather fetch failed:', e);
                        setWeatherData(WEATHER_FORECAST);
                        setCurrentCondition({ temp: 72, condition: 'Clear', icon: 'Sun' });
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadWeather();
            }, [selectedCity]);

            const cityName = selectedCity.split(',')[0];
            const displayData = weatherData.length > 0 ? weatherData.slice(0, 7) : WEATHER_FORECAST.slice(0, 7);

            return (
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl overflow-hidden text-white h-full">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <div className="relative">
                                <button
                                    onClick={() => setShowCityDropdown(!showCityDropdown)}
                                    className="text-2xl font-bold flex items-center gap-2 hover:text-blue-100 transition-colors cursor-pointer"
                                >
                                    <Icon name={currentCondition.icon} size={24} className={currentCondition.icon === 'Sun' ? 'text-yellow-300' : 'text-gray-200'} />
                                    {cityName}
                                    <Icon name="ChevronDown" size={18} className={`transition-transform ${showCityDropdown ? 'rotate-180' : ''}`} />
                                </button>
                                <p className="text-blue-100 text-sm">7-Day Forecast {isLoading && <span className="animate-pulse">‚Ä¢ Loading...</span>}</p>

                                {showCityDropdown && (
                                    <div className="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl z-50 min-w-[200px] max-h-[300px] overflow-y-auto">
                                        {availableCities.map(city => (
                                            <button
                                                key={city}
                                                onClick={() => handleCityChange(city)}
                                                className={`w-full text-left px-4 py-2 text-sm hover:bg-blue-50 transition-colors ${
                                                    selectedCity === city ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-700'
                                                }`}
                                            >
                                                {city}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="text-right">
                                <div className="flex items-center gap-2 justify-end">
                                    <span className="text-3xl font-bold">{convertTemp(currentCondition.temp, tempUnit)}¬∞</span>
                                    <button
                                        onClick={toggleTempUnit}
                                        className="text-sm font-medium bg-white/20 hover:bg-white/30 px-2 py-1 rounded cursor-pointer transition-colors"
                                        title="Click to toggle ¬∞F/¬∞C"
                                    >
                                        ¬∞{tempUnit}
                                    </button>
                                    <span className="text-sm font-medium bg-white/20 px-2 py-1 rounded">{currentCondition.condition}</span>
                                </div>
                                <span className="block text-sm text-blue-100 mt-1">Today</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {displayData.map((day, idx) => (
                                <div key={idx} className="flex flex-col items-center p-2 rounded-lg hover:bg-white/10 transition-colors">
                                    <span className="text-xs font-medium text-blue-100 mb-2">{day.day}</span>
                                    <Icon name={day.icon || 'Cloud'} size={24} className={`mb-2 ${day.icon === 'Sun' ? 'text-yellow-300' : day.icon === 'CloudRain' ? 'text-blue-200' : 'text-gray-200'}`} />
                                    <div className="flex items-center gap-1 mb-1">
                                        <span className="font-bold text-lg">{convertTemp(day.temp, tempUnit)}¬∞</span>
                                    </div>
                                    <span className="text-[10px] text-blue-100 text-center leading-tight mb-1" title={day.condition || day.status}>{(day.condition || day.status || '').split(' ')[0]}</span>
                                    <div className="flex items-center gap-0.5 text-xs text-blue-200" title="Chance of Rain">
                                        <Icon name="CloudRain" size={10} />
                                        <span>{day.rainChance || day.rain || 0}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const HolidaysWidget = () => (
            <div className="bg-white rounded-2xl shadow-xl p-6 h-full border border-gray-100">
                <h3 className="text-gray-800 font-bold text-lg mb-4 flex items-center gap-2">
                    <div className="p-1.5 bg-red-100 rounded-lg text-red-600"><Icon name="Gift" size={18} /></div>
                    Upcoming Holidays
                </h3>
                <div className="space-y-4">
                    {UPCOMING_HOLIDAYS.map((h, i) => (
                        <div key={i} className="flex items-center gap-4 group">
                            <div className="w-12 h-12 rounded-xl bg-gray-50 flex flex-col items-center justify-center border border-gray-100 group-hover:border-red-200 group-hover:bg-red-50 transition-colors">
                                <span className="text-xs text-gray-500 uppercase font-bold group-hover:text-red-500">{h.date.split(' ')[0]}</span>
                                <span className="text-lg font-bold text-gray-800 group-hover:text-red-700">{h.date.split(' ')[1]}</span>
                            </div>
                            <div>
                                <h4 className="font-medium text-gray-900">{h.name}</h4>
                                <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{h.type}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const CustomizeModal = ({ isOpen, onClose, visibleKeys, onToggle, onReset, cardConfig, activeFilters, onClearFilters, customWidgets = [], onAddWidget, onEditWidget, onDeleteWidget }) => {
            if (!isOpen) return null;
            
            // Handle both old (market/product) and new (markets/products) filter formats
            const hasMarketFilters = activeFilters?.markets?.length > 0;
            const hasProductFilters = activeFilters?.products?.length > 0;
            const hasAnyFilters = hasMarketFilters || hasProductFilters;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <Icon name="Settings" size={20} /> Customize Dashboard
                            </h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full text-gray-500">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        
                        {/* Active Filters Section */}
                        {hasAnyFilters && (
                            <div className="px-6 py-3 bg-blue-50 border-b border-blue-100">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2 text-sm flex-wrap">
                                        <Icon name="Filter" size={14} className="text-blue-600" />
                                        <span className="text-blue-700 font-medium">Active Filters:</span>
                                        {hasMarketFilters && activeFilters.markets.map((m, i) => (
                                            <span key={`m-${i}`} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{m}</span>
                                        ))}
                                        {hasProductFilters && activeFilters.products.map((p, i) => (
                                            <span key={`p-${i}`} className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">{p}</span>
                                        ))}
                                    </div>
                                    <button 
                                        onClick={onClearFilters}
                                        className="text-xs text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <div className="p-6 max-h-[60vh] overflow-y-auto">
                            {/* Default Widgets Section */}
                            <p className="text-sm text-gray-500 mb-4">Select which cards you want to see on your dashboard.</p>
                            <div className="space-y-2 mb-6">
                                {Object.entries(cardConfig).map(([key, config]) => {
                                    const isVisible = visibleKeys.includes(key);
                                    return (
                                        <div 
                                            key={key} 
                                            onClick={() => onToggle(key)}
                                            className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isVisible ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-lg ${config.color.replace('text-', 'bg-').replace('600', '100')} ${config.color}`}>
                                                    <Icon name={config.icon} size={18} />
                                                </div>
                                                <span className="font-medium text-gray-800">{config.title.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')}</span>
                                            </div>
                                            <div className={isVisible ? "text-blue-600" : "text-gray-300"}>
                                                <Icon name={isVisible ? "Eye" : "EyeOff"} size={20} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Custom Widgets Section */}
                            <div className="border-t pt-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-semibold text-gray-800 flex items-center gap-2">
                                        <Icon name="Target" size={16} className="text-purple-600" />
                                        Custom Widgets
                                    </h4>
                                    <button
                                        onClick={onAddWidget}
                                        className="px-3 py-1.5 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-1"
                                    >
                                        <Icon name="Plus" size={14} /> New Widget
                                    </button>
                                </div>
                                
                                {customWidgets.length === 0 ? (
                                    <div className="text-center py-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                        <Icon name="Target" size={32} className="text-gray-300 mx-auto mb-2" />
                                        <p className="text-sm text-gray-500">No custom widgets yet</p>
                                        <p className="text-xs text-gray-400">Create widgets to track specific data</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {customWidgets.map(widget => (
                                            <div 
                                                key={widget.id} 
                                                className="flex items-center justify-between p-3 rounded-xl border border-purple-200 bg-purple-50/50"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg ${widget.color.replace('text-', 'bg-').replace('-600', '-100')} ${widget.color}`}>
                                                        <Icon name={widget.icon} size={18} />
                                                    </div>
                                                    <div>
                                                        <span className="font-medium text-gray-800">{widget.title}</span>
                                                        {widget.subtitle && <p className="text-xs text-gray-500">{widget.subtitle}</p>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <button 
                                                        onClick={() => onEditWidget(widget)}
                                                        className="p-2 hover:bg-purple-100 rounded-lg text-purple-600 transition-colors"
                                                        title="Edit"
                                                    >
                                                        <Icon name="Edit" size={16} />
                                                    </button>
                                                    <button 
                                                        onClick={() => onDeleteWidget(widget.id)}
                                                        className="p-2 hover:bg-red-100 rounded-lg text-red-500 transition-colors"
                                                        title="Delete"
                                                    >
                                                        <Icon name="X" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                            <button 
                                onClick={onReset}
                                className="text-sm text-red-600 hover:text-red-800 font-medium flex items-center gap-1"
                            >
                                <Icon name="RefreshCw" size={14} /> Reset to Default
                            </button>
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- DETAIL MODAL (External - loaded from detailModal.js) ---
        const DetailModal = (window.STAPDetailModal && window.STAPDetailModal.DetailModal) || (props => null);


        const FileUploader = ({ title, onFileSelect, status }) => (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors relative bg-white">
                <input 
                    type="file" 
                    accept=".csv"
                    onChange={(e) => onFileSelect(e.target.files[0])}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <div className="flex flex-col items-center gap-2">
                    <div className={`p-2 rounded-full ${status === 'done' ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>
                        <Icon name={status === 'done' ? 'CheckCircle' : 'UploadCloud'} size={20} />
                    </div>
                    <h3 className="font-semibold text-gray-700 text-sm">{title}</h3>
                    <p className="text-xs text-gray-500">{status === 'done' ? 'File Loaded' : 'Click or drag CSV here'}</p>
                </div>
            </div>
        );

        const StatCard = ({ title, value, subtitle, color, icon, onClick }) => (
            <div 
                onClick={onClick}
                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between hover:shadow-md transition-shadow cursor-pointer group"
            >
                <div>
                    <p className="text-sm font-medium text-gray-500 mb-1 group-hover:text-gray-700 transition-colors">{title}</p>
                    <h2 className="text-3xl font-bold text-gray-800">{typeof value === 'number' ? value.toLocaleString() : value}</h2>
                    {subtitle && <p className={`text-xs mt-2 font-medium ${color}`}>{subtitle}</p>}
                </div>
                <div className={`p-3 rounded-lg ${color.replace('text-', 'bg-').replace('600', '100').replace('500', '100')} ${color}`}>
                    <Icon name={icon} size={24} />
                </div>
            </div>
        );

        const MasterTrackingTable = ({ data, onRowClick, onBack, onOpenSettings }) => {
            // Column visibility state
            const [visibleCols, setVisibleCols] = useState({
                date: true, id: true, market: true, advertiser: true,
                product: true, stage: true, progress: true, charted: true, pending: true,
                firstInstall: false, completion: false, status: true
            });
            const [showColMenu, setShowColMenu] = useState(false);
            const [compactMode, setCompactMode] = useState(true); // Default to compact
            
            // Hidden settings gear - requires 5 clicks to open
            const settingsClickRef = useRef({ count: 0, timer: null });
            const handleSettingsClick = () => {
                settingsClickRef.current.count++;
                
                // Clear existing timer
                if (settingsClickRef.current.timer) {
                    clearTimeout(settingsClickRef.current.timer);
                }
                
                // Reset after 3 seconds of no clicks
                settingsClickRef.current.timer = setTimeout(() => {
                    settingsClickRef.current.count = 0;
                }, 3000);
                
                // Open settings on 5th click
                if (settingsClickRef.current.count >= 5) {
                    settingsClickRef.current.count = 0;
                    if (onOpenSettings) onOpenSettings();
                }
            };

            const downloadCSV = () => {
                const headers = ["Product Start Date", "Campaign Number", "Market", "Advertiser", "Campaign", "Product", "Inventory Opportunity Stage", "Progress", "Booked (SF)", "Charted", "Installed", "Pending", "First Install", "Completion"];
                const rows = data.map(row => [
                    `"${stripEmojis(row.rawDate || row.date || '')}"`,
                    `"${stripEmojis(row.id || '')}"`,
                    `"${stripEmojis(row.market || '')}"`,
                    `"${stripEmojis(row.advertiser || '')}"`,
                    `"${stripEmojis(row.name || '')}"`,
                    `"${stripEmojis(row.product || '')}"`,
                    `"${stripEmojis(row.stage || '')}"`,
                    `"${stripEmojis(row.progress || '')}"`,
                    row.totalQty || row.quantity || 0,
                    row.adjustedQty || '',
                    row.totalInstalled || row.installed || 0,
                    row.pending || 0,
                    `"${stripEmojis(row.firstInstall || '')}"`,
                    `"${stripEmojis(row.completion || '')}"`
                ]);
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Master_Tracking_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const toggleCol = (col) => setVisibleCols(prev => ({ ...prev, [col]: !prev[col] }));
            
            const colLabels = {
                date: 'Start Date', id: 'ID', market: 'Market', advertiser: 'Advertiser / Campaign',
                product: 'Product', stage: 'Stage', progress: 'Progress',
                charted: 'Charted', pending: 'Pending', firstInstall: 'First Install', completion: 'Completion', status: 'Status'
            };

            // Dynamic cell padding based on compact mode
            const cellPad = compactMode ? 'px-2 py-1.5' : 'px-4 py-3';
            const fontSize = compactMode ? 'text-xs' : 'text-sm';

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="px-4 py-3 border-b border-gray-100 flex flex-wrap justify-between items-center bg-gray-50 gap-2">
                    <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                    {onBack && (
                        <button onClick={onBack} className="p-1 hover:bg-gray-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                            <Icon name="ArrowLeft" size={18} />
                        </button>
                    )}
                    <Icon name="Settings" size={18} className="text-purple-600" />
                    Installations
                    <span className="text-xs text-gray-500 font-normal ml-1">‚Äî Click any row to update</span>
                    <span className="bg-purple-100 text-purple-700 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                    </h3>
                    <div className="flex items-center gap-2">
                        {/* Settings Gear - Hidden feature, requires 5 clicks to open */}
                        {onOpenSettings && (
                            <button 
                                onClick={handleSettingsClick}
                                className="p-1.5 hover:bg-gray-200 rounded-lg transition-colors text-gray-500 hover:text-gray-700"
                                title="Settings"
                            >
                                <Icon name="Settings" size={16} />
                            </button>
                        )}
                        {/* Compact Mode Toggle */}
                        <button 
                            onClick={() => setCompactMode(!compactMode)}
                            className={`flex items-center gap-1 text-xs font-medium px-2 py-1 rounded transition-colors ${compactMode ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            title="Toggle compact view"
                        >
                            <Icon name={compactMode ? "Minimize2" : "Maximize2"} size={12} />
                            {compactMode ? 'Compact' : 'Full'}
                        </button>
                        
                        {/* Column Visibility Menu */}
                        <div className="relative">
                            <button 
                                onClick={() => setShowColMenu(!showColMenu)}
                                className="flex items-center gap-1 text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
                            >
                                <Icon name="Columns" size={12} /> Columns
                            </button>
                            {showColMenu && (
                                <div className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-30 p-2 w-44">
                                    {Object.entries(colLabels).map(([key, label]) => (
                                        <label key={key} className="flex items-center gap-2 px-2 py-1 hover:bg-gray-50 rounded cursor-pointer text-xs">
                                            <input 
                                                type="checkbox" 
                                                checked={visibleCols[key]} 
                                                onChange={() => toggleCol(key)}
                                                className="rounded text-purple-600"
                                            />
                                            {label}
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <button onClick={downloadCSV} className="flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded transition-colors">
                            <Icon name="Download" size={12} /> CSV
                        </button>
                        <button onClick={() => exportToPDF('installations', data)} className="flex items-center gap-1 text-xs font-medium text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-2 py-1 rounded transition-colors">
                            <Icon name="FileText" size={12} /> PDF
                        </button>
                    </div>
                </div>

                {/* Click outside to close menu */}
                {showColMenu && <div className="fixed inset-0 z-20" onClick={() => setShowColMenu(false)} />}
                
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse" style={{ minWidth: compactMode ? '800px' : '1200px' }}>
                    <thead>
                        <tr className={`${compactMode ? 'text-[10px]' : 'text-xs'} font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider`}>
                        {visibleCols.date && <th className={`${cellPad} sticky left-0 bg-gray-50 z-10`}>Date</th>}
                        {visibleCols.id && <th className={`${cellPad} ${visibleCols.date ? '' : 'sticky left-0 bg-gray-50 z-10'}`}>ID</th>}
                        {visibleCols.market && <th className={cellPad}>Market</th>}
                        {visibleCols.advertiser && <th className={cellPad}>Advertiser / Campaign</th>}
                        {visibleCols.product && <th className={cellPad}>Product</th>}
                        {visibleCols.stage && <th className={cellPad}>Stage</th>}
                        {visibleCols.progress && <th className={cellPad}>Progress</th>}
                        {visibleCols.charted && <th className={`${cellPad} text-center`}>Charted</th>}
                        {visibleCols.pending && <th className={`${cellPad} text-center`}>Pend</th>}
                        {visibleCols.firstInstall && <th className={cellPad}>1st Install</th>}
                        {visibleCols.completion && <th className={cellPad}>Complete</th>}
                        {visibleCols.status && <th className={`${cellPad} text-right`}>Status</th>}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {data.map((row, idx) => (
                        <tr 
                            key={idx} 
                            onClick={() => onRowClick(row)}
                            className={`hover:bg-gray-50 transition-colors cursor-pointer ${row.hasQtyAdjustment ? 'bg-blue-50/50' : ''} ${row.isComplete ? 'bg-green-50/30' : ''} ${row.isGhost ? 'bg-orange-50' : ''}`}
                        >
                            {visibleCols.date && <td className={`${cellPad} ${fontSize} text-gray-600 whitespace-nowrap sticky left-0 bg-white ${row.hasQtyAdjustment ? 'bg-blue-50/50' : ''} ${row.isComplete ? 'bg-green-50/30' : ''} ${row.isGhost ? 'bg-orange-50' : ''}`}>{row.rawDate || row.date}</td>}
                            {visibleCols.id && <td className={`${cellPad} text-[10px] font-mono text-gray-500 ${!visibleCols.date ? 'sticky left-0 bg-white' : ''}`}>{row.id}</td>}
                            {visibleCols.market && <td className={`${cellPad} ${fontSize}`}>
                                {row.market ? (
                                    <span className="px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded text-[10px]">{row.market.split(',')[0]}</span>
                                ) : (
                                    <span className="text-gray-300">-</span>
                                )}
                            </td>}
                            {visibleCols.advertiser && <td className={`${cellPad} ${fontSize} max-w-[200px]`}>
                                <div className="font-medium text-gray-900 truncate" title={row.advertiser}>
                                    {row.advertiser}
                                    {row.isGhost && <span className="ml-1" title={row.ghostReason || 'Ghost Booking'}>üëª</span>}
                                </div>
                                <div className="text-gray-500 truncate text-[10px]" title={row.name}>
                                    {row.name}
                                    {row.isOverridden && <span className="ml-1 text-blue-500">‚úé</span>}
                                    {row.hasBonus && <span className="ml-1 px-1 bg-purple-100 text-purple-700 rounded text-[9px]" title={row.bonusNote}>+B</span>}
                                </div>
                            </td>}
                            {visibleCols.product && <td className={`${cellPad} ${fontSize} text-center`} title={row.product}>
                                <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-[10px] font-medium">{abbreviateProduct(row.product)}</span>
                            </td>}
                            {visibleCols.stage && <td className={cellPad}>
                                <span className={`px-1.5 py-0.5 rounded text-[10px] border ${getStatusColor(row.stage, row.dateObj)}`}>
                                    {row.stage}
                                </span>
                            </td>}
                            {visibleCols.progress && <td className={`${cellPad} ${fontSize} font-mono`}>{row.progress}</td>}
                            {visibleCols.charted && <td className={`${cellPad} text-center ${fontSize}`}>
                                {row.adjustedQty ? (
                                    <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium" title="Charted qty verified">
                                        {row.adjustedQty}
                                    </span>
                                ) : (
                                    <span className="text-gray-300">-</span>
                                )}
                            </td>}
                            {visibleCols.pending && <td className={`${cellPad} text-center font-bold ${fontSize}`}>
                                {row.pending > 0 ? <span className="text-orange-600">{row.pending}</span> : <span className="text-gray-300">-</span>}
                            </td>}
                            {visibleCols.firstInstall && <td className={`${cellPad} ${fontSize} font-mono text-gray-600 whitespace-nowrap`}>{row.firstInstall || '-'}</td>}
                            {visibleCols.completion && <td className={`${cellPad} ${fontSize} font-mono text-gray-600 whitespace-nowrap`}>{row.completion || '-'}</td>}
                            {visibleCols.status && <td className={`${cellPad} text-right`}>
                                <div className="flex items-center justify-end gap-1">
                                    {(() => {
                                        // Check both isComplete flag AND stage hierarchy for Done status
                                        const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                                        const stageLower = (row.stage || '').toLowerCase();
                                        const isDone = row.isComplete || completedStages.includes(stageLower);
                                        return isDone ? (
                                            <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded ${compactMode ? 'text-[10px]' : 'text-xs'} bg-green-100 text-green-700 font-medium`}>
                                                <Icon name="CheckCircle" size={compactMode ? 10 : 12} /> Done
                                            </span>
                                        ) : (
                                            <span className={`inline-flex items-center px-1.5 py-0.5 rounded ${compactMode ? 'text-[10px]' : 'text-xs'} bg-gray-100 text-gray-600`}>
                                                Active
                                            </span>
                                        );
                                    })()}
                                    {/* Production Proof Icon - only show if set */}
                                    {row.productionProof && (
                                        <ProductionIcon type={row.productionProof} size={12} compact />
                                    )}
                                </div>
                            </td>}
                        </tr>
                        ))}
                    </tbody>
                    </table>
                </div>
                </div>
            );
        };

        const CampaignTable = ({ data, title, onRowClick, dateLabel = "Start Date", dateKey = "date", view, onBack }) => {
            const downloadCSV = () => {
                // Always use just Qty - never use "X / X" format (Excel misreads as dates)
                const qtyHeader = view === 'expiredFlights' ? 'Removal Qty' : 'Qty';

                const headers = ["Stage", "Advertiser", "Campaign", "Product", "Market", dateLabel, qtyHeader, "ID"];
                const rows = data.map(row => {
                    // Always use Qty (booked), not "Installed / Qty" format
                    const qtyValue = row.quantity || row.totalQty || 0;

                    return [
                        `"${stripEmojis(row.stage || '')}"`,
                        `"${stripEmojis(row.advertiser || '')}"`,
                        `"${stripEmojis(row.name || '')}"`,
                        `"${stripEmojis((row.product || row.media || '').replace('Transit Shelters-', '').replace('Transit Shelter-', '').replace('Transit Buses-', ''))}"`,
                        `"${stripEmojis(row.market || '')}"`,
                        `"${stripEmojis(row[dateKey] || '')}"`,
                        qtyValue,
                        `"${stripEmojis(row.id || '')}"`
                    ];
                });
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100 relative">
                    {onBack && view !== 'dashboard' && (
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 hover:bg-gray-100 rounded-full transition-colors" title="Back to Dashboard">
                            <Icon name="ArrowLeft" size={18} />
                        </button>
                    )}
                    <div className="text-gray-400 mb-2 inline-block"><Icon name="Layers" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No campaigns found</h3>
                    <p className="text-gray-500 text-sm mb-4">No data matches your current filter.</p>
                    {onBack && view !== 'dashboard' && (
                        <button onClick={onBack} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                            <Icon name="ArrowLeft" size={14} className="inline mr-1" /> Back to Dashboard
                        </button>
                    )}
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
                    <div className="px-6 py-3 border-b bg-gray-50 flex justify-between items-center">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2 text-sm">
                            {onBack && view !== 'dashboard' && (
                                <button onClick={onBack} className="p-1 hover:bg-gray-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={16} />
                                </button>
                            )}
                            {/* Title icon based on view */}
                            {view === 'dashboard' && <Icon name="Calendar" size={16} className="text-blue-500" />}
                            {view === 'upcoming' && <Icon name="Sun" size={16} className="text-amber-500" />}
                            {view === 'recentInstalls' && <Icon name="CheckCircle" size={16} className="text-green-500" />}
                            {view === 'activeInstalls' && <Icon name="Hammer" size={16} className="text-orange-500" />}
                            {view === 'inProgressFlights' && <Icon name="Rocket" size={16} className="text-blue-500" />}
                            {view === 'delayedFlights' && <Icon name="Flame" size={16} className="text-red-500" />}
                            {view === 'onHoldCampaigns' && <Icon name="PauseCircle" size={16} className="text-gray-500" />}
                            {view === 'fullyInstalledThisWeek' && <Icon name="Award" size={16} className="text-yellow-500" />}
                            {view === 'currentWeekInstallCount' && <Icon name="TrendingUp" size={16} className="text-emerald-500" />}
                            {view === 'rotations' && <Icon name="RefreshCw" size={16} className="text-purple-500" />}
                            {view === 'materialReadyFuture' && <Icon name="Package" size={16} className="text-teal-500" />}
                            {view === 'expiredFlights' && <Icon name="Lightbulb" size={16} className="text-amber-500" />}
                            {view === 'pastDue' && <Icon name="AlertTriangle" size={16} className="text-orange-500" />}
                            {view?.startsWith('custom_') && <Icon name="Star" size={16} className="text-purple-500" />}
                            {(title || '').replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/gu, '').trim()}
                            <span className="bg-gray-200 text-gray-600 text-[10px] py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <div className="flex items-center gap-2">
                            <button onClick={downloadCSV} className="text-blue-600 text-xs flex gap-1.5 font-medium hover:text-blue-800 transition-colors">
                                <Icon name="Download" size={14}/> CSV
                            </button>
                            <button onClick={() => exportToPDF(view === 'expiredFlights' ? 'expired' : 'campaigns', data, { title: title || 'Campaign Report' })} className="text-red-600 text-xs flex gap-1.5 font-medium hover:text-red-800 transition-colors">
                                <Icon name="FileText" size={14}/> PDF
                            </button>
                        </div>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse table-fixed min-w-[1100px]">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-[10px] font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-2 py-2 w-[120px]">Stage</th>
                                    <th className="px-2 py-2 w-[220px]">Advertiser / Campaign</th>
                                    <th className="px-2 py-2 w-[110px]">Product</th>
                                    <th className="px-2 py-2 w-[120px]">Market</th>
                                    <th className="px-2 py-2 w-[70px]">{dateLabel}</th>
                                    <th className="px-2 py-2 text-center w-[36px]" title="In-House Installation"><Icon name="Home" size={12} /></th>
                                    <th className="px-2 py-2 text-right w-[45px]" title="Booked quantity from Salesforce">Qty</th>
                                    <th className="px-2 py-2 text-center w-[70px]" title="Charted units (verified from charting system)">Charted</th>
                                    <th className="px-2 py-2 w-[140px]" title="Installation progress">Progress</th>
                                    <th className="px-2 py-2 text-right w-[90px]">ID</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick(row)} className={`hover:bg-blue-50 cursor-pointer transition-colors ${row.isGhost ? 'bg-orange-50' : ''}`}>
                                        <td className="px-2 py-2">
                                            <div className="flex items-center gap-1 flex-wrap">
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] border whitespace-nowrap ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage || 'No Stage'}</span>
                                                {row.emailSentCount > 0 && (
                                                    <div className="flex items-center gap-0.5 px-1 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200" title="Emails sent">
                                                        <Icon name="Mail" size={8}/>
                                                        <span className="text-[8px] font-bold">{row.emailSentCount}</span>
                                                    </div>
                                                )}
                                                {row.isGhost && (
                                                    <span className="px-1 py-0.5 bg-orange-100 text-orange-700 rounded text-[8px] font-bold" title={row.ghostReason || 'Ghost Booking'}>üëª</span>
                                                )}
                                                {row.hasBonus && (
                                                    <span className="px-1 py-0.5 bg-purple-100 text-purple-700 rounded text-[8px]" title={row.bonusNote}>+B</span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-2 py-2">
                                            <div className="text-xs font-medium text-gray-900 truncate" title={row.advertiser}>{row.advertiser}</div>
                                            <div className="text-[10px] text-gray-500 truncate" title={row.name}>{row.name}</div>
                                        </td>
                                        <td className="px-2 py-2 text-center">
                                            <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-[10px] font-medium" title={row.product}>
                                                {abbreviateProduct(row.product)}
                                            </span>
                                        </td>
                                        <td className="px-2 py-2">
                                            {row.market ? (
                                                <span className="px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded text-[10px] block truncate" title={row.market}>{row.market}</span>
                                            ) : (
                                                <span className="text-gray-300 text-xs">-</span>
                                            )}
                                        </td>
                                        <td className="px-2 py-2 text-xs text-gray-600 whitespace-nowrap">{row[dateKey]}</td>
                                        <td className="px-2 py-2 text-center">
                                            {row.productionProof === 'in-house' ? (
                                                <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-teal-100 text-teal-600" title="In-House Installation">
                                                    <Icon name="Home" size={12} />
                                                </span>
                                            ) : (
                                                <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 text-gray-400" title="Outsourced / Client-Produced">
                                                    <Icon name="ExternalLink" size={12} />
                                                </span>
                                            )}
                                        </td>
                                        <td className="px-2 py-2 text-right text-xs font-semibold text-gray-900">{row.quantity || row.totalQty || 0}</td>
                                        <td className="px-2 py-2 text-center">
                                            {(() => {
                                                const booked = row.quantity || row.totalQty || 0;
                                                const charted = row.adjustedQty;
                                                if (charted === null || charted === undefined) {
                                                    return <span className="text-[10px] text-gray-400" title="Not verified - click row to verify">--</span>;
                                                } else if (charted === booked) {
                                                    return <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-[10px] font-medium" title="Matched">{charted} ‚úì</span>;
                                                } else if (charted < booked) {
                                                    return <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-[10px] font-medium" title={`${booked - charted} unlinked units`}>{charted} ‚ö†</span>;
                                                } else {
                                                    return <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-medium" title={`${charted - booked} over booked`}>{charted} ‚Üë</span>;
                                                }
                                            })()}
                                        </td>
                                        <td className="px-2 py-2">
                                            {(() => {
                                                const totalQty = row.adjustedQty || row.quantity || row.totalQty || 0;
                                                const installedQty = row.installed || row.totalInstalled || 0;
                                                const pendingQty = row.pending || row.totalPending || Math.max(0, totalQty - installedQty);
                                                const pct = totalQty > 0 ? Math.round((installedQty / totalQty) * 100) : 0;
                                                const barColor = pct >= 75 ? 'bg-green-500' : pct >= 50 ? 'bg-amber-500' : 'bg-red-400';

                                                if (totalQty === 0) {
                                                    return <span className="text-[10px] text-gray-400">--</span>;
                                                }

                                                return (
                                                    <div className="flex flex-col gap-0.5">
                                                        <div className="flex items-center gap-1.5">
                                                            <div className="flex-1 bg-gray-200 rounded-full h-1.5 min-w-[60px]">
                                                                <div className={`h-1.5 rounded-full ${barColor}`} style={{ width: `${pct}%` }}></div>
                                                            </div>
                                                            <span className="text-[10px] font-medium text-gray-700 whitespace-nowrap">{installedQty}/{totalQty}</span>
                                                        </div>
                                                        <div className="text-[9px] text-gray-500">
                                                            {pct}% ‚Ä¢ {pendingQty} pending
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </td>
                                        <td className="px-2 py-2 text-right text-[10px] text-gray-500 font-mono whitespace-nowrap">{row.id}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PipelineSummaryTable = ({ data }) => {
            const total = data.reduce((acc, curr) => acc + curr.count, 0);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-2xl mx-auto mt-8">
                    <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                            <Icon name="BarChart" size={20} className="text-blue-600" />
                            Pipeline Summary (This Month)
                        </h3>
                        <span className="bg-blue-100 text-blue-700 text-xs py-0.5 px-2 rounded-full font-bold">Total: {total}</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-6 py-3">Stage</th>
                                    <th className="px-6 py-3 text-right">Count</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, idx) => (
                                    <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                        <td className="px-6 py-3 font-medium text-gray-900">{row.stage}</td>
                                        <td className="px-6 py-3 text-right text-gray-600 font-mono">{row.count}</td>
                                    </tr>
                                ))}
                                <tr className="bg-gray-50 font-bold border-t border-gray-200">
                                    <td className="px-6 py-3 text-gray-900">Total</td>
                                    <td className="px-6 py-3 text-right text-blue-600">{total}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // üìã HOLD REPORT TABLE (Simplified View - No Install Metrics)
        const HoldReportTable = ({ data, onRowClick, onBack }) => {
            const downloadCSV = () => {
                const headers = ['Campaign #', 'Start Date', 'End Date', 'Market', 'Advertiser', 'Campaign', 'Product', 'Stage', 'Owner', 'Qty', 'Charted'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => [
                        stripEmojis(row.id || ''),
                        stripEmojis(row.date || ''),
                        stripEmojis(row.endDate || ''),
                        `"${stripEmojis((row.market || '').replace(/"/g, '""'))}"`,
                        `"${stripEmojis((row.advertiser || '').replace(/"/g, '""'))}"`,
                        `"${stripEmojis((row.name || '').replace(/"/g, '""'))}"`,
                        `"${stripEmojis((row.product || '').replace(/"/g, '""'))}"`,
                        stripEmojis(row.stage || ''),
                        stripEmojis(row.owner || ''),
                        row.quantity || row.totalQty || 0,
                        row.adjustedQty || ''
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `hold_report_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100 relative">
                    {onBack && (
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 hover:bg-amber-100 rounded-full transition-colors" title="Back to Dashboard">
                            <Icon name="ArrowLeft" size={18} />
                        </button>
                    )}
                    <div className="text-gray-400 mb-2 inline-block"><Icon name="ClipboardList" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No holds found</h3>
                    <p className="text-gray-500 text-sm mb-4">All campaigns are either completed or canceled.</p>
                    {onBack && (
                        <button onClick={onBack} className="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600 transition-colors">
                            <Icon name="ArrowLeft" size={14} className="inline mr-1" /> Back to Dashboard
                        </button>
                    )}
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="px-6 py-4 border-b bg-amber-50 flex justify-between items-center">
                        <h3 className="font-semibold text-amber-900 flex items-center gap-2">
                            {onBack && (
                                <button onClick={onBack} className="p-1 hover:bg-amber-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={18} />
                                </button>
                            )}
                            <Icon name="ClipboardList" size={20} /> Hold Report (Simplified View)
                            <span className="bg-amber-200 text-amber-800 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <div className="flex items-center gap-2">
                            <button onClick={downloadCSV} className="text-amber-700 text-sm flex gap-2 font-medium hover:text-amber-900 transition-colors">
                                <Icon name="Download" size={16}/> CSV
                            </button>
                            <button onClick={() => exportToPDF('holds', data)} className="text-red-600 text-sm flex gap-2 font-medium hover:text-red-800 transition-colors">
                                <Icon name="FileText" size={16}/> PDF
                            </button>
                        </div>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-4 py-3">ID</th>
                                    <th className="px-4 py-3">Start</th>
                                    <th className="px-4 py-3">End</th>
                                    <th className="px-4 py-3">Market</th>
                                    <th className="px-4 py-3">Advertiser / Campaign</th>
                                    <th className="px-4 py-3">Product</th>
                                    <th className="px-4 py-3">Stage</th>
                                    <th className="px-4 py-3">Owner</th>
                                    <th className="px-4 py-3 text-right">Qty</th>
                                    <th className="px-4 py-3 text-center">Charted</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick && onRowClick(row)} className="hover:bg-amber-50 cursor-pointer transition-colors">
                                        <td className="px-4 py-3 text-xs font-mono text-gray-500">{row.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.date}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.endDate}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">
                                            <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">{row.market || '-'}</span>
                                        </td>
                                        <td className="px-4 py-3">
                                            <div className="font-medium text-gray-900">{row.advertiser}</div>
                                            <div className="text-xs text-gray-500 truncate" title={row.name}>{row.name}</div>
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-xs font-medium" title={row.product}>
                                                {abbreviateProduct(row.product)}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs border ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage}</span>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.owner}</td>
                                        <td className="px-4 py-3 text-right text-sm font-mono text-gray-600">{row.quantity || row.totalQty}</td>
                                        <td className="px-4 py-3 text-center">
                                            {(() => {
                                                const booked = row.quantity || row.totalQty || 0;
                                                const charted = row.adjustedQty;
                                                if (charted === null || charted === undefined) {
                                                    return <span className="text-xs text-gray-400">--</span>;
                                                } else if (charted === booked) {
                                                    return <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">{charted} ‚úì</span>;
                                                } else if (charted < booked) {
                                                    return <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-medium">{charted} ‚ö†</span>;
                                                } else {
                                                    return <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">{charted} ‚Üë</span>;
                                                }
                                            })()}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // üëª GHOST BOOKINGS TABLE (SF Records with No Owner or No Stage)
        const GhostBookingsTable = ({ data, onRowClick, onBack }) => {
            const copyIds = () => {
                const ids = data.map(row => row.id).join('\n');
                navigator.clipboard.writeText(ids);
                alert(`${data.length} Campaign IDs copied to clipboard!`);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100 relative">
                    {onBack && (
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 hover:bg-orange-100 rounded-full transition-colors" title="Back to Dashboard">
                            <Icon name="ArrowLeft" size={18} />
                        </button>
                    )}
                    <div className="text-green-400 mb-2 inline-block"><Icon name="CheckCircle" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No ghost bookings</h3>
                    <p className="text-gray-500 text-sm mb-4">All campaigns have assigned sales owners, valid stages, and products.</p>
                    {onBack && (
                        <button onClick={onBack} className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                            <Icon name="ArrowLeft" size={14} className="inline mr-1" /> Back to Dashboard
                        </button>
                    )}
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-orange-200 overflow-hidden">
                    <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                        <h3 className="font-semibold text-orange-900 flex items-center gap-2">
                            {onBack && (
                                <button onClick={onBack} className="p-1 hover:bg-orange-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={18} />
                                </button>
                            )}
                            <Icon name="Ghost" size={20} /> üëª Ghost Bookings
                            <span className="bg-orange-200 text-orange-800 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <div className="flex items-center gap-2">
                            <button onClick={copyIds} className="text-orange-700 text-sm flex gap-2 font-medium hover:text-orange-900 transition-colors">
                                <Icon name="Copy" size={16}/> Copy IDs
                            </button>
                            <button onClick={() => exportToPDF('campaigns', data, { title: 'Ghost Bookings Report', subtitle: `${data.length} Missing Data Records | ${new Date().toLocaleDateString()}` })} className="text-red-600 text-sm flex gap-2 font-medium hover:text-red-800 transition-colors">
                                <Icon name="FileText" size={16}/> PDF
                            </button>
                        </div>
                    </div>
                    <div className="bg-orange-50 px-6 py-3 border-b border-orange-100">
                        <p className="text-sm text-orange-800">
                            ‚ö†Ô∏è These bookings need attention: missing sales owner, no stage, or no product assigned. Review in Salesforce before finalizing reports.
                        </p>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-4 py-3">Reason</th>
                                    <th className="px-4 py-3">Campaign #</th>
                                    <th className="px-4 py-3">Start Date</th>
                                    <th className="px-4 py-3">Market</th>
                                    <th className="px-4 py-3">Advertiser</th>
                                    <th className="px-4 py-3">Campaign</th>
                                    <th className="px-4 py-3">Product</th>
                                    <th className="px-4 py-3">Stage</th>
                                    <th className="px-4 py-3 text-right">Qty</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick && onRowClick(row)} className="hover:bg-orange-50 cursor-pointer transition-colors bg-orange-25">
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                row.ghostReason === 'No Stage' ? 'bg-purple-100 text-purple-700' : 
                                                row.ghostReason === 'No Product' ? 'bg-pink-100 text-pink-700' : 
                                                'bg-orange-100 text-orange-700'
                                            }`}>
                                                {row.ghostReason || 'No Owner'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-xs font-mono text-orange-700 font-bold">{row.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.date}</td>
                                        <td className="px-4 py-3 text-sm">
                                            <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">{row.market || '-'}</span>
                                        </td>
                                        <td className="px-4 py-3 font-medium text-gray-900">{row.advertiser}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.name}</td>
                                        <td className="px-4 py-3 text-center">
                                            {row.product ? (
                                                <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-xs font-medium" title={row.product}>
                                                    {abbreviateProduct(row.product)}
                                                </span>
                                            ) : (
                                                <span className="text-pink-500 italic text-xs">No Product</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs border ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage || 'No Stage'}</span>
                                        </td>
                                        <td className="px-4 py-3 text-right text-sm font-mono text-gray-600">{row.quantity || row.totalQty}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        // ===========================================
        // GEOPATH IMPRESSION ESTIMATOR BY ZIP CODE
        // ===========================================
        // Source: US Census Bureau 2022 Estimates
        // Formula based on population density + industry benchmarks
        // ===========================================
        
        const LA_ZIP_DATA = {
            // Format: ZIP: { pop: population, sqMi: square miles, area: name }
            // South LA
            '90001': { pop: 57652, sqMi: 4.5, area: 'Florence' },
            '90002': { pop: 53108, sqMi: 3.8, area: 'Watts' },
            '90003': { pop: 75024, sqMi: 4.2, area: 'South LA' },
            '90004': { pop: 58833, sqMi: 2.1, area: 'Hancock Park' },
            '90005': { pop: 37754, sqMi: 0.9, area: 'Koreatown' },
            '90006': { pop: 56628, sqMi: 1.4, area: 'Koreatown' },
            '90007': { pop: 41004, sqMi: 1.3, area: 'USC Area' },
            '90008': { pop: 33076, sqMi: 2.8, area: 'Baldwin Hills' },
            '90010': { pop: 4185, sqMi: 0.3, area: 'Mid-Wilshire' },
            '90011': { pop: 106042, sqMi: 4.8, area: 'South Central' },
            '90012': { pop: 38430, sqMi: 3.2, area: 'Downtown LA' },
            '90013': { pop: 14587, sqMi: 0.7, area: 'Downtown LA' },
            '90014': { pop: 9273, sqMi: 0.3, area: 'Fashion District' },
            '90015': { pop: 25554, sqMi: 1.1, area: 'South Park' },
            '90016': { pop: 47309, sqMi: 2.4, area: 'West Adams' },
            '90017': { pop: 28754, sqMi: 0.8, area: 'Downtown LA' },
            '90018': { pop: 49898, sqMi: 2.6, area: 'Jefferson Park' },
            '90019': { pop: 59410, sqMi: 2.8, area: 'Mid-City' },
            '90020': { pop: 38400, sqMi: 0.8, area: 'Koreatown' },
            '90021': { pop: 2781, sqMi: 1.2, area: 'Industrial District' },
            '90023': { pop: 44558, sqMi: 3.5, area: 'Boyle Heights' },
            '90024': { pop: 50392, sqMi: 2.9, area: 'Westwood' },
            '90025': { pop: 44429, sqMi: 3.4, area: 'West LA' },
            '90026': { pop: 64769, sqMi: 3.1, area: 'Echo Park' },
            '90027': { pop: 45764, sqMi: 5.8, area: 'Los Feliz' },
            '90028': { pop: 30982, sqMi: 1.8, area: 'Hollywood' },
            '90029': { pop: 34649, sqMi: 1.3, area: 'Thai Town' },
            '90031': { pop: 37457, sqMi: 4.2, area: 'Lincoln Heights' },
            '90032': { pop: 44881, sqMi: 3.8, area: 'El Sereno' },
            '90033': { pop: 47655, sqMi: 2.1, area: 'Boyle Heights' },
            '90034': { pop: 55061, sqMi: 2.5, area: 'Palms' },
            '90035': { pop: 26595, sqMi: 1.8, area: 'Mid-City' },
            '90036': { pop: 37713, sqMi: 2.1, area: 'Fairfax' },
            '90037': { pop: 69064, sqMi: 3.2, area: 'Vermont Square' },
            '90038': { pop: 27979, sqMi: 1.4, area: 'Hollywood' },
            '90039': { pop: 28244, sqMi: 2.8, area: 'Silver Lake' },
            '90041': { pop: 28321, sqMi: 3.5, area: 'Eagle Rock' },
            '90042': { pop: 59151, sqMi: 5.8, area: 'Highland Park' },
            '90043': { pop: 44461, sqMi: 3.2, area: 'View Park' },
            '90044': { pop: 98990, sqMi: 5.2, area: 'Vermont-Slauson' },
            '90045': { pop: 41123, sqMi: 5.4, area: 'Westchester' },
            '90046': { pop: 48170, sqMi: 4.2, area: 'West Hollywood' },
            '90047': { pop: 52200, sqMi: 4.5, area: 'Vermont Knolls' },
            '90048': { pop: 20411, sqMi: 1.2, area: 'Beverly Grove' },
            '90049': { pop: 35819, sqMi: 8.2, area: 'Brentwood' },
            '90056': { pop: 8225, sqMi: 0.9, area: 'Ladera Heights' },
            '90057': { pop: 47142, sqMi: 1.1, area: 'Westlake' },
            '90058': { pop: 3049, sqMi: 4.8, area: 'Vernon' },
            '90059': { pop: 39471, sqMi: 2.8, area: 'Green Meadows' },
            '90061': { pop: 28646, sqMi: 2.1, area: 'Vermont Vista' },
            '90062': { pop: 33528, sqMi: 2.0, area: 'South LA' },
            '90063': { pop: 52008, sqMi: 3.8, area: 'East LA' },
            '90064': { pop: 25956, sqMi: 2.1, area: 'Rancho Park' },
            '90065': { pop: 44897, sqMi: 5.2, area: 'Cypress Park' },
            '90066': { pop: 54142, sqMi: 4.5, area: 'Mar Vista' },
            '90067': { pop: 2653, sqMi: 0.5, area: 'Century City' },
            '90068': { pop: 21064, sqMi: 4.8, area: 'Hollywood Hills' },
            '90069': { pop: 20045, sqMi: 1.8, area: 'West Hollywood' },
            '90071': { pop: 313, sqMi: 0.2, area: 'Financial District' },
            '90077': { pop: 7868, sqMi: 6.5, area: 'Bel Air' },
            '90210': { pop: 19180, sqMi: 5.8, area: 'Beverly Hills' },
            '90272': { pop: 21298, sqMi: 8.5, area: 'Pacific Palisades' },
            '90290': { pop: 5300, sqMi: 8.2, area: 'Topanga' },
            '90291': { pop: 25656, sqMi: 2.1, area: 'Venice' },
            '90292': { pop: 24481, sqMi: 3.2, area: 'Marina del Rey' },
            '90293': { pop: 13039, sqMi: 1.8, area: 'Playa del Rey' },
            '90402': { pop: 11816, sqMi: 0.8, area: 'Santa Monica' },
            // San Fernando Valley
            '91040': { pop: 20911, sqMi: 4.2, area: 'Sunland' },
            '91042': { pop: 27119, sqMi: 12.5, area: 'Tujunga' },
            '91303': { pop: 30611, sqMi: 4.8, area: 'Canoga Park' },
            '91304': { pop: 54369, sqMi: 8.2, area: 'Canoga Park' },
            '91306': { pop: 49460, sqMi: 5.8, area: 'Winnetka' },
            '91307': { pop: 25368, sqMi: 12.5, area: 'West Hills' },
            '91311': { pop: 40196, sqMi: 5.5, area: 'Chatsworth' },
            '91316': { pop: 34305, sqMi: 3.8, area: 'Encino' },
            '91324': { pop: 29744, sqMi: 3.2, area: 'Northridge' },
            '91325': { pop: 35537, sqMi: 3.8, area: 'Northridge' },
            '91326': { pop: 36503, sqMi: 8.5, area: 'Porter Ranch' },
            '91330': { pop: 2699, sqMi: 0.8, area: 'CSUN' },
            '91331': { pop: 99804, sqMi: 8.2, area: 'Pacoima' },
            '91335': { pop: 77158, sqMi: 6.5, area: 'Reseda' },
            '91340': { pop: 34822, sqMi: 3.5, area: 'San Fernando' },
            '91342': { pop: 92580, sqMi: 18.5, area: 'Sylmar' },
            '91343': { pop: 63193, sqMi: 5.2, area: 'North Hills' },
            '91344': { pop: 53862, sqMi: 8.8, area: 'Granada Hills' },
            '91345': { pop: 18481, sqMi: 2.1, area: 'Mission Hills' },
            '91352': { pop: 45601, sqMi: 4.5, area: 'Sun Valley' },
            '91356': { pop: 30599, sqMi: 3.2, area: 'Tarzana' },
            '91364': { pop: 28765, sqMi: 4.2, area: 'Woodland Hills' },
            '91367': { pop: 44862, sqMi: 5.8, area: 'Woodland Hills' },
            '91401': { pop: 39179, sqMi: 2.5, area: 'Van Nuys' },
            '91402': { pop: 67937, sqMi: 4.8, area: 'Panorama City' },
            '91403': { pop: 25887, sqMi: 2.8, area: 'Sherman Oaks' },
            '91405': { pop: 55451, sqMi: 3.5, area: 'Van Nuys' },
            '91406': { pop: 53276, sqMi: 4.2, area: 'Van Nuys' },
            '91411': { pop: 23689, sqMi: 1.8, area: 'Van Nuys' },
            '91423': { pop: 31787, sqMi: 3.8, area: 'Sherman Oaks' },
            '91436': { pop: 16190, sqMi: 2.1, area: 'Encino' },
            '91601': { pop: 35615, sqMi: 2.8, area: 'North Hollywood' },
            '91602': { pop: 19980, sqMi: 2.5, area: 'North Hollywood' },
            '91604': { pop: 32073, sqMi: 3.5, area: 'Studio City' },
            '91605': { pop: 51654, sqMi: 3.8, area: 'North Hollywood' },
            '91606': { pop: 43552, sqMi: 2.8, area: 'North Hollywood' },
            '91607': { pop: 30734, sqMi: 2.5, area: 'Valley Village' },
            // Harbor Area
            '90501': { pop: 42536, sqMi: 4.8, area: 'Torrance' },
            '90502': { pop: 18430, sqMi: 2.5, area: 'Torrance' },
            '90710': { pop: 27517, sqMi: 3.8, area: 'Harbor City' },
            '90731': { pop: 63431, sqMi: 8.5, area: 'San Pedro' },
            '90732': { pop: 22078, sqMi: 5.2, area: 'San Pedro' },
            '90744': { pop: 54277, sqMi: 6.8, area: 'Wilmington' },
            '90810': { pop: 36306, sqMi: 4.2, area: 'Long Beach' },
        };

        // Industry standard multipliers (based on Geopath methodology)
        const PRODUCT_MULTIPLIERS = {
            'Panel-Targeted': 1.15,      // High visibility, strategic placement
            'Panel-Network': 0.95,       // Standard network placement
            'Digital': 2.8,              // Multiple rotations, higher frequency
            'Digital Panel-Spot-Pl...': 2.8,
            'Transit Shelter': 0.65,     // Pedestrian focused, lower vehicle
            'Wallscape': 1.4,            // Large format, high visibility
            'Poster': 0.75,              // Standard poster
            'default': 1.0
        };

        /**
         * Estimate weekly impressions for a ZIP code
         * @param {string} zip - ZIP code
         * @param {string} product - Product type (optional)
         * @returns {object} - Impression estimates by product type
         */

        const STAT_CARD_CONFIG = {
            delayedFlights: {
                title: "Delayed / Overdue",
                subtitle: "Urgent (Last 3 Weeks)",
                color: "text-orange-600",
                icon: "Flame"
            },
            inProgressFlights: {
                title: "In-Progress Flights",
                subtitle: "Material Ready (Last 4 Weeks)",
                color: "text-teal-600",
                icon: "Rocket"
            },
            expiredFlights: {
                title: "Expired Flights",
                subtitle: "Installed - Ready for Removal",
                color: "text-gray-600",
                icon: "Lightbulb"
            },
            rotations: {
                title: "Rotations",
                subtitle: "Upcoming",
                color: "text-cyan-600",
                icon: "Repeat"
            },
            upcoming: {
                title: "Upcoming",
                subtitle: "Next 7 Days",
                color: "text-orange-600",
                icon: "Sun"
            },
            pastDue: {
                title: "Past Due",
                subtitle: "Older Backlog (3+ weeks)",
                color: "text-red-600",
                icon: "AlertTriangle"
            },
            activeInstalls: {
                title: "Active Installs",
                subtitle: "Last 30 Days",
                color: "text-purple-600",
                icon: "Hammer"
            },
            recentInstalls: {
                title: "Installed",
                subtitle: "Faces (Last 30 Days)",
                color: "text-green-600",
                icon: "CheckSquare"
            },
            fullyInstalledThisWeek: {
                title: "Installed This Week",
                subtitle: "Campaigns",
                color: "text-yellow-600",
                icon: "Medal"
            },
            currentWeekInstallCount: {
                title: "Installs This Week",
                subtitle: "Campaign Count",
                color: "text-emerald-600",
                icon: "TrendingUp"
            }
        };

        const DEFAULT_VISIBLE_CARDS = [
            'delayedFlights', 'inProgressFlights', 'expiredFlights', 'rotations', 'upcoming'
        ];

        // --- CUSTOM WIDGET MODAL ---
        const CustomWidgetModal = ({ isOpen, onClose, onSave, editWidget, allData = [] }) => {
            const [widgetConfig, setWidgetConfig] = useState({
                id: '',
                title: '',
                subtitle: '',
                icon: 'Target',
                color: 'text-blue-600',
                stages: [],
                owners: [],
                products: [],
                installStatus: '', // 'fully', 'partial', 'notStarted', ''
                dateLogic: '', // 'startingNext7', 'endingNext7', 'longRunning', ''
                volumeFilter: '', // 'high50', 'low10', ''
                displayValue: 'count' // 'count', 'qty', 'pending', 'installed'
            });
            
            // Reset form when opening/editing
            useEffect(() => {
                if (editWidget) {
                    setWidgetConfig(editWidget);
                } else {
                    setWidgetConfig({
                        id: `custom_${Date.now()}`,
                        title: '',
                        subtitle: '',
                        icon: 'Target',
                        color: 'text-blue-600',
                        stages: [],
                        owners: [],
                        products: [],
                        installStatus: '',
                        dateLogic: '',
                        volumeFilter: '',
                        displayValue: 'count'
                    });
                }
            }, [editWidget, isOpen]);
            
            // Get unique values from data
            const uniqueStages = [...new Set(allData.map(d => d.stage).filter(Boolean))].sort();
            const uniqueOwners = [...new Set(allData.map(d => d.owner).filter(Boolean))].sort();
            const uniqueProducts = [...new Set(allData.map(d => d.product || d.media).filter(Boolean))].sort();
            
            // Calculate preview value
            const getPreviewValue = () => {
                let filtered = [...allData];
                
                // Stage filter
                if (widgetConfig.stages.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.stages.includes(d.stage));
                }
                
                // Owner filter
                if (widgetConfig.owners.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.owners.includes(d.owner));
                }
                
                // Product filter
                if (widgetConfig.products.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.products.includes(d.product || d.media));
                }
                
                // Install status filter
                if (widgetConfig.installStatus === 'fully') {
                    filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                } else if (widgetConfig.installStatus === 'partial') {
                    filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                } else if (widgetConfig.installStatus === 'notStarted') {
                    filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                }
                
                // Date logic filter
                const today = new Date();
                today.setHours(0,0,0,0);
                if (widgetConfig.dateLogic === 'startingNext7') {
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                } else if (widgetConfig.dateLogic === 'endingNext7') {
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                } else if (widgetConfig.dateLogic === 'longRunning') {
                    filtered = filtered.filter(d => {
                        if (!d.dateObj || !d.endDateObj) return false;
                        const duration = (d.endDateObj - d.dateObj) / (1000 * 60 * 60 * 24);
                        return duration > 30;
                    });
                }
                
                // Volume filter
                if (widgetConfig.volumeFilter === 'high50') {
                    filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                } else if (widgetConfig.volumeFilter === 'low10') {
                    filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                }
                
                // Calculate display value
                if (widgetConfig.displayValue === 'count') {
                    return filtered.length;
                } else if (widgetConfig.displayValue === 'qty') {
                    return filtered.reduce((sum, d) => sum + (d.quantity || d.totalQty || 0), 0);
                } else if (widgetConfig.displayValue === 'pending') {
                    return filtered.reduce((sum, d) => sum + (d.pending || 0), 0);
                } else if (widgetConfig.displayValue === 'installed') {
                    return filtered.reduce((sum, d) => sum + (d.totalInstalled || d.installed || 0), 0);
                }
                return 0;
            };
            
            const toggleArrayItem = (arr, item) => {
                return arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item];
            };
            
            const iconOptions = [
                // Row 1 - Operations/Status
                'Target', 'Flame', 'Rocket', 'CheckSquare', 'AlertTriangle', 'Clock', 'Calendar', 
                // Row 2 - Charts/Business
                'BarChart', 'TrendingUp', 'PieChart', 'Activity', 'DollarSign', 'Briefcase',
                // Row 3 - Objects
                'Package', 'Truck', 'Medal', 'Lightbulb', 'Sun', 'Star', 'Crown',
                // Row 4 - People/Communication
                'Users', 'User', 'Mail', 'MessageSquare', 'Bell', 'Megaphone',
                // Row 5 - Actions/Tools
                'Hammer', 'Tool', 'Wrench', 'Settings', 'Filter', 'Layers',
                // Row 6 - Status/Alerts
                'CheckCircle', 'XCircle', 'AlertCircle', 'Info', 'Shield', 'Flag',
                // Row 7 - Nature/Weather
                'Cloud', 'Snowflake', 'Droplet', 'Moon', 'Sunrise', 'Umbrella',
                // Row 8 - Misc
                'Heart', 'Zap', 'Gift', 'Bookmark', 'Tag', 'Hash', 'Compass',
                // Row 9 - Tech
                'Database', 'Server', 'Globe', 'Wifi', 'Monitor', 'Cpu'
            ];
            const colorOptions = [
                // Primary
                { name: 'Blue', value: 'text-blue-600' },
                { name: 'Green', value: 'text-green-600' },
                { name: 'Red', value: 'text-red-600' },
                { name: 'Orange', value: 'text-orange-600' },
                { name: 'Purple', value: 'text-purple-600' },
                { name: 'Teal', value: 'text-teal-600' },
                { name: 'Yellow', value: 'text-yellow-600' },
                { name: 'Pink', value: 'text-pink-600' },
                { name: 'Cyan', value: 'text-cyan-600' },
                { name: 'Gray', value: 'text-gray-600' },
                // Additional shades
                { name: 'Indigo', value: 'text-indigo-600' },
                { name: 'Violet', value: 'text-violet-600' },
                { name: 'Fuchsia', value: 'text-fuchsia-600' },
                { name: 'Rose', value: 'text-rose-600' },
                { name: 'Emerald', value: 'text-emerald-600' },
                { name: 'Lime', value: 'text-lime-600' },
                { name: 'Amber', value: 'text-amber-600' },
                { name: 'Sky', value: 'text-sky-600' },
                { name: 'Slate', value: 'text-slate-600' },
                { name: 'Zinc', value: 'text-zinc-600' },
                // Darker variants
                { name: 'Navy', value: 'text-blue-800' },
                { name: 'Forest', value: 'text-green-800' },
                { name: 'Maroon', value: 'text-red-800' },
                { name: 'Plum', value: 'text-purple-800' }
            ];
            
            // Randomize icon and color
            const randomize = () => {
                const randomIcon = iconOptions[Math.floor(Math.random() * iconOptions.length)];
                const randomColor = colorOptions[Math.floor(Math.random() * colorOptions.length)].value;
                setWidgetConfig(prev => ({ ...prev, icon: randomIcon, color: randomColor }));
            };
            
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-gradient-to-r from-blue-600 to-purple-600 text-white flex justify-between items-center">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="Plus" size={24} />
                                {editWidget ? 'Edit Custom Widget' : 'Create Custom Widget'}
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Left Column - Basic Info */}
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-800 border-b pb-2">Widget Appearance</h3>
                                    
                                    {/* Title */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                                        <input
                                            type="text"
                                            value={widgetConfig.title}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, title: e.target.value }))}
                                            placeholder="e.g., My Priority Items"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    {/* Subtitle */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
                                        <input
                                            type="text"
                                            value={widgetConfig.subtitle}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, subtitle: e.target.value }))}
                                            placeholder="e.g., Needs Attention"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    {/* Randomize Button */}
                                    <div>
                                        <button
                                            onClick={randomize}
                                            className="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all flex items-center justify-center gap-2"
                                        >
                                            <Icon name="Sparkles" size={18} />
                                            üé≤ Randomize Icon & Color
                                        </button>
                                    </div>
                                    
                                    {/* Icon Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                                        <div className="max-h-36 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                            <div className="flex flex-wrap gap-2">
                                                {iconOptions.map(icon => (
                                                    <button
                                                        key={icon}
                                                        onClick={() => setWidgetConfig(prev => ({ ...prev, icon }))}
                                                        className={`p-2 rounded-lg border-2 transition-all ${widgetConfig.icon === icon ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                                                        title={icon}
                                                    >
                                                        <Icon name={icon} size={18} />
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Color Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
                                        <div className="max-h-28 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                            <div className="flex flex-wrap gap-1.5">
                                                {colorOptions.map(c => (
                                                    <button
                                                        key={c.value}
                                                        onClick={() => setWidgetConfig(prev => ({ ...prev, color: c.value }))}
                                                        className={`px-2.5 py-1 rounded-full text-xs font-medium transition-all ${widgetConfig.color === c.value ? 'ring-2 ring-offset-1 ring-blue-500' : ''} ${c.value.replace('text-', 'bg-').replace('-600', '-100').replace('-800', '-200')} ${c.value}`}
                                                        title={c.name}
                                                    >
                                                        {c.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Display Value */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Value</label>
                                        <select
                                            value={widgetConfig.displayValue}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, displayValue: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="count">Campaign Count</option>
                                            <option value="qty">Sum of Qty (Faces)</option>
                                            <option value="pending">Sum of Pending</option>
                                            <option value="installed">Sum of Installed</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {/* Right Column - Filters */}
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-800 border-b pb-2">Filter Criteria</h3>
                                    
                                    {/* Stage Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Stage</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueStages.map(stage => (
                                                <label key={stage} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.stages.includes(stage)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, stages: toggleArrayItem(prev.stages, stage) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    {stage}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Owner Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Owner</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueOwners.slice(0, 20).map(owner => (
                                                <label key={owner} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.owners.includes(owner)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, owners: toggleArrayItem(prev.owners, owner) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    {owner}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Product Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Product Type</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueProducts.slice(0, 20).map(product => (
                                                <label key={product} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.products.includes(product)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, products: toggleArrayItem(prev.products, product) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    <span className="truncate">{product.replace('Transit Shelters-', '').replace('Transit Shelter-', '')}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Install Status */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Install Status</label>
                                        <select
                                            value={widgetConfig.installStatus}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, installStatus: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All</option>
                                            <option value="fully">Fully Installed (Pending = 0)</option>
                                            <option value="partial">Partially Installed</option>
                                            <option value="notStarted">Not Started (Installed = 0)</option>
                                        </select>
                                    </div>
                                    
                                    {/* Date Logic */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Date Filter</label>
                                        <select
                                            value={widgetConfig.dateLogic}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, dateLogic: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All Dates</option>
                                            <option value="startingNext7">Starting in Next 7 Days</option>
                                            <option value="endingNext7">Ending in Next 7 Days</option>
                                            <option value="longRunning">Long-Running (&gt;30 days)</option>
                                        </select>
                                    </div>
                                    
                                    {/* Volume Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Volume Filter</label>
                                        <select
                                            value={widgetConfig.volumeFilter}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, volumeFilter: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All Volumes</option>
                                            <option value="high50">High Volume (50+ faces)</option>
                                            <option value="low10">Low Volume (&lt;10 faces)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Preview */}
                            <div className="mt-6 p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                                <h3 className="text-sm font-medium text-gray-500 mb-3">Preview</h3>
                                <div className="flex items-center gap-4">
                                    <div className={`p-4 rounded-xl ${widgetConfig.color.replace('text-', 'bg-').replace('-600', '-100')}`}>
                                        <Icon name={widgetConfig.icon} size={28} className={widgetConfig.color} />
                                    </div>
                                    <div>
                                        <p className="text-2xl font-bold text-gray-900">{getPreviewValue().toLocaleString()}</p>
                                        <p className="font-semibold text-gray-800">{widgetConfig.title || 'Widget Title'}</p>
                                        <p className={`text-sm ${widgetConfig.color}`}>{widgetConfig.subtitle || 'Subtitle'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => {
                                    if (!widgetConfig.title.trim()) {
                                        alert('Please enter a title for your widget');
                                        return;
                                    }
                                    onSave(widgetConfig);
                                    onClose();
                                }}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2"
                            >
                                <Icon name="Save" size={18} />
                                {editWidget ? 'Update Widget' : 'Create Widget'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: INSTALLATION RISK COMMAND CENTER ---

        // --- INSTALLATION RISK COMMAND CENTER (External - loaded from riskCommandCenter.js) ---
        const InstallationRiskCommandCenter = (window.STAPRiskCommandCenter && window.STAPRiskCommandCenter.InstallationRiskCommandCenter) || (props => null);



        // --- AVAILABILITY COMPONENT (External - loaded from availability.js) ---
        // Uses window.STAP_AvailabilityComponent from external Babel-compiled module
        const AvailabilityComponent = window.STAP_AvailabilityComponent || (({ allData }) => (
            <div className="flex items-center justify-center h-64">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                    <p className="text-gray-500">Loading Availability Component...</p>
                    <p className="text-xs text-gray-400 mt-1">If this persists, check that availability.js is loaded.</p>
                </div>
            </div>
        ));



        // --- CANVAS GEAR SIDEBAR (External - loaded from canvasGearSidebar.js) ---
        // Uses window.STAPCanvasGearSidebar.CanvasGearSidebar from external Babel-compiled module
        const CanvasGearSidebar = (window.STAPCanvasGearSidebar && window.STAPCanvasGearSidebar.CanvasGearSidebar) || (props => (
            <div className="fixed left-0 top-0 w-80 h-screen bg-gray-900 z-20 hidden md:flex items-center justify-center">
                <div className="text-center text-white">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto mb-2"></div>
                    <p className="text-sm">Loading Sidebar...</p>
                </div>
            </div>
        ));

        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COLLAPSED MINI-BAR with Waterfall Cascade
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CollapsedMiniBar = ({ view, setView, onLogout }) => {
            
            const moduleItems = [
                { id: 'dashboard', icon: 'LayoutDashboard' },
                { id: 'holdReport', icon: 'ClipboardList' },
                { id: 'availability', icon: 'Calendar' },
                { id: 'riskAnalysis', icon: 'ShieldAlert' },
                { id: 'master', icon: 'Hammer' },
                { id: 'specialMedia', icon: 'Megaphone' },
                { id: 'popGallery', icon: 'Camera' },
                { id: 'materialReceivers', icon: 'Package' },
                { id: 'performanceReport', icon: 'FileText' },
            ];
            
            const pipelineItems = [
                { id: 'delayedFlights', icon: 'Flame' },
                { id: 'onHoldCampaigns', icon: 'Pause' },
                { id: 'inProgressFlights', icon: 'Rocket' },
                { id: 'fullyInstalledThisWeek', icon: 'Medal' },
                { id: 'rotations', icon: 'Repeat' },
                { id: 'thisWeek', icon: 'Calendar' },
                { id: 'upcoming', icon: 'Sun' },
                { id: 'materialReadyFuture', icon: 'Archive' },
                { id: 'nextMonth', icon: 'Clock' },
                { id: 'pipelineSummary', icon: 'BarChart' },
            ];
            
            const historyItems = [
                { id: 'expiredFlights', icon: 'Lightbulb' },
                { id: 'pastDue', icon: 'AlertTriangle' },
                { id: 'recentInstalls', icon: 'CheckSquare' },
                { id: 'history', icon: 'History' },
                { id: 'lostOpportunities', icon: 'XCircle' },
            ];
            
            const IconButton = ({ item, colorClass, bgClass, borderClass, hoverBorderClass, index = 0, isVisible = true }) => (
                <button
                    onClick={() => setView(item.id)}
                    className={`w-8 h-8 mb-0.5 rounded-lg flex items-center justify-center transition-all duration-300 ${
                        view === item.id
                            ? `${bgClass} ${borderClass} shadow-lg`
                            : `border border-slate-700 hover:${hoverBorderClass || 'border-slate-500'} hover:bg-slate-800/50`
                    }`}
                    style={{
                        opacity: isVisible ? 1 : 0,
                        transform: isVisible ? 'translateY(0) scale(1)' : 'translateY(-10px) scale(0.8)',
                        transitionDelay: isVisible ? `${index * 50}ms` : '0ms',
                    }}
                    title={item.id}
                >
                    <Icon
                        name={item.icon}
                        size={14}
                        className={`transition-colors ${view === item.id ? colorClass : 'text-slate-500 group-hover:text-slate-300'}`}
                    />
                </button>
            );
            
            return (
                <div className="w-full h-full bg-gradient-to-b from-slate-800 to-slate-950 flex flex-col items-center py-3 overflow-y-auto hide-scrollbar">
                    {/* Modules Section - Always show all */}
                    <div className="text-cyan-400 text-[9px] font-bold mb-2 tracking-wider">MOD</div>
                    {moduleItems.map((item, i) => (
                        <IconButton
                            key={item.id}
                            item={item}
                            colorClass="text-cyan-400"
                            bgClass="bg-cyan-500/20"
                            borderClass="border border-cyan-400"
                            hoverBorderClass="border-cyan-600"
                            isVisible={true}
                        />
                    ))}

                    {/* ZIP Impressions - Always visible, navigates to full dashboard */}
                    <button
                        onClick={() => setView('impressions')}
                        className={`w-8 h-8 mb-0.5 rounded-lg flex items-center justify-center transition-all duration-300 ${
                            view === 'impressions'
                                ? 'bg-emerald-500/20 border border-emerald-400 shadow-lg'
                                : 'border border-emerald-500/50 hover:border-emerald-400 hover:bg-emerald-500/20 bg-emerald-500/10'
                        }`}
                        title="ZIP Impressions Dashboard"
                    >
                        <Icon name="Globe" size={14} className="text-emerald-400" />
                    </button>

                    {/* Pipeline Section */}
                    <div className="w-8 border-t border-slate-700 my-1.5" />
                    <div className="text-purple-400 text-[9px] font-bold mb-2 tracking-wider">PIPE</div>
                    
                    <div className="flex flex-col items-center">
                        {pipelineItems.map((item, i) => (
                            <IconButton
                                key={item.id}
                                item={item}
                                colorClass="text-purple-400"
                                bgClass="bg-purple-500/20"
                                borderClass="border border-purple-400"
                                hoverBorderClass="border-purple-600"
                                index={i}
                                isVisible={true}
                            />
                        ))}
                    </div>
                    
                    {/* History Section */}
                    <div className="w-8 border-t border-slate-700 my-1.5" />
                    <div className="text-amber-400 text-[9px] font-bold mb-2 tracking-wider">HIST</div>
                    
                    <div className="flex flex-col items-center">
                        {historyItems.map((item, i) => (
                            <IconButton
                                key={item.id}
                                item={item}
                                colorClass="text-amber-400"
                                bgClass="bg-amber-500/20"
                                borderClass="border border-amber-400"
                                hoverBorderClass="border-amber-600"
                                index={i}
                                isVisible={true}
                            />
                        ))}
                    </div>
                    
                    <div className="flex-1" />
                    <button
                        onClick={onLogout}
                        className="w-8 h-8 mb-3 border border-slate-700 rounded-lg flex items-center justify-center text-slate-500 hover:text-red-400 hover:border-red-400 hover:bg-red-500/10 transition-colors"
                    >
                        <Icon name="LogOut" size={14} />
                    </button>
                </div>
            );
        };
        
        // Wrapper that handles collapse state
        const Sidebar = ({ view, setView, onReset, onOpenDigest, onResetEmailLogs, onOpenSheetSettings, onLogout, ghostCount = 0, isCollapsed: externalCollapsed, setIsCollapsed: externalSetCollapsed }) => {
            const [internalCollapsed, setInternalCollapsed] = useState(false);
            const isCollapsed = externalCollapsed !== undefined ? externalCollapsed : internalCollapsed;
            const setIsCollapsed = externalSetCollapsed || setInternalCollapsed;
            
            return (
                <>
                    <div 
                        className={`fixed left-0 top-0 h-screen z-20 hidden md:block transition-all duration-500 ease-in-out overflow-hidden`}
                        style={{ width: isCollapsed ? 64 : 320 }}
                    >
                        {!isCollapsed && (
                            <CanvasGearSidebar
                                view={view}
                                setView={setView}
                                onLogout={onLogout}
                                onOpenDigest={onOpenDigest}
                                onReset={onReset}
                                onResetEmailLogs={onResetEmailLogs}
                                onOpenSheetSettings={onOpenSheetSettings}
                                isCollapsed={isCollapsed}
                                setIsCollapsed={setIsCollapsed}
                            />
                        )}
                        
                        {/* Collapsed mini-bar with waterfall cascade */}
                        {isCollapsed && (
                            <CollapsedMiniBar view={view} setView={setView} onLogout={onLogout} />
                        )}
                    </div>
                    
                    {/* Toggle button */}
                    <button
                        onClick={() => setIsCollapsed(!isCollapsed)}
                        className="fixed z-30 hidden md:flex items-center justify-center w-6 h-12 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-r-lg transition-all duration-300"
                        style={{ left: isCollapsed ? 64 : 320, top: '50%', transform: 'translateY(-50%)' }}
                    >
                        <Icon name={isCollapsed ? 'ChevronRight' : 'ChevronLeft'} size={14} className="text-slate-400" />
                    </button>
                </>
            );
        };

        // ============================================
        // PERFORMANCE REPORT COMPONENT - City Compliance
        // ============================================
        const PerformanceReport = ({ data: rawData, onBack, setView }) => {
            const data = Array.isArray(rawData) ? rawData : [];
            
            const [dateRange, setDateRange] = useState({ 
                start: new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });
            const [selectedMarket, setSelectedMarket] = useState('ALL');
            const [reportType, setReportType] = useState('summary'); // 'summary', 'detailed', 'photos'
            const [showPrintView, setShowPrintView] = useState(false);

            // Filter data by date range and market
            const filteredData = useMemo(() => {
                return data.filter(d => {
                    // Only include installed/completed campaigns
                    const validStages = ['Installed', 'Photos Taken', 'POP Completed'];
                    if (!validStages.includes(d.stage)) return false;
                    
                    // Date filter
                    const campaignDate = d.dateObj || new Date(d.date);
                    if (dateRange.start && campaignDate < new Date(dateRange.start)) return false;
                    if (dateRange.end && campaignDate > new Date(dateRange.end)) return false;
                    
                    // Market filter
                    if (selectedMarket !== 'ALL' && d.market !== selectedMarket) return false;
                    
                    return true;
                });
            }, [data, dateRange, selectedMarket]);

            // Get unique markets
            const markets = useMemo(() => {
                const validStages = ['Installed', 'Photos Taken', 'POP Completed'];
                const installed = data.filter(d => validStages.includes(d.stage));
                return [...new Set(installed.map(d => d.market).filter(Boolean))].sort();
            }, [data]);

            // Calculate summary stats with impressions
            const stats = useMemo(() => {
                const totalCampaigns = filteredData.length;
                const totalUnits = filteredData.reduce((sum, d) => sum + (parseInt(d.quantity) || parseInt(d.totalQty) || 0), 0);
                
                // Calculate impressions (use existing impressions field or estimate)
                const calculateImpressions = (campaign) => {
                    if (campaign.impressions) return parseInt(campaign.impressions);
                    // Estimate based on media type and quantity
                    const dailyRates = {
                        'Transit Shelters': 15000, 'Bus Bench': 8000, 'Digital Screen': 45000,
                        'Billboard': 35000, 'Shelter': 12000, 'Urban Panel': 18000, 'Kiosk': 6000,
                        'Bus Wrap': 50000, 'Street Furniture': 10000, 'Digital Kiosk': 25000,
                        'Mall Display': 22000, 'Airport Display': 40000
                    };
                    const mediaType = campaign.product || campaign.media || '';
                    const rate = dailyRates[mediaType] || Object.values(dailyRates).find((v, i) => 
                        mediaType.toLowerCase().includes(Object.keys(dailyRates)[i]?.toLowerCase())
                    ) || 10000;
                    const qty = parseInt(campaign.quantity) || parseInt(campaign.totalQty) || 1;
                    const days = 28; // Default campaign duration
                    return Math.round(rate * qty * days);
                };
                
                const totalImpressions = filteredData.reduce((sum, d) => sum + calculateImpressions(d), 0);
                
                // By stage
                const byStage = {
                    installed: filteredData.filter(d => d.stage === 'Installed').length,
                    photosTaken: filteredData.filter(d => d.stage === 'Photos Taken').length,
                    popCompleted: filteredData.filter(d => d.stage === 'POP Completed').length
                };
                
                // By market (with impressions)
                const byMarket = {};
                filteredData.forEach(d => {
                    const market = d.market?.split(',')[0] || 'Unknown';
                    if (!byMarket[market]) {
                        byMarket[market] = { campaigns: 0, units: 0, photos: 0, popComplete: 0, impressions: 0 };
                    }
                    byMarket[market].campaigns++;
                    byMarket[market].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byMarket[market].impressions += calculateImpressions(d);
                    if (d.stage === 'Photos Taken' || d.stage === 'POP Completed') byMarket[market].photos++;
                    if (d.stage === 'POP Completed') byMarket[market].popComplete++;
                });
                
                // By advertiser (with impressions)
                const byAdvertiser = {};
                filteredData.forEach(d => {
                    const adv = d.advertiser || 'Unknown';
                    if (!byAdvertiser[adv]) {
                        byAdvertiser[adv] = { campaigns: 0, units: 0, products: new Set(), impressions: 0 };
                    }
                    byAdvertiser[adv].campaigns++;
                    byAdvertiser[adv].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byAdvertiser[adv].impressions += calculateImpressions(d);
                    if (d.product) byAdvertiser[adv].products.add(d.product);
                });
                
                // By product type (with impressions)
                const byProduct = {};
                filteredData.forEach(d => {
                    const prod = d.product?.split('-')[0] || 'Unknown';
                    if (!byProduct[prod]) {
                        byProduct[prod] = { campaigns: 0, units: 0, impressions: 0 };
                    }
                    byProduct[prod].campaigns++;
                    byProduct[prod].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byProduct[prod].impressions += calculateImpressions(d);
                });
                
                return { totalCampaigns, totalUnits, totalImpressions, byStage, byMarket, byAdvertiser, byProduct, calculateImpressions };
            }, [filteredData]);

            // Print function
            const handlePrint = () => {
                window.print();
            };

            // Export to CSV
            const handleExportCSV = () => {
                const headers = ['Campaign #', 'Advertiser', 'Campaign Name', 'Market', 'Product', 'Quantity', 'Impressions', 'Start Date', 'End Date', 'Status', 'Owner'];
                const rows = filteredData.map(d => [
                    stripEmojis(d.campaignNumber || ''),
                    stripEmojis(d.advertiser || ''),
                    stripEmojis(d.campaign || ''),
                    stripEmojis(d.market || ''),
                    stripEmojis(d.product || ''),
                    d.quantity || d.totalQty || '',
                    stats.calculateImpressions(d).toLocaleString(),
                    stripEmojis(d.date || ''),
                    stripEmojis(d.endDate || ''),
                    stripEmojis(d.stage || ''),
                    stripEmojis(d.owner || '')
                ]);

                const csvContent = [headers, ...rows].map(row => row.map(cell => `"${stripEmojis(String(cell))}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Performance_Report_${dateRange.start}_to_${dateRange.end}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className={`bg-white rounded-xl shadow-sm border border-gray-200 ${showPrintView ? 'print-view' : ''}`}>
                    {/* Header */}
                    <div className="px-6 py-4 border-b bg-gradient-to-r from-emerald-50 to-teal-50 flex justify-between items-center print:bg-white">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="p-1 hover:bg-emerald-200 rounded-full transition-colors print:hidden" title="Back">
                                <Icon name="ArrowLeft" size={20} className="text-emerald-600" />
                            </button>
                            <div>
                                <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                    <Icon name="FileText" size={20} className="text-emerald-600" />
                                    Performance Report
                                </h3>
                                <p className="text-sm text-gray-500">
                                    Installation proof with impression tracking for city compliance
                                    {data.length > 0 && <span className="ml-2 text-xs text-emerald-600 flex items-center gap-1">(<Icon name="ClipboardList" size={12} /> {filteredData.length} installations ‚Ä¢ <Icon name="Eye" size={12} /> {(stats.totalImpressions / 1000000).toFixed(1)}M impressions)</span>}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 print:hidden">
                            <button 
                                onClick={() => setView && setView('popGallery')}
                                className="px-3 py-2 bg-indigo-100 border border-indigo-300 hover:bg-indigo-200 text-indigo-700 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="Camera" size={16} /> View POP Gallery
                            </button>
                            <button
                                onClick={handleExportCSV}
                                className="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="Download" size={16} /> CSV
                            </button>
                            <button
                                onClick={() => exportToPDF('campaigns', filteredData, {
                                    title: 'Performance Report',
                                    subtitle: `${filteredData.length} Installations | ${stats.totalImpressions.toLocaleString()} Impressions | ${dateRange.start} to ${dateRange.end}`,
                                    stats: { 'Campaigns': filteredData.length, 'Units': stats.totalUnits, 'Impressions': (stats.totalImpressions / 1000000).toFixed(1) + 'M' },
                                    filename: `Performance_Report_${dateRange.start}_to_${dateRange.end}.pdf`
                                })}
                                className="px-3 py-2 bg-red-50 border border-red-300 hover:bg-red-100 text-red-700 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="FileText" size={16} /> PDF
                            </button>
                            <button
                                onClick={handlePrint}
                                className="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold flex items-center gap-2"
                            >
                                <Icon name="Printer" size={16} /> Print
                            </button>
                        </div>
                    </div>

                    {/* Filters */}
                    <div className="px-6 py-4 border-b bg-gray-50 print:hidden">
                        <div className="flex flex-wrap items-center gap-4">
                            {/* Date Range */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Report Period</label>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="date" 
                                        value={dateRange.start}
                                        onChange={e => setDateRange(prev => ({ ...prev, start: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                    <span className="text-gray-400">‚Üí</span>
                                    <input 
                                        type="date" 
                                        value={dateRange.end}
                                        onChange={e => setDateRange(prev => ({ ...prev, end: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                </div>
                            </div>

                            {/* Market Filter */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Market</label>
                                <select 
                                    value={selectedMarket}
                                    onChange={e => setSelectedMarket(e.target.value)}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white min-w-[180px]"
                                >
                                    <option value="ALL">All Markets ({markets.length})</option>
                                    {markets.map(m => (
                                        <option key={m} value={m}>{m.split(',')[0]}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Quick Date Presets */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Quick Select</label>
                                <div className="flex gap-1">
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setDate(start.getDate() - 7);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 7 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setMonth(start.getMonth() - 1);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 30 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setMonth(start.getMonth() - 3);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 90 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const year = new Date().getFullYear();
                                            setDateRange({ start: `${year}-01-01`, end: new Date().toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        YTD
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Print Header - Only visible when printing */}
                    <div className="hidden print:block px-6 py-4 border-b">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">Installation Performance Report</h1>
                                <p className="text-gray-600">Los Angeles STAP Operations</p>
                            </div>
                            <div className="text-right text-sm text-gray-600">
                                <p><strong>Report Period:</strong> {dateRange.start} to {dateRange.end}</p>
                                <p><strong>Generated:</strong> {new Date().toLocaleDateString()}</p>
                                <p><strong>Market:</strong> {selectedMarket === 'ALL' ? 'All Markets' : selectedMarket}</p>
                                <p><strong>Total Impressions:</strong> {stats.totalImpressions.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Summary</h4>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-emerald-700">{stats.totalCampaigns}</div>
                                <div className="text-sm text-emerald-600 font-medium">Total Campaigns</div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-blue-700">{stats.totalUnits.toLocaleString()}</div>
                                <div className="text-sm text-blue-600 font-medium">Total Units Installed</div>
                            </div>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-center">
                                <div className="text-2xl font-bold text-amber-700">{(stats.totalImpressions / 1000000).toFixed(1)}M</div>
                                <div className="text-sm text-amber-600 font-medium">Total Impressions</div>
                                <div className="text-[10px] text-amber-500 mt-0.5">{stats.totalImpressions.toLocaleString()} views</div>
                            </div>
                            <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-purple-700">{stats.byStage.photosTaken + stats.byStage.popCompleted}</div>
                                <div className="text-sm text-purple-600 font-medium">Photos Documented</div>
                            </div>
                            <div className="bg-teal-50 border border-teal-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-teal-700">{stats.byStage.popCompleted}</div>
                                <div className="text-sm text-teal-600 font-medium">POP Completed</div>
                            </div>
                        </div>
                    </div>

                    {/* By Market Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Market</h4>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-3 font-semibold">Market</th>
                                        <th className="text-center p-3 font-semibold">Campaigns</th>
                                        <th className="text-center p-3 font-semibold">Units</th>
                                        <th className="text-center p-3 font-semibold">Impressions</th>
                                        <th className="text-center p-3 font-semibold">Photos Taken</th>
                                        <th className="text-center p-3 font-semibold">POP Complete</th>
                                        <th className="text-center p-3 font-semibold">Completion %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(stats.byMarket).sort((a, b) => b[1].impressions - a[1].impressions).map(([market, data]) => (
                                        <tr key={market} className="border-b hover:bg-gray-50">
                                            <td className="p-3 font-medium">{market}</td>
                                            <td className="p-3 text-center">{data.campaigns}</td>
                                            <td className="p-3 text-center font-bold">{data.units.toLocaleString()}</td>
                                            <td className="p-3 text-center">
                                                <span className="text-amber-700 font-medium">{(data.impressions / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-3 text-center">{data.photos}</td>
                                            <td className="p-3 text-center">{data.popComplete}</td>
                                            <td className="p-3 text-center">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    data.campaigns > 0 && data.popComplete / data.campaigns >= 0.9 ? 'bg-green-100 text-green-700' :
                                                    data.campaigns > 0 && data.popComplete / data.campaigns >= 0.5 ? 'bg-yellow-100 text-yellow-700' :
                                                    'bg-red-100 text-red-700'
                                                }`}>
                                                    {data.campaigns > 0 ? Math.round((data.popComplete / data.campaigns) * 100) : 0}%
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-100 font-bold">
                                    <tr>
                                        <td className="p-3">TOTAL</td>
                                        <td className="p-3 text-center">{stats.totalCampaigns}</td>
                                        <td className="p-3 text-center">{stats.totalUnits.toLocaleString()}</td>
                                        <td className="p-3 text-center text-amber-700">{(stats.totalImpressions / 1000000).toFixed(1)}M</td>
                                        <td className="p-3 text-center">{stats.byStage.photosTaken + stats.byStage.popCompleted}</td>
                                        <td className="p-3 text-center">{stats.byStage.popCompleted}</td>
                                        <td className="p-3 text-center">
                                            {stats.totalCampaigns > 0 ? Math.round((stats.byStage.popCompleted / stats.totalCampaigns) * 100) : 0}%
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* By Advertiser Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Advertiser ({Object.keys(stats.byAdvertiser).length})</h4>
                        <div className="overflow-x-auto max-h-[350px] overflow-y-auto">
                            <table className="w-full text-sm">
                                <thead className="sticky top-0 bg-white z-10">
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-3 font-semibold">Advertiser</th>
                                        <th className="text-center p-3 font-semibold">Campaigns</th>
                                        <th className="text-center p-3 font-semibold">Units</th>
                                        <th className="text-center p-3 font-semibold">Impressions</th>
                                        <th className="text-left p-3 font-semibold">Products</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(stats.byAdvertiser).sort((a, b) => b[1].impressions - a[1].impressions).map(([advertiser, data]) => (
                                        <tr key={advertiser} className="border-b hover:bg-gray-50">
                                            <td className="p-3 font-medium">{advertiser}</td>
                                            <td className="p-3 text-center">{data.campaigns}</td>
                                            <td className="p-3 text-center font-bold">{data.units.toLocaleString()}</td>
                                            <td className="p-3 text-center">
                                                <span className="text-amber-700 font-medium">{(data.impressions / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-3 text-xs text-gray-600">{[...data.products].slice(0, 2).join(', ')}{data.products.size > 2 ? ` +${data.products.size - 2} more` : ''}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* By Product Type Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Product Type</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {Object.entries(stats.byProduct).sort((a, b) => b[1].impressions - a[1].impressions).map(([product, data]) => (
                                <div key={product} className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                    <div className="text-lg font-bold text-gray-800">{data.units.toLocaleString()}</div>
                                    <div className="text-xs text-gray-600">{product}</div>
                                    <div className="text-[10px] text-gray-400">{data.campaigns} campaigns</div>
                                    <div className="text-[10px] text-amber-600 font-medium mt-1 flex items-center gap-1"><Icon name="Eye" size={10} /> {(data.impressions / 1000).toFixed(0)}K impressions</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Detailed Campaign List */}
                    <div className="px-6 py-4">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Campaign Details ({filteredData.length})</h4>
                        <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table className="w-full text-sm">
                                <thead className="sticky top-0 bg-white z-10">
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-2 font-semibold text-xs">Campaign #</th>
                                        <th className="text-left p-2 font-semibold text-xs">Advertiser / Campaign</th>
                                        <th className="text-left p-2 font-semibold text-xs">Market</th>
                                        <th className="text-left p-2 font-semibold text-xs">Product</th>
                                        <th className="text-center p-2 font-semibold text-xs">Qty</th>
                                        <th className="text-center p-2 font-semibold text-xs">Charted</th>
                                        <th className="text-center p-2 font-semibold text-xs">Impressions</th>
                                        <th className="text-center p-2 font-semibold text-xs">Start</th>
                                        <th className="text-center p-2 font-semibold text-xs">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.map((d, idx) => (
                                        <tr key={idx} className="border-b hover:bg-gray-50 text-xs">
                                            <td className="p-2 font-mono">{d.campaignNumber}</td>
                                            <td className="p-2">
                                                <div className="font-medium text-gray-900">{d.advertiser}</div>
                                                <div className="text-[10px] text-gray-500 truncate" title={d.name}>{d.name}</div>
                                            </td>
                                            <td className="p-2 text-gray-600">{d.market?.split(',')[0]}</td>
                                            <td className="p-2 text-center">
                                                <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-[10px] font-medium" title={d.product}>
                                                    {abbreviateProduct(d.product)}
                                                </span>
                                            </td>
                                            <td className="p-2 text-center font-bold">{d.quantity || d.totalQty}</td>
                                            <td className="p-2 text-center">
                                                {(() => {
                                                    const booked = d.quantity || d.totalQty || 0;
                                                    const charted = d.adjustedQty;
                                                    if (charted === null || charted === undefined) {
                                                        return <span className="text-gray-400">--</span>;
                                                    } else if (charted === booked) {
                                                        return <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-medium">{charted} ‚úì</span>;
                                                    } else if (charted < booked) {
                                                        return <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded font-medium">{charted} ‚ö†</span>;
                                                    } else {
                                                        return <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">{charted} ‚Üë</span>;
                                                    }
                                                })()}
                                            </td>
                                            <td className="p-2 text-center">
                                                <span className="text-amber-700 font-medium">{(stats.calculateImpressions(d) / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-2 text-center text-gray-500">{d.date}</td>
                                            <td className="p-2 text-center">
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold ${
                                                    d.stage === 'POP Completed' ? 'bg-blue-100 text-blue-700' :
                                                    d.stage === 'Photos Taken' ? 'bg-purple-100 text-purple-700' :
                                                    'bg-green-100 text-green-700'
                                                }`}>
                                                    {d.stage === 'POP Completed' ? '‚úì POP' : d.stage}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="px-6 py-4 bg-gray-50 border-t text-center text-xs text-gray-500">
                        <p>Report generated by LA STAP Operations Hub ‚Ä¢ {new Date().toLocaleString()}</p>
                        <p className="mt-1">This report is for city compliance verification purposes.</p>
                    </div>

                    {/* Print Styles */}
                    <style>{`
                        @media print {
                            body * { visibility: hidden; }
                            .print-view, .print-view * { visibility: visible; }
                            .print-view { position: absolute; left: 0; top: 0; width: 100%; }
                            .print\\:hidden { display: none !important; }
                            .print\\:block { display: block !important; }
                            .print\\:bg-white { background: white !important; }
                        }
                    `}</style>
                </div>
            );
        };

        // ============================================
        // POP GALLERY COMPONENT - Proof of Performance
        // ============================================

        // --- MATERIAL RECEIVERS (External - loaded from materialReceivers.js) ---
        const MaterialReceivers = (window.STAPMaterialReceivers && window.STAPMaterialReceivers.MaterialReceivers) || (props => null);



        // --- POP GALLERY (External - loaded from popGallery.js) ---
        const POPGallery = (window.STAPPOPGallery && window.STAPPOPGallery.POPGallery) || (props => null);


        const AuthorizedDashboard = ({ onLogout }) => {
            const [view, setView] = useState('upload');
            const [files, setFiles] = useState({ holds: null, install: null });
            const [processing, setProcessing] = useState(false);
            
            // ============================================
            // DATA PERSISTENCE & MANUAL OVERRIDES SYSTEM
            // ============================================
            /*
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ                    DATA FLOW ARCHITECTURE                           ‚îÇ
            ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
            ‚îÇ                                                                     ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
            ‚îÇ   ‚îÇ Google Sheet ‚îÇ     ‚îÇ  CSV Upload  ‚îÇ     ‚îÇ  Demo Data   ‚îÇ       ‚îÇ
            ‚îÇ   ‚îÇ   (Live)     ‚îÇ     ‚îÇ   (Manual)   ‚îÇ     ‚îÇ   (Mock)     ‚îÇ       ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
            ‚îÇ          ‚îÇ                    ‚îÇ                    ‚îÇ               ‚îÇ
            ‚îÇ          ‚ñº                    ‚ñº                    ‚ñº               ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ                    baseData (State)                      ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ         { holds: [], installs: [], specialty: [] }       ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ                                                          ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   üì¶ Auto-persisted to localStorage (stap_csv_data)      ‚îÇ      ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ                            ‚ñº                                       ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ              manualOverrides (State)                     ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   { campaignId: { stage, installed, pending, notes } }   ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ                                                          ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   ‚úèÔ∏è Auto-persisted to localStorage (stap_manual_overrides)‚îÇ     ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ                            ‚ñº                                       ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ              processedData (useMemo)                     ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   Combines baseData + manualOverrides                    ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   Categorizes into: delayed, inProgress, installed, etc. ‚îÇ      ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
            ‚îÇ          ‚ñº                 ‚ñº                 ‚ñº                     ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
            ‚îÇ   ‚îÇ Dashboard  ‚îÇ    ‚îÇ   Daily    ‚îÇ    ‚îÇ  Update    ‚îÇ              ‚îÇ
            ‚îÇ   ‚îÇ  Widgets   ‚îÇ    ‚îÇ   Digest   ‚îÇ    ‚îÇ  Stages    ‚îÇ              ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
            ‚îÇ                                                                    ‚îÇ
            ‚îÇ   SMART FALLBACK SYNC:                                            ‚îÇ
            ‚îÇ   1. Try Google Sheet via CORS proxies                            ‚îÇ
            ‚îÇ   2. If ALL fail ‚Üí Load from localStorage (persisted CSV)         ‚îÇ
            ‚îÇ   3. Show "Cached" indicator + warning                            ‚îÇ
            ‚îÇ                                                                    ‚îÇ
            ‚îÇ   PERSISTENCE RULES:                                              ‚îÇ
            ‚îÇ   ‚Ä¢ CSV data persists across sessions until new upload            ‚îÇ
            ‚îÇ   ‚Ä¢ Manual overrides persist indefinitely                         ‚îÇ
            ‚îÇ   ‚Ä¢ "Reset Data" clears session; "Clear All" clears storage       ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            */
            // Priority: Google Sheet (Live) > Manual Overrides > Persisted CSV > Empty
            
            // Load persisted CSV data from localStorage on init
            const [baseData, setBaseData] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_csv_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('üìÇ Loaded persisted CSV data:', parsed.holds?.length || 0, 'holds,', parsed.installs?.length || 0, 'installs');

                        return parsed;
                    }
                } catch (e) {
                    console.warn('Could not load persisted CSV data:', e);
                }
                return { holds: [], installs: [] };
            });
            
            // Extended manual overrides: { campaignId: { stage?, installed?, pending?, notes? } }
            const [manualOverrides, setManualOverrides] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_manual_overrides');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const count = Object.keys(parsed).length;
                        if (count > 0) {
                            console.log(`‚úèÔ∏è Loaded ${count} manual override(s) from localStorage`);
                        }
                        return parsed;
                    }
                    return {};
                } catch (e) {
                    console.warn('Could not load manual overrides:', e);
                    return {};
                }
            });

            // One-time migration: Move legacy stap_production_proof data into stap_manual_overrides
            useEffect(() => {
                try {
                    const legacyProofs = localStorage.getItem('stap_production_proof');
                    if (legacyProofs) {
                        const proofData = JSON.parse(legacyProofs);
                        const migratedCount = Object.keys(proofData).length;
                        if (migratedCount > 0) {
                            setManualOverrides(prev => {
                                const merged = { ...prev };
                                Object.entries(proofData).forEach(([key, value]) => {
                                    merged[key] = { ...(merged[key] || {}), productionProof: value };
                                });
                                return merged;
                            });
                            localStorage.removeItem('stap_production_proof'); // Clean up legacy key
                            console.log(`üîÑ Migrated ${migratedCount} production proof(s) to unified storage`);
                        }
                    }
                } catch (e) {
                    console.warn('Could not migrate production proofs:', e);
                }
            }, []);

            // Track data source for UI feedback
            const [dataSource, setDataSource] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_data_source');
                    return saved ? JSON.parse(saved) : { type: 'none', timestamp: null, error: null };
                } catch (e) {
                    return { type: 'none', timestamp: null, error: null };
                }
            });
            
            // Persist CSV data to localStorage whenever it changes
            // With quota handling and data optimization for large datasets
            const [storageWarning, setStorageWarning] = useState(null);
            
            useEffect(() => {
                if (baseData.holds?.length > 0 || baseData.installs?.length > 0) {
                    const saveToStorage = async () => {
                        try {
                            // Optimize data by removing redundant fields for storage
                            const optimizedData = {
                                holds: baseData.holds?.map(item => {
                                    // Keep essential fields only, remove computed/display fields
                                    const { 
                                        // Keep these
                                        id, date, endDate, productEndDate, programEndDate,
                                        advertiser, name, rawName, owner, market, product, media,
                                        stage, quantity, totalQty, installed, totalInstalled, pending,
                                        isGhost, ghostReason, isComplete, hasBonus, bonusNote,
                                        // Skip dateObj - we'll reconstruct from date string
                                        dateObj, endDateObj, productEndDateObj, programEndDateObj,
                                        ...rest 
                                    } = item;
                                    return {
                                        id, date, endDate, productEndDate, programEndDate,
                                        advertiser, name, rawName, owner, market, product, media,
                                        stage, quantity, totalQty, installed, totalInstalled, pending,
                                        isGhost, ghostReason, isComplete, hasBonus, bonusNote
                                    };
                                }) || [],
                                installs: baseData.installs?.map(item => {
                                    const { dateObj, endDateObj, productEndDateObj, programEndDateObj, ...rest } = item;
                                    return rest;
                                }) || [],
                                specialtyHolds: baseData.specialtyHolds?.map(item => {
                                    const { dateObj, endDateObj, ...rest } = item;
                                    return rest;
                                }) || [],
                                lost: baseData.lost?.map(item => {
                                    const { dateObj, endDateObj, ...rest } = item;
                                    return rest;
                                }) || []
                            };
                            
                            const jsonString = JSON.stringify(optimizedData);
                            const sizeInMB = (jsonString.length / (1024 * 1024)).toFixed(2);
                            
                            console.log(`üíæ Attempting to save ${baseData.holds?.length || 0} rows (${sizeInMB} MB)...`);
                            
                            // Check if data is too large (warn at 4MB, localStorage typically allows 5-10MB)
                            if (jsonString.length > 4 * 1024 * 1024) {
                                console.warn(`‚ö†Ô∏è Data size (${sizeInMB} MB) is large - may fail on some browsers`);
                                setStorageWarning(`Large dataset (${sizeInMB} MB) - persistence may be limited`);
                            } else {
                                setStorageWarning(null);
                            }
                            
                            // Try localStorage first
                            localStorage.setItem('stap_csv_data', jsonString);
                            console.log(`‚úÖ CSV data persisted to localStorage (${sizeInMB} MB, ${baseData.holds?.length || 0} rows)`);
                            
                        } catch (e) {
                            // Handle quota exceeded error
                            if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                                console.error('‚ùå localStorage quota exceeded!', e);
                                setStorageWarning('‚ö†Ô∏è Data too large for browser storage. Your session will not persist after refresh.');
                                
                                // Try to save at least the data source info so user knows data isn't persisted
                                try {
                                    localStorage.setItem('stap_storage_overflow', 'true');
                                } catch (e2) {
                                    // Storage completely full
                                }
                            } else {
                                console.warn('Could not persist CSV data:', e);
                                setStorageWarning('Storage error: ' + e.message);
                            }
                        }
                    };
                    
                    saveToStorage();
                }
            }, [baseData]);
            
            // Persist manual overrides to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('stap_manual_overrides', JSON.stringify(manualOverrides));
                } catch (e) {
                    console.warn('Could not persist manual overrides:', e);
                }
            }, [manualOverrides]);
            
            // Persist data source info
            useEffect(() => {
                try {
                    localStorage.setItem('stap_data_source', JSON.stringify(dataSource));
                } catch (e) {
                    console.warn('Could not persist data source info:', e);
                }
            }, [dataSource]);
            
            // Note: We no longer auto-navigate to dashboard on login.
            // Instead, we show a "Resume Previous Session" card on the upload screen
            // This gives users explicit control over whether to use cached data.
            
            // Function to update manual override for a campaign
            const updateManualOverride = (campaignId, updates) => {
                setManualOverrides(prev => ({
                    ...prev,
                    [campaignId]: {
                        ...(prev[campaignId] || {}),
                        ...updates,
                        lastModified: new Date().toISOString()
                    }
                }));
            };
            
            // Function to clear a specific override
            const clearManualOverride = (campaignId) => {
                setManualOverrides(prev => {
                    const updated = { ...prev };
                    delete updated[campaignId];
                    return updated;
                });
            };
            
            // Function to clear all overrides
            const clearAllOverrides = () => {
                setManualOverrides({});
            };
            
            // Function to explicitly clear persisted CSV (for new upload)
            const clearPersistedData = () => {
                try {
                    localStorage.removeItem('stap_csv_data');
                    localStorage.removeItem('stap_data_source');
                    setBaseData({ holds: [], installs: [] });
                    setDataSource({ type: 'none', timestamp: null, error: null });
                    console.log('üóëÔ∏è Persisted data cleared');
                } catch (e) {
                    console.warn('Could not clear persisted data:', e);
                }
            };
            
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [columnMappingInfo, setColumnMappingInfo] = useState(null); // NEW: Column mapping feedback
            
            // SIDEBAR COLLAPSE STATE - for magical appear/vanish
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

            // LIVE MODE - Set to true when real data is uploaded
            const [isLiveMode, setIsLiveMode] = useState(false);

            // Material Receivers data (lifted to parent to persist across navigation)
            // Initialize from localStorage if available
            const [materialReceiverData, setMaterialReceiverData] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_materials_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('üì¶ Loaded', parsed.length, 'materials from localStorage');
                        return parsed;
                    }
                } catch (e) {
                    console.error('Failed to load materials from localStorage:', e);
                }
                return [];
            });
            const [materialReceiverLinkedSheet, setMaterialReceiverLinkedSheet] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_materials_sheet');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null;
                }
            });
            
            // Save materials to localStorage whenever they change
            React.useEffect(() => {
                if (materialReceiverData.length > 0) {
                    localStorage.setItem('stap_materials_data', JSON.stringify(materialReceiverData));
                    console.log('üíæ Saved', materialReceiverData.length, 'materials to localStorage');
                }
            }, [materialReceiverData]);
            
            // Save linked sheet info to localStorage
            React.useEffect(() => {
                if (materialReceiverLinkedSheet) {
                    localStorage.setItem('stap_materials_sheet', JSON.stringify(materialReceiverLinkedSheet));
                }
            }, [materialReceiverLinkedSheet]);
            
            // Auto-sync isLiveMode when materials data changes
            React.useEffect(() => {
                if (materialReceiverData.length > 0) {
                    setIsLiveMode(true);
                } else {
                    setIsLiveMode(false);
                }
            }, [materialReceiverData]);
            
            // NEW: Header Filter State - Now supports multiple selections
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [dateSort, setDateSort] = useState('desc'); // Default Descending (Newest to Oldest / Most Recent First)
            const [marketFilters, setMarketFilters] = useState([]); // Array of selected markets/groups
            const [productFilters, setProductFilters] = useState([]); // Array of selected products/groups
            const [productionFilter, setProductionFilter] = useState('ALL'); // 'ALL', 'in-house', 'client', 'mixed', 'unset'
            
            // SMART GROUPINGS - Market Regions
            const MARKET_GROUPS = {
                'West Coast': ['Los Angeles', 'San Francisco', 'Seattle', 'San Diego', 'Portland', 'Sacramento'],
                'East Coast': ['New York', 'Boston', 'Philadelphia', 'Washington', 'Baltimore', 'Newark'],
                'Southwest': ['Dallas', 'Houston', 'Phoenix', 'Austin', 'San Antonio', 'Denver'],
                'Southeast': ['Miami', 'Orlando', 'Atlanta', 'Tampa', 'Charlotte', 'Nashville'],
                'Midwest': ['Chicago', 'Detroit', 'Minneapolis', 'Cleveland', 'Indianapolis', 'Columbus']
            };
            
            // SMART GROUPINGS - Product Categories  
            const PRODUCT_GROUPS = {
                'All Digital': ['Digital Network-Spot', 'Digital Panel-Spot', 'Digital Network-Quarter Spot', 'Digital Domination', 'Digital Panel-Spot-Playlist'],
                'All Static Panels': ['Panel-Targeted', 'Panel-Network', 'Panel-Icon'],
                'Premium Units': ['Domination', 'Full Wrap', 'Production Embellishments']
            };
            
            // Customization State
            const [visibleStatKeys, setVisibleStatKeys] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_dashboard_prefs');
                    const parsed = saved ? JSON.parse(saved) : null;
                    // Validate that parsed is an array with valid keys
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('üìä Dashboard prefs loaded:', parsed);
                        return parsed;
                    }
                } catch (e) {
                    console.error('‚ùå Error loading dashboard prefs:', e);
                }
                console.log('üìä Using default dashboard cards');
                return DEFAULT_VISIBLE_CARDS;
            });
            const [isCustomizeModalOpen, setIsCustomizeModalOpen] = useState(false);
            
            // NEW: Custom Widgets State
            const [customWidgets, setCustomWidgets] = useState(() => {
                const saved = localStorage.getItem('stap_custom_widgets');
                return saved ? JSON.parse(saved) : [];
            });
            const [isCustomWidgetModalOpen, setIsCustomWidgetModalOpen] = useState(false);
            const [editingWidget, setEditingWidget] = useState(null);
            
            // Save custom widgets to localStorage
            useEffect(() => {
                localStorage.setItem('stap_custom_widgets', JSON.stringify(customWidgets));
            }, [customWidgets]);
            
            // NEW: Digest Modal State (Lazy-loaded)
            const [isDigestModalOpen, setIsDigestModalOpen] = useState(false);
            const [digestModalLoaded, setDigestModalLoaded] = useState(false);
            const [digestModalLoading, setDigestModalLoading] = useState(false);

            // Lazy load digestModal.js only when needed
            const openDigestModal = async () => {
                if (!digestModalLoaded && !digestModalLoading) {
                    setDigestModalLoading(true);
                    try {
                        // Fetch and compile the script with Babel
                        const response = await fetch('digestModal.js?v=' + Date.now());
                        const code = await response.text();
                        const compiled = Babel.transform(code, { presets: ['react'] }).code;
                        const script = document.createElement('script');
                        script.textContent = compiled;
                        document.head.appendChild(script);
                        setDigestModalLoaded(true);
                        console.log('‚úÖ digestModal.js lazy-loaded');
                    } catch (err) {
                        console.error('Failed to load digestModal.js:', err);
                    }
                    setDigestModalLoading(false);
                }
                setIsDigestModalOpen(true);
            };

            // AI Pipeline Insight State
            const [pipelineInsight, setPipelineInsight] = useState('');
            const [isInsightLoading, setIsInsightLoading] = useState(false);

            // --- DEBUGGER STATE (Required for Console) ---
            const [debugLogs, setDebugLogs] = useState([]);
            // NEW: State to hide/show the console
            const [showDebug, setShowDebug] = useState(false); 
            const [secretClicks, setSecretClicks] = useState(0); // Track clicks

            const addLog = (msg) => {
                setDebugLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev]);
            };
            const clearLogs = () => setDebugLogs([]);

            // NEW: Secret Handler
            const handleSecretMode = () => {
                const newCount = secretClicks + 1;
                setSecretClicks(newCount);
                if (newCount === 5) {
                    setShowDebug(prev => !prev); // Toggle on/off
                    setSecretClicks(0); // Reset counter
                    // Optional: distinct visual cue
                    if (!showDebug) alert("üë®‚Äçüíª Developer Mode Enabled: Debug Console is now visible.");
                }
            };

            // --- EMAIL STATS LOGIC (NEW) ---
            const [emailStats, setEmailStats] = useState(() => {
                const saved = localStorage.getItem('stap_email_log');
                return saved ? JSON.parse(saved) : {};
            });

            useEffect(() => {
                localStorage.setItem('stap_email_log', JSON.stringify(emailStats));
            }, [emailStats]);

            const handleLogEmail = (key) => {
                setEmailStats(prev => ({
                    ...prev,
                    [key]: (prev[key] || 0) + 1
                }));
            };

            const handleResetEmailLogs = () => {
                if (confirm("Are you sure you want to clear all email sent logs? This cannot be undone.")) {
                    setEmailStats({});
                }
            };

            useEffect(() => {
                localStorage.setItem('stap_dashboard_prefs', JSON.stringify(visibleStatKeys));
            }, [visibleStatKeys]);

            const handleToggleStat = (key) => {
                setVisibleStatKeys(prev => 
                    prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]
                );
            };

            const handleResetStats = () => {
                setVisibleStatKeys(DEFAULT_VISIBLE_CARDS);
                // Also reset filters when resetting stats
                setMarketFilters([]);
                setProductFilters([]);
                setProductionFilter('ALL');
                console.log('üîÑ Dashboard reset to defaults');
            };

            // Production Proof Webhook for Google Sheet Sync
            const [proofWebhookUrl, setProofWebhookUrl] = useState(
                localStorage.getItem('stap_proof_webhook') || ''
            );

            const saveProofWebhookUrl = (url) => {
                setProofWebhookUrl(url);
                localStorage.setItem('stap_proof_webhook', url);
            };

            /**
             * Syncs production proof changes to Google Sheet via Apps Script webhook
             * @param {string} campaignKey - Composite key for the campaign
             * @param {string} productionProof - 'in-house', 'client', or 'mixed'
             */
            const syncProofToSheet = async (campaignKey, productionProof) => {
                if (!proofWebhookUrl) return; // No webhook configured

                try {
                    await fetch(proofWebhookUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateProof',
                            campaignKey,
                            productionProof,
                            timestamp: new Date().toISOString()
                        })
                    });
                    console.log(`üì§ Proof synced to Sheet: ${campaignKey} ‚Üí ${productionProof}`);
                } catch (e) {
                    console.warn('Proof sync failed:', e);
                }
            };

            /**
             * Updates campaign override data (stage, install counts, production proof, etc.)
             * @param {string} campaignKey - Composite key: `${campaignId}_${date}` for unique identification
             * @param {string} newStage - New stage value (can be same as current if only updating other fields)
             * @param {Object} additionalUpdates - Optional fields: { productionProof, installed, pending, notes, photosLink, receiverLink, materialBreakdown }
             */
            const handleUpdateStage = (campaignKey, newStage, additionalUpdates = {}) => {
                console.log('üîß handleUpdateStage called:', { campaignKey, newStage, additionalUpdates });
                const updates = { stage: newStage, ...additionalUpdates };
                updateManualOverride(campaignKey, updates);
                console.log('‚úÖ Override saved for:', campaignKey, '‚Üí', newStage);

                // If material data is provided, also store it for Material Receiver sync
                if (additionalUpdates.materialBreakdown || additionalUpdates.photosLink || additionalUpdates.receiverLink) {
                    const materialData = JSON.parse(localStorage.getItem('stap_material_data') || '{}');
                    materialData[campaignKey] = {
                        materialBreakdown: additionalUpdates.materialBreakdown || [],
                        photosLink: additionalUpdates.photosLink || null,
                        receiverLink: additionalUpdates.receiverLink || null,
                        mediaType: additionalUpdates.mediaType || null,
                        totalQty: additionalUpdates.totalQty || null,
                        updatedAt: new Date().toISOString()
                    };
                    localStorage.setItem('stap_material_data', JSON.stringify(materialData));
                    console.log('üì¶ Material data synced for:', campaignKey);
                }

                // Sync production proof to Google Sheet if webhook is configured
                if (additionalUpdates.productionProof) {
                    syncProofToSheet(campaignKey, additionalUpdates.productionProof);
                }

                // Also update the selected item so the modal reflects changes instantly
                setSelectedItem(prev => {
                    if (!prev) return null;
                    const updated = { ...prev, stage: newStage, isOverridden: true };
                    if (additionalUpdates.installed !== undefined) {
                        updated.totalInstalled = additionalUpdates.installed;
                        updated.installed = additionalUpdates.installed;
                        const totalQty = prev.totalQty || prev.quantity || 0;
                        updated.pending = Math.max(0, totalQty - additionalUpdates.installed);
                    }
                    if (additionalUpdates.photosLink) updated.photosLink = additionalUpdates.photosLink;
                    if (additionalUpdates.receiverLink) updated.receiverLink = additionalUpdates.receiverLink;
                    if (additionalUpdates.materialBreakdown) updated.materialBreakdown = additionalUpdates.materialBreakdown;
                    if (additionalUpdates.productionProof) updated.productionProof = additionalUpdates.productionProof;
                    return updated;
                });
            };

            // Quick update for install count only (from inline edit)
            const handleUpdateInstallCount = (id, installedCount) => {
                updateManualOverride(id, { installed: installedCount });
            };

            // Handler for resetting data to be passed to Sidebar
            const handleResetData = (clearPersisted = false) => {
                setFiles({holds:null, install:null});
                setBaseData({ holds: [], installs: [] });
                setColumnMappingInfo(null); // Reset column mapping
                setView('upload');
                setDateFilter({ start: '', end: '' }); // Reset date filters
                setMarketFilters([]); // Reset market filters
                setProductFilters([]); // Reset product filters
                
                if (clearPersisted) {
                    clearPersistedData();
                    clearAllOverrides();
                }
            };

            // üëª GHOST BOOKING STATE
            const [ghostBookings, setGhostBookings] = useState([]);
            const [showGhostAlert, setShowGhostAlert] = useState(false);
            const [includeGhosts, setIncludeGhosts] = useState(false); // Toggle to include/exclude ghosts
            
            // üîß GOOGLE SHEET SETTINGS (Hidden Feature)
            const [showSheetSettings, setShowSheetSettings] = useState(false);

            // Main processing function (UPGRADED: Single Source of Truth)
            const runProcessingLogic = (rawData, rawInstalls = null) => {
                // Process using unified Master Export processor
                const result = processMasterExport(rawData);
                
                // Capture column mapping info for UI feedback
                if (window.__lastColumnMapping) {
                    setColumnMappingInfo(window.__lastColumnMapping);
                    const { matched, total, missingRequired } = window.__lastColumnMapping;
                    if (missingRequired.length > 0) {
                        addLog(`‚ö†Ô∏è Column mapping: ${matched}/${total} matched. Missing required: ${missingRequired.join(', ')}`);
                    } else {
                        addLog(`‚úÖ Smart column mapping: ${matched}/${total} columns matched successfully`);
                    }
                }
                
                const data = {
                    holds: result.regular,
                    installs: result.regular, // Same data source now
                    specialtyHolds: result.specialty,
                    lost: result.lost
                };

                // üëª Handle Ghost Bookings
                if (result.ghosts && result.ghosts.length > 0) {
                    setGhostBookings(result.ghosts);
                    setShowGhostAlert(true); // Trigger alert modal
                    addLog(`üëª WARNING: ${result.ghosts.length} ghost bookings detected (no sales owner or no stage)`);
                } else {
                    setGhostBookings([]);
                    setShowGhostAlert(false);
                }

                setBaseData(data);
                setView('dashboard');
            };

            // --- ‚úÑ LIVE SYNC IMPLEMENTATION ---
            
            // Google Sheet configuration - now uses saved URL from settings
            const getSavedSheetConfig = () => {
                const savedUrl = localStorage.getItem('stap_google_sheet_url');
                if (savedUrl) {
                    const sheetIdMatch = savedUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    const gidMatch = savedUrl.match(/gid=(\d+)/);
                    if (sheetIdMatch) {
                        return {
                            sheetId: sheetIdMatch[1],
                            gid: gidMatch ? gidMatch[1] : '0'
                        };
                    }
                }
                // Default fallback
                return {
                    sheetId: "1m02U3lviYB0W4Cqt77J-_0s4XwVBu-fGZXFfpawJqjM",
                    gid: "57794332"
                };
            };
            
            const sheetConfig = getSavedSheetConfig();
            const SHEET_ID = sheetConfig.sheetId;
            const SHEET_GID = sheetConfig.gid;
            
            // Using the 'export' endpoint
            const GOOGLE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

            const handleLiveSync = async () => {
                setProcessing(true);
                clearLogs();
                addLog("üöÄ Starting Live Sync sequence...");
                
                // Get fresh config in case it was updated
                const config = getSavedSheetConfig();
                const googleUrl = `https://docs.google.com/spreadsheets/d/${config.sheetId}/export?format=csv&gid=${config.gid}`;
                
                addLog(`üìã Sheet ID: ${config.sheetId.substring(0, 10)}...`);
                addLog(`üìã Tab GID: ${config.gid}`);
                addLog("üìã Strategy: Google Sheet ‚Üí Fallback to Persisted CSV");

                // List of proxies to try in order
                const gateways = [
                    { name: "Primary (AllOrigins)", url: `https://api.allorigins.win/raw?url=${encodeURIComponent(googleUrl)}` },
                    { name: "Backup 1 (CorsProxy)", url: `https://corsproxy.io/?${encodeURIComponent(googleUrl)}` },
                    { name: "Backup 2 (CodeTabs)",  url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(googleUrl)}` }
                ];

                let syncSuccess = false;

                try {
                    let csvText = null;

                    // Loop through gateways until one works
                    for (const gateway of gateways) {
                        try {
                            addLog(`üîÑ Connecting via ${gateway.name}...`);
                            const response = await fetch(gateway.url);
                            
                            if (response.ok) {
                                const text = await response.text();
                                // Validation: Ensure it's not an HTML error page
                                if (text && !text.trim().startsWith("<!DOCTYPE") && !text.includes("<html")) {
                                    csvText = text;
                                    addLog(`‚úÖ Success via ${gateway.name}!`);
                                    break; // Stop looping, we got the data
                                } else {
                                    addLog(`‚ö†Ô∏è ${gateway.name} returned HTML (Auth Error). Skipping...`);
                                }
                            } else {
                                addLog(`‚ö†Ô∏è ${gateway.name} HTTP ${response.status}. Skipping...`);
                            }
                        } catch (e) {
                            addLog(`‚ö†Ô∏è ${gateway.name} Error: ${e.message}`);
                        }
                    }

                    if (csvText) {
                        addLog(`üì¶ Payload received: ${csvText.length} bytes`);
                        
                        const rawMergedData = parseCSV(csvText);
                        addLog(`üìä CSV Parsed: ${rawMergedData.length} rows found`);

                        if (rawMergedData.length === 0) throw new Error("Parsed data is empty.");

                        // Debug: Verify we see the 'End' header now
                        const headers = Object.keys(rawMergedData[0]).join(", ").toLowerCase();
                        if (headers.includes("end")) {
                            addLog("‚úÖ 'End' column confirmed.");
                        } else {
                            addLog("‚ö†Ô∏è WARNING: 'End' column NOT found in headers.");
                        }

                        // Process Data from Google Sheet
                        addLog("‚öôÔ∏è Processing Google Sheet data...");
                        runProcessingLogic(rawMergedData, rawMergedData);
                        
                        // Update data source tracking
                        setDataSource({
                            type: 'google_sheet',
                            timestamp: new Date().toISOString(),
                            error: null,
                            rowCount: rawMergedData.length
                        });
                        
                        addLog("‚úÖ Live Sync Complete!");
                        syncSuccess = true;
                    } else {
                        throw new Error("All gateways failed to fetch Google Sheet.");
                    }

                } catch (error) {
                    console.error('Live sync error:', error);
                    addLog(`‚ùå Google Sheet sync failed: ${error.message}`);
                    
                    // ============================================
                    // SMART FALLBACK: Try persisted CSV data
                    // ============================================
                    addLog("üîÑ Attempting fallback to persisted CSV data...");
                    
                    try {
                        const persistedData = localStorage.getItem('stap_csv_data');
                        if (persistedData) {
                            const parsed = JSON.parse(persistedData);
                            if ((parsed.holds?.length > 0) || (parsed.installs?.length > 0)) {
                                addLog(`üìÇ Found persisted data: ${parsed.holds?.length || 0} holds, ${parsed.installs?.length || 0} installs`);
                                
                                // Use persisted data
                                setBaseData(parsed);
                                setDataSource({
                                    type: 'persisted_csv',
                                    timestamp: new Date().toISOString(),
                                    error: error.message,
                                    fallback: true
                                });
                                
                                addLog("‚úÖ Fallback successful! Using persisted CSV data.");
                                addLog("‚ÑπÔ∏è Note: Data may be outdated. Try Live Sync again when connection is stable.");
                                syncSuccess = true;
                            } else {
                                addLog("‚ö†Ô∏è No persisted CSV data available for fallback.");
                            }
                        } else {
                            addLog("‚ö†Ô∏è No persisted CSV data found in localStorage.");
                        }
                    } catch (fallbackError) {
                        addLog(`‚ùå Fallback also failed: ${fallbackError.message}`);
                    }
                    
                    if (!syncSuccess) {
                        setDataSource({
                            type: 'error',
                            timestamp: new Date().toISOString(),
                            error: error.message
                        });
                        alert("Sync Failed and no fallback data available. Please upload a CSV file manually.");
                    }
                } finally {
                    setProcessing(false);
                }
            };
            // ----------------------------------

            const processData = async () => {
                setProcessing(true);
                await new Promise(r => setTimeout(r, 800));

                try {
                    let rawHolds = [], rawInstalls = [];

                    if (files.install) {
                        const text = await files.install.text();
                        rawInstalls = parseCSV(text);
                    }

                    if (files.holds) {
                        const text = await files.holds.text();
                        rawHolds = parseCSV(text);
                    }
                    
                    runProcessingLogic(rawHolds, rawInstalls);
                    
                    // Track data source as CSV upload
                    setDataSource({
                        type: 'csv_upload',
                        timestamp: new Date().toISOString(),
                        error: null,
                        files: {
                            holds: files.holds?.name || null,
                            install: files.install?.name || null
                        },
                        rowCount: rawHolds.length + rawInstalls.length
                    });

                } catch (e) {
                    alert("Error processing files: " + e.message);
                    setDataSource({
                        type: 'error',
                        timestamp: new Date().toISOString(),
                        error: e.message
                    });
                } finally {
                    setProcessing(false);
                }
            };

            const generatePipelineInsight = async (allCampaigns) => {
                setIsInsightLoading(true);

                // --- 1. FETCH LIVE WEATHER ---
                let weatherData = [];
                let weatherContext = "Weather data unavailable.";
                let weatherRisk = "unknown";
                try {
                    weatherData = await fetchLiveWeather('Los Angeles, CA');
                    const next3Days = weatherData.slice(0, 3);
                    const maxRain = Math.max(...next3Days.map(d => d.rainChance));
                    const avgTemp = Math.round(next3Days.reduce((s, d) => s + d.temp, 0) / 3);
                    const rainDays = next3Days.filter(d => d.rainChance > 50).map(d => d.day).join(', ');

                    if (maxRain > 85) {
                        weatherContext = `üö® CRITICAL: Heavy rain (${maxRain}% chance) expected${rainDays ? ` on ${rainDays}` : ''}. HALT all field installs immediately.`;
                        weatherRisk = "critical";
                    } else if (maxRain > 60) {
                        weatherContext = `‚ö†Ô∏è CAUTION: Moderate rain risk (${maxRain}%)${rainDays ? ` on ${rainDays}` : ''}. Reschedule outdoor work.`;
                        weatherRisk = "warning";
                    } else if (maxRain > 30) {
                        weatherContext = `‚òÅÔ∏è WATCH: Some rain possible (${maxRain}%). Monitor hourly forecasts.`;
                        weatherRisk = "watch";
                    } else {
                        weatherContext = `‚úÖ CLEAR: Favorable conditions (${avgTemp}¬∞F, ${maxRain}% rain). Full operations approved.`;
                        weatherRisk = "good";
                    }
                } catch (e) {
                    console.error('Weather fetch failed:', e);
                }

                // --- 2. Calculate Holiday Risk ---
                const today = new Date();
                const nextHoliday = UPCOMING_HOLIDAYS.find(h => {
                    let hDate = new Date(h.date + " " + today.getFullYear());
                    if (hDate < today) hDate.setFullYear(today.getFullYear() + 1);
                    const diffDays = (hDate - today) / (1000 * 60 * 60 * 24);
                    return diffDays >= 0 && diffDays <= 14;
                });

                const holidayContext = nextHoliday
                    ? `üìÖ STAFFING ALERT: '${nextHoliday.name}' (${nextHoliday.type}) approaching. Expect reduced crew availability.`
                    : "‚úÖ No holiday staffing constraints.";

                // --- 3. CALCULATE COMPREHENSIVE METRICS ---
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                // Calculate week bounds (Monday to Sunday)
                const dayOfWeek = now.getDay();
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const thisMonday = new Date(now); thisMonday.setDate(now.getDate() + diffToMonday); thisMonday.setHours(0,0,0,0);
                const thisSunday = new Date(thisMonday); thisSunday.setDate(thisMonday.getDate() + 6); thisSunday.setHours(23,59,59,999);

                // Determine active filters for context
                const activeFilterContext = [];
                if (marketFilters.length > 0) activeFilterContext.push(`Markets: ${marketFilters.join(', ')}`);
                if (productFilters.length > 0) activeFilterContext.push(`Products: ${productFilters.join(', ')}`);
                if (productionFilter !== 'ALL') activeFilterContext.push(`Production: ${productionFilter}`);
                const filterNote = activeFilterContext.length > 0
                    ? `‚ö†Ô∏è FILTERED VIEW: ${activeFilterContext.join(' | ')}`
                    : 'üìä FULL PORTFOLIO VIEW (no filters applied)';

                const safeCampaigns = allCampaigns || [];
                const totalCampaigns = safeCampaigns.length;

                // --- COMPREHENSIVE INSTALL TRACKING ---
                const installMetrics = {
                    // Unit-level tracking
                    totalUnitsOrdered: 0,
                    totalUnitsInstalled: 0,
                    totalUnitsPending: 0,

                    // Campaign-level tracking
                    fullyInstalled: [],      // 100% complete
                    partiallyInstalled: [],  // Some progress, not done
                    notStarted: [],          // 0 installed

                    // Risk categories
                    stalledCampaigns: [],    // Started but no recent progress
                    atRiskCampaigns: [],     // Past start date, low completion
                    criticalCampaigns: [],   // High priority issues
                };

                const holdMetrics = {
                    count: 0,
                    totalQty: 0,
                    campaigns: [],
                    byReason: {}
                };

                const removalMetrics = {
                    thisWeek: { count: 0, qty: 0, campaigns: [] },
                    overdue: { count: 0, qty: 0, campaigns: [] }
                };

                const pipelineMetrics = {
                    rfp: { count: 0, qty: 0 },
                    proposal: { count: 0, qty: 0 },
                    contracted: { count: 0, qty: 0 },
                    proofsApproved: { count: 0, qty: 0 },
                    materialReady: { count: 0, qty: 0 },
                    installed: { count: 0, qty: 0 },
                    popComplete: { count: 0, qty: 0 }
                };

                const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                const holdStages = ['pending hold', 'on hold'];
                const activeInstallStages = ['material ready for install', 'installed'];

                safeCampaigns.forEach(c => {
                    const stage = (c.stage || '').trim();
                    const stageLower = stage.toLowerCase();
                    const qty = parseFloat(c.quantity) || parseFloat(c.totalQty) || 0;
                    const installed = parseFloat(c.totalInstalled) || parseFloat(c.installed) || 0;
                    const pending = parseFloat(c.pending) || (qty - installed);
                    const completionPct = qty > 0 ? Math.round((installed / qty) * 100) : 0;

                    let startDate = c.dateObj;
                    if (!startDate && c.date) startDate = new Date(c.date);

                    let endDate = c.endDateObj;
                    if (!endDate && c.endDate) endDate = new Date(c.endDate);

                    const daysSinceStart = startDate ? Math.floor((now - startDate) / (1000 * 60 * 60 * 24)) : null;
                    const daysUntilEnd = endDate ? Math.floor((endDate - now) / (1000 * 60 * 60 * 24)) : null;

                    // --- UNIT-LEVEL INSTALL TRACKING ---
                    if (activeInstallStages.includes(stageLower) || stageLower.includes('material ready')) {
                        installMetrics.totalUnitsOrdered += qty;
                        installMetrics.totalUnitsInstalled += installed;
                        installMetrics.totalUnitsPending += pending;

                        const campaignInfo = {
                            advertiser: c.advertiser,
                            market: c.market,
                            qty: qty,
                            installed: installed,
                            pending: pending,
                            completionPct: completionPct,
                            stage: stage,
                            daysSinceStart: daysSinceStart,
                            daysUntilEnd: daysUntilEnd,
                            owner: c.owner
                        };

                        if (completionPct >= 100 || pending === 0) {
                            installMetrics.fullyInstalled.push(campaignInfo);
                        } else if (installed > 0) {
                            installMetrics.partiallyInstalled.push(campaignInfo);

                            // Check for stalled campaigns (started >7 days ago, <50% complete)
                            if (daysSinceStart > 7 && completionPct < 50) {
                                installMetrics.stalledCampaigns.push(campaignInfo);
                            }
                        } else {
                            installMetrics.notStarted.push(campaignInfo);

                            // Check for at-risk (past start date, 0% progress)
                            if (daysSinceStart > 0) {
                                installMetrics.atRiskCampaigns.push(campaignInfo);
                            }
                        }

                        // Critical: Past start date, ending soon, low completion
                        if (daysSinceStart > 3 && daysUntilEnd !== null && daysUntilEnd < 7 && completionPct < 50) {
                            installMetrics.criticalCampaigns.push(campaignInfo);
                        }
                    }

                    // --- HOLD TRACKING ---
                    if (holdStages.includes(stageLower)) {
                        holdMetrics.count++;
                        holdMetrics.totalQty += qty;
                        const holdReason = c.holdReason || 'Unspecified';
                        holdMetrics.campaigns.push({
                            advertiser: c.advertiser,
                            market: c.market,
                            qty: qty,
                            reason: holdReason,
                            owner: c.owner
                        });
                        holdMetrics.byReason[holdReason] = (holdMetrics.byReason[holdReason] || 0) + 1;
                    }

                    // --- REMOVAL TRACKING ---
                    if (endDate && stageLower !== 'takedown complete') {
                        if (endDate >= thisMonday && endDate <= thisSunday) {
                            removalMetrics.thisWeek.count++;
                            removalMetrics.thisWeek.qty += qty;
                            removalMetrics.thisWeek.campaigns.push({
                                advertiser: c.advertiser,
                                endDate: c.endDate,
                                qty: qty
                            });
                        } else if (endDate < now) {
                            removalMetrics.overdue.count++;
                            removalMetrics.overdue.qty += qty;
                            removalMetrics.overdue.campaigns.push({
                                advertiser: c.advertiser,
                                endDate: c.endDate,
                                qty: qty,
                                daysOverdue: Math.floor((now - endDate) / (1000 * 60 * 60 * 24))
                            });
                        }
                    }

                    // --- PIPELINE STAGE TRACKING ---
                    if (stageLower.includes('rfp')) pipelineMetrics.rfp.count++, pipelineMetrics.rfp.qty += qty;
                    else if (stageLower.includes('proposal')) pipelineMetrics.proposal.count++, pipelineMetrics.proposal.qty += qty;
                    else if (stageLower.includes('contracted')) pipelineMetrics.contracted.count++, pipelineMetrics.contracted.qty += qty;
                    else if (stageLower.includes('proofs approved')) pipelineMetrics.proofsApproved.count++, pipelineMetrics.proofsApproved.qty += qty;
                    else if (stageLower.includes('material ready')) pipelineMetrics.materialReady.count++, pipelineMetrics.materialReady.qty += qty;
                    else if (stageLower === 'installed') pipelineMetrics.installed.count++, pipelineMetrics.installed.qty += qty;
                    else if (stageLower.includes('pop')) pipelineMetrics.popComplete.count++, pipelineMetrics.popComplete.qty += qty;
                });

                // Calculate overall completion rate
                const overallCompletionRate = installMetrics.totalUnitsOrdered > 0
                    ? Math.round((installMetrics.totalUnitsInstalled / installMetrics.totalUnitsOrdered) * 100)
                    : 0;

                // Sort risk lists by severity
                installMetrics.criticalCampaigns.sort((a, b) => a.daysUntilEnd - b.daysUntilEnd);
                installMetrics.stalledCampaigns.sort((a, b) => a.completionPct - b.completionPct);
                installMetrics.atRiskCampaigns.sort((a, b) => b.daysSinceStart - a.daysSinceStart);

                // Format risk summaries
                const criticalSummary = installMetrics.criticalCampaigns.slice(0, 5).map(c =>
                    `${c.advertiser} (${c.completionPct}% done, ${c.daysUntilEnd}d left)`
                ).join('; ') || 'None';

                const stalledSummary = installMetrics.stalledCampaigns.slice(0, 5).map(c =>
                    `${c.advertiser} (${c.completionPct}%, stalled ${c.daysSinceStart}d)`
                ).join('; ') || 'None';

                const atRiskSummary = installMetrics.atRiskCampaigns.slice(0, 5).map(c =>
                    `${c.advertiser} (${c.daysSinceStart}d late, 0%)`
                ).join('; ') || 'None';

                const holdSummary = holdMetrics.campaigns.slice(0, 5).map(c =>
                    `${c.advertiser} (${c.qty} units - ${c.reason})`
                ).join('; ') || 'None';

                const overdueRemovalSummary = removalMetrics.overdue.campaigns.slice(0, 3).map(c =>
                    `${c.advertiser} (${c.daysOverdue}d overdue)`
                ).join('; ') || 'None';

                // --- 4. RISK-FOCUSED EXECUTIVE PROMPT ---
                const prompt = `You are the Senior Director of Operations at Vector Media, a national out-of-home advertising company. You are known for your sharp risk assessment skills and zero tolerance for operational failures. Your job is to identify disasters before they happen.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ OPERATIONAL RISK ASSESSMENT - ${now.toLocaleDateString()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${filterNote}
Total Campaigns in View: ${totalCampaigns}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä INSTALL EXECUTION SCORECARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

UNIT-LEVEL TRACKING:
‚Ä¢ Total Units Ordered: ${installMetrics.totalUnitsOrdered.toLocaleString()}
‚Ä¢ Units Installed: ${installMetrics.totalUnitsInstalled.toLocaleString()} (${overallCompletionRate}%)
‚Ä¢ Units Pending: ${installMetrics.totalUnitsPending.toLocaleString()}

CAMPAIGN STATUS:
‚Ä¢ ‚úÖ Fully Installed: ${installMetrics.fullyInstalled.length} campaigns
‚Ä¢ üîÑ Partially Installed: ${installMetrics.partiallyInstalled.length} campaigns
‚Ä¢ ‚è≥ Not Started: ${installMetrics.notStarted.length} campaigns

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö® RISK RADAR - IMMEDIATE ATTENTION REQUIRED
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CRITICAL (Ending Soon + Low Completion): ${installMetrics.criticalCampaigns.length} campaigns
${installMetrics.criticalCampaigns.length > 0 ? `‚Üí ${criticalSummary}` : '‚Üí None - Good'}

STALLED (Started >7d ago, <50% complete): ${installMetrics.stalledCampaigns.length} campaigns
${installMetrics.stalledCampaigns.length > 0 ? `‚Üí ${stalledSummary}` : '‚Üí None - Good'}

AT RISK (Past start date, 0% installed): ${installMetrics.atRiskCampaigns.length} campaigns
${installMetrics.atRiskCampaigns.length > 0 ? `‚Üí ${atRiskSummary}` : '‚Üí None - Good'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚è∏Ô∏è HOLDS BLOCKING REVENUE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Campaigns on Hold: ${holdMetrics.count}
‚Ä¢ Units Blocked: ${holdMetrics.totalQty.toLocaleString()}
${holdMetrics.count > 0 ? `‚Üí ${holdSummary}` : '‚Üí No holds - pipeline flowing'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üóëÔ∏è REMOVAL OPERATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Removals Due This Week: ${removalMetrics.thisWeek.count} campaigns / ${removalMetrics.thisWeek.qty.toLocaleString()} units
‚Ä¢ OVERDUE Removals: ${removalMetrics.overdue.count} campaigns / ${removalMetrics.overdue.qty.toLocaleString()} units
${removalMetrics.overdue.count > 0 ? `‚Üí OVERDUE: ${overdueRemovalSummary}` : '‚Üí Removal schedule on track'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üå¶Ô∏è EXTERNAL RISK FACTORS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${weatherContext}
${holidayContext}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìà PIPELINE HEALTH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ RFP: ${pipelineMetrics.rfp.count} campaigns
‚Ä¢ Proposal: ${pipelineMetrics.proposal.count} campaigns
‚Ä¢ Contracted: ${pipelineMetrics.contracted.count} campaigns
‚Ä¢ Material Ready: ${pipelineMetrics.materialReady.count} campaigns (${pipelineMetrics.materialReady.qty} units)
‚Ä¢ Installed: ${pipelineMetrics.installed.count} campaigns
‚Ä¢ POP Complete: ${pipelineMetrics.popComplete.count} campaigns

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã YOUR DIRECTIVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

As Senior Director of Operations, provide a SHARP, NO-BS operational briefing (5-8 sentences max). You must:

1. **HEADLINE THE BIGGEST RISK** - What's the #1 thing that could blow up this week? Be specific with campaign names and numbers.

2. **INSTALL VELOCITY CHECK** - We're at ${overallCompletionRate}% installed (${installMetrics.totalUnitsInstalled}/${installMetrics.totalUnitsOrdered} units). ${overallCompletionRate < 50 ? 'This is CONCERNING.' : overallCompletionRate < 75 ? 'We need to accelerate.' : 'Solid progress.'} What's the path to completion?

3. **CALL OUT STALLED WORK** - ${installMetrics.stalledCampaigns.length > 0 ? `We have ${installMetrics.stalledCampaigns.length} stalled campaigns. NAME THEM and demand action.` : 'No stalled campaigns - acknowledge this.'}

4. **HOLDS IMPACT** - ${holdMetrics.count > 0 ? `${holdMetrics.count} campaigns (${holdMetrics.totalQty} units) are held up. What's the revenue impact and who needs to unblock?` : 'Pipeline is clear of holds.'}

5. **WEATHER/STAFFING** - ${weatherRisk === 'critical' || weatherRisk === 'warning' ? 'CRITICAL: Factor weather into your directive!' : 'Weather is favorable.'} ${nextHoliday ? 'Holiday staffing risk is real.' : ''}

Be DIRECT. Use SPECIFIC NUMBERS. Call out SPECIFIC ADVERTISERS at risk. No corporate fluff. Act like millions of dollars are on the line - because they are.`;

                try {
                    const text = await callGroq(prompt, 2000);
                    setPipelineInsight(text);
                } catch (e) {
                    setPipelineInsight("Analysis unavailable. Please check API configuration.");
                } finally {
                    setIsInsightLoading(false);
                }
            };

            // ADDED: Helper to format dates for display in the Title
            const formatDateShort = (d) => `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

            const processedData = useMemo(() => {
                // This logic runs whenever baseData OR manualOverrides changes
                const categories = {
                    pastDue: [], thisWeek: [], nextMonth: [], upcoming: [], recentInstalls: [], 
                    pipelineSummary: [], activeInstalls: [], lostOpportunities: [], specialMedia: [], all: [], 
                    masterTracking: [], sixMonthHistory: [], inProgressFlights: [], delayedFlights: [],
                    fullyInstalledThisWeek: [], rotations: [], expiredFlights: [],
                    holdReport: [], // Simple pipeline view
                    ghostBookings: [], // Ghost bookings
                    materialReadyFuture: [], // Material Ready with future start dates
                    onHoldCampaigns: [] // Campaigns specifically on hold (Pending Hold / On Hold stage)
                };
                const pipelineCounts = {}; 
                
                // Map for Aggregating Expired Flights (Deduplication) - RESTORED
                const expiredMap = new Map(); 

                const today = new Date(); today.setHours(0,0,0,0);
                
                // Hold Report now includes ALL stages (simplified version of Install Report)
                
                // Hold stages
                const HOLD_STAGES = ['pending hold', 'on hold'];
                
                // Helper Dates for In-Progress Flights Logic
                const twoMonthsAgo = new Date(today); twoMonthsAgo.setMonth(today.getMonth() - 2);
                const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(today.getDate() - 7);
                
                // Helper Date for Installed This Week (Sunday start)
                const startOfFormulaWeek = new Date(today);
                startOfFormulaWeek.setDate(today.getDate() - today.getDay());
                
                // --- NEW: ROTATION LOGIC HELPERS (UPDATED) ---
                // User Requirement: "No past dates, only current and upcoming (til year end)"
                const endOfYear = new Date(today.getFullYear(), 11, 31);
                endOfYear.setHours(23, 59, 59, 999);
                
                // Update: Include the full current posting week (starting Sunday)
                // e.g., if today is Mon 12/9, we want to see rotations that started Sun 12/8
                const startOfPostingWeek = new Date(today);
                startOfPostingWeek.setDate(today.getDate() - today.getDay()); // Go back to Sunday
                startOfPostingWeek.setHours(0, 0, 0, 0);
                
                // --- STRICT EXPIRED FLIGHTS LOGIC üí° (Per Spreadsheet Formula) ---
                const currentDay = today.getDay(); // 0-6
                const distanceToMonday = currentDay === 0 ? 6 : currentDay - 1;
                
                const currentMonday = new Date(today);
                currentMonday.setDate(today.getDate() - distanceToMonday);
                currentMonday.setHours(0,0,0,0); // Normalize time

                const expiredStartCutoff = new Date(currentMonday);
                expiredStartCutoff.setDate(currentMonday.getDate() - 45);
                expiredStartCutoff.setHours(0,0,0,0); // Normalize time
                
                // Expose these for title display
                categories.expiredRangeStart = formatDateShort(expiredStartCutoff);
                categories.expiredRangeEnd = formatDateShort(currentMonday);
                // -------------------------------------------------------------
                
                // --- NEW DELAYED FLIGHTS HELPER DATES ---
                const startOfCurrentWeekMonday = new Date(currentMonday); 
                const delayedLookbackDate = new Date(today);
                delayedLookbackDate.setMonth(today.getMonth() - 2);
                // ------------------------------------------

                const rotationKeywords = [
                    "the rideshare amigo", "jacob emrani", "boren law", 
                    "los angeles department of transportation", "call jacob", 
                    "adriana's insuranc", "la care", "filler"
                ];

                // 1. Install Report is used ONLY for lookup map in processHoldReport.
                
                // 2. Specialty Media - ALSO CHECK FOR GHOSTS
                if (baseData.specialtyHolds) {
                    baseData.specialtyHolds.forEach(item => {
                        const newItem = { ...item };
                        
                        // Reconvert dates from localStorage strings
                        if (newItem.dateObj && !(newItem.dateObj instanceof Date)) {
                            newItem.dateObj = new Date(newItem.dateObj);
                        }
                        if (newItem.endDateObj && !(newItem.endDateObj instanceof Date)) {
                            newItem.endDateObj = new Date(newItem.endDateObj);
                        }
                        if (!newItem.dateObj && newItem.date) {
                            newItem.dateObj = new Date(newItem.date);
                        }
                        
                        // üëª Collect ghosts from specialty items too
                        if (newItem.isGhost) {
                            categories.ghostBookings.push(newItem);
                            if (!includeGhosts) return; // Skip from specialty view if excluding
                        }

                        // MODIFIED: Check composite key for extended overrides (includes product for uniqueness)
                        const uniqueKey = `${newItem.id}_${newItem.date}_${newItem.product || newItem.media}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            if (override.stage) {
                                newItem.stage = override.stage;
                                newItem.isOverridden = true;
                                // Recalculate isComplete based on stage hierarchy
                                const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                                if (completedStages.includes(override.stage.toLowerCase())) {
                                    newItem.isComplete = true;
                                }
                            }
                            if (override.previousStage) {
                                newItem.previousStage = override.previousStage;
                            }
                            // Apply adjusted quantity override
                            if (override.adjustedQty && override.adjustedQty > 0) {
                                newItem.adjustedQty = override.adjustedQty;
                                newItem.hasQtyAdjustment = true;
                                newItem.isOverridden = true;
                            }
                            if (override.installed !== undefined) {
                                newItem.totalInstalled = override.installed;
                                newItem.installed = override.installed;
                                const targetQty = newItem.adjustedQty || newItem.totalQty || newItem.quantity || 0;
                                newItem.pending = Math.max(0, targetQty - override.installed);
                                newItem.isOverridden = true;
                            } else if (newItem.hasQtyAdjustment) {
                                const installed = newItem.totalInstalled || newItem.installed || 0;
                                newItem.pending = Math.max(0, newItem.adjustedQty - installed);
                            }
                            if (override.productionProof) {
                                newItem.productionProof = override.productionProof;
                                newItem.isOverridden = true;
                            }
                        }
                        categories.specialMedia.push(newItem);
                    });
                }
                
                // 3. Lost Opportunities - ALSO CHECK FOR GHOSTS
                if (baseData.lost) {
                    baseData.lost.forEach(item => {
                        const newItem = { ...item };
                        
                        // Reconvert dates from localStorage strings
                        if (newItem.dateObj && !(newItem.dateObj instanceof Date)) {
                            newItem.dateObj = new Date(newItem.dateObj);
                        }
                        if (newItem.endDateObj && !(newItem.endDateObj instanceof Date)) {
                            newItem.endDateObj = new Date(newItem.endDateObj);
                        }
                        if (!newItem.dateObj && newItem.date) {
                            newItem.dateObj = new Date(newItem.date);
                        }
                        
                        // üëª Collect ghosts from lost items too
                        if (newItem.isGhost) {
                            categories.ghostBookings.push(newItem);
                        }

                        // MODIFIED: Check composite key for extended overrides (includes product for uniqueness)
                        const uniqueKey = `${newItem.id}_${newItem.date}_${newItem.product || newItem.media}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            if (override.stage) {
                                newItem.stage = override.stage;
                                newItem.isOverridden = true;
                                // Recalculate isComplete based on stage hierarchy
                                const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                                if (completedStages.includes(override.stage.toLowerCase())) {
                                    newItem.isComplete = true;
                                }
                            }
                            if (override.previousStage) {
                                newItem.previousStage = override.previousStage;
                            }
                            // Apply adjusted quantity override
                            if (override.adjustedQty && override.adjustedQty > 0) {
                                newItem.adjustedQty = override.adjustedQty;
                                newItem.hasQtyAdjustment = true;
                                newItem.isOverridden = true;
                            }
                            if (override.installed !== undefined) {
                                newItem.totalInstalled = override.installed;
                                newItem.installed = override.installed;
                                const targetQty = newItem.adjustedQty || newItem.totalQty || newItem.quantity || 0;
                                newItem.pending = Math.max(0, targetQty - override.installed);
                                newItem.isOverridden = true;
                            } else if (newItem.hasQtyAdjustment) {
                                const installed = newItem.totalInstalled || newItem.installed || 0;
                                newItem.pending = Math.max(0, newItem.adjustedQty - installed);
                            }
                            if (override.productionProof) {
                                newItem.productionProof = override.productionProof;
                                newItem.isOverridden = true;
                            }
                        }
                        categories.lostOpportunities.push(newItem);
                    });
                }
                
                // 4. Dashboard / Pipeline (THE MAIN SOURCE LOOP)
                if (baseData.holds) {
                    // Helper Dates
                    const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay()); 
                    const dayOfWeek = today.getDay();
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    const thisMonday = new Date(today); thisMonday.setDate(today.getDate() + diffToMonday);
                    const thisSunday = new Date(thisMonday); thisSunday.setDate(thisMonday.getDate() + 6);
                    const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                    const weekday2 = dayOfWeek === 0 ? 7 : dayOfWeek; 
                    const nextWeekStart = new Date(today); nextWeekStart.setDate(today.getDate() - weekday2 + 8);
                    const nextWeekEnd = new Date(nextWeekStart); nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                    const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const recentLookbackDate = new Date(firstDayCurrentMonth); recentLookbackDate.setDate(firstDayCurrentMonth.getDate() - 7);
                    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const nextMonthStartPipeline = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    const lookbackDate = new Date(today); lookbackDate.setMonth(today.getMonth() - 14);

                    baseData.holds.forEach(originalItem => {
                        const item = { ...originalItem };
                        
                        // IMPORTANT: Reconvert dates from localStorage strings back to Date objects
                        if (item.dateObj && !(item.dateObj instanceof Date)) {
                            item.dateObj = new Date(item.dateObj);
                        }
                        if (item.endDateObj && !(item.endDateObj instanceof Date)) {
                            item.endDateObj = new Date(item.endDateObj);
                        }
                        if (item.productEndDateObj && !(item.productEndDateObj instanceof Date)) {
                            item.productEndDateObj = new Date(item.productEndDateObj);
                        }
                        if (item.programEndDateObj && !(item.programEndDateObj instanceof Date)) {
                            item.programEndDateObj = new Date(item.programEndDateObj);
                        }
                        // Fallback: create dateObj from date string if missing
                        if (!item.dateObj && item.date) {
                            item.dateObj = new Date(item.date);
                        }
                        if (!item.endDateObj && item.endDate) {
                            item.endDateObj = new Date(item.endDate);
                        }
                        
                        // üëª GHOST FILTER: Skip ghosts from main views unless explicitly included
                        if (item.isGhost) {
                            categories.ghostBookings.push(item);
                            if (!includeGhosts) return; // Skip from other categories
                        }

                        // MODIFIED: Check composite key for extended manual overrides (includes product for uniqueness)
                        const uniqueKey = `${item.id}_${item.date}_${item.product || item.media}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            console.log('üìã Applying override for:', uniqueKey, override);
                            // Apply stage override
                            if (override.stage) {
                                console.log('  ‚Üí Stage override:', item.stage, '‚Üí', override.stage);
                                item.stage = override.stage;
                                item.isOverridden = true;
                                // Recalculate isComplete based on stage hierarchy
                                const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                                if (completedStages.includes(override.stage.toLowerCase())) {
                                    item.isComplete = true;
                                }
                            }
                            // Store previous stage for auto-stage reversal
                            if (override.previousStage) {
                                item.previousStage = override.previousStage;
                            }
                            // Apply adjusted quantity override (charted qty)
                            if (override.adjustedQty && override.adjustedQty > 0) {
                                item.adjustedQty = override.adjustedQty;
                                item.hasQtyAdjustment = true;
                                item.isOverridden = true;
                            }
                            // Apply installed count override
                            if (override.installed !== undefined) {
                                item.totalInstalled = override.installed;
                                item.installed = override.installed;
                                // Recalculate pending using adjustedQty if set, else original qty
                                const targetQty = item.adjustedQty || item.totalQty || item.quantity || 0;
                                item.pending = Math.max(0, targetQty - override.installed);
                                // Update progress
                                if (targetQty > 0) {
                                    const pct = Math.round((override.installed / targetQty) * 100);
                                    item.progress = `${override.installed}/${targetQty} (${pct}%)`;
                                }
                                item.isOverridden = true;
                            } else if (item.hasQtyAdjustment) {
                                // If only adjustedQty set (no installed override), recalculate pending
                                const installed = item.totalInstalled || item.installed || 0;
                                item.pending = Math.max(0, item.adjustedQty - installed);
                                if (item.adjustedQty > 0) {
                                    const pct = Math.round((installed / item.adjustedQty) * 100);
                                    item.progress = `${installed}/${item.adjustedQty} (${pct}%)`;
                                }
                            }
                            // Apply pending override (if explicitly set)
                            if (override.pending !== undefined) {
                                item.pending = override.pending;
                                item.isOverridden = true;
                            }
                            // Apply notes
                            if (override.notes) {
                                item.overrideNotes = override.notes;
                            }
                            // Apply production proof override
                            if (override.productionProof) {
                                item.productionProof = override.productionProof;
                                item.isOverridden = true;
                            }
                        }

                        // INJECT EMAIL STATS
                        item.emailSentCount = emailStats[uniqueKey] || 0;

                        const stageLower = (item.stage || '').toLowerCase().trim();
                        const advName = (item.rawName || item.name || '').toLowerCase();
                        const campId = (item.id || '').toLowerCase();

                        // Skip Lost Opportunities to separate list (includes -none- stage)
                        if (stageLower === 'lost opportunity' || stageLower === '- none -' || stageLower === '-none-') {
                             categories.lostOpportunities.push(item);
                             return;
                        }
                        
                        // Empty stage rows go to Ghost Bookings - needs attention
                        if (!stageLower || stageLower === '') {
                            item.isGhost = true;
                            item.ghostReason = 'No Stage';
                            item.stage = 'No Stage'; // Set display value
                            categories.ghostBookings.push(item);
                            return; // Skip from other operational views
                        }
                        
                        // Empty product rows go to Ghost Bookings - needs attention
                        const productValue = (item.product || item.media || '').trim();
                        if (!productValue) {
                            item.isGhost = true;
                            item.ghostReason = 'No Product';
                            categories.ghostBookings.push(item);
                            return; // Skip from other operational views
                        }

                        // --- PRIMARY LIST POPULATION ---
                        categories.all.push(item);
                        
                        // Active Installs: Only stages that are ACTIVELY being worked on
                        // Installed (partially done) or Material Ready (ready to install)
                        const isActiveWorkStage = ['installed', 'material ready for install'].includes(stageLower);
                        if (isActiveWorkStage && item.pending > 0) {
                            categories.activeInstalls.push(item); 
                        }
                        
                        // üìã HOLD REPORT: All campaigns (simplified version of Install Report)
                        categories.holdReport.push(item);
                        
                        // ‚è∏Ô∏è ON HOLD CAMPAIGNS: Specifically Pending Hold or On Hold stage
                        if (HOLD_STAGES.includes(stageLower)) {
                            categories.onHoldCampaigns.push(item);
                        }
                        
                        // 6-Month History
                        const sixMonthsAgo = new Date(today); sixMonthsAgo.setMonth(today.getMonth() - 6);
                        if (item.dateObj >= sixMonthsAgo && item.dateObj <= today) {
                            categories.sixMonthHistory.push(item);
                        }

                        // --- FULLY INSTALLED THIS WEEK ü•á ---
                        // Show campaigns with stage "Installed" that STARTED this week
                        // Uses Product Start Date only
                        if (stageLower === 'installed') {
                            const isWarnerPerms = advName.includes("warner bros. | perms | stap");
                            
                            if (!isWarnerPerms && item.dateObj >= startOfFormulaWeek && item.dateObj <= today) {
                                categories.fullyInstalledThisWeek.push(item);
                            }
                        }

                        // --- IN-PROGRESS FLIGHTS LOGIC üöÄ ---
                        // Material Ready + past start date = actively being installed
                        // Lookback: 4 weeks for reasonable visibility
                        const isFiller = advName.includes('filler');
                        const isMaterialReady = stageLower === 'material ready for install';
                        const hasStarted = item.dateObj <= today;
                        
                        const inProgressLookback = new Date(today);
                        inProgressLookback.setDate(today.getDate() - 28); // 4 weeks
                        const isWithinInProgressWindow = item.dateObj >= inProgressLookback;
                        
                        if (isMaterialReady && !isFiller && hasStarted && isWithinInProgressWindow) {
                            categories.inProgressFlights.push(item);
                        }
                        
                        // --- MATERIAL READY - FUTURE üì¶ ---
                        // Material Ready but start date is in the future (upcoming installs)
                        if (isMaterialReady && !isFiller && item.dateObj > today) {
                            categories.materialReadyFuture.push(item);
                        }
                        
                        // --- ROTATIONS LOGIC üîÅ ---
                        const isRotationAdvertiser = rotationKeywords.some(k => advName.includes(k));
                        
                        if (isRotationAdvertiser) {
                            if (item.dateObj >= startOfPostingWeek && item.dateObj <= endOfYear) {
                                categories.rotations.push(item);
                            }
                        }
                        
                        // --- DELAYED / AT RISK FLIGHTS üî• ---
                        // Shows campaigns that are past their start date but not completed
                        // Lookback: 3 weeks - balances visibility with manageable list size
                        const isExcludedDelay = advName.includes("warner bros. | perms") ||
                                                advName.includes("adriana's insurance") ||
                                                campId.includes("filler campaign") ||
                                                isFiller;
                        
                        const isCompletedStage = ['installed', 'photos taken', 'pop completed', 'takedown complete', 'canceled', 'lost opportunity'].includes(stageLower);
                        const isPastStartDate = item.dateObj < today;

                        // 7-day grace period - only consider delayed if 7+ days past start date
                        const gracePeriodDate = new Date(today);
                        gracePeriodDate.setDate(today.getDate() - 7);
                        const isPastGracePeriod = item.dateObj < gracePeriodDate;

                        // Lookback: 3 weeks (21 days) for delayed flights
                        const delayedLookback = new Date(today);
                        delayedLookback.setDate(today.getDate() - 21);
                        const isWithinDelayedWindow = item.dateObj >= delayedLookback;

                        if (!isExcludedDelay && !isCompletedStage && isPastGracePeriod && isWithinDelayedWindow) {
                            categories.delayedFlights.push(item);
                        }

                        // --- PAST DUE (all older backlog - everything older than 3 weeks) ---
                        // Non-overlapping with Delayed Flights (which covers last 3 weeks)
                        const isExcludedPastDue = advName.includes("filler") || campId.includes("filler campaign");
                        const isOlderThanDelayedWindow = item.dateObj < delayedLookback; // Older than 3 weeks, no upper limit
                        
                        if (!isExcludedPastDue && !isCompletedStage && isPastStartDate && isOlderThanDelayedWindow) {
                            categories.pastDue.push(item);
                        }

                        // --- STRICT EXPIRED LOGIC + DEDUPLICATION (RESTORED) ---
                        // Only show INSTALLED campaigns - these are the ones that need physical removal
                        // Filter: End Date in last 45 days AND stage is Installed/Photos Taken/POP Completed
                        const isInstalledStage = ['installed', 'photos taken', 'pop completed'].includes(stageLower);
                        
                        if (item.endDateObj && isInstalledStage) {
                            const compEndDate = new Date(item.endDateObj);
                            compEndDate.setHours(0,0,0,0);

                            if (compEndDate >= expiredStartCutoff && compEndDate <= currentMonday) {
                                // Deduplicate Key: ID + Start Date + End Date
                                const key = `${item.id}|${item.date}|${item.endDate}`;
                                
                                if (expiredMap.has(key)) {
                                    const entry = expiredMap.get(key);
                                    // Merge Quantities
                                    entry.quantity += (item.quantity || 0);
                                    entry.totalInstalled += (item.totalInstalled || 0);
                                    
                                    // Indicate mixed media if strictly different
                                    if (entry.media !== item.media && !entry.media.includes('Mixed')) {
                                        entry.media = 'Mixed Media / Various'; 
                                    }
                                } else {
                                    // Clone specific for this map to avoid polluting other lists
                                    expiredMap.set(key, { ...item });
                                }
                            }
                        }
                        // -------------------------------------

                        if (item.dateObj >= thisMonday && item.dateObj <= thisSunday) { categories.thisWeek.push(item); }
                        if (item.dateObj >= nextMonthStart && item.dateObj <= nextMonthEnd) { categories.nextMonth.push(item); }
                        
                        // UPCOMING
                        if (item.dateObj >= nextWeekStart && item.dateObj <= nextWeekEnd && item.stage && !stageLower.includes('canceled')) {
                            categories.upcoming.push(item);
                        }

                        // Recent Installs: Stage='Installed' with start date in last 30 days
                        if (stageLower === 'installed') {
                            const thirtyDaysAgo = new Date(today);
                            thirtyDaysAgo.setDate(today.getDate() - 30);
                            
                            // Filter by Product Start Date within last 30 days
                            if (item.dateObj >= thirtyDaysAgo && item.dateObj <= today) {
                                categories.recentInstalls.push(item);
                            }
                        }
                        
                        // PIPELINE SUMMARY: Count campaigns by stage for CURRENT MONTH only
                        // Timeline-based view of what's happening this month
                        // Excludes: Lost Opportunities (already filtered above)
                        if (item.dateObj >= currentMonthStart && item.dateObj < nextMonthStartPipeline) {
                            const s = item.stage || 'Unknown';
                            pipelineCounts[s] = (pipelineCounts[s] || 0) + 1;
                        }
                    });
                    
                    // Finalize Expired List from Map (RESTORED)
                    categories.expiredFlights = Array.from(expiredMap.values());
                    
                    // Build Pipeline Summary from all counted stages
                    categories.pipelineSummary = Object.entries(pipelineCounts)
                        .map(([stage, count]) => ({ stage, count }))
                        .sort((a, b) => b.count - a.count);
                }

                categories.pastDue.sort((a, b) => a.dateObj - b.dateObj);
                categories.recentInstalls.sort((a, b) => b.dateObj - a.dateObj); // Most recent start date first
                categories.masterTracking.sort((a,b) => b.dateObj - a.dateObj);
                categories.sixMonthHistory.sort((a,b) => b.dateObj - a.dateObj);
                categories.inProgressFlights.sort((a,b) => b.dateObj - a.dateObj);
                categories.delayedFlights.sort((a,b) => a.dateObj - b.dateObj);
                categories.fullyInstalledThisWeek.sort((a,b) => a.dateObj - b.dateObj);
                categories.rotations.sort((a,b) => a.dateObj - b.dateObj); 
                categories.expiredFlights.sort((a,b) => a.endDateObj - b.endDateObj); // Sort by End Date ascending
                categories.holdReport.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending
                categories.ghostBookings.sort((a,b) => a.dateObj - b.dateObj); // Sort ghosts by date
                categories.materialReadyFuture.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending
                categories.onHoldCampaigns.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending

                // üêõ DEBUG: Log stage values and installed filter results
                if (categories.all && categories.all.length > 0) {
                    const stageValues = {};
                    const installedItems = [];
                    const startOfWeekDebug = new Date(today);
                    startOfWeekDebug.setDate(today.getDate() - today.getDay());
                    startOfWeekDebug.setHours(0,0,0,0);

                    categories.all.forEach(item => {
                        const stage = (item.stage || 'EMPTY').trim();
                        stageValues[stage] = (stageValues[stage] || 0) + 1;

                        if (stage.toLowerCase() === 'installed') {
                            installedItems.push({
                                name: item.name?.substring(0, 30),
                                stage: item.stage,
                                date: item.date,
                                dateObj: item.dateObj,
                                inThisWeek: item.dateObj >= startOfWeekDebug && item.dateObj <= today
                            });
                        }
                    });

                    console.log('üêõ DEBUG: Stage Values in Data:', stageValues);
                    console.log('üêõ DEBUG: Items with "Installed" stage:', installedItems.length);
                    console.log('üêõ DEBUG: Week range:', startOfWeekDebug.toDateString(), 'to', today.toDateString());
                    if (installedItems.length > 0) {
                        console.log('üêõ DEBUG: First 5 Installed items:', installedItems.slice(0, 5));
                        console.log('üêõ DEBUG: Items in this week:', installedItems.filter(i => i.inThisWeek).length);
                    }
                    console.log('üêõ DEBUG: fullyInstalledThisWeek count:', categories.fullyInstalledThisWeek.length);
                }

                // 2. Master Tracking: Everything EXCEPT Lost Opportunities and Ghosts (unless included)
                if (baseData.installs) {
                    categories.masterTracking = [...baseData.installs]
                        .map(item => {
                            const newItem = { ...item };
                            // Reconvert dates from localStorage strings to Date objects
                            if (newItem.dateObj && !(newItem.dateObj instanceof Date)) {
                                newItem.dateObj = new Date(newItem.dateObj);
                            }
                            if (newItem.endDateObj && !(newItem.endDateObj instanceof Date)) {
                                newItem.endDateObj = new Date(newItem.endDateObj);
                            }
                            if (!newItem.dateObj && newItem.date) {
                                newItem.dateObj = new Date(newItem.date);
                            }

                            // APPLY MANUAL OVERRIDES (stage, installed count, etc.) - includes product for uniqueness
                            const uniqueKey = `${newItem.id}_${newItem.date}_${newItem.product || newItem.media}`;
                            const override = manualOverrides[uniqueKey];
                            if (override) {
                                if (override.stage) {
                                    newItem.stage = override.stage;
                                    newItem.isOverridden = true;
                                    // Recalculate isComplete based on stage hierarchy
                                    const completedStages = ['installed', 'photos taken', 'pop completed', 'takedown complete'];
                                    if (completedStages.includes(override.stage.toLowerCase())) {
                                        newItem.isComplete = true;
                                    }
                                }
                                if (override.adjustedQty && override.adjustedQty > 0) {
                                    newItem.adjustedQty = override.adjustedQty;
                                    newItem.hasQtyAdjustment = true;
                                    newItem.isOverridden = true;
                                }
                                if (override.installed !== undefined) {
                                    newItem.totalInstalled = override.installed;
                                    newItem.installed = override.installed;
                                    const targetQty = newItem.adjustedQty || newItem.totalQty || newItem.quantity || 0;
                                    newItem.pending = Math.max(0, targetQty - override.installed);
                                    newItem.isOverridden = true;
                                }
                                if (override.productionProof) {
                                    newItem.productionProof = override.productionProof;
                                    newItem.isOverridden = true;
                                }
                            }

                            return newItem;
                        })
                        .filter(i => {
                            // Exclude ghosts unless explicitly included
                            if (i.isGhost && !includeGhosts) return false;
                            // Exclude Lost Opportunities (includes -none- stage)
                            const stageLower = (i.stage || '').toLowerCase().trim();
                            if (stageLower === 'lost opportunity' || stageLower === '- none -' || stageLower === '-none-') return false;
                            return true;
                        });
                    // Ensure sorting consistency
                    categories.masterTracking.sort((a,b) => b.dateObj - a.dateObj);
                }

                return categories;
            }, [baseData, manualOverrides, emailStats, includeGhosts]);

            // Extract unique markets and products for filters
            const filterOptions = useMemo(() => {
                if (!processedData?.all) return { markets: [], products: [], marketGroups: MARKET_GROUPS, productGroups: PRODUCT_GROUPS };
                
                const marketSet = new Set();
                const productSet = new Set();
                
                processedData.all.forEach(item => {
                    if (item.market) marketSet.add(item.market);
                    if (item.product || item.media) productSet.add(item.product || item.media);
                });
                
                return {
                    markets: Array.from(marketSet).sort(),
                    products: Array.from(productSet).sort(),
                    marketGroups: MARKET_GROUPS,
                    productGroups: PRODUCT_GROUPS
                };
            }, [processedData]);
            
            // Handle adding/removing filter chips
            const addFilter = (type, value) => {
                if (type === 'market') {
                    if (!marketFilters.includes(value)) {
                        setMarketFilters(prev => [...prev, value]);
                    }
                } else {
                    if (!productFilters.includes(value)) {
                        setProductFilters(prev => [...prev, value]);
                    }
                }
            };
            
            const removeFilter = (type, value) => {
                if (type === 'market') {
                    setMarketFilters(prev => prev.filter(f => f !== value));
                } else {
                    setProductFilters(prev => prev.filter(f => f !== value));
                }
            };
            
            const clearAllFilters = () => {
                setMarketFilters([]);
                setProductFilters([]);
            };

            // Filtered stats for dashboard cards - waterfall effect
            const filteredStats = useMemo(() => {
                if (!processedData) return null;
                
                // If no filters active, return original processedData
                if (marketFilters.length === 0 && productFilters.length === 0 && productionFilter === 'ALL') {
                    return processedData;
                }
                
                // Helper: Check if item matches any selected market filter
                const itemMatchesMarket = (item) => {
                    if (marketFilters.length === 0) return true;
                    
                    return marketFilters.some(filter => {
                        // Check if filter is a group
                        if (MARKET_GROUPS[filter]) {
                            return MARKET_GROUPS[filter].some(city => 
                                item.market?.toLowerCase().includes(city.toLowerCase())
                            );
                        }
                        // Individual market match
                        return item.market === filter;
                    });
                };
                
                // Helper: Check if item matches any selected product filter
                const itemMatchesProduct = (item) => {
                    if (productFilters.length === 0) return true;
                    const itemProduct = item.product || item.media || '';
                    
                    return productFilters.some(filter => {
                        // Check if filter is a group
                        if (PRODUCT_GROUPS[filter]) {
                            return PRODUCT_GROUPS[filter].some(prod => 
                                itemProduct.toLowerCase().includes(prod.toLowerCase())
                            );
                        }
                        // Individual product match
                        return itemProduct === filter;
                    });
                };
                
                // Helper: Check if item matches production filter
                const itemMatchesProduction = (item) => {
                    if (productionFilter === 'ALL') return true;
                    if (productionFilter === 'unset') return !item.productionProof;
                    return item.productionProof === productionFilter;
                };
                
                // Helper function to filter an array
                const filterArray = (arr) => {
                    if (!arr || !Array.isArray(arr)) return arr;
                    return arr.filter(item => {
                        return itemMatchesMarket(item) && itemMatchesProduct(item) && itemMatchesProduction(item);
                    });
                };
                
                // Create filtered copy of all categories
                return {
                    ...processedData,
                    pastDue: filterArray(processedData.pastDue),
                    thisWeek: filterArray(processedData.thisWeek),
                    nextMonth: filterArray(processedData.nextMonth),
                    upcoming: filterArray(processedData.upcoming),
                    recentInstalls: filterArray(processedData.recentInstalls),
                    activeInstalls: filterArray(processedData.activeInstalls),
                    lostOpportunities: filterArray(processedData.lostOpportunities),
                    specialMedia: filterArray(processedData.specialMedia),
                    all: filterArray(processedData.all),
                    masterTracking: filterArray(processedData.masterTracking),
                    sixMonthHistory: filterArray(processedData.sixMonthHistory),
                    inProgressFlights: filterArray(processedData.inProgressFlights),
                    delayedFlights: filterArray(processedData.delayedFlights),
                    fullyInstalledThisWeek: filterArray(processedData.fullyInstalledThisWeek),
                    rotations: filterArray(processedData.rotations),
                    expiredFlights: filterArray(processedData.expiredFlights),
                    holdReport: filterArray(processedData.holdReport),
                    ghostBookings: filterArray(processedData.ghostBookings),
                    materialReadyFuture: filterArray(processedData.materialReadyFuture),
                    onHoldCampaigns: filterArray(processedData.onHoldCampaigns),
                    pipelineSummary: processedData.pipelineSummary // Keep pipeline summary as-is (it's aggregated)
                };
            }, [processedData, marketFilters, productFilters, productionFilter]);

            const filteredData = useMemo(() => {
                if (!filteredStats) return [];
                
                // Use view-specific data - filters are already applied via filteredStats
                let activeSet = [];
                if (view === 'master') { activeSet = filteredStats.masterTracking; } 
                else if (view === 'dashboard') { 
                    // Show recent activity: recent installs + this week + upcoming, sorted by date desc
                    const recentInstalls = filteredStats.recentInstalls || [];
                    const thisWeek = filteredStats.thisWeek || [];
                    const upcoming = filteredStats.upcoming || [];
                    const inProgress = filteredStats.inProgressFlights || [];
                    
                    // Combine and deduplicate by unique key (id + date)
                    const seen = new Set();
                    const combined = [];
                    [...recentInstalls, ...inProgress, ...thisWeek, ...upcoming].forEach(item => {
                        const key = `${item.id}_${item.date}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            combined.push(item);
                        }
                    });
                    
                    // Sort by date descending (most recent first)
                    activeSet = combined.sort((a, b) => {
                        const dateA = a.dateObj || new Date(a.date);
                        const dateB = b.dateObj || new Date(b.date);
                        return dateB - dateA;
                    }).slice(0, 100); // Limit to 100 most recent
                } 
                else if (view === 'pipelineSummary') { return filteredStats.pipelineSummary; } 
                else if (view === 'history') { activeSet = filteredStats.sixMonthHistory; }
                else if (view === 'lostOpportunities') { activeSet = filteredStats.lostOpportunities; }
                else if (view === 'specialMedia') { activeSet = filteredStats.specialMedia; }
                else if (view === 'inProgressFlights') { activeSet = filteredStats.inProgressFlights; }
                else if (view === 'delayedFlights') { activeSet = filteredStats.delayedFlights; }
                else if (view === 'fullyInstalledThisWeek') { activeSet = filteredStats.fullyInstalledThisWeek; }
                else if (view === 'currentWeekInstallCount') { activeSet = filteredStats.fullyInstalledThisWeek; }
                else if (view === 'rotations') { activeSet = filteredStats.rotations; }
                else if (view === 'expiredFlights') { activeSet = filteredStats.expiredFlights; }
                else if (view === 'holdReport') { activeSet = filteredStats.holdReport; }
                else if (view === 'onHoldCampaigns') { activeSet = filteredStats.onHoldCampaigns; }
                else if (view === 'ghostBookings') { activeSet = filteredStats.ghostBookings; }
                else if (view === 'materialReadyFuture') { activeSet = filteredStats.materialReadyFuture; }
                else if (view === 'pastDue') { activeSet = filteredStats.pastDue; }
                else if (view === 'recentInstalls') { activeSet = filteredStats.recentInstalls; }
                else if (view === 'activeInstalls') { activeSet = filteredStats.activeInstalls; }
                else if (view === 'upcoming') { activeSet = filteredStats.upcoming; }
                else if (view === 'thisWeek') { activeSet = filteredStats.thisWeek; }
                else if (view === 'nextMonth') { activeSet = filteredStats.nextMonth; }
                else if (view.startsWith('custom_')) {
                    // Custom widget view - apply the widget's filters
                    const widget = customWidgets.find(w => w.id === view);
                    if (widget) {
                        let filtered = [...(filteredStats.all || [])];
                        
                        if (widget.stages?.length > 0) {
                            filtered = filtered.filter(d => widget.stages.includes(d.stage));
                        }
                        if (widget.owners?.length > 0) {
                            filtered = filtered.filter(d => widget.owners.includes(d.owner));
                        }
                        if (widget.products?.length > 0) {
                            filtered = filtered.filter(d => widget.products.includes(d.product || d.media));
                        }
                        if (widget.installStatus === 'fully') {
                            filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                        } else if (widget.installStatus === 'partial') {
                            filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                        } else if (widget.installStatus === 'notStarted') {
                            filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                        }
                        
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        if (widget.dateLogic === 'startingNext7') {
                            const next7 = new Date(today);
                            next7.setDate(today.getDate() + 7);
                            filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                        } else if (widget.dateLogic === 'endingNext7') {
                            const next7 = new Date(today);
                            next7.setDate(today.getDate() + 7);
                            filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                        } else if (widget.dateLogic === 'longRunning') {
                            filtered = filtered.filter(d => {
                                if (!d.dateObj || !d.endDateObj) return false;
                                return (d.endDateObj - d.dateObj) / (1000*60*60*24) > 30;
                            });
                        }
                        
                        if (widget.volumeFilter === 'high50') {
                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                        } else if (widget.volumeFilter === 'low10') {
                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                        }
                        
                        activeSet = filtered;
                    } else {
                        activeSet = [];
                    }
                }
                else { activeSet = filteredStats[view] || []; }
                
                // 1. Text Search Filter
                let result = activeSet;
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    result = result.filter(item => 
                        item.name.toLowerCase().includes(lower) || 
                        item.advertiser.toLowerCase().includes(lower) || 
                        item.id.toLowerCase().includes(lower) ||
                        (item.stage || '').toLowerCase().includes(lower) ||
                        (item.product || item.media || '').toLowerCase().includes(lower)
                    );
                }

                // 2. Date Range Filter (Global)
                if (dateFilter.start || dateFilter.end) {
                    // Parse dates as LOCAL time (not UTC) by using yyyy/mm/dd format or manual parsing
                    const parseLocalDate = (dateStr) => {
                        if (!dateStr) return null;
                        // dateStr is "YYYY-MM-DD" from input type="date"
                        const [year, month, day] = dateStr.split('-').map(Number);
                        return new Date(year, month - 1, day, 0, 0, 0, 0); // Local midnight
                    };

                    const startDate = parseLocalDate(dateFilter.start);
                    const endDate = parseLocalDate(dateFilter.end);
                    // Set end date to end of day for inclusive comparison
                    if (endDate) endDate.setHours(23, 59, 59, 999);

                    // Determine which date to filter on (expired flights use End Date, others Start Date)
                    const keyToUse = view === 'expiredFlights' ? 'endDateObj' : 'dateObj';

                    result = result.filter(item => {
                        const itemDate = item[keyToUse];
                        if (!itemDate || isNaN(itemDate.getTime())) return false; // Skip invalid dates
                        if (startDate && itemDate < startDate) return false;
                        if (endDate && itemDate > endDate) return false;
                        return true;
                    });
                }

                // 3. Global Date Sort
                // Default logic: This week first? Or purely chronological?
                // User asked for "filter dates up or down" -> implying simple Asc/Desc toggle.
                // We will respect the 'dateSort' state ('asc' or 'desc')
                const keyToUse = view === 'expiredFlights' ? 'endDateObj' : 'dateObj';
                
                result.sort((a, b) => {
                    const dateA = a[keyToUse] || new Date(0);
                    const dateB = b[keyToUse] || new Date(0);
                    
                    if (dateSort === 'asc') {
                        return dateA - dateB;
                    } else {
                        return dateB - dateA;
                    }
                });

                return result;
            }, [filteredStats, view, searchTerm, dateFilter, dateSort, customWidgets]);

            const toggleSort = () => {
                setDateSort(prev => prev === 'asc' ? 'desc' : 'asc');
            };

            const clearDateFilters = () => {
                setDateFilter({ start: '', end: '' });
                setDateSort('asc');
                setMarketFilters([]);
                setProductFilters([]);
            };

            if (view === 'upload') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 md:p-6">
                        {/* üëª GHOST BOOKING ALERT MODAL */}
                        {showGhostAlert && ghostBookings.length > 0 && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
                                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-scale-in">
                                    <div className="px-6 py-4 bg-orange-500 text-white flex items-center gap-3">
                                        <Icon name="AlertTriangle" size={24} />
                                        <h3 className="font-bold text-lg">üëª Ghost Bookings Detected</h3>
                                    </div>
                                    <div className="p-6">
                                        <p className="text-gray-700 mb-4">
                                            <strong>{ghostBookings.length} bookings</strong> have no sales owner or no stage assigned.
                                            These need attention in Salesforce before being tracked.
                                        </p>
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4 max-h-40 overflow-y-auto">
                                            {ghostBookings.slice(0, 5).map((g, i) => (
                                                <div key={i} className="text-sm py-1 border-b border-orange-100 last:border-0 flex justify-between">
                                                    <span><span className="font-mono text-orange-700">{g.id}</span> - {g.advertiser}</span>
                                                    <span className="text-xs text-orange-500">{g.ghostReason || 'Unknown'}</span>
                                                </div>
                                            ))}
                                            {ghostBookings.length > 5 && (
                                                <div className="text-xs text-orange-600 pt-2">...and {ghostBookings.length - 5} more</div>
                                            )}
                                        </div>
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => { setShowGhostAlert(false); setView('ghostBookings'); }}
                                                className="flex-1 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition-colors"
                                            >
                                                Review Ghost Bookings
                                            </button>
                                            <button
                                                onClick={() => { setShowGhostAlert(false); setIncludeGhosts(false); }}
                                                className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors"
                                            >
                                                Exclude & Continue
                                            </button>
                                        </div>
                                        <button
                                            onClick={() => { setShowGhostAlert(false); setIncludeGhosts(true); }}
                                            className="w-full mt-2 py-2 text-sm text-gray-500 hover:text-gray-700"
                                        >
                                            Include anyway (not recommended)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="max-w-2xl w-full bg-white rounded-xl shadow-lg p-5 mb-4">
                            <div className="text-center mb-4">
                                {/* Added onClick and cursor-pointer to the H1 */}
                                <h1 
                                    onClick={handleSecretMode}
                                    className="text-2xl font-bold mb-1 text-gray-900 cursor-pointer select-none"
                                    title="v3.0 - Single Source of Truth - Click 5 times for Dev Mode"
                                >
                                    Los Angeles Ops<span className="bg-gradient-to-r from-pink-500 to-yellow-500 bg-clip-text text-transparent">Hub Vector Media</span>
                                </h1>
                                <p className="text-gray-500 text-sm">Dashboard & Master Tracking Portal</p>
                                <span className="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">
                                    v3.0
                                </span>
                            </div>

                            {/* --- LIVE SYNC & LOGOUT BUTTONS --- */}
                            <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
                                <div className="flex items-center justify-center gap-3 max-w-md mx-auto">
                                    <button
                                        onClick={handleLiveSync}
                                        disabled={processing}
                                        className={`flex-1 py-2.5 rounded-lg text-white font-bold flex items-center justify-center gap-2 transition-all shadow-sm ${processing ? 'bg-blue-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700'}`}
                                    >
                                        {processing ? <><Icon name="RefreshCw" size={18} className="animate-spin" /> Syncing...</> : <><Icon name="Cloud" size={18} /> Sync Live Data</>}
                                    </button>
                                    <button
                                        onClick={onLogout}
                                        className="px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-800 text-white font-bold flex items-center gap-2 transition-all shadow-sm"
                                        title="Logout"
                                    >
                                        <Icon name="LogOut" size={18} />
                                    </button>
                                </div>
                                <p className="text-xs text-blue-600 mt-1.5 text-center">Google Sheet ‚Üí Cached fallback</p>
                            </div>

                            {/* --- RESTORE PREVIOUS SESSION (if persisted data exists) --- */}
                            {baseData.holds?.length > 0 && (
                                <div className={`mb-4 p-3 rounded-lg border ${storageWarning ? 'bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200' : 'bg-gradient-to-r from-purple-50 to-indigo-50 border-purple-200'}`}>
                                    <div className="flex items-center justify-between gap-3">
                                        <div className="flex items-center gap-2 min-w-0">
                                            <div className={`p-1.5 rounded-lg flex-shrink-0 ${storageWarning ? 'bg-amber-100' : 'bg-purple-100'}`}>
                                                <Icon name={storageWarning ? "AlertTriangle" : "Database"} size={16} className={storageWarning ? 'text-amber-600' : 'text-purple-600'} />
                                            </div>
                                            <div className="min-w-0">
                                                <h4 className={`font-bold text-sm ${storageWarning ? 'text-amber-900' : 'text-purple-900'}`}>
                                                    {storageWarning ? 'Session (Limited)' : 'Previous Session'}
                                                </h4>
                                                <p className={`text-xs truncate ${storageWarning ? 'text-amber-600' : 'text-purple-600'}`}>
                                                    {baseData.holds.length.toLocaleString()} campaigns
                                                    {dataSource.timestamp && ` ‚Ä¢ ${new Date(dataSource.timestamp).toLocaleDateString()}`}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-1.5 flex-shrink-0">
                                            <button 
                                                onClick={() => {
                                                    setView('dashboard');
                                                    setDataSource(prev => ({ ...prev, type: 'persisted_csv', autoRestored: true }));
                                                }}
                                                className={`px-3 py-1.5 text-white rounded-lg font-bold text-xs transition-colors flex items-center gap-1.5 ${storageWarning ? 'bg-amber-600 hover:bg-amber-700' : 'bg-purple-600 hover:bg-purple-700'}`}
                                            >
                                                <Icon name="Play" size={12} /> Resume
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    if (confirm('Clear all cached data?')) {
                                                        handleResetData(true);
                                                    }
                                                }}
                                                className="p-1.5 bg-white text-red-500 border border-red-200 rounded-lg hover:bg-red-50 transition-colors"
                                                title="Clear cache"
                                            >
                                                <Icon name="Trash2" size={12} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- ‚úÑ DEBUG CONSOLE UI (Hidden by Default) --- */}
                            {showDebug && (
                                <div className="mb-4 border border-gray-800 bg-gray-900 rounded-lg overflow-hidden shadow-inner animate-fade-in">
                                    <div className="bg-gray-800 px-3 py-1.5 flex justify-between items-center border-b border-gray-700">
                                        <span className="text-xs font-mono text-gray-400 font-bold uppercase">Terminal</span>
                                        <button onClick={clearLogs} className="text-xs text-gray-500 hover:text-white">Clear</button>
                                    </div>
                                    <div className="p-3 h-24 overflow-y-auto font-mono text-xs space-y-0.5">
                                        {debugLogs.length === 0 ? (
                                            <span className="text-gray-600 italic">Waiting...</span>
                                        ) : (
                                            debugLogs.map((log, i) => (
                                                <div key={i} className={`${log.includes('ERROR') ? 'text-red-400' : log.includes('‚úÖ') ? 'text-green-400' : log.includes('üëª') ? 'text-orange-400' : 'text-gray-300'}`}>
                                                    {log}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* --- MANUAL UPLOAD SECTION (SINGLE FILE) --- */}
                            <div className="relative border-t border-gray-200 pt-4">
                                <span className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    Manual Upload
                                </span>
                                <div className="mb-3">
                                    <FileUploader 
                                        title="üìä Master Tracking Export" 
                                        onFileSelect={(f) => setFiles({ holds: f, install: f })} 
                                        status={files.holds ? 'done' : 'waiting'} 
                                    />
                                </div>
                                <button onClick={processData} disabled={!files.holds || processing} className="w-full py-2 rounded-lg bg-gray-800 text-white font-bold text-sm hover:bg-gray-900 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Process File <Icon name="ArrowRight" size={16} />
                                </button>
                            </div>
                            
                            {/* Footer with demo link and dedication */}
                            <div className="mt-4 pt-3 border-t border-gray-100 flex items-center justify-between">
                                <a href="/demo.html" className="text-xs font-medium text-gray-400 hover:text-gray-600 underline">Load Demo</a>
                                <p className="text-xs text-gray-400">Made with üíô for Charting</p>
                            </div>
                        </div>

                        <div className="max-w-2xl w-full grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-2"><WeatherWidget /></div>
                            <div><HolidaysWidget /></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex font-sans bg-gray-50 text-gray-900">
                    <Sidebar
                        view={view}
                        setView={setView}
                        onReset={handleResetData}
                        onOpenDigest={openDigestModal}
                        onResetEmailLogs={handleResetEmailLogs}
                        onOpenSheetSettings={() => setShowSheetSettings(true)}
                        onLogout={onLogout}
                        ghostCount={processedData?.ghostBookings?.length || 0}
                        isCollapsed={sidebarCollapsed}
                        setIsCollapsed={setSidebarCollapsed}
                    />
                    <DetailModal 
                        item={selectedItem} 
                        onClose={() => setSelectedItem(null)} 
                        onSave={handleUpdateStage} 
                        onLogEmail={handleLogEmail}
                    />
                    <GoogleSheetSettingsModal
                        isOpen={showSheetSettings}
                        onClose={() => setShowSheetSettings(false)}
                        currentSheetUrl={localStorage.getItem('stap_google_sheet_url') || ''}
                        onSave={(url) => {
                            addLog(`üîß Google Sheet URL updated`);
                        }}
                    />
                    <CustomizeModal 
                        isOpen={isCustomizeModalOpen} 
                        onClose={() => setIsCustomizeModalOpen(false)}
                        visibleKeys={visibleStatKeys}
                        onToggle={handleToggleStat}
                        onReset={handleResetStats}
                        cardConfig={STAT_CARD_CONFIG}
                        activeFilters={{ markets: marketFilters, products: productFilters }}
                        onClearFilters={clearAllFilters}
                        customWidgets={customWidgets}
                        onAddWidget={() => { setEditingWidget(null); setIsCustomWidgetModalOpen(true); }}
                        onEditWidget={(widget) => { setEditingWidget(widget); setIsCustomWidgetModalOpen(true); }}
                        onDeleteWidget={(id) => { if(confirm('Delete this widget?')) setCustomWidgets(prev => prev.filter(w => w.id !== id)); }}
                    />
                    {/* Digest Modal - Lazy loaded */}
                    {digestModalLoading && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 flex items-center gap-3">
                                <div className="animate-spin w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                                <span className="text-gray-700">Loading Daily Digest...</span>
                            </div>
                        </div>
                    )}
                    {digestModalLoaded && window.STAPDigestModal && (
                        <window.STAPDigestModal.DigestModal
                            isOpen={isDigestModalOpen}
                            onClose={() => setIsDigestModalOpen(false)}
                            processedData={processedData}
                            filterOptions={filterOptions}
                            currentMarket={marketFilters.length > 0 ? marketFilters[0] : 'Los Angeles, CA'}
                        />
                    )}
                    <CustomWidgetModal
                        isOpen={isCustomWidgetModalOpen}
                        onClose={() => { setIsCustomWidgetModalOpen(false); setEditingWidget(null); }}
                        onSave={(widget) => {
                            if (editingWidget) {
                                setCustomWidgets(prev => prev.map(w => w.id === widget.id ? widget : w));
                            } else {
                                setCustomWidgets(prev => [...prev, widget]);
                            }
                        }}
                        editWidget={editingWidget}
                        allData={processedData?.all || []}
                    />
                    
                    <div
                        className={`flex-1 flex flex-col transition-all duration-500 ease-in-out ${sidebarCollapsed ? 'main-content-collapsed' : 'main-content-expanded'}`}
                    >
                        <header className="bg-white border-b border-gray-200 px-8 py-4 flex flex-col sticky top-0 z-20 gap-3">
                            {/* Simplified header for Availability, Risk Analysis, and Impressions views */}
                            {(view === 'availability' || view === 'riskAnalysis' || view === 'impressions') ? (
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            {view === 'availability' ? (
                                                <>
                                                    <span className="p-1.5 rounded-lg border-2 border-teal-500 bg-teal-50">
                                                        <Icon name="BarChart3" size={18} className="text-teal-600" />
                                                    </span>
                                                    Availability Charting
                                                </>
                                            ) : view === 'impressions' ? (
                                                <>
                                                    <span className="p-1.5 rounded-lg border-2 border-purple-500 bg-purple-50">
                                                        <Icon name="Eye" size={18} className="text-purple-600" />
                                                    </span>
                                                    Impressions Dashboard
                                                </>
                                            ) : (
                                                <>
                                                    <span className="p-1.5 rounded-lg border-2 border-amber-500 bg-amber-50">
                                                        <Icon name="AlertTriangle" size={18} className="text-amber-600" />
                                                    </span>
                                                    Install Risk Center
                                                </>
                                            )}
                                        </h1>
                                        <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                            Use filters below
                                        </span>
                                    </div>
                                    <div className="relative w-64">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="Search" size={16} /></div>
                                        <input 
                                            type="text" 
                                            placeholder="Search campaigns..." 
                                            className="w-full pl-9 pr-4 py-1.5 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                </div>
                            ) : (
                            <>
                            {/* Top Row: Search + Filters */}
                            <div className="flex flex-col sm:flex-row items-center justify-between gap-3">
                                <div className="flex items-center gap-3 w-full max-w-md">
                                    <div className="relative w-full">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="Search" size={16} /></div>
                                        <input 
                                            type="text" 
                                            placeholder="Search..." 
                                            className="w-full pl-9 pr-4 py-1.5 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    {/* Filter count indicator */}
                                    {(marketFilters.length > 0 || productFilters.length > 0) && filteredStats && (
                                        <div className="flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-medium whitespace-nowrap">
                                            <Icon name="Filter" size={12} />
                                            <span>{filteredStats.all?.length || 0} results</span>
                                        </div>
                                    )}
                                    {/* Column Mapping Status */}
                                    {columnMappingInfo && (
                                        <div 
                                            className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap cursor-help ${
                                                columnMappingInfo.missingRequired.length > 0 
                                                    ? 'bg-amber-100 text-amber-700' 
                                                    : 'bg-green-100 text-green-700'
                                            }`}
                                            title={`Column Mapping: ${columnMappingInfo.matched}/${columnMappingInfo.total} matched\n\nMatched columns:\n${
                                                columnMappingInfo.mappingResults
                                                    .filter(r => r.found)
                                                    .map(r => `‚úì ${r.field} ‚Üí ${r.mappedTo}`)
                                                    .join('\n')
                                            }${columnMappingInfo.missingRequired.length > 0 ? '\n\nMissing required:\n' + columnMappingInfo.missingRequired.map(f => `‚úó ${f}`).join('\n') : ''}`}
                                        >
                                            <Icon name={columnMappingInfo.missingRequired.length > 0 ? "AlertTriangle" : "CheckCircle"} size={12} />
                                            <span>{columnMappingInfo.matched}/{columnMappingInfo.total} cols</span>
                                        </div>
                                    )}
                                    {/* Data Source Indicator */}
                                    {dataSource.type !== 'none' && (
                                        <div 
                                            className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap cursor-help ${
                                                storageWarning ? 'bg-red-100 text-red-700' :
                                                dataSource.type === 'google_sheet' ? 'bg-green-100 text-green-700' :
                                                dataSource.type === 'csv_upload' ? 'bg-blue-100 text-blue-700' :
                                                dataSource.type === 'persisted_csv' ? 'bg-amber-100 text-amber-700' :
                                                'bg-red-100 text-red-700'
                                            }`}
                                            title={`Data Source: ${
                                                dataSource.type === 'google_sheet' ? 'Live Google Sheet' :
                                                dataSource.type === 'csv_upload' ? 'CSV Upload' :
                                                dataSource.type === 'persisted_csv' ? 'Cached CSV (Fallback)' : 'Error'
                                            }\nLast sync: ${dataSource.timestamp ? new Date(dataSource.timestamp).toLocaleString() : 'N/A'}${
                                                dataSource.fallback ? '\n‚ö†Ô∏è Using fallback data - Google Sheet unavailable' : ''
                                            }${storageWarning ? '\n‚ö†Ô∏è ' + storageWarning : ''}${
                                                Object.keys(manualOverrides).length > 0 ? `\n‚úèÔ∏è ${Object.keys(manualOverrides).length} manual override(s) active` : ''
                                            }\n\nüìä ${processedData?.all?.length?.toLocaleString() || 0} total campaigns`}
                                        >
                                            <Icon name={
                                                storageWarning ? 'AlertTriangle' :
                                                dataSource.type === 'google_sheet' ? 'Wifi' :
                                                dataSource.type === 'csv_upload' ? 'FileSpreadsheet' :
                                                dataSource.type === 'persisted_csv' ? 'Database' : 'AlertCircle'
                                            } size={12} />
                                            <span>
                                                {storageWarning ? 'No Save' :
                                                 dataSource.type === 'google_sheet' ? 'Live' :
                                                 dataSource.type === 'csv_upload' ? 'CSV' :
                                                 dataSource.type === 'persisted_csv' ? 'Cached' : 'Error'}
                                            </span>
                                            {(dataSource.fallback || storageWarning) && <span className="text-amber-600">‚ö†</span>}
                                            {Object.keys(manualOverrides).length > 0 && (
                                                <span className="ml-1 px-1 bg-purple-200 text-purple-700 rounded text-[10px]">
                                                    +{Object.keys(manualOverrides).length}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* --- HEADER FILTERS --- */}
                                <div className="flex items-center gap-2 flex-wrap justify-end">
                                    {/* Market Filter Dropdown with Smart Groups */}
                                    <select 
                                        value=""
                                        onChange={(e) => {
                                            if (e.target.value) addFilter('market', e.target.value);
                                        }}
                                        className="text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100 border-gray-200"
                                        title="Add Market Filter"
                                    >
                                        <option value="">‚¨° Add Market</option>
                                        <optgroup label="üìç Regions">
                                            {Object.keys(MARKET_GROUPS).map(group => (
                                                <option key={group} value={group} disabled={marketFilters.includes(group)}>
                                                    {group}
                                                </option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="üìå Individual Markets">
                                            {filterOptions.markets.map(m => (
                                                <option key={m} value={m} disabled={marketFilters.includes(m)}>
                                                    {m.split(',')[0]}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                    
                                    {/* Product Filter Dropdown with Smart Groups */}
                                    <select 
                                        value=""
                                        onChange={(e) => {
                                            if (e.target.value) addFilter('product', e.target.value);
                                        }}
                                        className="text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100 border-gray-200"
                                        title="Add Product Filter"
                                    >
                                        <option value="">‚óà Add Product</option>
                                        <optgroup label="üì¶ Categories">
                                            {Object.keys(PRODUCT_GROUPS).map(group => (
                                                <option key={group} value={group} disabled={productFilters.includes(group)}>
                                                    {group}
                                                </option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="üìã Individual Products">
                                            {filterOptions.products.map(p => (
                                                <option key={p} value={p} disabled={productFilters.includes(p)}>
                                                    {p.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                    
                                    {/* Production Source Filter */}
                                    <select 
                                        value={productionFilter}
                                        onChange={(e) => setProductionFilter(e.target.value)}
                                        className={`text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-purple-500 ${
                                            productionFilter !== 'ALL' 
                                                ? 'bg-purple-100 border-purple-300 text-purple-700' 
                                                : 'bg-gray-100 border-gray-200'
                                        }`}
                                        title="Filter by Production Source"
                                    >
                                        <option value="ALL">‚åÇ Production: All</option>
                                        <option value="in-house">‚åÇ In-House Only</option>
                                        <option value="client">‚Üë Client Only</option>
                                        <option value="mixed">‚Üª Mixed Only</option>
                                        <option value="unset">? Not Set</option>
                                    </select>
                                    
                                    {/* Date Range */}
                                    <div className="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                                        <input 
                                            type="date" 
                                            className="bg-transparent text-xs font-medium text-gray-600 px-2 py-1 outline-none w-28"
                                            value={dateFilter.start}
                                            onChange={(e) => setDateFilter(prev => ({...prev, start: e.target.value}))}
                                            title="Start Date"
                                        />
                                        <span className="text-gray-400 text-xs">-</span>
                                        <input 
                                            type="date" 
                                            className="bg-transparent text-xs font-medium text-gray-600 px-2 py-1 outline-none w-28"
                                            value={dateFilter.end}
                                            onChange={(e) => setDateFilter(prev => ({...prev, end: e.target.value}))}
                                            title="End Date"
                                        />
                                    </div>
                                    
                                    {/* Sort Button */}
                                    <button 
                                        onClick={toggleSort} 
                                        className="p-1.5 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center justify-center"
                                        title={`Sort Dates ${dateSort === 'asc' ? 'Oldest to Newest' : 'Newest to Oldest'}`}
                                    >
                                        <Icon name={dateSort === 'asc' ? 'ArrowUp' : 'ArrowDown'} size={16} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* Filter Chips Bar */}
                            {(marketFilters.length > 0 || productFilters.length > 0 || productionFilter !== 'ALL' || dateFilter.start || dateFilter.end) && (
                                <div className="flex items-center gap-2 flex-wrap">
                                    <span className="text-xs text-gray-500 font-medium">Active Filters:</span>

                                    {/* Date Range Chip */}
                                    {(dateFilter.start || dateFilter.end) && (
                                        <span
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name="Calendar" size={12} />
                                            {dateFilter.start && dateFilter.end
                                                ? `${new Date(dateFilter.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(dateFilter.end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                                                : dateFilter.start
                                                    ? `From ${new Date(dateFilter.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                                                    : `Until ${new Date(dateFilter.end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                                            }
                                            <button
                                                onClick={() => setDateFilter({ start: '', end: '' })}
                                                className="ml-1 hover:bg-amber-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    )}

                                    {/* Market Chips */}
                                    {marketFilters.map(filter => (
                                        <span 
                                            key={`market-${filter}`}
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name="MapPin" size={12} />
                                            {filter}
                                            <button 
                                                onClick={() => removeFilter('market', filter)}
                                                className="ml-1 hover:bg-blue-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    ))}
                                    
                                    {/* Product Chips */}
                                    {productFilters.map(filter => (
                                        <span 
                                            key={`product-${filter}`}
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name="Package" size={12} />
                                            {filter.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                            <button 
                                                onClick={() => removeFilter('product', filter)}
                                                className="ml-1 hover:bg-purple-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    ))}
                                    
                                    {/* Production Filter Chip */}
                                    {productionFilter !== 'ALL' && (
                                        <span 
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name={productionFilter === 'in-house' ? 'Home' : productionFilter === 'client' ? 'Upload' : productionFilter === 'mixed' ? 'RefreshCw' : 'HelpCircle'} size={12} />
                                            {productionFilter === 'in-house' ? 'In-House' : productionFilter === 'client' ? 'Client' : productionFilter === 'mixed' ? 'Mixed' : 'Not Set'}
                                            <button 
                                                onClick={() => setProductionFilter('ALL')}
                                                className="ml-1 hover:bg-purple-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    )}
                                    
                                    {/* Clear All Button */}
                                    <button
                                        onClick={() => { clearAllFilters(); setProductionFilter('ALL'); setDateFilter({ start: '', end: '' }); }}
                                        className="text-xs text-red-600 hover:text-red-700 hover:underline font-medium"
                                    >
                                        Clear All
                                    </button>
                                </div>
                            )}
                            </>
                            )}
                        </header>

                        <main className="p-8 flex-1 overflow-y-auto">
                            {/* --- VIEW SWITCHER --- */}
                            {view === 'riskAnalysis' ? (
                                <InstallationRiskCommandCenter allData={processedData?.all || []} />
                            ) : view === 'availability' ? (
                                <AvailabilityComponent allData={processedData.all} />
                            ) : view === 'impressions' ? (
                                <ImpressionsDashboard
                                    campaignData={processedData?.all || []}
                                    proposalName="OOH Impressions Analysis"
                                    clientName=""
                                    showExport={true}
                                />
                            ) : (
                                <>
                                    {/* --- DASHBOARD VIEW --- */}
                                    {view === 'dashboard' && filteredStats && (
                                        <div>
                                            <div className="flex justify-between items-center mb-4">
                                                <h2 className="text-lg font-bold text-gray-800">Dashboard</h2>
                                                <div className="flex items-center gap-3">
                                                    {/* AI Pipeline Health Button */}
                                                    <button 
                                                        onClick={() => generatePipelineInsight(filteredStats.all)}
                                                        disabled={isInsightLoading}
                                                        className={`text-sm flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium transition-all ${isInsightLoading ? 'bg-gray-100 text-gray-400' : 'bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 hover:from-purple-200 hover:to-blue-200'}`}
                                                    >
                                                        <Icon name="Sparkles" size={16} className={isInsightLoading ? "animate-spin" : ""} />
                                                        {isInsightLoading ? "Analyzing..." : "AI Pipeline Insights"}
                                                    </button>
                                                    <button
                                                        onClick={() => exportToPDF('installations', filteredStats.all || [], {
                                                            title: 'Weekly Operations Summary',
                                                            subtitle: `${(filteredStats.all || []).length} Total Campaigns | ${new Date().toLocaleDateString()}`,
                                                            stats: {
                                                                'In Progress': (filteredStats.inProgressFlights || []).length,
                                                                'Upcoming': (filteredStats.upcoming || []).length,
                                                                'Installed': (filteredStats.fullyInstalledThisWeek || []).length,
                                                                'Delayed': (filteredStats.delayedFlights || []).length
                                                            },
                                                            filename: `Weekly_Summary_${new Date().toISOString().split('T')[0]}.pdf`
                                                        })}
                                                        className="text-sm flex items-center gap-2 text-red-600 hover:text-red-800 font-medium transition-colors bg-red-50 px-3 py-1.5 rounded-lg"
                                                    >
                                                        <Icon name="FileText" size={16} /> Export PDF
                                                    </button>
                                                    <button
                                                        onClick={() => setIsCustomizeModalOpen(true)}
                                                        className="text-sm flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium transition-colors"
                                                    >
                                                        <Icon name="Settings" size={16} /> Customize
                                                    </button>
                                                </div>
                                            </div>

                                            {/* AI Pipeline Insight Display - Executive Summary */}
                                            {pipelineInsight && (
                                                <div className="mb-6 p-5 bg-gradient-to-r from-purple-50 via-blue-50 to-indigo-50 border border-purple-200 rounded-xl relative shadow-sm">
                                                    <div className="flex items-start gap-4">
                                                        <div className="p-3 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl shadow-md text-white">
                                                            <Icon name="Sparkles" size={24} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <h4 className="text-base font-bold text-purple-900">Executive Briefing</h4>
                                                                <span className="text-xs bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full font-medium">AI-Generated</span>
                                                            </div>
                                                            <div className="text-sm text-gray-700 leading-relaxed whitespace-pre-line prose prose-sm max-w-none">
                                                                {pipelineInsight.split('\n').map((line, i) => {
                                                                    // Format bold text
                                                                    const formattedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                                                    // Check for bullet points or numbered lists
                                                                    if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-') || /^\d+\./.test(line.trim())) {
                                                                        return <p key={i} className="ml-4 my-1" dangerouslySetInnerHTML={{ __html: formattedLine }} />;
                                                                    }
                                                                    return <p key={i} className="my-1" dangerouslySetInnerHTML={{ __html: formattedLine }} />;
                                                                })}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => setPipelineInsight('')} className="text-gray-400 hover:text-gray-600 p-1">
                                                            <Icon name="X" size={18} />
                                                        </button>
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-purple-100 flex items-center justify-end">
                                                        <button 
                                                            onClick={() => generatePipelineInsight(filteredStats.all)}
                                                            className="text-xs text-purple-600 hover:text-purple-800 font-medium flex items-center gap-1"
                                                        >
                                                            <Icon name="RefreshCw" size={12} /> Refresh Analysis
                                                        </button>
                                                    </div>
                                                </div>
                                            )}

                                            <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Weekly Overview</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                                {/* Debug: Log what's being rendered */}
                                                {console.log('üéØ Dashboard rendering:', { 
                                                    visibleStatKeys, 
                                                    hasFilteredStats: !!filteredStats,
                                                    categories: filteredStats ? Object.keys(filteredStats).filter(k => Array.isArray(filteredStats[k]) && filteredStats[k].length > 0) : []
                                                })}
                                                {visibleStatKeys.map(key => {
                                                    const config = STAT_CARD_CONFIG[key];
                                                    let data = filteredStats[key];
                                                    
                                                    // Active Installs widget: limit to last 30 days
                                                    if (key === 'activeInstalls' && data) {
                                                        const today = new Date();
                                                        today.setHours(0,0,0,0);
                                                        const oneMonthAgo = new Date(today);
                                                        oneMonthAgo.setDate(today.getDate() - 30);
                                                        data = data.filter(i => i.dateObj >= oneMonthAgo);
                                                    }
                                                    
                                                    if (!config || !data) return null;
                                                    
                                                    // Installed widget: show sum of Qty (faces), not campaign count
                                                    let displayValue = data.length;
                                                    if (key === 'recentInstalls' && data) {
                                                        displayValue = data.reduce((sum, item) => sum + (item.quantity || item.totalQty || 0), 0);
                                                    }

                                                    // Current week install count: show campaign count this week
                                                    if (key === 'currentWeekInstallCount') {
                                                        const thisWeekData = filteredStats.fullyInstalledThisWeek || [];
                                                        displayValue = thisWeekData.length;
                                                        data = thisWeekData; // Use same data for click-through
                                                    }

                                                    return (
                                                        <StatCard 
                                                            key={key}
                                                            title={config.title} 
                                                            value={displayValue} 
                                                            subtitle={config.subtitle} 
                                                            color={config.color} 
                                                            icon={config.icon} 
                                                            onClick={() => setView(key)}
                                                        />
                                                    );
                                                })}
                                                
                                                {/* Custom Widgets */}
                                                {customWidgets.map(widget => {
                                                    // Calculate custom widget value
                                                    const getCustomWidgetData = () => {
                                                        let filtered = [...(filteredStats.all || [])];
                                                        
                                                        if (widget.stages?.length > 0) {
                                                            filtered = filtered.filter(d => widget.stages.includes(d.stage));
                                                        }
                                                        if (widget.owners?.length > 0) {
                                                            filtered = filtered.filter(d => widget.owners.includes(d.owner));
                                                        }
                                                        if (widget.products?.length > 0) {
                                                            filtered = filtered.filter(d => widget.products.includes(d.product || d.media));
                                                        }
                                                        if (widget.installStatus === 'fully') {
                                                            filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                                                        } else if (widget.installStatus === 'partial') {
                                                            filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                                                        } else if (widget.installStatus === 'notStarted') {
                                                            filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                                                        }
                                                        
                                                        const today = new Date();
                                                        today.setHours(0,0,0,0);
                                                        if (widget.dateLogic === 'startingNext7') {
                                                            const next7 = new Date(today);
                                                            next7.setDate(today.getDate() + 7);
                                                            filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                                                        } else if (widget.dateLogic === 'endingNext7') {
                                                            const next7 = new Date(today);
                                                            next7.setDate(today.getDate() + 7);
                                                            filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                                                        } else if (widget.dateLogic === 'longRunning') {
                                                            filtered = filtered.filter(d => {
                                                                if (!d.dateObj || !d.endDateObj) return false;
                                                                return (d.endDateObj - d.dateObj) / (1000*60*60*24) > 30;
                                                            });
                                                        }
                                                        
                                                        if (widget.volumeFilter === 'high50') {
                                                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                                                        } else if (widget.volumeFilter === 'low10') {
                                                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                                                        }
                                                        
                                                        return filtered;
                                                    };
                                                    
                                                    const widgetData = getCustomWidgetData();
                                                    let displayValue = widgetData.length;
                                                    if (widget.displayValue === 'qty') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.quantity || d.totalQty || 0), 0);
                                                    } else if (widget.displayValue === 'pending') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.pending || 0), 0);
                                                    } else if (widget.displayValue === 'installed') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.totalInstalled || d.installed || 0), 0);
                                                    }
                                                    
                                                    return (
                                                        <div key={widget.id} className="relative">
                                                            <StatCard 
                                                                title={widget.title} 
                                                                value={displayValue} 
                                                                subtitle={widget.subtitle} 
                                                                color={widget.color} 
                                                                icon={widget.icon} 
                                                                onClick={() => setView(widget.id)}
                                                            />
                                                            {/* Custom widget indicator */}
                                                            <div className="absolute top-2 right-2">
                                                                <span className="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium">Custom</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* Dashboard view: CampaignTable inside dashboard container for alignment */}
                                            <CampaignTable 
                                                data={filteredData} 
                                                title={(marketFilters.length > 0 || productFilters.length > 0) ? 'Filtered Results' : 'Recent Activity'}
                                                onRowClick={setSelectedItem}
                                                dateLabel="Start Date"
                                                dateKey="date"
                                                view={view}
                                                onBack={() => setView('dashboard')}
                                            />
                                        </div>
                                    )}

                                    {/* --- DATA TABLES (Non-Dashboard Views) --- */}
                                    {view !== 'dashboard' && (
                                    (view === 'master' || view === 'activeInstalls' || view === 'history') ? (
                                        <MasterTrackingTable 
                                            data={filteredData} 
                                            onRowClick={setSelectedItem}
                                            onBack={() => setView('dashboard')}
                                            onOpenSettings={() => setShowSheetSettings(true)}
                                        />
                                    ) : view === 'pipelineSummary' ? (
                                        <PipelineSummaryTable data={filteredData} />
                                    ) : view === 'holdReport' ? (
                                        <HoldReportTable data={filteredData} onRowClick={setSelectedItem} onBack={() => setView('dashboard')} />
                                    ) : view === 'ghostBookings' ? (
                                        <GhostBookingsTable data={filteredData} onRowClick={setSelectedItem} onBack={() => setView('dashboard')} />
                                    ) : view === 'materialReceivers' ? (
                                        <MaterialReceivers
                                            data={processedData.all}
                                            onBack={() => setView('dashboard')}
                                            setView={setView}
                                            setIsLiveMode={setIsLiveMode}
                                            materials={materialReceiverData}
                                            setMaterials={setMaterialReceiverData}
                                            linkedSheet={materialReceiverLinkedSheet}
                                            setLinkedSheet={setMaterialReceiverLinkedSheet}
                                        />
                                    ) : view === 'popGallery' ? (
                                        <POPGallery data={processedData.all} onBack={() => setView('dashboard')} setView={setView} />
                                    ) : view === 'performanceReport' ? (
                                        <PerformanceReport data={processedData.all} onBack={() => setView('dashboard')} setView={setView} />
                                    ) : (
                                        <CampaignTable 
                                            data={filteredData} 
                                            title={
                                                // Show view-specific title, add filter indicator if filters active
                                                view === 'dashboard' ? ((marketFilters.length > 0 || productFilters.length > 0) ? 'Filtered Results' : 'Recent Activity') :
                                                view === 'thisWeek' ? 'Scheduled This Week' :
                                                view === 'nextMonth' ? 'Scheduled Next Month' :
                                                view === 'upcoming' ? 'Upcoming (Next 7 Days)' :
                                                view === 'recentInstalls' ? 'Installed (Last 30 Days)' :
                                                view === 'activeInstalls' ? 'Active Installs (Last 30 Days)' :
                                                view === 'history' ? 'Install History (6 Months)' :
                                                view === 'lostOpportunities' ? 'Lost Opportunities' :
                                                view === 'specialMedia' ? 'Specialty Media Pipeline' :
                                                view === 'inProgressFlights' ? 'In-Progress Flights (Material Ready - Last 4 Weeks)' :
                                                view === 'delayedFlights' ? 'Delayed / Overdue (Last 3 Weeks)' :
                                                view === 'onHoldCampaigns' ? 'On Hold Campaigns' :
                                                view === 'fullyInstalledThisWeek' ? 'Installed This Week' :
                                                view === 'rotations' ? 'Rotations' :
                                                view === 'materialReadyFuture' ? 'Material Ready' :
                                                view === 'expiredFlights' ? `Expired Flights (${processedData.expiredRangeStart} - ${processedData.expiredRangeEnd})` :
                                                view === 'pastDue' ? 'Past Due (Older Backlog 3+ Weeks)' :
                                                view.startsWith('custom_') ? (customWidgets.find(w => w.id === view)?.title || 'Custom Widget') :
                                                'Campaigns'
                                            } 
                                            onRowClick={setSelectedItem}
                                            dateLabel={view === 'expiredFlights' ? "End Date" : "Start Date"}
                                            dateKey={view === 'expiredFlights' ? "endDate" : "date"}
                                            view={view}
                                            onBack={() => setView('dashboard')}
                                        />
                                    ))}
                                </>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        // --- MASTER APPLICATION WRAPPER ---
        const App = () => {
            // SESSION HYDRATION: Restore user from localStorage on mount
            const [user, setUser] = useState(() => {
                try {
                    const saved = localStorage.getItem('STAP_SESSION');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('‚úÖ Session restored for:', parsed.email);
                        return parsed;
                    }
                    return null;
                } catch {
                    return null;
                }
            });

            // Handle login - persist session to localStorage
            const handleLogin = (userData) => {
                setUser(userData);
                try {
                    localStorage.setItem('STAP_SESSION', JSON.stringify(userData));
                    console.log('‚úÖ Session saved for:', userData.email);
                } catch (e) {
                    console.warn('Could not save session to localStorage');
                }
            };

            // Handle logout - clear session from localStorage
            const handleLogout = () => {
                setUser(null);
                try {
                    localStorage.removeItem('STAP_SESSION');
                    console.log('‚úÖ Session cleared');
                } catch (e) {
                    console.warn('Could not clear session from localStorage');
                }
            };

            // If not authenticated, show the Ghost Login
            if (!user) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            // If authenticated, show the Dashboard
            return <AuthorizedDashboard onLogout={handleLogout} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>