

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA STAP Operations Portal - Secure</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tesseract.js for OCR (Text Recognition) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <!-- PDF.js for PDF parsing and rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Leaflet Map (FREE - OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Shared Base Styles */
        body { margin: 0; background-color: #f9fafb; font-family: 'Inter', sans-serif; overflow-x: hidden; } /* bg-gray-50 equivalent */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile fallback background when Three.js fails */
        .login-fallback-bg {
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
            position: absolute;
            inset: 0;
            z-index: -1;
        }
        .login-fallback-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        }
        
        /* --- LOGIN SPECIFIC STYLES --- */
        .ghost-panel {
            background: rgba(15, 23, 42, 0.15);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .ghost-panel:hover {
            background: rgba(15, 23, 42, 0.25);
            border-color: rgba(56, 189, 248, 0.2);
        }
        .input-ghost {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }
        .input-ghost:focus {
            border-bottom-color: #38bdf8;
            background: linear-gradient(to bottom, transparent, rgba(56, 189, 248, 0.05));
            outline: none;
        }
        .input-ghost::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        .btn-modern {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: #38bdf8;
            position: relative; overflow: hidden;
            transition: all 0.3s ease;
        }
        .btn-modern:hover {
            background: rgba(56, 189, 248, 0.2);
            border-color: #38bdf8;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
            color: white;
        }
        .animate-float { animation: float 8s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        /* --- DASHBOARD SPECIFIC ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        
        /* AI Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .ai-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f3f4f6 4%, #e5e7eb 25%, #f3f4f6 36%);
            background-size: 1000px 100%;
        }
        
        /* Sidebar responsive margin classes */
        @media (min-width: 768px) {
            .main-content-expanded { margin-left: 320px; }
            .main-content-collapsed { margin-left: 64px; }
        }
        
        /* Custom Scrollbar Styling for Tables */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Always show scrollbar for table containers with max-height */
        .max-h-\[600px\].overflow-y-auto,
        .max-h-\[500px\].overflow-y-auto,
        .max-h-\[400px\].overflow-y-auto,
        .max-h-\[350px\].overflow-y-auto,
        .max-h-\[300px\].overflow-y-auto,
        .max-h-96.overflow-y-auto {
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        // üîí SECURITY: Credentials
        const ACCESS_EMAIL = "admin@vectormedia.com";
        const ACCESS_PASSWORD = "secret123";

        // --- 3D "GRAND CHRONOS" SCENE (The Core Engine) ---
        const ChronosScene = ({ isHyperSpeed }) => {
            const mountRef = useRef(null);
            const targetRotationRef = useRef(0);
            const currentRotationRef = useRef(0);

            useEffect(() => {
                // 1. Setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color('#020617'); // Deep Slate
                scene.fog = new THREE.Fog('#020617', 15, 80);

                const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 42);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.1;
                
                // Safety check for mount
                if (mountRef.current) {
                    mountRef.current.appendChild(renderer.domElement);
                }

                // 2. Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                scene.add(ambientLight);
                const keyLight = new THREE.SpotLight(0x38bdf8, 4);
                keyLight.position.set(25, 25, 30);
                keyLight.castShadow = true;
                scene.add(keyLight);
                const fillLight = new THREE.PointLight(0x6366f1, 2);
                fillLight.position.set(-25, -10, 10);
                scene.add(fillLight);
                const rimLight = new THREE.DirectionalLight(0xffffff, 1.5);
                rimLight.position.set(0, 20, -10);
                scene.add(rimLight);

                // 3. Materials & Gears
                const matDarkMetal = new THREE.MeshStandardMaterial({ color: 0x0f172a, metalness: 0.8, roughness: 0.3 });
                const matChrome = new THREE.MeshStandardMaterial({ color: 0xe2e8f0, metalness: 1.0, roughness: 0.15 });
                const matAccent = new THREE.MeshStandardMaterial({ color: 0x0ea5e9, metalness: 0.7, roughness: 0.2, emissive: 0x0284c7, emissiveIntensity: 0.3 });

                const createGearRing = (radius, width, thickness, teethCount, material, toothHeight = 0.8) => {
                    const group = new THREE.Group();
                    const tubeGeo = new THREE.TorusGeometry(radius, width/2, 24, 120);
                    const ring = new THREE.Mesh(tubeGeo, material);
                    ring.castShadow = true; ring.receiveShadow = true;
                    group.add(ring);
                    const toothGeo = new THREE.BoxGeometry(width, thickness, toothHeight);
                    const teethMesh = new THREE.InstancedMesh(toothGeo, material, teethCount);
                    const dummy = new THREE.Object3D();
                    for(let i=0; i<teethCount; i++){
                        const angle = (i/teethCount) * Math.PI * 2;
                        const x = Math.cos(angle) * (radius + (width/4));
                        const y = Math.sin(angle) * (radius + (width/4));
                        dummy.position.set(x, y, 0);
                        dummy.rotation.z = angle;
                        dummy.rotation.x = Math.PI/2;
                        dummy.updateMatrix();
                        teethMesh.setMatrixAt(i, dummy.matrix);
                    }
                    teethMesh.castShadow = true; teethMesh.receiveShadow = true;
                    group.add(teethMesh);
                    return group;
                };

                const chronosGroup = new THREE.Group();
                scene.add(chronosGroup);
                chronosGroup.rotation.x = 0.25; chronosGroup.rotation.y = -0.15;

                const ring1 = createGearRing(22, 2.5, 1.5, 120, matDarkMetal, 1.5); ring1.position.z = -5; chronosGroup.add(ring1);
                const ring2 = createGearRing(16, 1.2, 1.0, 96, matChrome, 1.0); ring2.position.z = -1; chronosGroup.add(ring2);
                const ring3 = createGearRing(13.5, 1.0, 1.0, 80, matDarkMetal, 0.8); ring3.position.z = 1; chronosGroup.add(ring3);
                const ring4 = createGearRing(9, 1.5, 1.2, 48, matAccent, 1.2); ring4.position.z = 3.5; chronosGroup.add(ring4);

                // Interaction
                const onWheel = (e) => { targetRotationRef.current += e.deltaY * 0.001; };
                window.addEventListener('wheel', onWheel);
                let mouseX = 0, mouseY = 0;
                const onMove = (e) => { mouseX = (e.clientX - window.innerWidth/2) * 0.0005; mouseY = (e.clientY - window.innerHeight/2) * 0.0005; };
                document.addEventListener('mousemove', onMove);

                const animate = () => {
                    requestAnimationFrame(animate);
                    currentRotationRef.current += (targetRotationRef.current - currentRotationRef.current) * 0.05;
                    const t = currentRotationRef.current;
                    const time = Date.now() * 0.0002;

                    ring1.rotation.z = (t * 0.2) + (time * 0.1);
                    ring2.rotation.z = t + (time * 0.3);
                    ring3.rotation.z = -(t * 1.2) - (time * 0.3);
                    ring4.rotation.z = (t * 2.0) + (time * 0.8);
                    
                    chronosGroup.rotation.y = -0.15 + (mouseX * 0.8);
                    chronosGroup.rotation.x = 0.25 + (-mouseY * 0.8);

                    if(isHyperSpeed) { camera.position.z -= 0.5; ring4.rotation.z += 0.3; }
                    renderer.render(scene, camera);
                };
                animate();

                const onResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', onResize);

                return () => {
                    window.removeEventListener('resize', onResize);
                    window.removeEventListener('wheel', onWheel);
                    document.removeEventListener('mousemove', onMove);
                    if(mountRef.current) mountRef.current.innerHTML = '';
                };
            }, [isHyperSpeed]);

            return <div ref={mountRef} className="absolute inset-0 z-0" />;
        };

        // --- COMPONENT: LOGIN SCREEN (Ghost UI) ---
        const LoginScreen = ({ onLogin, onDemoMode }) => {
            const [email, setEmail] = useState('');
            const [code, setCode] = useState('');
            const [isLaunching, setIsLaunching] = useState(false);
            const [launchingDemo, setLaunchingDemo] = useState(false);
            const [launchingMobile, setLaunchingMobile] = useState(false);
            const [error, setError] = useState('');
            const [threeJsLoaded, setThreeJsLoaded] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            // Auto-detect mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            
            // Check if Three.js is available
            useEffect(() => {
                if (typeof THREE !== 'undefined') {
                    setThreeJsLoaded(true);
                }
            }, []);
            
            // Navigation to mobile app (only after auth)
            const goToMobileApp = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                setLaunchingMobile(true);
                setTimeout(() => {
                    const baseUrl = window.location.origin;
                    const mobileUrl = baseUrl + '/mobile.html';
                    window.location.replace(mobileUrl);
                }, 1500);
            };

            // Handle login form - just validates, doesn't launch yet
            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (email !== ACCESS_EMAIL || code !== ACCESS_PASSWORD) {
                    setError('Invalid Credentials');
                    return;
                }
                // Credentials valid - show app choice
                setIsAuthenticated(true);
            };
            
            // Launch desktop app
            const launchDesktop = () => {
                setIsLaunching(true);
                setTimeout(() => { onLogin({ email }); }, 1500);
            };
            
            const handleDemoClick = () => {
                setLaunchingDemo(true);
                setTimeout(() => { onDemoMode(); }, 1500);
            };
            
            const isAnimating = isLaunching || launchingDemo || launchingMobile;

            return (
                <div className="relative w-full h-screen overflow-hidden text-white bg-slate-900 font-sans">
                    {/* Fallback gradient background */}
                    <div className="login-fallback-bg"></div>
                    
                    {/* Three.js on desktop only */}
                    {threeJsLoaded && !isMobile && (
                        <ChronosScene isHyperSpeed={isAnimating} />
                    )}
                    
                    {/* Mobile animated background */}
                    {isMobile && (
                        <div className="absolute inset-0 overflow-hidden">
                            <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-sky-500/10 rounded-full blur-3xl animate-pulse"></div>
                            <div className="absolute bottom-1/4 right-1/4 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                        </div>
                    )}
                    
                    <div className="relative z-10 w-full h-full flex flex-col justify-between p-4 sm:p-8 md:p-12 pointer-events-none overflow-y-auto">
                        {/* Header */}
                        <div className={`flex justify-between items-start transition-opacity duration-500 ${isAnimating ? 'opacity-0' : 'opacity-100'}`}>
                            <div className="pointer-events-auto">
                                <h1 className="text-2xl sm:text-3xl font-extrabold tracking-tight text-white mb-1">VECTOR<span className="text-sky-400">MEDIA</span></h1>
                                <p className="text-xs sm:text-sm text-slate-400 font-medium tracking-widest uppercase">Operations Portal</p>
                            </div>
                        </div>
                        
                        {/* Main Panel */}
                        <div className={`flex justify-center items-center flex-1 py-4 transition-all duration-700 ${isAnimating ? 'scale-110 opacity-0' : 'scale-100 opacity-100'}`}>
                            <div className={`ghost-panel w-full max-w-[400px] p-6 sm:p-8 rounded-2xl pointer-events-auto ${isMobile ? '' : 'animate-float'}`}>
                                
                                {/* ===== AUTHENTICATED: Show Desktop/Mobile Choice ===== */}
                                {isAuthenticated ? (
                                    <>
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-green-500/20 flex items-center justify-center">
                                                <svg className="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <h2 className="text-xl font-bold text-white">Welcome Back</h2>
                                            <p className="text-slate-400 text-xs mt-1">Choose your experience</p>
                                        </div>
                                        
                                        {/* Desktop App Button */}
                                        <button 
                                            type="button"
                                            onClick={launchDesktop}
                                            className="mb-3 w-full py-4 rounded-xl font-bold text-sm uppercase tracking-widest transition-all
                                                bg-gradient-to-r from-sky-500 to-blue-600 
                                                text-white shadow-lg shadow-sky-500/30
                                                hover:shadow-sky-500/50 hover:scale-[1.02]
                                                flex items-center justify-center gap-3 active:scale-[0.98]
                                                cursor-pointer"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            <span>Desktop App</span>
                                        </button>
                                        
                                        {/* Mobile App Button */}
                                        <button 
                                            type="button"
                                            onClick={goToMobileApp}
                                            className="mb-4 w-full py-4 rounded-xl font-bold text-sm uppercase tracking-widest transition-all
                                                bg-gradient-to-r from-orange-500 to-amber-500 
                                                text-white shadow-lg shadow-orange-500/30
                                                hover:shadow-orange-500/50 hover:scale-[1.02]
                                                flex items-center justify-center gap-3 active:scale-[0.98]
                                                cursor-pointer"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                            </svg>
                                            <span>Mobile App</span>
                                        </button>
                                        
                                        {/* Back link */}
                                        <button 
                                            type="button"
                                            onClick={() => setIsAuthenticated(false)}
                                            className="w-full py-2 text-slate-500 text-xs hover:text-slate-300 transition-colors"
                                        >
                                            ‚Üê Back to login
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        {/* ===== NOT AUTHENTICATED: Show Login Form ===== */}
                                        <div className="text-center mb-6 sm:mb-8">
                                            <h2 className="text-2xl font-bold text-white mb-1">Identify</h2>
                                            <p className="text-slate-400 text-xs tracking-wide">Scroll to wind mechanism.</p>
                                        </div>
                                        
                                        <form onSubmit={handleSubmit} className="space-y-4 sm:space-y-6">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Operative Email</label>
                                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full input-ghost py-2 text-sm" placeholder="admin@vectormedia.com" required />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Password</label>
                                                <input type="password" value={code} onChange={e => setCode(e.target.value)} className="w-full input-ghost py-2 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                                            </div>
                                            {error && <div className="text-red-400 text-xs font-bold text-center pt-2">{error}</div>}
                                            <button type="submit" className="w-full btn-modern py-3 rounded-lg font-bold text-xs uppercase tracking-widest mt-4">Authenticate</button>
                                        </form>
                                        
                                        {/* Demo Version Divider */}
                                        <div className="flex items-center gap-3 mt-6 mb-4">
                                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                                            <span className="text-[10px] text-slate-500 uppercase tracking-widest">or</span>
                                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                                        </div>
                                        
                                        {/* Demo Version Button */}
                                        <button 
                                            type="button"
                                            onClick={handleDemoClick}
                                            className="w-full py-3 rounded-lg font-bold text-xs uppercase tracking-widest transition-all
                                                bg-gradient-to-r from-purple-500/20 to-indigo-500/20 
                                                border border-purple-400/30 text-purple-300
                                                hover:from-purple-500/30 hover:to-indigo-500/30 
                                                hover:border-purple-400/50 hover:text-purple-200
                                                hover:shadow-[0_0_20px_rgba(168,85,247,0.3)]
                                                flex items-center justify-center gap-2"
                                        >
                                            <span>üéì</span>
                                            <span>Demo Version</span>
                                            <span className="text-[9px] opacity-70">(with guides)</span>
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        {/* Bottom padding for mobile safe area */}
                        <div className="h-4 sm:h-0"></div>
                    </div>
                </div>
            );
        };

        // --- DATE UTILITIES (Required for Availability Chart) ---
        const getDatesInRange = (startDate, endDate) => {
            const date = new Date(startDate);
            const dates = [];
            while (date <= endDate) {
                dates.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return dates;
        };

        const isDateInRange = (checkDate, start, end) => {
            const d = new Date(checkDate).setHours(0,0,0,0);
            const s = new Date(start).setHours(0,0,0,0);
            const e = new Date(end).setHours(0,0,0,0);
            return d >= s && d <= e;
        };

        // Check if date is start of posting week (Monday = 1)
        const isPostingDay = (date) => date.getDay() === 1;

        // --- REAL AI AGENT (DIRECT CALL FOR INTERNAL USE ONLY) ---
        // =============================================
        // GROQ API CONFIGURATION (Llama 3.3 70B)
        // =============================================
        // API key stored in localStorage - configure via Settings modal (triple-click logo)
        const getGroqApiKey = () => localStorage.getItem('stap_groq_api_key') || '';

        const callGroq = async (prompt, maxTokens = 1024) => {
            const GROQ_API_KEY = getGroqApiKey();
            if (!GROQ_API_KEY) {
                return "‚ö†Ô∏è Configuration Error: Please add your Groq API Key in Settings (triple-click logo).";
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { 
                                role: "system", 
                                content: "You are an expert operations analyst for an out-of-home advertising company. Provide concise, actionable insights using bullet points and specific numbers. Be direct and executive-level in your communication."
                            },
                            { role: "user", content: prompt }
                        ],
                        max_tokens: maxTokens,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices?.[0]?.message?.content || "Error: No response generated.";

            } catch (error) {
                console.error("Groq AI Failed:", error);
                return `Analysis Failed: ${error.message}. Please check your API Key and connection.`;
            }
        };

        // =============================================
        // LIVE WEATHER API (Open-Meteo - Free, No Key)
        // =============================================
        const MARKET_COORDINATES = {
            'Los Angeles, CA': { lat: 34.05, lon: -118.24 },
            'Dallas, TX': { lat: 32.78, lon: -96.80 },
            'Miami, FL': { lat: 25.76, lon: -80.19 },
            'Chicago, IL': { lat: 41.88, lon: -87.63 },
            'Boston, MA': { lat: 42.36, lon: -71.06 },
            'New York, NY': { lat: 40.71, lon: -74.01 },
            'Seattle, WA': { lat: 47.61, lon: -122.33 },
            'San Francisco, CA': { lat: 37.77, lon: -122.42 },
            'Orlando, FL': { lat: 28.54, lon: -81.38 },
            'Las Vegas, NV': { lat: 36.17, lon: -115.14 },
            'Baltimore, MD': { lat: 39.29, lon: -76.61 },
            'Philadelphia, PA': { lat: 39.95, lon: -75.17 },
            'Washington D.C., DC': { lat: 38.91, lon: -77.04 }
        };

        const fetchLiveWeather = async (market) => {
            // Find coordinates for market (fuzzy match)
            const marketKey = Object.keys(MARKET_COORDINATES).find(k => 
                market?.toLowerCase().includes(k.split(',')[0].toLowerCase())
            ) || 'Los Angeles, CA';
            
            const coords = MARKET_COORDINATES[marketKey];
            
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&daily=temperature_2m_max,precipitation_probability_max,weathercode&timezone=auto&forecast_days=7`
                );
                
                if (!response.ok) throw new Error('Weather API failed');
                
                const data = await response.json();
                
                // Map weather codes to conditions and icons
                const weatherCodeMap = {
                    0: { condition: 'Clear', icon: 'Sun' },
                    1: { condition: 'Mostly Clear', icon: 'Sun' },
                    2: { condition: 'Partly Cloudy', icon: 'Cloud' },
                    3: { condition: 'Overcast', icon: 'Cloud' },
                    45: { condition: 'Foggy', icon: 'Cloud' },
                    48: { condition: 'Icy Fog', icon: 'Cloud' },
                    51: { condition: 'Light Drizzle', icon: 'CloudRain' },
                    53: { condition: 'Drizzle', icon: 'CloudRain' },
                    55: { condition: 'Heavy Drizzle', icon: 'CloudRain' },
                    61: { condition: 'Light Rain', icon: 'CloudRain' },
                    63: { condition: 'Rain', icon: 'CloudRain' },
                    65: { condition: 'Heavy Rain', icon: 'CloudRain' },
                    71: { condition: 'Light Snow', icon: 'Snowflake' },
                    73: { condition: 'Snow', icon: 'Snowflake' },
                    75: { condition: 'Heavy Snow', icon: 'Snowflake' },
                    80: { condition: 'Rain Showers', icon: 'CloudRain' },
                    81: { condition: 'Moderate Showers', icon: 'CloudRain' },
                    82: { condition: 'Heavy Showers', icon: 'CloudRain' },
                    95: { condition: 'Thunderstorm', icon: 'CloudLightning' },
                    96: { condition: 'Thunderstorm w/ Hail', icon: 'CloudLightning' },
                    99: { condition: 'Severe Thunderstorm', icon: 'CloudLightning' }
                };

                return data.daily.time.map((date, i) => {
                    const code = data.daily.weathercode[i];
                    const weather = weatherCodeMap[code] || { condition: 'Unknown', icon: 'Cloud' };
                    // Fix timezone issue: append T12:00:00 to avoid UTC midnight shifting the day
                    const dayName = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                    return {
                        day: dayName,
                        date: date,
                        temp: Math.round(data.daily.temperature_2m_max[i]),
                        rainChance: data.daily.precipitation_probability_max[i] || 0,
                        condition: weather.condition,
                        icon: weather.icon
                    };
                });
            } catch (error) {
                console.error('Weather fetch failed:', error);
                // Return fallback static data
                return [
                    { day: 'Today', temp: 72, rainChance: 10, condition: 'Clear', icon: 'Sun' },
                    { day: 'Tue', temp: 74, rainChance: 5, condition: 'Sunny', icon: 'Sun' },
                    { day: 'Wed', temp: 71, rainChance: 15, condition: 'Partly Cloudy', icon: 'Cloud' },
                    { day: 'Thu', temp: 68, rainChance: 30, condition: 'Cloudy', icon: 'Cloud' },
                    { day: 'Fri', temp: 70, rainChance: 20, condition: 'Partly Cloudy', icon: 'Cloud' }
                ];
            }
        };

        // Legacy wrapper for backward compatibility
        const callGemini = async (prompt) => {
            return await callGroq(prompt);
        };

        // --- ICONS MAPPING ---
        const ICON_MAP = {
            UploadCloud: 'upload-cloud',
            FileText: 'file-text',
            AlertTriangle: 'alert-triangle',
            CheckCircle: 'check-circle',
            Clock: 'clock',
            Search: 'search',
            LayoutDashboard: 'layout-dashboard',
            Calendar: 'calendar',
            Menu: 'menu',
            X: 'x',
            ArrowRight: 'arrow-right',
            ArrowLeft: 'arrow-left',
            RefreshCw: 'refresh-cw',
            Layers: 'layers',
            Download: 'download',
            Hammer: 'hammer',
            Sun: 'sun',
            Cloud: 'cloud',
            CloudRain: 'cloud-rain',
            Wind: 'wind',
            CheckSquare: 'check-square',
            BarChart: 'bar-chart-2',
            History: 'history',
            Edit: 'edit-2',
            Save: 'save',
            XCircle: 'x-circle',
            Megaphone: 'megaphone',
            Rocket: 'rocket',
            Flame: 'flame',
            Medal: 'medal',
            Repeat: 'repeat',
            Lightbulb: 'lightbulb',
            Settings: 'settings',
            Eye: 'eye',
            EyeOff: 'eye-off',
            Play: 'play-circle',
            Gift: 'gift',
            Sparkles: 'sparkles',
            Bot: 'bot',
            Mail: 'mail',
            Filter: 'filter',
            ArrowUp: 'arrow-up',
            ArrowDown: 'arrow-down',
            ChevronDown: 'chevron-down',
            ChevronUp: 'chevron-up',
            ChevronLeft: 'chevron-left',
            ChevronRight: 'chevron-right',
            Copy: 'copy',
            Send: 'send',
            Sliders: 'sliders',
            AlertOctagon: 'alert-octagon', 
            Info: 'info', 
            CloudFog: 'cloud-fog', 
            MapPin: 'map-pin', 
            ShieldAlert: 'shield-alert',
            TrendingUp: 'trending-up',
            TrendingDown: 'trending-down',
            List: 'list',
            Wifi: 'wifi',
            CloudLightning: 'cloud-lightning',
            Snowflake: 'snowflake',
            Target: 'target',
            AlertCircle: 'alert-circle',
            // NEW: Added for sidebar icons
            Pause: 'pause',
            Archive: 'archive',
            Package: 'package',
            Box: 'box',
            Inbox: 'inbox',
            Truck: 'truck',
            PackageCheck: 'package-check',
            Warehouse: 'warehouse',
            PauseCircle: 'pause-circle',
            StopCircle: 'stop-circle',
            CirclePause: 'circle-pause',
            Hand: 'hand',
            Columns: 'columns',
            Layout: 'layout',
            Edit3: 'edit-3',
            Plus: 'plus',
            Minimize2: 'minimize-2',
            Maximize2: 'maximize-2',
            Ghost: 'ghost',
            ClipboardList: 'clipboard-list',
            // NEW: Additional icons for custom widgets
            Star: 'star',
            Heart: 'heart',
            Zap: 'zap',
            Activity: 'activity',
            Users: 'users',
            User: 'user',
            DollarSign: 'dollar-sign',
            Percent: 'percent',
            PieChart: 'pie-chart',
            LineChart: 'line-chart',
            Briefcase: 'briefcase',
            Building: 'building-2',
            Home: 'home',
            Flag: 'flag',
            Bookmark: 'bookmark',
            Bell: 'bell',
            Coffee: 'coffee',
            Compass: 'compass',
            Crosshair: 'crosshair',
            Crown: 'crown',
            Database: 'database',
            FileCheck: 'file-check',
            Folder: 'folder',
            FolderOpen: 'folder-open',
            Globe: 'globe',
            Hash: 'hash',
            HelpCircle: 'help-circle',
            Image: 'image',
            Key: 'key',
            Link: 'link',
            Lock: 'lock',
            Unlock: 'unlock',
            MessageSquare: 'message-square',
            Monitor: 'monitor',
            Moon: 'moon',
            Music: 'music',
            Navigation: 'navigation',
            Paperclip: 'paperclip',
            Phone: 'phone',
            Printer: 'printer',
            Radio: 'radio',
            Shield: 'shield',
            ShoppingCart: 'shopping-cart',
            Smile: 'smile',
            Speaker: 'speaker',
            Square: 'square',
            Tag: 'tag',
            Terminal: 'terminal',
            ThumbsUp: 'thumbs-up',
            ThumbsDown: 'thumbs-down',
            Timer: 'timer',
            Tool: 'tool',
            Trash: 'trash-2',
            Umbrella: 'umbrella',
            Video: 'video',
            Volume: 'volume-2',
            Watch: 'watch',
            Wrench: 'wrench',
            Award: 'award',
            Battery: 'battery',
            BatteryCharging: 'battery-charging',
            Bluetooth: 'bluetooth',
            Camera: 'camera',
            Cast: 'cast',
            Circle: 'circle',
            Clipboard: 'clipboard',
            CloudOff: 'cloud-off',
            Code: 'code',
            Cpu: 'cpu',
            CreditCard: 'credit-card',
            Disc: 'disc',
            Dribbble: 'dribbble',
            Droplet: 'droplet',
            ExternalLink: 'external-link',
            Feather: 'feather',
            Film: 'film',
            Gitlab: 'gitlab',
            Grid: 'grid',
            Headphones: 'headphones',
            Map: 'map',
            Mic: 'mic',
            MinusCircle: 'minus-circle',
            MoreHorizontal: 'more-horizontal',
            Move: 'move',
            Octagon: 'octagon',
            PenTool: 'pen-tool',
            Power: 'power',
            Server: 'server',
            Sidebar: 'sidebar',
            Slash: 'slash',
            Stopwatch: 'stopwatch',
            Sunrise: 'sunrise',
            Sunset: 'sunset',
            Tablet: 'tablet',
            Thermometer: 'thermometer',
            ToggleLeft: 'toggle-left',
            ToggleRight: 'toggle-right',
            Trending: 'trending-up',
            Triangle: 'triangle',
            Type: 'type',
            Upload: 'upload',
            UserCheck: 'user-check',
            UserMinus: 'user-minus',
            UserPlus: 'user-plus',
            VolumeX: 'volume-x',
            WifiOff: 'wifi-off',
            ZoomIn: 'zoom-in',
            ZoomOut: 'zoom-out',
            // NEW: PDF Report icons
            LayoutTemplate: 'layout',
            BarChart3: 'bar-chart-3',
            Table: 'table',
            Table2: 'table-2',
            FileSpreadsheet: 'file-spreadsheet',
            // NEW: Photo analysis icons
            Scan: 'scan',
            ScanLine: 'scan-line',
            FileSearch: 'file-search',
            Maximize: 'maximize',
            Loader: 'loader',
            ScanEye: 'scan-eye'
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const iconName = ICON_MAP[name] || 'circle';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', iconName);
                ref.current.appendChild(i);
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons({
                        root: ref.current,
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);

            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };
        
        // Production Source Icon Component - Clean outlined icons instead of emojis
        const ProductionIcon = ({ type, size = 14, showLabel = false, compact = false }) => {
            const config = {
                'in-house': { 
                    icon: 'Home', 
                    color: 'text-purple-600', 
                    bg: 'bg-purple-100',
                    border: 'border-purple-300',
                    label: 'In-House'
                },
                'client': { 
                    icon: 'Upload', 
                    color: 'text-blue-600', 
                    bg: 'bg-blue-100',
                    border: 'border-blue-300',
                    label: 'Client'
                },
                'mixed': { 
                    icon: 'RefreshCw', 
                    color: 'text-amber-600', 
                    bg: 'bg-amber-100',
                    border: 'border-amber-300',
                    label: 'Mixed'
                },
                'unset': { 
                    icon: 'HelpCircle', 
                    color: 'text-gray-400', 
                    bg: 'bg-gray-100',
                    border: 'border-gray-300',
                    label: 'Not Set'
                }
            };
            
            const c = config[type] || config['unset'];
            
            if (compact) {
                return (
                    <span className={`${c.color}`} title={c.label}>
                        <Icon name={c.icon} size={size} />
                    </span>
                );
            }
            
            if (showLabel) {
                return (
                    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${c.bg} ${c.color} border ${c.border}`}>
                        <Icon name={c.icon} size={size} />
                        {c.label}
                    </span>
                );
            }
            
            return (
                <span className={`inline-flex items-center justify-center p-1 rounded ${c.bg} ${c.color}`} title={c.label}>
                    <Icon name={c.icon} size={size} />
                </span>
            );
        };

        // ============================================
        // ============================================
        // DEMO TIPS & GUIDE COMPONENTS
        // These are loaded from external demo.js file when needed
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Placeholder components - will be replaced by demo.js if loaded
        const DemoTip = window.STAPDemo?.DemoTip || (() => null);
        const FeatureBadge = window.STAPDemo?.FeatureBadge || (() => null);
        const DemoWelcomeModal = window.STAPDemo?.DemoWelcomeModal || (() => null);
        const DemoGuidePanel = window.STAPDemo?.DemoGuidePanel || (() => null);
        const generateMockData = window.STAPDemo?.generateMockData || (() => ({ holds: [], installs: [] }));
        const getDemoMaterials = window.STAPDemo?.getDemoMaterials || (() => []);

        // --- EMAIL DIGEST GENERATION LOGIC ---
        
        const generateDigestHtml = (processedData, weatherForecast, settings) => {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Font size based on compact mode
            const fontSize = settings.compactMode ? '10px' : '12px';
            const headerSize = settings.compactMode ? '11px' : '13px';
            const padding = settings.compactMode ? '4px 6px' : '8px 10px';
            
            // --- Helper: Create Table Row ---
            const createHtmlTable = (data, headers, columnWidths, rowMapper) => {
                if (!data || data.length === 0) {
                    return "<p style='font-style: italic; color: #666;'>No flights are currently in this category.</p>";
                }
                let table = `<table class="data-table" style="font-size: ${fontSize};"><tr>`;
                headers.forEach((header, index) => {
                    const widthAttr = columnWidths[index] ? ` width="${columnWidths[index]}"` : '';
                    table += `<th${widthAttr} style="font-size: ${headerSize}; padding: ${padding};">${header}</th>`;
                });
                table += '</tr>';
                data.forEach(item => {
                    const rowValues = rowMapper(item);
                    table += '<tr>';
                    rowValues.forEach(val => {
                        table += `<td style="padding: ${padding};">${val || ''}</td>`;
                    });
                    table += '</tr>';
                });
                return table + '</table>';
            };

            // --- Helper: Weather HTML (UPDATED FOR COLOR) ---
            const getWeatherHtml = () => {
                const days = weatherForecast.slice(0, 4); // First 4 days
                let html = '<table border="0" cellpadding="0" cellspacing="0" style="width: 100%; border-collapse: collapse;"><tbody><tr>';
                days.forEach((day, i) => {
                    const dayName = i === 0 ? "Today" : day.day;
                    const iconEmoji = day.icon === 'Sun' ? '&#9728;' : day.icon === 'Cloud' ? '&#9729;' : '&#127783;';
                    html += `
                        <td style="width: 25%; text-align: center; padding: 0 2px; vertical-align: top;">
                            <h4 style="margin: 0; font-size: 10px; color: #ffffff; font-family: sans-serif; font-weight: bold; padding-bottom: 2px;">${dayName}</h4>
                            <p style="font-size: 20px; line-height: 1; margin: 0; display: block; padding-bottom: 2px; font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;">${iconEmoji}</p>
                            <p style="margin: 0; font-size: 9px; font-family: sans-serif; color: #ffffff; line-height: 1.2;">
                                <span style="font-weight: bold;">${day.temp}¬∞</span>
                            </p>
                        </td>
                    `;
                });
                html += '</tr></tbody></table>';
                return html;
            };

            // --- Generate Tables ---
            // Helper for formatting Client/Campaign cell
            const formatClient = (client, campaign) => `<strong>${client}</strong><br/><span style="font-size:11px;color:#666;">${campaign}</span>`;
            
            // Helper to shorten product names
            const formatProduct = (product) => {
                if (!product) return '-';
                return product.replace('Transit Shelter-', '').replace('Transit Shelters-', '').replace('Transit Buses-', '');
            };
            
            // Helper to shorten market names
            const formatMarket = (market) => {
                if (!market) return '-';
                return market.split(',')[0].replace(' - STAP', '');
            };
            
            // Helper to abbreviate dates (1/2/25 instead of 1/2/2025)
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                // Convert various date formats to short format
                const parts = dateStr.split('/');
                if (parts.length === 3 && parts[2].length === 4) {
                    return `${parts[0]}/${parts[1]}/${parts[2].slice(-2)}`;
                }
                return dateStr;
            };

            // Dynamic column building based on settings
            const buildTableConfig = (baseHeaders, baseWidths, baseMapper, options = {}) => {
                let headers = [...baseHeaders];
                let widths = [...baseWidths];
                let mapper = baseMapper;
                
                // Add optional columns
                if (settings.showMarketColumn && options.includeMarket) {
                    headers.splice(options.marketPosition || 2, 0, 'Market');
                    widths.splice(options.marketPosition || 2, 0, '12%');
                }
                if (settings.showProductColumn && options.includeProduct) {
                    headers.splice(options.productPosition || 3, 0, 'Media');
                    widths.splice(options.productPosition || 3, 0, '15%');
                }
                
                return { headers, widths };
            };

            const tables = {
                delayed: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Late'); base.widths.push('7%', '5%');
                    
                    return createHtmlTable(processedData.delayedFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        // Calculate days overdue
                        const daysLate = item.dateObj ? Math.floor((new Date() - item.dateObj) / (1000 * 60 * 60 * 24)) : '-';
                        const daysLateDisplay = daysLate > 0 ? `<span style="color: ${daysLate > 7 ? '#d32f2f' : '#f57c00'}; font-weight: bold;">${daysLate}d</span>` : '-';
                        row.push(formatDate(item.date), daysLateDisplay);
                        return row;
                    });
                })(),
                
                inProgress: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '45%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('15%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Progress'); base.widths.push('7%', '22%');
                    
                    return createHtmlTable(processedData.inProgressFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        
                        // Build visual progress bar
                        const totalQty = item.quantity || item.totalQty || 0;
                        const installedQty = item.installed || item.totalInstalled || 0;
                        const pendingQty = item.pending || item.totalPending || (totalQty - installedQty);
                        const pct = totalQty > 0 ? Math.round((installedQty / totalQty) * 100) : 0;
                        const barColor = pct >= 75 ? '#4caf50' : pct >= 50 ? '#ff9800' : '#f44336';
                        
                        const progressHtml = totalQty > 0 ? `
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="flex: 1; background: #e0e0e0; border-radius: 4px; height: 8px; min-width: 80px;">
                                    <div style="width: ${pct}%; background: ${barColor}; height: 100%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 11px; white-space: nowrap; color: #333;">
                                    <strong>${installedQty}</strong>/${totalQty}
                                </span>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${pct}% ‚Ä¢ ${pendingQty} pending</div>
                        ` : '-';
                        
                        row.push(formatDate(item.date), progressHtml);
                        return row;
                    });
                })(),
                
                upcoming: (() => {
                    const base = { headers: ["Stage", "Campaign #", "Client / Campaign"], widths: ['18%', '10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('20%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start'); base.widths.push('7%');
                    
                    return createHtmlTable(processedData.upcoming, base.headers, base.widths, item => {
                        const row = [item.stage, item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        row.push(formatDate(item.date));
                        return row;
                    });
                })(),
                
                installed: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('Start', 'Units'); base.widths.push('7%', '10%');
                    
                    return createHtmlTable(processedData.fullyInstalledThisWeek, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        
                        // Show installed count with checkmark
                        const totalQty = item.quantity || item.totalQty || 0;
                        const installedQty = item.installed || item.totalInstalled || totalQty;
                        const unitsHtml = totalQty > 0 ? `
                            <span style="color: #4caf50; font-weight: bold;">‚úì ${installedQty}</span>
                            <span style="color: #666; font-size: 11px;">/ ${totalQty}</span>
                        ` : '-';
                        
                        row.push(formatDate(item.date), unitsHtml);
                        return row;
                    });
                })(),
                
                recentCompleted: (() => {
                    const base = { headers: ["Stage", "Campaign #", "Advertiser / Campaign"], widths: ['18%', '10%', '55%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('20%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    
                    return createHtmlTable(processedData.recentInstalls, base.headers, base.widths, item => {
                        const row = [item.stage, item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        return row;
                    });
                })(),
                
                pipeline: (() => {
                    // Count unique campaigns (by ID) for each category
                    const countUniqueCampaigns = (arr) => {
                        if (!arr || arr.length === 0) return 0;
                        const uniqueIds = new Set(arr.map(item => item.id));
                        return uniqueIds.size;
                    };
                    
                    // Match dashboard stat cards - count unique campaigns
                    const dashboardStats = [
                        { stage: 'Delayed / Overdue', count: countUniqueCampaigns(processedData.delayedFlights) },
                        { stage: 'In-Progress', count: countUniqueCampaigns(processedData.inProgressFlights) },
                        { stage: 'Upcoming (7 Days)', count: countUniqueCampaigns(processedData.upcoming) },
                        { stage: 'Installed This Week', count: countUniqueCampaigns(processedData.fullyInstalledThisWeek) },
                        { stage: 'Ready for Removal', count: countUniqueCampaigns(processedData.expiredFlights) },
                        { stage: 'Rotations', count: countUniqueCampaigns(processedData.rotations) },
                        { stage: 'On Hold', count: countUniqueCampaigns(processedData.onHoldCampaigns) }
                    ].filter(s => s.count > 0);
                    
                    return createHtmlTable(
                        dashboardStats,
                        ["Category", "Campaigns"],
                        ['80%', '20%'],
                        item => [item.stage, `<strong>${item.count}</strong>`]
                    );
                })(),
                
                removal: (() => {
                    const base = { headers: ["Campaign #", "Advertiser / Campaign"], widths: ['10%', '50%'] };
                    if (settings.showMarketColumn) { base.headers.push('Market'); base.widths.push('18%'); }
                    if (settings.showProductColumn) { base.headers.push('Media'); base.widths.push('18%'); }
                    if (settings.showOwnerColumn) { base.headers.push('Owner'); base.widths.push('15%'); }
                    base.headers.push('End', 'Ago'); base.widths.push('7%', '5%');
                    
                    return createHtmlTable(processedData.expiredFlights, base.headers, base.widths, item => {
                        const row = [item.id, formatClient(item.advertiser, item.name)];
                        if (settings.showMarketColumn) row.push(formatMarket(item.market));
                        if (settings.showProductColumn) row.push(formatProduct(item.product || item.media));
                        if (settings.showOwnerColumn) row.push(item.owner);
                        // Calculate days since expired
                        const daysAgo = item.endDateObj ? Math.floor((new Date() - item.endDateObj) / (1000 * 60 * 60 * 24)) : '-';
                        const daysDisplay = daysAgo > 0 ? `${daysAgo}d` : '-';
                        row.push(formatDate(item.endDate), daysDisplay);
                        return row;
                    });
                })()
            };

            const weatherHtml = getWeatherHtml();

            // Dynamic Sections based on settings
            let sectionsHtml = '';
            
            if (settings.sections.summary) {
                // Calculate production breakdown
                const allCampaigns = processedData.all || [];
                const productionBreakdown = {
                    inHouse: allCampaigns.filter(c => c.productionProof === 'in-house').length,
                    client: allCampaigns.filter(c => c.productionProof === 'client').length,
                    mixed: allCampaigns.filter(c => c.productionProof === 'mixed').length,
                    unset: allCampaigns.filter(c => !c.productionProof).length
                };
                const hasProductionData = productionBreakdown.inHouse > 0 || productionBreakdown.client > 0 || productionBreakdown.mixed > 0;
                
                sectionsHtml += `
                <tr><td class="summary-section">
                <h2>THIS WEEK AT A GLANCE</h2>
                <div class="summary-grid">
                    <div class="summary-item"><div class="count" style="color: ${processedData.delayedFlights.length > 0 ? '#d32f2f' : '#4caf50'};">${processedData.delayedFlights.length}</div><div class="label">DELAYED</div></div>
                    <div class="summary-item"><div class="count normal">${processedData.inProgressFlights.length}</div><div class="label">IN-PROGRESS</div></div>
                    <div class="summary-item"><div class="count normal">${processedData.upcoming.length}</div><div class="label">UPCOMING</div></div>
                    <div class="summary-item"><div class="count" style="color: #4caf50;">${processedData.fullyInstalledThisWeek.length}</div><div class="label">INSTALLED</div></div>
                </div>
                ${hasProductionData ? `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e8;">
                    <h3 style="margin: 0 0 10px; font-size: 14px; color: #666; text-align: center;">PRODUCTION SOURCE BREAKDOWN</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="count" style="font-size: 20px; color: #7c3aed;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                ${productionBreakdown.inHouse}
                            </div>
                            <div class="label" style="font-size: 10px;">IN-HOUSE</div>
                        </div>
                        <div class="summary-item">
                            <div class="count" style="font-size: 20px; color: #2563eb;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                ${productionBreakdown.client}
                            </div>
                            <div class="label" style="font-size: 10px;">CLIENT</div>
                        </div>
                        <div class="summary-item">
                            <div class="count" style="font-size: 20px; color: #d97706;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                                ${productionBreakdown.mixed}
                            </div>
                            <div class="label" style="font-size: 10px;">MIXED</div>
                        </div>
                        ${productionBreakdown.unset > 0 ? `<div class="summary-item"><div class="count" style="font-size: 20px; color: #9ca3af;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>${productionBreakdown.unset}</div><div class="label" style="font-size: 10px;">NOT SET</div></div>` : ''}
                    </div>
                </div>
                ` : ''}
                </td></tr>`;
            }

            if (settings.sections.delayed) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.delayed}</h2>${tables.delayed}</td></tr>`;
            }
            if (settings.sections.inProgress) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.inProgress}</h2>${tables.inProgress}</td></tr>`;
            }
            if (settings.sections.upcoming) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.upcoming}</h2>${tables.upcoming}</td></tr>`;
            }
            if (settings.sections.installed) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.installed}</h2>${tables.installed}</td></tr>`;
            }
            if (settings.sections.recent) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.recent}</h2>${tables.recentCompleted}</td></tr>`;
            }
            if (settings.sections.pipeline) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.pipeline}</h2>${tables.pipeline}</td></tr>`;
            }
            if (settings.sections.removal) {
                sectionsHtml += `<tr><td class="section"><h2>${settings.titles.removal}</h2>${tables.removal}</td></tr>`;
            }

            return `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f4f8; margin: 0; padding: 15px; color: #333333; }
            .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
            .header { background-color: #00C9FF; background-image: linear-gradient(to right, #00C9FF, #6E6AFF); padding: 15px 20px; color: #ffffff; }
            .header h1 { margin: 0; font-size: 26px; font-weight: 600; line-height: 1.2; color: #ffffff; }
            .header p { margin: 4px 0 0; font-size: 16px; opacity: 0.9; color: #ffffff; }
            .logo { max-width: 80px; height: auto; display: block; }
            .summary-section { padding: 25px 30px; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e8; }
            .summary-section h2 { margin: 0 0 15px; font-size: 20px; color: #0d47a1; text-align: center;}
            .summary-grid { display: table; width: 100%; border-collapse: collapse; }
            .summary-item { display: table-cell; text-align: center; padding: 10px; }
            .summary-item .count { font-size: 28px; font-weight: 600; color: #d32f2f; line-height: 1.1; }
            .summary-item .count.normal { color: #2979ff; }
            .summary-item .label { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
            .section { padding: 25px 30px; border-bottom: 1px solid #e0e0e8; }
            .section:last-of-type { border-bottom: none; }
            .section h2 { margin: 0 0 15px; font-size: 20px; color: #0d47a1; }
            table.data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            .data-table th, .data-table td { padding: 9px 8px; text-align: left; border-bottom: 1px solid #eeeeee; font-size: 13px; vertical-align: top; word-break: break-word; }
            .data-table th { font-weight: 600; color: #555; background-color: #f8f9fa; }
            .data-table tr:last-child td { border-bottom: none; }
            .footer { padding: 30px; text-align: center; font-size: 14px; background-color: #f0f4f8; }
            .footer a { background-color: #2979ff; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; }
            </style></head><body>
            <table class="container" align="center" cellpadding="0" cellspacing="0">
                <tr>
                <td class="header">
                    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                    <tr>
                        <td width="100" align="left" valign="middle">
                        <img src="https://drive.google.com/thumbnail?id=1Z8ZtHCnM5MT06YFAsokHxBXV70JsD3c7" alt="Vector Logo" class="logo">
                        </td>
                        <td align="center" valign="middle" style="padding: 0 10px;">
                        <h1 style="margin: 0; font-size: 26px; font-weight: 600; line-height: 1.2;">${settings.mainTitle}</h1>
                        <p style="margin: 4px 0 0; font-size: 16px; opacity: 0.9;">${today}</p>
                        </td>
                        <td width="200" align="right" valign="middle">${settings.showWeather ? weatherHtml : ''}</td>
                    </tr>
                    </table>
                </td>
                </tr>
                ${sectionsHtml}
                <tr><td class="footer">
                    <a href="#">View Full Dashboard</a>
                    <p style="margin-top: 15px; font-size: 11px; color: #999;">
                        Report generated: ${new Date().toLocaleString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        })} ‚Ä¢ LA STAP Operations Portal
                    </p>
                </td></tr>
            </table>
            </body></html>`;
        };

        // --- CONFIGURATION & HELPER FUNCTIONS ---
        
        const ALL_STAGES = [
            'RFP',
            'Initial Proposal',
            'Client Feedback',
            'Pending Hold',
            'On Hold',
            'Pending Client Approval',
            'Pending Finance Approval',
            'Contracted',
            'Proofs Approved', 
            'Working On It',
            'Proofs Out For Approval',
            'Artwork Received',
            'Material Ready For Install',
            'Installed',
            'Photos Taken',
            'POP Completed',
            'Takedown Complete',
            'Lost Opportunity',
            'Canceled'
        ];

        const SPECIALTY_KEYWORDS = [
            'embellishment'
        ];

        // --- MOCK DATA FOR LANDING PAGE ---
        const WEATHER_FORECAST = [
            { day: 'Mon', temp: 72, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Tue', temp: 75, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Wed', temp: 68, icon: 'Cloud', status: 'Cloudy', rain: 10 },
            { day: 'Thu', temp: 70, icon: 'Sun', status: 'Clear', rain: 0 },
            { day: 'Fri', temp: 74, icon: 'Sun', status: 'Sunny', rain: 5 },
            { day: 'Sat', temp: 71, icon: 'CloudRain', status: 'Showers', rain: 60 },
            { day: 'Sun', temp: 69, icon: 'Cloud', status: 'Partly Cloudy', rain: 20 },
            // Week 2
            { day: 'Mon', temp: 70, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Tue', temp: 73, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Wed', temp: 66, icon: 'Cloud', status: 'Cloudy', rain: 15 },
            { day: 'Thu', temp: 68, icon: 'CloudRain', status: 'Rain', rain: 40 },
            { day: 'Fri', temp: 71, icon: 'Sun', status: 'Clear', rain: 5 },
            { day: 'Sat', temp: 75, icon: 'Sun', status: 'Sunny', rain: 0 },
            { day: 'Sun', temp: 77, icon: 'Sun', status: 'Sunny', rain: 0 },
        ];

        const UPCOMING_HOLIDAYS = [
            { date: 'Dec 14', name: 'Hanukkah', type: 'Jewish' },
            { date: 'Dec 25', name: 'Christmas Day', type: 'Federal' },
            { date: 'Jan 01', name: 'New Year\'s Day', type: 'Federal' },
            { date: 'Jan 15', name: 'Martin Luther King Jr. Day', type: 'Federal' },
            { date: 'Feb 02', name: 'Tu BiShvat', type: 'Jewish' },
            { date: 'Feb 19', name: 'Presidents\' Day', type: 'Federal' }
        ];

        // --- GLOBAL CITY DATA (MOVED TO GLOBAL SCOPE FOR AI ACCESS) ---
        const CITY_DATA = {
            'Los Angeles': [
                { rainChance: 0, temp: 78, condition: 'Sunny' }, { rainChance: 0, temp: 80, condition: 'Sunny' },
                { rainChance: 0, temp: 79, condition: 'Sunny' }, { rainChance: 0, temp: 77, condition: 'Sunny' },
                { rainChance: 5, temp: 75, condition: 'Partly Cloudy' },
            ],
            'Seattle': [
                { rainChance: 88, temp: 48, condition: 'Heavy Rain' }, { rainChance: 92, temp: 46, condition: 'Storms' },
                { rainChance: 65, temp: 49, condition: 'Showers' }, { rainChance: 40, temp: 51, condition: 'Cloudy' },
                { rainChance: 75, temp: 47, condition: 'Rain' },
            ],
            'New York': [
                { rainChance: 10, temp: 35, condition: 'Partly Cloudy' }, { rainChance: 20, temp: 32, condition: 'Overcast' },
                { rainChance: 0, temp: 30, condition: 'Clear' }, { rainChance: 5, temp: 34, condition: 'Sunny' },
                { rainChance: 40, temp: 38, condition: 'Light Snow' },
            ],
            'Miami': [
                { rainChance: 30, temp: 82, condition: 'Scattered T-Storms' }, { rainChance: 50, temp: 84, condition: 'Partly Cloudy' },
                { rainChance: 20, temp: 81, condition: 'Sunny' }, { rainChance: 80, temp: 79, condition: 'Thunderstorms' },
                { rainChance: 10, temp: 80, condition: 'Sunny' },
            ]
        };

        const parseCSV = (text) => {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const parseLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') { inQuotes = !inQuotes; }
                    else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                    else { current += char; }
                }
                result.push(current.trim());
                return result;
            };
            const headers = parseLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = parseLine(line);
                const entry = {};
                headers.forEach((h, i) => { entry[h] = values[i] || ''; });
                return entry;
            });
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const clean = dateStr.trim().split(' ')[0]; 

            // Handle MM/DD/YYYY (Standard US CSV)
            const usParts = clean.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if (usParts) {
                let year = parseInt(usParts[3], 10);
                if (year < 100) year += 2000;
                return new Date(year, parseInt(usParts[1], 10) - 1, parseInt(usParts[2], 10));
            }

            // Handle YYYY-MM-DD (ISO / Google API)
            const isoParts = clean.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (isoParts) {
                return new Date(parseInt(isoParts[1], 10), parseInt(isoParts[2], 10) - 1, parseInt(isoParts[3], 10));
            }

            const d = new Date(dateStr);
            return isNaN(d) ? null : d;
        };

        const getStatusColor = (stage, date) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            if (!stage || stage === '') return "bg-gray-200 text-gray-500 border-gray-300 italic";
            if (!date) return "bg-gray-100 text-gray-800";
            const isPastDue = date < today && !['Installed', 'Photos Taken', 'POP Completed', 'Takedown Complete', 'Canceled', 'Lost Opportunity'].includes(stage);
            
            if (stage === 'Lost Opportunity') return "bg-gray-200 text-gray-500 border-gray-300";
            if (stage === 'Takedown Complete') return "bg-slate-200 text-slate-600 border-slate-300";
            if (isPastDue) return "bg-red-100 text-red-800 border-red-200 font-bold";
            if (stage?.includes('Installed')) return "bg-blue-100 text-blue-800 border-blue-200";
            if (stage?.includes('Material Ready')) return "bg-green-100 text-green-800 border-green-200";
            if (stage?.includes('Contracted')) return "bg-yellow-100 text-yellow-800 border-yellow-200";
            if (stage?.includes('Pending')) return "bg-orange-50 text-orange-600 border-orange-200";
            return "bg-gray-100 text-gray-600 border-gray-200";
        };

        const findCol = (headers, keywords, exclude = []) => headers.find(h => {
            const low = h.toLowerCase();
            if (!keywords.some(k => low.includes(k))) return false;
            if (exclude.some(e => low.includes(e))) return false;
            return true;
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üß† SMART COLUMN MATCHER - Fuzzy matching for flexible CSV imports
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Levenshtein distance for fuzzy string matching
        const levenshteinDistance = (str1, str2) => {
            const m = str1.length, n = str2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    dp[i][j] = str1[i-1] === str2[j-1] 
                        ? dp[i-1][j-1] 
                        : Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
                }
            }
            return dp[m][n];
        };

        // Similarity score (0-1, higher = more similar)
        const similarityScore = (str1, str2) => {
            const s1 = str1.toLowerCase().replace(/[^a-z0-9]/g, '');
            const s2 = str2.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (s1 === s2) return 1;
            if (s1.includes(s2) || s2.includes(s1)) return 0.9;
            const maxLen = Math.max(s1.length, s2.length);
            if (maxLen === 0) return 0;
            return 1 - (levenshteinDistance(s1, s2) / maxLen);
        };

        // Smart column mapping with synonyms and variations
        const COLUMN_SYNONYMS = {
            // Campaign ID variations
            'campaign_id': ['campaign number', 'campaign id', 'campaign #', 'campaign no', 'campaignnumber', 'campaign_number', 'id', 'campaign-id', 'booking id', 'booking number', 'order id', 'order number', 'opp id', 'opportunity id'],
            
            // Product Start Date - THIS IS THE KEY DATE FOR ROTATIONS/COPY CHANGES
            // IMPORTANT: Must NOT match "program start date" - that's the contract date
            'start_date': ['product start date', 'product start', 'flight start date', 'flight start', 'posting start', 'posting date', 'install start', 'media start date', 'media start', 'product_start_date', 'flight_start_date', 'prod start', 'prod start date'],
            
            // Product End Date - When the specific flight/rotation ends
            'product_end_date': ['product end date', 'product end', 'flight end date', 'flight end', 'posting end', 'removal date', 'takedown date', 'media end date', 'media end', 'product_end_date', 'flight_end_date', 'prod end', 'prod end date'],
            
            // Program End Date - Overall contract end (informational)
            'program_end_date': ['program end date', 'program end', 'contract end date', 'contract end', 'agreement end', 'final contract end', 'program_end_date'],
            
            // Market variations
            'market': ['market', 'dma', 'region', 'city', 'location', 'territory', 'area', 'metro', 'geo', 'geography', 'market name', 'market_name'],
            
            // Owner variations
            'owner': ['opportunity owner', 'owner', 'sales rep', 'sales owner', 'account exec', 'ae', 'rep', 'salesperson', 'account manager', 'am', 'assigned to', 'assigned', 'sales_rep', 'account_exec'],
            
            // Advertiser variations
            'advertiser': ['advertiser', 'client', 'customer', 'account', 'brand', 'company', 'advertiser name', 'client name', 'account name', 'buyer', 'agency'],
            
            // Campaign Name variations
            'campaign': ['campaign', 'campaign name', 'flight name', 'order name', 'booking name', 'description', 'title', 'name', 'campaign_name', 'flight'],
            
            // Product/Media variations
            'product': ['product', 'media', 'media type', 'format', 'unit type', 'inventory', 'asset', 'product type', 'product name', 'media_type', 'unit', 'ad type', 'ad format', 'placement'],
            
            // Stage/Status variations
            'stage': ['inventory opportunity stage', 'stage', 'status', 'workflow stage', 'current stage', 'opp stage', 'opportunity stage', 'workflow status', 'state', 'phase', 'step'],
            
            // Progress variations
            'progress': ['progress', 'completion', 'install progress', 'pct complete', 'percent complete', '% complete', 'installed/total', 'progress_pct'],
            
            // Quantity variations
            'quantity': ['quantity', 'qty', 'total qty', 'total quantity', 'units', 'faces', 'spots', 'panels', 'count', 'num units', 'total units', 'total', 'ordered', 'booked'],
            
            // Installed count variations
            'installed': ['installed', 'posted', 'live', 'completed', 'installed qty', 'installed quantity', 'posted qty', 'up', 'active'],
            
            // Pending variations
            'pending': ['pending', 'remaining', 'left', 'to install', 'outstanding', 'not installed', 'pending qty'],
            
            // First Install Date variations
            'first_install': ['first install date', 'first install', 'first posted', 'first up date', 'initial install', '1st install'],
            
            // Completion Date variations
            'completion': ['completion date', 'completed date', 'finish date', 'done date', 'last install', 'final install'],
            
            // Production Proof variations (In-House vs Client-Produced)
            'production_proof': ['production proof', 'production source', 'produced by', 'print source', 'material source', 'production type', 'in-house', 'inhouse production', 'production']
        };

        // Find best matching column with fuzzy logic
        const smartFindColumn = (headers, targetField, minScore = 0.6) => {
            const synonyms = COLUMN_SYNONYMS[targetField] || [targetField];
            let bestMatch = null;
            let bestScore = 0;

            for (const header of headers) {
                const headerClean = header.toLowerCase().trim();
                
                for (const synonym of synonyms) {
                    // Exact match (highest priority)
                    if (headerClean === synonym.toLowerCase()) {
                        return header;
                    }
                    
                    // Check similarity
                    const score = similarityScore(headerClean, synonym);
                    if (score > bestScore && score >= minScore) {
                        bestScore = score;
                        bestMatch = header;
                    }
                }
            }

            return bestMatch;
        };

        // Build complete column mapping from headers
        const buildSmartColumnMap = (headers) => {
            const colMap = {};
            const mappingResults = []; // Track results for user feedback
            
            // Field mappings with clear distinction between Product (flight) and Program (contract) dates
            const fieldMappings = [
                { field: 'id', target: 'campaign_id', fallback: 'Campaign Number', required: true, description: 'Unique campaign identifier' },
                { field: 'startDate', target: 'start_date', fallback: 'Product Start Date', required: true, description: 'Product/Flight start (for rotations/copy changes)' },
                { field: 'productEndDate', target: 'product_end_date', fallback: 'Product End Date', required: false, description: 'Product/Flight end date' },
                { field: 'programEndDate', target: 'program_end_date', fallback: 'Program End Date', required: false, description: 'Program/Contract end date' },
                { field: 'market', target: 'market', fallback: 'Market', required: false, description: 'Market/DMA' },
                { field: 'owner', target: 'owner', fallback: 'Opportunity Owner', required: false, description: 'Sales rep/owner' },
                { field: 'advertiser', target: 'advertiser', fallback: 'Advertiser', required: true, description: 'Client/Advertiser name' },
                { field: 'campaign', target: 'campaign', fallback: 'Campaign', required: false, description: 'Campaign name' },
                { field: 'product', target: 'product', fallback: 'Product', required: false, description: 'Media type/Product' },
                { field: 'stage', target: 'stage', fallback: 'Inventory Opportunity Stage', required: true, description: 'Workflow stage/status' },
                { field: 'progress', target: 'progress', fallback: 'Progress', required: false, description: 'Install progress' },
                { field: 'qty', target: 'quantity', fallback: 'Quantity', required: false, description: 'Total quantity' },
                { field: 'installed', target: 'installed', fallback: 'Installed', required: false, description: 'Installed count' },
                { field: 'pending', target: 'pending', fallback: 'Pending', required: false, description: 'Pending count' },
                { field: 'firstInstall', target: 'first_install', fallback: 'First Install Date', required: false, description: 'First install date' },
                { field: 'completion', target: 'completion', fallback: 'Completion Date', required: false, description: 'Completion date' },
                { field: 'productionProof', target: 'production_proof', fallback: 'Production Proof', required: false, description: 'In-House or Client production' }
            ];

            fieldMappings.forEach(({ field, target, fallback, required }) => {
                const match = smartFindColumn(headers, target);
                const found = match && headers.includes(match);
                
                colMap[field] = match || fallback;
                
                mappingResults.push({
                    field,
                    mappedTo: match || fallback,
                    found,
                    required,
                    status: found ? 'matched' : (required ? 'missing' : 'optional')
                });
            });

            // Log mapping results for debugging
            console.log('üìä Smart Column Mapping Results:');
            console.log('Headers found:', headers.length);
            mappingResults.forEach(({ field, mappedTo, found, status }) => {
                const icon = status === 'matched' ? '‚úÖ' : (status === 'missing' ? '‚ùå' : '‚ö†Ô∏è');
                console.log(`  ${icon} ${field} ‚Üí "${mappedTo}"`);
            });

            // Store mapping results globally for UI feedback
            window.__lastColumnMapping = {
                headers,
                mappingResults,
                matched: mappingResults.filter(r => r.found).length,
                total: mappingResults.length,
                missingRequired: mappingResults.filter(r => r.status === 'missing').map(r => r.field)
            };

            return colMap;
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // --- DATA PROCESSING LOGIC ---

        // üß† UNIFIED PROCESSOR: Single Source of Truth (Master_Tracking_Export)
        // Handles aggregation, ghost detection, and all data transformation
        const processMasterExport = (rawRows) => {
            if (rawRows.length === 0) return { regular: [], specialty: [], lost: [], ghosts: [] };
            
            const headers = Object.keys(rawRows[0]);
            
            // üß† USE SMART COLUMN MAPPING - handles position changes and name variations
            const colMap = buildSmartColumnMap(headers);

            // Aggregation Map: Key = CampaignID | StartDate | Product
            const aggregationMap = new Map();
            const ghostItems = [];
            const currentYear = new Date().getFullYear();
            const maxYear = currentYear + 3; // Allow up to 3 years ahead for planning

            rawRows.forEach(row => {
                const id = (row[colMap.id] || '').toString().trim();
                if (!id) return;

                const rawStartDate = row[colMap.startDate] || '';
                const startDateObj = parseDate(rawStartDate);
                if (!startDateObj) return;

                // Year filter: Include past year through 3 years ahead
                const rowYear = startDateObj.getFullYear();
                if (rowYear < currentYear - 1 || rowYear > maxYear) return;

                const owner = (row[colMap.owner] || '').trim();
                const advertiser = (row[colMap.advertiser] || '').trim();
                const campaignName = (row[colMap.campaign] || '').trim();
                const product = (row[colMap.product] || '').trim();
                const market = (row[colMap.market] || '').trim();
                const stage = (row[colMap.stage] || '').trim();
                
                // Parse dates
                const rawProductEndDate = row[colMap.productEndDate] || '';
                const rawProgramEndDate = row[colMap.programEndDate] || '';
                const productEndDateObj = parseDate(rawProductEndDate);
                const programEndDateObj = parseDate(rawProgramEndDate);
                
                // Product End Date used for filtering (when this specific flight ends)
                // Program End Date is when the entire campaign ends (informational only)
                const effectiveEndDate = rawProductEndDate || rawProgramEndDate;
                const effectiveEndDateObj = productEndDateObj || programEndDateObj;

                // Parse metrics
                const qty = parseFloat(row[colMap.qty]) || 0;
                const installed = parseFloat(row[colMap.installed]) || 0;
                const pending = parseFloat(row[colMap.pending]) || 0;
                const progressStr = row[colMap.progress] || `${installed} / ${qty}`;
                
                // Parse install dates
                const firstInstallStr = row[colMap.firstInstall] || '';
                const completionStr = row[colMap.completion] || '';
                const firstInstallDate = parseDate(firstInstallStr);
                const completionDate = parseDate(completionStr);
                
                // Parse Production Proof (In-House vs Client-Produced)
                // If there's a link/value ‚Üí In-House production (proofs only exist for in-house)
                // If empty ‚Üí Client-produced or unknown
                const rawProductionProof = (row[colMap.productionProof] || '').toString().trim();
                let productionProof = null;
                let proofLink = null;
                
                // Check if it's a link (Google Drive, Dropbox, etc.)
                const isLink = rawProductionProof.startsWith('http') || 
                               rawProductionProof.includes('drive.google.com') || 
                               rawProductionProof.includes('dropbox.com') ||
                               rawProductionProof.includes('.pdf') ||
                               rawProductionProof.includes('.png') ||
                               rawProductionProof.includes('.jpg');
                
                if (isLink) {
                    // Has a proof link ‚Üí definitely in-house production
                    productionProof = 'in-house';
                    proofLink = rawProductionProof;
                } else if (rawProductionProof) {
                    // Has text value - check what it says
                    const valueLower = rawProductionProof.toLowerCase();
                    if (valueLower.includes('in-house') || valueLower.includes('inhouse') || valueLower === 'in house' || valueLower === 'yes' || valueLower === 'true') {
                        productionProof = 'in-house';
                    } else if (valueLower.includes('client') || valueLower.includes('external') || valueLower === 'no' || valueLower === 'false') {
                        productionProof = 'client';
                    } else if (valueLower.includes('mixed') || valueLower.includes('both')) {
                        productionProof = 'mixed';
                    } else {
                        // Has some value but not recognized - treat as in-house (likely a filename or reference)
                        productionProof = 'in-house';
                        proofLink = rawProductionProof; // Could be a filename
                    }
                }
                // If empty, productionProof stays null (unknown/client)

                // üëª GHOST DETECTION: No owner OR no stage = Ghost booking from SF
                const noOwner = !owner || owner.toLowerCase() === 'n/a' || owner === '-';
                const noStage = !stage || stage.trim() === '' || stage.toLowerCase() === 'n/a' || stage === '-';
                const isGhost = noOwner || noStage;
                const ghostReason = noOwner ? 'No Owner' : (noStage ? 'No Stage' : null);

                // Build base item
                const baseItem = {
                    id,
                    name: campaignName,
                    advertiser: advertiser || 'Unknown',
                    rawName: `${advertiser} | ${campaignName}`,
                    owner: owner || 'üëª NO OWNER',
                    market,
                    date: rawStartDate,
                    dateObj: startDateObj,
                    productEndDate: rawProductEndDate,
                    productEndDateObj,
                    programEndDate: rawProgramEndDate,
                    programEndDateObj,
                    // Effective end date for filtering (Product End Date = when this flight ends)
                    endDate: effectiveEndDate,
                    endDateObj: effectiveEndDateObj,
                    product,
                    media: product, // Alias
                    stage,
                    productionProof, // In-House, Client, Mixed, or null
                    proofLink, // URL to proof PDF/image if in-house
                    isGhost,
                    ghostReason
                };

                // If ghost, collect separately and SKIP from main aggregation
                // Ghosts should ONLY appear in Ghost Bookings, not Master Tracking
                if (isGhost) {
                    ghostItems.push({
                        ...baseItem,
                        quantity: qty,
                        totalQty: qty,
                        installed,
                        totalInstalled: installed,
                        pending,
                        progress: progressStr,
                        isComplete: pending === 0 && qty > 0,
                        firstInstall: firstInstallStr,
                        completion: completionStr
                    });
                    return; // ‚Üê SKIP from main aggregation - goes ONLY to Ghost Bookings
                }

                // AGGREGATION KEY: CampaignID + StartDate + Product + Market
                // This combines bonus lines (same campaign, date, product, market) into one row
                // But keeps different markets as separate rows
                const dateKey = startDateObj.toISOString().split('T')[0];
                const aggKey = `${id}|${dateKey}|${product}|${market}`;

                if (!aggregationMap.has(aggKey)) {
                    aggregationMap.set(aggKey, {
                        ...baseItem,
                        totalQty: 0,
                        totalInstalled: 0,
                        totalPending: 0,
                        lineCount: 0, // Track bonus lines
                        firstInstallDate: null,
                        rawFirstInstall: null,
                        completionDate: null,
                        rawCompletion: null
                    });
                }

                const item = aggregationMap.get(aggKey);
                item.totalQty += qty;
                item.totalInstalled += installed;
                item.totalPending += pending;
                item.lineCount += 1;

                // Track earliest first install and latest completion
                if (firstInstallDate) {
                    if (!item.firstInstallDate || firstInstallDate < item.firstInstallDate) {
                        item.firstInstallDate = firstInstallDate;
                        item.rawFirstInstall = firstInstallStr;
                    }
                }
                if (completionDate) {
                    if (!item.completionDate || completionDate > item.completionDate) {
                        item.completionDate = completionDate;
                        item.rawCompletion = completionStr;
                    }
                }
            });

            // Finalize aggregated items
            const regularItems = [];
            const specialtyItems = [];
            const lostItems = [];

            aggregationMap.forEach(item => {
                const finalItem = {
                    ...item,
                    quantity: item.totalQty,
                    installed: item.totalInstalled,
                    pending: item.totalPending,
                    progress: `${item.totalInstalled} / ${item.totalQty}`,
                    isComplete: item.totalPending === 0 && item.totalQty > 0,
                    firstInstall: item.rawFirstInstall,
                    completion: item.rawCompletion,
                    // Bonus indicator: Show if multiple lines were combined
                    hasBonus: item.lineCount > 1,
                    bonusNote: item.lineCount > 1 ? `(${item.lineCount} lines combined)` : ''
                };

                const stageLower = (finalItem.stage || '').toLowerCase().trim();
                
                // Route to appropriate category
                if (stageLower === 'lost opportunity' || stageLower === '- none -') {
                    lostItems.push(finalItem);
                } else if (SPECIALTY_KEYWORDS.some(k => (finalItem.product || '').toLowerCase().includes(k))) {
                    specialtyItems.push(finalItem);
                } else {
                    regularItems.push(finalItem);
                }
            });

            return { 
                regular: regularItems, 
                specialty: specialtyItems, 
                lost: lostItems,
                ghosts: ghostItems
            };
        };

        // LEGACY: Keep processHoldReport as wrapper for backward compatibility
        const processHoldReport = (rawRows, installMap) => {
            // Now just delegates to the unified processor
            return processMasterExport(rawRows);
        };

        // LEGACY: Keep processInstallReport as wrapper for backward compatibility  
        const processInstallReport = (rawRows) => {
            const result = processMasterExport(rawRows);
            return { regular: result.regular };
        }

        // --- COMPONENTS ---
        
        // --- IMPRESSIONS LOOKUP MODAL ---
        const ImpressionsLookupModal = ({ isOpen, onClose }) => {
            const [selectedZip, setSelectedZip] = useState('');
            const [searchArea, setSearchArea] = useState('');
            const [result, setResult] = useState(null);
            const [searchResults, setSearchResults] = useState([]);

            const availableZips = React.useMemo(() => getAvailableZips(), []);

            const handleZipLookup = (zip) => {
                if (zip && zip.length === 5) {
                    const data = estimateImpressions(zip);
                    setResult(data);
                    setSelectedZip(zip);
                }
            };

            const handleAreaSearch = (area) => {
                setSearchArea(area);
                if (area.length >= 2) {
                    const results = findZipsByArea(area);
                    setSearchResults(results.slice(0, 10));
                } else {
                    setSearchResults([]);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-gradient-to-r from-emerald-600 to-teal-600 text-white">
                            <div className="flex justify-between items-center">
                                <h2 className="text-xl font-bold flex items-center gap-2">
                                    <Icon name="MapPin" size={24} />
                                    Geopath Impressions Lookup
                                </h2>
                                <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full">
                                    <Icon name="X" size={20} />
                                </button>
                            </div>
                            <p className="text-sm text-white/80 mt-1">Estimate weekly impressions by ZIP code</p>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto max-h-[calc(85vh-180px)]">
                            {/* Search Section */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                {/* ZIP Lookup */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Lookup by ZIP Code</label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={selectedZip}
                                            onChange={(e) => setSelectedZip(e.target.value.replace(/\D/g, '').slice(0, 5))}
                                            placeholder="e.g. 90028"
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                            maxLength={5}
                                        />
                                        <button
                                            onClick={() => handleZipLookup(selectedZip)}
                                            disabled={selectedZip.length !== 5}
                                            className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <Icon name="Search" size={18} />
                                        </button>
                                    </div>
                                </div>

                                {/* Area Search */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Search by Area Name</label>
                                    <input
                                        type="text"
                                        value={searchArea}
                                        onChange={(e) => handleAreaSearch(e.target.value)}
                                        placeholder="e.g. Hollywood, Venice..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                    />
                                </div>
                            </div>

                            {/* Area Search Results */}
                            {searchResults.length > 0 && (
                                <div className="mb-6 p-3 bg-gray-50 rounded-lg">
                                    <p className="text-xs text-gray-500 mb-2">Click a ZIP to view details:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {searchResults.map(r => (
                                            <button
                                                key={r.zip}
                                                onClick={() => { handleZipLookup(r.zip); setSearchArea(''); setSearchResults([]); }}
                                                className="px-3 py-1 bg-white border border-gray-200 rounded-full text-sm hover:border-emerald-500 hover:text-emerald-600 transition-colors"
                                            >
                                                {r.zip} - {r.area}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Results */}
                            {result && (
                                <div className="space-y-4">
                                    {/* Location Info */}
                                    <div className={`p-4 rounded-xl ${result.found ? 'bg-emerald-50 border border-emerald-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-900">ZIP {result.zip}</h3>
                                                <p className={`text-sm ${result.found ? 'text-emerald-700' : 'text-yellow-700'}`}>
                                                    {result.found ? result.area : 'ZIP not in database - using LA average'}
                                                </p>
                                            </div>
                                            <div className={`px-3 py-1 rounded-full text-xs font-medium ${result.found ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                {result.found ? 'Data Found' : 'Estimated'}
                                            </div>
                                        </div>
                                        
                                        {result.found && (
                                            <div className="mt-3 grid grid-cols-3 gap-4 text-center">
                                                <div className="bg-white rounded-lg p-2">
                                                    <p className="text-xs text-gray-500">Population</p>
                                                    <p className="font-bold text-gray-900">{result.population?.toLocaleString()}</p>
                                                </div>
                                                <div className="bg-white rounded-lg p-2">
                                                    <p className="text-xs text-gray-500">Sq. Miles</p>
                                                    <p className="font-bold text-gray-900">{result.sqMiles}</p>
                                                </div>
                                                <div className="bg-white rounded-lg p-2">
                                                    <p className="text-xs text-gray-500">Density</p>
                                                    <p className="font-bold text-gray-900">{result.density?.toLocaleString()}/mi¬≤</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Impressions by Product */}
                                    <div className="bg-gray-50 rounded-xl p-4">
                                        <h4 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                            <Icon name="BarChart" size={18} className="text-emerald-600" />
                                            Weekly Impressions by Product
                                        </h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            {Object.entries(result.weeklyImpressions).map(([product, imps]) => (
                                                <div key={product} className="bg-white rounded-lg p-3 border border-gray-200">
                                                    <p className="text-xs text-gray-500 truncate" title={product}>{product}</p>
                                                    <p className="text-xl font-bold text-gray-900">{imps.toLocaleString()}</p>
                                                    <p className="text-xs text-gray-400">imps/week/face</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Methodology Note */}
                                    <div className="text-xs text-gray-500 bg-gray-100 rounded-lg p-3">
                                        <p className="font-medium mb-1">üìä Methodology:</p>
                                        <p>Estimates based on US Census 2022 population data and industry-standard Geopath visibility factors. 
                                        Actual impressions may vary based on specific placement, traffic patterns, and time of day.</p>
                                    </div>
                                </div>
                            )}

                            {/* Quick Reference */}
                            {!result && (
                                <div className="text-center py-8 text-gray-500">
                                    <Icon name="MapPin" size={48} className="mx-auto mb-3 text-gray-300" />
                                    <p className="font-medium">Enter a ZIP code or search by area</p>
                                    <p className="text-sm">Coverage: {availableZips.length} LA ZIP codes</p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">
                            <p className="text-xs text-gray-500">
                                Data: US Census 2022 ‚Ä¢ {Object.keys(LA_ZIP_DATA).length} ZIPs
                            </p>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GOOGLE SHEET SETTINGS MODAL (Hidden Feature - Triple-click on logo)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const GoogleSheetSettingsModal = ({ isOpen, onClose, currentSheetUrl, onSave }) => {
            const [sheetUrl, setSheetUrl] = useState(currentSheetUrl || '');
            const [testStatus, setTestStatus] = useState(null); // null, 'testing', 'success', 'error'
            const [testMessage, setTestMessage] = useState('');
            
            useEffect(() => {
                if (isOpen) {
                    // Load saved URL from localStorage
                    const saved = localStorage.getItem('stap_google_sheet_url');
                    if (saved) setSheetUrl(saved);
                }
            }, [isOpen]);
            
            const handleSave = () => {
                localStorage.setItem('stap_google_sheet_url', sheetUrl);
                if (onSave) onSave(sheetUrl);
                onClose();
            };
            
            const handleTest = async () => {
                if (!sheetUrl) {
                    setTestStatus('error');
                    setTestMessage('Please enter a Google Sheet URL');
                    return;
                }
                
                setTestStatus('testing');
                setTestMessage('Testing connection...');
                
                try {
                    // Extract sheet ID from URL
                    const sheetIdMatch = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (!sheetIdMatch) {
                        throw new Error('Invalid Google Sheet URL format');
                    }
                    
                    const sheetId = sheetIdMatch[1];
                    
                    // Extract gid (tab ID) if present
                    const gidMatch = sheetUrl.match(/gid=(\d+)/);
                    const gid = gidMatch ? gidMatch[1] : '0';
                    
                    // Build CSV export URL with gid
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    
                    // Try multiple CORS proxies
                    const proxies = [
                        (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                        (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                        (url) => url // Direct fetch as last resort
                    ];
                    
                    let text = null;
                    let lastError = null;
                    
                    for (const proxyFn of proxies) {
                        try {
                            const proxyUrl = proxyFn(csvUrl);
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 8000);
                            
                            const response = await fetch(proxyUrl, { 
                                signal: controller.signal,
                                headers: { 'Accept': 'text/csv,*/*' }
                            });
                            clearTimeout(timeoutId);
                            
                            text = await response.text();
                            
                            // Check if it looks like CSV data (not HTML error page)
                            if (!text.includes('<!DOCTYPE') && !text.includes('<html') && text.trim().length > 0) {
                                break; // Success!
                            }
                            text = null; // Reset and try next proxy
                        } catch (e) {
                            lastError = e;
                            continue;
                        }
                    }
                    
                    if (!text) {
                        throw new Error('Sheet not accessible. Make sure:\n1. Sharing is set to "Anyone with the link"\n2. The URL is correct');
                    }
                    
                    // Count rows
                    const rows = text.split('\n').filter(r => r.trim()).length;
                    
                    // Check first row for headers
                    const firstRow = text.split('\n')[0] || '';
                    const hasHeaders = firstRow.toLowerCase().includes('campaign') || 
                                      firstRow.toLowerCase().includes('advertiser') ||
                                      firstRow.toLowerCase().includes('date');
                    
                    setTestStatus('success');
                    setTestMessage(`‚úÖ Connected! Found ${rows} rows${gid !== '0' ? ` (tab gid=${gid})` : ''}.${hasHeaders ? ' Headers detected.' : ''}`);
                    
                } catch (err) {
                    setTestStatus('error');
                    setTestMessage(`‚ùå ${err.message || 'Connection failed'}`);
                }
            };
            
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-900 rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden border border-slate-700" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="px-6 py-4 border-b border-slate-700 bg-slate-800 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-500/20 rounded-lg">
                                    <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold text-white">Live Sync Settings</h2>
                                    <p className="text-xs text-slate-400">Configure Google Sheet connection</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        {/* Body */}
                        <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                            {/* Sheet URL Input */}
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Google Sheet URL</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text"
                                        value={sheetUrl}
                                        onChange={(e) => setSheetUrl(e.target.value)}
                                        placeholder="https://docs.google.com/spreadsheets/d/..."
                                        className="flex-1 px-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                    />
                                    <button 
                                        onClick={handleTest}
                                        disabled={testStatus === 'testing'}
                                        className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors disabled:opacity-50"
                                    >
                                        {testStatus === 'testing' ? 'Testing...' : 'Test'}
                                    </button>
                                </div>
                                {testMessage && (
                                    <p className={`mt-2 text-sm ${testStatus === 'success' ? 'text-green-400' : testStatus === 'error' ? 'text-red-400' : 'text-slate-400'}`}>
                                        {testMessage}
                                    </p>
                                )}
                            </div>
                            
                            {/* Required Google Sheet Settings */}
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                                    <span className="text-yellow-400">‚öôÔ∏è</span> Required Google Sheet Settings
                                </h3>
                                <ol className="space-y-2 text-sm text-slate-300">
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">1.</span>
                                        <span>Open your Google Sheet and click <strong className="text-white">Share</strong> (top right)</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">2.</span>
                                        <span>Under "General access", change from "Restricted" to <strong className="text-green-400">"Anyone with the link"</strong></span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">3.</span>
                                        <span>Set role to <strong className="text-white">"Viewer"</strong> (read-only is fine)</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-blue-400 font-bold">4.</span>
                                        <span>Click <strong className="text-white">Copy link</strong> and paste it above</span>
                                    </li>
                                </ol>
                            </div>
                            
                            {/* Required Columns */}
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                                    <span className="text-green-400">üìã</span> Required Columns
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">Your Google Sheet must have these column headers (case-insensitive):</p>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Campaign ID</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Advertiser</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Campaign Name</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-red-400">*</span> <span className="text-white font-mono">Product Start Date</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Product End Date</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Install Stage</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Market</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Quantity</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Installed</span>
                                    </div>
                                    <div className="bg-slate-900/50 rounded px-3 py-2">
                                        <span className="text-slate-500">‚óã</span> <span className="text-slate-300 font-mono">Product</span>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-2"><span className="text-red-400">*</span> = Required, <span className="text-slate-500">‚óã</span> = Optional</p>
                            </div>
                            
                            {/* Tips */}
                            <div className="bg-blue-500/10 rounded-xl p-4 border border-blue-500/30">
                                <h3 className="font-bold text-blue-400 mb-2 flex items-center gap-2">
                                    <span>üí°</span> Pro Tips
                                </h3>
                                <ul className="space-y-1 text-xs text-slate-300">
                                    <li>‚Ä¢ The first row must contain column headers</li>
                                    <li>‚Ä¢ Dates should be in MM/DD/YYYY or YYYY-MM-DD format</li>
                                    <li>‚Ä¢ The system auto-detects similar column names (e.g., "Start Date" ‚Üí "Product Start Date")</li>
                                    <li>‚Ä¢ Sheet must have at least one data row below headers</li>
                                    <li>‚Ä¢ If sync fails, it will fall back to your last uploaded CSV data</li>
                                </ul>
                            </div>

                            {/* Groq API Key */}
                            <div className="bg-gradient-to-r from-orange-500/10 to-red-500/10 rounded-xl p-4 border border-orange-500/30">
                                <h3 className="font-bold text-orange-400 mb-3 flex items-center gap-2">
                                    <span>ü§ñ</span> AI Features (Groq API)
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    Power AI analysis features with Groq's Llama 3.3 70B model. Get a free API key at <a href="https://console.groq.com/keys" target="_blank" rel="noopener" className="text-orange-400 hover:underline">console.groq.com/keys</a>
                                </p>
                                <div>
                                    <label className="block text-xs font-medium text-slate-400 mb-1">API Key</label>
                                    <input
                                        type="password"
                                        defaultValue={localStorage.getItem('stap_groq_api_key') || ''}
                                        onChange={(e) => localStorage.setItem('stap_groq_api_key', e.target.value)}
                                        placeholder="gsk_..."
                                        className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none font-mono"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">üîí Stored locally in your browser only</p>
                                </div>
                            </div>

                            {/* Production Proof Webhook Sync */}
                            <div className="bg-gradient-to-r from-teal-500/10 to-emerald-500/10 rounded-xl p-4 border border-teal-500/30">
                                <h3 className="font-bold text-teal-400 mb-3 flex items-center gap-2">
                                    <span>üîÑ</span> Production Proof Sync (Optional)
                                </h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    Sync production proof changes (In-House/Client/Mixed) back to your Google Sheet in real-time using Apps Script.
                                </p>
                                <div className="mb-3">
                                    <label className="block text-xs font-medium text-slate-400 mb-1">Webhook URL</label>
                                    <input
                                        type="text"
                                        defaultValue={localStorage.getItem('stap_proof_webhook') || ''}
                                        onChange={(e) => localStorage.setItem('stap_proof_webhook', e.target.value)}
                                        placeholder="https://script.google.com/macros/s/..."
                                        className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none"
                                    />
                                </div>
                                <details className="text-xs">
                                    <summary className="cursor-pointer text-teal-400 hover:text-teal-300 font-medium">
                                        üìã Apps Script Setup Instructions
                                    </summary>
                                    <div className="mt-3 p-3 bg-slate-900/70 rounded-lg border border-slate-700 space-y-2 text-slate-300">
                                        <p><strong className="text-white">1.</strong> Open your Google Sheet ‚Üí Extensions ‚Üí Apps Script</p>
                                        <p><strong className="text-white">2.</strong> Paste this code:</p>
                                        <pre className="bg-black/50 p-2 rounded text-[10px] overflow-x-auto font-mono text-green-400">{`function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  if (data.action === 'updateProof') {
    const sheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName('Master Export'); // Change to your sheet name
    const dataRange = sheet.getDataRange().getValues();
    const headers = dataRange[0];

    // Find column indices
    const idCol = headers.findIndex(h =>
      h.toLowerCase().includes('campaign id'));
    const proofCol = headers.findIndex(h =>
      h.toLowerCase().includes('production'));

    if (idCol === -1 || proofCol === -1) {
      return ContentService.createTextOutput(
        JSON.stringify({success: false, error: 'Columns not found'})
      );
    }

    // Find row and update
    const [campaignId, date] = data.campaignKey.split('_');
    for (let i = 1; i < dataRange.length; i++) {
      if (dataRange[i][idCol] == campaignId) {
        sheet.getRange(i + 1, proofCol + 1)
          .setValue(data.productionProof);
        break;
      }
    }

    return ContentService.createTextOutput(
      JSON.stringify({success: true})
    ).setMimeType(ContentService.MimeType.JSON);
  }
}`}</pre>
                                        <p><strong className="text-white">3.</strong> Deploy ‚Üí New deployment ‚Üí Web app</p>
                                        <p><strong className="text-white">4.</strong> Set "Execute as" = <span className="text-amber-400">Me</span>, "Who has access" = <span className="text-amber-400">Anyone</span></p>
                                        <p><strong className="text-white">5.</strong> Copy the deployment URL and paste above</p>
                                    </div>
                                </details>
                            </div>

                            {/* Backup & Restore Settings */}
                            <div className="bg-gradient-to-r from-purple-500/10 to-indigo-500/10 rounded-xl p-4 border border-purple-500/30">
                                <h3 className="font-bold text-purple-400 mb-3 flex items-center gap-2">
                                    <span>üíæ</span> Backup & Restore Settings
                                </h3>
                                <p className="text-xs text-slate-400 mb-4">
                                    Export your settings (Sheet URLs, Webhook, etc.) to a file. Restore them after clearing cache or on a new device.
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            // Gather all settings from localStorage
                                            const settings = {
                                                version: '1.0',
                                                exportDate: new Date().toISOString(),
                                                settings: {
                                                    // Main data source
                                                    googleSheetUrl: localStorage.getItem('stap_google_sheet_url') || '',
                                                    // Material Receiver
                                                    materialSheetUrl: localStorage.getItem('stap_material_sheet_url') || '',
                                                    materialWebhook: localStorage.getItem('stap_material_webhook') || '',
                                                    // POP Gallery
                                                    popSheetUrl: localStorage.getItem('stap_pop_sheet_url') || '',
                                                    // Mobile
                                                    mobileSheetUrl: localStorage.getItem('stap_mobile_sheet_url') || '',
                                                    // Production Proof Sync
                                                    proofWebhook: localStorage.getItem('stap_proof_webhook') || '',
                                                    // AI Features
                                                    groqApiKey: localStorage.getItem('stap_groq_api_key') || '',
                                                }
                                            };
                                            
                                            // Create and download file
                                            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `stap-settings-backup-${new Date().toISOString().split('T')[0]}.json`;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            URL.revokeObjectURL(url);
                                        }}
                                        className="flex-1 px-4 py-2.5 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Export Settings
                                    </button>
                                    <label className="flex-1 px-4 py-2.5 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                        </svg>
                                        Import Settings
                                        <input 
                                            type="file" 
                                            accept=".json"
                                            className="hidden"
                                            onChange={(e) => {
                                                const file = e.target.files?.[0];
                                                if (!file) return;
                                                
                                                const reader = new FileReader();
                                                reader.onload = (event) => {
                                                    try {
                                                        const data = JSON.parse(event.target.result);
                                                        
                                                        if (!data.settings) {
                                                            alert('Invalid settings file format');
                                                            return;
                                                        }
                                                        
                                                        // Restore settings to localStorage
                                                        const s = data.settings;
                                                        if (s.googleSheetUrl) localStorage.setItem('stap_google_sheet_url', s.googleSheetUrl);
                                                        if (s.materialSheetUrl) localStorage.setItem('stap_material_sheet_url', s.materialSheetUrl);
                                                        if (s.materialWebhook) localStorage.setItem('stap_material_webhook', s.materialWebhook);
                                                        if (s.popSheetUrl) localStorage.setItem('stap_pop_sheet_url', s.popSheetUrl);
                                                        if (s.mobileSheetUrl) localStorage.setItem('stap_mobile_sheet_url', s.mobileSheetUrl);
                                                        if (s.proofWebhook) localStorage.setItem('stap_proof_webhook', s.proofWebhook);
                                                        if (s.groqApiKey) localStorage.setItem('stap_groq_api_key', s.groqApiKey);

                                                        // Update current modal's sheet URL
                                                        if (s.googleSheetUrl) setSheetUrl(s.googleSheetUrl);
                                                        
                                                        alert(`‚úÖ Settings restored from ${data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'backup'}!\n\nPlease refresh the page to apply all settings.`);
                                                    } catch (err) {
                                                        alert('Failed to parse settings file: ' + err.message);
                                                    }
                                                };
                                                reader.readAsText(file);
                                                e.target.value = ''; // Reset input
                                            }}
                                        />
                                    </label>
                                </div>
                                <p className="text-xs text-slate-500 mt-2">
                                    üìÅ Settings saved: Sheets, Webhooks, Groq API Key
                                </p>
                            </div>
                        </div>
                        
                        {/* Footer */}
                        <div className="px-6 py-4 border-t border-slate-700 bg-slate-800 flex justify-between items-center">
                            <p className="text-xs text-slate-500">
                                üîí Your sheet URL is stored locally in your browser
                            </p>
                            <div className="flex gap-3">
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-400 hover:text-white transition-colors"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={handleSave}
                                    className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DigestModal = ({ isOpen, onClose, processedData, filterOptions, currentMarket }) => {
            const [htmlContent, setHtmlContent] = useState('');
            const [copied, setCopied] = useState(false);
            const [showSettings, setShowSettings] = useState(true); // Default open for visibility
            const [liveWeather, setLiveWeather] = useState([]);
            const [isLoadingWeather, setIsLoadingWeather] = useState(false);
            const recipient = 'agutierrez@vectormedia.com';

            // --- MULTI-SELECT FILTER STATE ---
            const [digestMarkets, setDigestMarkets] = useState([]);
            const [digestProducts, setDigestProducts] = useState([]);

            // --- SMART GROUPINGS (same as dashboard) ---
            const DIGEST_MARKET_GROUPS = {
                'West Coast': ['Los Angeles', 'San Francisco', 'Seattle', 'San Diego', 'Portland', 'Sacramento'],
                'East Coast': ['New York', 'Boston', 'Philadelphia', 'Washington', 'Baltimore', 'Newark'],
                'Southwest': ['Dallas', 'Houston', 'Phoenix', 'Austin', 'San Antonio', 'Denver'],
                'Southeast': ['Miami', 'Orlando', 'Atlanta', 'Tampa', 'Charlotte', 'Nashville'],
                'Midwest': ['Chicago', 'Detroit', 'Minneapolis', 'Cleveland', 'Indianapolis', 'Columbus']
            };
            
            const DIGEST_PRODUCT_GROUPS = {
                'All Digital': ['Digital Network', 'Digital Panel', 'Digital Domination', 'Digital'],
                'All Static Panels': ['Panel-Targeted', 'Panel-Network', 'Panel-Icon', 'Panel'],
                'Premium Units': ['Domination', 'Full Wrap', 'Embellishment', 'Icon']
            };

            // --- DIGEST SETTINGS STATE ---
            const [digestSettings, setDigestSettings] = useState({
                mainTitle: "Daily Operations Digest",
                showWeather: true,
                showProductColumn: true, // NEW: Toggle product column
                showMarketColumn: true,  // NEW: Toggle market column
                showOwnerColumn: true,   // NEW: Toggle owner column
                compactMode: false,      // NEW: Compact tables
                sections: {
                    summary: true,
                    delayed: true,
                    inProgress: true,
                    upcoming: true,
                    installed: true,
                    recent: true,
                    pipeline: true,
                    removal: true
                },
                titles: {
                    delayed: "Delayed or Overdue Flights",
                    inProgress: "In-Progress Flights",
                    upcoming: "Upcoming",
                    installed: "Installed this Week",
                    recent: "Recent Completed Installs",
                    pipeline: "Hold Pipeline Summary (This Month)",
                    removal: "Removal Dates (Past 45 days)"
                }
            });

            // Add/Remove filter helpers
            const addMarketFilter = (value) => {
                if (value && !digestMarkets.includes(value)) {
                    setDigestMarkets([...digestMarkets, value]);
                }
            };
            const removeMarketFilter = (value) => {
                setDigestMarkets(digestMarkets.filter(m => m !== value));
            };
            const addProductFilter = (value) => {
                if (value && !digestProducts.includes(value)) {
                    setDigestProducts([...digestProducts, value]);
                }
            };
            const removeProductFilter = (value) => {
                setDigestProducts(digestProducts.filter(p => p !== value));
            };
            const clearAllDigestFilters = () => {
                setDigestMarkets([]);
                setDigestProducts([]);
            };

            // Fetch live weather when market changes
            useEffect(() => {
                const loadWeather = async () => {
                    if (!isOpen) return;
                    setIsLoadingWeather(true);
                    try {
                        // Use first selected market or default
                        const marketForWeather = digestMarkets.length > 0 
                            ? digestMarkets[0] 
                            : (currentMarket || 'Los Angeles, CA');
                        const data = await fetchLiveWeather(marketForWeather);
                        setLiveWeather(data);
                    } catch (err) {
                        console.error('Weather fetch failed:', err);
                        setLiveWeather(WEATHER_FORECAST); // Fallback to static
                    }
                    setIsLoadingWeather(false);
                };
                loadWeather();
            }, [isOpen, digestMarkets, currentMarket]);

            // --- EDITABLE DIGEST DATA STATE ---
            const [editableData, setEditableData] = useState(null);
            const [deletedItems, setDeletedItems] = useState([]); // Track deleted items for undo/restore
            const [showAddModal, setShowAddModal] = useState(false);
            const [addModalSection, setAddModalSection] = useState(null);
            const [newEntry, setNewEntry] = useState({
                id: '', advertiser: '', name: '', market: '', product: '', owner: '', date: '', stage: '', progress: ''
            });

            // Filter processedData by markets and products (multi-select)
            const filteredDigestData = useMemo(() => {
                if (!processedData) return null;
                
                const hasMarketFilters = digestMarkets.length > 0;
                const hasProductFilters = digestProducts.length > 0;
                
                if (!hasMarketFilters && !hasProductFilters) {
                    return processedData;
                }

                // Check if item matches any of the selected markets
                const matchesMarket = (item) => {
                    if (!hasMarketFilters) return true;
                    return digestMarkets.some(filter => {
                        // Check if it's a region group
                        if (DIGEST_MARKET_GROUPS[filter]) {
                            const cities = DIGEST_MARKET_GROUPS[filter];
                            return cities.some(city => item.market?.toLowerCase().includes(city.toLowerCase()));
                        }
                        // Individual market match
                        return item.market === filter;
                    });
                };

                // Check if item matches any of the selected products
                const matchesProduct = (item) => {
                    if (!hasProductFilters) return true;
                    const itemProduct = item.product || item.media || '';
                    return digestProducts.some(filter => {
                        // Check if it's a product group
                        if (DIGEST_PRODUCT_GROUPS[filter]) {
                            const keywords = DIGEST_PRODUCT_GROUPS[filter];
                            return keywords.some(kw => itemProduct.toLowerCase().includes(kw.toLowerCase()));
                        }
                        // Individual product match
                        return itemProduct === filter;
                    });
                };

                const filterArray = (arr) => {
                    if (!arr) return [];
                    return arr.filter(item => matchesMarket(item) && matchesProduct(item));
                };

                // Recalculate pipeline summary based on filtered data
                const filteredAll = filterArray(processedData.all);
                const pipelineCounts = {};
                filteredAll.forEach(item => {
                    const stage = item.stage || 'Unknown';
                    pipelineCounts[stage] = (pipelineCounts[stage] || 0) + 1;
                });
                const filteredPipeline = Object.entries(pipelineCounts)
                    .map(([stage, count]) => ({ stage, count }))
                    .sort((a, b) => b.count - a.count);

                return {
                    ...processedData,
                    all: filteredAll,
                    upcoming: filterArray(processedData.upcoming),
                    delayedFlights: filterArray(processedData.delayedFlights),
                    inProgressFlights: filterArray(processedData.inProgressFlights),
                    fullyInstalledThisWeek: filterArray(processedData.fullyInstalledThisWeek),
                    recentInstalls: filterArray(processedData.recentInstalls),
                    expiredFlights: filterArray(processedData.expiredFlights),
                    pipelineSummary: filteredPipeline
                };
            }, [processedData, digestMarkets, digestProducts]);

            // Initialize editable data when filtered data changes
            useEffect(() => {
                if (filteredDigestData) {
                    setEditableData({
                        delayedFlights: [...(filteredDigestData.delayedFlights || [])],
                        inProgressFlights: [...(filteredDigestData.inProgressFlights || [])],
                        upcoming: [...(filteredDigestData.upcoming || [])],
                        fullyInstalledThisWeek: [...(filteredDigestData.fullyInstalledThisWeek || [])],
                        recentInstalls: [...(filteredDigestData.recentInstalls || [])],
                        expiredFlights: [...(filteredDigestData.expiredFlights || [])],
                        pipelineSummary: [...(filteredDigestData.pipelineSummary || [])]
                    });
                }
            }, [filteredDigestData]);

            // Delete row from a section (with undo support)
            const deleteRow = (section, index) => {
                const deletedItem = editableData[section][index];
                // Track the deleted item with its section and original index
                setDeletedItems(prev => [...prev, { 
                    item: deletedItem, 
                    section, 
                    originalIndex: index,
                    timestamp: Date.now()
                }]);
                setEditableData(prev => ({
                    ...prev,
                    [section]: prev[section].filter((_, i) => i !== index)
                }));
            };

            // Undo last delete
            const undoLastDelete = () => {
                if (deletedItems.length === 0) return;
                const lastDeleted = deletedItems[deletedItems.length - 1];
                setEditableData(prev => {
                    const sectionData = [...(prev[lastDeleted.section] || [])];
                    // Insert at original position or at end if position no longer valid
                    const insertIndex = Math.min(lastDeleted.originalIndex, sectionData.length);
                    sectionData.splice(insertIndex, 0, lastDeleted.item);
                    return {
                        ...prev,
                        [lastDeleted.section]: sectionData
                    };
                });
                setDeletedItems(prev => prev.slice(0, -1));
            };

            // Restore all deleted items
            const restoreAllDeleted = () => {
                if (deletedItems.length === 0) return;
                // Group by section and restore
                const restoredBySections = {};
                deletedItems.forEach(({ item, section }) => {
                    if (!restoredBySections[section]) {
                        restoredBySections[section] = [];
                    }
                    restoredBySections[section].push(item);
                });
                
                setEditableData(prev => {
                    const updated = { ...prev };
                    Object.entries(restoredBySections).forEach(([section, items]) => {
                        updated[section] = [...(prev[section] || []), ...items];
                    });
                    return updated;
                });
                setDeletedItems([]);
            };

            // Clear deleted items history (e.g., when closing modal)
            const clearDeletedHistory = () => {
                setDeletedItems([]);
            };

            // Reset deleted items when modal closes
            useEffect(() => {
                if (!isOpen) {
                    setDeletedItems([]);
                }
            }, [isOpen]);

            // Open add modal for a section
            const openAddModal = (section) => {
                setAddModalSection(section);
                setNewEntry({
                    id: 'MANUAL-' + Date.now(),
                    advertiser: '',
                    name: '',
                    market: 'Los Angeles - STAP',
                    product: 'Transit Shelters-Panel-Targeted',
                    owner: '',
                    date: new Date().toLocaleDateString(),
                    endDate: new Date().toLocaleDateString(),
                    stage: section === 'delayed' ? 'Material Ready' : 
                           section === 'inProgress' ? 'In-Progress' :
                           section === 'upcoming' ? 'Material Ready' :
                           section === 'installed' ? 'Installation Complete' :
                           section === 'recent' ? 'Installation Complete' :
                           section === 'removal' ? 'Expired' : 'Unknown',
                    progress: '50%',
                    isManual: true
                });
                setShowAddModal(true);
            };

            // Add new entry to section
            const addNewEntry = () => {
                if (!newEntry.advertiser) {
                    alert('Please enter an advertiser name');
                    return;
                }
                
                const sectionMap = {
                    'delayed': 'delayedFlights',
                    'inProgress': 'inProgressFlights',
                    'upcoming': 'upcoming',
                    'installed': 'fullyInstalledThisWeek',
                    'recent': 'recentInstalls',
                    'removal': 'expiredFlights'
                };
                
                const sectionKey = sectionMap[addModalSection];
                if (sectionKey) {
                    setEditableData(prev => ({
                        ...prev,
                        [sectionKey]: [...prev[sectionKey], { ...newEntry }]
                    }));
                }
                setShowAddModal(false);
            };

            // Reset edits to original filtered data
            const resetEdits = () => {
                if (filteredDigestData) {
                    setEditableData({
                        delayedFlights: [...(filteredDigestData.delayedFlights || [])],
                        inProgressFlights: [...(filteredDigestData.inProgressFlights || [])],
                        upcoming: [...(filteredDigestData.upcoming || [])],
                        fullyInstalledThisWeek: [...(filteredDigestData.fullyInstalledThisWeek || [])],
                        recentInstalls: [...(filteredDigestData.recentInstalls || [])],
                        expiredFlights: [...(filteredDigestData.expiredFlights || [])],
                        pipelineSummary: [...(filteredDigestData.pipelineSummary || [])]
                    });
                }
            };

            // Check if any manual edits have been made
            const hasManualEdits = useMemo(() => {
                if (!editableData || !filteredDigestData) return false;
                return (
                    editableData.delayedFlights?.length !== filteredDigestData.delayedFlights?.length ||
                    editableData.inProgressFlights?.length !== filteredDigestData.inProgressFlights?.length ||
                    editableData.upcoming?.length !== filteredDigestData.upcoming?.length ||
                    editableData.fullyInstalledThisWeek?.length !== filteredDigestData.fullyInstalledThisWeek?.length ||
                    editableData.recentInstalls?.length !== filteredDigestData.recentInstalls?.length ||
                    editableData.expiredFlights?.length !== filteredDigestData.expiredFlights?.length ||
                    editableData.delayedFlights?.some(item => item.isManual) ||
                    editableData.inProgressFlights?.some(item => item.isManual) ||
                    editableData.upcoming?.some(item => item.isManual) ||
                    editableData.fullyInstalledThisWeek?.some(item => item.isManual) ||
                    editableData.recentInstalls?.some(item => item.isManual) ||
                    editableData.expiredFlights?.some(item => item.isManual)
                );
            }, [editableData, filteredDigestData]);

            // Use editable data for HTML generation
            const dataForHtml = useMemo(() => {
                if (!editableData || !filteredDigestData) return filteredDigestData;
                return {
                    ...filteredDigestData,
                    delayedFlights: editableData.delayedFlights,
                    inProgressFlights: editableData.inProgressFlights,
                    upcoming: editableData.upcoming,
                    fullyInstalledThisWeek: editableData.fullyInstalledThisWeek,
                    recentInstalls: editableData.recentInstalls,
                    expiredFlights: editableData.expiredFlights,
                    pipelineSummary: editableData.pipelineSummary
                };
            }, [editableData, filteredDigestData]);

            useEffect(() => {
                if (isOpen && dataForHtml && liveWeather.length > 0) {
                    const html = generateDigestHtml(dataForHtml, liveWeather, digestSettings);
                    setHtmlContent(html);
                }
            }, [isOpen, dataForHtml, liveWeather, digestSettings]);

            // Copy Logic for Rich Text
            const handleCopy = () => {
                const type = 'text/html';
                const blob = new Blob([htmlContent], { type });
                const data = [new ClipboardItem({ [type]: blob })];
                
                navigator.clipboard.write(data).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => {
                    console.error(err);
                    alert('Could not copy directly. Please select the text in the preview and press Ctrl+C.');
                });
            };

            const handleOpenMailClient = () => {
                const filterParts = [];
                if (digestMarkets.length > 0) filterParts.push(digestMarkets.map(m => m.split(',')[0]).join(', '));
                if (digestProducts.length > 0) filterParts.push(digestProducts.join(', '));
                const filterSuffix = filterParts.length > 0 ? ` (${filterParts.join(' | ')})` : '';
                const subject = `LA STAP - ${digestSettings.mainTitle}${filterSuffix} - ${new Date().toLocaleDateString()}`;
                window.open(`mailto:${recipient}?subject=${encodeURIComponent(subject)}`, '_blank');
            };

            const toggleSection = (key) => {
                setDigestSettings(prev => ({
                    ...prev,
                    sections: { ...prev.sections, [key]: !prev.sections[key] }
                }));
            };

            const updateSectionTitle = (key, val) => {
                setDigestSettings(prev => ({
                    ...prev,
                    titles: { ...prev.titles, [key]: val }
                }));
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-[1400px] w-full overflow-hidden animate-scale-in flex flex-col h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <Icon name="Mail" size={20} className="text-blue-600" /> Daily Digest Preview
                                {(digestMarkets.length > 0 || digestProducts.length > 0) && (
                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">
                                        {filteredDigestData?.all?.length || 0} campaigns
                                    </span>
                                )}
                            </h3>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${showSettings ? 'bg-blue-100 text-blue-700' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                                >
                                    <Icon name="Sliders" size={16} /> Customize Template
                                </button>
                                <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-hidden relative flex">
                            {/* --- SETTINGS PANEL --- */}
                            {showSettings && (
                                <div className="w-96 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4 animate-fade-in flex flex-col gap-5 shadow-inner">
                                    {/* FILTER DATA - Multi-Select */}
                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="Filter" size={14} /> Filter Data
                                        </h4>
                                        
                                        {/* Market Multi-Select */}
                                        <div className="mb-3">
                                            <label className="block text-xs font-medium text-gray-600 mb-1">Markets</label>
                                            <select 
                                                value=""
                                                onChange={e => { if (e.target.value) addMarketFilter(e.target.value); }}
                                                className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                            >
                                                <option value="">+ Add Market Filter...</option>
                                                <optgroup label="üìç Regions">
                                                    {Object.keys(DIGEST_MARKET_GROUPS).map(region => (
                                                        <option key={region} value={region} disabled={digestMarkets.includes(region)}>
                                                            {region}
                                                        </option>
                                                    ))}
                                                </optgroup>
                                                <optgroup label="üìå Individual Markets">
                                                    {(filterOptions?.markets || []).map(m => (
                                                        <option key={m} value={m} disabled={digestMarkets.includes(m)}>
                                                            {m.split(',')[0]}
                                                        </option>
                                                    ))}
                                                </optgroup>
                                            </select>
                                            {/* Market Chips */}
                                            {digestMarkets.length > 0 && (
                                                <div className="flex flex-wrap gap-1 mt-2">
                                                    {digestMarkets.map(m => (
                                                        <span key={m} className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                                            <Icon name="MapPin" size={10} />
                                                            {DIGEST_MARKET_GROUPS[m] ? m : m.split(',')[0]}
                                                            <button onClick={() => removeMarketFilter(m)} className="hover:bg-blue-200 rounded-full p-0.5">
                                                                <Icon name="X" size={10} />
                                                            </button>
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Product Multi-Select */}
                                        <div className="mb-3">
                                            <label className="block text-xs font-medium text-gray-600 mb-1">Products / Media</label>
                                            <select 
                                                value=""
                                                onChange={e => { if (e.target.value) addProductFilter(e.target.value); }}
                                                className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                            >
                                                <option value="">+ Add Product Filter...</option>
                                                <optgroup label="üì¶ Categories">
                                                    {Object.keys(DIGEST_PRODUCT_GROUPS).map(cat => (
                                                        <option key={cat} value={cat} disabled={digestProducts.includes(cat)}>
                                                            {cat}
                                                        </option>
                                                    ))}
                                                </optgroup>
                                                <optgroup label="üìã Individual Products">
                                                    {(filterOptions?.products || []).map(p => (
                                                        <option key={p} value={p} disabled={digestProducts.includes(p)}>
                                                            {p.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                                        </option>
                                                    ))}
                                                </optgroup>
                                            </select>
                                            {/* Product Chips */}
                                            {digestProducts.length > 0 && (
                                                <div className="flex flex-wrap gap-1 mt-2">
                                                    {digestProducts.map(p => (
                                                        <span key={p} className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                                            <Icon name="Package" size={10} />
                                                            {p.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                                            <button onClick={() => removeProductFilter(p)} className="hover:bg-purple-200 rounded-full p-0.5">
                                                                <Icon name="X" size={10} />
                                                            </button>
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Filter Summary */}
                                        {(digestMarkets.length > 0 || digestProducts.length > 0) && (
                                            <div className="p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                                <p className="text-xs text-blue-700 font-medium flex items-center gap-1">
                                                    <Icon name="Filter" size={12} />
                                                    Showing {filteredDigestData?.all?.length || 0} of {processedData?.all?.length || 0} campaigns
                                                </p>
                                                <button 
                                                    onClick={clearAllDigestFilters}
                                                    className="text-xs text-red-600 hover:underline mt-1 font-medium"
                                                >
                                                    ‚úï Clear All Filters
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <hr className="border-gray-200" />

                                    {/* GENERAL SETTINGS */}
                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="Settings" size={14} /> General Settings
                                        </h4>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Email Title</label>
                                                <input 
                                                    type="text" 
                                                    value={digestSettings.mainTitle}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, mainTitle: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                />
                                            </div>
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.showWeather}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, showWeather: e.target.checked }))}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Show Weather Widget {isLoadingWeather && <span className="text-xs text-blue-500">(Loading...)</span>}
                                            </label>
                                        </div>
                                    </div>

                                    <hr className="border-gray-200" />

                                    {/* TABLE COLUMNS */}
                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="Columns" size={14} /> Table Columns
                                        </h4>
                                        <div className="space-y-2">
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.showProductColumn}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, showProductColumn: e.target.checked }))}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Show Product/Media Column
                                            </label>
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.showMarketColumn}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, showMarketColumn: e.target.checked }))}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Show Market Column
                                            </label>
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.showOwnerColumn}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, showOwnerColumn: e.target.checked }))}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Show Owner Column
                                            </label>
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.compactMode}
                                                    onChange={e => setDigestSettings(prev => ({ ...prev, compactMode: e.target.checked }))}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Compact Mode (smaller tables)
                                            </label>
                                        </div>
                                    </div>

                                    <hr className="border-gray-200" />

                                    {/* SECTIONS & TITLES */}
                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="Layout" size={14} /> Sections & Titles
                                        </h4>
                                        <div className="space-y-3">
                                            <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer font-medium">
                                                <input 
                                                    type="checkbox" 
                                                    checked={digestSettings.sections.summary}
                                                    onChange={() => toggleSection('summary')}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                Top Summary Grid
                                            </label>

                                            <hr className="border-gray-200" />

                                            {[
                                                { key: 'delayed', label: 'Delayed Flights', icon: 'Flame' },
                                                { key: 'inProgress', label: 'In-Progress Flights', icon: 'Rocket' },
                                                { key: 'upcoming', label: 'Upcoming Flights', icon: 'Sun' },
                                                { key: 'installed', label: 'Installed This Week', icon: 'Medal' },
                                                { key: 'recent', label: 'Recently Completed', icon: 'CheckSquare' },
                                                { key: 'pipeline', label: 'Pipeline Summary', icon: 'BarChart' },
                                                { key: 'removal', label: 'Removal Dates', icon: 'Lightbulb' },
                                            ].map(sec => (
                                                <div key={sec.key} className={`p-2 rounded-lg border transition-colors ${digestSettings.sections[sec.key] ? 'bg-white border-gray-200' : 'bg-gray-100 border-transparent opacity-60'}`}>
                                                    <label className="flex items-center gap-2 text-sm text-gray-900 font-medium cursor-pointer mb-1">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={digestSettings.sections[sec.key]}
                                                            onChange={() => toggleSection(sec.key)}
                                                            className="rounded text-blue-600 focus:ring-blue-500"
                                                        />
                                                        <Icon name={sec.icon} size={14} className="text-gray-500" />
                                                        {sec.label}
                                                    </label>
                                                    {digestSettings.sections[sec.key] && (
                                                        <input 
                                                            type="text"
                                                            value={digestSettings.titles[sec.key]}
                                                            onChange={e => updateSectionTitle(sec.key, e.target.value)}
                                                            className="w-full px-2 py-1 rounded border border-gray-200 text-xs text-gray-600 focus:border-blue-400 outline-none ml-6"
                                                            placeholder="Section Title..."
                                                        />
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <hr className="border-gray-200" />

                                    {/* MANUAL EDITS SECTION */}
                                    <div>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="Edit3" size={14} /> Manual Edits
                                        </h4>
                                        
                                        {hasManualEdits && (
                                            <div className="mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg">
                                                <p className="text-xs text-amber-700 font-medium flex items-center gap-1">
                                                    <Icon name="AlertCircle" size={12} />
                                                    You have unsaved manual edits
                                                </p>
                                                <button 
                                                    onClick={resetEdits}
                                                    className="text-xs text-amber-600 hover:underline mt-1 font-medium"
                                                >
                                                    ‚Ü∫ Reset to Original Data
                                                </button>
                                            </div>
                                        )}

                                        <p className="text-xs text-gray-500 mb-3">
                                            Add or remove rows from each section. Changes appear in the preview immediately.
                                        </p>

                                        <div className="space-y-2">
                                            {[
                                                { key: 'delayed', dataKey: 'delayedFlights', label: 'Delayed' },
                                                { key: 'inProgress', dataKey: 'inProgressFlights', label: 'In-Progress' },
                                                { key: 'upcoming', dataKey: 'upcoming', label: 'Upcoming' },
                                                { key: 'installed', dataKey: 'fullyInstalledThisWeek', label: 'Installed' },
                                                { key: 'recent', dataKey: 'recentInstalls', label: 'Recent' },
                                                { key: 'removal', dataKey: 'expiredFlights', label: 'Removal' },
                                            ].map(sec => (
                                                <div key={sec.key} className="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs font-medium text-gray-700">{sec.label}</span>
                                                        <span className="text-xs text-gray-400">
                                                            ({editableData?.[sec.dataKey]?.length || 0} rows)
                                                        </span>
                                                        {editableData?.[sec.dataKey]?.some(item => item.isManual) && (
                                                            <span className="text-[9px] bg-amber-100 text-amber-700 px-1 rounded">edited</span>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => openAddModal(sec.key)}
                                                        className="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"
                                                    >
                                                        <Icon name="Plus" size={12} /> Add
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- EDIT DATA PANEL (Middle) --- */}
                            {showSettings && editableData && (
                                <div className="w-80 bg-white border-r border-gray-200 overflow-y-auto flex flex-col">
                                    <div className="p-3 bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                                                <Icon name="List" size={16} /> Edit Rows
                                            </h4>
                                            {deletedItems.length > 0 && (
                                                <div className="flex items-center gap-1">
                                                    <button
                                                        onClick={undoLastDelete}
                                                        className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors flex items-center gap-1"
                                                        title="Undo last delete"
                                                    >
                                                        <Icon name="RotateCcw" size={12} /> Undo
                                                    </button>
                                                    <button
                                                        onClick={restoreAllDeleted}
                                                        className="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors flex items-center gap-1"
                                                        title={`Restore all ${deletedItems.length} deleted items`}
                                                    >
                                                        <Icon name="RefreshCw" size={12} /> All ({deletedItems.length})
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Click ‚úï to remove a row from the email
                                            {deletedItems.length > 0 && (
                                                <span className="text-amber-600 ml-1">‚Ä¢ {deletedItems.length} deleted</span>
                                            )}
                                        </p>
                                    </div>
                                    
                                    <div className="p-3 space-y-4 flex-1">
                                        {[
                                            { key: 'delayed', dataKey: 'delayedFlights', label: 'Delayed', color: 'red' },
                                            { key: 'inProgress', dataKey: 'inProgressFlights', label: 'In-Progress', color: 'blue' },
                                            { key: 'upcoming', dataKey: 'upcoming', label: 'Upcoming', color: 'amber' },
                                            { key: 'installed', dataKey: 'fullyInstalledThisWeek', label: 'Installed', color: 'green' },
                                            { key: 'recent', dataKey: 'recentInstalls', label: 'Recent', color: 'teal' },
                                            { key: 'removal', dataKey: 'expiredFlights', label: 'Removal', color: 'gray' },
                                        ].map(sec => digestSettings.sections[sec.key] && (
                                            <div key={sec.key}>
                                                <div className="flex items-center justify-between mb-2">
                                                    <h5 className={`text-xs font-bold text-${sec.color}-600 uppercase`}>{sec.label}</h5>
                                                    <span className="text-[10px] text-gray-400">{editableData?.[sec.dataKey]?.length || 0}</span>
                                                </div>
                                                <div className="space-y-1 max-h-40 overflow-y-auto">
                                                    {(editableData?.[sec.dataKey] || []).map((item, idx) => (
                                                        <div key={idx} className={`flex items-center justify-between p-1.5 rounded text-xs ${item.isManual ? 'bg-amber-50 border border-amber-200' : 'bg-gray-50'}`}>
                                                            <div className="truncate flex-1 mr-2">
                                                                <span className="font-medium text-gray-800">{item.advertiser}</span>
                                                                <span className="text-gray-400 ml-1">#{item.id?.slice(-6)}</span>
                                                                {item.isManual && <span className="ml-1 text-amber-600">(manual)</span>}
                                                            </div>
                                                            <button
                                                                onClick={() => deleteRow(sec.dataKey, idx)}
                                                                className="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded shrink-0"
                                                                title="Remove from email"
                                                            >
                                                                <Icon name="X" size={12} />
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {(editableData?.[sec.dataKey] || []).length === 0 && (
                                                        <p className="text-xs text-gray-400 italic py-2 text-center">No entries</p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* --- PREVIEW IFRAME --- */}
                            <div className="flex-1 bg-gray-100 relative">
                                <iframe 
                                    srcDoc={htmlContent} 
                                    className="w-full h-full border-0" 
                                    title="Email Preview"
                                />
                            </div>
                        </div>

                        {/* --- ADD ENTRY MODAL --- */}
                        {showAddModal && (
                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowAddModal(false)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <Icon name="Plus" size={20} className="text-blue-600" />
                                        Add Manual Entry
                                        <span className="text-xs font-normal text-gray-500 ml-2">
                                            ({addModalSection})
                                        </span>
                                    </h3>
                                    
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Advertiser *</label>
                                                <input 
                                                    type="text" 
                                                    value={newEntry.advertiser}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, advertiser: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="Company Name"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Campaign Name</label>
                                                <input 
                                                    type="text" 
                                                    value={newEntry.name}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, name: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="Campaign Name"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Market</label>
                                                <select 
                                                    value={newEntry.market}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, market: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                >
                                                    {(filterOptions?.markets || ['Los Angeles - STAP', 'New York, NY', 'Dallas, TX', 'Miami, FL', 'Chicago, IL']).map(m => (
                                                        <option key={m} value={m}>{m.split(',')[0]}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Media Type</label>
                                                <select 
                                                    value={newEntry.product}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, product: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                >
                                                    {(filterOptions?.products || ['Transit Shelters-Panel-Targeted', 'Transit Shelters-Panel-Network', 'Digital Network']).map(p => (
                                                        <option key={p} value={p}>{p.replace('Transit Shelters-', '').replace('Transit Shelter-', '')}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Owner</label>
                                                <input 
                                                    type="text" 
                                                    value={newEntry.owner}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, owner: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="Owner Name"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Date</label>
                                                <input 
                                                    type="text" 
                                                    value={newEntry.date}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, date: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="MM/DD/YY"
                                                />
                                            </div>
                                        </div>

                                        {addModalSection === 'inProgress' && (
                                            <div>
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Progress</label>
                                                <input 
                                                    type="text" 
                                                    value={newEntry.progress}
                                                    onChange={e => setNewEntry(prev => ({ ...prev, progress: e.target.value }))}
                                                    className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                    placeholder="e.g., 50%"
                                                />
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="flex justify-end gap-3 mt-6">
                                        <button 
                                            onClick={() => setShowAddModal(false)}
                                            className="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            onClick={addNewEntry}
                                            className="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700"
                                        >
                                            Add Entry
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white px-6 py-4 border-t border-gray-100 flex items-center justify-between shrink-0">
                            <p className="text-sm text-gray-500 italic flex items-center gap-1">
                                <Icon name="AlertTriangle" size={14} /> 
                                Tip: Copy here, then Paste into Outlook/Gmail.
                                {hasManualEdits && <span className="ml-2 text-amber-600 font-medium">(includes manual edits)</span>}
                            </p>
                            <div className="flex gap-3">
                                <button 
                                    onClick={handleCopy}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${copied ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    <Icon name={copied ? "CheckCircle" : "Copy"} size={18} />
                                    {copied ? 'Copied to Clipboard!' : '1. Copy Table'}
                                </button>
                                <button 
                                    onClick={handleOpenMailClient}
                                    className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm"
                                >
                                    <Icon name="Send" size={18} /> 2. Open Mail & Paste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const WeatherWidget = () => {
            const [weatherData, setWeatherData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedCity, setSelectedCity] = useState('Los Angeles, CA');
            const [currentCondition, setCurrentCondition] = useState({ temp: 72, condition: 'Clear', icon: 'Sun' });

            useEffect(() => {
                const loadWeather = async () => {
                    setIsLoading(true);
                    try {
                        const data = await fetchLiveWeather(selectedCity);
                        setWeatherData(data);
                        if (data && data.length > 0) {
                            setCurrentCondition({
                                temp: data[0].temp,
                                condition: data[0].condition,
                                icon: data[0].icon
                            });
                        }
                    } catch (e) {
                        console.error('Weather fetch failed:', e);
                        setWeatherData(WEATHER_FORECAST);
                        setCurrentCondition({ temp: 72, condition: 'Clear', icon: 'Sun' });
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadWeather();
            }, [selectedCity]);

            const cityName = selectedCity.split(',')[0];
            const displayData = weatherData.length > 0 ? weatherData.slice(0, 7) : WEATHER_FORECAST.slice(0, 7);

            return (
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl overflow-hidden text-white h-full">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold flex items-center gap-2">
                                    <Icon name={currentCondition.icon} size={24} className={currentCondition.icon === 'Sun' ? 'text-yellow-300' : 'text-gray-200'} /> 
                                    {cityName}
                                </h2>
                                <p className="text-blue-100 text-sm">7-Day Forecast {isLoading && <span className="animate-pulse">‚Ä¢ Loading...</span>}</p>
                            </div>
                            <div className="text-right">
                                <div className="flex items-center gap-2 justify-end">
                                    <span className="text-3xl font-bold">{currentCondition.temp}¬∞</span>
                                    <span className="text-sm font-medium bg-white/20 px-2 py-1 rounded">{currentCondition.condition}</span>
                                </div>
                                <span className="block text-sm text-blue-100 mt-1">Today</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {displayData.map((day, idx) => (
                                <div key={idx} className="flex flex-col items-center p-2 rounded-lg hover:bg-white/10 transition-colors">
                                    <span className="text-xs font-medium text-blue-100 mb-2">{day.day}</span>
                                    <Icon name={day.icon || 'Cloud'} size={24} className={`mb-2 ${day.icon === 'Sun' ? 'text-yellow-300' : day.icon === 'CloudRain' ? 'text-blue-200' : 'text-gray-200'}`} />
                                    <div className="flex items-center gap-1 mb-1">
                                        <span className="font-bold text-lg">{day.temp}¬∞</span>
                                    </div>
                                    <span className="text-[10px] text-blue-100 text-center leading-tight mb-1" title={day.condition || day.status}>{(day.condition || day.status || '').split(' ')[0]}</span>
                                    <div className="flex items-center gap-0.5 text-xs text-blue-200" title="Chance of Rain">
                                        <Icon name="CloudRain" size={10} />
                                        <span>{day.rainChance || day.rain || 0}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const HolidaysWidget = () => (
            <div className="bg-white rounded-2xl shadow-xl p-6 h-full border border-gray-100">
                <h3 className="text-gray-800 font-bold text-lg mb-4 flex items-center gap-2">
                    <div className="p-1.5 bg-red-100 rounded-lg text-red-600"><Icon name="Gift" size={18} /></div>
                    Upcoming Holidays
                </h3>
                <div className="space-y-4">
                    {UPCOMING_HOLIDAYS.map((h, i) => (
                        <div key={i} className="flex items-center gap-4 group">
                            <div className="w-12 h-12 rounded-xl bg-gray-50 flex flex-col items-center justify-center border border-gray-100 group-hover:border-red-200 group-hover:bg-red-50 transition-colors">
                                <span className="text-xs text-gray-500 uppercase font-bold group-hover:text-red-500">{h.date.split(' ')[0]}</span>
                                <span className="text-lg font-bold text-gray-800 group-hover:text-red-700">{h.date.split(' ')[1]}</span>
                            </div>
                            <div>
                                <h4 className="font-medium text-gray-900">{h.name}</h4>
                                <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{h.type}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const CustomizeModal = ({ isOpen, onClose, visibleKeys, onToggle, onReset, cardConfig, activeFilters, onClearFilters, customWidgets = [], onAddWidget, onEditWidget, onDeleteWidget }) => {
            if (!isOpen) return null;
            
            // Handle both old (market/product) and new (markets/products) filter formats
            const hasMarketFilters = activeFilters?.markets?.length > 0;
            const hasProductFilters = activeFilters?.products?.length > 0;
            const hasAnyFilters = hasMarketFilters || hasProductFilters;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <Icon name="Settings" size={20} /> Customize Dashboard
                            </h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full text-gray-500">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        
                        {/* Active Filters Section */}
                        {hasAnyFilters && (
                            <div className="px-6 py-3 bg-blue-50 border-b border-blue-100">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2 text-sm flex-wrap">
                                        <Icon name="Filter" size={14} className="text-blue-600" />
                                        <span className="text-blue-700 font-medium">Active Filters:</span>
                                        {hasMarketFilters && activeFilters.markets.map((m, i) => (
                                            <span key={`m-${i}`} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{m}</span>
                                        ))}
                                        {hasProductFilters && activeFilters.products.map((p, i) => (
                                            <span key={`p-${i}`} className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">{p}</span>
                                        ))}
                                    </div>
                                    <button 
                                        onClick={onClearFilters}
                                        className="text-xs text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <div className="p-6 max-h-[60vh] overflow-y-auto">
                            {/* Default Widgets Section */}
                            <p className="text-sm text-gray-500 mb-4">Select which cards you want to see on your dashboard.</p>
                            <div className="space-y-2 mb-6">
                                {Object.entries(cardConfig).map(([key, config]) => {
                                    const isVisible = visibleKeys.includes(key);
                                    return (
                                        <div 
                                            key={key} 
                                            onClick={() => onToggle(key)}
                                            className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isVisible ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-lg ${config.color.replace('text-', 'bg-').replace('600', '100')} ${config.color}`}>
                                                    <Icon name={config.icon} size={18} />
                                                </div>
                                                <span className="font-medium text-gray-800">{config.title.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')}</span>
                                            </div>
                                            <div className={isVisible ? "text-blue-600" : "text-gray-300"}>
                                                <Icon name={isVisible ? "Eye" : "EyeOff"} size={20} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Custom Widgets Section */}
                            <div className="border-t pt-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-semibold text-gray-800 flex items-center gap-2">
                                        <Icon name="Target" size={16} className="text-purple-600" />
                                        Custom Widgets
                                    </h4>
                                    <button
                                        onClick={onAddWidget}
                                        className="px-3 py-1.5 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-1"
                                    >
                                        <Icon name="Plus" size={14} /> New Widget
                                    </button>
                                </div>
                                
                                {customWidgets.length === 0 ? (
                                    <div className="text-center py-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                        <Icon name="Target" size={32} className="text-gray-300 mx-auto mb-2" />
                                        <p className="text-sm text-gray-500">No custom widgets yet</p>
                                        <p className="text-xs text-gray-400">Create widgets to track specific data</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {customWidgets.map(widget => (
                                            <div 
                                                key={widget.id} 
                                                className="flex items-center justify-between p-3 rounded-xl border border-purple-200 bg-purple-50/50"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg ${widget.color.replace('text-', 'bg-').replace('-600', '-100')} ${widget.color}`}>
                                                        <Icon name={widget.icon} size={18} />
                                                    </div>
                                                    <div>
                                                        <span className="font-medium text-gray-800">{widget.title}</span>
                                                        {widget.subtitle && <p className="text-xs text-gray-500">{widget.subtitle}</p>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <button 
                                                        onClick={() => onEditWidget(widget)}
                                                        className="p-2 hover:bg-purple-100 rounded-lg text-purple-600 transition-colors"
                                                        title="Edit"
                                                    >
                                                        <Icon name="Edit" size={16} />
                                                    </button>
                                                    <button 
                                                        onClick={() => onDeleteWidget(widget.id)}
                                                        className="p-2 hover:bg-red-100 rounded-lg text-red-500 transition-colors"
                                                        title="Delete"
                                                    >
                                                        <Icon name="X" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                            <button 
                                onClick={onReset}
                                className="text-sm text-red-600 hover:text-red-800 font-medium flex items-center gap-1"
                            >
                                <Icon name="RefreshCw" size={14} /> Reset to Default
                            </button>
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailModal = ({ item, onClose, onSave, onLogEmail }) => {
            const [editMode, setEditMode] = useState(false);
            const [newStage, setNewStage] = useState(item?.stage || '');
            const [emailDraft, setEmailDraft] = useState('');
            const [copyFeedback, setCopyFeedback] = useState("");
            
            // --- INSTALL COUNT EDITING ---
            const [editingInstallCount, setEditingInstallCount] = useState(false);
            const [newInstalledCount, setNewInstalledCount] = useState(0);
            
            // --- CUSTOM FIELDS ---
            const [customQty, setCustomQty] = useState('');
            const [customDesigns, setCustomDesigns] = useState('');
            const [customPhotosLink, setCustomPhotosLink] = useState('');
            const [customReceiverLink, setCustomReceiverLink] = useState('');
            
            // --- TEMPLATE LOGIC ---
            const [selectedTemplate, setSelectedTemplate] = useState('auto');
            const [issueReason, setIssueReason] = useState('');
            const [newEta, setNewEta] = useState('');
            const [missingType, setMissingType] = useState('instructions');
            const [deadlineDate, setDeadlineDate] = useState('End of Day Today');
            const [showInstallControls, setShowInstallControls] = useState(false);

            // --- ‚úÑ PASTE 1: NEW STATE & INVENTORY LOGIC ---
            const [materialBreakdown, setMaterialBreakdown] = useState([{ code: '', qty: '', link: '' }]);

            // Helper: Calculate if we have enough inventory
            const getInventoryStatus = () => {
                const required = parseFloat(customQty) || 0;
                const currentTotal = materialBreakdown.reduce((acc, row) => acc + (parseFloat(row.qty) || 0), 0);
                return { currentTotal, isSufficient: currentTotal >= required };
            };

            // Row Handlers
            const addRow = () => setMaterialBreakdown([...materialBreakdown, { code: '', qty: '', link: '' }]);
            const removeRow = (index) => {
                const newRows = materialBreakdown.filter((_, i) => i !== index);
                setMaterialBreakdown(newRows.length ? newRows : [{ code: '', qty: '', link: '' }]);
            };
            const updateRow = (index, field, value) => {
                const newRows = [...materialBreakdown];
                newRows[index][field] = value;
                setMaterialBreakdown(newRows);
            };

            useEffect(() => {
                if (item) {
                    setNewStage(item.stage);
                    setNewInstalledCount(item.totalInstalled || item.installed || 0);
                    setEditingInstallCount(false);
                    
                    // Load saved material data if exists
                    const uniqueKey = `${item.id}_${item.date}`;
                    const savedMaterialData = JSON.parse(localStorage.getItem('stap_material_data') || '{}');
                    const savedData = savedMaterialData[uniqueKey];
                    
                    if (savedData) {
                        // Restore previously saved data
                        setCustomQty(savedData.totalQty || item.quantity || item.totalQty || '0');
                        setCustomDesigns(savedData.mediaType || item.media || item.product || '');
                        setCustomPhotosLink(savedData.photosLink || '');
                        setCustomReceiverLink(savedData.receiverLink || '');
                        if (savedData.materialBreakdown && savedData.materialBreakdown.length > 0) {
                            setMaterialBreakdown(savedData.materialBreakdown);
                        } else {
                            setMaterialBreakdown([{ code: '', qty: '', link: '' }]);
                        }
                    } else {
                        // Reset to defaults from item
                        setCustomQty(item.quantity || item.totalQty || '0');
                        setCustomDesigns(item.media || item.product || '');
                        setCustomPhotosLink(''); 
                        setCustomReceiverLink('');
                        setMaterialBreakdown([{ code: '', qty: '', link: '' }]);
                    }
                    
                    setIssueReason(''); setNewEta('');
                    setSelectedTemplate('auto');
                    setShowInstallControls(true);
                }
            }, [item]);

            // --- TEMPLATE GENERATORS (Comprehensive Card View) ---
            // Helper to format media type nicely
            const formatMediaType = (media) => {
                if (!media) return 'N/A';
                return media.replace('Transit Shelter-', 'TS-').replace('Transit Shelters-', 'TS-').replace('Transit Buses-', 'Bus-');
            };
            
            // Helper to format market nicely
            const formatMarketName = (market) => {
                if (!market) return 'N/A';
                return market.split(',')[0].replace(' - STAP', '');
            };

            const generateScheduleTemplate = () => {
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);

                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#007bff; padding:12px 15px; color:white;'><strong style='font-size:16px;'>üìÖ Installation Scheduled</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>Work orders have been submitted for scheduling:</p>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Total Qty</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                        ${customReceiverLink ? `<p style='margin:15px 0 0;'><a href="${customReceiverLink}" style="color:#007bff;">üìÑ View Receiver PDF</a></p>` : ''}
                    </div>
                </div>`;
            };
            
            const generateCompletionTemplate = () => {
                const designCodes = materialBreakdown.filter(row => row.code).map(row => {
                    if (row.link) {
                        return `<a href="${row.link}" style="color:#28a745;" target="_blank">${row.code}</a>`;
                    }
                    return row.code;
                });

                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#28a745; padding:12px 15px; color:white;'><strong style='font-size:16px;'>‚úÖ Installation Complete</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>Great news! This campaign is now <strong>fully installed</strong>.</p>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Qty Installed</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong style="color:#28a745;">${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                        ${customPhotosLink ? `<p style='margin:15px 0 0;'><a href="${customPhotosLink}" style="background:#28a745; color:white; padding:10px 20px; text-decoration:none; border-radius:4px; display:inline-block;">üì∏ View Photos</a></p>` : ''}
                    </div>
                </div>`;
            };
            
            const generateMissingAssetsTemplate = () => {
                let missingText = missingType === 'instructions' ? "Posting Instructions" : missingType === 'material' ? "Creative Materials" : "Instructions & Materials";
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);

                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#dc3545; padding:12px 15px; color:white;'><strong style='font-size:16px;'>‚ö†Ô∏è HOLD ‚Äî Missing Assets</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 10px;'>This campaign is <strong>on hold</strong>. We are missing:</p>
                        <p style='margin:0 0 15px; padding:10px; background:#fff5f5; border-left:3px solid #dc3545; color:#c92a2a;'><strong>${missingText}</strong></p>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Total Qty</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                        <p style='margin:15px 0 0; padding:10px; background:#fff3cd; border-left:3px solid #ffc107; font-size:13px;'><strong>‚è∞ Deadline:</strong> ${deadlineDate}</p>
                    </div>
                </div>`;
            };

            const generateDelayTemplate = () => {
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);
                
                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#fd7e14; padding:12px 15px; color:white;'><strong style='font-size:16px;'>üöß Installation Delay</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>Please be advised of a schedule change for this campaign:</p>
                        <div style='margin:0 0 15px; padding:10px; background:#fff3cd; border-left:3px solid #fd7e14;'>
                            <strong>Reason:</strong> ${issueReason || 'Weather/Access'}<br/>
                            <strong>New Target:</strong> ${newEta || 'TBD'}
                        </div>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Total Qty</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>`;
            };
            
            const generateMaintenanceTemplate = () => {
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);
                
                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#20c997; padding:12px 15px; color:white;'><strong style='font-size:16px;'>üõ†Ô∏è Maintenance Resolved</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>Maintenance has been completed for this campaign:</p>
                        <p style='margin:0 0 15px; padding:10px; background:#e6fffa; border-left:3px solid #20c997; color:#0ca678;'><strong>Action Taken:</strong> ${issueReason || 'Repairs completed'}</p>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Total Qty</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                        ${customPhotosLink ? `<p style='margin:15px 0 0;'><a href="${customPhotosLink}" style="background:#20c997; color:white; padding:10px 20px; text-decoration:none; border-radius:4px; display:inline-block;">üì∏ View Photos</a></p>` : ''}
                    </div>
                </div>`;
            };
            
            const generateRemovalTemplate = () => {
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);
                
                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#6c757d; padding:12px 15px; color:white;'><strong style='font-size:16px;'>üóëÔ∏è Removal Confirmed</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>All materials have been removed for this campaign.</p>
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Total Qty</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${customQty}</strong> faces</td></tr>
                            ${designCodes.length > 0 ? `<tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Designs</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${designCodes.join(', ')}</td></tr>` : ''}
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>`;
            };

            // --- Material Received Template ---
            const generateMaterialReceivedTemplate = () => {
                const breakdownRows = materialBreakdown.map(row => {
                    const codeDisplay = row.link 
                        ? `<a href="${row.link}" style="color: #6f42c1; font-weight: bold; text-decoration: underline;" target="_blank">${row.code || 'N/A'}</a>`
                        : (row.code || 'N/A');
                    return `<tr><td style='padding:6px 10px; border-bottom:1px solid #eee;'>${codeDisplay}</td><td style='padding:6px 10px; border-bottom:1px solid #eee; text-align:right;'>${row.qty || 0}</td></tr>`;
                }).join('');

                const { isSufficient, currentTotal } = getInventoryStatus();
                const required = parseFloat(customQty) || 0;
                const overage = currentTotal - required;
                
                let statusColor, statusText, statusIcon;
                if (currentTotal >= required) {
                    statusColor = '#28a745';
                    statusIcon = '‚úÖ';
                    statusText = 'Inventory Sufficient';
                } else {
                    statusColor = '#dc3545';
                    statusIcon = '‚ùå';
                    statusText = 'Inventory Shortage';
                }
                
                const overageNote = currentTotal >= required 
                    ? (overage > 0 ? ` (+${overage} overage)` : '')
                    : ` (short ${required - currentTotal})`;
                
                const designCodes = materialBreakdown.filter(row => row.code).map(row => row.code);
                
                const noOverageNote = (currentTotal === required && currentTotal > 0) ? `
                    <p style='margin:10px 0; padding:8px; background:#fff8e6; border-left:3px solid #ffc107; font-size:12px; color:#856404;'>
                        üí° No overage included ‚Äî consider ordering backup material.
                    </p>
                ` : '';

                return `<div style='font-family:Arial,sans-serif; max-width:520px; color:#333;'>
                    <div style='background:#6f42c1; padding:12px 15px; color:white;'><strong style='font-size:16px;'>üì¶ Materials Received</strong></div>
                    <div style='padding:15px; background:#fff; border:1px solid #ddd; border-top:none;'>
                        <p style='margin:0 0 12px;'>Hi ${item.owner || 'Team'},</p>
                        <p style='margin:0 0 15px;'>Materials have landed in the warehouse and are being processed. Work orders are being drafted.</p>
                        
                        <p style='margin:0 0 15px; padding:10px; background:#f8f9fa; border-left:3px solid ${statusColor};'>
                            <strong>Inventory Status:</strong> ${statusIcon} ${statusText}${overageNote}<br/>
                            <span style="font-size:12px; color:#666;">Received: ${currentTotal} / Required: ${customQty}</span>
                        </p>
                        ${noOverageNote}
                        
                        ${breakdownRows ? `<table style='width:100%; font-size:12px; border-collapse:collapse; margin:0 0 15px; background:#faf8ff;'>
                            <tr style='background:#6f42c1; color:white;'><th style='padding:8px 10px; text-align:left;'>Design Code</th><th style='padding:8px 10px; text-align:right;'>Qty</th></tr>
                            ${breakdownRows}
                        </table>` : ''}
                        
                        <table style='width:100%; font-size:13px; border-collapse:collapse; background:#f8f9fa; border-radius:4px;'>
                            <tr><td style='padding:8px 10px; color:#666; width:110px; border-bottom:1px solid #eee;'>Advertiser</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${item.advertiser}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Campaign</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.id}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Flight Name</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.name || 'N/A'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Media Type</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'><strong>${formatMediaType(customDesigns)}</strong></td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Market</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${formatMarketName(item.market)}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666; border-bottom:1px solid #eee;'>Product Dates</td><td style='padding:8px 10px; border-bottom:1px solid #eee;'>${item.date} ‚Äî ${item.endDate || 'TBD'}</td></tr>
                            <tr><td style='padding:8px 10px; color:#666;'>Sales Owner</td><td style='padding:8px 10px;'>${item.owner || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>`;
            };

            // --- ‚úÑ PASTE 3: UPDATED ROUTER EFFECT ---
            useEffect(() => {
                if (!item) return;
                let mode = selectedTemplate;
                
                // Auto-detect logic (Optional: keep or replace your existing)
                if (mode === 'auto') {
                    if (item.stage === "Installed") mode = 'complete';
                    else if (item.stage === "Material Ready For Install") mode = 'material_received'; // <--- NEW DEFAULT
                    else if (item.stage.includes("Pending")) mode = 'missing';
                    else if (item.stage.includes("Expired") || item.stage.includes("Completed") || item.stage === "Takedown Complete") mode = 'removal';
                    else mode = 'schedule';
                }
                
                // Route to the correct template
                if (mode === 'material_received') setEmailDraft(generateMaterialReceivedTemplate()); // <--- NEW LINK
                else if (mode === 'schedule') setEmailDraft(generateScheduleTemplate());
                else if (mode === 'complete') setEmailDraft(generateCompletionTemplate());
                else if (mode === 'missing') setEmailDraft(generateMissingAssetsTemplate());
                else if (mode === 'delay') setEmailDraft(generateDelayTemplate());
                else if (mode === 'maintenance') setEmailDraft(generateMaintenanceTemplate());
                else if (mode === 'removal') setEmailDraft(generateRemovalTemplate());
            }, [customQty, selectedTemplate, item, materialBreakdown]); // Added materialBreakdown dependency

            const handleCopyToWebmail = async () => {
                try {
                    const blobHtml = new Blob([emailDraft], { type: "text/html" });
                    const blobText = new Blob([emailDraft], { type: "text/plain" });
                    const data = [new ClipboardItem({ ["text/html"]: blobHtml, ["text/plain"]: blobText })];
                    await navigator.clipboard.write(data);
                    
                    if(onLogEmail) onLogEmail(`${item.id}_${item.date}`);
                    setCopyFeedback("‚úÖ Copied!");
                    setTimeout(() => setCopyFeedback(""), 2000);
                } catch (err) { 
                    // Fallback to execCommand if clipboard API fails (iframe restriction)
                    try {
                        const listener = (e) => {
                             e.clipboardData.setData("text/html", emailDraft);
                             e.clipboardData.setData("text/plain", emailDraft);
                             e.preventDefault();
                        };
                        document.addEventListener("copy", listener);
                        document.execCommand("copy");
                        document.removeEventListener("copy", listener);
                        
                        if(onLogEmail) onLogEmail(`${item.id}_${item.date}`);
                        setCopyFeedback("‚úÖ Copied!");
                        setTimeout(() => setCopyFeedback(""), 2000);
                    } catch (e) {
                        setCopyFeedback("‚ùå Failed to copy");
                    }
                }
            };

            const handleSave = () => { 
                const uniqueKey = `${item.id}_${item.date}`;
                // Build comprehensive save object with all card data
                const saveData = { 
                    installed: newInstalledCount,
                    // Material & Design data
                    materialBreakdown: materialBreakdown.filter(row => row.code || row.qty),
                    photosLink: customPhotosLink || null,
                    receiverLink: customReceiverLink || null,
                    mediaType: customDesigns || null,
                    totalQty: customQty || null
                };
                onSave(uniqueKey, newStage, saveData); 
                setEditMode(false); 
                setEditingInstallCount(false);
            };
            
            const handleSaveInstallCount = () => {
                const uniqueKey = `${item.id}_${item.date}`;
                onSave(uniqueKey, item.stage, { installed: newInstalledCount });
                setEditingInstallCount(false);
            };
            
            // Save all card data without changing stage
            const handleSaveAllData = () => {
                const uniqueKey = `${item.id}_${item.date}`;
                const saveData = { 
                    installed: newInstalledCount,
                    materialBreakdown: materialBreakdown.filter(row => row.code || row.qty),
                    photosLink: customPhotosLink || null,
                    receiverLink: customReceiverLink || null,
                    mediaType: customDesigns || null,
                    totalQty: customQty || null
                };
                onSave(uniqueKey, item.stage, saveData);
                // Show feedback
                alert('‚úÖ Data saved! Material info synced to Material Receiver & POP Gallery.');
            };

            if (!item) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="px-8 py-6 border-b bg-gray-50 flex justify-between items-start">
                            <div>
                                <div className="flex items-center gap-3 mb-2">
                                    {editMode ? (
                                        <div className="flex items-center gap-2"><select value={newStage} onChange={(e) => setNewStage(e.target.value)} className="border rounded px-2">{ALL_STAGES.map(s => <option key={s}>{s}</option>)}</select><button onClick={handleSave} className="text-green-600"><Icon name="Save" size={18}/></button></div>
                                    ) : (
                                        <span onClick={() => setEditMode(true)} className={`px-3 py-1 rounded-full text-xs font-bold border cursor-pointer ${getStatusColor(item.stage, item.dateObj)}`}>{item.stage} <Icon name="Edit" size={10} className="inline ml-1 opacity-50"/></span>
                                    )}
                                    <span className="text-gray-400 text-xs font-mono">{item.id}</span>
                                </div>
                                <h2 className="text-2xl font-bold">{item.advertiser}</h2>
                                <h3 className="text-lg text-gray-600">{item.name}</h3>
                            </div>
                            <button onClick={onClose}><Icon name="X" size={24} /></button>
                        </div>

                        {/* Body */}
                        <div className="p-8 overflow-y-auto">
                            {/* Standard Data Grid */}
                            <div className="grid grid-cols-2 gap-6 mb-8">
                                <div className="bg-gray-50 p-4 rounded border"><h4 className="font-bold text-xs text-gray-500 mb-2">SCHEDULE</h4><p className="text-sm"><strong>Start:</strong> {item.date}</p><p className="text-sm"><strong>End:</strong> {item.endDate}</p></div>
                                <div className="bg-gray-50 p-4 rounded border">
                                    <h4 className="font-bold text-xs text-gray-500 mb-2">INSTALL PROGRESS</h4>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm"><strong>Booked Qty:</strong> {item.quantity || item.totalQty || 0}</span>
                                    </div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-sm"><strong>Installed:</strong></span>
                                        {editingInstallCount ? (
                                            <div className="flex items-center gap-1">
                                                <input 
                                                    type="number" 
                                                    value={newInstalledCount} 
                                                    onChange={(e) => setNewInstalledCount(parseInt(e.target.value) || 0)}
                                                    className="w-16 px-2 py-1 border rounded text-sm"
                                                    min="0"
                                                    max={item.quantity || item.totalQty || 999}
                                                />
                                                <button onClick={handleSaveInstallCount} className="text-green-600 hover:text-green-700" title="Save">
                                                    <Icon name="Check" size={16} />
                                                </button>
                                                <button onClick={() => { setEditingInstallCount(false); setNewInstalledCount(item.totalInstalled || item.installed || 0); }} className="text-gray-400 hover:text-gray-600" title="Cancel">
                                                    <Icon name="X" size={16} />
                                                </button>
                                            </div>
                                        ) : (
                                            <span 
                                                onClick={() => setEditingInstallCount(true)} 
                                                className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded cursor-pointer hover:bg-blue-200 transition-colors text-sm font-medium"
                                                title="Click to edit installed count"
                                            >
                                                {item.totalInstalled || item.installed || 0} <Icon name="Edit" size={10} className="inline ml-1 opacity-50"/>
                                            </span>
                                        )}
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm"><strong>Pending:</strong> <span className={item.pending > 0 ? 'text-orange-600 font-bold' : 'text-green-600'}>{item.pending || 0}</span></span>
                                    </div>
                                    {item.isOverridden && (
                                        <div className="mt-2 text-xs text-purple-600 flex items-center gap-1">
                                            <Icon name="Edit" size={10} /> Manual override active
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Production Proof Selector */}
                            <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className="font-bold text-sm text-gray-700 flex items-center gap-2">
                                            Production Source
                                            {item.productionProof && (
                                                <ProductionIcon type={item.productionProof} size={14} />
                                            )}
                                        </h4>
                                        <p className="text-xs text-gray-500">Who produced the creative materials?</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                const uniqueKey = `${item.id}_${item.date}`;
                                                onSave(uniqueKey, item.stage, { productionProof: 'in-house' });
                                            }}
                                            className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1 ${
                                                item.productionProof === 'in-house' 
                                                    ? 'bg-purple-600 text-white' 
                                                    : 'bg-white border border-purple-300 text-purple-700 hover:bg-purple-50'
                                            }`}
                                        >
                                            <Icon name="Home" size={12} /> In-House
                                        </button>
                                        <button
                                            onClick={() => {
                                                const uniqueKey = `${item.id}_${item.date}`;
                                                onSave(uniqueKey, item.stage, { productionProof: 'client' });
                                            }}
                                            className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1 ${
                                                item.productionProof === 'client' 
                                                    ? 'bg-blue-600 text-white' 
                                                    : 'bg-white border border-blue-300 text-blue-700 hover:bg-blue-50'
                                            }`}
                                        >
                                            <Icon name="Upload" size={12} /> Client
                                        </button>
                                        <button
                                            onClick={() => {
                                                const uniqueKey = `${item.id}_${item.date}`;
                                                onSave(uniqueKey, item.stage, { productionProof: 'mixed' });
                                            }}
                                            className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1 ${
                                                item.productionProof === 'mixed' 
                                                    ? 'bg-amber-600 text-white' 
                                                    : 'bg-white border border-amber-300 text-amber-700 hover:bg-amber-50'
                                            }`}
                                            title="Original from client, reprint from in-house (or vice versa)"
                                        >
                                            <Icon name="RefreshCw" size={12} /> Mixed
                                        </button>
                                    </div>
                                </div>
                                {/* Proof Link - Show if available */}
                                {item.proofLink && (
                                    <div className="mt-3 pt-3 border-t border-purple-200">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-gray-600">üìÑ Proof Document:</span>
                                            <a 
                                                href={item.proofLink.startsWith('http') ? item.proofLink : `https://${item.proofLink}`}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="text-xs text-purple-600 hover:text-purple-800 hover:underline flex items-center gap-1"
                                            >
                                                <Icon name="ExternalLink" size={12} />
                                                {item.proofLink.length > 50 ? item.proofLink.substring(0, 50) + '...' : item.proofLink}
                                            </a>
                                        </div>
                                    </div>
                                )}
                                {/* Auto-detection note */}
                                {item.productionProof === 'in-house' && item.proofLink && (
                                    <div className="mt-2 text-[10px] text-purple-500 flex items-center gap-1">
                                        <Icon name="Zap" size={10} /> Auto-detected from proof link in Google Sheet
                                    </div>
                                )}
                            </div>

                            {/* EMAIL GENERATOR UI */}
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-sm font-bold flex items-center gap-2"><Icon name="Bot" size={16} /> Comms Center</h4>
                                <select value={selectedTemplate} onChange={(e) => setSelectedTemplate(e.target.value)} className="text-xs border rounded px-2 py-1">
                                    <option value="auto">‚ú® Auto-Detect</option>
                                    <option value="schedule">üìÖ Scheduled</option>
                                    <option value="material_received">üì¶ Materials Landed</option>
                                    <option value="complete">‚úÖ Installed</option>
                                    <option value="missing">‚ö†Ô∏è Missing Assets</option>
                                    <option value="delay">üöß Delay Alert</option>
                                    <option value="maintenance">üõ†Ô∏è Maintenance</option>
                                    <option value="removal">üóëÔ∏è Removal</option>
                                </select>
                            </div>

                            {showInstallControls && (
                                <div className="mb-4 p-4 bg-gray-50 border rounded-lg">
                                    {/* Missing Asset Options */}
                                    {selectedTemplate === 'missing' && (
                                        <div className="mb-3 p-3 bg-red-50 border border-red-100 rounded">
                                            <div className="flex gap-4 mb-2 text-sm"><label><input type="radio" checked={missingType==='instructions'} onChange={()=>setMissingType('instructions')}/> Instructions</label><label><input type="radio" checked={missingType==='material'} onChange={()=>setMissingType('material')}/> Material</label><label><input type="radio" checked={missingType==='both'} onChange={()=>setMissingType('both')}/> Both</label></div>
                                            <input type="text" value={deadlineDate} onChange={(e)=>setDeadlineDate(e.target.value)} className="w-full text-sm border rounded px-2 py-1" placeholder="Deadline Date"/>
                                        </div>
                                    )}

                                    {/* --- ‚úÑ PASTE 4: DYNAMIC INVENTORY INPUTS --- */}
                                    {selectedTemplate === 'material_received' ? (
                                        <div className="mb-4 bg-gray-50 border rounded p-3">
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs font-bold text-gray-500">Inventory Breakdown</label>
                                                <span className="text-xs font-bold text-gray-400">Total: {getInventoryStatus().currentTotal}</span>
                                            </div>
                                            <div className="space-y-2 mb-2">
                                                {materialBreakdown.map((row, idx) => (
                                                    <div key={idx} className="flex gap-2">
                                                        <input 
                                                            placeholder="Design Code" 
                                                            value={row.code}
                                                            onChange={e => updateRow(idx, 'code', e.target.value)}
                                                            className="flex-1 text-sm border rounded px-2 py-1"
                                                        />
                                                        <input 
                                                            placeholder="Qty" 
                                                            type="number"
                                                            value={row.qty}
                                                            onChange={e => updateRow(idx, 'qty', e.target.value)}
                                                            className="w-16 text-sm border rounded px-2 py-1"
                                                        />
                                                        <input 
                                                            placeholder="Google Drive Link" 
                                                            value={row.link}
                                                            onChange={e => updateRow(idx, 'link', e.target.value)}
                                                            className="flex-1 text-sm border border-purple-200 rounded px-2 py-1"
                                                            title="Paste Google Drive link for poster image/PDF"
                                                        />
                                                        <button onClick={() => removeRow(idx)} className="text-red-400"><Icon name="X" size={16} /></button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={addRow} className="text-xs text-blue-600 font-bold hover:underline">+ Add Row</button>
                                        </div>
                                    ) : (
                                        /* KEEP YOUR EXISTING INPUTS HERE FOR OTHER TEMPLATES */
                                        <div className="grid grid-cols-2 gap-4 mb-3">
                                             <div><label className="text-xs font-bold text-gray-500">Total Flight Qty</label><input type="text" value={customQty} onChange={(e)=>setCustomQty(e.target.value)} className="w-full text-sm border rounded px-2 py-1"/></div>
                                             <div><label className="text-xs font-bold text-gray-500">Media Type</label><input type="text" value={customDesigns} readOnly className="w-full text-sm border rounded px-2 py-1 bg-gray-50 text-gray-600 cursor-not-allowed"/></div>
                                        </div>
                                    )}

                                    {/* Dynamic Inputs */}
                                    {(selectedTemplate === 'delay' || selectedTemplate === 'maintenance') && <div className="mb-3"><label className="text-xs font-bold">Reason/Action</label><input type="text" value={issueReason} onChange={(e)=>setIssueReason(e.target.value)} className="w-full text-sm border rounded px-2 py-1" placeholder="Details..."/></div>}
                                    {selectedTemplate === 'delay' && <div className="mb-3"><label className="text-xs font-bold">New Date</label><input type="text" value={newEta} onChange={(e)=>setNewEta(e.target.value)} className="w-full text-sm border rounded px-2 py-1"/></div>}
                                    
                                    {/* Photos & Receiver Links - Always visible */}
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <div><label className="text-xs font-bold text-green-700">üì∏ Photos Link</label><input type="text" value={customPhotosLink} onChange={(e)=>setCustomPhotosLink(e.target.value)} className="w-full text-sm border border-green-200 rounded px-2 py-1" placeholder="POP folder URL..."/></div>
                                        <div><label className="text-xs font-bold text-blue-700">üìÑ Receiver Link</label><input type="text" value={customReceiverLink} onChange={(e)=>setCustomReceiverLink(e.target.value)} className="w-full text-sm border border-blue-200 rounded px-2 py-1" placeholder="Receiver PDF URL..."/></div>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <button onClick={handleCopyToWebmail} className="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded flex justify-center gap-2 hover:bg-blue-700"><Icon name="Copy" size={16}/> {copyFeedback || "Copy Email"}</button>
                                        <button onClick={handleSaveAllData} className="px-4 py-2 bg-green-600 text-white font-bold rounded flex justify-center gap-2 hover:bg-green-700" title="Save to Material Receiver & POP Gallery"><Icon name="Save" size={16}/> Save</button>
                                    </div>
                                </div>
                            )}

                            {/* PREVIEW */}
                            <div className="border rounded bg-white p-4 h-64 overflow-y-auto">
                                <div dangerouslySetInnerHTML={{ __html: emailDraft }} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const FileUploader = ({ title, onFileSelect, status }) => (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors relative bg-white">
                <input 
                    type="file" 
                    accept=".csv"
                    onChange={(e) => onFileSelect(e.target.files[0])}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <div className="flex flex-col items-center gap-2">
                    <div className={`p-2 rounded-full ${status === 'done' ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>
                        <Icon name={status === 'done' ? 'CheckCircle' : 'UploadCloud'} size={20} />
                    </div>
                    <h3 className="font-semibold text-gray-700 text-sm">{title}</h3>
                    <p className="text-xs text-gray-500">{status === 'done' ? 'File Loaded' : 'Click or drag CSV here'}</p>
                </div>
            </div>
        );

        const StatCard = ({ title, value, subtitle, color, icon, onClick }) => (
            <div 
                onClick={onClick}
                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between hover:shadow-md transition-shadow cursor-pointer group"
            >
                <div>
                    <p className="text-sm font-medium text-gray-500 mb-1 group-hover:text-gray-700 transition-colors">{title}</p>
                    <h2 className="text-3xl font-bold text-gray-800">{typeof value === 'number' ? value.toLocaleString() : value}</h2>
                    {subtitle && <p className={`text-xs mt-2 font-medium ${color}`}>{subtitle}</p>}
                </div>
                <div className={`p-3 rounded-lg ${color.replace('text-', 'bg-').replace('600', '100').replace('500', '100')} ${color}`}>
                    <Icon name={icon} size={24} />
                </div>
            </div>
        );

        const MasterTrackingTable = ({ data, onRowClick, onBack, onOpenSettings }) => {
            // Column visibility state
            const [visibleCols, setVisibleCols] = useState({
                date: true, id: true, market: true, advertiser: true, campaign: true,
                product: true, stage: true, progress: true, pending: true,
                firstInstall: false, completion: false, status: true
            });
            const [showColMenu, setShowColMenu] = useState(false);
            const [compactMode, setCompactMode] = useState(true); // Default to compact
            
            // Hidden settings gear - requires 5 clicks to open
            const settingsClickRef = useRef({ count: 0, timer: null });
            const handleSettingsClick = () => {
                settingsClickRef.current.count++;
                
                // Clear existing timer
                if (settingsClickRef.current.timer) {
                    clearTimeout(settingsClickRef.current.timer);
                }
                
                // Reset after 3 seconds of no clicks
                settingsClickRef.current.timer = setTimeout(() => {
                    settingsClickRef.current.count = 0;
                }, 3000);
                
                // Open settings on 5th click
                if (settingsClickRef.current.count >= 5) {
                    settingsClickRef.current.count = 0;
                    if (onOpenSettings) onOpenSettings();
                }
            };

            const downloadCSV = () => {
                const headers = ["Product Start Date", "Campaign Number", "Market", "Advertiser", "Campaign", "Product", "Inventory Opportunity Stage", "Progress", "Quantity", "Installed", "Pending", "First Install", "Completion"];
                const rows = data.map(row => [`"${row.rawDate || row.date || ''}"`, `"${row.id}"`, `"${row.market || ''}"`, `"${row.advertiser}"`, `"${row.name}"`, `"${row.product}"`, `"${row.stage}"`, `"${row.progress}"`, row.totalQty || row.quantity, row.totalInstalled || row.installed, row.pending, `"${row.firstInstall || ''}"`, `"${row.completion || ''}"`]);
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Master_Tracking_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const toggleCol = (col) => setVisibleCols(prev => ({ ...prev, [col]: !prev[col] }));
            
            const colLabels = {
                date: 'Start Date', id: 'ID', market: 'Market', advertiser: 'Advertiser',
                campaign: 'Campaign', product: 'Product', stage: 'Stage', progress: 'Progress',
                pending: 'Pending', firstInstall: 'First Install', completion: 'Completion', status: 'Status'
            };

            // Dynamic cell padding based on compact mode
            const cellPad = compactMode ? 'px-2 py-1.5' : 'px-4 py-3';
            const fontSize = compactMode ? 'text-xs' : 'text-sm';

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="px-4 py-3 border-b border-gray-100 flex flex-wrap justify-between items-center bg-gray-50 gap-2">
                    <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                    {onBack && (
                        <button onClick={onBack} className="p-1 hover:bg-gray-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                            <Icon name="ArrowLeft" size={18} />
                        </button>
                    )}
                    <Icon name="Settings" size={18} className="text-purple-600" />
                    Installations
                    <span className="text-xs text-gray-500 font-normal ml-1">‚Äî Click any row to update</span>
                    <span className="bg-purple-100 text-purple-700 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                    </h3>
                    <div className="flex items-center gap-2">
                        {/* Settings Gear - Hidden feature, requires 5 clicks to open */}
                        {onOpenSettings && (
                            <button 
                                onClick={handleSettingsClick}
                                className="p-1.5 hover:bg-gray-200 rounded-lg transition-colors text-gray-500 hover:text-gray-700"
                                title="Settings"
                            >
                                <Icon name="Settings" size={16} />
                            </button>
                        )}
                        {/* Compact Mode Toggle */}
                        <button 
                            onClick={() => setCompactMode(!compactMode)}
                            className={`flex items-center gap-1 text-xs font-medium px-2 py-1 rounded transition-colors ${compactMode ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            title="Toggle compact view"
                        >
                            <Icon name={compactMode ? "Minimize2" : "Maximize2"} size={12} />
                            {compactMode ? 'Compact' : 'Full'}
                        </button>
                        
                        {/* Column Visibility Menu */}
                        <div className="relative">
                            <button 
                                onClick={() => setShowColMenu(!showColMenu)}
                                className="flex items-center gap-1 text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
                            >
                                <Icon name="Columns" size={12} /> Columns
                            </button>
                            {showColMenu && (
                                <div className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-30 p-2 w-44">
                                    {Object.entries(colLabels).map(([key, label]) => (
                                        <label key={key} className="flex items-center gap-2 px-2 py-1 hover:bg-gray-50 rounded cursor-pointer text-xs">
                                            <input 
                                                type="checkbox" 
                                                checked={visibleCols[key]} 
                                                onChange={() => toggleCol(key)}
                                                className="rounded text-purple-600"
                                            />
                                            {label}
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <button onClick={downloadCSV} className="flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded transition-colors">
                            <Icon name="Download" size={12} /> CSV
                        </button>
                    </div>
                </div>
                
                {/* Click outside to close menu */}
                {showColMenu && <div className="fixed inset-0 z-20" onClick={() => setShowColMenu(false)} />}
                
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse" style={{ minWidth: compactMode ? '800px' : '1200px' }}>
                    <thead>
                        <tr className={`${compactMode ? 'text-[10px]' : 'text-xs'} font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider`}>
                        {visibleCols.date && <th className={`${cellPad} sticky left-0 bg-gray-50 z-10`}>Date</th>}
                        {visibleCols.id && <th className={`${cellPad} ${visibleCols.date ? '' : 'sticky left-0 bg-gray-50 z-10'}`}>ID</th>}
                        {visibleCols.market && <th className={cellPad}>Market</th>}
                        {visibleCols.advertiser && <th className={cellPad}>Advertiser</th>}
                        {visibleCols.campaign && <th className={cellPad}>Campaign</th>}
                        {visibleCols.product && <th className={cellPad}>Product</th>}
                        {visibleCols.stage && <th className={cellPad}>Stage</th>}
                        {visibleCols.progress && <th className={cellPad}>Progress</th>}
                        {visibleCols.pending && <th className={`${cellPad} text-center`}>Pend</th>}
                        {visibleCols.firstInstall && <th className={cellPad}>1st Install</th>}
                        {visibleCols.completion && <th className={cellPad}>Complete</th>}
                        {visibleCols.status && <th className={`${cellPad} text-right`}>Status</th>}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {data.map((row, idx) => (
                        <tr 
                            key={idx} 
                            onClick={() => onRowClick(row)}
                            className={`hover:bg-gray-50 transition-colors cursor-pointer ${row.isComplete ? 'bg-green-50/30' : ''} ${row.isGhost ? 'bg-orange-50' : ''}`}
                        >
                            {visibleCols.date && <td className={`${cellPad} ${fontSize} text-gray-600 whitespace-nowrap sticky left-0 bg-white ${row.isComplete ? 'bg-green-50/30' : ''} ${row.isGhost ? 'bg-orange-50' : ''}`}>{row.rawDate || row.date}</td>}
                            {visibleCols.id && <td className={`${cellPad} text-[10px] font-mono text-gray-500 ${!visibleCols.date ? 'sticky left-0 bg-white' : ''}`}>{row.id}</td>}
                            {visibleCols.market && <td className={`${cellPad} ${fontSize}`}>
                                {row.market ? (
                                    <span className="px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded text-[10px]">{row.market.split(',')[0]}</span>
                                ) : (
                                    <span className="text-gray-300">-</span>
                                )}
                            </td>}
                            {visibleCols.advertiser && <td className={`${cellPad} font-medium text-gray-900 ${fontSize}`}>
                                {row.advertiser}
                                {row.isGhost && <span className="ml-1" title={row.ghostReason || 'Ghost Booking'}>üëª</span>}
                            </td>}
                            {visibleCols.campaign && <td className={`${cellPad} ${fontSize} text-gray-600 max-w-[150px] truncate`} title={row.name}>
                                {row.name}
                                {row.isOverridden && <span className="ml-1 text-blue-500">‚úé</span>}
                                {row.hasBonus && <span className="ml-1 px-1 bg-purple-100 text-purple-700 rounded text-[9px]" title={row.bonusNote}>+B</span>}
                            </td>}
                            {visibleCols.product && <td className={`${cellPad} ${fontSize} text-gray-600 max-w-[120px] truncate`} title={row.product}>{row.product}</td>}
                            {visibleCols.stage && <td className={cellPad}>
                                <span className={`px-1.5 py-0.5 rounded text-[10px] border ${getStatusColor(row.stage, row.dateObj)}`}>
                                    {row.stage}
                                </span>
                            </td>}
                            {visibleCols.progress && <td className={`${cellPad} ${fontSize} font-mono`}>{row.progress}</td>}
                            {visibleCols.pending && <td className={`${cellPad} text-center font-bold ${fontSize}`}>
                                {row.pending > 0 ? <span className="text-orange-600">{row.pending}</span> : <span className="text-gray-300">-</span>}
                            </td>}
                            {visibleCols.firstInstall && <td className={`${cellPad} ${fontSize} font-mono text-gray-600 whitespace-nowrap`}>{row.firstInstall || '-'}</td>}
                            {visibleCols.completion && <td className={`${cellPad} ${fontSize} font-mono text-gray-600 whitespace-nowrap`}>{row.completion || '-'}</td>}
                            {visibleCols.status && <td className={`${cellPad} text-right`}>
                                <div className="flex items-center justify-end gap-1">
                                    {row.isComplete ? (
                                        <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded ${compactMode ? 'text-[10px]' : 'text-xs'} bg-green-100 text-green-700 font-medium`}>
                                            <Icon name="CheckCircle" size={compactMode ? 10 : 12} /> Done
                                        </span>
                                    ) : (
                                        <span className={`inline-flex items-center px-1.5 py-0.5 rounded ${compactMode ? 'text-[10px]' : 'text-xs'} bg-gray-100 text-gray-600`}>
                                            Active
                                        </span>
                                    )}
                                    {/* Production Proof Icon - only show if set */}
                                    {row.productionProof && (
                                        <ProductionIcon type={row.productionProof} size={12} compact />
                                    )}
                                </div>
                            </td>}
                        </tr>
                        ))}
                    </tbody>
                    </table>
                </div>
                </div>
            );
        };

        const CampaignTable = ({ data, title, onRowClick, dateLabel = "Start Date", dateKey = "date", view, onBack }) => {
            const downloadCSV = () => {
                // Always use just Qty - never use "X / X" format (Excel misreads as dates)
                const qtyHeader = view === 'expiredFlights' ? 'Removal Qty' : 'Qty';
                
                const headers = ["Stage", "Advertiser", "Campaign", "Product", "Market", dateLabel, qtyHeader, "ID"];
                const rows = data.map(row => {
                    // Always use Qty (booked), not "Installed / Qty" format
                    const qtyValue = row.quantity || row.totalQty || 0;
                    
                    return [
                        `"${row.stage || ''}"`, 
                        `"${row.advertiser || ''}"`, 
                        `"${row.name || ''}"`, 
                        `"${(row.product || row.media || '').replace('Transit Shelters-', '').replace('Transit Shelter-', '').replace('Transit Buses-', '')}"`,
                        `"${row.market || ''}"`,
                        `"${row[dateKey] || ''}"`, 
                        qtyValue,
                        `"${row.id || ''}"`
                    ];
                });
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                    <div className="text-gray-400 mb-2 inline-block"><Icon name="Layers" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No campaigns found</h3>
                    <p className="text-gray-500 text-sm">No data matches your current filter.</p>
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
                    <div className="px-6 py-3 border-b bg-gray-50 flex justify-between items-center">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2 text-sm">
                            {onBack && view !== 'dashboard' && (
                                <button onClick={onBack} className="p-1 hover:bg-gray-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={16} />
                                </button>
                            )}
                            {/* Title icon based on view */}
                            {view === 'dashboard' && <Icon name="Calendar" size={16} className="text-blue-500" />}
                            {view === 'upcoming' && <Icon name="Sun" size={16} className="text-amber-500" />}
                            {view === 'recentInstalls' && <Icon name="CheckCircle" size={16} className="text-green-500" />}
                            {view === 'activeInstalls' && <Icon name="Hammer" size={16} className="text-orange-500" />}
                            {view === 'inProgressFlights' && <Icon name="Rocket" size={16} className="text-blue-500" />}
                            {view === 'delayedFlights' && <Icon name="Flame" size={16} className="text-red-500" />}
                            {view === 'onHoldCampaigns' && <Icon name="PauseCircle" size={16} className="text-gray-500" />}
                            {view === 'fullyInstalledThisWeek' && <Icon name="Award" size={16} className="text-yellow-500" />}
                            {view === 'rotations' && <Icon name="RefreshCw" size={16} className="text-purple-500" />}
                            {view === 'materialReadyFuture' && <Icon name="Package" size={16} className="text-teal-500" />}
                            {view === 'expiredFlights' && <Icon name="Lightbulb" size={16} className="text-amber-500" />}
                            {view === 'pastDue' && <Icon name="AlertTriangle" size={16} className="text-orange-500" />}
                            {view?.startsWith('custom_') && <Icon name="Star" size={16} className="text-purple-500" />}
                            {(title || '').replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/gu, '').trim()}
                            <span className="bg-gray-200 text-gray-600 text-[10px] py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <button onClick={downloadCSV} className="text-blue-600 text-xs flex gap-1.5 font-medium hover:text-blue-800 transition-colors">
                            <Icon name="Download" size={14}/> CSV
                        </button>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse table-fixed min-w-[1100px]">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-[10px] font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-2 py-2 w-[120px]">Stage</th>
                                    <th className="px-2 py-2 w-[115px]">Advertiser</th>
                                    <th className="px-2 py-2 w-[240px]">Campaign</th>
                                    <th className="px-2 py-2 w-[110px]">Product</th>
                                    <th className="px-2 py-2 w-[120px]">Market</th>
                                    <th className="px-2 py-2 w-[70px]">{dateLabel}</th>
                                    <th className="px-2 py-2 text-center w-[36px]" title="In-House Installation"><Icon name="Home" size={12} /></th>
                                    <th className="px-2 py-2 text-right w-[45px]">Qty</th>
                                    <th className="px-2 py-2 text-right w-[90px]">ID</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick(row)} className={`hover:bg-blue-50 cursor-pointer transition-colors ${row.isGhost ? 'bg-orange-50' : ''}`}>
                                        <td className="px-2 py-2">
                                            <div className="flex items-center gap-1 flex-wrap">
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] border whitespace-nowrap ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage || 'No Stage'}</span>
                                                {row.emailSentCount > 0 && (
                                                    <div className="flex items-center gap-0.5 px-1 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200" title="Emails sent">
                                                        <Icon name="Mail" size={8}/>
                                                        <span className="text-[8px] font-bold">{row.emailSentCount}</span>
                                                    </div>
                                                )}
                                                {row.isGhost && (
                                                    <span className="px-1 py-0.5 bg-orange-100 text-orange-700 rounded text-[8px] font-bold" title={row.ghostReason || 'Ghost Booking'}>üëª</span>
                                                )}
                                                {row.hasBonus && (
                                                    <span className="px-1 py-0.5 bg-purple-100 text-purple-700 rounded text-[8px]" title={row.bonusNote}>+B</span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-2 py-2 text-xs font-medium text-gray-900 truncate" title={row.advertiser}>{row.advertiser}</td>
                                        <td className="px-2 py-2 text-xs text-gray-600 truncate" title={row.name}>{row.name}</td>
                                        <td className="px-2 py-2">
                                            {row.product ? (
                                                <span className="px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded text-[10px] block truncate" title={row.product}>
                                                    {row.product.replace('Transit Shelters-', '').replace('Transit Shelter-', '').replace('Transit Buses-', '')}
                                                </span>
                                            ) : (
                                                <span className="text-gray-300 text-xs">-</span>
                                            )}
                                        </td>
                                        <td className="px-2 py-2">
                                            {row.market ? (
                                                <span className="px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded text-[10px] block truncate" title={row.market}>{row.market}</span>
                                            ) : (
                                                <span className="text-gray-300 text-xs">-</span>
                                            )}
                                        </td>
                                        <td className="px-2 py-2 text-xs text-gray-600 whitespace-nowrap">{row[dateKey]}</td>
                                        <td className="px-2 py-2 text-center">
                                            {row.productionProof === 'in-house' ? (
                                                <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-teal-100 text-teal-600" title="In-House Installation">
                                                    <Icon name="Home" size={12} />
                                                </span>
                                            ) : (
                                                <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 text-gray-400" title="Outsourced / Client-Produced">
                                                    <Icon name="ExternalLink" size={12} />
                                                </span>
                                            )}
                                        </td>
                                        <td className="px-2 py-2 text-right text-xs font-semibold text-gray-900">{row.quantity || row.totalQty || 0}</td>
                                        <td className="px-2 py-2 text-right text-[10px] text-gray-500 font-mono whitespace-nowrap">{row.id}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PipelineSummaryTable = ({ data }) => {
            const total = data.reduce((acc, curr) => acc + curr.count, 0);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-2xl mx-auto mt-8">
                    <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                            <Icon name="BarChart" size={20} className="text-blue-600" />
                            Pipeline Summary (This Month)
                        </h3>
                        <span className="bg-blue-100 text-blue-700 text-xs py-0.5 px-2 rounded-full font-bold">Total: {total}</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-6 py-3">Stage</th>
                                    <th className="px-6 py-3 text-right">Count</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, idx) => (
                                    <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                        <td className="px-6 py-3 font-medium text-gray-900">{row.stage}</td>
                                        <td className="px-6 py-3 text-right text-gray-600 font-mono">{row.count}</td>
                                    </tr>
                                ))}
                                <tr className="bg-gray-50 font-bold border-t border-gray-200">
                                    <td className="px-6 py-3 text-gray-900">Total</td>
                                    <td className="px-6 py-3 text-right text-blue-600">{total}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // üìã HOLD REPORT TABLE (Simplified View - No Install Metrics)
        const HoldReportTable = ({ data, onRowClick, onBack }) => {
            const downloadCSV = () => {
                const headers = ['Campaign #', 'Start Date', 'End Date', 'Market', 'Advertiser', 'Campaign', 'Product', 'Stage', 'Owner', 'Qty'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => [
                        row.id,
                        row.date,
                        row.endDate,
                        `"${(row.market || '').replace(/"/g, '""')}"`,
                        `"${(row.advertiser || '').replace(/"/g, '""')}"`,
                        `"${(row.name || '').replace(/"/g, '""')}"`,
                        `"${(row.product || '').replace(/"/g, '""')}"`,
                        row.stage,
                        row.owner,
                        row.quantity || row.totalQty
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `hold_report_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                    <div className="text-gray-400 mb-2 inline-block"><Icon name="ClipboardList" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No holds found</h3>
                    <p className="text-gray-500 text-sm">All campaigns are either completed or canceled.</p>
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="px-6 py-4 border-b bg-amber-50 flex justify-between items-center">
                        <h3 className="font-semibold text-amber-900 flex items-center gap-2">
                            {onBack && (
                                <button onClick={onBack} className="p-1 hover:bg-amber-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={18} />
                                </button>
                            )}
                            <Icon name="ClipboardList" size={20} /> Hold Report (Simplified View)
                            <span className="bg-amber-200 text-amber-800 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <button onClick={downloadCSV} className="text-amber-700 text-sm flex gap-2 font-medium hover:text-amber-900 transition-colors">
                            <Icon name="Download" size={16}/> CSV
                        </button>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-4 py-3">ID</th>
                                    <th className="px-4 py-3">Start</th>
                                    <th className="px-4 py-3">End</th>
                                    <th className="px-4 py-3">Market</th>
                                    <th className="px-4 py-3">Advertiser</th>
                                    <th className="px-4 py-3">Campaign</th>
                                    <th className="px-4 py-3">Product</th>
                                    <th className="px-4 py-3">Stage</th>
                                    <th className="px-4 py-3">Owner</th>
                                    <th className="px-4 py-3 text-right">Qty</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick && onRowClick(row)} className="hover:bg-amber-50 cursor-pointer transition-colors">
                                        <td className="px-4 py-3 text-xs font-mono text-gray-500">{row.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.date}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.endDate}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">
                                            <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">{row.market || '-'}</span>
                                        </td>
                                        <td className="px-4 py-3 font-medium text-gray-900">{row.advertiser}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.name}</td>
                                        <td className="px-4 py-3 text-sm text-gray-500">{row.product}</td>
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs border ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage}</span>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.owner}</td>
                                        <td className="px-4 py-3 text-right text-sm font-mono text-gray-600">{row.quantity || row.totalQty}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // üëª GHOST BOOKINGS TABLE (SF Records with No Owner or No Stage)
        const GhostBookingsTable = ({ data, onRowClick, onBack }) => {
            const copyIds = () => {
                const ids = data.map(row => row.id).join('\n');
                navigator.clipboard.writeText(ids);
                alert(`${data.length} Campaign IDs copied to clipboard!`);
            };

            if (data.length === 0) return (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                    <div className="text-green-400 mb-2 inline-block"><Icon name="CheckCircle" size={40} /></div>
                    <h3 className="text-lg font-medium text-gray-900">No ghost bookings üéâ</h3>
                    <p className="text-gray-500 text-sm">All campaigns have assigned sales owners, valid stages, and products.</p>
                </div>
            );

            return (
                <div className="bg-white rounded-xl shadow-sm border border-orange-200 overflow-hidden">
                    <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                        <h3 className="font-semibold text-orange-900 flex items-center gap-2">
                            {onBack && (
                                <button onClick={onBack} className="p-1 hover:bg-orange-200 rounded-full transition-colors mr-1" title="Back to Dashboard">
                                    <Icon name="ArrowLeft" size={18} />
                                </button>
                            )}
                            <Icon name="Ghost" size={20} /> üëª Ghost Bookings
                            <span className="bg-orange-200 text-orange-800 text-xs py-0.5 px-2 rounded-full">{data.length}</span>
                        </h3>
                        <button onClick={copyIds} className="text-orange-700 text-sm flex gap-2 font-medium hover:text-orange-900 transition-colors">
                            <Icon name="Copy" size={16}/> Copy IDs
                        </button>
                    </div>
                    <div className="bg-orange-50 px-6 py-3 border-b border-orange-100">
                        <p className="text-sm text-orange-800">
                            ‚ö†Ô∏è These bookings need attention: missing sales owner, no stage, or no product assigned. Review in Salesforce before finalizing reports.
                        </p>
                    </div>
                    <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="sticky top-0 z-10">
                                <tr className="text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-200 uppercase tracking-wider">
                                    <th className="px-4 py-3">Reason</th>
                                    <th className="px-4 py-3">Campaign #</th>
                                    <th className="px-4 py-3">Start Date</th>
                                    <th className="px-4 py-3">Market</th>
                                    <th className="px-4 py-3">Advertiser</th>
                                    <th className="px-4 py-3">Campaign</th>
                                    <th className="px-4 py-3">Product</th>
                                    <th className="px-4 py-3">Stage</th>
                                    <th className="px-4 py-3 text-right">Qty</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, i) => (
                                    <tr key={i} onClick={() => onRowClick && onRowClick(row)} className="hover:bg-orange-50 cursor-pointer transition-colors bg-orange-25">
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                row.ghostReason === 'No Stage' ? 'bg-purple-100 text-purple-700' : 
                                                row.ghostReason === 'No Product' ? 'bg-pink-100 text-pink-700' : 
                                                'bg-orange-100 text-orange-700'
                                            }`}>
                                                {row.ghostReason || 'No Owner'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-xs font-mono text-orange-700 font-bold">{row.id}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.date}</td>
                                        <td className="px-4 py-3 text-sm">
                                            <span className="px-2 py-0.5 bg-blue-50 text-blue-700 rounded text-xs">{row.market || '-'}</span>
                                        </td>
                                        <td className="px-4 py-3 font-medium text-gray-900">{row.advertiser}</td>
                                        <td className="px-4 py-3 text-sm text-gray-600">{row.name}</td>
                                        <td className="px-4 py-3 text-sm text-gray-500">{row.product || <span className="text-pink-500 italic">No Product</span>}</td>
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-xs border ${getStatusColor(row.stage, row.dateObj)}`}>{row.stage || 'No Stage'}</span>
                                        </td>
                                        <td className="px-4 py-3 text-right text-sm font-mono text-gray-600">{row.quantity || row.totalQty}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        // ===========================================
        // GEOPATH IMPRESSION ESTIMATOR BY ZIP CODE
        // ===========================================
        // Source: US Census Bureau 2022 Estimates
        // Formula based on population density + industry benchmarks
        // ===========================================
        
        const LA_ZIP_DATA = {
            // Format: ZIP: { pop: population, sqMi: square miles, area: name }
            // South LA
            '90001': { pop: 57652, sqMi: 4.5, area: 'Florence' },
            '90002': { pop: 53108, sqMi: 3.8, area: 'Watts' },
            '90003': { pop: 75024, sqMi: 4.2, area: 'South LA' },
            '90004': { pop: 58833, sqMi: 2.1, area: 'Hancock Park' },
            '90005': { pop: 37754, sqMi: 0.9, area: 'Koreatown' },
            '90006': { pop: 56628, sqMi: 1.4, area: 'Koreatown' },
            '90007': { pop: 41004, sqMi: 1.3, area: 'USC Area' },
            '90008': { pop: 33076, sqMi: 2.8, area: 'Baldwin Hills' },
            '90010': { pop: 4185, sqMi: 0.3, area: 'Mid-Wilshire' },
            '90011': { pop: 106042, sqMi: 4.8, area: 'South Central' },
            '90012': { pop: 38430, sqMi: 3.2, area: 'Downtown LA' },
            '90013': { pop: 14587, sqMi: 0.7, area: 'Downtown LA' },
            '90014': { pop: 9273, sqMi: 0.3, area: 'Fashion District' },
            '90015': { pop: 25554, sqMi: 1.1, area: 'South Park' },
            '90016': { pop: 47309, sqMi: 2.4, area: 'West Adams' },
            '90017': { pop: 28754, sqMi: 0.8, area: 'Downtown LA' },
            '90018': { pop: 49898, sqMi: 2.6, area: 'Jefferson Park' },
            '90019': { pop: 59410, sqMi: 2.8, area: 'Mid-City' },
            '90020': { pop: 38400, sqMi: 0.8, area: 'Koreatown' },
            '90021': { pop: 2781, sqMi: 1.2, area: 'Industrial District' },
            '90023': { pop: 44558, sqMi: 3.5, area: 'Boyle Heights' },
            '90024': { pop: 50392, sqMi: 2.9, area: 'Westwood' },
            '90025': { pop: 44429, sqMi: 3.4, area: 'West LA' },
            '90026': { pop: 64769, sqMi: 3.1, area: 'Echo Park' },
            '90027': { pop: 45764, sqMi: 5.8, area: 'Los Feliz' },
            '90028': { pop: 30982, sqMi: 1.8, area: 'Hollywood' },
            '90029': { pop: 34649, sqMi: 1.3, area: 'Thai Town' },
            '90031': { pop: 37457, sqMi: 4.2, area: 'Lincoln Heights' },
            '90032': { pop: 44881, sqMi: 3.8, area: 'El Sereno' },
            '90033': { pop: 47655, sqMi: 2.1, area: 'Boyle Heights' },
            '90034': { pop: 55061, sqMi: 2.5, area: 'Palms' },
            '90035': { pop: 26595, sqMi: 1.8, area: 'Mid-City' },
            '90036': { pop: 37713, sqMi: 2.1, area: 'Fairfax' },
            '90037': { pop: 69064, sqMi: 3.2, area: 'Vermont Square' },
            '90038': { pop: 27979, sqMi: 1.4, area: 'Hollywood' },
            '90039': { pop: 28244, sqMi: 2.8, area: 'Silver Lake' },
            '90041': { pop: 28321, sqMi: 3.5, area: 'Eagle Rock' },
            '90042': { pop: 59151, sqMi: 5.8, area: 'Highland Park' },
            '90043': { pop: 44461, sqMi: 3.2, area: 'View Park' },
            '90044': { pop: 98990, sqMi: 5.2, area: 'Vermont-Slauson' },
            '90045': { pop: 41123, sqMi: 5.4, area: 'Westchester' },
            '90046': { pop: 48170, sqMi: 4.2, area: 'West Hollywood' },
            '90047': { pop: 52200, sqMi: 4.5, area: 'Vermont Knolls' },
            '90048': { pop: 20411, sqMi: 1.2, area: 'Beverly Grove' },
            '90049': { pop: 35819, sqMi: 8.2, area: 'Brentwood' },
            '90056': { pop: 8225, sqMi: 0.9, area: 'Ladera Heights' },
            '90057': { pop: 47142, sqMi: 1.1, area: 'Westlake' },
            '90058': { pop: 3049, sqMi: 4.8, area: 'Vernon' },
            '90059': { pop: 39471, sqMi: 2.8, area: 'Green Meadows' },
            '90061': { pop: 28646, sqMi: 2.1, area: 'Vermont Vista' },
            '90062': { pop: 33528, sqMi: 2.0, area: 'South LA' },
            '90063': { pop: 52008, sqMi: 3.8, area: 'East LA' },
            '90064': { pop: 25956, sqMi: 2.1, area: 'Rancho Park' },
            '90065': { pop: 44897, sqMi: 5.2, area: 'Cypress Park' },
            '90066': { pop: 54142, sqMi: 4.5, area: 'Mar Vista' },
            '90067': { pop: 2653, sqMi: 0.5, area: 'Century City' },
            '90068': { pop: 21064, sqMi: 4.8, area: 'Hollywood Hills' },
            '90069': { pop: 20045, sqMi: 1.8, area: 'West Hollywood' },
            '90071': { pop: 313, sqMi: 0.2, area: 'Financial District' },
            '90077': { pop: 7868, sqMi: 6.5, area: 'Bel Air' },
            '90210': { pop: 19180, sqMi: 5.8, area: 'Beverly Hills' },
            '90272': { pop: 21298, sqMi: 8.5, area: 'Pacific Palisades' },
            '90290': { pop: 5300, sqMi: 8.2, area: 'Topanga' },
            '90291': { pop: 25656, sqMi: 2.1, area: 'Venice' },
            '90292': { pop: 24481, sqMi: 3.2, area: 'Marina del Rey' },
            '90293': { pop: 13039, sqMi: 1.8, area: 'Playa del Rey' },
            '90402': { pop: 11816, sqMi: 0.8, area: 'Santa Monica' },
            // San Fernando Valley
            '91040': { pop: 20911, sqMi: 4.2, area: 'Sunland' },
            '91042': { pop: 27119, sqMi: 12.5, area: 'Tujunga' },
            '91303': { pop: 30611, sqMi: 4.8, area: 'Canoga Park' },
            '91304': { pop: 54369, sqMi: 8.2, area: 'Canoga Park' },
            '91306': { pop: 49460, sqMi: 5.8, area: 'Winnetka' },
            '91307': { pop: 25368, sqMi: 12.5, area: 'West Hills' },
            '91311': { pop: 40196, sqMi: 5.5, area: 'Chatsworth' },
            '91316': { pop: 34305, sqMi: 3.8, area: 'Encino' },
            '91324': { pop: 29744, sqMi: 3.2, area: 'Northridge' },
            '91325': { pop: 35537, sqMi: 3.8, area: 'Northridge' },
            '91326': { pop: 36503, sqMi: 8.5, area: 'Porter Ranch' },
            '91330': { pop: 2699, sqMi: 0.8, area: 'CSUN' },
            '91331': { pop: 99804, sqMi: 8.2, area: 'Pacoima' },
            '91335': { pop: 77158, sqMi: 6.5, area: 'Reseda' },
            '91340': { pop: 34822, sqMi: 3.5, area: 'San Fernando' },
            '91342': { pop: 92580, sqMi: 18.5, area: 'Sylmar' },
            '91343': { pop: 63193, sqMi: 5.2, area: 'North Hills' },
            '91344': { pop: 53862, sqMi: 8.8, area: 'Granada Hills' },
            '91345': { pop: 18481, sqMi: 2.1, area: 'Mission Hills' },
            '91352': { pop: 45601, sqMi: 4.5, area: 'Sun Valley' },
            '91356': { pop: 30599, sqMi: 3.2, area: 'Tarzana' },
            '91364': { pop: 28765, sqMi: 4.2, area: 'Woodland Hills' },
            '91367': { pop: 44862, sqMi: 5.8, area: 'Woodland Hills' },
            '91401': { pop: 39179, sqMi: 2.5, area: 'Van Nuys' },
            '91402': { pop: 67937, sqMi: 4.8, area: 'Panorama City' },
            '91403': { pop: 25887, sqMi: 2.8, area: 'Sherman Oaks' },
            '91405': { pop: 55451, sqMi: 3.5, area: 'Van Nuys' },
            '91406': { pop: 53276, sqMi: 4.2, area: 'Van Nuys' },
            '91411': { pop: 23689, sqMi: 1.8, area: 'Van Nuys' },
            '91423': { pop: 31787, sqMi: 3.8, area: 'Sherman Oaks' },
            '91436': { pop: 16190, sqMi: 2.1, area: 'Encino' },
            '91601': { pop: 35615, sqMi: 2.8, area: 'North Hollywood' },
            '91602': { pop: 19980, sqMi: 2.5, area: 'North Hollywood' },
            '91604': { pop: 32073, sqMi: 3.5, area: 'Studio City' },
            '91605': { pop: 51654, sqMi: 3.8, area: 'North Hollywood' },
            '91606': { pop: 43552, sqMi: 2.8, area: 'North Hollywood' },
            '91607': { pop: 30734, sqMi: 2.5, area: 'Valley Village' },
            // Harbor Area
            '90501': { pop: 42536, sqMi: 4.8, area: 'Torrance' },
            '90502': { pop: 18430, sqMi: 2.5, area: 'Torrance' },
            '90710': { pop: 27517, sqMi: 3.8, area: 'Harbor City' },
            '90731': { pop: 63431, sqMi: 8.5, area: 'San Pedro' },
            '90732': { pop: 22078, sqMi: 5.2, area: 'San Pedro' },
            '90744': { pop: 54277, sqMi: 6.8, area: 'Wilmington' },
            '90810': { pop: 36306, sqMi: 4.2, area: 'Long Beach' },
        };

        // Industry standard multipliers (based on Geopath methodology)
        const PRODUCT_MULTIPLIERS = {
            'Panel-Targeted': 1.15,      // High visibility, strategic placement
            'Panel-Network': 0.95,       // Standard network placement
            'Digital': 2.8,              // Multiple rotations, higher frequency
            'Digital Panel-Spot-Pl...': 2.8,
            'Transit Shelter': 0.65,     // Pedestrian focused, lower vehicle
            'Wallscape': 1.4,            // Large format, high visibility
            'Poster': 0.75,              // Standard poster
            'default': 1.0
        };

        /**
         * Estimate weekly impressions for a ZIP code
         * @param {string} zip - ZIP code
         * @param {string} product - Product type (optional)
         * @returns {object} - Impression estimates by product type
         */
        function estimateImpressions(zip, product = null) {
            const data = LA_ZIP_DATA[zip];
            
            if (!data) {
                // Return estimate based on LA average if ZIP not found
                const avgDensity = 8000; // LA average pop density
                const baseImps = Math.round(avgDensity * 0.75);
                return {
                    zip,
                    found: false,
                    area: 'Unknown',
                    population: null,
                    density: avgDensity,
                    weeklyImpressions: {
                        'Panel-Targeted': Math.round(baseImps * 1.15),
                        'Panel-Network': Math.round(baseImps * 0.95),
                        'Digital': Math.round(baseImps * 2.8),
                        'Transit Shelter': Math.round(baseImps * 0.65),
                    }
                };
            }

            const density = Math.round(data.pop / data.sqMi);
            
            // Base formula: Population density √ó visibility factor
            // Industry benchmark: ~0.75 impressions per person in density per week
            const baseImpressions = Math.round(density * 0.75);
            
            const impressions = {};
            for (const [type, mult] of Object.entries(PRODUCT_MULTIPLIERS)) {
                if (type !== 'default') {
                    impressions[type] = Math.round(baseImpressions * mult);
                }
            }

            return {
                zip,
                found: true,
                area: data.area,
                population: data.pop,
                sqMiles: data.sqMi,
                density,
                weeklyImpressions: impressions,
                // Convenience: get single product
                getForProduct: (prod) => {
                    const mult = PRODUCT_MULTIPLIERS[prod] || PRODUCT_MULTIPLIERS['default'];
                    return Math.round(baseImpressions * mult);
                }
            };
        }

        /**
         * Get all ZIPs with data
         */
        function getAvailableZips() {
            return Object.keys(LA_ZIP_DATA).sort();
        }

        /**
         * Lookup ZIP by area name
         */
        function findZipsByArea(areaName) {
            const results = [];
            for (const [zip, data] of Object.entries(LA_ZIP_DATA)) {
                if (data.area.toLowerCase().includes(areaName.toLowerCase())) {
                    results.push({ zip, ...data });
                }
            }
            return results;
        }

        // ===========================================
        // END GEOPATH IMPRESSION ESTIMATOR
        // ===========================================

        const STAT_CARD_CONFIG = {
            delayedFlights: {
                title: "Delayed / Overdue",
                subtitle: "Urgent (Last 3 Weeks)",
                color: "text-orange-600",
                icon: "Flame"
            },
            inProgressFlights: {
                title: "In-Progress Flights",
                subtitle: "Material Ready (Last 4 Weeks)",
                color: "text-teal-600",
                icon: "Rocket"
            },
            expiredFlights: {
                title: "Expired Flights",
                subtitle: "Installed - Ready for Removal",
                color: "text-gray-600",
                icon: "Lightbulb"
            },
            rotations: {
                title: "Rotations",
                subtitle: "Upcoming",
                color: "text-cyan-600",
                icon: "Repeat"
            },
            upcoming: {
                title: "Upcoming",
                subtitle: "Next 7 Days",
                color: "text-orange-600",
                icon: "Sun"
            },
            pastDue: {
                title: "Past Due",
                subtitle: "Older Backlog (3+ weeks)",
                color: "text-red-600",
                icon: "AlertTriangle"
            },
            activeInstalls: {
                title: "Active Installs",
                subtitle: "Last 30 Days",
                color: "text-purple-600",
                icon: "Hammer"
            },
            recentInstalls: {
                title: "Installed",
                subtitle: "Faces (Last 30 Days)",
                color: "text-green-600",
                icon: "CheckSquare"
            },
            fullyInstalledThisWeek: {
                title: "Installed This Week",
                subtitle: "Campaigns",
                color: "text-yellow-600",
                icon: "Medal"
            }
        };

        const DEFAULT_VISIBLE_CARDS = [
            'delayedFlights', 'inProgressFlights', 'expiredFlights', 'rotations', 'upcoming'
        ];

        // --- CUSTOM WIDGET MODAL ---
        const CustomWidgetModal = ({ isOpen, onClose, onSave, editWidget, allData = [] }) => {
            const [widgetConfig, setWidgetConfig] = useState({
                id: '',
                title: '',
                subtitle: '',
                icon: 'Target',
                color: 'text-blue-600',
                stages: [],
                owners: [],
                products: [],
                installStatus: '', // 'fully', 'partial', 'notStarted', ''
                dateLogic: '', // 'startingNext7', 'endingNext7', 'longRunning', ''
                volumeFilter: '', // 'high50', 'low10', ''
                displayValue: 'count' // 'count', 'qty', 'pending', 'installed'
            });
            
            // Reset form when opening/editing
            useEffect(() => {
                if (editWidget) {
                    setWidgetConfig(editWidget);
                } else {
                    setWidgetConfig({
                        id: `custom_${Date.now()}`,
                        title: '',
                        subtitle: '',
                        icon: 'Target',
                        color: 'text-blue-600',
                        stages: [],
                        owners: [],
                        products: [],
                        installStatus: '',
                        dateLogic: '',
                        volumeFilter: '',
                        displayValue: 'count'
                    });
                }
            }, [editWidget, isOpen]);
            
            // Get unique values from data
            const uniqueStages = [...new Set(allData.map(d => d.stage).filter(Boolean))].sort();
            const uniqueOwners = [...new Set(allData.map(d => d.owner).filter(Boolean))].sort();
            const uniqueProducts = [...new Set(allData.map(d => d.product || d.media).filter(Boolean))].sort();
            
            // Calculate preview value
            const getPreviewValue = () => {
                let filtered = [...allData];
                
                // Stage filter
                if (widgetConfig.stages.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.stages.includes(d.stage));
                }
                
                // Owner filter
                if (widgetConfig.owners.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.owners.includes(d.owner));
                }
                
                // Product filter
                if (widgetConfig.products.length > 0) {
                    filtered = filtered.filter(d => widgetConfig.products.includes(d.product || d.media));
                }
                
                // Install status filter
                if (widgetConfig.installStatus === 'fully') {
                    filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                } else if (widgetConfig.installStatus === 'partial') {
                    filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                } else if (widgetConfig.installStatus === 'notStarted') {
                    filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                }
                
                // Date logic filter
                const today = new Date();
                today.setHours(0,0,0,0);
                if (widgetConfig.dateLogic === 'startingNext7') {
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                } else if (widgetConfig.dateLogic === 'endingNext7') {
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                } else if (widgetConfig.dateLogic === 'longRunning') {
                    filtered = filtered.filter(d => {
                        if (!d.dateObj || !d.endDateObj) return false;
                        const duration = (d.endDateObj - d.dateObj) / (1000 * 60 * 60 * 24);
                        return duration > 30;
                    });
                }
                
                // Volume filter
                if (widgetConfig.volumeFilter === 'high50') {
                    filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                } else if (widgetConfig.volumeFilter === 'low10') {
                    filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                }
                
                // Calculate display value
                if (widgetConfig.displayValue === 'count') {
                    return filtered.length;
                } else if (widgetConfig.displayValue === 'qty') {
                    return filtered.reduce((sum, d) => sum + (d.quantity || d.totalQty || 0), 0);
                } else if (widgetConfig.displayValue === 'pending') {
                    return filtered.reduce((sum, d) => sum + (d.pending || 0), 0);
                } else if (widgetConfig.displayValue === 'installed') {
                    return filtered.reduce((sum, d) => sum + (d.totalInstalled || d.installed || 0), 0);
                }
                return 0;
            };
            
            const toggleArrayItem = (arr, item) => {
                return arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item];
            };
            
            const iconOptions = [
                // Row 1 - Operations/Status
                'Target', 'Flame', 'Rocket', 'CheckSquare', 'AlertTriangle', 'Clock', 'Calendar', 
                // Row 2 - Charts/Business
                'BarChart', 'TrendingUp', 'PieChart', 'Activity', 'DollarSign', 'Briefcase',
                // Row 3 - Objects
                'Package', 'Truck', 'Medal', 'Lightbulb', 'Sun', 'Star', 'Crown',
                // Row 4 - People/Communication
                'Users', 'User', 'Mail', 'MessageSquare', 'Bell', 'Megaphone',
                // Row 5 - Actions/Tools
                'Hammer', 'Tool', 'Wrench', 'Settings', 'Filter', 'Layers',
                // Row 6 - Status/Alerts
                'CheckCircle', 'XCircle', 'AlertCircle', 'Info', 'Shield', 'Flag',
                // Row 7 - Nature/Weather
                'Cloud', 'Snowflake', 'Droplet', 'Moon', 'Sunrise', 'Umbrella',
                // Row 8 - Misc
                'Heart', 'Zap', 'Gift', 'Bookmark', 'Tag', 'Hash', 'Compass',
                // Row 9 - Tech
                'Database', 'Server', 'Globe', 'Wifi', 'Monitor', 'Cpu'
            ];
            const colorOptions = [
                // Primary
                { name: 'Blue', value: 'text-blue-600' },
                { name: 'Green', value: 'text-green-600' },
                { name: 'Red', value: 'text-red-600' },
                { name: 'Orange', value: 'text-orange-600' },
                { name: 'Purple', value: 'text-purple-600' },
                { name: 'Teal', value: 'text-teal-600' },
                { name: 'Yellow', value: 'text-yellow-600' },
                { name: 'Pink', value: 'text-pink-600' },
                { name: 'Cyan', value: 'text-cyan-600' },
                { name: 'Gray', value: 'text-gray-600' },
                // Additional shades
                { name: 'Indigo', value: 'text-indigo-600' },
                { name: 'Violet', value: 'text-violet-600' },
                { name: 'Fuchsia', value: 'text-fuchsia-600' },
                { name: 'Rose', value: 'text-rose-600' },
                { name: 'Emerald', value: 'text-emerald-600' },
                { name: 'Lime', value: 'text-lime-600' },
                { name: 'Amber', value: 'text-amber-600' },
                { name: 'Sky', value: 'text-sky-600' },
                { name: 'Slate', value: 'text-slate-600' },
                { name: 'Zinc', value: 'text-zinc-600' },
                // Darker variants
                { name: 'Navy', value: 'text-blue-800' },
                { name: 'Forest', value: 'text-green-800' },
                { name: 'Maroon', value: 'text-red-800' },
                { name: 'Plum', value: 'text-purple-800' }
            ];
            
            // Randomize icon and color
            const randomize = () => {
                const randomIcon = iconOptions[Math.floor(Math.random() * iconOptions.length)];
                const randomColor = colorOptions[Math.floor(Math.random() * colorOptions.length)].value;
                setWidgetConfig(prev => ({ ...prev, icon: randomIcon, color: randomColor }));
            };
            
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-gradient-to-r from-blue-600 to-purple-600 text-white flex justify-between items-center">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="Plus" size={24} />
                                {editWidget ? 'Edit Custom Widget' : 'Create Custom Widget'}
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Left Column - Basic Info */}
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-800 border-b pb-2">Widget Appearance</h3>
                                    
                                    {/* Title */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                                        <input
                                            type="text"
                                            value={widgetConfig.title}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, title: e.target.value }))}
                                            placeholder="e.g., My Priority Items"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    {/* Subtitle */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
                                        <input
                                            type="text"
                                            value={widgetConfig.subtitle}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, subtitle: e.target.value }))}
                                            placeholder="e.g., Needs Attention"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    {/* Randomize Button */}
                                    <div>
                                        <button
                                            onClick={randomize}
                                            className="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all flex items-center justify-center gap-2"
                                        >
                                            <Icon name="Sparkles" size={18} />
                                            üé≤ Randomize Icon & Color
                                        </button>
                                    </div>
                                    
                                    {/* Icon Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                                        <div className="max-h-36 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                            <div className="flex flex-wrap gap-2">
                                                {iconOptions.map(icon => (
                                                    <button
                                                        key={icon}
                                                        onClick={() => setWidgetConfig(prev => ({ ...prev, icon }))}
                                                        className={`p-2 rounded-lg border-2 transition-all ${widgetConfig.icon === icon ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                                                        title={icon}
                                                    >
                                                        <Icon name={icon} size={18} />
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Color Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
                                        <div className="max-h-28 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                            <div className="flex flex-wrap gap-1.5">
                                                {colorOptions.map(c => (
                                                    <button
                                                        key={c.value}
                                                        onClick={() => setWidgetConfig(prev => ({ ...prev, color: c.value }))}
                                                        className={`px-2.5 py-1 rounded-full text-xs font-medium transition-all ${widgetConfig.color === c.value ? 'ring-2 ring-offset-1 ring-blue-500' : ''} ${c.value.replace('text-', 'bg-').replace('-600', '-100').replace('-800', '-200')} ${c.value}`}
                                                        title={c.name}
                                                    >
                                                        {c.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Display Value */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Value</label>
                                        <select
                                            value={widgetConfig.displayValue}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, displayValue: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="count">Campaign Count</option>
                                            <option value="qty">Sum of Qty (Faces)</option>
                                            <option value="pending">Sum of Pending</option>
                                            <option value="installed">Sum of Installed</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {/* Right Column - Filters */}
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-800 border-b pb-2">Filter Criteria</h3>
                                    
                                    {/* Stage Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Stage</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueStages.map(stage => (
                                                <label key={stage} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.stages.includes(stage)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, stages: toggleArrayItem(prev.stages, stage) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    {stage}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Owner Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Owner</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueOwners.slice(0, 20).map(owner => (
                                                <label key={owner} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.owners.includes(owner)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, owners: toggleArrayItem(prev.owners, owner) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    {owner}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Product Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">By Product Type</label>
                                        <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 space-y-1">
                                            {uniqueProducts.slice(0, 20).map(product => (
                                                <label key={product} className="flex items-center gap-2 text-sm hover:bg-gray-50 px-2 py-1 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={widgetConfig.products.includes(product)}
                                                        onChange={() => setWidgetConfig(prev => ({ ...prev, products: toggleArrayItem(prev.products, product) }))}
                                                        className="rounded text-blue-600"
                                                    />
                                                    <span className="truncate">{product.replace('Transit Shelters-', '').replace('Transit Shelter-', '')}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Install Status */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Install Status</label>
                                        <select
                                            value={widgetConfig.installStatus}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, installStatus: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All</option>
                                            <option value="fully">Fully Installed (Pending = 0)</option>
                                            <option value="partial">Partially Installed</option>
                                            <option value="notStarted">Not Started (Installed = 0)</option>
                                        </select>
                                    </div>
                                    
                                    {/* Date Logic */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Date Filter</label>
                                        <select
                                            value={widgetConfig.dateLogic}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, dateLogic: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All Dates</option>
                                            <option value="startingNext7">Starting in Next 7 Days</option>
                                            <option value="endingNext7">Ending in Next 7 Days</option>
                                            <option value="longRunning">Long-Running (&gt;30 days)</option>
                                        </select>
                                    </div>
                                    
                                    {/* Volume Filter */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Volume Filter</label>
                                        <select
                                            value={widgetConfig.volumeFilter}
                                            onChange={(e) => setWidgetConfig(prev => ({ ...prev, volumeFilter: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All Volumes</option>
                                            <option value="high50">High Volume (50+ faces)</option>
                                            <option value="low10">Low Volume (&lt;10 faces)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Preview */}
                            <div className="mt-6 p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                                <h3 className="text-sm font-medium text-gray-500 mb-3">Preview</h3>
                                <div className="flex items-center gap-4">
                                    <div className={`p-4 rounded-xl ${widgetConfig.color.replace('text-', 'bg-').replace('-600', '-100')}`}>
                                        <Icon name={widgetConfig.icon} size={28} className={widgetConfig.color} />
                                    </div>
                                    <div>
                                        <p className="text-2xl font-bold text-gray-900">{getPreviewValue().toLocaleString()}</p>
                                        <p className="font-semibold text-gray-800">{widgetConfig.title || 'Widget Title'}</p>
                                        <p className={`text-sm ${widgetConfig.color}`}>{widgetConfig.subtitle || 'Subtitle'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => {
                                    if (!widgetConfig.title.trim()) {
                                        alert('Please enter a title for your widget');
                                        return;
                                    }
                                    onSave(widgetConfig);
                                    onClose();
                                }}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2"
                            >
                                <Icon name="Save" size={18} />
                                {editWidget ? 'Update Widget' : 'Create Widget'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: GEOPATH IMPRESSIONS LOOKUP ---
        const ImpressionsModal = ({ isOpen, onClose }) => {
            const [searchZip, setSearchZip] = useState('');
            const [selectedProduct, setSelectedProduct] = useState('Panel-Targeted');
            const [viewMode, setViewMode] = useState('search'); // 'search' or 'rankings'
            
            if (!isOpen) return null;
            
            const productTypes = Object.keys(PRODUCT_MULTIPLIERS).filter(p => p !== 'default' && !p.includes('...'));
            
            // Calculate impressions for a ZIP
            const getZipImpressions = (zip) => {
                const data = LA_ZIP_DATA[zip];
                if (!data) return null;
                
                const density = Math.round(data.pop / data.sqMi);
                const baseImpressions = Math.round(density * 0.75);
                
                const products = {};
                productTypes.forEach(type => {
                    const mult = PRODUCT_MULTIPLIERS[type] || 1.0;
                    products[type] = {
                        weekly: Math.round(baseImpressions * mult),
                        fourWeek: Math.round(baseImpressions * mult * 4),
                        daily: Math.round(baseImpressions * mult / 7)
                    };
                });
                
                return {
                    zipCode: zip,
                    area: data.area,
                    population: data.pop,
                    sqMiles: data.sqMi,
                    popDensity: density,
                    products
                };
            };
            
            // Search results
            const searchResult = searchZip.length === 5 ? getZipImpressions(searchZip) : null;
            
            // Top ZIPs by selected product
            const topZips = Object.keys(LA_ZIP_DATA)
                .map(zip => getZipImpressions(zip))
                .filter(Boolean)
                .sort((a, b) => (b.products?.[selectedProduct]?.weekly || 0) - (a.products?.[selectedProduct]?.weekly || 0))
                .slice(0, 15);
            
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-gradient-to-r from-emerald-600 to-teal-600 text-white flex justify-between items-center">
                            <div>
                                <h2 className="text-xl font-bold flex items-center gap-2">
                                    <Icon name="MapPin" size={24} />
                                    Geopath Impression Estimator
                                </h2>
                                <p className="text-emerald-100 text-sm mt-1">
                                    ZIP-based weekly impression estimates ‚Ä¢ {Object.keys(LA_ZIP_DATA).length} LA ZIPs
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        
                        {/* Tab Navigation */}
                        <div className="px-6 py-3 bg-gray-50 border-b flex items-center gap-4">
                            <button 
                                onClick={() => setViewMode('search')}
                                className={`px-4 py-2 rounded-lg font-medium transition-colors ${viewMode === 'search' ? 'bg-emerald-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`}
                            >
                                <Icon name="Search" size={16} className="inline mr-2" />
                                ZIP Lookup
                            </button>
                            <button 
                                onClick={() => setViewMode('rankings')}
                                className={`px-4 py-2 rounded-lg font-medium transition-colors ${viewMode === 'rankings' ? 'bg-emerald-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`}
                            >
                                <Icon name="TrendingUp" size={16} className="inline mr-2" />
                                Top ZIPs
                            </button>
                            
                            <div className="ml-auto flex items-center gap-2">
                                <label className="text-sm text-gray-600">Product:</label>
                                <select 
                                    value={selectedProduct}
                                    onChange={e => setSelectedProduct(e.target.value)}
                                    className="px-3 py-1.5 border rounded-lg text-sm"
                                >
                                    {productTypes.map(p => (
                                        <option key={p} value={p}>{p}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {viewMode === 'search' ? (
                                <div className="space-y-6">
                                    {/* Search Input */}
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Enter ZIP Code</label>
                                            <input
                                                type="text"
                                                value={searchZip}
                                                onChange={e => setSearchZip(e.target.value.replace(/\D/g, '').slice(0, 5))}
                                                placeholder="e.g., 90028"
                                                className="w-full px-4 py-3 text-xl border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all"
                                                maxLength={5}
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Search Result */}
                                    {searchZip.length === 5 && !searchResult && (
                                        <div className="text-center py-8 bg-orange-50 rounded-xl border border-orange-200">
                                            <Icon name="AlertCircle" size={32} className="text-orange-500 mx-auto mb-2" />
                                            <p className="text-orange-700">ZIP code {searchZip} not found in LA database</p>
                                            <p className="text-sm text-orange-600 mt-1">Try a different Los Angeles area ZIP</p>
                                        </div>
                                    )}
                                    
                                    {searchResult && (
                                        <div className="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl border border-emerald-200 overflow-hidden">
                                            <div className="px-6 py-4 bg-emerald-600 text-white">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <h3 className="text-2xl font-bold">{searchResult.zipCode}</h3>
                                                        <p className="text-emerald-100">{searchResult.area}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-sm text-emerald-100">Population Density</p>
                                                        <p className="text-2xl font-bold">{searchResult.popDensity.toLocaleString()}/mi¬≤</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="p-6">
                                                <div className="grid grid-cols-2 gap-4 mb-6">
                                                    <div className="bg-white rounded-lg p-4 shadow-sm">
                                                        <p className="text-sm text-gray-500">Population</p>
                                                        <p className="text-2xl font-bold text-gray-800">{searchResult.population.toLocaleString()}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4 shadow-sm">
                                                        <p className="text-sm text-gray-500">Area</p>
                                                        <p className="text-2xl font-bold text-gray-800">{searchResult.sqMiles.toFixed(2)} mi¬≤</p>
                                                    </div>
                                                </div>
                                                
                                                <h4 className="font-semibold text-gray-800 mb-3">Weekly Impressions by Product</h4>
                                                <div className="space-y-2">
                                                    {Object.entries(searchResult.products).map(([product, data]) => (
                                                        <div key={product} className={`flex justify-between items-center p-3 rounded-lg ${product === selectedProduct ? 'bg-emerald-100 border-2 border-emerald-400' : 'bg-white'}`}>
                                                            <span className="font-medium text-gray-700">{product}</span>
                                                            <div className="text-right">
                                                                <span className="text-lg font-bold text-gray-800">{data.weekly.toLocaleString()}</span>
                                                                <span className="text-sm text-gray-500 ml-2">/ week</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Formula Info */}
                                    <div className="bg-gray-50 rounded-xl p-4 border">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                            <Icon name="Info" size={16} />
                                            How it's calculated
                                        </h4>
                                        <p className="text-sm text-gray-600">
                                            <code className="bg-gray-200 px-2 py-0.5 rounded">Weekly Imps = (Population √∑ Sq Miles) √ó 0.75 √ó Product Multiplier</code>
                                        </p>
                                        <div className="mt-2 text-xs text-gray-500">
                                            Product Multipliers: {Object.entries(PRODUCT_MULTIPLIERS)
                                                .filter(([k]) => k !== 'default' && !k.includes('...'))
                                                .map(([k, v]) => `${k}: ${v}√ó`)
                                                .join(' ‚Ä¢ ')}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-800">
                                        Top 15 ZIPs by {selectedProduct} Impressions
                                    </h3>
                                    <div className="bg-white rounded-xl border overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3 text-left font-semibold text-gray-700">#</th>
                                                    <th className="px-4 py-3 text-left font-semibold text-gray-700">ZIP</th>
                                                    <th className="px-4 py-3 text-left font-semibold text-gray-700">Area</th>
                                                    <th className="px-4 py-3 text-right font-semibold text-gray-700">Pop Density</th>
                                                    <th className="px-4 py-3 text-right font-semibold text-gray-700">Weekly Imps</th>
                                                    <th className="px-4 py-3 text-right font-semibold text-gray-700">4-Week Imps</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {topZips.map((zip, i) => (
                                                    <tr key={zip.zipCode} className="hover:bg-emerald-50 cursor-pointer" onClick={() => { setSearchZip(zip.zipCode); setViewMode('search'); }}>
                                                        <td className="px-4 py-3 font-medium text-gray-500">{i + 1}</td>
                                                        <td className="px-4 py-3 font-bold text-emerald-600">{zip.zipCode}</td>
                                                        <td className="px-4 py-3 text-gray-700">{zip.area}</td>
                                                        <td className="px-4 py-3 text-right text-gray-600">{zip.popDensity.toLocaleString()}/mi¬≤</td>
                                                        <td className="px-4 py-3 text-right font-semibold text-gray-800">{zip.products?.[selectedProduct]?.weekly?.toLocaleString()}</td>
                                                        <td className="px-4 py-3 text-right text-gray-600">{zip.products?.[selectedProduct]?.fourWeek?.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Footer */}
                        <div className="px-6 py-4 bg-gray-50 border-t flex justify-between items-center text-sm text-gray-500">
                            <div>
                                <Icon name="Database" size={14} className="inline mr-1" />
                                {Object.keys(LA_ZIP_DATA).length} ZIPs ‚Ä¢ Based on Census data & Geopath methodology
                            </div>
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: INSTALLATION RISK COMMAND CENTER ---
        const InstallationRiskCommandCenter = ({ allData = [] }) => {
            const formatDateDetails = (baseDate, offsetDays) => {
                const date = new Date(baseDate);
                date.setDate(date.getDate() + offsetDays);
                return {
                    day: new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(date),
                    dateStr: new Intl.DateTimeFormat('en-US', { month: 'short', day: '2-digit' }).format(date),
                    fullDate: date 
                };
            };

            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedCity, setSelectedCity] = useState('Los Angeles, CA');
            const [weatherData, setWeatherData] = useState([]);
            const [isLoadingWeather, setIsLoadingWeather] = useState(true);
            const [weatherError, setWeatherError] = useState(null);
            const [activeTab, setActiveTab] = useState('forecast'); // 'forecast' or 'historical'

            // Available cities from MARKET_COORDINATES
            const availableCities = Object.keys(MARKET_COORDINATES);

            // Fetch live weather on city change
            useEffect(() => {
                const loadWeather = async () => {
                    setIsLoadingWeather(true);
                    setWeatherError(null);
                    try {
                        const data = await fetchLiveWeather(selectedCity);
                        setWeatherData(data);
                    } catch (e) {
                        setWeatherError('Failed to load weather');
                        // Fallback to static data
                        setWeatherData([
                            { day: 'Today', temp: 72, rainChance: 10, condition: 'Clear', icon: 'Sun' },
                            { day: 'Tue', temp: 74, rainChance: 5, condition: 'Sunny', icon: 'Sun' },
                            { day: 'Wed', temp: 71, rainChance: 15, condition: 'Partly Cloudy', icon: 'Cloud' },
                            { day: 'Thu', temp: 68, rainChance: 30, condition: 'Cloudy', icon: 'Cloud' },
                            { day: 'Fri', temp: 70, rainChance: 20, condition: 'Partly Cloudy', icon: 'Cloud' }
                        ]);
                    } finally {
                        setIsLoadingWeather(false);
                    }
                };
                loadWeather();
            }, [selectedCity]);

            const handleCityChange = (newCity) => {
                setSelectedCity(newCity);
            };

            const forecast = useMemo(() => {
                if (!weatherData || weatherData.length === 0) return [];
                return weatherData.slice(0, 5); // First 5 days
            }, [weatherData]);

            // --- HISTORICAL ANALYSIS ---
            const historicalStats = useMemo(() => {
                if (!allData || allData.length === 0) {
                    return {
                        totalCampaigns: 0,
                        delayedCampaigns: [],
                        avgDelayDays: 0,
                        byMonth: {},
                        byMarket: {},
                        holidayImpact: [],
                        weatherPatterns: []
                    };
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Known holidays for analysis
                const knownHolidays = [
                    { name: 'New Year', dates: ['12/31', '01/01', '01/02'] },
                    { name: 'MLK Day', dates: ['01/15', '01/16', '01/17'] },
                    { name: 'Presidents Day', dates: ['02/17', '02/18', '02/19'] },
                    { name: 'Memorial Day', dates: ['05/26', '05/27', '05/28'] },
                    { name: 'July 4th', dates: ['07/03', '07/04', '07/05'] },
                    { name: 'Labor Day', dates: ['09/01', '09/02', '09/03'] },
                    { name: 'Thanksgiving', dates: ['11/27', '11/28', '11/29'] },
                    { name: 'Christmas', dates: ['12/24', '12/25', '12/26'] },
                    { name: 'Hanukkah', dates: ['12/14', '12/15', '12/22'] }
                ];

                // Rainy season months by region
                const rainySeasons = {
                    'Los Angeles': [1, 2, 3, 12], // Winter
                    'Seattle': [10, 11, 12, 1, 2, 3, 4], // Fall-Spring
                    'Miami': [6, 7, 8, 9], // Summer hurricane season
                    'Chicago': [4, 5, 6], // Spring
                    'Boston': [3, 4, 11], // Spring/Fall
                    'New York': [4, 5, 9, 10] // Spring/Fall
                };

                const delayedCampaigns = [];
                const byMonth = {};
                const byMarket = {};
                const holidayDelays = {};
                const seasonalDelays = { rainy: 0, clear: 0, rainyTotal: 0, clearTotal: 0 };

                allData.forEach(item => {
                    const startDate = item.dateObj || (item.date ? new Date(item.date) : null);
                    const firstInstallDate = item.firstInstallDateObj || (item.firstInstall ? new Date(item.firstInstall) : null);
                    const stage = (item.stage || '').toLowerCase();
                    const market = item.market || 'Unknown';
                    const marketCity = market.split(',')[0];

                    if (!startDate || isNaN(startDate.getTime())) return;

                    const month = startDate.getMonth() + 1;
                    const monthName = startDate.toLocaleDateString('en-US', { month: 'short' });
                    const dateStr = `${String(month).padStart(2, '0')}/${String(startDate.getDate()).padStart(2, '0')}`;

                    // Track by month
                    if (!byMonth[monthName]) byMonth[monthName] = { total: 0, delayed: 0, onTime: 0 };
                    byMonth[monthName].total++;

                    // Track by market
                    if (!byMarket[marketCity]) byMarket[marketCity] = { total: 0, delayed: 0, avgDelay: 0, totalDelayDays: 0 };
                    byMarket[marketCity].total++;

                    // Check if this was during rainy season for the market
                    const isRainySeason = rainySeasons[marketCity]?.includes(month);
                    if (isRainySeason) {
                        seasonalDelays.rainyTotal++;
                    } else {
                        seasonalDelays.clearTotal++;
                    }

                    // Check holiday proximity
                    const nearHoliday = knownHolidays.find(h => h.dates.includes(dateStr));

                    // Calculate delay
                    let delayDays = 0;
                    let isDelayed = false;

                    if (firstInstallDate && startDate < firstInstallDate) {
                        // Install happened after start date
                        delayDays = Math.floor((firstInstallDate - startDate) / (1000 * 60 * 60 * 24));
                        if (delayDays > 3) { // Consider >3 days as a meaningful delay
                            isDelayed = true;
                        }
                    } else if (startDate < today && !['installed', 'photos taken', 'pop completed', 'canceled', 'lost opportunity'].includes(stage)) {
                        // Should have started but not installed yet
                        delayDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                        if (delayDays > 0) {
                            isDelayed = true;
                        }
                    }

                    if (isDelayed) {
                        byMonth[monthName].delayed++;
                        byMarket[marketCity].delayed++;
                        byMarket[marketCity].totalDelayDays += delayDays;

                        if (isRainySeason) seasonalDelays.rainy++;
                        if (nearHoliday) {
                            if (!holidayDelays[nearHoliday.name]) holidayDelays[nearHoliday.name] = { count: 0, totalDays: 0 };
                            holidayDelays[nearHoliday.name].count++;
                            holidayDelays[nearHoliday.name].totalDays += delayDays;
                        }

                        delayedCampaigns.push({
                            ...item,
                            delayDays,
                            nearHoliday: nearHoliday?.name,
                            isRainySeason
                        });
                    } else {
                        byMonth[monthName].onTime++;
                    }
                });

                // Calculate averages
                Object.keys(byMarket).forEach(m => {
                    if (byMarket[m].delayed > 0) {
                        byMarket[m].avgDelay = Math.round(byMarket[m].totalDelayDays / byMarket[m].delayed);
                    }
                });

                const totalDelayed = delayedCampaigns.length;
                const avgDelayDays = totalDelayed > 0 
                    ? Math.round(delayedCampaigns.reduce((sum, c) => sum + c.delayDays, 0) / totalDelayed)
                    : 0;

                // Calculate holiday impact stats
                const holidayImpact = Object.entries(holidayDelays)
                    .map(([name, data]) => ({
                        name,
                        count: data.count,
                        avgDays: Math.round(data.totalDays / data.count)
                    }))
                    .sort((a, b) => b.count - a.count);

                // Weather pattern stats
                const rainyDelayRate = seasonalDelays.rainyTotal > 0 
                    ? Math.round((seasonalDelays.rainy / seasonalDelays.rainyTotal) * 100) 
                    : 0;
                const clearDelayRate = seasonalDelays.clearTotal > 0 
                    ? Math.round((seasonalDelays.clear / seasonalDelays.clearTotal) * 100) 
                    : 0;

                return {
                    totalCampaigns: allData.length,
                    delayedCampaigns: delayedCampaigns.sort((a, b) => b.delayDays - a.delayDays).slice(0, 20),
                    totalDelayed,
                    avgDelayDays,
                    byMonth,
                    byMarket: Object.entries(byMarket).sort((a, b) => b[1].delayed - a[1].delayed),
                    holidayImpact,
                    weatherPatterns: {
                        rainyDelayRate,
                        clearDelayRate,
                        rainyTotal: seasonalDelays.rainyTotal,
                        clearTotal: seasonalDelays.clearTotal
                    }
                };
            }, [allData]);

            const holidays = [
                { name: 'Christmas Eve', date: 'Dec 24' }, { name: 'Christmas Day', date: 'Dec 25' },
                { name: 'New Year\'s Eve', date: 'Dec 31' }, { name: 'New Year\'s Day', date: 'Jan 01' },
            ];

            const getDelayRisk = (percentage) => {
                if (percentage > 85) return { level: 'CRITICAL', label: 'Heavy Delays Certain', color: 'bg-red-100 text-red-800 border-red-200' };
                if (percentage > 75) return { level: 'HIGH', label: 'Big Chance of Delays', color: 'bg-orange-100 text-orange-800 border-orange-200' };
                return { level: 'LOW', label: 'No Delays Expected', color: 'bg-green-100 text-green-800 border-green-200' };
            };

            const getUpcomingHolidays = () => {
                if (!forecast || forecast.length === 0) return [];
                const datesInForecast = forecast.map(f => f.date);
                return holidays.filter(h => datesInForecast.includes(h.date));
            };

            const smartSummary = useMemo(() => {
                // Guard against empty forecast array
                if (!forecast || forecast.length === 0) {
                    return {
                        title: "Loading Weather Data...",
                        message: "Fetching live weather forecast for your market.",
                        subMessage: "Please wait a moment.",
                        alertType: "info"
                    };
                }

                const worstDayIndex = forecast.reduce((maxIdx, current, idx, arr) => 
                    current.rainChance > arr[maxIdx].rainChance ? idx : maxIdx, 0
                );
                const worstDay = forecast[worstDayIndex];
                const highestRainChance = worstDay?.rainChance || 0;
                const upcoming = getUpcomingHolidays();
                const hasHolidays = upcoming.length > 0;
                const holidayNames = upcoming.map(h => h.name).join(' and ');

                let title = "", message = "", subMessage = "", alertType = "success"; 

                if (highestRainChance > 85) {
                    alertType = "error";
                    title = "Installation Halted: Critical Weather Alert";
                    message = `Heavy installation delays are inevitable due to severe precipitation levels on ${worstDay?.day || 'upcoming day'} (${highestRainChance}%).`;
                    if (hasHolidays) subMessage = `COMPOUNDING FACTOR: These delays will be worsened by reduced workforce availability during ${holidayNames}.`;
                } else if (highestRainChance > 75) {
                    alertType = "warning";
                    title = "Schedule At Risk: Weather Warning";
                    message = `There is a significant probability of schedule slippage due to rain on ${worstDay?.day || 'upcoming day'} (${highestRainChance}%).`;
                    if (hasHolidays) subMessage = `LOGISTICS NOTE: Rescheduling options are limited due to upcoming ${holidayNames} observances.`;
                } else {
                    if (hasHolidays) {
                        alertType = "info"; 
                        title = "Weather Clear / Logistics Alert";
                        message = `Weather conditions are favorable, but installation capacity is reduced due to ${holidayNames}.`;
                        subMessage = "Ensure crews are confirmed 48 hours in advance.";
                    } else {
                        alertType = "success";
                        title = "Schedule On Track";
                        message = "Operations are green. Weather conditions remain favorable for all scheduled installations.";
                        subMessage = "No significant rain or holiday constraints detected in the 5-day window.";
                    }
                }
                return { title, message, subMessage, alertType };
            }, [forecast]);

            const updateRainChance = (index, newValue) => {
                const newWeatherData = [...weatherData];
                newWeatherData[index].rainChance = parseInt(newValue);
                setWeatherData(newWeatherData);
            };

            return (
                <div className="bg-slate-50 p-6 rounded-xl min-h-full">
                    <div className="max-w-5xl mx-auto space-y-8">
                        {/* Header */}
                        <div className="flex flex-col md:flex-row justify-between items-end border-b border-slate-200 pb-4 gap-4">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900">Installation Command Center</h1>
                                <p className="text-slate-500 mt-1">Forecast & Schedule Risk Analysis</p>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex flex-col items-end gap-2">
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">Region</label>
                                    <div className="relative">
                                        <select value={selectedCity} onChange={(e) => handleCityChange(e.target.value)}
                                            className="appearance-none bg-white border border-slate-300 text-slate-700 py-1 pl-3 pr-8 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium cursor-pointer">
                                            {availableCities.map(city => <option key={city} value={city}>{city}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-2 text-slate-400 pointer-events-none"><Icon name="MapPin" size={14} /></div>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end gap-2">
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">Forecast Start Date</label>
                                    <div className="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-300 shadow-sm">
                                        <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="px-2 py-1 text-slate-700 focus:outline-none font-medium" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Tab Navigation */}
                        <div className="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 w-fit">
                            <button 
                                onClick={() => setActiveTab('forecast')}
                                className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2 ${activeTab === 'forecast' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100'}`}
                            >
                                <Icon name="Cloud" size={16} /> Live Forecast
                            </button>
                            <button 
                                onClick={() => setActiveTab('historical')}
                                className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all flex items-center gap-2 ${activeTab === 'historical' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100'}`}
                            >
                                <Icon name="History" size={16} /> Historical Analysis
                            </button>
                        </div>

                        {activeTab === 'forecast' ? (
                            <>
                                {/* Smart Summary */}
                                <div className={`p-6 rounded-xl border-l-8 shadow-sm transition-all duration-300 ${
                                    smartSummary.alertType === 'error' ? 'bg-white border-red-500 shadow-red-100' :
                                    smartSummary.alertType === 'warning' ? 'bg-white border-orange-400 shadow-orange-100' :
                                    smartSummary.alertType === 'info' ? 'bg-white border-purple-500 shadow-purple-100' :
                                    'bg-white border-green-500 shadow-green-100'
                                }`}>
                                    <div className="flex items-start gap-4">
                                        <div className={`mt-1 p-2 rounded-full ${
                                            smartSummary.alertType === 'error' ? 'bg-red-100 text-red-600' :
                                            smartSummary.alertType === 'warning' ? 'bg-orange-100 text-orange-600' :
                                            smartSummary.alertType === 'info' ? 'bg-purple-100 text-purple-600' :
                                            'bg-green-100 text-green-600'
                                        }`}>
                                            <Icon name={smartSummary.alertType === 'error' ? "AlertOctagon" : smartSummary.alertType === 'warning' ? "AlertTriangle" : smartSummary.alertType === 'info' ? "Calendar" : "CheckCircle"} size={24} />
                                        </div>
                                        <div className="flex-1">
                                            <h2 className={`text-xl font-bold mb-1 ${
                                                smartSummary.alertType === 'error' ? 'text-red-700' :
                                                smartSummary.alertType === 'warning' ? 'text-orange-700' :
                                                smartSummary.alertType === 'info' ? 'text-purple-700' :
                                                'text-green-700'
                                            }`}>{smartSummary.title}</h2>
                                            <p className="text-lg font-medium leading-relaxed text-slate-700">{smartSummary.message}</p>
                                            {smartSummary.subMessage && (
                                                <div className="mt-3 pt-3 border-t border-slate-200 flex items-start gap-2 text-sm font-semibold text-slate-600">
                                                    <Icon name="Info" size={16} className="mt-0.5 shrink-0" />
                                                    <span>{smartSummary.subMessage}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                        {/* Dashboard Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-sm uppercase tracking-wide text-slate-400 font-bold">Live Forecast ({selectedCity.split(',')[0]})</h3>
                                    {isLoadingWeather ? (
                                        <span className="text-xs text-blue-700 bg-blue-100 px-2 py-1 rounded font-bold flex items-center gap-1">
                                            <Icon name="RefreshCw" size={12} className="animate-spin" /> Loading...
                                        </span>
                                    ) : weatherError ? (
                                        <span className="text-xs text-orange-700 bg-orange-100 px-2 py-1 rounded font-bold">Cached Data</span>
                                    ) : (
                                        <span className="text-xs text-green-700 bg-green-100 px-2 py-1 rounded font-bold flex items-center gap-1">
                                            <Icon name="Wifi" size={12} /> Live Data
                                        </span>
                                    )}
                                </div>
                                <div className="space-y-6">
                                    {isLoadingWeather ? (
                                        <div className="flex flex-col items-center justify-center py-12 text-slate-400">
                                            <Icon name="Cloud" size={48} className="mb-3 animate-pulse" />
                                            <p className="text-sm">Fetching weather data...</p>
                                        </div>
                                    ) : forecast.map((day, idx) => {
                                        const risk = getDelayRisk(day.rainChance);
                                        const isHoliday = holidays.find(h => h.date === day.date);
                                        return (
                                            <div key={idx} className="relative group">
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center transition-colors ${risk.color}`}>
                                                            <Icon name={day.icon || (day.rainChance > 75 ? "CloudRain" : day.rainChance > 20 ? "Cloud" : "Sun")} size={20} />
                                                        </div>
                                                        <div>
                                                            <div className="font-semibold flex items-center gap-2">
                                                                {day.day} <span className="text-slate-400 font-normal text-sm">({day.date || ''})</span>
                                                                {isHoliday && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold animate-pulse">{isHoliday.name}</span>}
                                                            </div>
                                                            <div className="text-xs text-slate-500">{day.condition} ‚Ä¢ {day.temp}¬∞F</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className={`text-xl font-bold ${day.rainChance > 85 ? 'text-red-600' : day.rainChance > 75 ? 'text-orange-500' : 'text-slate-700'}`}>{day.rainChance}%</span>
                                                    </div>
                                                </div>
                                                <div className={`w-full h-2 rounded-lg ${day.rainChance > 85 ? 'bg-red-200' : day.rainChance > 75 ? 'bg-orange-200' : day.rainChance > 30 ? 'bg-yellow-200' : 'bg-green-200'}`}>
                                                    <div className={`h-full rounded-lg ${day.rainChance > 85 ? 'bg-red-500' : day.rainChance > 75 ? 'bg-orange-500' : day.rainChance > 30 ? 'bg-yellow-500' : 'bg-green-500'}`} style={{ width: `${day.rainChance}%` }}></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                    <h3 className="text-sm uppercase tracking-wide text-slate-400 font-bold mb-4">Risk Criteria</h3>
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-100">
                                            <div className="w-2 h-12 bg-green-500 rounded-full"></div>
                                            <div><div className="font-bold text-green-900">0% - 75% Rain</div><div className="text-sm text-green-700">Safe zone. Standard velocity.</div></div>
                                        </div>
                                        <div className="flex items-center gap-3 p-3 bg-orange-50 rounded-lg border border-orange-100">
                                            <div className="w-2 h-12 bg-orange-500 rounded-full"></div>
                                            <div><div className="font-bold text-orange-900">76% - 85% Rain</div><div className="text-sm text-orange-700">Warning zone. Expect delays.</div></div>
                                        </div>
                                        <div className="flex items-center gap-3 p-3 bg-red-50 rounded-lg border border-red-100">
                                            <div className="w-2 h-12 bg-red-600 rounded-full"></div>
                                            <div><div className="font-bold text-red-900">86%+ Rain</div><div className="text-sm text-red-700">No-Go zone. Automatic rescheduling.</div></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-purple-50 p-6 rounded-xl border border-purple-100">
                                    <div className="flex items-center gap-2 mb-2 text-purple-800 font-bold"><Icon name="Calendar" size={18} /><span>Known Constraints</span></div>
                                    <div className="flex flex-wrap gap-2">
                                        {holidays.map((h, i) => (
                                            <span key={i} className={`px-3 py-1 border rounded-full text-xs font-semibold shadow-sm transition-all ${forecast.some(f => f.date === h.date) ? "bg-purple-600 text-white border-purple-700" : "bg-white text-slate-400 border-slate-200"}`}>{h.date}: {h.name}</span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                            </>
                        ) : (
                            /* Historical Analysis Tab */
                            <div className="space-y-6">
                                {/* Stats Overview */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-blue-100 rounded-lg text-blue-600">
                                                <Icon name="FileText" size={20} />
                                            </div>
                                            <span className="text-xs font-bold text-slate-500 uppercase">Total Campaigns</span>
                                        </div>
                                        <div className="text-3xl font-bold text-slate-800">{historicalStats.totalCampaigns}</div>
                                        <div className="text-xs text-slate-500 mt-1">In dataset</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl border border-red-200 shadow-sm">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-red-100 rounded-lg text-red-600">
                                                <Icon name="AlertTriangle" size={20} />
                                            </div>
                                            <span className="text-xs font-bold text-slate-500 uppercase">Delayed Installs</span>
                                        </div>
                                        <div className="text-3xl font-bold text-red-600">{historicalStats.totalDelayed}</div>
                                        <div className="text-xs text-slate-500 mt-1">Started late or pending</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl border border-orange-200 shadow-sm">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-orange-100 rounded-lg text-orange-600">
                                                <Icon name="Clock" size={20} />
                                            </div>
                                            <span className="text-xs font-bold text-slate-500 uppercase">Avg Delay</span>
                                        </div>
                                        <div className="text-3xl font-bold text-orange-600">{historicalStats.avgDelayDays}</div>
                                        <div className="text-xs text-slate-500 mt-1">Days behind schedule</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl border border-purple-200 shadow-sm">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="p-2 bg-purple-100 rounded-lg text-purple-600">
                                                <Icon name="CloudRain" size={20} />
                                            </div>
                                            <span className="text-xs font-bold text-slate-500 uppercase">Weather Impact</span>
                                        </div>
                                        <div className="text-3xl font-bold text-purple-600">{historicalStats.weatherPatterns.rainyDelayRate}%</div>
                                        <div className="text-xs text-slate-500 mt-1">Delay rate in rainy season</div>
                                    </div>
                                </div>

                                {/* Holiday Impact Analysis */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                                            <Icon name="Calendar" size={16} className="text-purple-500" /> Holiday Impact on Delays
                                        </h3>
                                        {historicalStats.holidayImpact.length > 0 ? (
                                            <div className="space-y-3">
                                                {historicalStats.holidayImpact.map((holiday, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-lg">üóìÔ∏è</span>
                                                            <div>
                                                                <div className="font-semibold text-slate-800">{holiday.name}</div>
                                                                <div className="text-xs text-slate-500">Avg {holiday.avgDays} days delayed</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className="text-xl font-bold text-purple-600">{holiday.count}</span>
                                                            <div className="text-xs text-slate-500">delays</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center py-8 text-slate-400">
                                                <Icon name="CheckCircle" size={32} className="mx-auto mb-2 text-green-400" />
                                                <p>No holiday-related delays detected</p>
                                            </div>
                                        )}
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                                            <Icon name="CloudRain" size={16} className="text-blue-500" /> Seasonal Weather Patterns
                                        </h3>
                                        <div className="space-y-4">
                                            <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-blue-800 flex items-center gap-2">
                                                        <Icon name="CloudRain" size={16} /> Rainy Season
                                                    </span>
                                                    <span className="text-2xl font-bold text-blue-600">{historicalStats.weatherPatterns.rainyDelayRate}%</span>
                                                </div>
                                                <div className="text-xs text-blue-600">
                                                    {historicalStats.weatherPatterns.rainyTotal} campaigns during wet months
                                                </div>
                                                <div className="mt-2 h-2 bg-blue-200 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 rounded-full" style={{ width: `${historicalStats.weatherPatterns.rainyDelayRate}%` }}></div>
                                                </div>
                                            </div>
                                            <div className="p-4 bg-green-50 rounded-lg border border-green-100">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-green-800 flex items-center gap-2">
                                                        <Icon name="Sun" size={16} /> Clear Season
                                                    </span>
                                                    <span className="text-2xl font-bold text-green-600">{historicalStats.weatherPatterns.clearDelayRate}%</span>
                                                </div>
                                                <div className="text-xs text-green-600">
                                                    {historicalStats.weatherPatterns.clearTotal} campaigns during dry months
                                                </div>
                                                <div className="mt-2 h-2 bg-green-200 rounded-full overflow-hidden">
                                                    <div className="h-full bg-green-500 rounded-full" style={{ width: `${historicalStats.weatherPatterns.clearDelayRate}%` }}></div>
                                                </div>
                                            </div>
                                            {historicalStats.weatherPatterns.rainyDelayRate > historicalStats.weatherPatterns.clearDelayRate + 10 && (
                                                <div className="p-3 bg-amber-50 rounded-lg border border-amber-200 text-amber-800 text-sm flex items-start gap-2">
                                                    <Icon name="AlertTriangle" size={16} className="mt-0.5 shrink-0" />
                                                    <span><strong>Insight:</strong> Delay rate is {historicalStats.weatherPatterns.rainyDelayRate - historicalStats.weatherPatterns.clearDelayRate}% higher during rainy season. Consider buffer time for wet-month campaigns.</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Market Performance */}
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                                        <Icon name="MapPin" size={16} className="text-red-500" /> Delays by Market
                                    </h3>
                                    <div className="max-h-[300px] overflow-y-auto">
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                            {historicalStats.byMarket.map(([market, data], idx) => (
                                                <div key={idx} className={`p-3 rounded-lg border ${data.delayed > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                                    <div className="font-semibold text-slate-800 text-sm truncate">{market}</div>
                                                    <div className="flex items-baseline gap-1 mt-1">
                                                        <span className={`text-xl font-bold ${data.delayed > 0 ? 'text-red-600' : 'text-green-600'}`}>{data.delayed}</span>
                                                        <span className="text-xs text-slate-500">/ {data.total}</span>
                                                    </div>
                                                    {data.avgDelay > 0 && (
                                                        <div className="text-xs text-slate-500 mt-1">~{data.avgDelay}d avg</div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Monthly Trends */}
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                                        <Icon name="TrendingUp" size={16} className="text-blue-500" /> Monthly Delay Trends
                                    </h3>
                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                        {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(month => {
                                            const data = historicalStats.byMonth[month] || { total: 0, delayed: 0 };
                                            const delayRate = data.total > 0 ? Math.round((data.delayed / data.total) * 100) : 0;
                                            return (
                                                <div key={month} className="flex flex-col items-center min-w-[60px]">
                                                    <div className="h-24 w-8 bg-slate-100 rounded-t-lg relative flex items-end overflow-hidden">
                                                        <div 
                                                            className={`w-full rounded-t transition-all ${delayRate > 30 ? 'bg-red-400' : delayRate > 15 ? 'bg-orange-400' : 'bg-blue-400'}`}
                                                            style={{ height: `${Math.max(delayRate, 5)}%` }}
                                                        ></div>
                                                    </div>
                                                    <div className="text-xs font-semibold text-slate-600 mt-1">{month}</div>
                                                    <div className="text-xs text-slate-400">{data.total}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="flex gap-4 mt-4 text-xs text-slate-500 justify-center">
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 bg-blue-400 rounded"></span> {'<'}15% delay</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 bg-orange-400 rounded"></span> 15-30% delay</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 bg-red-400 rounded"></span> {'>'}30% delay</span>
                                    </div>
                                </div>

                                {/* Recent Delays Table */}
                                {historicalStats.delayedCampaigns.length > 0 && (
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
                                            <Icon name="List" size={16} className="text-red-500" /> Most Delayed Campaigns ({historicalStats.delayedCampaigns.length})
                                        </h3>
                                        <div className="overflow-x-auto max-h-[400px] overflow-y-auto">
                                            <table className="w-full text-sm">
                                                <thead className="sticky top-0 bg-white z-10">
                                                    <tr className="border-b border-slate-200">
                                                        <th className="text-left py-2 px-3 text-slate-500 font-semibold">Campaign</th>
                                                        <th className="text-left py-2 px-3 text-slate-500 font-semibold">Market</th>
                                                        <th className="text-left py-2 px-3 text-slate-500 font-semibold">Start Date</th>
                                                        <th className="text-center py-2 px-3 text-slate-500 font-semibold">Delay</th>
                                                        <th className="text-left py-2 px-3 text-slate-500 font-semibold">Factors</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historicalStats.delayedCampaigns.map((c, idx) => (
                                                        <tr key={idx} className="border-b border-slate-100 hover:bg-slate-50">
                                                            <td className="py-2 px-3">
                                                                <div className="font-medium text-slate-800">{c.advertiser}</div>
                                                                <div className="text-xs text-slate-500">{c.id}</div>
                                                            </td>
                                                            <td className="py-2 px-3 text-slate-600">{c.market?.split(',')[0]}</td>
                                                            <td className="py-2 px-3 text-slate-600">{c.date}</td>
                                                            <td className="py-2 px-3 text-center">
                                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${c.delayDays > 14 ? 'bg-red-100 text-red-700' : c.delayDays > 7 ? 'bg-orange-100 text-orange-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                                    {c.delayDays}d
                                                                </span>
                                                            </td>
                                                            <td className="py-2 px-3">
                                                                <div className="flex gap-1 flex-wrap">
                                                                    {c.nearHoliday && (
                                                                        <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">üóìÔ∏è {c.nearHoliday}</span>
                                                                    )}
                                                                    {c.isRainySeason && (
                                                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">üåßÔ∏è Rainy Season</span>
                                                                    )}
                                                                    {!c.nearHoliday && !c.isRainySeason && (
                                                                        <span className="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-xs">Unknown</span>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: AVAILABILITY COMPONENT ---
        const AvailabilityComponent = ({ allData }) => {
            // Helper to ensure we have a valid Date object (handles localStorage string serialization)
            const ensureDate = (dateValue) => {
                if (!dateValue) return null;
                if (dateValue instanceof Date) return isNaN(dateValue.getTime()) ? null : dateValue;
                // It's a string, parse it
                const parsed = new Date(dateValue);
                return isNaN(parsed.getTime()) ? null : parsed;
            };
            
            // --- MARKET & MEDIA INVENTORY PRESETS (Editable by chartist) ---
            const DEFAULT_INVENTORY = {
                'Los Angeles - STAP': { 'Transit Shelter-Digital Panel-Spot': 500, 'Transit Shelter-Digital Network-Spot': 400, 'Transit Shelters-Panel-Targeted': 2000, 'Transit Shelters-Panel-Network': 1500, 'Transit Shelters-Panel-Icon': 800, 'Transit Shelters-Domination': 200, 'Transit Shelter-Digital Panel-Spot-Playlist A': 100, 'Other': 1000 },
                'Los Angeles, CA': { 'Transit Buses-King': 150, 'Transit Buses-Kong': 80, 'Transit Buses-Full Side': 120, 'Transit Buses-Full Back': 120, 'Transit Buses-Full Wrap': 40, 'Transit Buses-Tailight Display': 100, 'Digital Billboards': 25, 'Other': 200 },
                'Dallas, TX': { 'Transit Buses-King': 100, 'Transit Buses-Kong': 50, 'Transit Buses-Full Side': 80, 'Transit Buses-Full Back': 80, 'Transit Buses-Full Wrap': 30, 'Other': 150 },
                'Miami, FL': { 'Transit Buses-King': 80, 'Transit Buses-Kong': 40, 'Transit Buses-Full Side': 60, 'Other': 120 },
                'Chicago, IL': { 'Transit Buses-King': 90, 'Transit Buses-Kong': 45, 'Transit Buses-Full Side': 70, 'Other': 130 },
                'Boston, MA': { 'Transit Buses-King': 60, 'Transit Buses-Kong': 30, 'Other': 100 },
                'Other Markets': { 'All Media': 500 }
            };

            // Market coordinates for map
            const MARKET_COORDS = {
                'Los Angeles, CA': [34.05, -118.24],
                'Dallas, TX': [32.78, -96.80],
                'Miami, FL': [25.76, -80.19],
                'Chicago, IL': [41.88, -87.63],
                'Boston, MA': [42.36, -71.06],
                'New York, NY': [40.71, -74.01],
                'Seattle, WA': [47.61, -122.33],
                'San Francisco, CA': [37.77, -122.42],
                'Orlando, FL': [28.54, -81.38],
                'Las Vegas, NV': [36.17, -115.14],
                'Baltimore, MD': [39.29, -76.61],
                'Philadelphia, PA': [39.95, -75.17],
                'Washington D.C., DC': [38.91, -77.04],
                'Phoenix, AZ': [33.45, -112.07],
                'Denver, CO': [39.74, -104.99],
                'Atlanta, GA': [33.75, -84.39],
                'Houston, TX': [29.76, -95.37],
                'San Diego, CA': [32.72, -117.16],
                'Minneapolis, MN': [44.98, -93.27],
                'Detroit, MI': [42.33, -83.05],
                'Portland, OR': [45.52, -122.68],
                'Charlotte, NC': [35.23, -80.84],
                'Tampa, FL': [27.95, -82.46],
                'Austin, TX': [30.27, -97.74],
                'Nashville, TN': [36.16, -86.78],
                'Broward County, FL': [26.12, -80.14],
                'Orange County, CA': [33.72, -117.83],
                'Howard County, MD': [39.25, -76.93],
                'Lakeland, FL': [28.04, -81.95],
                'Santa Monica, CA': [34.02, -118.49]
            };

            // --- STATE ---
            const [rangeStart, setRangeStart] = useState(() => {
                const d = new Date();
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
                const monday = new Date(d.setDate(diff));
                return monday.toISOString().split('T')[0];
            });
            const [rangeEnd, setRangeEnd] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() + 90); 
                return d.toISOString().split('T')[0];
            });
            
            const [selectedMarket, setSelectedMarket] = useState('ALL');
            const [selectedMedia, setSelectedMedia] = useState('ALL');
            const [selectedZip, setSelectedZip] = useState(''); // NEW: ZIP code filter
            const [inventoryOverride, setInventoryOverride] = useState(null); // Manual override
            const [requiredSize, setRequiredSize] = useState(50);
            const [includeHolds, setIncludeHolds] = useState(true);
            const [viewMode, setViewMode] = useState('daily'); // 'daily', 'weekly', 'monthly', or 'yearly'
            const [chartView, setChartView] = useState('timeline'); // 'timeline', 'map', or 'geopath'
            const [sortByImpressions, setSortByImpressions] = useState(false); // NEW: Sort openings by impressions
            
            // --- IMPRESSIONS ESTIMATION HELPER ---
            // Maps product types to estimated weekly impressions per unit
            const getProductImpressions = (productType) => {
                if (!productType) return { weekly: 5000, multiplier: 1.0 };
                const prodLower = productType.toLowerCase();
                
                // Digital products - highest impressions due to rotation
                if (prodLower.includes('digital')) {
                    if (prodLower.includes('spectacular') || prodLower.includes('domination')) {
                        return { weekly: 85000, multiplier: 2.8, tier: 'Premium Digital' };
                    }
                    if (prodLower.includes('billboard')) {
                        return { weekly: 65000, multiplier: 2.5, tier: 'Digital Billboard' };
                    }
                    return { weekly: 45000, multiplier: 2.0, tier: 'Digital' };
                }
                
                // Transit - varies by placement
                if (prodLower.includes('transit') || prodLower.includes('bus')) {
                    if (prodLower.includes('full wrap')) {
                        return { weekly: 55000, multiplier: 1.8, tier: 'Transit Premium' };
                    }
                    if (prodLower.includes('king') || prodLower.includes('kong')) {
                        return { weekly: 35000, multiplier: 1.4, tier: 'Transit Large' };
                    }
                    if (prodLower.includes('shelter')) {
                        return { weekly: 18000, multiplier: 0.65, tier: 'Transit Shelter' };
                    }
                    return { weekly: 25000, multiplier: 1.0, tier: 'Transit' };
                }
                
                // Wallscapes & Large Format
                if (prodLower.includes('wallscape') || prodLower.includes('mural')) {
                    return { weekly: 70000, multiplier: 1.8, tier: 'Wallscape' };
                }
                
                // Bulletins & Posters
                if (prodLower.includes('bulletin') || prodLower.includes('spectacular')) {
                    return { weekly: 50000, multiplier: 1.5, tier: 'Bulletin' };
                }
                if (prodLower.includes('poster') || prodLower.includes('panel')) {
                    if (prodLower.includes('targeted') || prodLower.includes('premier')) {
                        return { weekly: 32000, multiplier: 1.15, tier: 'Panel Targeted' };
                    }
                    return { weekly: 25000, multiplier: 0.95, tier: 'Panel/Poster' };
                }
                
                // Street furniture
                if (prodLower.includes('bench') || prodLower.includes('kiosk') || prodLower.includes('furniture')) {
                    return { weekly: 12000, multiplier: 0.55, tier: 'Street Furniture' };
                }
                
                // Default
                return { weekly: 20000, multiplier: 1.0, tier: 'Standard' };
            };
            
            // Map ref for Leaflet
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            
            // Popup state for campaign details (click to open, click outside to close)
            const [expandedRowId, setExpandedRowId] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);
            
            // Handle escape key to exit fullscreen
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape' && isFullscreen) {
                        setIsFullscreen(false);
                    }
                };
                window.addEventListener('keydown', handleEscape);
                return () => window.removeEventListener('keydown', handleEscape);
            }, [isFullscreen]);
            
            // Geopath Plotter State
            const [geopathData, setGeopathData] = useState([]);
            const [geopathFile, setGeopathFile] = useState(null);
            const [geopathStats, setGeopathStats] = useState(null);
            const geopathMapRef = useRef(null);
            const geopathMapInstanceRef = useRef(null);

            // --- GEOPATH CSV PARSER ---
            const parseGeopathCSV = (text) => {
                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) return [];
                
                // Parse header row
                const parseRow = (line) => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') { inQuotes = !inQuotes; }
                        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                        else { current += char; }
                    }
                    result.push(current.trim());
                    return result;
                };
                
                const headers = parseRow(lines[0]).map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'));
                
                // Find relevant columns (flexible matching)
                const findColumn = (patterns) => {
                    return headers.findIndex(h => patterns.some(p => h.includes(p)));
                };
                
                const latIdx = findColumn(['latitude', 'lat', 'y_coord']);
                const lonIdx = findColumn(['longitude', 'lon', 'lng', 'long', 'x_coord']);
                const impIdx = findColumn(['impression', 'imps', 'weekly_imp', 'daily_imp', 'avg_imp', 'target_imp']);
                const idIdx = findColumn(['geopath_id', 'spot_id', 'panel_id', 'unit_id', 'id', 'plant_unit']);
                const nameIdx = findColumn(['name', 'description', 'location', 'address', 'street']);
                const mediaIdx = findColumn(['media_type', 'media', 'product', 'type', 'format']);
                const marketIdx = findColumn(['market', 'dma', 'cbsa', 'city']);
                const reachIdx = findColumn(['reach', 'target_reach']);
                const freqIdx = findColumn(['frequency', 'freq', 'avg_frequency']);
                
                if (latIdx === -1 || lonIdx === -1) {
                    alert('CSV must contain Latitude and Longitude columns');
                    return [];
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseRow(lines[i]);
                    const lat = parseFloat(values[latIdx]);
                    const lon = parseFloat(values[lonIdx]);
                    
                    if (isNaN(lat) || isNaN(lon)) continue;
                    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) continue;
                    
                    const impressions = impIdx !== -1 ? parseFloat(values[impIdx]?.replace(/,/g, '')) || 0 : 0;
                    
                    data.push({
                        lat,
                        lon,
                        impressions,
                        id: idIdx !== -1 ? values[idIdx] : `LOC-${i}`,
                        name: nameIdx !== -1 ? values[nameIdx] : '',
                        media: mediaIdx !== -1 ? values[mediaIdx] : '',
                        market: marketIdx !== -1 ? values[marketIdx] : '',
                        reach: reachIdx !== -1 ? parseFloat(values[reachIdx]?.replace(/,/g, '')) || 0 : 0,
                        frequency: freqIdx !== -1 ? parseFloat(values[freqIdx]) || 0 : 0,
                        raw: values
                    });
                }
                
                return data;
            };

            // Handle Geopath file upload
            const handleGeopathUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setGeopathFile(file);
                const reader = new FileReader();
                reader.onload = (event) => {
                    const parsed = parseGeopathCSV(event.target.result);
                    setGeopathData(parsed);
                    
                    // Calculate stats
                    if (parsed.length > 0) {
                        const impressions = parsed.map(d => d.impressions).filter(i => i > 0);
                        const stats = {
                            total: parsed.length,
                            withImpressions: impressions.length,
                            totalImpressions: impressions.reduce((s, i) => s + i, 0),
                            avgImpressions: impressions.length > 0 ? Math.round(impressions.reduce((s, i) => s + i, 0) / impressions.length) : 0,
                            minImpressions: impressions.length > 0 ? Math.min(...impressions) : 0,
                            maxImpressions: impressions.length > 0 ? Math.max(...impressions) : 0,
                            medianImpressions: impressions.length > 0 ? impressions.sort((a, b) => a - b)[Math.floor(impressions.length / 2)] : 0,
                            markets: [...new Set(parsed.map(d => d.market).filter(Boolean))],
                            mediaTypes: [...new Set(parsed.map(d => d.media).filter(Boolean))]
                        };
                        setGeopathStats(stats);
                        setChartView('geopath'); // Auto-switch to Geopath view
                    }
                };
                reader.readAsText(file);
            };

            // --- GEOPATH MAP INITIALIZATION ---
            useEffect(() => {
                if (chartView !== 'geopath' || !geopathMapRef.current || geopathData.length === 0) return;
                
                // Clean up existing map
                if (geopathMapInstanceRef.current) {
                    geopathMapInstanceRef.current.remove();
                    geopathMapInstanceRef.current = null;
                }

                // Calculate bounds
                const lats = geopathData.map(d => d.lat);
                const lons = geopathData.map(d => d.lon);
                const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
                const centerLon = (Math.min(...lons) + Math.max(...lons)) / 2;

                // Initialize map
                const map = L.map(geopathMapRef.current, {
                    center: [centerLat || 39.8, centerLon || -98.5],
                    zoom: 10,
                    scrollWheelZoom: true
                });

                // Add tile layer (dark mode for better visibility)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                    maxZoom: 19
                }).addTo(map);

                // Calculate impression thresholds for coloring
                const impressions = geopathData.map(d => d.impressions).filter(i => i > 0);
                const sortedImps = [...impressions].sort((a, b) => a - b);
                const p25 = sortedImps[Math.floor(sortedImps.length * 0.25)] || 0;
                const p50 = sortedImps[Math.floor(sortedImps.length * 0.50)] || 0;
                const p75 = sortedImps[Math.floor(sortedImps.length * 0.75)] || 0;
                const p90 = sortedImps[Math.floor(sortedImps.length * 0.90)] || 0;

                // Color scale function
                const getColor = (imp) => {
                    if (imp === 0) return '#6b7280'; // gray for no data
                    if (imp >= p90) return '#22c55e'; // green - top 10%
                    if (imp >= p75) return '#84cc16'; // lime - top 25%
                    if (imp >= p50) return '#eab308'; // yellow - above median
                    if (imp >= p25) return '#f97316'; // orange - below median
                    return '#ef4444'; // red - bottom 25%
                };

                // Add markers
                geopathData.forEach(loc => {
                    const color = getColor(loc.impressions);
                    const radius = loc.impressions > 0 
                        ? Math.max(5, Math.min(15, 5 + (loc.impressions / (p90 || 1)) * 10))
                        : 5;
                    
                    const circle = L.circleMarker([loc.lat, loc.lon], {
                        radius: radius,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // Popup with details
                    const popupContent = `
                        <div style="min-width: 200px; font-family: Inter, sans-serif;">
                            <h3 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #1e293b;">
                                ${loc.name || loc.id}
                            </h3>
                            ${loc.media ? `<div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">‚ñ∏ ${loc.media}</div>` : ''}
                            ${loc.market ? `<div style="font-size: 11px; color: #64748b; margin-bottom: 8px;">‚óâ ${loc.market}</div>` : ''}
                            
                            <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">Weekly Impressions</div>
                                <div style="font-size: 20px; font-weight: bold; color: ${color};">
                                    ${loc.impressions > 0 ? loc.impressions.toLocaleString() : 'N/A'}
                                </div>
                                ${loc.impressions > 0 ? `
                                    <div style="font-size: 10px; color: #64748b; margin-top: 4px;">
                                        ${loc.impressions >= p90 ? '‚òÖ Top 10%' : 
                                          loc.impressions >= p75 ? '‚ñ≤ Top 25%' : 
                                          loc.impressions >= p50 ? '‚óè Above Median' : 
                                          loc.impressions >= p25 ? '‚ñº Below Median' : '‚óã Bottom 25%'}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${loc.reach > 0 || loc.frequency > 0 ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                    ${loc.reach > 0 ? `<div><span style="color: #64748b;">Reach:</span> <strong>${loc.reach.toLocaleString()}</strong></div>` : ''}
                                    ${loc.frequency > 0 ? `<div><span style="color: #64748b;">Freq:</span> <strong>${loc.frequency.toFixed(1)}</strong></div>` : ''}
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                ID: ${loc.id}<br>
                                Coords: ${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}
                            </div>
                        </div>
                    `;
                    
                    circle.bindPopup(popupContent, { maxWidth: 300 });
                    circle.bindTooltip(`${loc.impressions > 0 ? loc.impressions.toLocaleString() + ' imps' : loc.id}`, {
                        permanent: false,
                        direction: 'top'
                    });
                });

                // Fit bounds to show all markers
                if (geopathData.length > 1) {
                    const bounds = L.latLngBounds(geopathData.map(d => [d.lat, d.lon]));
                    map.fitBounds(bounds, { padding: [20, 20] });
                }

                geopathMapInstanceRef.current = map;

                return () => {
                    if (geopathMapInstanceRef.current) {
                        geopathMapInstanceRef.current.remove();
                        geopathMapInstanceRef.current = null;
                    }
                };
            }, [chartView, geopathData]);

            // --- EXTRACT UNIQUE MARKETS & MEDIA FROM DATA ---
            // EXCLUDED PRODUCTION-RELATED ITEMS (not actual media inventory)
            const EXCLUDED_PRODUCTS = [
                'rush fee', 'rush', 'shipping', 'freight', 'delivery',
                'measurement', 'measurements', 'survey',
                'analytics', 'reporting', 'report',
                'production', 'install fee', 'installation fee',
                'removal', 'removal fee', 'de-install',
                'design', 'design fee', 'creative', 'artwork',
                'permit', 'permits', 'permitting',
                'admin', 'administrative', 'misc', 'miscellaneous',
                'service', 'services', 'charge',
                'tax', 'taxes'
            ];
            
            const isProductExcluded = (product) => {
                if (!product) return true;
                const productLower = product.toLowerCase();
                return EXCLUDED_PRODUCTS.some(excluded => 
                    productLower.includes(excluded) || productLower === excluded
                );
            };

            const { markets, mediaTypes } = useMemo(() => {
                if (!allData) return { markets: [], mediaTypes: [] };
                const marketSet = new Set();
                const mediaSet = new Set();
                allData.forEach(item => {
                    if (item.market) marketSet.add(item.market);
                    // Only include actual media products, not production items
                    if (item.product && !isProductExcluded(item.product)) {
                        mediaSet.add(item.product);
                    }
                });
                return {
                    markets: ['ALL', ...Array.from(marketSet).sort()],
                    mediaTypes: ['ALL', ...Array.from(mediaSet).sort()]
                };
            }, [allData]);

            // --- REGION & CATEGORY MAPPINGS for smart groupings ---
            const AVAILABILITY_MARKET_GROUPS = {
                'West Coast': ['Los Angeles', 'San Francisco', 'Seattle', 'San Diego', 'Portland', 'Sacramento', 'Santa Monica', 'Orange County'],
                'East Coast': ['New York', 'Boston', 'Philadelphia', 'Washington', 'Baltimore', 'Newark', 'Howard County'],
                'Southwest': ['Dallas', 'Houston', 'Phoenix', 'Austin', 'San Antonio', 'Denver', 'Las Vegas'],
                'Southeast': ['Miami', 'Orlando', 'Atlanta', 'Tampa', 'Charlotte', 'Nashville', 'Broward County', 'Lakeland'],
                'Midwest': ['Chicago', 'Detroit', 'Minneapolis', 'Cleveland', 'Indianapolis', 'Columbus']
            };
            
            const AVAILABILITY_MEDIA_GROUPS = {
                'Digital': ['Digital', 'digital'],
                'Static': ['Panel', 'Poster', 'Static'],
                'Premium': ['Domination', 'Full Wrap', 'Embellishment', 'Icon', 'Premium']
            };

            // --- CALCULATE TOTAL INVENTORY BASED ON SELECTION ---
            const totalInventory = useMemo(() => {
                if (inventoryOverride) return inventoryOverride;
                
                let total = 0;
                const isRegion = selectedMarket.startsWith('REGION:');
                const isCategory = selectedMedia.startsWith('CATEGORY:');
                
                if (selectedMarket === 'ALL' && selectedMedia === 'ALL') {
                    // Sum all inventory
                    Object.values(DEFAULT_INVENTORY).forEach(mediaObj => {
                        Object.values(mediaObj).forEach(qty => total += qty);
                    });
                } else if (selectedMarket === 'ALL' || isRegion) {
                    // Sum across all markets (or region) for selected media
                    Object.values(DEFAULT_INVENTORY).forEach(mediaObj => {
                        Object.entries(mediaObj).forEach(([media, qty]) => {
                            if (selectedMedia === 'ALL' || selectedMedia === media || media === 'Other' || media === 'All Media') total += qty;
                        });
                    });
                } else if (selectedMedia === 'ALL' || isCategory) {
                    // Sum all media for selected market
                    const marketKey = Object.keys(DEFAULT_INVENTORY).find(k => selectedMarket.includes(k.split(',')[0])) || 'Other Markets';
                    const mediaObj = DEFAULT_INVENTORY[marketKey] || DEFAULT_INVENTORY['Other Markets'];
                    Object.values(mediaObj).forEach(qty => total += qty);
                } else {
                    // Specific market + media
                    const marketKey = Object.keys(DEFAULT_INVENTORY).find(k => selectedMarket.includes(k.split(',')[0])) || 'Other Markets';
                    const mediaObj = DEFAULT_INVENTORY[marketKey] || DEFAULT_INVENTORY['Other Markets'];
                    total = mediaObj[selectedMedia] || mediaObj['Other'] || mediaObj['All Media'] || 100;
                }
                return total || 500;
            }, [selectedMarket, selectedMedia, inventoryOverride]);

            // --- FILTER DATA BY MARKET & MEDIA (with region/category support) ---
            const filteredData = useMemo(() => {
                if (!allData) return [];
                
                // Check if using region or category
                const isRegion = selectedMarket.startsWith('REGION:');
                const isCategory = selectedMedia.startsWith('CATEGORY:');
                const regionName = isRegion ? selectedMarket.replace('REGION:', '') : null;
                const categoryName = isCategory ? selectedMedia.replace('CATEGORY:', '') : null;
                
                return allData.filter(item => {
                    // Market filtering
                    if (selectedMarket !== 'ALL') {
                        if (isRegion) {
                            // Check if item's market is in the region
                            const regionCities = AVAILABILITY_MARKET_GROUPS[regionName] || [];
                            const matchesRegion = regionCities.some(city => 
                                item.market?.toLowerCase().includes(city.toLowerCase())
                            );
                            if (!matchesRegion) return false;
                        } else {
                            if (item.market !== selectedMarket) return false;
                        }
                    }
                    
                    // NOTE: ZIP filter is INFORMATIONAL ONLY
                    // It shows impressions estimates for the selected neighborhood
                    // but doesn't filter booking data (which doesn't have ZIP-level granularity)
                    // If your data HAS ZIP codes, uncomment below to enable filtering:
                    /*
                    if (selectedZip) {
                        const itemZip = item.zip || item.zipCode || item.postalCode || '';
                        const address = item.address || item.location || '';
                        const zipMatches = itemZip.toString().includes(selectedZip) || 
                                          address.toString().includes(selectedZip);
                        if (!zipMatches) return false;
                    }
                    */
                    
                    // Media filtering
                    if (selectedMedia !== 'ALL') {
                        if (isCategory) {
                            // Check if item's product matches the category
                            const categoryKeywords = AVAILABILITY_MEDIA_GROUPS[categoryName] || [];
                            const matchesCategory = categoryKeywords.some(keyword => 
                                item.product?.toLowerCase().includes(keyword.toLowerCase())
                            );
                            if (!matchesCategory) return false;
                        } else {
                            if (item.product !== selectedMedia) return false;
                        }
                    }
                    
                    if (!includeHolds && (item.stage?.includes("Hold") || item.stage?.includes("Pending"))) return false;
                    return true;
                });
            }, [allData, selectedMarket, selectedMedia, selectedZip, includeHolds]);

            // --- MARKET UTILIZATION SUMMARY ---
            const marketSummary = useMemo(() => {
                if (!allData) return [];
                const today = new Date();
                const summary = {};
                
                allData.forEach(item => {
                    const market = item.market || 'Unknown';
                    if (!summary[market]) {
                        summary[market] = { market, booked: 0, campaigns: 0, stages: {} };
                    }
                    
                    // Only count active campaigns (date range includes today)
                    let itemStart = ensureDate(item.dateObj) || ensureDate(item.date);
                    let itemEnd = ensureDate(item.endDateObj) || ensureDate(item.endDate) || itemStart;
                    if (itemStart && itemEnd && today >= itemStart && today <= itemEnd) {
                        summary[market].booked += (item.quantity || item.totalQty || 0);
                        summary[market].campaigns++;
                        const stage = item.stage || 'Unknown';
                        summary[market].stages[stage] = (summary[market].stages[stage] || 0) + 1;
                    }
                });

                return Object.values(summary)
                    .sort((a, b) => b.booked - a.booked)
                    .slice(0, 8); // Top 8 markets
            }, [allData]);

            // --- MAP DATA: All markets with coordinates ---
            const mapMarketData = useMemo(() => {
                if (!allData) return [];
                const today = new Date();
                // Parse dates as local time
                const rangeStartDate = new Date(rangeStart + 'T00:00:00');
                const rangeEndDate = new Date(rangeEnd + 'T00:00:00');
                const summary = {};
                
                allData.forEach(item => {
                    const market = item.market || 'Unknown';
                    if (!summary[market]) {
                        summary[market] = { 
                            market, 
                            booked: 0, 
                            available: 0,
                            campaigns: 0, 
                            holds: 0,
                            confirmed: 0,
                            mediaTypes: {}
                        };
                    }
                    
                    // Check if campaign overlaps with selected date range
                    let itemStart = ensureDate(item.dateObj) || ensureDate(item.date);
                    let itemEnd = ensureDate(item.endDateObj) || ensureDate(item.endDate) || itemStart;
                    
                    if (itemStart && itemEnd) {
                        const overlaps = itemStart <= rangeEndDate && itemEnd >= rangeStartDate;
                        if (overlaps) {
                            const qty = item.quantity || item.totalQty || 0;
                            summary[market].booked += qty;
                            summary[market].campaigns++;
                            
                            // Track media types (excluding production items)
                            const media = item.product || 'Other';
                            if (!isProductExcluded(media)) {
                                if (!summary[market].mediaTypes[media]) {
                                    summary[market].mediaTypes[media] = 0;
                                }
                                summary[market].mediaTypes[media] += qty;
                            }
                            
                            // Track holds vs confirmed
                            if (item.stage?.includes('Hold') || item.stage?.includes('Pending')) {
                                summary[market].holds += qty;
                            } else {
                                summary[market].confirmed += qty;
                            }
                        }
                    }
                });

                // Add coordinates and calculate utilization
                return Object.values(summary)
                    .map(m => {
                        // Find coordinates (fuzzy match)
                        const coordKey = Object.keys(MARKET_COORDS).find(k => 
                            m.market.toLowerCase().includes(k.split(',')[0].toLowerCase()) ||
                            k.toLowerCase().includes(m.market.split(',')[0].toLowerCase())
                        );
                        const coords = coordKey ? MARKET_COORDS[coordKey] : null;
                        
                        // Estimate total inventory for this market
                        const invKey = Object.keys(DEFAULT_INVENTORY).find(k => 
                            m.market.toLowerCase().includes(k.split(',')[0].toLowerCase())
                        ) || 'Other Markets';
                        const marketInv = DEFAULT_INVENTORY[invKey] || DEFAULT_INVENTORY['Other Markets'];
                        const totalInv = Object.values(marketInv).reduce((s, v) => s + v, 0);
                        
                        const utilization = totalInv > 0 ? Math.round((m.booked / totalInv) * 100) : 0;
                        
                        return {
                            ...m,
                            coords,
                            totalInventory: totalInv,
                            utilization: Math.min(100, utilization),
                            available: Math.max(0, totalInv - m.booked)
                        };
                    })
                    .filter(m => m.coords) // Only markets with coordinates
                    .sort((a, b) => b.booked - a.booked);
            }, [allData, rangeStart, rangeEnd]);

            // --- LEAFLET MAP INITIALIZATION ---
            useEffect(() => {
                if (chartView !== 'map' || !mapContainerRef.current) return;
                
                // Clean up existing map
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                }

                // Initialize map centered on US
                const map = L.map(mapContainerRef.current, {
                    center: [39.8, -98.5],
                    zoom: 4,
                    scrollWheelZoom: true
                });

                // Add OpenStreetMap tiles (FREE!)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);

                // Add market markers
                mapMarketData.forEach(market => {
                    if (!market.coords) return;
                    
                    // Color based on utilization
                    let color = '#22c55e'; // green
                    if (market.utilization >= 90) color = '#ef4444'; // red
                    else if (market.utilization >= 70) color = '#f97316'; // orange
                    else if (market.utilization >= 50) color = '#eab308'; // yellow
                    else if (market.utilization >= 30) color = '#3b82f6'; // blue
                    
                    // Size based on booked units (min 15, max 50)
                    const radius = Math.max(15, Math.min(50, 10 + Math.sqrt(market.booked) * 2));
                    
                    // Create circle marker
                    const circle = L.circleMarker(market.coords, {
                        radius: radius,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // Top media types for popup
                    const topMedia = Object.entries(market.mediaTypes)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3)
                        .map(([media, qty]) => `<li>${media}: ${qty}</li>`)
                        .join('');
                    
                    // Popup content
                    circle.bindPopup(`
                        <div style="min-width: 200px; font-family: Inter, sans-serif;">
                            <h3 style="margin: 0 0 8px 0; font-size: 14px; font-weight: bold; color: #1e293b;">${market.market}</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div style="background: #f1f5f9; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: ${color};">${market.booked}</div>
                                    <div style="font-size: 10px; color: #64748b;">Booked</div>
                                </div>
                                <div style="background: #f1f5f9; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: #22c55e;">${market.available}</div>
                                    <div style="font-size: 10px; color: #64748b;">Available</div>
                                </div>
                            </div>
                            <div style="background: linear-gradient(to right, ${color} ${market.utilization}%, #e2e8f0 ${market.utilization}%); height: 8px; border-radius: 4px; margin-bottom: 8px;"></div>
                            <div style="font-size: 11px; color: #64748b; text-align: center; margin-bottom: 8px;">${market.utilization}% Utilized ‚Ä¢ ${market.campaigns} Flights</div>
                            <div style="font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 8px;">
                                <strong style="color: #475569;">Top Media:</strong>
                                <ul style="margin: 4px 0 0 16px; padding: 0; color: #64748b;">${topMedia || '<li>No data</li>'}</ul>
                            </div>
                            ${market.holds > 0 ? `<div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-radius: 4px; font-size: 10px; color: #92400e;">‚óè ${market.holds} units on hold</div>` : ''}
                        </div>
                    `, { maxWidth: 300 });
                    
                    // Tooltip on hover
                    circle.bindTooltip(`${market.market.split(',')[0]}: ${market.booked} booked`, {
                        permanent: false,
                        direction: 'top'
                    });
                });

                mapInstanceRef.current = map;

                // Cleanup on unmount
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, [chartView, mapMarketData]);
            const utilizationData = useMemo(() => {
                if (!filteredData) return [];
                // Parse dates as local time (add T00:00:00 to prevent UTC interpretation)
                const start = new Date(rangeStart + 'T00:00:00');
                const end = new Date(rangeEnd + 'T00:00:00');
                if (isNaN(start.getTime()) || isNaN(end.getTime())) return [];

                const days = getDatesInRange(start, end);

                return days.map(day => {
                    let bookedUnits = 0;
                    let activeCampaigns = [];
                    let holdUnits = 0;
                    let confirmedUnits = 0;

                    filteredData.forEach(item => {
                        let itemStart = ensureDate(item.dateObj) || ensureDate(item.date);
                        let itemEnd = ensureDate(item.endDateObj) || ensureDate(item.endDate) || itemStart;

                        if (itemStart && isDateInRange(day, itemStart, itemEnd)) {
                            const qty = parseFloat(item.quantity) || parseFloat(item.totalQty) || 0;
                            bookedUnits += qty;
                            
                            // Track holds vs confirmed separately
                            if (item.stage?.includes("Hold") || item.stage?.includes("Pending")) {
                                holdUnits += qty;
                            } else {
                                confirmedUnits += qty;
                            }
                            
                            if (qty > 3) activeCampaigns.push({ name: item.advertiser, qty, stage: item.stage, media: item.product });
                        }
                    });

                    const available = totalInventory - bookedUnits;
                    const utilizationPct = totalInventory > 0 ? (bookedUnits / totalInventory) * 100 : 0;
                    
                    let status = 'open'; 
                    if (utilizationPct >= 100) status = 'full';
                    else if (utilizationPct >= 90) status = 'critical';
                    else if (utilizationPct >= 70) status = 'tight';
                    else if (utilizationPct >= 40) status = 'moderate';
                    else if (bookedUnits > 0) status = 'light';

                    return {
                        date: day,
                        dayName: day.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                        weekLabel: day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        isStartOfWeek: isPostingDay(day), 
                        booked: bookedUnits,
                        holdUnits,
                        confirmedUnits,
                        available: Math.max(0, available),
                        utilizationPct: Math.min(100, utilizationPct),
                        campaigns: activeCampaigns.sort((a,b) => b.qty - a.qty),
                        status
                    };
                });
            }, [filteredData, rangeStart, rangeEnd, totalInventory]);

            // --- WEEKLY AGGREGATION ---
            const weeklyData = useMemo(() => {
                if (utilizationData.length === 0) return [];
                const weeks = [];
                let currentWeek = null;

                utilizationData.forEach(day => {
                    if (day.isStartOfWeek || !currentWeek) {
                        if (currentWeek) weeks.push(currentWeek);
                        currentWeek = {
                            weekStart: day.date,
                            weekLabel: day.weekLabel,
                            days: [],
                            avgBooked: 0,
                            avgAvailable: 0,
                            peakBooked: 0,
                            minAvailable: Infinity,
                            campaigns: new Map() // Use Map to store campaign details
                        };
                    }
                    currentWeek.days.push(day);
                    currentWeek.avgBooked += day.booked;
                    currentWeek.avgAvailable += day.available;
                    currentWeek.peakBooked = Math.max(currentWeek.peakBooked, day.booked);
                    currentWeek.minAvailable = Math.min(currentWeek.minAvailable, day.available);
                    // Store campaign details with name as key
                    day.campaigns.forEach(c => {
                        if (!currentWeek.campaigns.has(c.name)) {
                            currentWeek.campaigns.set(c.name, { 
                                name: c.name, 
                                qty: c.qty, 
                                stage: c.stage,
                                advertiser: c.advertiser || c.name.split(' - ')[0]
                            });
                        }
                    });
                });
                if (currentWeek) weeks.push(currentWeek);

                return weeks.map(w => ({
                    ...w,
                    avgBooked: Math.round(w.avgBooked / w.days.length),
                    avgAvailable: Math.round(w.avgAvailable / w.days.length),
                    avgUtilization: Math.min(100, Math.round((w.avgBooked / w.days.length / totalInventory) * 100)),
                    campaignCount: w.campaigns.size,
                    campaignList: Array.from(w.campaigns.values()) // Convert to array for display
                }));
            }, [utilizationData, totalInventory]);

            // --- MONTHLY DATA ---
            const monthlyData = useMemo(() => {
                if (utilizationData.length === 0) return [];
                const months = {};
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                utilizationData.forEach(day => {
                    const monthKey = `${day.date.getFullYear()}-${day.date.getMonth()}`;
                    if (!months[monthKey]) {
                        months[monthKey] = {
                            monthKey,
                            monthLabel: `${monthNames[day.date.getMonth()]} ${day.date.getFullYear()}`,
                            monthShort: monthNames[day.date.getMonth()],
                            year: day.date.getFullYear(),
                            days: [],
                            totalBooked: 0,
                            totalAvailable: 0,
                            peakBooked: 0,
                            minAvailable: Infinity,
                            campaigns: new Map()
                        };
                    }
                    months[monthKey].days.push(day);
                    months[monthKey].totalBooked += day.booked;
                    months[monthKey].totalAvailable += day.available;
                    months[monthKey].peakBooked = Math.max(months[monthKey].peakBooked, day.booked);
                    months[monthKey].minAvailable = Math.min(months[monthKey].minAvailable, day.available);
                    day.campaigns.forEach(c => {
                        if (!months[monthKey].campaigns.has(c.name)) {
                            months[monthKey].campaigns.set(c.name, { name: c.name, qty: c.qty, stage: c.stage });
                        }
                    });
                });

                return Object.values(months).map(m => ({
                    ...m,
                    avgBooked: Math.round(m.totalBooked / m.days.length),
                    avgAvailable: Math.round(m.totalAvailable / m.days.length),
                    avgUtilization: Math.min(100, Math.round((m.totalBooked / m.days.length / totalInventory) * 100)),
                    campaignCount: m.campaigns.size,
                    campaignList: Array.from(m.campaigns.values()),
                    daysCount: m.days.length
                }));
            }, [utilizationData, totalInventory]);

            // --- YEARLY DATA ---
            const yearlyData = useMemo(() => {
                if (utilizationData.length === 0) return [];
                const years = {};

                utilizationData.forEach(day => {
                    const year = day.date.getFullYear();
                    if (!years[year]) {
                        years[year] = {
                            year,
                            yearLabel: year.toString(),
                            days: [],
                            totalBooked: 0,
                            totalAvailable: 0,
                            peakBooked: 0,
                            minAvailable: Infinity,
                            campaigns: new Map(),
                            monthlyBreakdown: {}
                        };
                    }
                    years[year].days.push(day);
                    years[year].totalBooked += day.booked;
                    years[year].totalAvailable += day.available;
                    years[year].peakBooked = Math.max(years[year].peakBooked, day.booked);
                    years[year].minAvailable = Math.min(years[year].minAvailable, day.available);
                    day.campaigns.forEach(c => {
                        if (!years[year].campaigns.has(c.name)) {
                            years[year].campaigns.set(c.name, { name: c.name, qty: c.qty, stage: c.stage });
                        }
                    });
                    // Track monthly breakdown
                    const month = day.date.getMonth();
                    if (!years[year].monthlyBreakdown[month]) {
                        years[year].monthlyBreakdown[month] = { booked: 0, days: 0 };
                    }
                    years[year].monthlyBreakdown[month].booked += day.booked;
                    years[year].monthlyBreakdown[month].days++;
                });

                return Object.values(years).map(y => ({
                    ...y,
                    avgBooked: Math.round(y.totalBooked / y.days.length),
                    avgAvailable: Math.round(y.totalAvailable / y.days.length),
                    avgUtilization: Math.min(100, Math.round((y.totalBooked / y.days.length / totalInventory) * 100)),
                    campaignCount: y.campaigns.size,
                    campaignList: Array.from(y.campaigns.values()),
                    daysCount: y.days.length
                }));
            }, [utilizationData, totalInventory]);

            // --- GAP FINDER ---
            const gaps = useMemo(() => {
                if (utilizationData.length === 0) return [];
                let currentGap = { start: null, length: 0, avgAvail: 0 };
                const foundGaps = [];
                
                utilizationData.forEach((day, index) => {
                    const fitsRequest = day.available >= requiredSize;

                    if (fitsRequest) {
                        if (!currentGap.start) {
                            currentGap.start = day.date;
                            currentGap.avgAvail = day.available;
                        } else {
                            currentGap.avgAvail += day.available;
                        }
                        currentGap.length++;
                    } else {
                        if (currentGap.start) {
                            currentGap.avgAvail = Math.floor(currentGap.avgAvail / currentGap.length);
                            foundGaps.push({...currentGap});
                            currentGap = { start: null, length: 0, avgAvail: 0 };
                        }
                    }
                    if (index === utilizationData.length - 1 && currentGap.start) {
                        currentGap.avgAvail = Math.floor(currentGap.avgAvail / currentGap.length);
                        foundGaps.push({...currentGap});
                    }
                });
                return foundGaps.filter(g => g.length >= 7).sort((a,b) => b.length - a.length); 
            }, [utilizationData, requiredSize]);

            // --- BEST OPENINGS BY MEDIA TYPE ---
            const [showOpeningsPanel, setShowOpeningsPanel] = useState(false);
            const [showMetricsHelp, setShowMetricsHelp] = useState(false);
            
            const bestOpeningsByMedia = useMemo(() => {
                if (!filteredData || filteredData.length === 0) return { byMedia: [], byMarket: [], recommendations: [], byImpressions: [] };
                
                // Parse dates as local time
                const start = new Date(rangeStart + 'T00:00:00');
                const end = new Date(rangeEnd + 'T00:00:00');
                if (isNaN(start.getTime()) || isNaN(end.getTime())) return { byMedia: [], byMarket: [], recommendations: [], byImpressions: [] };

                const days = getDatesInRange(start, end);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get all unique media types from FILTERED data, excluding production items
                const allMediaTypes = [...new Set(filteredData.map(item => item.product).filter(Boolean))]
                    .filter(product => !isProductExcluded(product));
                
                // Calculate openings for each media type
                const mediaOpenings = allMediaTypes.map(mediaType => {
                    // Get inventory for this media type
                    let mediaInventory = 0;
                    Object.values(DEFAULT_INVENTORY).forEach(marketInv => {
                        Object.entries(marketInv).forEach(([media, qty]) => {
                            if (media === mediaType || (media === 'Other' && !Object.keys(marketInv).includes(mediaType))) {
                                mediaInventory += qty;
                            }
                        });
                    });
                    if (mediaInventory === 0) mediaInventory = 100; // Default

                    // Calculate daily utilization for this media from FILTERED data
                    const mediaUtilization = days.map(day => {
                        let booked = 0;
                        filteredData.forEach(item => {
                            if (item.product !== mediaType) return;
                            if (!includeHolds && (item.stage?.includes("Hold") || item.stage?.includes("Pending"))) return;
                            
                            let itemStart = ensureDate(item.dateObj) || ensureDate(item.date);
                            let itemEnd = ensureDate(item.endDateObj) || ensureDate(item.endDate) || itemStart;
                            
                            if (itemStart && itemEnd && day >= itemStart && day <= itemEnd) {
                                booked += (item.quantity || item.totalQty || 0);
                            }
                        });
                        return {
                            date: day,
                            booked,
                            available: Math.max(0, mediaInventory - booked)
                        };
                    });

                    // Find gaps for this media
                    const mediaGaps = [];
                    let currentGap = null;
                    
                    mediaUtilization.forEach((day, idx) => {
                        const canFit = day.available >= requiredSize;
                        
                        if (canFit) {
                            if (!currentGap) {
                                currentGap = {
                                    start: day.date,
                                    end: day.date,
                                    length: 1,
                                    minAvail: day.available,
                                    avgAvail: day.available,
                                    isImmediate: day.date <= new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000) // Within 2 weeks
                                };
                            } else {
                                currentGap.end = day.date;
                                currentGap.length++;
                                currentGap.minAvail = Math.min(currentGap.minAvail, day.available);
                                currentGap.avgAvail += day.available;
                            }
                        } else {
                            if (currentGap) {
                                currentGap.avgAvail = Math.round(currentGap.avgAvail / currentGap.length);
                                if (currentGap.length >= 7) mediaGaps.push({ ...currentGap });
                                currentGap = null;
                            }
                        }
                        
                        if (idx === mediaUtilization.length - 1 && currentGap) {
                            currentGap.avgAvail = Math.round(currentGap.avgAvail / currentGap.length);
                            if (currentGap.length >= 7) mediaGaps.push({ ...currentGap });
                        }
                    });

                    // Separate into short-term and long-term
                    const shortTerm = mediaGaps.filter(g => g.length < 28).sort((a, b) => a.start - b.start).slice(0, 3);
                    const longTerm = mediaGaps.filter(g => g.length >= 28).sort((a, b) => b.length - a.length).slice(0, 3);
                    
                    // Calculate overall availability score
                    const totalAvailableDays = mediaUtilization.filter(d => d.available >= requiredSize).length;
                    const availabilityScore = Math.round((totalAvailableDays / days.length) * 100);

                    // Best gap = LONGEST gap (sorted by length descending)
                    const sortedGaps = [...mediaGaps].sort((a, b) => b.length - a.length);
                    const bestGap = sortedGaps[0] || null;
                    
                    // Calculate impressions potential based on DATE RANGE
                    const impData = getProductImpressions(mediaType);
                    const weeklyImpressions = impData.weekly;
                    
                    // Total impressions for this date range:
                    // Method: weekly imps √ó average available units √ó weeks in SELECTED RANGE
                    const avgAvailableUnits = totalAvailableDays > 0 
                        ? Math.round(mediaUtilization.filter(d => d.available >= requiredSize).reduce((sum, d) => sum + d.available, 0) / totalAvailableDays)
                        : 0;
                    const weeksInRange = days.length / 7;
                    
                    // Campaign impressions based on the BEST GAP specifically
                    const campaignImpressions = bestGap 
                        ? Math.round(weeklyImpressions * bestGap.avgAvail * (bestGap.length / 7))
                        : 0;
                    
                    // Total potential impressions across ALL availability in date range
                    const totalRangeImpressions = Math.round(weeklyImpressions * avgAvailableUnits * (totalAvailableDays / 7));

                    return {
                        media: mediaType,
                        inventory: mediaInventory,
                        shortTerm,
                        longTerm,
                        totalGaps: mediaGaps.length,
                        bestGap,
                        availabilityScore,
                        hasImmediate: mediaGaps.some(g => g.isImmediate),
                        totalAvailableDays,
                        weeksInRange,
                        // Impressions data
                        impressions: {
                            weeklyPerUnit: weeklyImpressions,
                            multiplier: impData.multiplier,
                            tier: impData.tier,
                            campaignTotal: campaignImpressions, // Best gap impressions
                            rangeTotal: totalRangeImpressions, // All availability in date range
                            avgAvailableUnits,
                            // Score for ranking (weighted by availability and impressions)
                            score: Math.round((campaignImpressions / 1000000) * (availabilityScore / 100) * 100)
                        }
                    };
                });

                // Sort by availability score OR impressions score
                const sortedByAvailability = [...mediaOpenings].sort((a, b) => {
                    // Always prioritize items with openings
                    const aHasOpenings = a.shortTerm.length > 0 || a.longTerm.length > 0;
                    const bHasOpenings = b.shortTerm.length > 0 || b.longTerm.length > 0;
                    if (aHasOpenings && !bHasOpenings) return -1;
                    if (!aHasOpenings && bHasOpenings) return 1;
                    
                    // Then sort by impressions score OR availability
                    return b.availabilityScore - a.availabilityScore;
                });
                
                // NEW: Sorted by impressions potential
                const sortedByImpressions = [...mediaOpenings]
                    .filter(m => m.shortTerm.length > 0 || m.longTerm.length > 0)
                    .sort((a, b) => (b.impressions?.rangeTotal || 0) - (a.impressions?.rangeTotal || 0));

                // Calculate market-specific openings
                const marketOpenings = [];
                const uniqueMarkets = [...new Set(filteredData.map(item => item.market).filter(Boolean))];
                
                uniqueMarkets.forEach(market => {
                    const marketData = filteredData.filter(item => item.market === market);
                    let marketBooked = 0;
                    
                    marketData.forEach(item => {
                        let itemStart = ensureDate(item.dateObj) || ensureDate(item.date);
                        let itemEnd = ensureDate(item.endDateObj) || ensureDate(item.endDate) || itemStart;
                        if (itemStart && itemEnd && today >= itemStart && today <= itemEnd) {
                            marketBooked += (item.quantity || item.totalQty || 0);
                        }
                    });

                    // Estimate market inventory
                    const marketKey = Object.keys(DEFAULT_INVENTORY).find(k => 
                        market.toLowerCase().includes(k.split(',')[0].toLowerCase())
                    ) || 'Other Markets';
                    const marketInv = DEFAULT_INVENTORY[marketKey] || DEFAULT_INVENTORY['Other Markets'];
                    const totalInv = Object.values(marketInv).reduce((s, v) => s + v, 0);
                    
                    const available = Math.max(0, totalInv - marketBooked);
                    const utilization = totalInv > 0 ? Math.round((marketBooked / totalInv) * 100) : 0;

                    if (available >= requiredSize) {
                        marketOpenings.push({
                            market,
                            available,
                            totalInventory: totalInv,
                            utilization,
                            canFit: true
                        });
                    }
                });

                // Generate recommendations
                const recommendations = [];
                
                // Best immediate opportunity
                const immediateOptions = sortedByAvailability.filter(m => m.hasImmediate && m.bestGap);
                if (immediateOptions.length > 0) {
                    const best = immediateOptions[0];
                    recommendations.push({
                        type: 'immediate',
                        icon: '‚ñ∂',
                        title: 'Best Immediate Opportunity',
                        message: `${best.media} has ${best.bestGap.minAvail} units available starting ${best.bestGap.start.toLocaleDateString()}`,
                        media: best.media,
                        gap: best.bestGap
                    });
                }

                // Best long-term opportunity
                const longTermOptions = sortedByAvailability.filter(m => m.longTerm.length > 0);
                if (longTermOptions.length > 0) {
                    const best = longTermOptions.sort((a, b) => (b.longTerm[0]?.length || 0) - (a.longTerm[0]?.length || 0))[0];
                    if (best.longTerm[0]) {
                        recommendations.push({
                            type: 'longterm',
                            icon: '‚óÜ',
                            title: 'Best Long-Term Window',
                            message: `${best.media} has ${Math.floor(best.longTerm[0].length / 7)} weeks available from ${best.longTerm[0].start.toLocaleDateString()}`,
                            media: best.media,
                            gap: best.longTerm[0]
                        });
                    }
                }

                // Highest availability media
                if (sortedByAvailability[0] && sortedByAvailability[0].availabilityScore > 50) {
                    recommendations.push({
                        type: 'flexible',
                        icon: '‚óá',
                        title: 'Most Flexible Media',
                        message: `${sortedByAvailability[0].media} has ${sortedByAvailability[0].availabilityScore}% availability across your date range`,
                        media: sortedByAvailability[0].media
                    });
                }

                // Market with most space
                const bestMarket = marketOpenings.sort((a, b) => b.available - a.available)[0];
                if (bestMarket) {
                    recommendations.push({
                        type: 'market',
                        icon: '‚óâ',
                        title: 'Best Market Availability',
                        message: `${bestMarket.market.split(',')[0]} has ${bestMarket.available} units available (${100 - bestMarket.utilization}% open)`,
                        market: bestMarket.market
                    });
                }

                // NEW: Top Impressions Opportunity
                const topImpression = sortedByImpressions[0];
                if (topImpression && topImpression.impressions?.rangeTotal > 0) {
                    const impTotal = topImpression.impressions.rangeTotal;
                    const impDisplay = impTotal >= 1000000000 
                        ? `${(impTotal / 1000000000).toFixed(1)}B`
                        : impTotal >= 1000000 
                            ? `${(impTotal / 1000000).toFixed(1)}M` 
                            : `${Math.round(impTotal / 1000)}K`;
                    recommendations.push({
                        type: 'impressions',
                        icon: 'üìä',
                        title: 'Highest Impression Potential',
                        message: `${topImpression.media}: ~${impDisplay} sellable impressions (${topImpression.impressions.avgAvailableUnits || 0} avg avail units)`,
                        media: topImpression.media,
                        impressions: topImpression.impressions
                    });
                }

                return {
                    byMedia: sortedByAvailability,
                    byImpressions: sortedByImpressions, // NEW
                    byMarket: marketOpenings.sort((a, b) => b.available - a.available).slice(0, 8),
                    recommendations
                };
            }, [filteredData, rangeStart, rangeEnd, requiredSize, includeHolds]);

            // --- STATUS COLORS ---
            const getStatusColor = (status) => {
                switch(status) {
                    case 'full': return 'bg-red-500';
                    case 'critical': return 'bg-orange-500';
                    case 'tight': return 'bg-yellow-400';
                    case 'moderate': return 'bg-blue-500';
                    case 'light': return 'bg-blue-300';
                    default: return 'bg-gray-200';
                }
            };

            // PDF Report Options State
            const [showPdfOptions, setShowPdfOptions] = useState(false);
            const [pdfOptions, setPdfOptions] = useState({
                includeMap: true,
                includeKpis: true,
                includeMarketBreakdown: true,
                includeImpressions: true,
                includeTable: true,
                includeHeader: true
            });

            // SVG Icons for PDF (Lucide-style)
            const PDF_ICONS = {
                chart: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>',
                map: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>',
                mapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
                eye: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
                calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
                barChart: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>'
            };

            // PDF Export Function - uses current filter state and options
            const generateAvailabilityPDF = (options) => {
                const { includeMap, includeKpis, includeMarketBreakdown, includeImpressions, includeTable, includeHeader } = options;
                
                const dataToExport = viewMode === 'weekly' ? weeklyData : viewMode === 'monthly' ? monthlyData : viewMode === 'yearly' ? yearlyData : utilizationData;
                const marketLabel = selectedMarket === 'ALL' ? 'All Markets' : selectedMarket;
                const mediaLabel = selectedMedia === 'ALL' ? 'All Media Types' : selectedMedia;
                
                // Calculate summary stats from filtered data
                const avgUtil = dataToExport.length > 0 ? (dataToExport.reduce((s, d) => s + (d.utilizationPct || d.avgUtilization || 0), 0) / dataToExport.length).toFixed(1) : 0;
                const peakUtil = dataToExport.length > 0 ? Math.max(...dataToExport.map(d => d.utilizationPct || d.avgUtilization || 0)).toFixed(1) : 0;
                const avgAvail = dataToExport.length > 0 ? Math.round(dataToExport.reduce((s, d) => s + (d.available || d.avgAvailable || 0), 0) / dataToExport.length) : 0;
                
                // Calculate total impressions estimate
                const weeksInRange = Math.max(1, Math.ceil(dataToExport.length / 7));
                const avgWeeklyImpressions = totalInventory * 18000;
                const totalImpressionsCalc = avgWeeklyImpressions * weeksInRange;
                const availImpressionsCalc = Math.round((avgAvail / Math.max(1, totalInventory)) * totalImpressionsCalc);
                
                // Market breakdown - filtered by current selection
                const marketBreakdownData = selectedMarket === 'ALL' ? mapMarketData.slice(0, 8) : mapMarketData.filter(m => m.market.includes(selectedMarket.split(',')[0])).slice(0, 8);
                
                // Build market cards HTML
                const marketCardsHTML = marketBreakdownData.map(function(m) {
                    var barColor = '#22c55e';
                    if (m.utilization >= 90) barColor = '#ef4444';
                    else if (m.utilization >= 70) barColor = '#f97316';
                    else if (m.utilization >= 50) barColor = '#eab308';
                    else if (m.utilization >= 30) barColor = '#3b82f6';
                    return '<div class="market-card">' +
                        '<div class="market-name">' + m.market + '</div>' +
                        '<div class="market-stats">' +
                            '<div class="market-stat"><div class="market-stat-value" style="color:' + barColor + '">' + m.booked + '</div><div class="market-stat-label">Booked</div></div>' +
                            '<div class="market-stat"><div class="market-stat-value" style="color:#22c55e">' + m.available + '</div><div class="market-stat-label">Available</div></div>' +
                            '<div class="market-stat"><div class="market-stat-value">' + m.utilization + '%</div><div class="market-stat-label">Utilized</div></div>' +
                        '</div>' +
                        '<div class="market-bar"><div class="market-bar-fill" style="width:' + m.utilization + '%;background:' + barColor + '"></div></div>' +
                    '</div>';
                }).join('');
                
                // Build table rows HTML
                const tableRowsHTML = dataToExport.slice(0, 50).map(function(d) {
                    var avail = d.available || d.avgAvailable || 0;
                    var periodImpressions = Math.round((avail / Math.max(1, totalInventory)) * avgWeeklyImpressions);
                    var label = d.weekLabel || d.dayName || d.monthLabel || d.yearLabel || '';
                    var status = d.status || 'open';
                    return '<tr>' +
                        '<td style="font-weight:500">' + label + '</td>' +
                        '<td style="text-align:right">' + (d.booked || d.avgBooked || 0).toLocaleString() + '</td>' +
                        '<td style="text-align:right">' + (d.confirmedUnits || d.avgConfirmed || 0).toLocaleString() + '</td>' +
                        '<td style="text-align:right">' + (d.holdUnits || d.avgHolds || 0).toLocaleString() + '</td>' +
                        '<td style="text-align:right;font-weight:600;color:#16a34a">' + avail.toLocaleString() + '</td>' +
                        '<td style="text-align:right">' + (d.utilizationPct || d.avgUtilization || 0).toFixed(1) + '%</td>' +
                        '<td style="text-align:right;color:#7c3aed">' + (periodImpressions / 1000).toFixed(0) + 'K</td>' +
                        '<td><span class="status-badge ' + status + '">' + status.charAt(0).toUpperCase() + status.slice(1) + '</span></td>' +
                    '</tr>';
                }).join('');
                
                // Map section HTML (conditional)
                const mapSectionHTML = includeMap ? `
                    <div class="section">
                        <div class="section-header">
                            <div class="section-icon map"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg></div>
                            <div class="section-title">Market Coverage Map</div>
                        </div>
                        <div id="map"></div>
                        <div class="map-legend">
                            <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> Open (&lt;30%)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> Available (30-50%)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#eab308"></div> Moderate (50-70%)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div> Tight (70-90%)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> Limited (&gt;90%)</div>
                        </div>
                    </div>
                ` : '';
                
                // Map script (conditional)
                const mapScriptHTML = includeMap ? `
                    <script>
                        window.onload = function() {
                            var map = L.map('map').setView([39.8, -98.5], 4);
                            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                                attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 19
                            }).addTo(map);
                            var markets = ${JSON.stringify(marketBreakdownData.map(m => ({ name: m.market, coords: m.coords, booked: m.booked, available: m.available, utilization: m.utilization })))};
                            markets.forEach(function(m) {
                                if (!m.coords) return;
                                var color = '#22c55e';
                                if (m.utilization >= 90) color = '#ef4444';
                                else if (m.utilization >= 70) color = '#f97316';
                                else if (m.utilization >= 50) color = '#eab308';
                                else if (m.utilization >= 30) color = '#3b82f6';
                                var radius = Math.max(12, Math.min(35, 8 + Math.sqrt(m.booked) * 1.5));
                                L.circleMarker(m.coords, { radius: radius, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85 })
                                    .addTo(map).bindPopup('<strong>' + m.name + '</strong><br>Booked: ' + m.booked + '<br>Available: ' + m.available + '<br>Utilization: ' + m.utilization + '%');
                            });
                            setTimeout(function() { window.print(); }, 1000);
                        };
                    <\/script>
                ` : '<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); };<\/script>';
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<!DOCTYPE html><html><head>
                    <title>OOH Media Availability Report - ${marketLabel}</title>
                    ${includeMap ? '<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>' : ''}
                    <style>
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif; color: #1a1a2e; background: #fff; }
                        .header { background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); color: white; padding: 40px; position: relative; overflow: hidden; }
                        .header::before { content: ''; position: absolute; top: -50%; right: -10%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(56,189,248,0.15) 0%, transparent 70%); }
                        .header-content { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; }
                        .logo-section { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
                        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #38bdf8, #818cf8); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
                        .company-name { font-size: 14px; text-transform: uppercase; letter-spacing: 3px; opacity: 0.7; }
                        .report-title { font-size: 32px; font-weight: 700; margin: 10px 0; }
                        .report-subtitle { font-size: 16px; opacity: 0.8; }
                        .header-meta { display: flex; gap: 40px; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; }
                        .meta-item { }
                        .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.5; margin-bottom: 4px; }
                        .meta-value { font-size: 18px; font-weight: 600; }
                        .content { max-width: 1200px; margin: 0 auto; padding: 40px; }
                        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 40px; }
                        .kpi-card { background: #f8fafc; border-radius: 16px; padding: 24px; text-align: center; border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
                        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
                        .kpi-card.teal::before { background: linear-gradient(90deg, #14b8a6, #06b6d4); }
                        .kpi-card.blue::before { background: linear-gradient(90deg, #3b82f6, #6366f1); }
                        .kpi-card.amber::before { background: linear-gradient(90deg, #f59e0b, #ef4444); }
                        .kpi-card.green::before { background: linear-gradient(90deg, #22c55e, #10b981); }
                        .kpi-card.purple::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
                        .kpi-value { font-size: 36px; font-weight: 700; margin-bottom: 5px; }
                        .kpi-card.teal .kpi-value { color: #0d9488; }
                        .kpi-card.blue .kpi-value { color: #2563eb; }
                        .kpi-card.amber .kpi-value { color: #d97706; }
                        .kpi-card.green .kpi-value { color: #16a34a; }
                        .kpi-card.purple .kpi-value { color: #7c3aed; }
                        .kpi-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
                        .kpi-sub { font-size: 11px; color: #94a3b8; margin-top: 8px; }
                        .section { margin-bottom: 40px; }
                        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
                        .section-icon svg { width: 20px; height: 20px; }
                        .section-icon.map { background: #dbeafe; color: #2563eb; }
                        .section-icon.chart { background: #d1fae5; color: #059669; }
                        .section-icon.table { background: #fef3c7; color: #d97706; }
                        .section-icon.impressions { background: #ede9fe; color: #7c3aed; }
                        .section-title { font-size: 18px; font-weight: 600; color: #1e293b; }
                        #map { height: 350px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
                        .map-legend { display: flex; gap: 20px; justify-content: center; padding: 15px; background: #f8fafc; border-radius: 10px; flex-wrap: wrap; }
                        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #475569; }
                        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
                        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
                        .one-col { display: block; }
                        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
                        .market-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; }
                        .market-name { font-weight: 600; color: #1e293b; margin-bottom: 10px; font-size: 14px; }
                        .market-stats { display: flex; gap: 15px; margin-bottom: 10px; }
                        .market-stat-value { font-size: 20px; font-weight: 700; }
                        .market-stat-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
                        .market-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
                        .market-bar-fill { height: 100%; border-radius: 4px; }
                        .impressions-box { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border-radius: 16px; padding: 30px; color: white; }
                        .impressions-title { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 15px; }
                        .impressions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
                        .impressions-value { font-size: 32px; font-weight: 700; }
                        .impressions-label { font-size: 12px; opacity: 0.7; }
                        .impressions-note { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 11px; opacity: 0.6; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th { background: #f1f5f9; padding: 12px 15px; text-align: left; font-weight: 600; color: #475569; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
                        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
                        tr:hover { background: #f8fafc; }
                        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
                        .status-badge.open { background: #dcfce7; color: #166534; }
                        .status-badge.light { background: #dbeafe; color: #1e40af; }
                        .status-badge.moderate { background: #fef9c3; color: #854d0e; }
                        .status-badge.tight { background: #fed7aa; color: #c2410c; }
                        .status-badge.critical { background: #fecaca; color: #dc2626; }
                        .status-badge.full { background: #ef4444; color: white; }
                        .footer { margin-top: 50px; padding: 30px 40px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
                        .footer-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
                        .footer-left { font-size: 12px; color: #64748b; }
                        .footer-right { font-size: 11px; color: #94a3b8; }
                        .logo-svg { width: 28px; height: 28px; color: white; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .header { padding: 30px; } .content { padding: 30px; } #map { height: 280px; } .kpi-grid { grid-template-columns: repeat(5, 1fr); } }
                    </style>
                </head><body>` +
                    (includeHeader ? '<div class="header"><div class="header-content">' +
                        '<div class="logo-section">' +
                            '<div class="logo-icon"><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></div>' +
                            '<div><div class="company-name">Vector Media</div><div class="report-title">OOH Media Availability Report</div></div>' +
                        '</div>' +
                        '<div class="report-subtitle">Comprehensive inventory analysis and market opportunity assessment</div>' +
                        '<div class="header-meta">' +
                            '<div class="meta-item"><div class="meta-label">Market</div><div class="meta-value">' + marketLabel + '</div></div>' +
                            '<div class="meta-item"><div class="meta-label">Media Type</div><div class="meta-value">' + mediaLabel + '</div></div>' +
                            '<div class="meta-item"><div class="meta-label">Flight Period</div><div class="meta-value">' + new Date(rangeStart).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ' - ' + new Date(rangeEnd).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) + '</div></div>' +
                            '<div class="meta-item"><div class="meta-label">Report Date</div><div class="meta-value">' + new Date().toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'}) + '</div></div>' +
                        '</div>' +
                    '</div></div>' : '') +
                    '<div class="content">' +
                        (includeKpis ? '<div class="kpi-grid">' +
                            '<div class="kpi-card teal"><div class="kpi-value">' + totalInventory.toLocaleString() + '</div><div class="kpi-label">Total Faces</div><div class="kpi-sub">Network Inventory</div></div>' +
                            '<div class="kpi-card green"><div class="kpi-value">' + avgAvail.toLocaleString() + '</div><div class="kpi-label">Avg Available</div><div class="kpi-sub">Faces per period</div></div>' +
                            '<div class="kpi-card blue"><div class="kpi-value">' + avgUtil + '%</div><div class="kpi-label">Avg Utilization</div><div class="kpi-sub">Across date range</div></div>' +
                            '<div class="kpi-card amber"><div class="kpi-value">' + peakUtil + '%</div><div class="kpi-label">Peak Demand</div><div class="kpi-sub">Highest utilization</div></div>' +
                            '<div class="kpi-card purple"><div class="kpi-value">' + (totalImpressionsCalc / 1000000).toFixed(1) + 'M</div><div class="kpi-label">Est. Impressions</div><div class="kpi-sub">Total opportunity</div></div>' +
                        '</div>' : '') +
                        (includeMap ? mapSectionHTML : '') +
                        '<div class="' + ((includeMarketBreakdown && includeImpressions) ? 'two-col' : 'one-col') + '">' +
                            (includeMarketBreakdown ? '<div class="section"><div class="section-header"><div class="section-icon chart"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><div class="section-title">Market Breakdown</div></div><div class="market-grid">' + marketCardsHTML + '</div></div>' : '') +
                            (includeImpressions ? '<div class="section"><div class="section-header"><div class="section-icon impressions"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></div><div class="section-title">Impression Opportunity</div></div>' +
                                '<div class="impressions-box">' +
                                    '<div class="impressions-title">Estimated Reach Potential</div>' +
                                    '<div class="impressions-grid">' +
                                        '<div><div class="impressions-value">' + (totalImpressionsCalc / 1000000).toFixed(1) + 'M</div><div class="impressions-label">Total Network Impressions</div></div>' +
                                        '<div><div class="impressions-value">' + (availImpressionsCalc / 1000000).toFixed(1) + 'M</div><div class="impressions-label">Available Impressions</div></div>' +
                                        '<div><div class="impressions-value">' + Math.round(avgWeeklyImpressions / 1000).toLocaleString() + 'K</div><div class="impressions-label">Weekly Reach (Full Network)</div></div>' +
                                        '<div><div class="impressions-value">' + weeksInRange + '</div><div class="impressions-label">Weeks in Flight Period</div></div>' +
                                    '</div>' +
                                    '<div class="impressions-note">* Impressions estimated using Geopath-equivalent methodology. Actual delivery may vary.</div>' +
                                '</div>' +
                            '</div>' : '') +
                        '</div>' +
                        (includeTable ? '<div class="section"><div class="section-header"><div class="section-icon table"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div><div class="section-title">Availability by Period</div></div>' +
                            '<table><thead><tr><th>Period</th><th style="text-align:right">Booked</th><th style="text-align:right">Confirmed</th><th style="text-align:right">On Hold</th><th style="text-align:right">Available</th><th style="text-align:right">Utilization</th><th style="text-align:right">Est. Impressions</th><th>Status</th></tr></thead>' +
                            '<tbody>' + tableRowsHTML + '</tbody></table>' +
                            (dataToExport.length > 50 ? '<p style="color:#94a3b8;font-size:11px;margin-top:12px;text-align:center;">Showing 50 of ' + dataToExport.length + ' periods. Export CSV for complete data.</p>' : '') +
                        '</div>' : '') +
                    '</div>' +
                    '<div class="footer"><div class="footer-content">' +
                        '<div class="footer-left"><strong>Vector Media</strong> ‚Ä¢ OOH Media Availability Report<br>For questions, contact your account representative</div>' +
                        '<div class="footer-right">Generated ' + new Date().toLocaleString() + '<br>CONFIDENTIAL - For planning purposes only</div>' +
                    '</div></div>' +
                    mapScriptHTML +
                '</body></html>');
                printWindow.document.close();
                setShowPdfOptions(false);
            };

            return (
                <div className={`bg-white rounded-xl shadow-sm border border-gray-200 ${isFullscreen ? 'fixed inset-0 z-50 rounded-none overflow-auto' : ''}`}>
                    {/* HEADER with View Toggle */}
                    <div className="p-4 border-b border-gray-100">
                        <div className="flex justify-between items-center">
                            <div>
                                <p className="text-sm text-gray-600">
                                    Viewing: <strong>{
                                        selectedMarket === 'ALL' ? 'All Markets' : 
                                        selectedMarket.startsWith('REGION:') ? `${selectedMarket.replace('REGION:', '')} Region` :
                                        selectedMarket.split(',')[0]
                                    }</strong> ‚Ä¢ 
                                    <strong>{
                                        selectedMedia === 'ALL' ? 'All Media' : 
                                        selectedMedia.startsWith('CATEGORY:') ? `${selectedMedia.replace('CATEGORY:', '')} Media` :
                                        selectedMedia
                                    }</strong> ‚Ä¢ 
                                    <span className="text-blue-600 font-bold">{totalInventory.toLocaleString()} Faces</span>
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* Chart View Toggle */}
                                <div className="flex bg-gray-100 rounded-lg p-0.5">
                                    <button onClick={() => setChartView('timeline')} className={`px-3 py-1.5 text-xs font-bold rounded-md flex items-center gap-1.5 transition-all ${chartView === 'timeline' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}>
                                        <Icon name="BarChart" size={14} /> Timeline
                                    </button>
                                    <button onClick={() => setChartView('map')} className={`px-3 py-1.5 text-xs font-bold rounded-md flex items-center gap-1.5 transition-all ${chartView === 'map' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                        <Icon name="MapPin" size={14} /> Map
                                    </button>
                                    <button onClick={() => setChartView('geopath')} className={`px-3 py-1.5 text-xs font-bold rounded-md flex items-center gap-1.5 transition-all ${chartView === 'geopath' ? 'bg-white shadow text-emerald-600' : 'text-gray-500 hover:text-gray-700'}`}>
                                        <Icon name="Target" size={14} /> Geopath
                                    </button>
                                </div>
                                {/* Fullscreen Toggle */}
                                <button 
                                    onClick={() => setIsFullscreen(!isFullscreen)}
                                    className={`px-3 py-1.5 text-xs font-bold rounded-lg flex items-center gap-1.5 transition-all border ${isFullscreen ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-400 hover:text-blue-600'}`}
                                    title={isFullscreen ? "Exit fullscreen" : "Expand to fullscreen"}
                                >
                                    <Icon name={isFullscreen ? "Minimize2" : "Maximize2"} size={14} />
                                    {isFullscreen ? 'Exit' : 'Expand'}
                                </button>
                                
                                {/* Export Dropdown */}
                                <div className="relative group">
                                    <button 
                                        className="px-3 py-1.5 text-xs font-bold rounded-lg flex items-center gap-1.5 transition-all border bg-white text-gray-600 border-gray-300 hover:border-teal-400 hover:text-teal-600"
                                        title="Export availability report"
                                    >
                                        <Icon name="Download" size={14} />
                                        Export
                                        <Icon name="ChevronDown" size={12} />
                                    </button>
                                    <div className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 min-w-[200px]">
                                        <div className="px-3 py-2 border-b border-gray-100">
                                            <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Export Options</div>
                                        </div>
                                        <button 
                                            onClick={() => {
                                                // Export CSV - uses filtered data based on current selections
                                                const dataToExport = viewMode === 'weekly' ? weeklyData : viewMode === 'monthly' ? monthlyData : viewMode === 'yearly' ? yearlyData : utilizationData;
                                                const headers = ['Date', 'Booked', 'Confirmed', 'On Hold', 'Available', 'Total Inventory', 'Utilization %', 'Status', 'Market Filter', 'Media Filter'];
                                                const rows = dataToExport.map(d => [
                                                    d.weekLabel || d.dayName || d.monthLabel || d.yearLabel,
                                                    d.booked || d.avgBooked || 0,
                                                    d.confirmedUnits || d.avgConfirmed || 0,
                                                    d.holdUnits || d.avgHolds || 0,
                                                    d.available || d.avgAvailable || 0,
                                                    totalInventory,
                                                    (d.utilizationPct || d.avgUtilization || 0).toFixed(1) + '%',
                                                    d.status || '',
                                                    selectedMarket === 'ALL' ? 'All Markets' : selectedMarket,
                                                    selectedMedia === 'ALL' ? 'All Media' : selectedMedia
                                                ]);
                                                const csvContent = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
                                                const blob = new Blob([csvContent], { type: 'text/csv' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `Availability_Report_${selectedMarket === 'ALL' ? 'All_Markets' : selectedMarket.replace(/[^a-z0-9]/gi, '_')}_${rangeStart}_to_${rangeEnd}.csv`;
                                                a.click();
                                                URL.revokeObjectURL(url);
                                            }}
                                            className="w-full px-4 py-2.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700"
                                        >
                                            <Icon name="FileSpreadsheet" size={16} className="text-green-600" />
                                            Export as CSV
                                        </button>
                                        <button 
                                            onClick={() => setShowPdfOptions(true)}
                                            className="w-full px-4 py-2.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 border-t border-gray-100"
                                        >
                                            <Icon name="FileText" size={16} className="text-red-500" />
                                            Export as PDF...
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* PDF Options Modal */}
                    {showPdfOptions && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowPdfOptions(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4" onClick={e => e.stopPropagation()}>
                                <div className="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-teal-100 rounded-lg">
                                            <Icon name="FileText" size={20} className="text-teal-600" />
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-gray-900">PDF Report Options</h3>
                                            <p className="text-xs text-gray-500">Select sections to include</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowPdfOptions(false)} className="p-1 hover:bg-gray-100 rounded-lg">
                                        <Icon name="X" size={20} className="text-gray-400" />
                                    </button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeHeader}
                                            onChange={e => setPdfOptions({...pdfOptions, includeHeader: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="LayoutTemplate" size={16} className="text-gray-400" />
                                                Report Header
                                            </div>
                                            <div className="text-xs text-gray-500">Company branding, title, meta info</div>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeKpis}
                                            onChange={e => setPdfOptions({...pdfOptions, includeKpis: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="BarChart3" size={16} className="text-gray-400" />
                                                KPI Summary Cards
                                            </div>
                                            <div className="text-xs text-gray-500">Total faces, utilization, impressions</div>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeMap}
                                            onChange={e => setPdfOptions({...pdfOptions, includeMap: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="Map" size={16} className="text-gray-400" />
                                                Market Coverage Map
                                            </div>
                                            <div className="text-xs text-gray-500">Interactive map with utilization markers</div>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeMarketBreakdown}
                                            onChange={e => setPdfOptions({...pdfOptions, includeMarketBreakdown: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="MapPin" size={16} className="text-gray-400" />
                                                Market Breakdown
                                            </div>
                                            <div className="text-xs text-gray-500">Per-market booked/available stats</div>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeImpressions}
                                            onChange={e => setPdfOptions({...pdfOptions, includeImpressions: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="Eye" size={16} className="text-gray-400" />
                                                Impression Opportunity
                                            </div>
                                            <div className="text-xs text-gray-500">Estimated reach and weekly impressions</div>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-gray-200">
                                        <input 
                                            type="checkbox" 
                                            checked={pdfOptions.includeTable}
                                            onChange={e => setPdfOptions({...pdfOptions, includeTable: e.target.checked})}
                                            className="w-5 h-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="Table" size={16} className="text-gray-400" />
                                                Availability Table
                                            </div>
                                            <div className="text-xs text-gray-500">Detailed period-by-period data</div>
                                        </div>
                                    </label>
                                </div>
                                <div className="px-6 py-4 border-t border-gray-200 flex gap-3 bg-gray-50 rounded-b-xl">
                                    <button 
                                        onClick={() => setShowPdfOptions(false)}
                                        className="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => generateAvailabilityPDF(pdfOptions)}
                                        className="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2"
                                    >
                                        <Icon name="Download" size={16} />
                                        Generate PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* FILTERS - Clean Organized Layout (Hidden in fullscreen) */}
                    {!isFullscreen && (
                    <div className="p-4 bg-gray-50 border-b border-gray-100">
                        <div className="flex flex-wrap items-end gap-4">
                            {/* Filter By Section */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Filter By</label>
                                <div className="flex items-center gap-2">
                                    <select 
                                        value={selectedMarket} 
                                        onChange={e => { setSelectedMarket(e.target.value); setInventoryOverride(null); }}
                                        className="text-sm font-medium border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 outline-none min-w-[160px]"
                                    >
                                        <option value="ALL">All Markets</option>
                                        <optgroup label="üìç Regions">
                                            <option value="REGION:West Coast">West Coast</option>
                                            <option value="REGION:East Coast">East Coast</option>
                                            <option value="REGION:Southwest">Southwest</option>
                                            <option value="REGION:Southeast">Southeast</option>
                                            <option value="REGION:Midwest">Midwest</option>
                                        </optgroup>
                                        <optgroup label="üìå Individual Markets">
                                            {markets.filter(m => m !== 'ALL').map(m => (
                                                <option key={m} value={m}>{m.split(',')[0]}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                    <select 
                                        value={selectedMedia} 
                                        onChange={e => { setSelectedMedia(e.target.value); setInventoryOverride(null); }}
                                        className="text-sm font-medium border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 outline-none min-w-[180px]"
                                    >
                                        <option value="ALL">All Media Types</option>
                                        <optgroup label="üì¶ Categories">
                                            <option value="CATEGORY:Digital">All Digital</option>
                                            <option value="CATEGORY:Static">All Static Panels</option>
                                            <option value="CATEGORY:Premium">Premium Units</option>
                                        </optgroup>
                                        <optgroup label="üìã Individual Media">
                                            {mediaTypes.filter(m => m !== 'ALL').map(m => (
                                                <option key={m} value={m}>{m}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            {/* ZIP Code Filter (LA Only) - INFORMATIONAL for impressions reference */}
                            {(selectedMarket === 'ALL' || selectedMarket.includes('Los Angeles') || selectedMarket === 'REGION:West Coast') && (
                                <div className="flex flex-col gap-1">
                                    <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1">
                                        <Icon name="MapPin" size={10} /> ZIP Impressions Ref
                                    </label>
                                    <div className="relative">
                                        <select 
                                            value={selectedZip} 
                                            onChange={e => setSelectedZip(e.target.value)}
                                            className="text-sm font-medium border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:ring-2 focus:ring-emerald-500 outline-none min-w-[180px] appearance-none pr-8"
                                        >
                                            <option value="">All ZIP Codes</option>
                                            <optgroup label="üèôÔ∏è Downtown / Central">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Downtown', 'South Park', 'Industrial District', 'Financial District'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üé¨ Hollywood">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => d.area.includes('Hollywood') || d.area.includes('West Hollywood')).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üèÆ Koreatown / Mid-City">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Koreatown', 'Mid-Wilshire', 'Mid-City', 'Park La Brea', 'Los Feliz'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üå¥ Westside">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Westwood', 'West LA', 'Palms', 'Beverlywood', 'Beverly Grove', 'Brentwood', 'Rancho Park', 'Century City', 'Bel Air', 'Beverly Hills'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üèñÔ∏è Beach Cities">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Venice', 'Marina del Rey', 'Playa del Rey', 'Santa Monica', 'Mar Vista', 'Playa Vista'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üè† Northeast LA">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Echo Park', 'Silver Lake', 'Eagle Rock', 'Highland Park', 'Glassell Park', 'Lincoln Heights', 'El Sereno', 'Thai Town'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üåÜ East LA / Boyle Heights">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => d.area.includes('East LA') || d.area.includes('Boyle Heights')).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üèòÔ∏è South LA">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Florence', 'Watts', 'South Central', 'Baldwin Hills', 'West Adams', 'Jefferson Park', 'View Park', 'Willowbrook', 'Ladera Heights'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="üå≥ San Fernando Valley">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Van Nuys', 'North Hollywood', 'Studio City', 'Sherman Oaks', 'Encino', 'Tarzana', 'Woodland Hills', 'Canoga Park', 'Winnetka', 'Northridge', 'Granada Hills', 'Pacoima', 'Sylmar', 'Reseda', 'Panorama City', 'Sun Valley', 'Sunland', 'Tujunga', 'Valley Village', 'North Hills', 'Mission Hills', 'Chatsworth', 'Porter Ranch', 'West Hills', 'San Fernando'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="‚öì Harbor / South Bay">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['San Pedro', 'Wilmington', 'Harbor City', 'Carson', 'Torrance', 'Gardena', 'Hawthorne', 'Lawndale', 'Inglewood', 'Lennox', 'Lomita', 'Long Beach'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="‚úàÔ∏è Culver City / LAX">
                                                {Object.entries(LA_ZIP_DATA).filter(([z, d]) => ['Culver City', 'Westchester'].includes(d.area)).map(([zip, data]) => (
                                                    <option key={zip} value={zip}>{zip} - {data.area}</option>
                                                ))}
                                            </optgroup>
                                        </select>
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">
                                            <Icon name="ChevronDown" size={14} className="text-gray-400" />
                                        </div>
                                    </div>
                                    {/* Compact indicator when selected */}
                                    {selectedZip && LA_ZIP_DATA[selectedZip] && (
                                        <div className="text-[10px] mt-1 text-emerald-600 font-medium">
                                            ‚úì See impressions reference below
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Inventory Section */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Inventory</label>
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center bg-white border border-gray-300 rounded-lg px-2 py-1">
                                        <span className="text-xs text-gray-500 mr-1.5">Total:</span>
                                        <input 
                                            type="number" 
                                            value={inventoryOverride || totalInventory} 
                                            onChange={e => setInventoryOverride(parseInt(e.target.value) || null)} 
                                            className="w-16 text-sm font-bold text-gray-800 outline-none"
                                        />
                                    </div>
                                    <div className="flex items-center bg-blue-50 border border-blue-200 rounded-lg px-2 py-1">
                                        <span className="text-xs text-blue-600 mr-1.5">Need:</span>
                                        <input 
                                            type="number" 
                                            value={requiredSize} 
                                            onChange={e => setRequiredSize(parseInt(e.target.value) || 0)} 
                                            className="w-12 text-sm font-bold text-blue-700 outline-none bg-transparent"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Date Range Section with Quick Presets */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Date Range</label>
                                <div className="flex items-center gap-2">
                                    {/* Back arrow */}
                                    <button
                                        onClick={() => {
                                            const start = new Date(rangeStart + 'T00:00:00');
                                            const end = new Date(rangeEnd + 'T00:00:00');
                                            start.setMonth(start.getMonth() - 1);
                                            end.setMonth(end.getMonth() - 1);
                                            setRangeStart(start.toISOString().split('T')[0]);
                                            setRangeEnd(end.toISOString().split('T')[0]);
                                        }}
                                        className="p-1.5 bg-gray-100 hover:bg-blue-100 rounded border border-gray-200 transition-all"
                                        title="Previous month"
                                    >
                                        <Icon name="ChevronLeft" size={14} className="text-gray-600" />
                                    </button>
                                    
                                    <div className="flex items-center gap-2 bg-white border border-gray-300 rounded-lg px-2 py-1">
                                        <Icon name="Calendar" size={14} className="text-gray-400" />
                                        <input type="date" value={rangeStart} onChange={e => setRangeStart(e.target.value)} className="bg-transparent font-medium text-gray-700 outline-none text-sm"/>
                                        <span className="text-gray-400">‚Üí</span>
                                        <input type="date" value={rangeEnd} onChange={e => setRangeEnd(e.target.value)} className="bg-transparent font-medium text-gray-700 outline-none text-sm"/>
                                    </div>
                                    
                                    {/* Forward arrow */}
                                    <button
                                        onClick={() => {
                                            const start = new Date(rangeStart + 'T00:00:00');
                                            const end = new Date(rangeEnd + 'T00:00:00');
                                            start.setMonth(start.getMonth() + 1);
                                            end.setMonth(end.getMonth() + 1);
                                            setRangeStart(start.toISOString().split('T')[0]);
                                            setRangeEnd(end.toISOString().split('T')[0]);
                                        }}
                                        className="p-1.5 bg-gray-100 hover:bg-blue-100 rounded border border-gray-200 transition-all"
                                        title="Next month"
                                    >
                                        <Icon name="ChevronRight" size={14} className="text-gray-600" />
                                    </button>
                                    
                                    {/* Quick Date Presets */}
                                    <div className="flex items-center gap-1">
                                        {[
                                            { label: 'This Mo', getRange: () => {
                                                const now = new Date();
                                                return { 
                                                    start: new Date(now.getFullYear(), now.getMonth(), 1),
                                                    end: new Date(now.getFullYear(), now.getMonth() + 1, 0)
                                                };
                                            }},
                                            { label: 'Next Mo', getRange: () => {
                                                const now = new Date();
                                                return { 
                                                    start: new Date(now.getFullYear(), now.getMonth() + 1, 1),
                                                    end: new Date(now.getFullYear(), now.getMonth() + 2, 0)
                                                };
                                            }},
                                            { label: '+2 Mo', getRange: () => {
                                                const now = new Date();
                                                return { 
                                                    start: new Date(now.getFullYear(), now.getMonth() + 2, 1),
                                                    end: new Date(now.getFullYear(), now.getMonth() + 3, 0)
                                                };
                                            }},
                                            { label: '90 Days', getRange: () => {
                                                const now = new Date();
                                                const end = new Date(now);
                                                end.setDate(end.getDate() + 90);
                                                return { start: now, end };
                                            }},
                                            { label: '6 Mo', getRange: () => {
                                                const now = new Date();
                                                const end = new Date(now);
                                                end.setMonth(end.getMonth() + 6);
                                                return { start: now, end };
                                            }},
                                            { label: '2026', getRange: () => {
                                                return { 
                                                    start: new Date(2026, 0, 1),
                                                    end: new Date(2026, 11, 31)
                                                };
                                            }},
                                        ].map((preset, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => {
                                                    const { start, end } = preset.getRange();
                                                    setRangeStart(start.toISOString().split('T')[0]);
                                                    setRangeEnd(end.toISOString().split('T')[0]);
                                                }}
                                                className="px-2 py-1 text-[10px] font-bold bg-gray-100 hover:bg-blue-100 hover:text-blue-700 rounded border border-gray-200 transition-all"
                                            >
                                                {preset.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Options Section */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Options</label>
                                <div className="flex items-center gap-2">
                                    {/* Holds Toggle - Redesigned for clarity */}
                                    <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5 border border-gray-200">
                                        <button 
                                            onClick={() => setIncludeHolds(true)}
                                            className={`px-2.5 py-1 text-[11px] font-bold rounded-md transition-all flex items-center gap-1 ${includeHolds ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                            title="Show all bookings including pending holds - conservative availability view"
                                        >
                                            <span className="w-2 h-2 rounded-full bg-orange-400"></span>
                                            All Bookings
                                        </button>
                                        <button 
                                            onClick={() => setIncludeHolds(false)}
                                            className={`px-2.5 py-1 text-[11px] font-bold rounded-md transition-all flex items-center gap-1 ${!includeHolds ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                            title="Show only confirmed bookings - optimistic availability view (holds may convert)"
                                        >
                                            <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                                            Confirmed Only
                                        </button>
                                    </div>
                                    <div className="flex bg-white border border-gray-300 rounded-lg p-0.5">
                                        <button onClick={() => setViewMode('daily')} className={`px-2 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'daily' ? 'bg-blue-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Day</button>
                                        <button onClick={() => setViewMode('weekly')} className={`px-2 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'weekly' ? 'bg-blue-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Week</button>
                                        <button onClick={() => setViewMode('monthly')} className={`px-2 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'monthly' ? 'bg-blue-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Month</button>
                                        <button onClick={() => setViewMode('yearly')} className={`px-2 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'yearly' ? 'bg-blue-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Year</button>
                                    </div>
                                    {/* Reset Button - inline with options */}
                                    <button 
                                        onClick={() => {
                                            setSelectedMarket('ALL');
                                            setSelectedMedia('ALL');
                                            setSelectedZip(''); // Reset ZIP filter
                                            setInventoryOverride(null);
                                            setRequiredSize(50);
                                            setIncludeHolds(true);
                                            setViewMode('daily');
                                            setSortByImpressions(false); // Reset impressions sort
                                            // Reset dates to default (today + 90 days)
                                            const today = new Date();
                                            const day = today.getDay();
                                            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                                            const monday = new Date(today.setDate(diff));
                                            setRangeStart(monday.toISOString().split('T')[0]);
                                            const futureDate = new Date();
                                            futureDate.setDate(futureDate.getDate() + 90);
                                            setRangeEnd(futureDate.toISOString().split('T')[0]);
                                        }}
                                        className="px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-100 border border-gray-300 text-gray-600 hover:bg-red-50 hover:border-red-300 hover:text-red-600 transition-all flex items-center gap-1"
                                        title="Reset all filters to defaults"
                                    >
                                        <Icon name="RotateCcw" size={12} />
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    )}
                    
                    {/* CONTENT AREA */}
                    <div className={isFullscreen ? "p-2" : "p-4"}>
                    
                    {/* ZIP IMPRESSIONS BANNER - Hidden in fullscreen */}
                    {!isFullscreen && selectedZip && LA_ZIP_DATA[selectedZip] && (
                        <div className="mb-4 p-3 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-white font-bold text-sm">
                                            {selectedZip.slice(-2)}
                                        </div>
                                        <div>
                                            <div className="font-bold text-emerald-800 text-lg flex items-center gap-2">
                                                {LA_ZIP_DATA[selectedZip].area}
                                                <span className="text-[10px] font-normal px-1.5 py-0.5 bg-emerald-200 text-emerald-700 rounded">üìä Reference</span>
                                            </div>
                                            <div className="text-xs text-emerald-600">ZIP {selectedZip} ‚Ä¢ {LA_ZIP_DATA[selectedZip].pop.toLocaleString()} pop ‚Ä¢ {LA_ZIP_DATA[selectedZip].sqMi} mi¬≤ ‚Ä¢ <span className="italic">Est. weekly impressions per unit</span></div>
                                        </div>
                                    </div>
                                    <div className="h-10 w-px bg-emerald-200"></div>
                                    <div className="text-center">
                                        <div className="text-xs text-emerald-600 font-medium">Pop Density</div>
                                        <div className="text-xl font-bold text-emerald-700">{Math.round(LA_ZIP_DATA[selectedZip].pop / LA_ZIP_DATA[selectedZip].sqMi).toLocaleString()}/mi¬≤</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {/* Impressions by product for this ZIP */}
                                    {(() => {
                                        const density = LA_ZIP_DATA[selectedZip].pop / LA_ZIP_DATA[selectedZip].sqMi;
                                        const baseImps = Math.round(density * 0.75);
                                        return (
                                            <>
                                                <div className="text-center px-3 py-1 bg-white rounded-lg border border-emerald-200">
                                                    <div className="text-[10px] text-gray-500">Digital</div>
                                                    <div className="font-bold text-emerald-700">{(baseImps * 2.8 / 1000).toFixed(0)}K</div>
                                                </div>
                                                <div className="text-center px-3 py-1 bg-white rounded-lg border border-emerald-200">
                                                    <div className="text-[10px] text-gray-500">Panel</div>
                                                    <div className="font-bold text-emerald-700">{(baseImps * 1.15 / 1000).toFixed(0)}K</div>
                                                </div>
                                                <div className="text-center px-3 py-1 bg-white rounded-lg border border-emerald-200">
                                                    <div className="text-[10px] text-gray-500">Transit</div>
                                                    <div className="font-bold text-emerald-700">{(baseImps * 0.65 / 1000).toFixed(0)}K</div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                    <button 
                                        onClick={() => setSelectedZip('')}
                                        className="p-1.5 text-emerald-600 hover:bg-emerald-100 rounded-lg transition-colors"
                                        title="Clear ZIP selection"
                                    >
                                        <Icon name="X" size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MARKET SUMMARY CARDS - Hidden in fullscreen */}
                    {!isFullscreen && (
                    <div className="mb-4 grid grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-2">
                        {marketSummary.slice(0, 6).map((m, idx) => (
                            <button 
                                key={m.market}
                                onClick={() => setSelectedMarket(m.market)}
                                className={`p-2 rounded-lg border text-left transition-all hover:shadow ${selectedMarket === m.market ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-200' : 'border-gray-200 bg-white hover:border-gray-300'}`}
                            >
                                <div className="text-[9px] font-bold text-gray-500 uppercase truncate">{m.market.split(',')[0]}</div>
                                <div className="text-base font-bold text-gray-800">{m.booked}</div>
                                <div className="text-[9px] text-gray-500">{m.campaigns} flights</div>
                            </button>
                        ))}
                    </div>
                    )}
                    
                    {/* View Mode Info Banner */}
                    {!isFullscreen && !includeHolds && (
                        <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2">
                            <Icon name="Info" size={14} className="text-blue-600 flex-shrink-0" />
                            <span className="text-xs text-blue-700">
                                <strong>Confirmed Only view:</strong> Showing only contracted bookings. Pending holds ({filteredData.filter(d => d.stage?.includes('Hold') || d.stage?.includes('Pending')).length} flights) are hidden ‚Äî actual availability may be lower if holds convert.
                            </span>
                            <button 
                                onClick={() => setIncludeHolds(true)}
                                className="ml-auto px-2 py-1 text-[10px] font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition-all flex-shrink-0"
                            >
                                Show All
                            </button>
                        </div>
                    )}

                    {/* RECOMMENDATIONS BAR - Hidden in fullscreen */}
                    {!isFullscreen && bestOpeningsByMedia.recommendations.length > 0 && (
                        <div className="mb-3 p-2 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                            <div className="flex items-center justify-between gap-2">
                                <div className="flex items-center gap-3 overflow-x-auto text-xs">
                                    {bestOpeningsByMedia.recommendations.slice(0, 2).map((rec, idx) => (
                                        <div key={idx} className="flex items-center gap-1 whitespace-nowrap">
                                            <span>{rec.icon}</span>
                                            <span className="font-semibold text-green-800">{rec.title}:</span>
                                            <span className="text-green-700 truncate max-w-[200px]">{rec.message}</span>
                                        </div>
                                    ))}
                                </div>
                                <button 
                                    onClick={() => setShowOpeningsPanel(!showOpeningsPanel)}
                                    className="px-2 py-1 bg-green-600 text-white text-[11px] font-bold rounded hover:bg-green-700 transition-colors flex items-center gap-1 whitespace-nowrap"
                                >
                                    <Icon name="Search" size={12} />
                                    {showOpeningsPanel ? 'Hide' : 'Find Openings'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* BEST OPENINGS PANEL (Expandable) - Hidden in fullscreen */}
                    {!isFullscreen && showOpeningsPanel && (
                        <div className="mb-6 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                            <div className="bg-gradient-to-r from-green-600 to-emerald-600 p-4 text-white">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-lg flex items-center gap-2">
                                            <Icon name="Search" size={20} /> Best Openings Finder
                                        </h3>
                                        <p className="text-green-100 text-sm">Finding windows for {requiredSize}+ units ‚Ä¢ {rangeStart} to {rangeEnd}</p>
                                    </div>
                                    <button onClick={() => setShowOpeningsPanel(false)} className="p-1 hover:bg-white/20 rounded">
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-4">
                                {/* Quick Stats */}
                                <div className="grid grid-cols-5 gap-3 mb-4">
                                    <div className="bg-blue-50 p-3 rounded-lg text-center">
                                        <div className="text-2xl font-bold text-blue-700">{bestOpeningsByMedia.byMedia.filter(m => m.shortTerm.length > 0).length}</div>
                                        <div className="text-xs text-blue-600">Media w/ Short-Term</div>
                                    </div>
                                    <div className="bg-purple-50 p-3 rounded-lg text-center">
                                        <div className="text-2xl font-bold text-purple-700">{bestOpeningsByMedia.byMedia.filter(m => m.longTerm.length > 0).length}</div>
                                        <div className="text-xs text-purple-600">Media w/ Long-Term</div>
                                    </div>
                                    <div className="bg-green-50 p-3 rounded-lg text-center">
                                        <div className="text-2xl font-bold text-green-700">{bestOpeningsByMedia.byMarket.length}</div>
                                        <div className="text-xs text-green-600">Markets w/ Space</div>
                                    </div>
                                    <div className="bg-amber-50 p-3 rounded-lg text-center">
                                        <div className="text-2xl font-bold text-amber-700">{bestOpeningsByMedia.byMedia.filter(m => m.hasImmediate).length}</div>
                                        <div className="text-xs text-amber-600">Immediate Options</div>
                                    </div>
                                    <button 
                                        onClick={() => setSortByImpressions(!sortByImpressions)}
                                        className={`p-3 rounded-lg text-center transition-all ${sortByImpressions ? 'bg-emerald-100 border-2 border-emerald-400' : 'bg-emerald-50 hover:bg-emerald-100'}`}
                                        title="Impressions if you sell the available inventory"
                                    >
                                        <div className="text-2xl font-bold text-emerald-700">
                                            {(() => {
                                                // Calculate based on ACTUAL available inventory
                                                const avgAvailable = utilizationData.length > 0 
                                                    ? Math.round(utilizationData.reduce((sum, d) => sum + d.available, 0) / utilizationData.length)
                                                    : 0;
                                                const weeksInRange = utilizationData.length / 7;
                                                const weeklyImpRate = selectedMedia.includes('Digital') ? 45000 : 15000;
                                                const totalImps = avgAvailable * weeklyImpRate * weeksInRange;
                                                
                                                if (totalImps >= 1000000000) return `${(totalImps / 1000000000).toFixed(1)}B`;
                                                if (totalImps >= 1000000) return `${(totalImps / 1000000).toFixed(0)}M`;
                                                if (totalImps >= 1000) return `${Math.round(totalImps / 1000)}K`;
                                                return totalImps.toString();
                                            })()}
                                        </div>
                                        <div className="text-xs text-emerald-600">{sortByImpressions ? '‚úì Sorted by Imps' : 'Sellable Imps'}</div>
                                    </button>
                                </div>

                                {/* Tabs for Short-Term vs Long-Term */}
                                <div className="flex gap-2 mb-4 border-b">
                                    <button 
                                        onClick={() => setViewMode('daily')}
                                        className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${viewMode === 'daily' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        üöÄ Short-Term (1-4 weeks)
                                    </button>
                                    <button 
                                        onClick={() => setViewMode('weekly')}
                                        className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${viewMode === 'weekly' ? 'border-purple-600 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    >
                                        üìÖ Long-Term (4+ weeks)
                                    </button>
                                </div>

                                {/* Openings by Media Type */}
                                <div className="space-y-3 max-h-96 overflow-y-auto">
                                    {(sortByImpressions ? bestOpeningsByMedia.byImpressions : bestOpeningsByMedia.byMedia)
                                        .filter(m => viewMode === 'daily' ? m.shortTerm.length > 0 : m.longTerm.length > 0)
                                        .map((media, idx) => {
                                            const openings = viewMode === 'daily' ? media.shortTerm : media.longTerm;
                                            const impTotal = media.impressions?.rangeTotal || 0;
                                            const impDisplay = impTotal >= 1000000000 
                                                ? `${(impTotal / 1000000000).toFixed(1)}B`
                                                : impTotal >= 1000000 
                                                    ? `${(impTotal / 1000000).toFixed(1)}M` 
                                                    : `${Math.round(impTotal / 1000)}K`;
                                            return (
                                                <div key={idx} className={`border rounded-lg p-3 hover:border-gray-300 transition-colors ${sortByImpressions && idx === 0 ? 'border-emerald-400 bg-emerald-50/30' : 'border-gray-200'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-2 flex-wrap">
                                                            <span className={`w-2 h-2 rounded-full ${media.availabilityScore > 70 ? 'bg-green-500' : media.availabilityScore > 40 ? 'bg-yellow-500' : 'bg-red-500'}`}></span>
                                                            <span className="font-semibold text-gray-800">{media.media}</span>
                                                            {media.hasImmediate && <span className="px-1.5 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded">NOW</span>}
                                                            {sortByImpressions && idx === 0 && <span className="px-1.5 py-0.5 bg-emerald-500 text-white text-[10px] font-bold rounded">üèÜ TOP IMPS</span>}
                                                            <span className="px-1.5 py-0.5 bg-gray-100 text-gray-600 text-[10px] font-medium rounded">{media.impressions?.tier || 'Standard'}</span>
                                                        </div>
                                                        <div className="text-right flex items-center gap-3">
                                                            {/* Impressions Estimate - for selected date range */}
                                                            <div className="flex flex-col items-end" title={`${media.totalAvailableDays || 0} available days √ó ${media.impressions?.avgAvailableUnits || 0} avg units`}>
                                                                <span className="text-[10px] text-emerald-600 font-medium">Range Imps</span>
                                                                <span className="font-bold text-emerald-700">~{impDisplay}</span>
                                                            </div>
                                                            <div className="flex flex-col items-end">
                                                                <span className="text-[10px] text-gray-500">Avail</span>
                                                                <span className={`font-bold ${media.availabilityScore > 70 ? 'text-green-600' : media.availabilityScore > 40 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                                    {media.availabilityScore}%
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                        {openings.map((gap, gIdx) => {
                                                            // Calculate impressions for this specific gap
                                                            const gapImps = Math.round((media.impressions?.weeklyPerUnit || 20000) * gap.avgAvail * (gap.length / 7));
                                                            const gapImpDisplay = gapImps >= 1000000 
                                                                ? `${(gapImps / 1000000).toFixed(1)}M` 
                                                                : `${Math.round(gapImps / 1000)}K`;
                                                            return (
                                                                <div 
                                                                    key={gIdx} 
                                                                    className={`p-2 rounded-lg text-xs ${gIdx === 0 ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}`}
                                                                >
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="font-bold text-gray-700">
                                                                            {Math.floor(gap.length / 7)} weeks
                                                                        </span>
                                                                        {gIdx === 0 && <span className="text-green-600 text-[10px] font-bold">BEST</span>}
                                                                    </div>
                                                                    <div className="text-gray-600">
                                                                        {gap.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {gap.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                                    </div>
                                                                    <div className="text-gray-500 mt-1">
                                                                        {gap.avgAvail} avg units ‚Ä¢ <span className="text-emerald-600 font-semibold">~{gapImpDisplay} imps</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    
                                    {bestOpeningsByMedia.byMedia.filter(m => viewMode === 'daily' ? m.shortTerm.length > 0 : m.longTerm.length > 0).length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icon name="AlertCircle" size={32} className="mx-auto mb-2 text-gray-400" />
                                            <p>No {viewMode === 'daily' ? 'short-term (1-4 week)' : 'long-term (4+ week)'} openings found for {requiredSize}+ units</p>
                                            <p className="text-sm mt-1">Try reducing the required units or expanding your date range</p>
                                        </div>
                                    )}
                                </div>

                                {/* Market Availability Section */}
                                {bestOpeningsByMedia.byMarket.length > 0 && (
                                    <div className="mt-4 pt-4 border-t">
                                        <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                            <Icon name="MapPin" size={16} className="text-blue-600" /> Markets with Available Space
                                        </h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            {bestOpeningsByMedia.byMarket.map((market, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => { setSelectedMarket(market.market); setShowOpeningsPanel(false); }}
                                                    className={`p-2 rounded-lg text-left text-xs border transition-all hover:shadow-md ${
                                                        market.utilization < 50 ? 'bg-green-50 border-green-200 hover:border-green-400' :
                                                        market.utilization < 70 ? 'bg-blue-50 border-blue-200 hover:border-blue-400' :
                                                        'bg-amber-50 border-amber-200 hover:border-amber-400'
                                                    }`}
                                                >
                                                    <div className="font-semibold text-gray-800 truncate">{market.market.split(',')[0]}</div>
                                                    <div className="flex justify-between mt-1">
                                                        <span className="text-gray-500">{market.available} avail</span>
                                                        <span className={`font-bold ${market.utilization < 50 ? 'text-green-600' : market.utilization < 70 ? 'text-blue-600' : 'text-yellow-600'}`}>
                                                            {100 - market.utilization}% open
                                                        </span>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* GAP ANALYSIS SUMMARY - Hidden in fullscreen */}
                    {!isFullscreen && (
                    <div className="mb-3">
                        {/* Quick Reference Toggle */}
                        <div className="flex justify-end mb-1">
                            <button 
                                onClick={() => setShowMetricsHelp(!showMetricsHelp)}
                                className="text-[10px] text-gray-500 hover:text-blue-600 flex items-center gap-1"
                            >
                                <Icon name="HelpCircle" size={12} />
                                {showMetricsHelp ? 'Hide' : 'What do these mean?'}
                            </button>
                        </div>
                        
                        {/* Metrics Help Panel */}
                        {showMetricsHelp && (
                            <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-[11px]">
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <span className="font-bold text-green-700">üîç OPENINGS:</span>
                                        <p className="text-gray-600">Number of media types (products) with availability gaps that fit your "Need" requirement.</p>
                                    </div>
                                    <div>
                                        <span className="font-bold text-blue-700">‚úì BEST WINDOW:</span>
                                        <p className="text-gray-600">Longest continuous period with enough availability to book your requested units.</p>
                                    </div>
                                    <div>
                                        <span className="font-bold text-purple-700">üì¶ SELLABLE:</span>
                                        <p className="text-gray-600">Count of availability gaps: "4+wk" = full flight opportunities, "1-3wk" = shorter fills.</p>
                                    </div>
                                    <div>
                                        <span className="font-bold text-indigo-700">üìä AVG UTIL:</span>
                                        <p className="text-gray-600">Average % of inventory booked across selected date range. Higher = busier.</p>
                                    </div>
                                    <div>
                                        <span className="font-bold text-amber-700">üìà PEAK:</span>
                                        <p className="text-gray-600">Highest single-day booking count. Shows your busiest day in the range.</p>
                                    </div>
                                    <div>
                                        <span className="font-bold text-emerald-700">üì£ SELLABLE IMPS:</span>
                                        <p className="text-gray-600">Impressions you can deliver if you sell available inventory. Shows avg available units √ó ~15K weekly imps (static) or ~45K (digital) √ó weeks.</p>
                                    </div>
                                </div>
                                <div className="pt-2 border-t border-blue-200">
                                    <span className="font-bold text-gray-700">üìã BOOKING VIEW OPTIONS:</span>
                                    <div className="flex gap-4 mt-1">
                                        <div className="flex items-start gap-1">
                                            <span className="w-2 h-2 mt-1 rounded-full bg-orange-400 flex-shrink-0"></span>
                                            <p className="text-gray-600"><strong>All Bookings:</strong> Includes confirmed + pending holds. Conservative view ‚Äî shows less availability.</p>
                                        </div>
                                        <div className="flex items-start gap-1">
                                            <span className="w-2 h-2 mt-1 rounded-full bg-blue-500 flex-shrink-0"></span>
                                            <p className="text-gray-600"><strong>Confirmed Only:</strong> Shows only contracted bookings. Optimistic view ‚Äî holds may convert and reduce actual availability.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
                        <button 
                            onClick={() => setShowOpeningsPanel(!showOpeningsPanel)}
                            className={`p-2 border rounded-lg transition-all hover:shadow ${showOpeningsPanel ? 'bg-green-100 border-green-400' : 'bg-green-50 border-green-200'}`}
                            title="Media types with availability gaps fitting your Need requirement"
                        >
                            <h4 className="text-[9px] font-bold uppercase flex items-center gap-1 text-green-700">
                                <Icon name="Search" size={10}/> Openings
                            </h4>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-bold text-green-700">{bestOpeningsByMedia.byMedia.filter(m => m.bestGap).length}</span>
                                <span className="text-[10px] text-green-600">media types</span>
                            </div>
                        </button>

                        <div 
                            className={`p-2 border rounded-lg ${gaps[0] ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'}`}
                            title="Longest continuous period with enough availability"
                        >
                            <h4 className="text-[9px] font-bold uppercase flex items-center gap-1 text-blue-700">
                                <Icon name="CheckCircle" size={10}/> Best Window
                            </h4>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-bold text-blue-700">{gaps[0] ? Math.floor(gaps[0].length / 7) : 0}</span>
                                <span className="text-[10px] text-blue-600">weeks</span>
                            </div>
                        </div>

                        <div 
                            className="p-2 bg-purple-50 border border-purple-200 rounded-lg"
                            title="Availability gaps: 4+wk = full flights, 1-3wk = shorter fills"
                        >
                            <h4 className="text-[9px] font-bold text-purple-700 uppercase">Sellable</h4>
                            <div className="text-[10px] text-purple-900">
                                <span className="font-bold">{gaps.filter(g => g.length >= 28).length}</span> 4+wk ‚Ä¢ 
                                <span className="font-bold ml-1">{gaps.filter(g => g.length >= 7 && g.length < 28).length}</span> 1-3wk
                            </div>
                        </div>

                        <div 
                            className="p-2 bg-indigo-50 border border-indigo-200 rounded-lg"
                            title="Average % of inventory booked in this date range"
                        >
                            <h4 className="text-[9px] font-bold text-indigo-700 uppercase">Avg Util</h4>
                            <div className="text-xl font-bold text-indigo-700">
                                {utilizationData.length > 0 ? Math.round(utilizationData.reduce((sum, d) => sum + d.utilizationPct, 0) / utilizationData.length) : 0}%
                            </div>
                        </div>

                        <div 
                            className="p-2 bg-amber-50 border border-amber-200 rounded-lg"
                            title="Highest single-day booking in this range"
                        >
                            <h4 className="text-[9px] font-bold text-amber-700 uppercase">Peak</h4>
                            <div className="text-xl font-bold text-amber-700">
                                {utilizationData.length > 0 ? Math.max(...utilizationData.map(d => d.booked)) : 0}
                            </div>
                        </div>
                        
                        {/* Sellable Impressions Card - Based on ACTUAL available inventory */}
                        <button 
                            onClick={() => { setSortByImpressions(true); setShowOpeningsPanel(true); }}
                            className={`p-2 border rounded-lg transition-all hover:shadow ${sortByImpressions ? 'bg-emerald-100 border-emerald-400' : 'bg-emerald-50 border-emerald-200'}`}
                            title="Impressions you can deliver if you sell the available inventory"
                        >
                            <h4 className="text-[9px] font-bold uppercase flex items-center gap-1 text-emerald-700">
                                <Icon name="TrendingUp" size={10}/> Sellable Imps
                            </h4>
                            <div className="flex flex-col">
                                <div className="flex items-baseline gap-1">
                                    <span className="text-xl font-bold text-emerald-700">
                                        {(() => {
                                            // Calculate based on ACTUAL available inventory from timeline
                                            const avgAvailable = utilizationData.length > 0 
                                                ? Math.round(utilizationData.reduce((sum, d) => sum + d.available, 0) / utilizationData.length)
                                                : 0;
                                            const weeksInRange = utilizationData.length / 7;
                                            // Use a base weekly impressions rate (~15,000 per unit per week for static)
                                            const weeklyImpRate = selectedMedia.includes('Digital') ? 45000 : 15000;
                                            const totalImps = avgAvailable * weeklyImpRate * weeksInRange;
                                            
                                            if (totalImps >= 1000000000) return `${(totalImps / 1000000000).toFixed(1)}B`;
                                            if (totalImps >= 1000000) return `${(totalImps / 1000000).toFixed(1)}M`;
                                            if (totalImps >= 1000) return `${Math.round(totalImps / 1000)}K`;
                                            return totalImps.toLocaleString();
                                        })()}
                                    </span>
                                </div>
                                <span className="text-[9px] text-emerald-600">
                                    {utilizationData.length > 0 
                                        ? `${Math.round(utilizationData.reduce((sum, d) => sum + d.available, 0) / utilizationData.length).toLocaleString()} avg avail`
                                        : '0 avail'}
                                </span>
                            </div>
                        </button>
                    </div>
                    </div>
                    )}

                    {/* CHART VIEW: TIMELINE or MAP */}
                    {chartView === 'timeline' ? (
                        /* TIMELINE VISUALIZATION */
                        <div className="relative border rounded-lg bg-gray-50">
                            {/* Fullscreen compact info bar */}
                            {isFullscreen && (
                                <div className="flex items-center justify-between px-4 py-2 bg-gray-800 text-white text-sm">
                                    <div className="flex items-center gap-4">
                                        <span className="font-bold">{selectedMarket === 'ALL' ? 'All Markets' : selectedMarket.split(',')[0]}</span>
                                        <span className="text-gray-400">‚Ä¢</span>
                                        <span>{selectedMedia === 'ALL' ? 'All Media' : selectedMedia}</span>
                                        <span className="text-gray-400">‚Ä¢</span>
                                        <span className="text-blue-400">{totalInventory.toLocaleString()} faces</span>
                                        <span className="text-gray-400">‚Ä¢</span>
                                        <span>
                                            {new Date(rangeStart + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ‚Üí {new Date(rangeEnd + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                        </span>
                                        <span className="text-gray-400">|</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-blue-500"></span>Confirmed</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-orange-400"></span>On Hold</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex bg-gray-700 rounded p-0.5">
                                            <button onClick={() => setViewMode('daily')} className={`px-2 py-1 text-xs font-bold rounded transition-all ${viewMode === 'daily' ? 'bg-blue-500 text-white' : 'text-gray-300 hover:text-white'}`}>Day</button>
                                            <button onClick={() => setViewMode('weekly')} className={`px-2 py-1 text-xs font-bold rounded transition-all ${viewMode === 'weekly' ? 'bg-blue-500 text-white' : 'text-gray-300 hover:text-white'}`}>Week</button>
                                            <button onClick={() => setViewMode('monthly')} className={`px-2 py-1 text-xs font-bold rounded transition-all ${viewMode === 'monthly' ? 'bg-blue-500 text-white' : 'text-gray-300 hover:text-white'}`}>Month</button>
                                            <button onClick={() => setViewMode('yearly')} className={`px-2 py-1 text-xs font-bold rounded transition-all ${viewMode === 'yearly' ? 'bg-blue-500 text-white' : 'text-gray-300 hover:text-white'}`}>Year</button>
                                        </div>
                                        <span className="text-xs text-gray-400">Press ESC to exit</span>
                                    </div>
                                </div>
                            )}
                            <div className="flex border-b bg-white sticky top-0 z-20 shadow-sm">
                                <div className="w-28 p-2 text-[9px] font-bold text-gray-400 uppercase tracking-wider border-r">
                                    {viewMode === 'daily' ? 'Date' : viewMode === 'weekly' ? 'Week' : viewMode === 'monthly' ? 'Month' : 'Year'}
                                </div>
                                <div className="flex-1 p-2 text-[9px] font-bold text-gray-400 uppercase tracking-wider flex justify-between">
                                    <span>Booked Faces ({requiredSize} needed / {totalInventory.toLocaleString()} total)</span>
                                    <div className="flex gap-3 items-center">
                                        <span className="flex items-center gap-1">
                                            <span className="w-4 h-3 rounded bg-blue-500"></span>
                                            <span className="text-blue-700 font-bold">Confirmed</span>
                                        </span>
                                        <span className="flex items-center gap-1">
                                            <span className="w-4 h-3 rounded bg-orange-400 border border-orange-500"></span>
                                            <span className="text-orange-700 font-bold">On Hold</span>
                                        </span>
                                        <span className="text-gray-300 mx-1">|</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span>Space OK</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span>Tight</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span>Full</span>
                                    </div>
                                </div>
                            </div>

                            <div className={`${isFullscreen ? '' : 'max-h-[400px] overflow-y-auto'}`}>
                                {viewMode === 'daily' ? (
                                    // DAILY VIEW
                                    utilizationData.map((day, idx) => {
                                        const canFit = day.available >= requiredSize;
                                        const isExpanded = expandedRowId === `day-${idx}`;
                                        
                                        return (
                                            <div key={idx} className={`flex border-b last:border-0 hover:bg-white transition-colors ${day.isStartOfWeek ? 'border-t-2 border-t-blue-300' : ''}`}>
                                                <div className={`w-28 p-1.5 border-r flex flex-col justify-center relative ${canFit ? 'bg-green-50/50' : 'bg-red-50/30'}`}>
                                                    {day.isStartOfWeek && (
                                                        <span className="absolute top-0 left-0 bg-blue-600 text-white text-[7px] px-0.5 rounded-br font-bold">WK</span>
                                                    )}
                                                    <span className={`text-[11px] ${day.isStartOfWeek ? 'font-bold text-gray-900' : 'font-medium text-gray-600'}`}>
                                                        {day.dayName}
                                                    </span>
                                                    <span className={`text-[9px] ${canFit ? 'text-green-600' : 'text-red-500'} font-semibold`}>
                                                        {day.available} avail
                                                    </span>
                                                </div>
                                                
                                                <div className="flex-1 p-1.5 flex items-center relative">
                                                    {/* Target Line */}
                                                    <div className="absolute top-0 bottom-0 border-r-2 border-dashed border-blue-300 z-0" 
                                                        style={{ left: `calc(${Math.min(100, (requiredSize / totalInventory) * 100)}%)` }} 
                                                    />

                                                    {/* Clickable Stacked Bar */}
                                                    <div 
                                                        onClick={() => {
                                                            if (day.campaigns.length > 0) {
                                                                setExpandedRowId(isExpanded ? null : `day-${idx}`);
                                                            }
                                                        }}
                                                        className={`h-6 rounded flex overflow-hidden shadow-sm relative z-10 ${day.campaigns.length > 0 ? 'cursor-pointer hover:ring-2 hover:ring-blue-300' : ''}`} 
                                                        style={{ width: `${Math.max(2, day.utilizationPct)}%` }}
                                                        title={day.campaigns.length > 0 ? `Click for campaign details` : ""}
                                                    >
                                                        {day.confirmedUnits > 0 && (
                                                            <div className={`${getStatusColor(day.status)} flex items-center justify-center`} 
                                                                style={{ width: `${(day.confirmedUnits / day.booked) * 100}%` }}>
                                                                <span className="text-[10px] font-bold text-white truncate px-1">{day.confirmedUnits.toLocaleString()}</span>
                                                            </div>
                                                        )}
                                                        {day.holdUnits > 0 && (
                                                            <div className="bg-orange-400 flex items-center justify-center border-l-2 border-orange-500" 
                                                                style={{ width: `${(day.holdUnits / day.booked) * 100}%` }}>
                                                                <span className="text-[10px] font-bold text-orange-900 truncate px-1">{day.holdUnits.toLocaleString()} Hold</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Summary text after bar */}
                                                    <div className="ml-2 text-[9px] text-gray-500 whitespace-nowrap flex items-center gap-1">
                                                        <span className="font-semibold text-gray-700">{day.booked.toLocaleString()}</span>
                                                        <span className="text-gray-400">total</span>
                                                        <span className="text-gray-300">‚Ä¢</span>
                                                        <span className="text-gray-400">{day.campaigns.length} flights</span>
                                                    </div>
                                                    
                                                    {/* Click-to-open popup */}
                                                    {isExpanded && day.campaigns.length > 0 && (
                                                        <div 
                                                            className="fixed right-8 top-1/2 -translate-y-1/2 bg-gray-900 text-white text-[11px] p-4 rounded-xl shadow-2xl z-[100] w-96"
                                                            onClick={e => e.stopPropagation()}
                                                        >
                                                            <div className="font-bold border-b border-gray-700 pb-2 mb-3 flex justify-between items-center">
                                                                <span className="text-sm">Active Flights ({day.campaigns.length})</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-gray-400">{day.booked} / {totalInventory}</span>
                                                                    <button 
                                                                        onClick={() => setExpandedRowId(null)}
                                                                        className="text-gray-400 hover:text-white p-0.5 hover:bg-gray-700 rounded"
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <ul className="max-h-[60vh] overflow-y-auto space-y-1">
                                                                {day.campaigns.map((c, i) => (
                                                                    <li key={i} className="flex justify-between items-center">
                                                                        <span className="truncate flex-1">{c.name}</span>
                                                                        <span className={`ml-2 px-1.5 rounded text-[9px] font-bold ${c.stage?.includes('Hold') ? 'bg-orange-500' : 'bg-blue-500'}`}>{c.qty}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                            <div className="mt-3 pt-2 border-t border-gray-700 flex justify-between items-center text-xs">
                                                                <span className="text-gray-400">{day.campaigns.length} campaigns</span>
                                                                <span className="font-bold text-blue-400">{day.booked.toLocaleString()} total faces</span>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })
                                ) : viewMode === 'weekly' ? (
                                    // WEEKLY VIEW
                                    weeklyData.map((week, idx) => {
                                        const canFit = week.minAvailable >= requiredSize;
                                        const utilizationColor = week.avgUtilization >= 90 ? 'bg-red-500' : week.avgUtilization >= 70 ? 'bg-yellow-400' : week.avgUtilization >= 40 ? 'bg-blue-500' : 'bg-blue-300';
                                        const isExpanded = expandedRowId === `week-${idx}`;
                                        
                                        return (
                                            <div key={idx} className={`flex border-b last:border-0 hover:bg-white transition-colors ${canFit ? '' : 'bg-red-50/30'}`}>
                                                <div className={`w-28 p-1.5 border-r flex flex-col justify-center ${canFit ? 'bg-green-50/50' : ''}`}>
                                                    <span className="text-[11px] font-bold text-gray-900">{week.weekLabel}</span>
                                                    <span className={`text-[9px] ${canFit ? 'text-green-600' : 'text-red-500'} font-semibold`}>
                                                        Min: {week.minAvailable}
                                                    </span>
                                                </div>
                                                
                                                <div className="flex-1 p-1.5 flex items-center gap-2 relative">
                                                    {/* Clickable bar */}
                                                    <div 
                                                        onClick={() => {
                                                            if (week.campaignList && week.campaignList.length > 0) {
                                                                setExpandedRowId(isExpanded ? null : `week-${idx}`);
                                                            }
                                                        }}
                                                        className={`h-5 rounded ${utilizationColor} flex items-center px-2 shadow-sm transition-all ${week.campaignList?.length > 0 ? 'cursor-pointer hover:ring-2 hover:ring-white/50' : ''}`} 
                                                        style={{ width: `${Math.max(5, week.avgUtilization)}%` }}
                                                        title={week.campaignList?.length > 0 ? "Click to see campaign details" : ""}
                                                    >
                                                        <span className="text-[9px] font-bold text-white">{week.avgUtilization}%</span>
                                                    </div>
                                                    <div className="text-[10px] text-gray-500">
                                                        <span className="font-semibold text-gray-700">{week.avgBooked}</span> avg ‚Ä¢ 
                                                        <span className="font-semibold text-gray-700 ml-1">{week.campaignCount}</span> flights
                                                        {week.campaignList?.length > 0 && !isExpanded && (
                                                            <button 
                                                                onClick={() => setExpandedRowId(`week-${idx}`)}
                                                                className="ml-2 text-blue-500 hover:text-blue-700 font-medium"
                                                            >
                                                                ‚ñº Details
                                                            </button>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Click-to-open popup */}
                                                    {isExpanded && week.campaignList && week.campaignList.length > 0 && (
                                                        <div 
                                                            className="fixed right-8 top-1/2 -translate-y-1/2 bg-gray-900 text-white text-[11px] p-4 rounded-xl shadow-2xl z-[100] w-96"
                                                            onClick={e => e.stopPropagation()}
                                                        >
                                                            <div className="font-bold border-b border-gray-700 pb-2 mb-3 flex justify-between items-center">
                                                                <span className="text-sm">‚ñ£ Booked Campaigns ({week.campaignCount})</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-gray-400">{week.weekLabel}</span>
                                                                    <button 
                                                                        onClick={() => setExpandedRowId(null)}
                                                                        className="text-gray-400 hover:text-white p-0.5 hover:bg-gray-700 rounded"
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <ul className="max-h-[50vh] overflow-y-auto space-y-1">
                                                                {week.campaignList.map((campaign, i) => (
                                                                    <li key={i} className="flex items-center justify-between gap-2 py-0.5">
                                                                        <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                                                            <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-400' : 'bg-blue-400'}`}></span>
                                                                            <span className="truncate">{campaign.name}</span>
                                                                        </div>
                                                                        <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-500' : 'bg-blue-500'}`}>
                                                                            {campaign.qty}
                                                                        </span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                            <div className="mt-3 pt-2 border-t border-gray-700 grid grid-cols-4 gap-2 text-[10px]">
                                                                <div>
                                                                    <span className="text-gray-400">Peak:</span>
                                                                    <span className="ml-1 font-bold">{week.peakBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Avg:</span>
                                                                    <span className="ml-1 font-bold">{week.avgBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Avail:</span>
                                                                    <span className="ml-1 font-bold text-green-400">{week.minAvailable}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Total:</span>
                                                                    <span className="ml-1 font-bold text-blue-400">{week.campaignList.reduce((sum, c) => sum + (c.qty || 0), 0).toLocaleString()}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })
                                ) : viewMode === 'monthly' ? (
                                    // MONTHLY VIEW
                                    monthlyData.map((month, idx) => {
                                        const canFit = month.minAvailable >= requiredSize;
                                        const utilizationColor = month.avgUtilization >= 90 ? 'bg-red-500' : month.avgUtilization >= 70 ? 'bg-yellow-400' : month.avgUtilization >= 40 ? 'bg-blue-500' : 'bg-blue-300';
                                        const isExpanded = expandedRowId === `month-${idx}`;
                                        
                                        return (
                                            <div key={idx} className={`flex border-b last:border-0 hover:bg-white transition-colors ${canFit ? '' : 'bg-red-50/30'}`}>
                                                <div className={`w-28 p-1.5 border-r flex flex-col justify-center ${canFit ? 'bg-green-50/50' : ''}`}>
                                                    <span className="text-[11px] font-bold text-gray-900">{month.monthLabel}</span>
                                                    <span className={`text-[9px] ${canFit ? 'text-green-600' : 'text-red-500'} font-semibold`}>
                                                        {month.daysCount} days
                                                    </span>
                                                </div>
                                                
                                                <div className="flex-1 p-1.5 flex items-center gap-2 relative">
                                                    <div 
                                                        onClick={() => {
                                                            if (month.campaignList && month.campaignList.length > 0) {
                                                                setExpandedRowId(isExpanded ? null : `month-${idx}`);
                                                            }
                                                        }}
                                                        className={`h-5 rounded ${utilizationColor} flex items-center px-2 shadow-sm transition-all ${month.campaignList?.length > 0 ? 'cursor-pointer hover:ring-2 hover:ring-white/50' : ''}`} 
                                                        style={{ width: `${Math.max(5, month.avgUtilization)}%` }}
                                                        title={month.campaignList?.length > 0 ? "Click to see campaign details" : ""}
                                                    >
                                                        <span className="text-[9px] font-bold text-white">{month.avgUtilization}%</span>
                                                    </div>
                                                    <div className="text-[10px] text-gray-500">
                                                        <span className="font-semibold text-gray-700">{month.avgBooked}</span> avg ‚Ä¢ 
                                                        <span className="font-semibold text-gray-700 ml-1">{month.campaignCount}</span> flights
                                                    </div>
                                                    
                                                    {/* Click-to-open popup */}
                                                    {isExpanded && month.campaignList && month.campaignList.length > 0 && (
                                                        <div 
                                                            className="fixed right-8 top-1/2 -translate-y-1/2 bg-gray-900 text-white text-[11px] p-4 rounded-xl shadow-2xl z-[100] w-96"
                                                            onClick={e => e.stopPropagation()}
                                                        >
                                                            <div className="font-bold border-b border-gray-700 pb-2 mb-3 flex justify-between items-center">
                                                                <span className="text-sm">‚ñ£ Booked Campaigns ({month.campaignCount})</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-gray-400">{month.monthLabel}</span>
                                                                    <button 
                                                                        onClick={() => setExpandedRowId(null)}
                                                                        className="text-gray-400 hover:text-white p-0.5 hover:bg-gray-700 rounded"
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <ul className="max-h-[50vh] overflow-y-auto space-y-1">
                                                                {month.campaignList.map((campaign, i) => (
                                                                    <li key={i} className="flex items-center justify-between gap-2 py-0.5">
                                                                        <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                                                            <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-400' : 'bg-blue-400'}`}></span>
                                                                            <span className="truncate">{campaign.name}</span>
                                                                        </div>
                                                                        <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-500' : 'bg-blue-500'}`}>
                                                                            {campaign.qty}
                                                                        </span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                            <div className="mt-3 pt-2 border-t border-gray-700 grid grid-cols-4 gap-2 text-[10px]">
                                                                <div>
                                                                    <span className="text-gray-400">Peak:</span>
                                                                    <span className="ml-1 font-bold">{month.peakBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Avg:</span>
                                                                    <span className="ml-1 font-bold">{month.avgBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Min Avail:</span>
                                                                    <span className="ml-1 font-bold text-green-400">{month.minAvailable}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Total:</span>
                                                                    <span className="ml-1 font-bold text-blue-400">{month.campaignList.reduce((sum, c) => sum + (c.qty || 0), 0).toLocaleString()}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })
                                ) : (
                                    // YEARLY VIEW
                                    yearlyData.map((year, idx) => {
                                        const canFit = year.minAvailable >= requiredSize;
                                        const utilizationColor = year.avgUtilization >= 90 ? 'bg-red-500' : year.avgUtilization >= 70 ? 'bg-yellow-400' : year.avgUtilization >= 40 ? 'bg-blue-500' : 'bg-blue-300';
                                        const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
                                        const isExpanded = expandedRowId === `year-${idx}`;
                                        
                                        return (
                                            <div key={idx} className={`flex border-b last:border-0 hover:bg-white transition-colors ${canFit ? '' : 'bg-red-50/30'}`}>
                                                <div className={`w-28 p-1.5 border-r flex flex-col justify-center ${canFit ? 'bg-green-50/50' : ''}`}>
                                                    <span className="text-[11px] font-bold text-gray-900">{year.yearLabel}</span>
                                                    <span className={`text-[9px] ${canFit ? 'text-green-600' : 'text-red-500'} font-semibold`}>
                                                        {year.daysCount} days
                                                    </span>
                                                </div>
                                                
                                                <div className="flex-1 p-1.5 flex flex-col gap-1 relative">
                                                    <div className="flex items-center gap-2">
                                                        <div 
                                                            onClick={() => {
                                                                if (year.campaignList && year.campaignList.length > 0) {
                                                                    setExpandedRowId(isExpanded ? null : `year-${idx}`);
                                                                }
                                                            }}
                                                            className={`h-5 rounded ${utilizationColor} flex items-center px-2 shadow-sm transition-all ${year.campaignList?.length > 0 ? 'cursor-pointer hover:ring-2 hover:ring-white/50' : ''}`} 
                                                            style={{ width: `${Math.max(5, year.avgUtilization)}%` }}
                                                            title={year.campaignList?.length > 0 ? "Click to see campaign details" : ""}
                                                        >
                                                            <span className="text-[9px] font-bold text-white">{year.avgUtilization}%</span>
                                                        </div>
                                                        <div className="text-[10px] text-gray-500">
                                                            <span className="font-semibold text-gray-700">{year.avgBooked}</span> avg ‚Ä¢ 
                                                            <span className="font-semibold text-gray-700 ml-1">{year.campaignCount}</span> flights
                                                        </div>
                                                    </div>
                                                    {/* Mini monthly sparkline */}
                                                    <div className="flex gap-0.5">
                                                        {monthNames.map((m, mIdx) => {
                                                            const monthData = year.monthlyBreakdown[mIdx];
                                                            const monthUtil = monthData ? Math.min(100, Math.round((monthData.booked / monthData.days / totalInventory) * 100)) : 0;
                                                            const barColor = monthUtil >= 90 ? 'bg-red-400' : monthUtil >= 70 ? 'bg-yellow-400' : monthUtil >= 40 ? 'bg-blue-400' : monthUtil > 0 ? 'bg-blue-300' : 'bg-gray-200';
                                                            return (
                                                                <div key={mIdx} className="flex flex-col items-center" title={`${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][mIdx]}: ${monthUtil}%`}>
                                                                    <div className={`w-4 ${barColor} rounded-sm`} style={{ height: `${Math.max(2, monthUtil / 5)}px` }}></div>
                                                                    <span className="text-[7px] text-gray-400">{m}</span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    
                                                    {/* Click-to-open popup */}
                                                    {isExpanded && year.campaignList && year.campaignList.length > 0 && (
                                                        <div 
                                                            className="fixed right-8 top-1/2 -translate-y-1/2 bg-gray-900 text-white text-[11px] p-4 rounded-xl shadow-2xl z-[100] w-96"
                                                            onClick={e => e.stopPropagation()}
                                                        >
                                                            <div className="font-bold border-b border-gray-700 pb-2 mb-3 flex justify-between items-center">
                                                                <span className="text-sm">‚ñ£ Booked Campaigns ({year.campaignCount})</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-gray-400">{year.yearLabel}</span>
                                                                    <button 
                                                                        onClick={() => setExpandedRowId(null)}
                                                                        className="text-gray-400 hover:text-white p-0.5 hover:bg-gray-700 rounded"
                                                                    >
                                                                        ‚úï
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <ul className="max-h-[50vh] overflow-y-auto space-y-1">
                                                                {year.campaignList.map((campaign, i) => (
                                                                    <li key={i} className="flex items-center justify-between gap-2 py-0.5">
                                                                        <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                                                            <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-400' : 'bg-blue-400'}`}></span>
                                                                            <span className="truncate">{campaign.name}</span>
                                                                        </div>
                                                                        <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold flex-shrink-0 ${campaign.stage?.includes('Hold') ? 'bg-orange-500' : 'bg-blue-500'}`}>
                                                                            {campaign.qty}
                                                                        </span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                            <div className="mt-3 pt-2 border-t border-gray-700 grid grid-cols-4 gap-2 text-[10px]">
                                                                <div>
                                                                    <span className="text-gray-400">Peak:</span>
                                                                    <span className="ml-1 font-bold">{year.peakBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Avg:</span>
                                                                    <span className="ml-1 font-bold">{year.avgBooked}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Min Avail:</span>
                                                                    <span className="ml-1 font-bold text-green-400">{year.minAvailable}</span>
                                                                </div>
                                                                <div>
                                                                    <span className="text-gray-400">Total:</span>
                                                                    <span className="ml-1 font-bold text-blue-400">{year.campaignList.reduce((sum, c) => sum + (c.qty || 0), 0).toLocaleString()}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    ) : chartView === 'map' ? (
                        /* MAP VIEW */
                        <div className="border rounded-lg overflow-hidden bg-gray-50">
                            <div className="flex border-b bg-white p-2 justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <Icon name="MapPin" size={14} className="text-blue-600" />
                                    <span className="text-xs font-bold text-gray-700">Market Map</span>
                                    <span className="text-[10px] text-gray-400">({mapMarketData.length})</span>
                                </div>
                                <div className="flex gap-2 text-[9px]">
                                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span>{'<'}50%</span>
                                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span>50-70%</span>
                                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-500"></span>70-90%</span>
                                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span>{'>'}90%</span>
                                </div>
                            </div>
                            <div 
                                ref={mapContainerRef} 
                                style={{ height: '400px', width: '100%' }}
                                className="bg-gray-100"
                            />
                            {/* Market Legend Below Map */}
                            <div className="p-2 bg-white border-t max-h-32 overflow-y-auto">
                                <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-1.5">
                                    {mapMarketData.slice(0, 12).map((m, idx) => (
                                        <div 
                                            key={idx} 
                                            className={`p-1.5 rounded border text-[10px] cursor-pointer hover:shadow transition-all ${
                                                m.utilization >= 90 ? 'bg-red-50 border-red-200' :
                                                m.utilization >= 70 ? 'bg-yellow-50 border-yellow-200' :
                                                m.utilization >= 50 ? 'bg-blue-50 border-blue-200' :
                                                'bg-green-50 border-green-200'
                                            }`}
                                            onClick={() => setSelectedMarket(m.market)}
                                        >
                                            <div className="font-bold text-gray-800 truncate">{m.market.split(',')[0]}</div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-500">{m.booked}/{m.totalInventory}</span>
                                                <span className={`font-bold ${
                                                    m.utilization >= 90 ? 'text-red-600' :
                                                    m.utilization >= 70 ? 'text-yellow-600' :
                                                    m.utilization >= 50 ? 'text-blue-600' :
                                                    'text-green-600'
                                                }`}>{m.utilization}%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : (
                        /* GEOPATH IMPRESSION PLOTTER */
                        <div className="border rounded-xl overflow-hidden bg-gray-50">
                            {/* Header with upload */}
                            <div className="flex flex-wrap border-b bg-white p-3 justify-between items-center gap-3">
                                <div className="flex items-center gap-2">
                                    <Icon name="Target" size={18} className="text-emerald-600" />
                                    <span className="text-sm font-bold text-gray-700">Geopath Impression Plotter</span>
                                    {geopathData.length > 0 && (
                                        <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">
                                            {geopathData.length} locations
                                        </span>
                                    )}
                                </div>
                                <div className="flex items-center gap-3">
                                    <label className="px-3 py-1.5 bg-emerald-600 text-white text-xs font-bold rounded-lg hover:bg-emerald-700 transition-colors cursor-pointer flex items-center gap-1">
                                        <Icon name="UploadCloud" size={14} />
                                        Upload Geopath CSV
                                        <input 
                                            type="file" 
                                            accept=".csv" 
                                            onChange={handleGeopathUpload}
                                            className="hidden"
                                        />
                                    </label>
                                    {geopathFile && (
                                        <span className="text-xs text-gray-500">{geopathFile.name}</span>
                                    )}
                                </div>
                            </div>
                            
                            {geopathData.length === 0 ? (
                                /* Empty state - instructions */
                                <div className="p-12 text-center">
                                    <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="Target" size={32} className="text-emerald-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-800 mb-2">Upload Geopath Data</h3>
                                    <p className="text-gray-500 mb-6 max-w-md mx-auto">
                                        Upload a CSV export from Geopath to visualize location impressions on the map. 
                                        Locations will be color-coded by performance.
                                    </p>
                                    
                                    <div className="bg-gray-100 rounded-lg p-4 text-left max-w-lg mx-auto mb-6">
                                        <h4 className="font-bold text-gray-700 text-sm mb-2">Required CSV Columns:</h4>
                                        <ul className="text-xs text-gray-600 space-y-1">
                                            <li>‚Ä¢ <strong>Latitude</strong> (lat, latitude, y_coord)</li>
                                            <li>‚Ä¢ <strong>Longitude</strong> (lon, lng, longitude, x_coord)</li>
                                        </ul>
                                        <h4 className="font-bold text-gray-700 text-sm mt-3 mb-2">Optional Columns:</h4>
                                        <ul className="text-xs text-gray-600 space-y-1">
                                            <li>‚Ä¢ <strong>Impressions</strong> (impressions, imps, weekly_imp)</li>
                                            <li>‚Ä¢ <strong>ID</strong> (geopath_id, spot_id, panel_id)</li>
                                            <li>‚Ä¢ <strong>Name/Location</strong> (name, description, address)</li>
                                            <li>‚Ä¢ <strong>Media Type</strong> (media_type, media, format)</li>
                                            <li>‚Ä¢ <strong>Market</strong> (market, dma, cbsa)</li>
                                            <li>‚Ä¢ <strong>Reach/Frequency</strong></li>
                                        </ul>
                                    </div>
                                    
                                    <label className="px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition-colors cursor-pointer inline-flex items-center gap-2">
                                        <Icon name="UploadCloud" size={18} />
                                        Select CSV File
                                        <input 
                                            type="file" 
                                            accept=".csv" 
                                            onChange={handleGeopathUpload}
                                            className="hidden"
                                        />
                                    </label>
                                </div>
                            ) : (
                                <>
                                    {/* Stats bar */}
                                    {geopathStats && (
                                        <div className="p-3 bg-gradient-to-r from-emerald-50 to-teal-50 border-b grid grid-cols-2 md:grid-cols-6 gap-3">
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-emerald-700">{geopathStats.total}</div>
                                                <div className="text-[10px] text-emerald-600 uppercase">Locations</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-emerald-700">{(geopathStats.totalImpressions / 1000000).toFixed(1)}M</div>
                                                <div className="text-[10px] text-emerald-600 uppercase">Total Imps</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-emerald-700">{(geopathStats.avgImpressions / 1000).toFixed(0)}K</div>
                                                <div className="text-[10px] text-emerald-600 uppercase">Avg Imps</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-green-600">{(geopathStats.maxImpressions / 1000).toFixed(0)}K</div>
                                                <div className="text-[10px] text-green-600 uppercase">Top Imps</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-red-600">{(geopathStats.minImpressions / 1000).toFixed(0)}K</div>
                                                <div className="text-[10px] text-red-600 uppercase">Low Imps</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-lg font-bold text-gray-700">{geopathStats.markets.length}</div>
                                                <div className="text-[10px] text-gray-500 uppercase">Markets</div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Legend */}
                                    <div className="p-2 bg-white border-b flex flex-wrap items-center justify-center gap-3 text-[10px]">
                                        <span className="text-gray-500 font-semibold">Impressions:</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-green-500"></span> Top 10%</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-lime-500"></span> Top 25%</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-yellow-500"></span> Above Median</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-orange-500"></span> Below Median</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-red-500"></span> Bottom 25%</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-gray-400"></span> No Data</span>
                                    </div>
                                    
                                    {/* Map */}
                                    <div 
                                        ref={geopathMapRef} 
                                        style={{ height: '500px', width: '100%' }}
                                        className="bg-gray-800"
                                    />
                                    
                                    {/* Bottom summary */}
                                    <div className="p-3 bg-white border-t">
                                        <div className="flex justify-between items-center">
                                            <div className="text-xs text-gray-500">
                                                {geopathStats?.mediaTypes.length > 0 && (
                                                    <span>Media: {geopathStats.mediaTypes.slice(0, 5).join(', ')}{geopathStats.mediaTypes.length > 5 ? '...' : ''}</span>
                                                )}
                                            </div>
                                            <button 
                                                onClick={() => { setGeopathData([]); setGeopathFile(null); setGeopathStats(null); }}
                                                className="text-xs text-red-600 hover:text-red-800 font-semibold flex items-center gap-1"
                                            >
                                                <Icon name="X" size={12} /> Clear Data
                                            </button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                    </div>{/* End CONTENT AREA */}
                </div>
            );
        };

        // --- SIDEBAR COMPONENT (MOVED OUTSIDE APP TO FIX SCROLL RESET) ---
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CANVAS GEAR SIDEBAR - Exact replica from engine.js
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CanvasGearSidebar = ({ view, setView, onLogout, onOpenDigest, onOpenImpressions, onReset, onResetEmailLogs, onOpenSheetSettings, isCollapsed, setIsCollapsed }) => {
            const canvasRef = useRef(null);
            const animationRef = useRef(null);
            const stateRef = useRef({
                gearRotation: 0,
                targetGearAngle: 0,
                currentGearAngle: 0,
                // Pipeline gear state
                pipelineGearAngle: 0,
                targetPipelineAngle: 0,
                currentPipelineAngle: 0,
                // History gear state
                historyGearAngle: 0,
                targetHistoryAngle: 0,
                currentHistoryAngle: 0,
                systemReady: true, // Start ready immediately - no loading delay needed
                initTime: 0,
                hoveredNode: null,
                hoveredPipelineNode: null,
                hoveredHistoryNode: null,
                hoveredButton: null,
                hoveredLogo: false, // Track logo hover
                logoClickCount: 0, // Track logo clicks for secret feature
                logoClickTimer: null, // Timer to reset click count
                // Gear hover states (for showing/hiding orbital icons)
                mainGearHovered: false,
                pipelineGearHovered: false,
                historyGearHovered: false,
                // Fade animation values (0-1)
                mainIconsOpacity: 0,
                pipelineIconsOpacity: 0,
                historyIconsOpacity: 0,
                mouse: { x: 0, y: 0, clicked: false },
                lastTime: performance.now(),
                // Date/time updates
                currentTime: new Date(),
            });
            
            // Titanium Theme
            const T = {
                bgDark: '#020617',
                bgMid: '#0f172a',
                bgLight: '#1e293b',
                metalDim: '#334155',
                metalMid: '#94a3b8',
                metalBright: '#e2e8f0',
                accent: '#38bdf8',
                accentGlow: 'rgba(56, 189, 248, 0.25)',
                accentAlt: '#a78bfa',  // Purple for pipeline
                accentAltGlow: 'rgba(167, 139, 250, 0.25)',
                textMain: '#f1f5f9',
                textSub: '#64748b',
                textDim: '#475569',
            };
            
            // MAIN GEAR - Navigation nodes (9 items)
            const navNodes = [
                { id: 'dashboard', label: 'DASHBOARD', angle: -90 },
                { id: 'master', label: 'INSTALLATIONS', angle: -50 },  // Hidden admin feature - access via triple-click logo
                { id: 'holdReport', label: 'HOLD REPORT', angle: -10 },
                { id: 'availability', label: 'AVAILABILITY', angle: 30 },
                { id: 'riskAnalysis', label: 'RISK CENTER', angle: 70 },
                { id: 'specialMedia', label: 'SPECIALTY', angle: 110 },
                { id: 'popGallery', label: 'POP GALLERY', angle: 150 },
                { id: 'materialReceivers', label: 'MATERIALS', angle: 190 },
                { id: 'performanceReport', label: 'PERFORMANCE', angle: 230 },
            ];
            
            // PIPELINE GEAR - Secondary navigation (10 items)
            const pipelineNodes = [
                { id: 'delayedFlights', label: 'DELAYED', angle: -90 },
                { id: 'onHoldCampaigns', label: 'ON HOLD', angle: -54 },
                { id: 'inProgressFlights', label: 'IN-PROGRESS', angle: -18 },
                { id: 'fullyInstalledThisWeek', label: 'INSTALLED', angle: 18 },
                { id: 'rotations', label: 'ROTATIONS', angle: 54 },
                { id: 'thisWeek', label: 'THIS WEEK', angle: 90 },
                { id: 'upcoming', label: 'UPCOMING', angle: 126 },
                { id: 'materialReadyFuture', label: 'MAT READY', angle: 162 },
                { id: 'nextMonth', label: 'NEXT MONTH', angle: 198 },
                { id: 'pipelineSummary', label: 'SUMMARY', angle: 234 },
            ];
            
            // HISTORY GEAR - Tertiary navigation (6 items)
            const historyNodes = [
                { id: 'expiredFlights', label: 'EXPIRED', angle: -90 },
                { id: 'pastDue', label: 'PAST DUE', angle: -30 },
                { id: 'recentInstalls', label: 'INSTALLED 30D', angle: 30 },
                { id: 'history', label: '6-MONTH', angle: 90 },
                { id: 'lostOpportunities', label: 'LOST', angle: 150 },
                { id: 'impressions', label: 'ZIP IMPRESS', angle: 210 },
            ];
            
            const icons = {
                // Main gear icons
                dashboard: 'M3 3h7v9H3V3zm11 0h7v5h-7V3zm0 9h7v9h-7v-9zM3 16h7v5H3v-5z',
                holdReport: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2 M9 5a2 2 0 002 2h2a2 2 0 002-2 M9 5a2 2 0 012-2h2a2 2 0 012 2 M12 12h4 M12 16h4 M8 12h.01 M8 16h.01',
                availability: 'M8 2v4 M16 2v4 M3 10h18 M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z',
                riskAnalysis: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z M12 8v4 M12 16h.01',
                master: 'M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7 M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z',  // Edit/pencil icon for stage updates
                specialMedia: 'M3 11l18-5v12L3 13v-2z M11.6 16.8a3 3 0 11-5.8-1.6',
                popGallery: 'M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z M12 17a4 4 0 100-8 4 4 0 000 8z',
                materialReceivers: 'M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12',
                performanceReport: 'M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8',
                // Pipeline gear icons
                delayedFlights: 'M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z',
                onHoldCampaigns: 'M10 9v6 M14 9v6 M5 5h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z',
                inProgressFlights: 'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09z M12 15l-3-3a22 22 0 012-3.95A12.88 12.88 0 0122 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 01-4 2z M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0 M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5',
                fullyInstalledThisWeek: 'M6 9H4.5a2.5 2.5 0 010-5H6 M18 9h1.5a2.5 2.5 0 000-5H18 M4 22h16 M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22 M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22 M18 2H6v7a6 6 0 1012 0V2z',
                rotations: 'M17 1l4 4-4 4 M3 11V9a4 4 0 014-4h14 M7 23l-4-4 4-4 M21 13v2a4 4 0 01-4 4H3',
                thisWeek: 'M8 2v4 M16 2v4 M3 10h18 M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z',
                upcoming: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z',
                materialReadyFuture: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4',
                nextMonth: 'M12 6v6l4 2 M2 12a10 10 0 1020 0 10 10 0 00-20 0z',
                pipelineSummary: 'M18 20V10 M12 20V4 M6 20v-6',
                // History gear icons
                expiredFlights: 'M9 18h6 M10 22h4 M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z',
                pastDue: 'M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z M12 9v4 M12 17h.01',
                recentInstalls: 'M9 11l3 3L22 4 M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11',
                history: 'M12 8v4l3 3 M3 12a9 9 0 1018 0 9 9 0 00-18 0z',
                lostOpportunities: 'M12 12m-10 0a10 10 0 1020 0 10 10 0 10-20 0 M15 9l-6 6 M9 9l6 6',
                impressions: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z M12 10m-3 0a3 3 0 106 0 3 3 0 10-6 0',
            };
            
            const drawIcon = (ctx, pathData, x, y, size, color) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.scale(size / 24, size / 24);
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                const path = new Path2D(pathData);
                ctx.stroke(path);
                ctx.restore();
            };
            
            const drawGear = (ctx, x, y, radius, teeth, rotation) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation);
                
                ctx.beginPath();
                const toothDepth = radius * 0.12;
                
                for (let i = 0; i < teeth; i++) {
                    const angle = (i / teeth) * Math.PI * 2;
                    const nextAngle = ((i + 1) / teeth) * Math.PI * 2;
                    const midAngle = (angle + nextAngle) / 2;
                    
                    const innerR = radius - toothDepth;
                    const outerR = radius;
                    
                    const t1 = angle + (nextAngle - angle) * 0.2;
                    const t2 = angle + (nextAngle - angle) * 0.4;
                    const v1 = angle + (nextAngle - angle) * 0.6;
                    const v2 = angle + (nextAngle - angle) * 0.8;
                    
                    if (i === 0) {
                        ctx.moveTo(Math.cos(angle) * outerR, Math.sin(angle) * outerR);
                    }
                    
                    ctx.quadraticCurveTo(
                        Math.cos(t1) * (outerR + 2), Math.sin(t1) * (outerR + 2),
                        Math.cos(t2) * outerR, Math.sin(t2) * outerR
                    );
                    ctx.quadraticCurveTo(
                        Math.cos(midAngle) * (innerR - 2), Math.sin(midAngle) * (innerR - 2),
                        Math.cos(v1) * innerR, Math.sin(v1) * innerR
                    );
                    ctx.quadraticCurveTo(
                        Math.cos(v2) * (innerR - 2), Math.sin(v2) * (innerR - 2),
                        Math.cos(nextAngle) * outerR, Math.sin(nextAngle) * outerR
                    );
                }
                ctx.closePath();
                
                ctx.fillStyle = T.bgMid;
                ctx.fill();
                ctx.strokeStyle = T.metalMid;
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                // Inner circles
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.7, 0, Math.PI * 2);
                ctx.strokeStyle = T.metalDim;
                ctx.lineWidth = 0.5;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.6, 0, Math.PI * 2);
                ctx.globalAlpha = 0.3;
                ctx.stroke();
                ctx.globalAlpha = 1;
                
                ctx.restore();
            };
            
            const drawGearMarker = (ctx, x, y, radius, angle, color = T.accent) => {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                
                // Marker positioned OUTSIDE the gear teeth, pointing outward
                const markerY = -radius - 8;  // Outside the gear
                ctx.beginPath();
                ctx.moveTo(-6, markerY);
                ctx.lineTo(6, markerY);
                ctx.lineTo(0, markerY + 15);  // Arrow pointing inward to gear
                ctx.closePath();
                
                ctx.shadowColor = color;
                ctx.shadowBlur = 12;
                ctx.fillStyle = color;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                ctx.restore();
            };
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const sidebarWidth = 320;
                
                // MAIN GEAR config (Modules)
                const mainOrbitRadius = 105;
                const mainNodeRadius = 20;
                const mainGearSize = 62;
                const mainGearTeeth = 18;
                
                // PIPELINE GEAR config (smaller, interlocking)
                const pipelineOrbitRadius = 82;
                const pipelineNodeRadius = 17;
                const pipelineGearSize = 48;
                const pipelineGearTeeth = 14;
                
                // HISTORY GEAR config (smallest)
                const historyOrbitRadius = 62;
                const historyNodeRadius = 14;
                const historyGearSize = 38;
                const historyGearTeeth = 11;
                
                const render = () => {
                    const now = performance.now();
                    const dt = (now - stateRef.current.lastTime) / 1000;
                    stateRef.current.lastTime = now;
                    
                    // Update state
                    stateRef.current.gearRotation += dt;
                    stateRef.current.initTime += dt;
                    
                    // Update time every second
                    stateRef.current.currentTime = new Date();
                    
                    if (!stateRef.current.systemReady && stateRef.current.initTime > 1.5) {
                        stateRef.current.systemReady = true;
                    }
                    
                    // Main gear angle smoothing
                    const diff = stateRef.current.targetGearAngle - stateRef.current.currentGearAngle;
                    stateRef.current.currentGearAngle += diff * 0.08;
                    
                    // Pipeline gear angle smoothing
                    const pipelineDiff = stateRef.current.targetPipelineAngle - stateRef.current.currentPipelineAngle;
                    stateRef.current.currentPipelineAngle += pipelineDiff * 0.08;
                    
                    // History gear angle smoothing
                    const historyDiff = stateRef.current.targetHistoryAngle - stateRef.current.currentHistoryAngle;
                    stateRef.current.currentHistoryAngle += historyDiff * 0.08;
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // GEAR HOVER DETECTION - Check if mouse is near each gear
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    const mouse = stateRef.current.mouse;
                    
                    const h = canvas.height;
                    
                    // FOOTER FIXED AT BOTTOM - calculate footer height first
                    const footerHeight = 150;  // Space needed for date/time + buttons
                    const footerStartY = h - footerHeight;
                    
                    // THREE GEAR POSITIONS - Vertically stacked with MORE spacing
                    const gearAreaTop = 70;
                    const gearAreaBottom = footerStartY - 5;
                    const gearAreaHeight = gearAreaBottom - gearAreaTop;
                    
                    // Distribute gears evenly
                    const mainCenterX = sidebarWidth / 2;
                    const mainCenterY = gearAreaTop + gearAreaHeight * 0.22;  // MODULES - moved down
                    
                    // Pipeline gear - true center
                    const meshGap1 = 18;
                    const pipelineCenterX = sidebarWidth / 2;
                    const pipelineCenterY = gearAreaTop + gearAreaHeight * 0.52;  // PIPELINE - centered
                    
                    // History gear - lower, closer to footer
                    const meshGap2 = 15;
                    const historyCenterX = sidebarWidth / 2;
                    const historyCenterY = gearAreaTop + gearAreaHeight * 0.85;  // HISTORY - further down
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // HOVER DETECTION - Check if mouse is over each gear's orbit area
                    // Only ONE gear can be active at a time (closest one wins)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    const mainDist = Math.hypot(mouse.x - mainCenterX, mouse.y - mainCenterY);
                    const pipelineDist = Math.hypot(mouse.x - pipelineCenterX, mouse.y - pipelineCenterY);
                    const historyDist = Math.hypot(mouse.x - historyCenterX, mouse.y - historyCenterY);
                    
                    // Determine which gear is closest (exclusive hover)
                    const mainInRange = mainDist < mainOrbitRadius + 30;
                    const pipelineInRange = pipelineDist < pipelineOrbitRadius + 25;
                    const historyInRange = historyDist < historyOrbitRadius + 22;
                    
                    // Only one gear can be hovered - priority to closest
                    let activeGear = null;
                    if (mainInRange && (!pipelineInRange || mainDist < pipelineDist) && (!historyInRange || mainDist < historyDist)) {
                        activeGear = 'main';
                    } else if (pipelineInRange && (!historyInRange || pipelineDist < historyDist)) {
                        activeGear = 'pipeline';
                    } else if (historyInRange) {
                        activeGear = 'history';
                    }
                    
                    stateRef.current.mainGearHovered = activeGear === 'main';
                    stateRef.current.pipelineGearHovered = activeGear === 'pipeline';
                    stateRef.current.historyGearHovered = activeGear === 'history';
                    
                    // Animate opacity (FAST fade in/out for snappy response)
                    const fadeInSpeed = 0.25;
                    const fadeOutSpeed = 0.35;  // Even faster fade out
                    
                    stateRef.current.mainIconsOpacity += stateRef.current.mainGearHovered 
                        ? fadeInSpeed : -fadeOutSpeed;
                    stateRef.current.pipelineIconsOpacity += stateRef.current.pipelineGearHovered 
                        ? fadeInSpeed : -fadeOutSpeed;
                    stateRef.current.historyIconsOpacity += stateRef.current.historyGearHovered 
                        ? fadeInSpeed : -fadeOutSpeed;
                    
                    // Clamp opacity values
                    stateRef.current.mainIconsOpacity = Math.max(0, Math.min(1, stateRef.current.mainIconsOpacity));
                    stateRef.current.pipelineIconsOpacity = Math.max(0, Math.min(1, stateRef.current.pipelineIconsOpacity));
                    stateRef.current.historyIconsOpacity = Math.max(0, Math.min(1, stateRef.current.historyIconsOpacity));
                    
                    // Clear
                    ctx.clearRect(0, 0, sidebarWidth, h);
                    
                    // Background gradient
                    const bgGrad = ctx.createRadialGradient(mainCenterX, h/2, 0, mainCenterX, h/2, h * 0.7);
                    bgGrad.addColorStop(0, T.bgLight);
                    bgGrad.addColorStop(1, T.bgDark);
                    ctx.fillStyle = bgGrad;
                    ctx.fillRect(0, 0, sidebarWidth, h);
                    
                    // Scan lines
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.01)';
                    for (let i = 0; i < h; i += 3) {
                        ctx.fillRect(0, i, sidebarWidth, 1);
                    }
                    
                    // Right border
                    ctx.strokeStyle = T.metalDim;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(sidebarWidth, 0);
                    ctx.lineTo(sidebarWidth, h);
                    ctx.stroke();
                    
                    // Header
                    ctx.fillStyle = T.textSub;
                    ctx.font = '300 11px Montserrat, Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('LOS ANGELES OPS', mainCenterX, 24);
                    
                    ctx.fillStyle = T.textMain;
                    ctx.font = '600 18px Montserrat, Inter, sans-serif';
                    ctx.fillText('VECTOR', mainCenterX - 48, 48);
                    ctx.fillStyle = T.accent;
                    ctx.fillText('MEDIA', mainCenterX + 40, 48);
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // MAIN GEAR - MODULES
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    
                    // Main orbit ring (only show when hovered)
                    const mainOpacity = stateRef.current.mainIconsOpacity;
                    if (mainOpacity > 0.01) {
                        ctx.globalAlpha = mainOpacity * 0.5;
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([3, 6]);
                        ctx.beginPath();
                        ctx.arc(mainCenterX, mainCenterY, mainOrbitRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Connection lines to main nodes
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 0.5;
                        navNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = mainCenterX + Math.cos(rad) * mainOrbitRadius;
                            const ny = mainCenterY + Math.sin(rad) * mainOrbitRadius;
                            ctx.beginPath();
                            ctx.moveTo(mainCenterX, mainCenterY);
                            ctx.lineTo(nx, ny);
                            ctx.stroke();
                        });
                        ctx.globalAlpha = 1;
                    }
                    
                    // Calculate gear angles - all three mesh together
                    let mainGearAngle, pipelineGearAngle, historyGearAngle;
                    if (!stateRef.current.systemReady) {
                        mainGearAngle = stateRef.current.gearRotation * 0.12;
                        // Pipeline spins opposite (meshed!)
                        pipelineGearAngle = -stateRef.current.gearRotation * 0.12 * (mainGearTeeth / pipelineGearTeeth);
                        // History spins same as main (meshed with pipeline)
                        historyGearAngle = stateRef.current.gearRotation * 0.12 * (mainGearTeeth / historyGearTeeth);
                    } else {
                        mainGearAngle = stateRef.current.currentGearAngle * Math.PI / 180;
                        pipelineGearAngle = stateRef.current.currentPipelineAngle * Math.PI / 180;
                        historyGearAngle = stateRef.current.currentHistoryAngle * Math.PI / 180;
                    }
                    
                    // Draw MAIN gear
                    drawGear(ctx, mainCenterX, mainCenterY, mainGearSize, mainGearTeeth, mainGearAngle);
                    
                    // Main gear marker (cyan) - only show when hovering main nodes
                    if (stateRef.current.systemReady && stateRef.current.hoveredNode) {
                        drawGearMarker(ctx, mainCenterX, mainCenterY, mainGearSize, mainGearAngle, T.accent);
                    }
                    
                    // Main central hub (glows when hovered)
                    const mainHubHovered = stateRef.current.mainGearHovered;
                    
                    if (mainHubHovered) {
                        ctx.shadowColor = T.accent;
                        ctx.shadowBlur = 20;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(mainCenterX, mainCenterY, 46, 0, Math.PI * 2);
                    ctx.fillStyle = T.bgDark;
                    ctx.globalAlpha = 0.95;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    
                    ctx.beginPath();
                    ctx.arc(mainCenterX, mainCenterY, 42, 0, Math.PI * 2);
                    ctx.strokeStyle = mainHubHovered ? T.accent : T.metalDim;
                    ctx.lineWidth = mainHubHovered ? 2 : 1;
                    ctx.stroke();
                    
                    // Main hub text
                    if (stateRef.current.systemReady) {
                        const hovered = stateRef.current.hoveredNode;
                        const displayText = hovered ? hovered.label : 'MODULES';
                        
                        ctx.fillStyle = mainHubHovered ? T.accent : (hovered ? T.textMain : T.textSub);
                        ctx.font = mainHubHovered || hovered ? '600 12px Montserrat, Inter, sans-serif' : '400 11px Montserrat, Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(displayText, mainCenterX, mainCenterY + 4);
                    } else {
                        ctx.fillStyle = T.textSub;
                        ctx.font = '300 10px Montserrat, Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('LOADING', mainCenterX, mainCenterY + 4);
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // GEAR MESH CONNECTIONS - Visual links between all three gears
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    
                    // Mesh point 1: Main ‚Üí Pipeline (midpoint between gears)
                    const meshPointY1 = (mainCenterY + mainGearSize + pipelineCenterY - pipelineGearSize) / 2;
                    ctx.strokeStyle = T.metalDim;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(mainCenterX, mainCenterY + mainGearSize);
                    ctx.lineTo(pipelineCenterX, pipelineCenterY - pipelineGearSize);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.arc(mainCenterX, meshPointY1, 4, 0, Math.PI * 2);
                    ctx.fillStyle = T.accent;
                    ctx.shadowColor = T.accent;
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // Mesh point 2: Pipeline ‚Üí History (midpoint between gears)
                    const meshPointY2 = (pipelineCenterY + pipelineGearSize + historyCenterY - historyGearSize) / 2;
                    ctx.strokeStyle = T.metalDim;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(pipelineCenterX, pipelineCenterY + pipelineGearSize);
                    ctx.lineTo(historyCenterX, historyCenterY - historyGearSize);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.arc(pipelineCenterX, meshPointY2, 3, 0, Math.PI * 2);
                    ctx.fillStyle = T.accentAlt;
                    ctx.shadowColor = T.accentAlt;
                    ctx.shadowBlur = 6;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // PIPELINE GEAR - SECONDARY (below, interlocking)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    
                    // Pipeline orbit ring (only show when hovered)
                    const pipelineOpacity = stateRef.current.pipelineIconsOpacity;
                    if (pipelineOpacity > 0.01) {
                        ctx.globalAlpha = pipelineOpacity * 0.5;
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([2, 4]);
                        ctx.beginPath();
                        ctx.arc(pipelineCenterX, pipelineCenterY, pipelineOrbitRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Connection lines to pipeline nodes
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 0.5;
                        pipelineNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = pipelineCenterX + Math.cos(rad) * pipelineOrbitRadius;
                            const ny = pipelineCenterY + Math.sin(rad) * pipelineOrbitRadius;
                            ctx.beginPath();
                            ctx.moveTo(pipelineCenterX, pipelineCenterY);
                            ctx.lineTo(nx, ny);
                            ctx.stroke();
                        });
                        ctx.globalAlpha = 1;
                    }
                    
                    // Draw PIPELINE gear (spinning opposite)
                    drawGear(ctx, pipelineCenterX, pipelineCenterY, pipelineGearSize, pipelineGearTeeth, pipelineGearAngle);
                    
                    // Pipeline gear marker (purple) - only show when hovering pipeline nodes
                    if (stateRef.current.systemReady && stateRef.current.hoveredPipelineNode) {
                        drawGearMarker(ctx, pipelineCenterX, pipelineCenterY, pipelineGearSize, pipelineGearAngle, T.accentAlt);
                    }
                    
                    // Pipeline central hub (glows when hovered)
                    const pipelineHubHovered = stateRef.current.pipelineGearHovered;
                    
                    if (pipelineHubHovered) {
                        ctx.shadowColor = T.accentAlt;
                        ctx.shadowBlur = 18;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(pipelineCenterX, pipelineCenterY, 36, 0, Math.PI * 2);
                    ctx.fillStyle = T.bgDark;
                    ctx.globalAlpha = 0.95;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    
                    ctx.beginPath();
                    ctx.arc(pipelineCenterX, pipelineCenterY, 32, 0, Math.PI * 2);
                    ctx.strokeStyle = pipelineHubHovered ? T.accentAlt : T.metalDim;
                    ctx.lineWidth = pipelineHubHovered ? 2 : 1;
                    ctx.stroke();
                    
                    // Pipeline hub text
                    if (stateRef.current.systemReady) {
                        const hovered = stateRef.current.hoveredPipelineNode;
                        const displayText = hovered ? hovered.label : 'PIPELINE';
                        
                        ctx.fillStyle = pipelineHubHovered ? T.accentAlt : (hovered ? T.accentAlt : T.textSub);
                        ctx.font = pipelineHubHovered || hovered ? '600 10px Montserrat, Inter, sans-serif' : '400 10px Montserrat, Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(displayText, pipelineCenterX, pipelineCenterY + 4);
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // MAIN NAVIGATION NODES (only visible when gear is hovered)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    stateRef.current.hoveredNode = null;
                    
                    if (mainOpacity > 0.01) {
                        navNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = mainCenterX + Math.cos(rad) * mainOrbitRadius;
                            const ny = mainCenterY + Math.sin(rad) * mainOrbitRadius;
                            
                            const dist = Math.hypot(mouse.x - nx, mouse.y - ny);
                            const isHovered = dist < (mainNodeRadius + 5) && stateRef.current.systemReady && mainOpacity > 0.5;
                            const isActive = view === node.id;
                            
                            if (isHovered) {
                                stateRef.current.hoveredNode = node;
                                stateRef.current.targetGearAngle = node.angle + 90;
                            }
                            
                            ctx.globalAlpha = mainOpacity;
                            ctx.beginPath();
                            ctx.arc(nx, ny, mainNodeRadius, 0, Math.PI * 2);
                            
                            if (isActive) {
                                ctx.fillStyle = 'rgba(56, 189, 248, 0.15)';
                                ctx.shadowColor = T.accent;
                                ctx.shadowBlur = 15;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = T.accent;
                                ctx.lineWidth = 2;
                                ctx.stroke();
                            } else if (isHovered) {
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                                ctx.shadowColor = T.accentGlow;
                                ctx.shadowBlur = 10;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = T.metalMid;
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            }
                            
                            const iconColor = isActive ? T.accent : (isHovered ? T.accent : T.metalMid);
                            const iconSize = 18;
                            drawIcon(ctx, icons[node.id], nx - iconSize/2, ny - iconSize/2, iconSize, iconColor);
                            
                            ctx.globalAlpha = 1;
                        });
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // PIPELINE NAVIGATION NODES (only visible when gear is hovered)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    stateRef.current.hoveredPipelineNode = null;
                    
                    if (pipelineOpacity > 0.01) {
                        pipelineNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = pipelineCenterX + Math.cos(rad) * pipelineOrbitRadius;
                            const ny = pipelineCenterY + Math.sin(rad) * pipelineOrbitRadius;
                            
                            const dist = Math.hypot(mouse.x - nx, mouse.y - ny);
                            const isHovered = dist < (pipelineNodeRadius + 5) && stateRef.current.systemReady && pipelineOpacity > 0.5;
                            const isActive = view === node.id;
                            
                            if (isHovered) {
                                stateRef.current.hoveredPipelineNode = node;
                                stateRef.current.targetPipelineAngle = node.angle + 90;
                            }
                            
                            ctx.globalAlpha = pipelineOpacity;
                            ctx.beginPath();
                            ctx.arc(nx, ny, pipelineNodeRadius, 0, Math.PI * 2);
                            
                            if (isActive) {
                                ctx.fillStyle = 'rgba(167, 139, 250, 0.15)';  // Purple for pipeline
                                ctx.shadowColor = T.accentAlt;
                                ctx.shadowBlur = 15;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = T.accentAlt;
                                ctx.lineWidth = 2;
                                ctx.stroke();
                            } else if (isHovered) {
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                                ctx.shadowColor = T.accentAltGlow;
                                ctx.shadowBlur = 10;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = T.metalMid;
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            }
                            
                            const iconColor = isActive ? T.accentAlt : (isHovered ? T.accentAlt : T.metalMid);
                            const iconSize = 16;
                            drawIcon(ctx, icons[node.id], nx - iconSize/2, ny - iconSize/2, iconSize, iconColor);
                            
                            ctx.globalAlpha = 1;
                        });
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // HISTORY GEAR - TERTIARY (smallest, bottom)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    
                    // History orbit ring (only show when hovered)
                    const historyOpacity = stateRef.current.historyIconsOpacity;
                    if (historyOpacity > 0.01) {
                        ctx.globalAlpha = historyOpacity * 0.5;
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([2, 3]);
                        ctx.beginPath();
                        ctx.arc(historyCenterX, historyCenterY, historyOrbitRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Connection lines to history nodes
                        ctx.strokeStyle = T.metalDim;
                        ctx.lineWidth = 0.5;
                        historyNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = historyCenterX + Math.cos(rad) * historyOrbitRadius;
                            const ny = historyCenterY + Math.sin(rad) * historyOrbitRadius;
                            ctx.beginPath();
                            ctx.moveTo(historyCenterX, historyCenterY);
                            ctx.lineTo(nx, ny);
                            ctx.stroke();
                        });
                        ctx.globalAlpha = 1;
                    }
                    
                    // Draw HISTORY gear
                    drawGear(ctx, historyCenterX, historyCenterY, historyGearSize, historyGearTeeth, historyGearAngle);
                    
                    // History gear marker (amber/orange)
                    const historyAccent = '#f59e0b';
                    if (stateRef.current.systemReady && stateRef.current.hoveredHistoryNode) {
                        drawGearMarker(ctx, historyCenterX, historyCenterY, historyGearSize, historyGearAngle, historyAccent);
                    }
                    
                    // History central hub (glows when hovered)
                    const historyHubHovered = stateRef.current.historyGearHovered;
                    
                    if (historyHubHovered) {
                        ctx.shadowColor = historyAccent;
                        ctx.shadowBlur = 15;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(historyCenterX, historyCenterY, 28, 0, Math.PI * 2);
                    ctx.fillStyle = T.bgDark;
                    ctx.globalAlpha = 0.95;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    
                    ctx.beginPath();
                    ctx.arc(historyCenterX, historyCenterY, 24, 0, Math.PI * 2);
                    ctx.strokeStyle = historyHubHovered ? historyAccent : T.metalDim;
                    ctx.lineWidth = historyHubHovered ? 2 : 1;
                    ctx.stroke();
                    
                    // History hub text
                    if (stateRef.current.systemReady) {
                        const hovered = stateRef.current.hoveredHistoryNode;
                        const displayText = hovered ? hovered.label : 'HISTORY';
                        
                        ctx.fillStyle = historyHubHovered ? historyAccent : (hovered ? historyAccent : T.textSub);
                        ctx.font = historyHubHovered || hovered ? '600 9px Montserrat, Inter, sans-serif' : '400 9px Montserrat, Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(displayText, historyCenterX, historyCenterY + 3);
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // HISTORY NAVIGATION NODES (only visible when gear is hovered)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    stateRef.current.hoveredHistoryNode = null;
                    
                    if (historyOpacity > 0.01) {
                        historyNodes.forEach(node => {
                            const rad = node.angle * Math.PI / 180;
                            const nx = historyCenterX + Math.cos(rad) * historyOrbitRadius;
                            const ny = historyCenterY + Math.sin(rad) * historyOrbitRadius;
                            
                            const dist = Math.hypot(mouse.x - nx, mouse.y - ny);
                            const isHovered = dist < (historyNodeRadius + 4) && stateRef.current.systemReady && historyOpacity > 0.5;
                            const isActive = view === node.id;
                            
                            if (isHovered) {
                                stateRef.current.hoveredHistoryNode = node;
                                stateRef.current.targetHistoryAngle = node.angle + 90;
                            }
                            
                            ctx.globalAlpha = historyOpacity;
                            ctx.beginPath();
                            ctx.arc(nx, ny, historyNodeRadius, 0, Math.PI * 2);
                            
                            if (isActive) {
                                ctx.fillStyle = 'rgba(245, 158, 11, 0.15)';  // Amber for history
                                ctx.shadowColor = historyAccent;
                                ctx.shadowBlur = 12;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = historyAccent;
                                ctx.lineWidth = 2;
                                ctx.stroke();
                            } else if (isHovered) {
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                                ctx.shadowColor = 'rgba(245, 158, 11, 0.25)';
                                ctx.shadowBlur = 8;
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                ctx.strokeStyle = T.metalMid;
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            }
                            
                            const iconColor = isActive ? historyAccent : (isHovered ? historyAccent : T.metalMid);
                            const iconSize = 14;
                            drawIcon(ctx, icons[node.id], nx - iconSize/2, ny - iconSize/2, iconSize, iconColor);
                            
                            ctx.globalAlpha = 1;
                        });
                    }
                    
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // FOOTER - Fixed at bottom of sidebar
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    
                    // Date/Time Display
                    const currentTime = stateRef.current.currentTime;
                    const timeStr = currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = currentTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    ctx.fillStyle = T.textMain;
                    ctx.font = '600 14px Montserrat, Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(timeStr, sidebarWidth / 2, footerStartY);
                    
                    ctx.fillStyle = T.textSub;
                    ctx.font = '300 10px Montserrat, Inter, sans-serif';
                    ctx.fillText(dateStr + '  ‚Ä¢  Los Angeles  ‚Ä¢  72¬∞F', sidebarWidth / 2, footerStartY + 16);
                    
                    // Daily Digest Button
                    const digestY = footerStartY + 35;
                    const digestHovered = mouse.x >= 30 && mouse.x <= sidebarWidth - 30 &&
                                         mouse.y >= digestY && mouse.y <= digestY + 32;
                    
                    // Blue gradient background
                    const digestGrad = ctx.createLinearGradient(30, digestY, sidebarWidth - 30, digestY);
                    digestGrad.addColorStop(0, digestHovered ? '#2563eb' : '#1d4ed8');
                    digestGrad.addColorStop(1, digestHovered ? '#3b82f6' : '#2563eb');
                    
                    ctx.fillStyle = digestGrad;
                    ctx.beginPath();
                    ctx.roundRect(30, digestY, sidebarWidth - 60, 32, 8);
                    ctx.fill();
                    
                    if (digestHovered) {
                        ctx.shadowColor = '#3b82f6';
                        ctx.shadowBlur = 15;
                        ctx.fill();
                        ctx.shadowBlur = 0;
                    }
                    
                    // Mail icon
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.roundRect(sidebarWidth/2 - 50, digestY + 9, 14, 10, 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(sidebarWidth/2 - 50, digestY + 11);
                    ctx.lineTo(sidebarWidth/2 - 43, digestY + 16);
                    ctx.lineTo(sidebarWidth/2 - 36, digestY + 11);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '600 11px Inter, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText('Daily Digest', sidebarWidth/2 - 28, digestY + 20);
                    
                    // Action Buttons Row
                    const btnY = digestY + 45;
                    const btnWidth = (sidebarWidth - 80) / 2;
                    
                    // Reset Data button
                    const resetHovered = mouse.x >= 30 && mouse.x <= 30 + btnWidth &&
                                        mouse.y >= btnY && mouse.y <= btnY + 28;
                    
                    ctx.strokeStyle = resetHovered ? T.accent : T.metalDim;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.roundRect(30, btnY, btnWidth, 28, 4);
                    ctx.stroke();
                    if (resetHovered) {
                        ctx.fillStyle = 'rgba(56, 189, 248, 0.1)';
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = resetHovered ? T.accent : T.textSub;
                    ctx.font = '500 9px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Reset Data', 30 + btnWidth/2, btnY + 18);
                    
                    // Clear Logs button
                    const clearHovered = mouse.x >= 40 + btnWidth && mouse.x <= sidebarWidth - 30 &&
                                        mouse.y >= btnY && mouse.y <= btnY + 28;
                    
                    ctx.strokeStyle = clearHovered ? '#ef4444' : T.metalDim;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.roundRect(40 + btnWidth, btnY, btnWidth, 28, 4);
                    ctx.stroke();
                    if (clearHovered) {
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = clearHovered ? '#ef4444' : T.textSub;
                    ctx.font = '500 9px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Clear Logs', 40 + btnWidth + btnWidth/2, btnY + 18);
                    
                    // Logout Button
                    const logoutY = btnY + 38;
                    const logoutHovered = mouse.x >= 30 && mouse.x <= sidebarWidth - 30 &&
                                         mouse.y >= logoutY && mouse.y <= logoutY + 32;
                    
                    ctx.fillStyle = logoutHovered ? '#1e293b' : '#0f172a';
                    ctx.beginPath();
                    ctx.roundRect(30, logoutY, sidebarWidth - 60, 32, 6);
                    ctx.fill();
                    ctx.strokeStyle = logoutHovered ? T.accent : T.metalDim;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    ctx.fillStyle = logoutHovered ? T.accent : T.textSub;
                    ctx.font = '600 10px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('LOGOUT', sidebarWidth / 2, logoutY + 20);
                    
                    // Logo hover detection (the VECTOR MEDIA text area: roughly y=10 to y=60, centered)
                    const logoHovered = mouse.x > mainCenterX - 80 && mouse.x < mainCenterX + 80 && mouse.y > 10 && mouse.y < 60;
                    stateRef.current.hoveredLogo = logoHovered;
                    
                    // Store button hover states
                    stateRef.current.hoveredButton = null;
                    if (digestHovered) stateRef.current.hoveredButton = 'digest';
                    if (resetHovered) stateRef.current.hoveredButton = 'reset';
                    if (clearHovered) stateRef.current.hoveredButton = 'clear';
                    if (logoutHovered) stateRef.current.hoveredButton = 'logout';
                    
                    // Handle click
                    if (stateRef.current.mouse.clicked) {
                        // Secret logo click handler - 3 clicks to open hidden features
                        if (stateRef.current.hoveredLogo) {
                            stateRef.current.logoClickCount++;
                            
                            // Clear existing timer
                            if (stateRef.current.logoClickTimer) {
                                clearTimeout(stateRef.current.logoClickTimer);
                            }
                            
                            // Reset click count after 2 seconds of no clicks
                            stateRef.current.logoClickTimer = setTimeout(() => {
                                stateRef.current.logoClickCount = 0;
                            }, 2000);
                            
                            // Trigger on 3rd click - go to Update Stages (hidden admin feature)
                            if (stateRef.current.logoClickCount >= 3) {
                                stateRef.current.logoClickCount = 0;
                                // Navigate to Update Stages view
                                setView('master');
                            }
                        }
                        
                        if (stateRef.current.hoveredNode && stateRef.current.systemReady) {
                            setView(stateRef.current.hoveredNode.id);
                        }
                        if (stateRef.current.hoveredPipelineNode && stateRef.current.systemReady) {
                            setView(stateRef.current.hoveredPipelineNode.id);
                        }
                        if (stateRef.current.hoveredHistoryNode && stateRef.current.systemReady) {
                            const nodeId = stateRef.current.hoveredHistoryNode.id;
                            if (nodeId === 'impressions') {
                                // Trigger impressions modal
                                if (onOpenImpressions) onOpenImpressions();
                            } else {
                                setView(nodeId);
                            }
                        }
                        // Button click handlers
                        if (stateRef.current.hoveredButton === 'digest' && onOpenDigest) {
                            onOpenDigest();
                        }
                        if (stateRef.current.hoveredButton === 'reset' && onReset) {
                            onReset();
                        }
                        if (stateRef.current.hoveredButton === 'clear' && onResetEmailLogs) {
                            onResetEmailLogs();
                        }
                        if (stateRef.current.hoveredButton === 'logout' && onLogout) {
                            onLogout();
                        }
                        stateRef.current.mouse.clicked = false;
                    }
                    
                    animationRef.current = requestAnimationFrame(render);
                };
                
                // Resize handler
                const resize = () => {
                    canvas.width = 320;
                    canvas.height = window.innerHeight;
                };
                
                // Mouse handlers
                const handleMouseMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    stateRef.current.mouse.x = e.clientX - rect.left;
                    stateRef.current.mouse.y = e.clientY - rect.top;
                };
                
                const handleClick = () => {
                    stateRef.current.mouse.clicked = true;
                };
                
                resize();
                window.addEventListener('resize', resize);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('click', handleClick);
                
                animationRef.current = requestAnimationFrame(render);
                
                return () => {
                    window.removeEventListener('resize', resize);
                    canvas.removeEventListener('mousemove', handleMouseMove);
                    canvas.removeEventListener('click', handleClick);
                    if (animationRef.current) {
                        cancelAnimationFrame(animationRef.current);
                    }
                };
            }, [view, setView, onLogout, onOpenDigest, onReset, onResetEmailLogs, onOpenSheetSettings]);
            
            return (
                <canvas 
                    ref={canvasRef}
                    className="fixed left-0 top-0 z-20 hidden md:block"
                    style={{ width: 320, cursor: 'pointer' }}
                />
            );
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COLLAPSED MINI-BAR with Waterfall Cascade
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CollapsedMiniBar = ({ view, setView, onLogout }) => {
            const [pipelineExpanded, setPipelineExpanded] = useState(false);
            const [historyExpanded, setHistoryExpanded] = useState(false);
            
            const moduleItems = [
                { id: 'dashboard', icon: 'LayoutDashboard' },
                { id: 'holdReport', icon: 'ClipboardList' },
                { id: 'availability', icon: 'Calendar' },
                { id: 'riskAnalysis', icon: 'ShieldAlert' },
                { id: 'master', icon: 'Hammer' },
                { id: 'specialMedia', icon: 'Megaphone' },
                { id: 'popGallery', icon: 'Camera' },
                { id: 'materialReceivers', icon: 'Package' },
                { id: 'performanceReport', icon: 'FileText' },
            ];
            
            const pipelineItems = [
                { id: 'delayedFlights', icon: 'Flame' },
                { id: 'onHoldCampaigns', icon: 'Pause' },
                { id: 'inProgressFlights', icon: 'Rocket' },
                { id: 'fullyInstalledThisWeek', icon: 'Medal' },
                { id: 'rotations', icon: 'Repeat' },
                { id: 'thisWeek', icon: 'Calendar' },
                { id: 'upcoming', icon: 'Sun' },
                { id: 'materialReadyFuture', icon: 'Archive' },
                { id: 'nextMonth', icon: 'Clock' },
                { id: 'pipelineSummary', icon: 'BarChart' },
            ];
            
            const historyItems = [
                { id: 'expiredFlights', icon: 'Lightbulb' },
                { id: 'pastDue', icon: 'AlertTriangle' },
                { id: 'recentInstalls', icon: 'CheckSquare' },
                { id: 'history', icon: 'History' },
                { id: 'lostOpportunities', icon: 'XCircle' },
                { id: 'impressions', icon: 'MapPin' },
            ];
            
            const IconButton = ({ item, colorClass, bgClass, borderClass, hoverBorderClass, index = 0, isVisible = true }) => (
                <button
                    onClick={() => setView(item.id)}
                    className={`w-10 h-10 mb-1 rounded-xl flex items-center justify-center transition-all duration-300 ${
                        view === item.id 
                            ? `${bgClass} ${borderClass} shadow-lg` 
                            : `border border-slate-700 hover:${hoverBorderClass || 'border-slate-500'} hover:bg-slate-800/50`
                    }`}
                    style={{
                        opacity: isVisible ? 1 : 0,
                        transform: isVisible ? 'translateY(0) scale(1)' : 'translateY(-10px) scale(0.8)',
                        transitionDelay: isVisible ? `${index * 50}ms` : '0ms',
                    }}
                    title={item.id}
                >
                    <Icon 
                        name={item.icon} 
                        size={16} 
                        className={`transition-colors ${view === item.id ? colorClass : 'text-slate-500 group-hover:text-slate-300'}`}
                    />
                </button>
            );
            
            return (
                <div className="w-full h-full bg-gradient-to-b from-slate-800 to-slate-950 flex flex-col items-center py-3 overflow-y-auto hide-scrollbar">
                    {/* Modules Section - Always show all */}
                    <div className="text-cyan-400 text-[9px] font-bold mb-2 tracking-wider">MOD</div>
                    {moduleItems.map((item, i) => (
                        <IconButton 
                            key={item.id} 
                            item={item} 
                            colorClass="text-cyan-400"
                            bgClass="bg-cyan-500/20"
                            borderClass="border border-cyan-400"
                            hoverBorderClass="border-cyan-600"
                            isVisible={true}
                        />
                    ))}
                    
                    {/* Pipeline Section - Collapsible waterfall */}
                    <div className="w-10 border-t border-slate-700 my-2" />
                    <div 
                        className="text-purple-400 text-[9px] font-bold mb-2 cursor-pointer hover:text-purple-300 flex items-center gap-0.5 tracking-wider"
                        onMouseEnter={() => setPipelineExpanded(true)}
                        onMouseLeave={() => setPipelineExpanded(false)}
                    >
                        PIPE
                        <Icon name={pipelineExpanded ? 'ChevronUp' : 'ChevronDown'} size={9} />
                    </div>
                    
                    <div 
                        className="flex flex-col items-center"
                        onMouseEnter={() => setPipelineExpanded(true)}
                        onMouseLeave={() => setPipelineExpanded(false)}
                    >
                        {pipelineItems.map((item, i) => {
                            const showByDefault = i < 3;
                            const isVisible = showByDefault || pipelineExpanded;
                            
                            if (!showByDefault && !pipelineExpanded) return null;
                            
                            return (
                                <IconButton 
                                    key={item.id} 
                                    item={item} 
                                    colorClass="text-purple-400"
                                    bgClass="bg-purple-500/20"
                                    borderClass="border border-purple-400"
                                    hoverBorderClass="border-purple-600"
                                    index={i - 3}
                                    isVisible={isVisible}
                                />
                            );
                        })}
                        {!pipelineExpanded && (
                            <div className="text-slate-600 text-[8px] mt-1">+{pipelineItems.length - 3}</div>
                        )}
                    </div>
                    
                    {/* History Section - Collapsible waterfall */}
                    <div className="w-10 border-t border-slate-700 my-2" />
                    <div 
                        className="text-amber-400 text-[9px] font-bold mb-2 cursor-pointer hover:text-amber-300 flex items-center gap-0.5 tracking-wider"
                        onMouseEnter={() => setHistoryExpanded(true)}
                        onMouseLeave={() => setHistoryExpanded(false)}
                    >
                        HIST
                        <Icon name={historyExpanded ? 'ChevronUp' : 'ChevronDown'} size={9} />
                    </div>
                    
                    <div 
                        className="flex flex-col items-center"
                        onMouseEnter={() => setHistoryExpanded(true)}
                        onMouseLeave={() => setHistoryExpanded(false)}
                    >
                        {historyItems.map((item, i) => {
                            const showByDefault = i < 3;
                            const isVisible = showByDefault || historyExpanded;
                            
                            if (!showByDefault && !historyExpanded) return null;
                            
                            return (
                                <IconButton 
                                    key={item.id} 
                                    item={item} 
                                    colorClass="text-amber-400"
                                    bgClass="bg-amber-500/20"
                                    borderClass="border border-amber-400"
                                    hoverBorderClass="border-amber-600"
                                    index={i - 3}
                                    isVisible={isVisible}
                                />
                            );
                        })}
                        {!historyExpanded && (
                            <div className="text-slate-600 text-[8px] mt-1">+{historyItems.length - 3}</div>
                        )}
                    </div>
                    
                    <div className="flex-1" />
                    <button 
                        onClick={onLogout} 
                        className="w-10 h-10 mb-3 border border-slate-700 rounded-xl flex items-center justify-center text-slate-500 hover:text-red-400 hover:border-red-400 hover:bg-red-500/10 transition-colors"
                    >
                        <Icon name="LogOut" size={16} />
                    </button>
                </div>
            );
        };
        
        // Wrapper that handles collapse state
        const Sidebar = ({ view, setView, onReset, onOpenDigest, onOpenImpressions, onResetEmailLogs, onOpenSheetSettings, onLogout, ghostCount = 0, isCollapsed: externalCollapsed, setIsCollapsed: externalSetCollapsed }) => {
            const [internalCollapsed, setInternalCollapsed] = useState(false);
            const isCollapsed = externalCollapsed !== undefined ? externalCollapsed : internalCollapsed;
            const setIsCollapsed = externalSetCollapsed || setInternalCollapsed;
            
            return (
                <>
                    <div 
                        className={`fixed left-0 top-0 h-screen z-20 hidden md:block transition-all duration-500 ease-in-out overflow-hidden`}
                        style={{ width: isCollapsed ? 64 : 320 }}
                    >
                        {!isCollapsed && (
                            <CanvasGearSidebar 
                                view={view} 
                                setView={setView} 
                                onLogout={onLogout}
                                onOpenDigest={onOpenDigest}
                                onOpenImpressions={onOpenImpressions}
                                onReset={onReset}
                                onResetEmailLogs={onResetEmailLogs}
                                onOpenSheetSettings={onOpenSheetSettings}
                                isCollapsed={isCollapsed}
                                setIsCollapsed={setIsCollapsed}
                            />
                        )}
                        
                        {/* Collapsed mini-bar with waterfall cascade */}
                        {isCollapsed && (
                            <CollapsedMiniBar view={view} setView={setView} onLogout={onLogout} />
                        )}
                    </div>
                    
                    {/* Toggle button */}
                    <button
                        onClick={() => setIsCollapsed(!isCollapsed)}
                        className="fixed z-30 hidden md:flex items-center justify-center w-6 h-12 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-r-lg transition-all duration-300"
                        style={{ left: isCollapsed ? 64 : 320, top: '50%', transform: 'translateY(-50%)' }}
                    >
                        <Icon name={isCollapsed ? 'ChevronRight' : 'ChevronLeft'} size={14} className="text-slate-400" />
                    </button>
                </>
            );
        };

        // ============================================
        // PERFORMANCE REPORT COMPONENT - City Compliance
        // ============================================
        const PerformanceReport = ({ data: rawData, onBack, setView, showDemoTips = false }) => {
            const data = Array.isArray(rawData) ? rawData : [];
            
            const [dateRange, setDateRange] = useState({ 
                start: new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });
            const [selectedMarket, setSelectedMarket] = useState('ALL');
            const [reportType, setReportType] = useState('summary'); // 'summary', 'detailed', 'photos'
            const [showPrintView, setShowPrintView] = useState(false);

            // Filter data by date range and market
            const filteredData = useMemo(() => {
                return data.filter(d => {
                    // Only include installed/completed campaigns
                    const validStages = ['Installed', 'Photos Taken', 'POP Completed'];
                    if (!validStages.includes(d.stage)) return false;
                    
                    // Date filter
                    const campaignDate = d.dateObj || new Date(d.date);
                    if (dateRange.start && campaignDate < new Date(dateRange.start)) return false;
                    if (dateRange.end && campaignDate > new Date(dateRange.end)) return false;
                    
                    // Market filter
                    if (selectedMarket !== 'ALL' && d.market !== selectedMarket) return false;
                    
                    return true;
                });
            }, [data, dateRange, selectedMarket]);

            // Get unique markets
            const markets = useMemo(() => {
                const validStages = ['Installed', 'Photos Taken', 'POP Completed'];
                const installed = data.filter(d => validStages.includes(d.stage));
                return [...new Set(installed.map(d => d.market).filter(Boolean))].sort();
            }, [data]);

            // Calculate summary stats with impressions
            const stats = useMemo(() => {
                const totalCampaigns = filteredData.length;
                const totalUnits = filteredData.reduce((sum, d) => sum + (parseInt(d.quantity) || parseInt(d.totalQty) || 0), 0);
                
                // Calculate impressions (use existing impressions field or estimate)
                const calculateImpressions = (campaign) => {
                    if (campaign.impressions) return parseInt(campaign.impressions);
                    // Estimate based on media type and quantity
                    const dailyRates = {
                        'Transit Shelters': 15000, 'Bus Bench': 8000, 'Digital Screen': 45000,
                        'Billboard': 35000, 'Shelter': 12000, 'Urban Panel': 18000, 'Kiosk': 6000,
                        'Bus Wrap': 50000, 'Street Furniture': 10000, 'Digital Kiosk': 25000,
                        'Mall Display': 22000, 'Airport Display': 40000
                    };
                    const mediaType = campaign.product || campaign.media || '';
                    const rate = dailyRates[mediaType] || Object.values(dailyRates).find((v, i) => 
                        mediaType.toLowerCase().includes(Object.keys(dailyRates)[i]?.toLowerCase())
                    ) || 10000;
                    const qty = parseInt(campaign.quantity) || parseInt(campaign.totalQty) || 1;
                    const days = 28; // Default campaign duration
                    return Math.round(rate * qty * days);
                };
                
                const totalImpressions = filteredData.reduce((sum, d) => sum + calculateImpressions(d), 0);
                
                // By stage
                const byStage = {
                    installed: filteredData.filter(d => d.stage === 'Installed').length,
                    photosTaken: filteredData.filter(d => d.stage === 'Photos Taken').length,
                    popCompleted: filteredData.filter(d => d.stage === 'POP Completed').length
                };
                
                // By market (with impressions)
                const byMarket = {};
                filteredData.forEach(d => {
                    const market = d.market?.split(',')[0] || 'Unknown';
                    if (!byMarket[market]) {
                        byMarket[market] = { campaigns: 0, units: 0, photos: 0, popComplete: 0, impressions: 0 };
                    }
                    byMarket[market].campaigns++;
                    byMarket[market].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byMarket[market].impressions += calculateImpressions(d);
                    if (d.stage === 'Photos Taken' || d.stage === 'POP Completed') byMarket[market].photos++;
                    if (d.stage === 'POP Completed') byMarket[market].popComplete++;
                });
                
                // By advertiser (with impressions)
                const byAdvertiser = {};
                filteredData.forEach(d => {
                    const adv = d.advertiser || 'Unknown';
                    if (!byAdvertiser[adv]) {
                        byAdvertiser[adv] = { campaigns: 0, units: 0, products: new Set(), impressions: 0 };
                    }
                    byAdvertiser[adv].campaigns++;
                    byAdvertiser[adv].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byAdvertiser[adv].impressions += calculateImpressions(d);
                    if (d.product) byAdvertiser[adv].products.add(d.product);
                });
                
                // By product type (with impressions)
                const byProduct = {};
                filteredData.forEach(d => {
                    const prod = d.product?.split('-')[0] || 'Unknown';
                    if (!byProduct[prod]) {
                        byProduct[prod] = { campaigns: 0, units: 0, impressions: 0 };
                    }
                    byProduct[prod].campaigns++;
                    byProduct[prod].units += parseInt(d.quantity) || parseInt(d.totalQty) || 0;
                    byProduct[prod].impressions += calculateImpressions(d);
                });
                
                return { totalCampaigns, totalUnits, totalImpressions, byStage, byMarket, byAdvertiser, byProduct, calculateImpressions };
            }, [filteredData]);

            // Print function
            const handlePrint = () => {
                window.print();
            };

            // Export to CSV
            const handleExportCSV = () => {
                const headers = ['Campaign #', 'Advertiser', 'Campaign Name', 'Market', 'Product', 'Quantity', 'Impressions', 'Start Date', 'End Date', 'Status', 'Owner'];
                const rows = filteredData.map(d => [
                    d.campaignNumber || '',
                    d.advertiser || '',
                    d.campaign || '',
                    d.market || '',
                    d.product || '',
                    d.quantity || d.totalQty || '',
                    stats.calculateImpressions(d).toLocaleString(),
                    d.date || '',
                    d.endDate || '',
                    d.stage || '',
                    d.owner || ''
                ]);
                
                const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Performance_Report_${dateRange.start}_to_${dateRange.end}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className={`bg-white rounded-xl shadow-sm border border-gray-200 ${showPrintView ? 'print-view' : ''}`}>
                    {/* Header */}
                    <div className="px-6 py-4 border-b bg-gradient-to-r from-emerald-50 to-teal-50 flex justify-between items-center print:bg-white">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="p-1 hover:bg-emerald-200 rounded-full transition-colors print:hidden" title="Back">
                                <Icon name="ArrowLeft" size={20} className="text-emerald-600" />
                            </button>
                            <div>
                                <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                    <Icon name="FileText" size={20} className="text-emerald-600" />
                                    Performance Report
                                </h3>
                                <p className="text-sm text-gray-500">
                                    Installation proof with impression tracking for city compliance
                                    {data.length > 0 && <span className="ml-2 text-xs text-emerald-600">(üìã {filteredData.length} installations ‚Ä¢ üëÅ {(stats.totalImpressions / 1000000).toFixed(1)}M impressions)</span>}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 print:hidden">
                            <button 
                                onClick={() => setView && setView('popGallery')}
                                className="px-3 py-2 bg-indigo-100 border border-indigo-300 hover:bg-indigo-200 text-indigo-700 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="Camera" size={16} /> View POP Gallery
                            </button>
                            <button 
                                onClick={handleExportCSV}
                                className="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="Download" size={16} /> Export CSV
                            </button>
                            <button 
                                onClick={handlePrint}
                                className="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold flex items-center gap-2"
                            >
                                <Icon name="Printer" size={16} /> Print Report
                            </button>
                        </div>
                    </div>

                    {/* Demo Tips for Performance Report */}
                    {showDemoTips && (
                        <div className="px-6 py-3 bg-gradient-to-r from-emerald-50 to-teal-50 border-b print:hidden">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div className="bg-white/80 rounded-lg p-3 border border-emerald-200">
                                    <div className="font-bold text-emerald-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üèõÔ∏è</span> City Compliance
                                    </div>
                                    <div className="text-[10px] text-emerald-700">
                                        This report proves installations to city officials. Shows completion rates, unit counts, and market breakdowns.
                                    </div>
                                </div>
                                <div className="bg-white/80 rounded-lg p-3 border border-teal-200">
                                    <div className="font-bold text-teal-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üëÅÔ∏è</span> Impression Tracking
                                    </div>
                                    <div className="text-[10px] text-teal-700">
                                        Impressions calculated by media type √ó quantity √ó flight days. Digital screens = 45K/day, Billboards = 35K/day.
                                    </div>
                                </div>
                                <div className="bg-white/80 rounded-lg p-3 border border-cyan-200">
                                    <div className="font-bold text-cyan-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üñ®Ô∏è</span> Export Options
                                    </div>
                                    <div className="text-[10px] text-cyan-700">
                                        Print creates clean PDF for city. CSV includes impressions data for analysis in Excel.
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Filters */}
                    <div className="px-6 py-4 border-b bg-gray-50 print:hidden">
                        <div className="flex flex-wrap items-center gap-4">
                            {/* Date Range */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Report Period</label>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="date" 
                                        value={dateRange.start}
                                        onChange={e => setDateRange(prev => ({ ...prev, start: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                    <span className="text-gray-400">‚Üí</span>
                                    <input 
                                        type="date" 
                                        value={dateRange.end}
                                        onChange={e => setDateRange(prev => ({ ...prev, end: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                </div>
                            </div>

                            {/* Market Filter */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Market</label>
                                <select 
                                    value={selectedMarket}
                                    onChange={e => setSelectedMarket(e.target.value)}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white min-w-[180px]"
                                >
                                    <option value="ALL">All Markets ({markets.length})</option>
                                    {markets.map(m => (
                                        <option key={m} value={m}>{m.split(',')[0]}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Quick Date Presets */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Quick Select</label>
                                <div className="flex gap-1">
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setDate(start.getDate() - 7);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 7 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setMonth(start.getMonth() - 1);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 30 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const end = new Date();
                                            const start = new Date();
                                            start.setMonth(start.getMonth() - 3);
                                            setDateRange({ start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Last 90 Days
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const year = new Date().getFullYear();
                                            setDateRange({ start: `${year}-01-01`, end: new Date().toISOString().split('T')[0] });
                                        }}
                                        className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        YTD
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Print Header - Only visible when printing */}
                    <div className="hidden print:block px-6 py-4 border-b">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">Installation Performance Report</h1>
                                <p className="text-gray-600">Los Angeles STAP Operations</p>
                            </div>
                            <div className="text-right text-sm text-gray-600">
                                <p><strong>Report Period:</strong> {dateRange.start} to {dateRange.end}</p>
                                <p><strong>Generated:</strong> {new Date().toLocaleDateString()}</p>
                                <p><strong>Market:</strong> {selectedMarket === 'ALL' ? 'All Markets' : selectedMarket}</p>
                                <p><strong>Total Impressions:</strong> {stats.totalImpressions.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Summary</h4>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-emerald-700">{stats.totalCampaigns}</div>
                                <div className="text-sm text-emerald-600 font-medium">Total Campaigns</div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-blue-700">{stats.totalUnits.toLocaleString()}</div>
                                <div className="text-sm text-blue-600 font-medium">Total Units Installed</div>
                            </div>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-center">
                                <div className="text-2xl font-bold text-amber-700">{(stats.totalImpressions / 1000000).toFixed(1)}M</div>
                                <div className="text-sm text-amber-600 font-medium">Total Impressions</div>
                                <div className="text-[10px] text-amber-500 mt-0.5">{stats.totalImpressions.toLocaleString()} views</div>
                            </div>
                            <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-purple-700">{stats.byStage.photosTaken + stats.byStage.popCompleted}</div>
                                <div className="text-sm text-purple-600 font-medium">Photos Documented</div>
                            </div>
                            <div className="bg-teal-50 border border-teal-200 rounded-lg p-4 text-center">
                                <div className="text-3xl font-bold text-teal-700">{stats.byStage.popCompleted}</div>
                                <div className="text-sm text-teal-600 font-medium">POP Completed</div>
                            </div>
                        </div>
                    </div>

                    {/* By Market Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Market</h4>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-3 font-semibold">Market</th>
                                        <th className="text-center p-3 font-semibold">Campaigns</th>
                                        <th className="text-center p-3 font-semibold">Units</th>
                                        <th className="text-center p-3 font-semibold">Impressions</th>
                                        <th className="text-center p-3 font-semibold">Photos Taken</th>
                                        <th className="text-center p-3 font-semibold">POP Complete</th>
                                        <th className="text-center p-3 font-semibold">Completion %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(stats.byMarket).sort((a, b) => b[1].impressions - a[1].impressions).map(([market, data]) => (
                                        <tr key={market} className="border-b hover:bg-gray-50">
                                            <td className="p-3 font-medium">{market}</td>
                                            <td className="p-3 text-center">{data.campaigns}</td>
                                            <td className="p-3 text-center font-bold">{data.units.toLocaleString()}</td>
                                            <td className="p-3 text-center">
                                                <span className="text-amber-700 font-medium">{(data.impressions / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-3 text-center">{data.photos}</td>
                                            <td className="p-3 text-center">{data.popComplete}</td>
                                            <td className="p-3 text-center">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    data.campaigns > 0 && data.popComplete / data.campaigns >= 0.9 ? 'bg-green-100 text-green-700' :
                                                    data.campaigns > 0 && data.popComplete / data.campaigns >= 0.5 ? 'bg-yellow-100 text-yellow-700' :
                                                    'bg-red-100 text-red-700'
                                                }`}>
                                                    {data.campaigns > 0 ? Math.round((data.popComplete / data.campaigns) * 100) : 0}%
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-100 font-bold">
                                    <tr>
                                        <td className="p-3">TOTAL</td>
                                        <td className="p-3 text-center">{stats.totalCampaigns}</td>
                                        <td className="p-3 text-center">{stats.totalUnits.toLocaleString()}</td>
                                        <td className="p-3 text-center text-amber-700">{(stats.totalImpressions / 1000000).toFixed(1)}M</td>
                                        <td className="p-3 text-center">{stats.byStage.photosTaken + stats.byStage.popCompleted}</td>
                                        <td className="p-3 text-center">{stats.byStage.popCompleted}</td>
                                        <td className="p-3 text-center">
                                            {stats.totalCampaigns > 0 ? Math.round((stats.byStage.popCompleted / stats.totalCampaigns) * 100) : 0}%
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* By Advertiser Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Advertiser ({Object.keys(stats.byAdvertiser).length})</h4>
                        <div className="overflow-x-auto max-h-[350px] overflow-y-auto">
                            <table className="w-full text-sm">
                                <thead className="sticky top-0 bg-white z-10">
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-3 font-semibold">Advertiser</th>
                                        <th className="text-center p-3 font-semibold">Campaigns</th>
                                        <th className="text-center p-3 font-semibold">Units</th>
                                        <th className="text-center p-3 font-semibold">Impressions</th>
                                        <th className="text-left p-3 font-semibold">Products</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(stats.byAdvertiser).sort((a, b) => b[1].impressions - a[1].impressions).map(([advertiser, data]) => (
                                        <tr key={advertiser} className="border-b hover:bg-gray-50">
                                            <td className="p-3 font-medium">{advertiser}</td>
                                            <td className="p-3 text-center">{data.campaigns}</td>
                                            <td className="p-3 text-center font-bold">{data.units.toLocaleString()}</td>
                                            <td className="p-3 text-center">
                                                <span className="text-amber-700 font-medium">{(data.impressions / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-3 text-xs text-gray-600">{[...data.products].slice(0, 2).join(', ')}{data.products.size > 2 ? ` +${data.products.size - 2} more` : ''}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* By Product Type Breakdown */}
                    <div className="px-6 py-4 border-b">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">By Product Type</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {Object.entries(stats.byProduct).sort((a, b) => b[1].impressions - a[1].impressions).map(([product, data]) => (
                                <div key={product} className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                    <div className="text-lg font-bold text-gray-800">{data.units.toLocaleString()}</div>
                                    <div className="text-xs text-gray-600">{product}</div>
                                    <div className="text-[10px] text-gray-400">{data.campaigns} campaigns</div>
                                    <div className="text-[10px] text-amber-600 font-medium mt-1">üëÅ {(data.impressions / 1000).toFixed(0)}K impressions</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Detailed Campaign List */}
                    <div className="px-6 py-4">
                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Campaign Details ({filteredData.length})</h4>
                        <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table className="w-full text-sm">
                                <thead className="sticky top-0 bg-white z-10">
                                    <tr className="bg-gray-50">
                                        <th className="text-left p-2 font-semibold text-xs">Campaign #</th>
                                        <th className="text-left p-2 font-semibold text-xs">Advertiser</th>
                                        <th className="text-left p-2 font-semibold text-xs">Market</th>
                                        <th className="text-left p-2 font-semibold text-xs">Product</th>
                                        <th className="text-center p-2 font-semibold text-xs">Qty</th>
                                        <th className="text-center p-2 font-semibold text-xs">Impressions</th>
                                        <th className="text-center p-2 font-semibold text-xs">Start</th>
                                        <th className="text-center p-2 font-semibold text-xs">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.map((d, idx) => (
                                        <tr key={idx} className="border-b hover:bg-gray-50 text-xs">
                                            <td className="p-2 font-mono">{d.campaignNumber}</td>
                                            <td className="p-2">{d.advertiser}</td>
                                            <td className="p-2 text-gray-600">{d.market?.split(',')[0]}</td>
                                            <td className="p-2 text-gray-600">{d.product?.split('-').slice(0, 2).join('-')}</td>
                                            <td className="p-2 text-center font-bold">{d.quantity || d.totalQty}</td>
                                            <td className="p-2 text-center">
                                                <span className="text-amber-700 font-medium">{(stats.calculateImpressions(d) / 1000).toFixed(0)}K</span>
                                            </td>
                                            <td className="p-2 text-center text-gray-500">{d.date}</td>
                                            <td className="p-2 text-center">
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold ${
                                                    d.stage === 'POP Completed' ? 'bg-blue-100 text-blue-700' :
                                                    d.stage === 'Photos Taken' ? 'bg-purple-100 text-purple-700' :
                                                    'bg-green-100 text-green-700'
                                                }`}>
                                                    {d.stage === 'POP Completed' ? '‚úì POP' : d.stage}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="px-6 py-4 bg-gray-50 border-t text-center text-xs text-gray-500">
                        <p>Report generated by LA STAP Operations Hub ‚Ä¢ {new Date().toLocaleString()}</p>
                        <p className="mt-1">This report is for city compliance verification purposes.</p>
                    </div>

                    {/* Print Styles */}
                    <style>{`
                        @media print {
                            body * { visibility: hidden; }
                            .print-view, .print-view * { visibility: visible; }
                            .print-view { position: absolute; left: 0; top: 0; width: 100%; }
                            .print\\:hidden { display: none !important; }
                            .print\\:block { display: block !important; }
                            .print\\:bg-white { background: white !important; }
                        }
                    `}</style>
                </div>
            );
        };

        // ============================================
        // POP GALLERY COMPONENT - Proof of Performance
        // ============================================
        // ============================================
        // MATERIAL RECEIVERS COMPONENT - Shipment Tracking
        // ============================================
        const MaterialReceivers = ({ data: rawData, onBack, setView, showDemoTips = false, setIsLiveMode, materials, setMaterials, linkedSheet, setLinkedSheet }) => {
            const data = Array.isArray(rawData) ? rawData : [];
            
            // State
            const [viewMode, setViewMode] = useState('cards'); // 'cards', 'list', 'timeline'
            const [selectedClient, setSelectedClient] = useState('ALL');
            const [selectedStatus, setSelectedStatus] = useState('ALL');
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedReceipt, setSelectedReceipt] = useState(null);
            // materials and linkedSheet are now passed as props from parent
            const [showAnalytics, setShowAnalytics] = useState(false); // Start collapsed for better fit
            const [showLinkModal, setShowLinkModal] = useState(false);
            const [sheetUrl, setSheetUrl] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [connectionError, setConnectionError] = useState('');
            const [lastSync, setLastSync] = useState(null);
            
            // Inline Editing State
            const [editingCell, setEditingCell] = useState(null); // { id, field }
            const [editValue, setEditValue] = useState('');
            
            // Campaign Assignment State (for PDF import)
            const [showCampaignAssign, setShowCampaignAssign] = useState(false);
            const [pendingPdfResults, setPendingPdfResults] = useState([]);
            const [campaignSearchTerm, setCampaignSearchTerm] = useState('');
            
            // PDF Upload State
            const [pdfProcessing, setPdfProcessing] = useState(false);
            const [pdfProgress, setPdfProgress] = useState('');
            const [pdfResults, setPdfResults] = useState([]);
            
            // Google Apps Script Webhook State (for bidirectional sync)
            const [webhookUrl, setWebhookUrl] = useState(localStorage.getItem('stap_material_webhook') || '');
            const [webhookSending, setWebhookSending] = useState(false);
            const [webhookStatus, setWebhookStatus] = useState('');
            const [showWebhookSetup, setShowWebhookSetup] = useState(false);
            
            // Column mapping for Google Sheet
            const [columnMapping, setColumnMapping] = useState({
                receiptNumber: 'Receipt #',
                dateReceived: 'Date',
                description: 'Description',
                posterCode: 'Poster Code',
                client: 'Client',
                printer: 'Printer',
                quantity: 'Qty',
                boxes: 'Boxes',
                designs: 'Designs',
                comments: 'Comments',
                status: 'Status',
                warehouseLocation: 'Location'
            });
            
            // AUTO-SYNC: Check master tracker for installed campaigns and update material status
            useEffect(() => {
                if (!data || data.length === 0 || !materials || materials.length === 0) return;
                
                let hasChanges = false;
                const updatedMaterials = materials.map(material => {
                    // Skip if no campaign linked or already installed
                    if (!material.campaignId || material.status === 'Installed') return material;
                    
                    // Find linked campaign in master tracker
                    const linkedCampaign = data.find(c => 
                        (c['Campaign ID'] || c.id) === material.campaignId
                    );
                    
                    if (linkedCampaign) {
                        const stage = (linkedCampaign['Install Stage'] || '').toLowerCase();
                        
                        // Auto-update to Installed if campaign is installed
                        if (stage.includes('installed') || stage.includes('photos taken') || stage.includes('pop complete')) {
                            hasChanges = true;
                            console.log(`üì¶ Auto-updating material ${material.receiptNumber} to Installed (campaign ${material.campaignId} is ${stage})`);
                            return { ...material, status: 'Installed' };
                        }
                        
                        // Auto-update to Fully Deployed if campaign is material ready
                        if (stage.includes('material ready') && material.status !== 'Fully Deployed' && material.status !== 'Installed') {
                            hasChanges = true;
                            return { ...material, status: 'Fully Deployed' };
                        }
                    }
                    
                    return material;
                });
                
                if (hasChanges) {
                    setMaterials(updatedMaterials);
                }
            }, [data]); // Re-run when master tracker data changes
            
            // Save webhook URL to localStorage
            const saveWebhookUrl = (url) => {
                setWebhookUrl(url);
                localStorage.setItem('stap_material_webhook', url);
            };
            
            // Send data to Google Apps Script webhook
            const sendToGoogleSheet = async (dataToSend) => {
                if (!webhookUrl) {
                    setWebhookStatus('‚ö†Ô∏è No webhook URL configured');
                    return false;
                }
                
                setWebhookSending(true);
                setWebhookStatus('Sending to Google Sheet...');
                
                try {
                    const payload = {
                        action: 'append',
                        data: dataToSend.map(item => ({
                            receiptNumber: item.receiptNumber || '',
                            dateReceived: item.dateReceived instanceof Date 
                                ? item.dateReceived.toLocaleDateString() 
                                : item.dateReceived || new Date().toLocaleDateString(),
                            client: item.client || item.advertiser || '',
                            description: item.description || '',
                            posterCode: item.posterCode || '',
                            quantity: item.quantity || 0,
                            printer: item.printer || '',
                            status: item.status || 'Received',
                            comments: item.comments || '',
                            thumbnailUrl: item.posterImage || '',
                            pdfSource: item.pdfSource || '',
                            timestamp: new Date().toISOString()
                        }))
                    };
                    
                    console.log('üì§ Sending to webhook:', webhookUrl);
                    console.log('üì¶ Payload:', payload);
                    
                    await fetch(webhookUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    setWebhookStatus(`‚úÖ Sent ${dataToSend.length} item(s) to Google Sheet!`);
                    return true;
                    
                } catch (err) {
                    console.error('Webhook error:', err);
                    setWebhookStatus(`‚ùå Error: ${err.message}`);
                    return false;
                } finally {
                    setWebhookSending(false);
                }
            };

            // ============================================
            // INLINE CELL EDITING
            // ============================================
            const startEditing = (id, field, currentValue) => {
                setEditingCell({ id, field });
                setEditValue(currentValue || '');
            };
            
            const saveEdit = async () => {
                if (!editingCell) return;
                
                const { id, field } = editingCell;
                const newValue = field === 'quantity' ? parseInt(editValue) || 0 : editValue;
                
                // Update local state
                setMaterials(prev => prev.map(m => 
                    m.id === id ? { ...m, [field]: newValue } : m
                ));
                
                // Sync to Google Sheet if webhook configured
                if (webhookUrl) {
                    try {
                        const material = materials.find(m => m.id === id);
                        if (material) {
                            const updatedMaterial = { ...material, [field]: newValue };
                            await fetch(webhookUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'update',
                                    receiptNumber: updatedMaterial.receiptNumber,
                                    field: field,
                                    value: newValue,
                                    data: [{
                                        receiptNumber: updatedMaterial.receiptNumber,
                                        dateReceived: updatedMaterial.dateReceived,
                                        client: updatedMaterial.client,
                                        description: updatedMaterial.description,
                                        posterCode: updatedMaterial.posterCode,
                                        quantity: updatedMaterial.quantity,
                                        printer: updatedMaterial.printer,
                                        status: updatedMaterial.status,
                                        comments: updatedMaterial.comments || '',
                                        thumbnailUrl: updatedMaterial.posterImage || '',
                                        pdfSource: updatedMaterial.pdfSource || '',
                                        timestamp: new Date().toISOString()
                                    }]
                                })
                            });
                            console.log('‚úÖ Synced edit to Google Sheet');
                        }
                    } catch (err) {
                        console.error('Failed to sync edit:', err);
                    }
                }
                
                setEditingCell(null);
                setEditValue('');
            };
            
            const cancelEdit = () => {
                setEditingCell(null);
                setEditValue('');
            };
            
            // Editable Cell Component
            const EditableCell = ({ material, field, className = '', type = 'text' }) => {
                const isEditing = editingCell?.id === material.id && editingCell?.field === field;
                const value = material[field];
                
                if (isEditing) {
                    return (
                        <input
                            type={type}
                            value={editValue}
                            onChange={(e) => setEditValue(e.target.value)}
                            onBlur={saveEdit}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') saveEdit();
                                if (e.key === 'Escape') cancelEdit();
                            }}
                            className={`w-full px-2 py-1 border-2 border-orange-400 rounded focus:outline-none focus:ring-2 focus:ring-orange-300 ${className}`}
                            autoFocus
                        />
                    );
                }
                
                return (
                    <span 
                        onClick={(e) => {
                            e.stopPropagation();
                            startEditing(material.id, field, value);
                        }}
                        className={`cursor-pointer hover:bg-orange-100 px-2 py-1 rounded block ${className}`}
                        title="Click to edit"
                    >
                        {value || '-'}
                    </span>
                );
            };

            // ============================================
            // PDF UPLOAD & PARSING
            // ============================================
            const handlePdfUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                
                setPdfProcessing(true);
                setPdfProgress('Starting PDF processing...');
                setConnectionError('');
                
                const results = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    setPdfProgress(`Processing ${file.name} (${i + 1}/${files.length})...`);
                    
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        
                        // Get first page for thumbnail
                        const page = await pdf.getPage(1);
                        const scale = 0.5;
                        const viewport = page.getViewport({ scale });
                        
                        // Create canvas for thumbnail
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        await page.render({ canvasContext: context, viewport }).promise;
                        const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Extract text from all pages
                        let fullText = '';
                        for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 3); pageNum++) {
                            const textPage = await pdf.getPage(pageNum);
                            const textContent = await textPage.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + ' ';
                        }
                        
                        // Parse extracted text for material data
                        const parsed = parsePdfText(fullText, file.name, thumbnailUrl);
                        results.push(parsed);
                        
                    } catch (err) {
                        console.error(`Error processing ${file.name}:`, err);
                        results.push({
                            id: `PDF-ERR-${i}`,
                            receiptNumber: file.name.replace('.pdf', ''),
                            description: `Error: ${err.message}`,
                            status: 'Error',
                            posterImage: null,
                            error: true
                        });
                    }
                }
                
                setPdfResults(results);
                setPdfProgress(`Processed ${results.length} PDF(s). Review and import below.`);
                setPdfProcessing(false);
            };
            
            // Parse PDF text to extract material data
            const parsePdfText = (text, fileName, thumbnailUrl) => {
                const upperText = text.toUpperCase();
                
                // Try to extract receipt/invoice number
                let receiptNumber = '';
                const invMatch = text.match(/(?:INV|INVOICE|RECEIPT|PO|ORDER)[#:\s\-]*([A-Z0-9\-]+)/i);
                if (invMatch) {
                    receiptNumber = invMatch[1].trim();
                } else {
                    // Try filename
                    const fileMatch = fileName.match(/(\d{5,})/);
                    receiptNumber = fileMatch ? `INV-${fileMatch[1]}` : `INV-${Date.now().toString().slice(-6)}`;
                }
                
                // Extract date - look for common date formats
                let dateReceived = new Date().toLocaleDateString();
                const datePatterns = [
                    /(\d{1,2}\/\d{1,2}\/\d{2,4})/,
                    /(\d{4}-\d{2}-\d{2})/,
                    /(?:DATE|RECEIVED)[:\s]*(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})/i
                ];
                for (const pattern of datePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        dateReceived = match[1];
                        break;
                    }
                }
                
                // Look for client/advertiser name
                const commonClients = ['NETFLIX', 'NIKE', 'APPLE', 'AMAZON', 'DISNEY', 'WARNER', 'PARAMOUNT', 'UNIVERSAL', 'SONY', 'HBO', 'HULU', 'GOOGLE', 'META', 'FACEBOOK', 'MICROSOFT'];
                let client = '';
                for (const c of commonClients) {
                    if (upperText.includes(c)) {
                        client = c;
                        break;
                    }
                }
                if (!client) {
                    const clientMatch = text.match(/(?:CLIENT|CUSTOMER|ADVERTISER|BILL TO)[:\s]*([A-Za-z][A-Za-z\s&]+)/i);
                    client = clientMatch ? clientMatch[1].trim().substring(0, 30) : 'Unknown Client';
                }
                
                // Extract quantity - look for total or qty
                let quantity = 1;
                const qtyMatch = text.match(/(?:TOTAL\s*(?:QUANTITY|QTY)?|QTY|QUANTITY)[:\s]*(\d+)/i);
                if (qtyMatch) {
                    quantity = parseInt(qtyMatch[1]) || 1;
                }
                
                // Extract description - keep it short
                let description = 'Material Receipt';
                const descMatch = text.match(/(?:DESCRIPTION|ITEM|PRODUCT|MATERIAL)[:\s]*([^\n]{5,50})/i);
                if (descMatch) {
                    description = descMatch[1].trim();
                } else {
                    // Use campaign name if found
                    const campaignMatch = text.match(/(?:CAMPAIGN)[:\s]*([^\n]{5,40})/i);
                    if (campaignMatch) {
                        description = campaignMatch[1].trim();
                    }
                }
                
                // Extract printer/vendor
                let printer = '';
                const printerMatch = text.match(/(?:PRINTER|VENDOR|FROM|SHIP FROM|CIRCLE|VENDOR)[:\s]*([A-Za-z][A-Za-z\s&]+)/i);
                if (printerMatch) {
                    printer = printerMatch[1].trim().substring(0, 30);
                }
                if (!printer && upperText.includes('CIRCLE GRAPHICS')) {
                    printer = 'Circle Graphics';
                }
                
                // Extract poster code if different from receipt
                let posterCode = receiptNumber;
                const codeMatch = text.match(/(?:POSTER\s*CODE|CODE|SKU)[:\s]*([A-Z0-9\-]+)/i);
                if (codeMatch) {
                    posterCode = codeMatch[1].trim();
                }
                
                return {
                    id: `PDF-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    receiptNumber: receiptNumber,
                    dateReceived: dateReceived,
                    description: description,
                    posterCode: posterCode,
                    client: client,
                    advertiser: client,
                    printer: printer || 'Unknown Vendor',
                    quantity: quantity,
                    boxes: 1,
                    designs: 1,
                    comments: `Imported from: ${fileName}`,
                    status: 'Received',
                    warehouseLocation: '',
                    posterImage: thumbnailUrl,
                    pdfSource: fileName
                };
            };
            
            // Import parsed PDFs to materials
            const handleImportPdfResults = async () => {
                const validResults = pdfResults.filter(r => !r.error);
                if (validResults.length === 0) return;
                
                // First, try to send to Google Sheet if webhook is configured
                if (webhookUrl) {
                    const sent = await sendToGoogleSheet(validResults);
                    if (sent) {
                        console.log('‚úÖ Data saved to Google Sheet');
                    }
                }
                
                // Then add to local state
                setMaterials(prev => [...validResults, ...(prev || [])]);
                setLinkedSheet({ name: `${validResults.length} PDF(s)`, type: 'pdf-import' });
                setLastSync(new Date());
                setPdfResults([]);
                setShowLinkModal(false);
                if (setIsLiveMode) setIsLiveMode(true);
            };

            // Google Apps Script template
            const getAppsScriptCode = () => `// ========================================
// STAP Material Receiver - Auto Sync Script
// ========================================
// SETUP INSTRUCTIONS:
// 1. Open your Google Sheet for Material Receivers
// 2. Go to Extensions ‚Üí Apps Script
// 3. Delete any existing code, paste this entire script
// 4. Click Deploy ‚Üí New deployment
// 5. Type: "Web app"
// 6. Execute as: "Me" 
// 7. Who has access: "Anyone"
// 8. Click Deploy, authorize, copy the URL
// 9. Paste URL into STAP Portal webhook field
// ========================================

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // Create headers if sheet is empty
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'Receipt #', 'Date Received', 'Client', 'Description', 
        'Poster Code', 'Quantity', 'Printer', 'Status', 
        'Comments', 'Thumbnail URL', 'PDF Source', 'Imported At'
      ]);
      // Format header row
      sheet.getRange(1, 1, 1, 12).setFontWeight('bold').setBackground('#4285f4').setFontColor('white');
    }
    
    // Append data rows
    if (data.action === 'append' && data.data) {
      data.data.forEach(item => {
        sheet.appendRow([
          item.receiptNumber,
          item.dateReceived,
          item.client,
          item.description,
          item.posterCode,
          item.quantity,
          item.printer,
          item.status,
          item.comments,
          item.thumbnailUrl,
          item.pdfSource,
          item.timestamp
        ]);
      });
    }
    
    return ContentService.createTextOutput(JSON.stringify({ 
      success: true, 
      rows: data.data?.length || 0 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({ 
    status: 'STAP Material Webhook Active',
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}`;

            // Webhook Setup Modal
            const WebhookSetupModal = () => {
                if (!showWebhookSetup) return null;
                
                const [localUrl, setLocalUrl] = useState(webhookUrl);
                const [copied, setCopied] = useState(false);
                const [testStatus, setTestStatus] = useState('');
                
                const copyCode = () => {
                    navigator.clipboard.writeText(getAppsScriptCode());
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                };
                
                const handleSave = () => {
                    saveWebhookUrl(localUrl);
                    setShowWebhookSetup(false);
                };
                
                const testWebhook = async () => {
                    if (!localUrl) return;
                    setTestStatus('Testing...');
                    try {
                        await fetch(localUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'test', data: [] })
                        });
                        setTestStatus('‚úÖ Request sent! Check your Google Sheet.');
                    } catch (err) {
                        setTestStatus('‚ùå Error: ' + err.message);
                    }
                };
                
                return (
                    <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" onClick={() => setShowWebhookSetup(false)}>
                        <div className="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
                            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                                <div className="text-white">
                                    <h3 className="text-xl font-bold flex items-center gap-2">
                                        <Icon name="Zap" size={24} /> Setup Google Sheet Auto-Sync
                                    </h3>
                                    <p className="text-blue-100 text-sm">PDF uploads will automatically save to your Google Sheet</p>
                                </div>
                                <button onClick={() => setShowWebhookSetup(false)} className="text-white/80 hover:text-white p-2">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>
                            
                            <div className="p-6 space-y-6">
                                {/* How it works */}
                                <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
                                    <h4 className="font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <Icon name="RefreshCw" size={18} /> How Bidirectional Sync Works
                                    </h4>
                                    <div className="text-sm text-green-700 space-y-1">
                                        <p>üì§ <strong>Upload PDFs</strong> ‚Üí Data auto-saves to your Google Sheet</p>
                                        <p>üì• <strong>Open app</strong> ‚Üí Data auto-loads from your Published Sheet URL</p>
                                        <p>‚úèÔ∏è <strong>Edit in Sheet</strong> ‚Üí Changes appear when you refresh the app</p>
                                    </div>
                                </div>
                                
                                {/* Step 1: Copy Script */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
                                        Copy the Google Apps Script
                                    </h4>
                                    <div className="relative">
                                        <pre className="bg-gray-900 text-green-400 p-4 rounded-lg text-[10px] overflow-auto max-h-40 font-mono leading-relaxed">
                                            {getAppsScriptCode()}
                                        </pre>
                                        <button 
                                            onClick={copyCode}
                                            className={`absolute top-2 right-2 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-all ${
                                                copied ? 'bg-green-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'
                                            }`}
                                        >
                                            <Icon name={copied ? "Check" : "Copy"} size={14} />
                                            {copied ? 'Copied!' : 'Copy Code'}
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Step 2: Deploy */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
                                        Deploy in Google Sheets
                                    </h4>
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-800">
                                        <ol className="list-decimal list-inside space-y-1">
                                            <li>Open your Material Receiver Google Sheet</li>
                                            <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                                            <li>Delete existing code, paste the copied script</li>
                                            <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                                            <li>Select type: <strong>Web app</strong></li>
                                            <li>Set "Who has access" to <strong>Anyone</strong></li>
                                            <li>Click <strong>Deploy</strong> and authorize</li>
                                            <li>Copy the deployment URL</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                {/* Step 3: Paste URL */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
                                        Paste Your Webhook URL
                                    </h4>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text"
                                            placeholder="https://script.google.com/macros/s/.../exec"
                                            value={localUrl}
                                            onChange={e => setLocalUrl(e.target.value)}
                                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm font-mono"
                                        />
                                        <button 
                                            onClick={testWebhook}
                                            disabled={!localUrl}
                                            className="px-4 py-2 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 text-gray-700 rounded-lg text-sm font-medium"
                                        >
                                            Test
                                        </button>
                                    </div>
                                    {testStatus && (
                                        <p className={`mt-2 text-sm ${testStatus.includes('‚úÖ') ? 'text-green-600' : testStatus.includes('‚ùå') ? 'text-red-600' : 'text-gray-600'}`}>
                                            {testStatus}
                                        </p>
                                    )}
                                </div>
                                
                                {/* Reminder about Published URL */}
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h5 className="font-bold text-blue-800 text-sm mb-1">üìã Don't forget!</h5>
                                    <p className="text-sm text-blue-700">
                                        Also publish your sheet as CSV (<strong>File ‚Üí Share ‚Üí Publish to web ‚Üí CSV</strong>) 
                                        and paste that URL in Option 1 above. This lets the app READ data back from your sheet.
                                    </p>
                                </div>
                            </div>
                            
                            <div className="px-6 py-4 bg-gray-50 border-t flex justify-between items-center sticky bottom-0">
                                <div className="text-xs text-gray-500">
                                    {webhookUrl ? '‚úÖ Webhook configured' : '‚ö†Ô∏è No webhook configured yet'}
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowWebhookSetup(false)}
                                        className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium text-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={handleSave}
                                        disabled={!localUrl}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-lg font-medium text-sm flex items-center gap-2"
                                    >
                                        <Icon name="Check" size={16} /> Save Webhook URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Convert Google Drive link to embeddable image URL
            const convertDriveLink = (url) => {
                if (!url) return null;
                url = url.trim();
                
                // Already a direct image URL
                if (url.match(/\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i)) return url;
                
                // Google Drive file link: https://drive.google.com/file/d/FILE_ID/view or /FILE_ID/FILENAME
                let match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match) {
                    return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
                }
                
                // Google Drive open link: https://drive.google.com/open?id=FILE_ID
                match = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
                if (match) {
                    return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
                }
                
                // Google Drive direct export: https://drive.google.com/uc?id=FILE_ID&export=download
                match = url.match(/drive\.google\.com\/uc\?.*id=([a-zA-Z0-9_-]+)/);
                if (match) {
                    return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
                }
                
                // Google Drive uc link (already embeddable)
                if (url.includes('drive.google.com/uc')) return url;
                
                // Google Drive thumbnail link
                if (url.includes('drive.google.com/thumbnail')) return url;
                
                // Google Photos sharing link
                match = url.match(/photos\.google\.com.*\/([a-zA-Z0-9_-]+)/);
                if (match) {
                    // Google Photos doesn't allow easy embedding, return as-is
                    return url;
                }
                
                // Dropbox link conversion
                if (url.includes('dropbox.com')) {
                    return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '');
                }
                
                // OneDrive/SharePoint link (limited support)
                if (url.includes('1drv.ms') || url.includes('onedrive.live.com')) {
                    return url;
                }
                
                // iCloud link (not easily embeddable)
                if (url.includes('icloud.com')) {
                    return url;
                }
                
                // Fallback - return as is (might be a direct URL)
                return url;
            };
            
            // Check if a string looks like a cloud storage or image URL
            const isGoogleDriveUrl = (str) => {
                if (!str || typeof str !== 'string') return false;
                return str.includes('drive.google.com') || 
                       str.includes('docs.google.com') ||
                       str.includes('photos.google.com') ||
                       str.includes('dropbox.com') ||
                       str.includes('1drv.ms') ||
                       str.includes('onedrive.live.com') ||
                       str.includes('icloud.com') ||
                       str.match(/\.(jpg|jpeg|png|gif|webp)$/i);
            };

            // Parse Google Sheet data
            const parseSheetData = (rows, headers) => {
                const headerMap = {};
                let driveUrlColumnIndex = -1;
                
                headers.forEach((h, i) => {
                    const headerLower = h.toLowerCase().trim();
                    // Auto-detect columns
                    if (headerLower.includes('receipt') || headerLower === 'inv' || headerLower === 'id') headerMap.receiptNumber = i;
                    if (headerLower.includes('date') || headerLower.includes('received') || headerLower.includes('transaction')) headerMap.dateReceived = i;
                    if (headerLower.includes('desc') || headerLower.includes('material') || headerLower.includes('name')) headerMap.description = i;
                    if (headerLower.includes('poster') && headerLower.includes('code')) headerMap.posterCode = i;
                    if (headerLower.includes('client') || headerLower.includes('advertiser') || headerLower.includes('customer')) headerMap.client = i;
                    if (headerLower.includes('printer') || headerLower.includes('vendor')) headerMap.printer = i;
                    if (headerLower.includes('qty') || headerLower.includes('quantity') || headerLower.includes('units') || headerLower.includes('total')) headerMap.quantity = i;
                    if (headerLower.includes('box')) headerMap.boxes = i;
                    if (headerLower.includes('design')) headerMap.designs = i;
                    if (headerLower.includes('comment') || headerLower.includes('note')) headerMap.comments = i;
                    if (headerLower.includes('status')) headerMap.status = i;
                    if (headerLower.includes('location') || headerLower.includes('warehouse') || headerLower.includes('bay')) headerMap.warehouseLocation = i;
                    // Image/File link detection
                    if (headerLower.includes('image') || headerLower.includes('photo') || headerLower.includes('picture') || 
                        headerLower.includes('file') || headerLower.includes('link') || headerLower.includes('url') ||
                        headerLower.includes('pdf') || headerLower.includes('attachment')) headerMap.imageLink = i;
                });
                
                // Smart detection: If no image column found, scan first row for Google Drive URLs
                if (headerMap.imageLink === undefined && rows.length > 0) {
                    const firstRow = rows[0];
                    for (let i = 0; i < firstRow.length; i++) {
                        if (isGoogleDriveUrl(firstRow[i])) {
                            driveUrlColumnIndex = i;
                            console.log('Auto-detected Google Drive URL in column', i, ':', headers[i]);
                            break;
                        }
                    }
                }
                
                console.log('Detected columns:', headerMap);
                console.log('Headers:', headers);
                if (driveUrlColumnIndex >= 0) console.log('Drive URL column index:', driveUrlColumnIndex);
                
                return rows.map((row, idx) => {
                    // Get the image URL - check mapped column first, then auto-detected Drive URL column
                    let rawImageLink = null;
                    if (headerMap.imageLink !== undefined) {
                        rawImageLink = row[headerMap.imageLink];
                    } else if (driveUrlColumnIndex >= 0) {
                        rawImageLink = row[driveUrlColumnIndex];
                    } else {
                        // Last resort: scan this row for any Google Drive URL
                        for (let cell of row) {
                            if (isGoogleDriveUrl(cell)) {
                                rawImageLink = cell;
                                break;
                            }
                        }
                    }
                    
                    const imageUrl = rawImageLink 
                        ? convertDriveLink(rawImageLink.trim())
                        : null; // Don't use placeholder images - show "No image" instead
                    
                    const receiptNum = row[headerMap.receiptNumber] || '';
                    
                    return {
                        id: receiptNum ? `${receiptNum}_${idx}` : `ROW-${idx}`, // Always unique ID with row index
                        receiptNumber: receiptNum,
                        dateReceived: row[headerMap.dateReceived] ? new Date(row[headerMap.dateReceived]) : new Date(),
                        description: row[headerMap.description] || '',
                        posterCode: row[headerMap.posterCode] || row[headerMap.description] || '',
                        client: row[headerMap.client] || '',
                        advertiser: row[headerMap.client] || '',
                        printer: row[headerMap.printer] || '',
                        quantity: parseInt(row[headerMap.quantity]) || 0,
                        boxes: parseInt(row[headerMap.boxes]) || 1,
                        designs: parseInt(row[headerMap.designs]) || 1,
                        comments: row[headerMap.comments] || '',
                        status: row[headerMap.status] || 'Received',
                        warehouseLocation: row[headerMap.warehouseLocation] || '',
                        posterImage: imageUrl,
                        originalFileLink: rawImageLink || null,
                        keywords: (row[headerMap.description] || '').toLowerCase().split(/[\s\-]+/).filter(w => w.length > 2)
                    };
                }).filter(m => m.receiptNumber || m.client); // Filter out empty rows
            };

            // Handle CSV file upload
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setIsLoading(true);
                setConnectionError('');
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const lines = text.split('\n').filter(l => l.trim());
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        const rows = lines.slice(1).map(line => {
                            // Handle CSV with quoted values
                            const values = [];
                            let current = '';
                            let inQuotes = false;
                            for (let char of line) {
                                if (char === '"') inQuotes = !inQuotes;
                                else if (char === ',' && !inQuotes) {
                                    values.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            values.push(current.trim());
                            return values;
                        });
                        
                        const parsed = parseSheetData(rows, headers);
                        setMaterials(parsed);
                        setLinkedSheet({ name: file.name, type: 'csv' });
                        setLastSync(new Date());
                        setShowLinkModal(false);
                        // Enable live mode - hides all demo features globally
                        if (setIsLiveMode) setIsLiveMode(true);
                    } catch (err) {
                        setConnectionError('Failed to parse CSV file: ' + err.message);
                    }
                    setIsLoading(false);
                };
                reader.onerror = () => {
                    setConnectionError('Failed to read file');
                    setIsLoading(false);
                };
                reader.readAsText(file);
            };

            // Fetch from Google Sheet published URL
            const handleConnectSheet = async () => {
                if (!sheetUrl) return;
                
                setIsLoading(true);
                setConnectionError('');
                
                try {
                    // Try with CORS proxy
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(sheetUrl)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const text = await response.text();
                    const lines = text.split('\n').filter(l => l.trim());
                    
                    if (lines.length < 2) throw new Error('No data found in spreadsheet');
                    
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const rows = lines.slice(1).map(line => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;
                        for (let char of line) {
                            if (char === '"') inQuotes = !inQuotes;
                            else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());
                        return values;
                    });
                    
                    const parsed = parseSheetData(rows, headers);
                    setMaterials(parsed);
                    setLinkedSheet({ name: 'Google Sheet (Live)', type: 'live-csv', url: sheetUrl });
                    setLastSync(new Date());
                    setShowLinkModal(false);
                    localStorage.setItem('stap_material_sheet_url', sheetUrl);
                    if (setIsLiveMode) setIsLiveMode(true);
                    
                    console.log(`üì¶ Loaded ${parsed.length} materials from Google Sheet`);
                } catch (err) {
                    console.error('Failed to fetch sheet:', err);
                    setConnectionError(`Failed to connect: ${err.message}. Make sure the sheet is published to web as CSV.`);
                } finally {
                    setIsLoading(false);
                }
            };

            // Load saved sheet URL on mount and auto-reconnect
            useEffect(() => {
                const savedUrl = localStorage.getItem('stap_material_sheet_url');
                if (savedUrl && !linkedSheet) {
                    setSheetUrl(savedUrl);
                    // Auto-reconnect to the saved sheet
                    const autoConnect = async () => {
                        setIsLoading(true);
                        try {
                            let csvUrl = savedUrl;
                            const match = savedUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                            if (match) {
                                const sheetId = match[1];
                                const gidMatch = savedUrl.match(/gid=(\d+)/);
                                const gid = gidMatch ? gidMatch[1] : '0';
                                csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                            }
                            
                            const response = await fetch(csvUrl);
                            if (!response.ok) throw new Error('Failed to fetch');
                            const text = await response.text();
                            const lines = text.split('\n').filter(line => line.trim());
                            if (lines.length < 2) throw new Error('No data found');
                            
                            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                            const rows = lines.slice(1).map(line => {
                                const values = [];
                                let current = '';
                                let inQuotes = false;
                                for (const char of line) {
                                    if (char === '"') inQuotes = !inQuotes;
                                    else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
                                    else current += char;
                                }
                                values.push(current.trim());
                                return values;
                            });
                            
                            const parsed = parseSheetData(rows, headers);
                            setMaterials(parsed);
                            setLinkedSheet({ name: 'Google Sheet (Live)', type: 'live-csv', url: savedUrl });
                            setLastSync(new Date());
                            if (setIsLiveMode) setIsLiveMode(true);
                            console.log(`üì¶ Auto-reconnected: Loaded ${parsed.length} materials from Google Sheet`);
                        } catch (err) {
                            console.error('Auto-reconnect failed:', err);
                            // Don't show error modal, just log it - user can manually reconnect
                        } finally {
                            setIsLoading(false);
                        }
                    };
                    autoConnect();
                }
            }, []);

            // Google Sheets Link Modal Component
            const LinkSheetModal = () => {
                if (!showLinkModal) return null;
                
                return (
                    <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setShowLinkModal(false)}>
                        <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-4 flex items-center justify-between">
                                <div className="text-white">
                                    <h3 className="text-xl font-bold flex items-center gap-2">
                                        <Icon name="FileSpreadsheet" size={24} /> Connect Google Sheet
                                    </h3>
                                    <p className="text-green-100 text-sm">Import material receipts from your spreadsheet</p>
                                </div>
                                <button onClick={() => setShowLinkModal(false)} className="text-white/80 hover:text-white p-2">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>
                            
                            <div className="p-6">
                                {/* Connection Status */}
                                {linkedSheet && (
                                    <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                                                <Icon name="Check" size={20} />
                                            </div>
                                            <div>
                                                <div className="font-bold text-green-800">Connected</div>
                                                <div className="text-sm text-green-600">{linkedSheet.name}</div>
                                                {lastSync && <div className="text-xs text-green-500">Last sync: {lastSync.toLocaleString()}</div>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            {linkedSheet?.type === 'live-csv' && (
                                                <button 
                                                    onClick={handleConnectSheet}
                                                    disabled={isLoading}
                                                    className="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-sm font-medium flex items-center gap-1"
                                                >
                                                    <Icon name="RefreshCw" size={14} className={isLoading ? 'animate-spin' : ''} /> Refresh
                                                </button>
                                            )}
                                            <button 
                                                onClick={() => { setMaterials([]); setLinkedSheet(null); localStorage.removeItem('stap_material_sheet_url'); localStorage.removeItem('stap_materials_data'); localStorage.removeItem('stap_materials_sheet'); if (setIsLiveMode) setIsLiveMode(false); }}
                                                className="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium"
                                            >
                                                Disconnect
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {connectionError && (
                                    <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                        ‚ö†Ô∏è {connectionError}
                                    </div>
                                )}
                                
                                {/* Option 1: Google Sheet URL (Primary) */}
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
                                        Connect Published Google Sheet (Recommended)
                                    </h4>
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 text-sm text-amber-800">
                                        <strong>How to publish:</strong> In Google Sheets ‚Üí File ‚Üí Share ‚Üí Publish to web ‚Üí Select CSV format ‚Üí Copy link
                                    </div>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text"
                                            placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                                            value={sheetUrl}
                                            onChange={e => setSheetUrl(e.target.value)}
                                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm"
                                        />
                                        <button 
                                            onClick={handleConnectSheet}
                                            disabled={!sheetUrl || isLoading}
                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white rounded-lg font-medium text-sm flex items-center gap-2"
                                        >
                                            {isLoading ? <Icon name="Loader" size={16} className="animate-spin" /> : <Icon name="Link" size={16} />}
                                            Connect
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Option 2: CSV Upload (Fallback) */}
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
                                        Or Upload CSV File
                                    </h4>
                                    <div className="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-orange-400 transition-colors">
                                        <input 
                                            type="file" 
                                            accept=".csv,.tsv,.txt"
                                            onChange={handleFileUpload}
                                            className="hidden"
                                            id="csv-upload"
                                        />
                                        <label htmlFor="csv-upload" className="cursor-pointer">
                                            <Icon name="Upload" size={32} className="mx-auto text-gray-400 mb-2" />
                                            <div className="text-gray-600 font-medium">Drop CSV file here or click to browse</div>
                                            <div className="text-xs text-gray-400 mt-1">Export your Google Sheet as CSV (File ‚Üí Download ‚Üí CSV)</div>
                                        </label>
                                    </div>
                                </div>
                                
                                {/* Option 3: PDF Upload (NEW!) */}
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <span className="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
                                        Or Upload Receiver PDFs
                                        <span className="ml-2 px-2 py-0.5 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[10px] font-bold rounded-full">NEW!</span>
                                    </h4>
                                    <div className="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-dashed border-red-300 rounded-xl p-6 text-center hover:border-red-400 transition-colors">
                                        <input 
                                            type="file" 
                                            accept=".pdf"
                                            multiple
                                            onChange={handlePdfUpload}
                                            className="hidden"
                                            id="pdf-upload"
                                            disabled={pdfProcessing}
                                        />
                                        <label htmlFor="pdf-upload" className={`cursor-pointer ${pdfProcessing ? 'opacity-50' : ''}`}>
                                            {pdfProcessing ? (
                                                <>
                                                    <Icon name="Loader" size={32} className="mx-auto text-red-500 mb-2 animate-spin" />
                                                    <div className="text-red-600 font-medium">{pdfProgress}</div>
                                                </>
                                            ) : (
                                                <>
                                                    <Icon name="FileText" size={32} className="mx-auto text-red-400 mb-2" />
                                                    <div className="text-red-600 font-medium">Drop PDF receiver(s) here or click to browse</div>
                                                    <div className="text-xs text-red-400 mt-1">Auto-extracts: Receipt #, Client, Qty, Date + generates thumbnail</div>
                                                </>
                                            )}
                                        </label>
                                    </div>
                                    
                                    {/* PDF Results Preview with Campaign Assignment */}
                                    {pdfResults.length > 0 && (
                                        <div className="mt-4 p-4 bg-white border border-red-200 rounded-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <h5 className="font-bold text-gray-800 flex items-center gap-2">
                                                    <Icon name="CheckCircle" size={16} className="text-green-500" />
                                                    {pdfResults.filter(r => !r.error).length} PDF(s) Ready - Assign Campaigns
                                                </h5>
                                                <div className="flex items-center gap-2">
                                                    {webhookUrl ? (
                                                        <span className="text-xs text-green-600 flex items-center gap-1">
                                                            <Icon name="Cloud" size={12} /> Will sync to Sheet
                                                        </span>
                                                    ) : (
                                                        <button 
                                                            onClick={() => setShowWebhookSetup(true)}
                                                            className="text-xs text-amber-600 hover:text-amber-800 flex items-center gap-1"
                                                        >
                                                            <Icon name="AlertCircle" size={12} /> Setup auto-sync ‚Üí
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={handleImportPdfResults}
                                                        disabled={webhookSending}
                                                        className="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 disabled:opacity-50 text-white rounded-lg font-medium text-sm flex items-center gap-2"
                                                    >
                                                        {webhookSending ? (
                                                            <><Icon name="Loader" size={16} className="animate-spin" /> Syncing...</>
                                                        ) : (
                                                            <><Icon name="Download" size={16} /> Import{webhookUrl ? ' & Sync' : ' All'}</>
                                                        )}
                                                    </button>
                                                </div>
                                            </div>
                                            {webhookStatus && (
                                                <div className={`mb-3 text-xs px-3 py-2 rounded-lg ${
                                                    webhookStatus.includes('‚úÖ') ? 'bg-green-50 text-green-700' : 
                                                    webhookStatus.includes('‚ùå') ? 'bg-red-50 text-red-700' : 
                                                    'bg-blue-50 text-blue-700'
                                                }`}>
                                                    {webhookStatus}
                                                </div>
                                            )}
                                            
                                            {/* PDF Results with Campaign Selection */}
                                            <div className="space-y-3 max-h-80 overflow-auto">
                                                {pdfResults.map((result, idx) => (
                                                    <div key={idx} className={`p-3 rounded-lg border ${result.error ? 'bg-red-50 border-red-300' : 'bg-gray-50 border-gray-200'}`}>
                                                        <div className="flex gap-3">
                                                            {result.posterImage && (
                                                                <img src={result.posterImage} alt="PDF thumbnail" className="w-20 h-24 object-cover rounded border flex-shrink-0" />
                                                            )}
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-start justify-between gap-2 mb-2">
                                                                    <div>
                                                                        <div className="font-mono text-xs text-orange-600">{result.receiptNumber}</div>
                                                                        <div className="font-bold text-sm text-gray-800">{result.client}</div>
                                                                        <div className="text-xs text-gray-500">Qty: {result.quantity} ‚Ä¢ {result.dateReceived}</div>
                                                                    </div>
                                                                    {result.error && <span className="text-xs text-red-600">‚ö†Ô∏è Error</span>}
                                                                </div>
                                                                
                                                                {/* Campaign Assignment - Searchable */}
                                                                <div className="bg-white rounded border border-gray-200 p-2">
                                                                    <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wide block mb-1">
                                                                        Assign to Campaign
                                                                    </label>
                                                                    <div className="relative">
                                                                        <input
                                                                            type="text"
                                                                            placeholder={result.campaignId ? (result.matchedCampaign || result.campaignId) : "üîç Search advertiser, campaign..."}
                                                                            value={result.campaignSearch || ''}
                                                                            onChange={(e) => {
                                                                                const newResults = [...pdfResults];
                                                                                newResults[idx] = { ...result, campaignSearch: e.target.value, showDropdown: true };
                                                                                setPdfResults(newResults);
                                                                            }}
                                                                            onFocus={() => {
                                                                                const newResults = [...pdfResults];
                                                                                newResults[idx] = { ...result, showDropdown: true };
                                                                                setPdfResults(newResults);
                                                                            }}
                                                                            className={`w-full text-xs border rounded px-2 py-1.5 ${
                                                                                result.campaignId && result.campaignId !== '__PENDING__' 
                                                                                    ? 'border-green-400 bg-green-50' 
                                                                                    : 'border-gray-300 bg-white'
                                                                            }`}
                                                                        />
                                                                        {result.campaignId && result.campaignId !== '__PENDING__' && (
                                                                            <span className="absolute right-2 top-1/2 -translate-y-1/2 text-green-600">
                                                                                <Icon name="CheckCircle" size={14} />
                                                                            </span>
                                                                        )}
                                                                        
                                                                        {/* Dropdown */}
                                                                        {result.showDropdown && (
                                                                            <div className="absolute z-50 top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-xl max-h-48 overflow-auto">
                                                                                <div 
                                                                                    onClick={() => {
                                                                                        const newResults = [...pdfResults];
                                                                                        newResults[idx] = { ...result, campaignId: '__PENDING__', matchedCampaign: 'Pending', showDropdown: false, campaignSearch: '' };
                                                                                        setPdfResults(newResults);
                                                                                    }}
                                                                                    className="px-3 py-2 hover:bg-amber-50 cursor-pointer text-amber-700 border-b text-xs"
                                                                                >
                                                                                    ‚è≥ Keep Pending
                                                                                </div>
                                                                                {data
                                                                                    .filter(c => {
                                                                                        const search = (result.campaignSearch || result.client || '').toLowerCase();
                                                                                        if (!search) return true;
                                                                                        return (
                                                                                            (c['Campaign ID'] || '').toLowerCase().includes(search) ||
                                                                                            (c['Advertiser'] || '').toLowerCase().includes(search) ||
                                                                                            (c['Flight Name'] || '').toLowerCase().includes(search)
                                                                                        );
                                                                                    })
                                                                                    .slice(0, 20)
                                                                                    .map(campaign => (
                                                                                        <div
                                                                                            key={campaign['Campaign ID'] || campaign.id}
                                                                                            onClick={() => {
                                                                                                const newResults = [...pdfResults];
                                                                                                newResults[idx] = { 
                                                                                                    ...result, 
                                                                                                    campaignId: campaign['Campaign ID'] || campaign.id,
                                                                                                    matchedCampaign: campaign['Flight Name'] || campaign['Advertiser'],
                                                                                                    // Auto-inherit production source from campaign
                                                                                                    productionSource: campaign.productionProof || result.productionSource,
                                                                                                    showDropdown: false,
                                                                                                    campaignSearch: ''
                                                                                                };
                                                                                                setPdfResults(newResults);
                                                                                            }}
                                                                                            className="px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-gray-100 text-xs"
                                                                                        >
                                                                                            <div className="font-medium text-gray-800 flex items-center gap-2">
                                                                                                {campaign['Advertiser'] || 'Unknown'}
                                                                                                {/* Show production source badge if available */}
                                                                                                {campaign.productionProof && (
                                                                                                    <ProductionIcon type={campaign.productionProof} size={12} compact />
                                                                                                )}
                                                                                            </div>
                                                                                            <div className="text-[10px] text-gray-500">
                                                                                                <span className="font-mono text-orange-600">{campaign['Campaign ID']}</span>
                                                                                                {' ‚Ä¢ '}{campaign['Flight Name'] || 'Untitled'}
                                                                                            </div>
                                                                                        </div>
                                                                                    ))
                                                                                }
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    {result.matchedCampaign && result.campaignId !== '__PENDING__' && (
                                                                        <div className="mt-1 text-[10px] text-green-600 flex items-center gap-1">
                                                                            <Icon name="Link" size={10} /> Linked: {result.matchedCampaign}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {/* Summary */}
                                            <div className="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between text-xs">
                                                <div className="text-gray-500">
                                                    <span className="font-medium text-green-600">{pdfResults.filter(r => r.campaignId && r.campaignId !== '__PENDING__').length}</span> assigned ‚Ä¢ 
                                                    <span className="font-medium text-amber-600 ml-1">{pdfResults.filter(r => !r.campaignId || r.campaignId === '__PENDING__').length}</span> pending
                                                </div>
                                                <div className="text-gray-400">
                                                    üí° You can assign campaigns later from the table view
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Webhook Setup Prompt */}
                                    <div className="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${webhookUrl ? 'bg-green-500' : 'bg-blue-500'}`}>
                                                    <Icon name={webhookUrl ? "Check" : "Zap"} size={20} className="text-white" />
                                                </div>
                                                <div>
                                                    <div className="font-bold text-gray-800 text-sm">
                                                        {webhookUrl ? '‚úÖ Auto-Sync Enabled' : '‚ö° Enable Auto-Sync to Google Sheet'}
                                                    </div>
                                                    <div className="text-xs text-gray-600">
                                                        {webhookUrl 
                                                            ? 'PDF imports will automatically save to your Google Sheet' 
                                                            : 'Never lose data - PDF uploads sync directly to your sheet'}
                                                    </div>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => setShowWebhookSetup(true)}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${
                                                    webhookUrl 
                                                        ? 'bg-gray-100 hover:bg-gray-200 text-gray-700' 
                                                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                                                }`}
                                            >
                                                <Icon name="Settings" size={16} />
                                                {webhookUrl ? 'Configure' : 'Setup Now'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Expected Columns */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h4 className="font-bold text-gray-700 mb-2 text-sm">üìã Expected Columns (auto-detected)</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                        {[
                                            { name: 'Receipt #', desc: 'INV number' },
                                            { name: 'Transaction Date', desc: 'When received' },
                                            { name: 'Client', desc: 'Advertiser name' },
                                            { name: 'Description', desc: 'Material name' },
                                            { name: 'Poster Code', desc: 'Unique ID' },
                                            { name: 'Qty / Total', desc: 'Units received' },
                                            { name: 'Printer', desc: 'Vendor' },
                                            { name: 'Image/File Link', desc: 'Google Drive URL', highlight: true },
                                        ].map(col => (
                                            <div key={col.name} className={`rounded p-2 border ${col.highlight ? 'bg-green-50 border-green-300' : 'bg-white'}`}>
                                                <div className={`font-medium ${col.highlight ? 'text-green-800' : 'text-gray-800'}`}>{col.name}</div>
                                                <div className={col.highlight ? 'text-green-600' : 'text-gray-500'}>{col.desc}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                        <div className="text-xs text-green-800">
                                            <strong>üì∑ Image Link Support:</strong> The system auto-detects any column containing Google Drive URLs - 
                                            even if the column is named after the poster code! Just make sure your sheet has the Drive link somewhere.
                                            <div className="mt-2 text-[10px] text-green-600">
                                                ‚úì Detects: <code className="bg-white px-1 rounded">drive.google.com/file/d/...</code>
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">
                                        Column names are flexible - the system auto-detects based on common patterns.
                                    </p>
                                </div>
                            </div>
                            
                            {/* Footer */}
                            <div className="px-6 py-4 bg-gray-50 border-t flex justify-between items-center">
                                <div className="text-xs text-gray-500">
                                    {materialsArray.length > 0 ? `‚úì ${materialsArray.length} receipts loaded` : 'No data loaded yet'}
                                </div>
                                <button 
                                    onClick={() => setShowLinkModal(false)}
                                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium text-sm"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // Demo materials data
            const demoMaterials = useMemo(() => [
                {
                    id: 'INV174705',
                    receiptNumber: 'INV174705',
                    dateReceived: new Date('2025-12-31T08:14:00'),
                    description: 'GET TRUE VALUE-AL',
                    posterCode: 'GET TRUE VALUE-AL',
                    client: 'ACCIDENT LAWYERS',
                    advertiser: 'Insider Accident Lawyers',
                    printer: 'CIRCLE GRAPHICS-P',
                    quantity: 11,
                    boxes: 1,
                    designs: 1,
                    comments: 'RECEIVED 1 BOX; 1 DESIGN ON 12.30.25',
                    status: 'Received',
                    warehouseLocation: 'Bay 3 - Shelf A2',
                    matchedCampaign: '251230001-0',
                    posterImage: 'https://picsum.photos/seed/accident-lawyers/400/500',
                    keywords: ['insider', 'accident', 'lawyers', 'get', 'true', 'value', '844', 'inside', 'accidentwin']
                },
                {
                    id: 'INV174688',
                    receiptNumber: 'INV174688',
                    dateReceived: new Date('2025-12-30T14:22:00'),
                    description: 'STRANGER THINGS S5-NF',
                    posterCode: 'STRANGER-S5-NF',
                    client: 'NETFLIX',
                    advertiser: 'Netflix',
                    printer: 'VISION GRAPHICS',
                    quantity: 250,
                    boxes: 12,
                    designs: 3,
                    comments: 'RECEIVED 12 BOXES; 3 DESIGNS - MAIN CAST, LOGO, TEASER',
                    status: 'In Warehouse',
                    warehouseLocation: 'Bay 1 - Pallets 1-3',
                    matchedCampaign: '258905855-0',
                    posterImage: 'https://picsum.photos/seed/netflix-stranger/400/500',
                    keywords: ['netflix', 'stranger', 'things', 'season', '5', 'streaming']
                },
                {
                    id: 'INV174690',
                    receiptNumber: 'INV174690',
                    dateReceived: new Date('2025-12-29T09:45:00'),
                    description: 'AIR MAX 2025-NK',
                    posterCode: 'AIRMAX-2025-NK',
                    client: 'NIKE',
                    advertiser: 'Nike',
                    printer: 'COLORCRAFT INC',
                    quantity: 75,
                    boxes: 4,
                    designs: 2,
                    comments: 'RECEIVED 4 BOXES; 2 DESIGNS - PRODUCT SHOT, LIFESTYLE',
                    status: 'Partially Deployed',
                    warehouseLocation: 'Bay 2 - Shelf B1',
                    matchedCampaign: '250929011-0',
                    deployedQty: 45,
                    posterImage: 'https://picsum.photos/seed/nike-airmax/400/500',
                    keywords: ['nike', 'air', 'max', '2025', 'just', 'do', 'it']
                },
                {
                    id: 'INV174685',
                    receiptNumber: 'INV174685',
                    dateReceived: new Date('2025-12-28T11:30:00'),
                    description: 'iPHONE 16 PRO-APL',
                    posterCode: 'IP16PRO-APL',
                    client: 'APPLE',
                    advertiser: 'Apple',
                    printer: 'PREMIUM PRINT CO',
                    quantity: 50,
                    boxes: 3,
                    designs: 1,
                    comments: 'RECEIVED 3 BOXES; 1 DESIGN - PRODUCT HERO',
                    status: 'Fully Deployed',
                    warehouseLocation: 'N/A - All Deployed',
                    matchedCampaign: '251115003-0',
                    deployedQty: 50,
                    posterImage: 'https://picsum.photos/seed/apple-iphone/400/500',
                    keywords: ['apple', 'iphone', '16', 'pro']
                },
                {
                    id: 'INV174680',
                    receiptNumber: 'INV174680',
                    dateReceived: new Date('2025-12-27T16:00:00'),
                    description: 'DAVID YURMAN JEWELRY-DY',
                    posterCode: 'JEWELRY-DY-2026',
                    client: 'DAVID YURMAN',
                    advertiser: 'David Yurman',
                    printer: 'LUXE GRAPHICS',
                    quantity: 25,
                    boxes: 2,
                    designs: 1,
                    comments: 'RECEIVED 2 BOXES; 1 DESIGN - SPRING COLLECTION',
                    status: 'Fully Deployed',
                    warehouseLocation: 'N/A - All Deployed',
                    matchedCampaign: '250922043-0',
                    deployedQty: 25,
                    posterImage: 'https://picsum.photos/seed/david-yurman/400/500',
                    keywords: ['david', 'yurman', 'jewelry', 'collection']
                },
                {
                    id: 'INV174675',
                    receiptNumber: 'INV174675',
                    dateReceived: new Date('2025-12-26T10:15:00'),
                    description: 'GALAXY S25 ULTRA-SAM',
                    posterCode: 'GS25U-SAM',
                    client: 'SAMSUNG',
                    advertiser: 'Samsung',
                    printer: 'DIGITAL PRINT WORKS',
                    quantity: 100,
                    boxes: 6,
                    designs: 2,
                    comments: 'RECEIVED 6 BOXES; 2 DESIGNS - PRODUCT, LIFESTYLE',
                    status: 'Partially Deployed',
                    warehouseLocation: 'Bay 2 - Shelf C3',
                    matchedCampaign: '250830022-0',
                    deployedQty: 68,
                    posterImage: 'https://picsum.photos/seed/samsung-galaxy/400/500',
                    keywords: ['samsung', 'galaxy', 's25', 'ultra']
                },
                {
                    id: 'INV174670',
                    receiptNumber: 'INV174670',
                    dateReceived: new Date('2025-12-24T08:00:00'),
                    description: 'COCA-COLA SUMMER-CC',
                    posterCode: 'SUMMER-CC-2025',
                    client: 'COCA-COLA',
                    advertiser: 'Coca-Cola',
                    printer: 'CLASSIC PRINT',
                    quantity: 40,
                    boxes: 2,
                    designs: 1,
                    comments: 'RECEIVED 2 BOXES; 1 DESIGN - SUMMER REFRESH',
                    status: 'In Warehouse',
                    warehouseLocation: 'Bay 4 - Shelf D1',
                    matchedCampaign: '251201044-0',
                    posterImage: 'https://picsum.photos/seed/coca-cola/400/500',
                    keywords: ['coca', 'cola', 'summer', 'refresh']
                },
                {
                    id: 'INV174665',
                    receiptNumber: 'INV174665',
                    dateReceived: new Date('2025-12-23T13:45:00'),
                    description: 'MCRIB RETURNS-MCD',
                    posterCode: 'MCRIB-2025-MCD',
                    client: 'MCDONALDS',
                    advertiser: 'McDonalds',
                    printer: 'GOLDEN ARCH PRINT',
                    quantity: 35,
                    boxes: 2,
                    designs: 1,
                    comments: 'RECEIVED 2 BOXES; 1 DESIGN - MCRIB PROMO',
                    status: 'Partially Deployed',
                    warehouseLocation: 'Bay 3 - Shelf B2',
                    matchedCampaign: '251010033-0',
                    deployedQty: 28,
                    posterImage: 'https://picsum.photos/seed/mcdonalds/400/500',
                    keywords: ['mcdonalds', 'mcrib', 'returns', '2025']
                }
            ], []);

            // Determine if we should show demo/sample data (no real data uploaded)
            // Safety: materials might be undefined if prop not passed correctly
            const materialsArray = materials || [];
            const hasNoData = materialsArray.length === 0;
            
            // Load saved material data from DetailModal (localStorage)
            const savedMaterialEntries = useMemo(() => {
                const savedData = JSON.parse(localStorage.getItem('stap_material_data') || '{}');
                const entries = [];
                
                Object.entries(savedData).forEach(([key, data]) => {
                    if (data.materialBreakdown && data.materialBreakdown.length > 0) {
                        const [campaignId, date] = key.split('_');
                        // Find matching campaign in rawData for additional context
                        const campaign = data.filter ? data : { advertiser: 'Unknown', name: '' };
                        
                        data.materialBreakdown.forEach((item, idx) => {
                            if (item.code || item.qty) {
                                entries.push({
                                    id: `SAVED-${key}-${idx}`,
                                    receiptNumber: `${campaignId}-D${idx + 1}`,
                                    dateReceived: new Date(data.updatedAt || Date.now()),
                                    description: item.code || 'Design Material',
                                    posterCode: item.code || '',
                                    client: campaignId,
                                    advertiser: campaignId,
                                    quantity: parseInt(item.qty) || 0,
                                    boxes: 1,
                                    designs: 1,
                                    status: 'Received',
                                    comments: `Logged from Update Stages - ${data.mediaType || ''}`,
                                    warehouseLocation: '',
                                    posterImage: item.link || `https://picsum.photos/seed/${key}-${idx}/400/500`,
                                    originalFileLink: item.link || null,
                                    keywords: [campaignId.toLowerCase(), (item.code || '').toLowerCase()],
                                    fromDetailModal: true
                                });
                            }
                        });
                    }
                });
                return entries;
            }, []);
            
            // Combine: uploaded data + saved entries from DetailModal
            const combinedMaterials = useMemo(() => {
                return [...materialsArray, ...savedMaterialEntries];
            }, [materialsArray, savedMaterialEntries]);
            
            // Use demo data ONLY if no real data uploaded - but empty array if in production mode
            // When showDemoTips is false (production), show empty state instead of demo data
            const allMaterials = combinedMaterials.length === 0 ? (showDemoTips ? demoMaterials : []) : combinedMaterials;

            // Get unique clients
            const clients = useMemo(() => {
                return [...new Set(allMaterials.map(m => m.client))].sort();
            }, [allMaterials]);

            // Filter materials
            const filteredMaterials = useMemo(() => {
                return allMaterials.filter(m => {
                    if (selectedClient !== 'ALL' && m.client !== selectedClient) return false;
                    if (selectedStatus !== 'ALL' && m.status !== selectedStatus) return false;
                    if (dateFilter.start && m.dateReceived < new Date(dateFilter.start)) return false;
                    if (dateFilter.end && m.dateReceived > new Date(dateFilter.end + 'T23:59:59')) return false;
                    if (searchTerm) {
                        const search = searchTerm.toLowerCase();
                        // Search across ALL fields
                        return (
                            m.receiptNumber?.toLowerCase().includes(search) ||
                            m.client?.toLowerCase().includes(search) ||
                            m.advertiser?.toLowerCase().includes(search) ||
                            m.description?.toLowerCase().includes(search) ||
                            m.posterCode?.toLowerCase().includes(search) ||
                            m.printer?.toLowerCase().includes(search) ||
                            m.status?.toLowerCase().includes(search) ||
                            m.comments?.toLowerCase().includes(search) ||
                            m.pdfSource?.toLowerCase().includes(search) ||
                            (typeof m.dateReceived === 'string' && m.dateReceived.toLowerCase().includes(search)) ||
                            String(m.quantity).includes(search)
                        );
                    }
                    return true;
                });
            }, [allMaterials, selectedClient, selectedStatus, dateFilter, searchTerm]);

            // Stats
            const stats = useMemo(() => {
                const totalQty = filteredMaterials.reduce((sum, m) => sum + m.quantity, 0);
                const deployedQty = filteredMaterials.reduce((sum, m) => sum + (m.deployedQty || 0), 0);
                const byStatus = {
                    received: filteredMaterials.filter(m => m.status === 'Received').length,
                    inWarehouse: filteredMaterials.filter(m => m.status === 'In Warehouse').length,
                    partiallyDeployed: filteredMaterials.filter(m => m.status === 'Partially Deployed').length,
                    fullyDeployed: filteredMaterials.filter(m => m.status === 'Fully Deployed').length
                };
                return { totalQty, deployedQty, byStatus, totalReceipts: filteredMaterials.length };
            }, [filteredMaterials]);

            // Performance Analytics
            const analytics = useMemo(() => {
                // Group by date (last 14 days)
                const last14Days = [];
                for (let i = 13; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    last14Days.push({
                        date,
                        dateStr: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        receipts: 0,
                        units: 0
                    });
                }
                
                allMaterials.forEach(m => {
                    const mDate = new Date(m.dateReceived);
                    mDate.setHours(0, 0, 0, 0);
                    const dayEntry = last14Days.find(d => d.date.getTime() === mDate.getTime());
                    if (dayEntry) {
                        dayEntry.receipts++;
                        dayEntry.units += m.quantity;
                    }
                });
                
                // By client breakdown
                const byClient = {};
                allMaterials.forEach(m => {
                    if (!byClient[m.client]) {
                        byClient[m.client] = { receipts: 0, units: 0, deployed: 0 };
                    }
                    byClient[m.client].receipts++;
                    byClient[m.client].units += m.quantity;
                    byClient[m.client].deployed += m.deployedQty || 0;
                });
                
                // Sort clients by units
                const clientRanking = Object.entries(byClient)
                    .map(([client, data]) => ({ client, ...data }))
                    .sort((a, b) => b.units - a.units);
                
                // By printer breakdown
                const byPrinter = {};
                allMaterials.forEach(m => {
                    const printer = m.printer || 'Unknown';
                    if (!byPrinter[printer]) {
                        byPrinter[printer] = { receipts: 0, units: 0 };
                    }
                    byPrinter[printer].receipts++;
                    byPrinter[printer].units += m.quantity;
                });
                
                // Recent activity (last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const recentReceipts = allMaterials.filter(m => m.dateReceived >= sevenDaysAgo);
                const recentUnits = recentReceipts.reduce((sum, m) => sum + m.quantity, 0);
                
                // Deployment rate
                const totalUnits = allMaterials.reduce((sum, m) => sum + m.quantity, 0);
                const totalDeployed = allMaterials.reduce((sum, m) => sum + (m.deployedQty || 0), 0);
                const deploymentRate = totalUnits > 0 ? Math.round((totalDeployed / totalUnits) * 100) : 0;
                
                // Average units per receipt
                const avgUnitsPerReceipt = allMaterials.length > 0 
                    ? Math.round(totalUnits / allMaterials.length) 
                    : 0;
                
                return {
                    dailyData: last14Days,
                    clientRanking,
                    byPrinter: Object.entries(byPrinter).map(([printer, data]) => ({ printer, ...data })),
                    recentReceipts: recentReceipts.length,
                    recentUnits,
                    deploymentRate,
                    avgUnitsPerReceipt,
                    totalUnits,
                    totalDeployed
                };
            }, [allMaterials]);

            // Status colors
            const getStatusColor = (status) => {
                switch(status) {
                    case 'Received': return 'bg-blue-100 text-blue-700 border-blue-300';
                    case 'Material Ready': 
                    case 'Material Ready for Install': return 'bg-amber-100 text-amber-700 border-amber-300';
                    case 'Deployed':
                    case 'Partially Deployed':
                    case 'Fully Deployed': return 'bg-purple-100 text-purple-700 border-purple-300';
                    case 'Installed': return 'bg-green-100 text-green-700 border-green-300 ring-2 ring-green-400';
                    // Legacy statuses for backwards compatibility
                    case 'Processed': return 'bg-sky-100 text-sky-700 border-sky-300';
                    case 'In Warehouse': return 'bg-amber-100 text-amber-700 border-amber-300';
                    default: return 'bg-gray-100 text-gray-700 border-gray-300';
                }
            };

            // Receipt Detail Modal
            const ReceiptModal = ({ receipt, onClose }) => {
                if (!receipt) return null;
                
                const deploymentPercent = receipt.quantity > 0 
                    ? Math.round(((receipt.deployedQty || 0) / receipt.quantity) * 100) 
                    : 0;
                
                return (
                    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={onClose}>
                        <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className="bg-gradient-to-r from-orange-500 to-amber-500 px-6 py-4 flex items-center justify-between">
                                <div className="text-white">
                                    <h3 className="text-xl font-bold">Receipt #{receipt.receiptNumber}</h3>
                                    <p className="text-orange-100 text-sm">{typeof receipt.dateReceived === 'string' ? receipt.dateReceived : (receipt.dateReceived?.toLocaleDateString?.() || '')} at {typeof receipt.dateReceived === 'object' ? receipt.dateReceived?.toLocaleTimeString?.() : ''}</p>
                                </div>
                                <button onClick={onClose} className="text-white/80 hover:text-white p-2">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>
                            
                            <div className="p-6">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Poster Image */}
                                    <div>
                                        <div className="aspect-[4/5] bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl overflow-hidden border-4 border-gray-200 relative">
                                            {receipt.posterImage ? (
                                                <img 
                                                    src={receipt.posterImage} 
                                                    alt={receipt.description || 'Material receipt'}
                                                    className="w-full h-full object-cover"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                        if (e.target.nextSibling) e.target.nextSibling.style.display = 'flex';
                                                    }}
                                                />
                                            ) : null}
                                            {/* Placeholder for missing/broken images */}
                                            <div 
                                                className="absolute inset-0 flex flex-col items-center justify-center text-gray-400"
                                                style={{ display: receipt.posterImage ? 'none' : 'flex' }}
                                            >
                                                <Icon name="Package" size={64} className="text-gray-300 mb-2" />
                                                <span className="text-sm text-gray-400">No image available</span>
                                                {receipt.originalFileLink && (
                                                    <a 
                                                        href={receipt.originalFileLink} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors"
                                                    >
                                                        Open original file ‚Üí
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="mt-3 text-center">
                                            <span className="text-xs text-gray-500">Poster Code: </span>
                                            <span className="text-sm font-mono font-bold text-gray-800">{receipt.posterCode}</span>
                                        </div>
                                    </div>
                                    
                                    {/* Details */}
                                    <div className="space-y-4">
                                        {/* Status Badge */}
                                        <div className="flex items-center justify-between">
                                            <span className={`px-4 py-2 rounded-full text-sm font-bold border ${getStatusColor(receipt.status)}`}>
                                                {receipt.status}
                                            </span>
                                            {receipt.matchedCampaign && (
                                                <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                                    ‚úì Matched to {receipt.matchedCampaign}
                                                </span>
                                            )}
                                        </div>
                                        
                                        {/* Info Grid */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-gray-50 rounded-lg p-3">
                                                <div className="text-xs text-gray-500 uppercase font-bold">Client</div>
                                                <div className="text-lg font-bold text-gray-800">{receipt.client}</div>
                                            </div>
                                            <div className="bg-gray-50 rounded-lg p-3">
                                                <div className="text-xs text-gray-500 uppercase font-bold">Quantity</div>
                                                <div className="text-lg font-bold text-gray-800">{receipt.quantity} units</div>
                                            </div>
                                            <div className="bg-gray-50 rounded-lg p-3">
                                                <div className="text-xs text-gray-500 uppercase font-bold">Boxes</div>
                                                <div className="text-lg font-bold text-gray-800">{receipt.boxes}</div>
                                            </div>
                                            <div className="bg-gray-50 rounded-lg p-3">
                                                <div className="text-xs text-gray-500 uppercase font-bold">Designs</div>
                                                <div className="text-lg font-bold text-gray-800">{receipt.designs}</div>
                                            </div>
                                        </div>
                                        
                                        {/* Deployment Progress */}
                                        {receipt.status !== 'Received' && receipt.status !== 'In Warehouse' && (
                                            <div className="bg-gray-50 rounded-lg p-4">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-sm font-bold text-gray-700">Deployment Progress</span>
                                                    <span className="text-sm font-bold text-gray-800">{receipt.deployedQty || 0} / {receipt.quantity}</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-3">
                                                    <div 
                                                        className={`h-3 rounded-full transition-all ${deploymentPercent >= 100 ? 'bg-green-500' : 'bg-purple-500'}`}
                                                        style={{ width: `${deploymentPercent}%` }}
                                                    ></div>
                                                </div>
                                                <div className="text-right text-xs text-gray-500 mt-1">{deploymentPercent}% deployed</div>
                                            </div>
                                        )}
                                        
                                        {/* Details List */}
                                        <div className="space-y-2">
                                            <div className="flex justify-between py-2 border-b">
                                                <span className="text-gray-500 text-sm">Description</span>
                                                <span className="font-medium text-gray-800 text-sm">{receipt.description}</span>
                                            </div>
                                            <div className="flex justify-between py-2 border-b">
                                                <span className="text-gray-500 text-sm">Printer</span>
                                                <span className="font-medium text-gray-800 text-sm">{receipt.printer}</span>
                                            </div>
                                            <div className="flex justify-between py-2 border-b">
                                                <span className="text-gray-500 text-sm">Warehouse Location</span>
                                                <span className="font-medium text-gray-800 text-sm">{receipt.warehouseLocation}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Comments */}
                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                            <div className="text-xs text-amber-600 uppercase font-bold mb-1">Comments</div>
                                            <div className="text-sm text-amber-800">{receipt.comments}</div>
                                        </div>
                                        
                                        {/* Keywords for OCR matching */}
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase font-bold mb-2">Expected Keywords (for POP verification)</div>
                                            <div className="flex flex-wrap gap-1">
                                                {receipt.keywords?.map(kw => (
                                                    <span key={kw} className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs">
                                                        {kw}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Actions */}
                                        <div className="flex flex-wrap gap-2 pt-4">
                                            <button className="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2">
                                                <Icon name="Camera" size={16} /> View in POP Gallery
                                            </button>
                                            {receipt.originalFileLink && (
                                                <a 
                                                    href={receipt.originalFileLink}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-medium text-sm flex items-center justify-center gap-2"
                                                >
                                                    <Icon name="FileText" size={16} /> Open Original PDF
                                                </a>
                                            )}
                                            <button className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm flex items-center justify-center gap-2">
                                                <Icon name="Printer" size={16} /> Print
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    {/* Header - Compact */}
                    <div className={`px-4 py-2 border-b flex justify-between items-center ${(hasNoData && showDemoTips) ? 'bg-gradient-to-r from-amber-50 to-orange-50' : 'bg-gradient-to-r from-green-50 to-emerald-50'}`}>
                        <div className="flex items-center gap-2">
                            <button onClick={onBack} className="p-1 hover:bg-orange-200 rounded-full transition-colors" title="Back">
                                <Icon name="ArrowLeft" size={16} className="text-orange-600" />
                            </button>
                            <div>
                                <h3 className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                    <Icon name="Package" size={16} className="text-orange-600" />
                                    Material Receivers
                                    {(hasNoData && showDemoTips) ? (
                                        <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-medium rounded-full flex items-center gap-1 border border-amber-300">
                                            ‚ö†Ô∏è DEMO
                                        </span>
                                    ) : linkedSheet && (
                                        <span className="px-1.5 py-0.5 bg-green-100 text-green-700 text-[10px] font-medium rounded-full flex items-center gap-1">
                                            <Icon name="CheckCircle" size={10} /> Live
                                        </span>
                                    )}
                                </h3>
                                <p className="text-xs text-gray-500">
                                    {allMaterials.length} receipts
                                    {(hasNoData && showDemoTips) && <span className="ml-1 text-amber-600">‚Ä¢ Sample data - upload CSV to see real data</span>}
                                    {!hasNoData && linkedSheet && <span className="ml-1 text-green-600">‚Ä¢ {linkedSheet.name}</span>}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            {/* Export CSV Button */}
                            {materialsArray.length > 0 && (
                                <button 
                                    onClick={() => {
                                        const headers = ['Receipt #', 'Date', 'Client', 'Description', 'Poster Code', 'Quantity', 'Printer', 'Status', 'Comments'];
                                        const rows = materialsArray.map(m => [
                                            m.receiptNumber, m.dateReceived, m.client, m.description, 
                                            m.posterCode, m.quantity, m.printer, m.status, m.comments
                                        ]);
                                        const csv = [headers, ...rows].map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
                                        const blob = new Blob([csv], { type: 'text/csv' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `materials_export_${new Date().toISOString().split('T')[0]}.csv`;
                                        a.click();
                                    }}
                                    className="px-2 py-1 bg-blue-100 border border-blue-200 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium flex items-center gap-1"
                                    title="Export to CSV"
                                >
                                    <Icon name="Download" size={14} /> Export
                                </button>
                            )}
                            {/* Clear All Button */}
                            {materialsArray.length > 0 && (
                                <button 
                                    onClick={() => {
                                        if (confirm(`Delete all ${materialsArray.length} receipts? This cannot be undone.`)) {
                                            setMaterials([]);
                                            localStorage.removeItem('stap_materials_data');
                                        }
                                    }}
                                    className="px-2 py-1 bg-red-100 border border-red-200 hover:bg-red-200 text-red-700 rounded text-xs font-medium flex items-center gap-1"
                                    title="Clear all materials"
                                >
                                    <Icon name="Trash2" size={14} /> Clear
                                </button>
                            )}
                            {/* Link Google Sheet Button */}
                            <button 
                                onClick={() => setShowLinkModal(true)}
                                className={`px-2 py-1 rounded text-xs font-medium flex items-center gap-1 transition-all ${
                                    linkedSheet 
                                        ? 'bg-green-100 border border-green-300 hover:bg-green-200 text-green-700'
                                        : 'bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white'
                                }`}
                            >
                                <Icon name="FileSpreadsheet" size={14} />
                                {linkedSheet ? 'Connected' : 'Link Sheet'}
                            </button>
                            <button 
                                onClick={() => setView && setView('popGallery')}
                                className="px-2 py-1 bg-indigo-100 border border-indigo-200 hover:bg-indigo-200 text-indigo-700 rounded text-xs font-medium flex items-center gap-1"
                            >
                                <Icon name="Camera" size={14} /> POP
                            </button>
                            <div className="flex bg-white border border-gray-300 rounded p-0.5">
                                <button 
                                    onClick={() => setViewMode('cards')}
                                    className={`p-1 rounded transition-all ${viewMode === 'cards' ? 'bg-orange-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="Card View"
                                >
                                    <Icon name="Grid" size={14} />
                                </button>
                                <button 
                                    onClick={() => setViewMode('list')}
                                    className={`p-1 rounded transition-all ${viewMode === 'list' ? 'bg-orange-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="List View"
                                >
                                    <Icon name="List" size={14} />
                                </button>
                                <button 
                                    onClick={() => setViewMode('timeline')}
                                    className={`p-1 rounded transition-all ${viewMode === 'timeline' ? 'bg-orange-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="Timeline View"
                                >
                                    <Icon name="Clock" size={14} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Stats + Filters Combined Row */}
                    <div className="px-3 py-2 border-b bg-gray-50 flex items-center gap-3 flex-wrap">
                        {/* Stats */}
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-1">
                                <span className="text-base font-bold text-gray-800">{stats.totalReceipts}</span>
                                <span className="text-[9px] text-gray-500">RCPTS</span>
                            </div>
                            <div className="flex items-center gap-1">
                                <span className="text-base font-bold text-orange-600">{stats.totalQty}</span>
                                <span className="text-[9px] text-gray-500">UNITS</span>
                            </div>
                            <div className="flex items-center gap-1">
                                <span className="text-base font-bold text-green-600">{stats.deployedQty}</span>
                                <span className="text-[9px] text-gray-500">DEPLOYED</span>
                            </div>
                        </div>
                        
                        <div className="h-4 w-px bg-gray-300"></div>
                        
                        {/* Filters inline */}
                        <select 
                            value={selectedClient}
                            onChange={e => setSelectedClient(e.target.value)}
                            className="px-2 py-1 border border-gray-300 rounded text-xs bg-white"
                        >
                            <option value="ALL">All Clients</option>
                            {clients.map(c => (
                                <option key={c} value={c}>{c}</option>
                            ))}
                        </select>
                        
                        <select 
                            value={selectedStatus}
                            onChange={e => setSelectedStatus(e.target.value)}
                            className="px-2 py-1 border border-gray-300 rounded text-xs bg-white"
                        >
                            <option value="ALL">All Status</option>
                            <option value="Received">üì• Received</option>
                            <option value="In Warehouse">üè≠ Warehouse</option>
                            <option value="Partially Deployed">üöö Partial</option>
                            <option value="Fully Deployed">‚úÖ Complete</option>
                        </select>
                        
                        <div className="relative flex-1 min-w-[200px] max-w-[350px]">
                            <Icon name="Search" size={14} className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" />
                            <input 
                                type="text"
                                placeholder="Search receipt #, client, description, printer..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-7 pr-8 py-1.5 border border-gray-300 rounded text-xs bg-white focus:ring-2 focus:ring-orange-300 focus:border-orange-400"
                            />
                            {searchTerm && (
                                <button 
                                    onClick={() => setSearchTerm('')}
                                    className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                >
                                    <Icon name="X" size={12} />
                                </button>
                            )}
                        </div>
                        
                        <div className="flex-1"></div>
                        
                        {/* Status badges */}
                        <div className="flex gap-1">
                            <span className="px-1 py-0.5 bg-blue-100 text-blue-700 rounded text-[9px]">üì•{stats.byStatus.received}</span>
                            <span className="px-1 py-0.5 bg-amber-100 text-amber-700 rounded text-[9px]">üè≠{stats.byStatus.inWarehouse}</span>
                            <span className="px-1 py-0.5 bg-purple-100 text-purple-700 rounded text-[9px]">üöö{stats.byStatus.partiallyDeployed}</span>
                            <span className="px-1 py-0.5 bg-green-100 text-green-700 rounded text-[9px]">‚úÖ{stats.byStatus.fullyDeployed}</span>
                        </div>
                        
                        {/* Analytics toggle */}
                        <button 
                            onClick={() => setShowAnalytics(!showAnalytics)}
                            className={`px-2 py-1 rounded text-[10px] font-medium flex items-center gap-1 ${showAnalytics ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                        >
                            <Icon name="TrendingUp" size={12} /> {showAnalytics ? 'Hide' : 'Stats'}
                        </button>
                    </div>

                    {/* Performance Analytics Panel - Compact */}
                    {showAnalytics && (
                        <div className="px-3 py-2 border-b bg-gradient-to-r from-orange-50 to-amber-50">
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-2 mb-2">
                                <div className="bg-white rounded p-2 border border-orange-200">
                                    <div className="text-[9px] text-gray-500 uppercase font-bold">Last 7 Days</div>
                                    <div className="text-lg font-bold text-orange-600">{analytics.recentReceipts}</div>
                                    <div className="text-[9px] text-gray-500">({analytics.recentUnits} units)</div>
                                </div>
                                <div className="bg-white rounded p-2 border border-green-200">
                                    <div className="text-[9px] text-gray-500 uppercase font-bold">Deploy Rate</div>
                                    <div className="text-lg font-bold text-green-600">{analytics.deploymentRate}%</div>
                                    <div className="text-[9px] text-gray-500">{analytics.totalDeployed}/{analytics.totalUnits}</div>
                                </div>
                                <div className="bg-white rounded p-2 border border-blue-200">
                                    <div className="text-[9px] text-gray-500 uppercase font-bold">Avg/Receipt</div>
                                    <div className="text-lg font-bold text-blue-600">{analytics.avgUnitsPerReceipt}</div>
                                    <div className="text-[9px] text-gray-500">units</div>
                                </div>
                                <div className="bg-white rounded p-2 border border-purple-200">
                                    <div className="text-[9px] text-gray-500 uppercase font-bold">Clients</div>
                                    <div className="text-lg font-bold text-purple-600">{analytics.clientRanking.length}</div>
                                    <div className="text-[9px] text-gray-500">active</div>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div className="bg-white rounded p-2 border border-gray-200">
                                    <div className="text-[10px] font-bold text-gray-700 mb-1">üìä Daily (14d)</div>
                                    <div className="flex items-end gap-px h-10">
                                        {analytics.dailyData.map((day, idx) => {
                                            const maxUnits = Math.max(...analytics.dailyData.map(d => d.units), 1);
                                            const height = (day.units / maxUnits) * 100;
                                            return (
                                                <div key={idx} className="flex-1">
                                                    <div 
                                                        className={`w-full rounded-t ${day.units > 0 ? 'bg-orange-400' : 'bg-gray-200'}`}
                                                        style={{ height: `${Math.max(height, 8)}%` }}
                                                        title={`${day.dateStr}: ${day.units} units`}
                                                    ></div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="bg-white rounded p-2 border border-gray-200">
                                    <div className="text-[10px] font-bold text-gray-700 mb-1">üë• Top Clients</div>
                                    <div className="space-y-0.5">
                                        {analytics.clientRanking.slice(0, 3).map((client, idx) => {
                                            const maxUnits = analytics.clientRanking[0]?.units || 1;
                                            const pct = (client.units / maxUnits) * 100;
                                            return (
                                                <div key={client.client} className="flex items-center gap-1">
                                                    <span className="text-[8px] text-gray-400 w-3">#{idx + 1}</span>
                                                    <span className="text-[9px] text-gray-700 truncate w-16">{client.client}</span>
                                                    <div className="flex-1 bg-gray-100 rounded h-1.5">
                                                        <div className="h-1.5 rounded bg-orange-400" style={{ width: `${pct}%` }}></div>
                                                    </div>
                                                    <span className="text-[8px] text-gray-500 w-6 text-right">{client.units}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Content */}
                    <div className="p-3">
                        {filteredMaterials.length === 0 ? (
                            <div className="text-center py-16">
                                <Icon name="Package" size={48} className="mx-auto text-gray-300 mb-4" />
                                <h3 className="text-lg font-semibold text-gray-500">No materials found</h3>
                                <p className="text-gray-400 text-sm mt-1">Try adjusting your filters or upload material receipts</p>
                            </div>
                        ) : viewMode === 'cards' ? (
                            /* Card View */
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {filteredMaterials.map(material => (
                                    <div 
                                        key={material.id}
                                        className="group cursor-pointer bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg hover:border-orange-300 transition-all relative"
                                    >
                                        {/* Delete button */}
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (confirm('Delete this receipt?')) {
                                                    setMaterials(prev => prev.filter(m => m.id !== material.id));
                                                }
                                            }}
                                            className="absolute top-2 left-2 z-10 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
                                            title="Delete"
                                        >
                                            <Icon name="X" size={14} />
                                        </button>
                                        
                                        <div onClick={() => setSelectedReceipt(material)}>
                                        {/* Poster Preview */}
                                        <div className="relative h-40 bg-gradient-to-br from-gray-100 to-gray-200">
                                            {material.posterImage ? (
                                                <img 
                                                    src={material.posterImage}
                                                    alt={material.description || 'Material receipt'}
                                                    className="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                    onError={(e) => {
                                                        // Replace with placeholder on error
                                                        e.target.style.display = 'none';
                                                        if (e.target.nextSibling) e.target.nextSibling.style.display = 'flex';
                                                    }}
                                                />
                                            ) : null}
                                            {/* Placeholder for missing/broken images */}
                                            <div 
                                                className="absolute inset-0 flex flex-col items-center justify-center text-gray-400"
                                                style={{ display: material.posterImage ? 'none' : 'flex' }}
                                            >
                                                <Icon name="Package" size={32} className="text-gray-300 mb-1" />
                                                <span className="text-[10px] text-gray-400 text-center px-2">
                                                    {material.originalFileLink ? 'Image unavailable' : 'No image'}
                                                </span>
                                                {material.originalFileLink && (
                                                    <a 
                                                        href={material.originalFileLink} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="text-[9px] text-blue-500 hover:underline mt-1"
                                                    >
                                                        Open original link ‚Üí
                                                    </a>
                                                )}
                                            </div>
                                            {/* Demo overlay - only show in demo mode when showing sample data */}
                                            {(hasNoData && showDemoTips) && (
                                                <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
                                                    <span className="bg-amber-500 text-white px-2 py-1 rounded text-[10px] font-bold transform -rotate-12">
                                                        SAMPLE IMAGE
                                                    </span>
                                                </div>
                                            )}
                                            {/* Quantity badge */}
                                            <div className="absolute top-2 right-2 bg-orange-500 text-white px-2 py-1 rounded-lg text-sm font-bold">
                                                üì¶ {material.quantity}
                                            </div>
                                            {/* Status badge */}
                                            <div className={`absolute bottom-2 left-2 px-2 py-1 rounded text-[10px] font-bold ${getStatusColor(material.status)}`}>
                                                {material.status}
                                            </div>
                                        </div>
                                        
                                        {/* Info */}
                                        <div className="p-3">
                                            <h4 className="font-bold text-gray-800 truncate">{material.client}</h4>
                                            <p className="text-xs text-gray-500 truncate">{material.description}</p>
                                            <div className="flex items-center justify-between mt-2">
                                                <span className="text-[10px] text-gray-400 font-mono">{material.receiptNumber}</span>
                                                <span className="text-[10px] text-gray-400">{typeof material.dateReceived === 'string' ? material.dateReceived : (material.dateReceived?.toLocaleDateString?.() || '')}</span>
                                            </div>
                                            {/* Deployment progress */}
                                            {material.deployedQty !== undefined && (
                                                <div className="mt-2">
                                                    <div className="flex justify-between text-[10px] text-gray-500 mb-1">
                                                        <span>Deployed</span>
                                                        <span>{material.deployedQty}/{material.quantity}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-1.5">
                                                        <div 
                                                            className="h-1.5 rounded-full bg-green-500"
                                                            style={{ width: `${(material.deployedQty / material.quantity) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            )}
                                            {/* Matched campaign indicator */}
                                            {material.matchedCampaign && (
                                                <div className="mt-2 text-[10px] text-green-600 flex items-center gap-1">
                                                    <Icon name="CheckCircle" size={10} /> Matched: {material.matchedCampaign}
                                                </div>
                                            )}
                                        </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : viewMode === 'list' ? (
                            /* Enhanced List View - Editable Table */
                            <div className="overflow-x-auto overflow-y-visible" style={{ overflow: 'visible' }}>
                                <table className="w-full text-sm border-collapse">
                                    <thead>
                                        <tr className="bg-gradient-to-r from-orange-500 to-amber-500 text-white">
                                            <th className="text-left p-2 font-semibold text-xs sticky left-0 bg-orange-500">Receipt #</th>
                                            <th className="text-left p-2 font-semibold text-xs">Date</th>
                                            <th className="text-left p-2 font-semibold text-xs">Client</th>
                                            <th className="text-left p-2 font-semibold text-xs min-w-[150px]">Description</th>
                                            <th className="text-center p-2 font-semibold text-xs">Qty</th>
                                            <th className="text-left p-2 font-semibold text-xs">Printer</th>
                                            <th className="text-center p-2 font-semibold text-xs">Source</th>
                                            <th className="text-left p-2 font-semibold text-xs">Status</th>
                                            <th className="text-left p-2 font-semibold text-xs min-w-[150px]">Campaign ID</th>
                                            <th className="text-left p-2 font-semibold text-xs min-w-[100px]">Comments</th>
                                            <th className="text-center p-2 font-semibold text-xs w-16">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredMaterials.map((material, idx) => (
                                            <tr 
                                                key={material.id}
                                                className={`border-b hover:bg-orange-50 transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
                                            >
                                                <td className="p-2 font-mono text-orange-600 font-medium text-xs sticky left-0 bg-inherit">
                                                    <EditableCell material={material} field="receiptNumber" className="text-orange-600 font-mono text-xs" />
                                                </td>
                                                <td className="p-2 text-xs">
                                                    <EditableCell material={material} field="dateReceived" className="text-gray-600 text-xs" />
                                                </td>
                                                <td className="p-2 text-xs">
                                                    <EditableCell material={material} field="client" className="font-medium text-gray-800 text-xs" />
                                                </td>
                                                <td className="p-2 text-xs">
                                                    <EditableCell material={material} field="description" className="text-gray-600 text-xs" />
                                                </td>
                                                <td className="p-2 text-center text-xs">
                                                    <EditableCell material={material} field="quantity" className="font-bold text-gray-800 text-center text-xs" type="number" />
                                                </td>
                                                <td className="p-2 text-xs">
                                                    <EditableCell material={material} field="printer" className="text-gray-600 text-xs" />
                                                </td>
                                                {/* Production Source - toggleable */}
                                                <td className="p-2 text-center text-xs">
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setMaterials(prev => prev.map(m => 
                                                                m.id === material.id 
                                                                    ? { ...m, productionSource: m.productionSource === 'in-house' ? 'client' : 'in-house' } 
                                                                    : m
                                                            ));
                                                        }}
                                                        className={`px-2 py-1 rounded text-[10px] font-medium cursor-pointer transition-colors ${
                                                            material.productionSource === 'in-house'
                                                                ? 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                                                                : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                                        }`}
                                                        title="Click to toggle production source"
                                                    >
                                                        {material.productionSource === 'in-house' 
                                                            ? <><Icon name="Home" size={10} /> In-House</>
                                                            : <><Icon name="Upload" size={10} /> Client</>
                                                        }
                                                    </button>
                                                </td>
                                                <td className="p-2 text-xs">
                                                    {editingCell?.id === material.id && editingCell?.field === 'status' ? (
                                                        <select
                                                            value={editValue}
                                                            onChange={(e) => {
                                                                setEditValue(e.target.value);
                                                                // Auto-save on select change
                                                                setTimeout(() => {
                                                                    setMaterials(prev => prev.map(m => 
                                                                        m.id === material.id ? { ...m, status: e.target.value } : m
                                                                    ));
                                                                    setEditingCell(null);
                                                                }, 0);
                                                            }}
                                                            onBlur={() => setEditingCell(null)}
                                                            className="text-xs border rounded px-1 py-0.5"
                                                            autoFocus
                                                        >
                                                            <option value="Received">üì• Received at Warehouse</option>
                                                            <option value="Material Ready">üìã Material Ready for Install</option>
                                                            <option value="Deployed">üöö Deployed (Work Orders Sent)</option>
                                                            <option value="Installed">‚úÖ Installed</option>
                                                        </select>
                                                    ) : (
                                                        <span 
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                startEditing(material.id, 'status', material.status);
                                                            }}
                                                            className={`px-2 py-0.5 rounded text-[10px] font-medium cursor-pointer ${getStatusColor(material.status)}`}
                                                            title="Click to change status"
                                                        >
                                                            {material.status}
                                                        </span>
                                                    )}
                                                </td>
                                                {/* Campaign ID Column - Searchable */}
                                                <td className="p-2 text-xs" style={{ overflow: 'visible' }}>
                                                    {editingCell?.id === material.id && editingCell?.field === 'campaignId' ? (
                                                        <div style={{ position: 'relative' }}>
                                                            <input
                                                                type="text"
                                                                placeholder="Search advertiser, campaign..."
                                                                value={campaignSearchTerm}
                                                                onChange={(e) => setCampaignSearchTerm(e.target.value)}
                                                                className="text-xs border-2 border-orange-400 rounded px-2 py-1 w-full min-w-[200px] focus:outline-none"
                                                                autoFocus
                                                            />
                                                            <div 
                                                                className="bg-white border border-gray-300 rounded-lg shadow-2xl max-h-72 overflow-auto"
                                                                style={{ 
                                                                    position: 'fixed',
                                                                    zIndex: 9999,
                                                                    width: '320px',
                                                                    marginTop: '4px'
                                                                }}
                                                            >
                                                                {/* Quick options */}
                                                                <div 
                                                                    onClick={() => {
                                                                        setMaterials(prev => prev.map(m => 
                                                                            m.id === material.id ? { ...m, campaignId: '', matchedCampaign: null } : m
                                                                        ));
                                                                        setEditingCell(null);
                                                                        setCampaignSearchTerm('');
                                                                    }}
                                                                    className="px-3 py-2 hover:bg-gray-100 cursor-pointer text-gray-500 border-b"
                                                                >
                                                                    ‚úñÔ∏è Clear / Unassign
                                                                </div>
                                                                <div 
                                                                    onClick={() => {
                                                                        setMaterials(prev => prev.map(m => 
                                                                            m.id === material.id ? { ...m, campaignId: '__PENDING__', matchedCampaign: 'Pending' } : m
                                                                        ));
                                                                        setEditingCell(null);
                                                                        setCampaignSearchTerm('');
                                                                    }}
                                                                    className="px-3 py-2 hover:bg-amber-50 cursor-pointer text-amber-700 border-b"
                                                                >
                                                                    ‚è≥ Mark as Pending
                                                                </div>
                                                                
                                                                {/* Filtered campaigns - only show when searching */}
                                                                {campaignSearchTerm.length >= 2 ? (
                                                                    (() => {
                                                                        const search = campaignSearchTerm.toLowerCase().trim();
                                                                        
                                                                        // Filter campaigns that match search
                                                                        const matchingCampaigns = data.filter(c => {
                                                                            const advertiser = String(c['Advertiser'] || c.advertiser || c.client || '').toLowerCase();
                                                                            const campaignId = String(c['Campaign ID'] || c.campaignId || c.id || '').toLowerCase();
                                                                            const flightName = String(c['Flight Name'] || c.flightName || c.title || c.name || '').toLowerCase();
                                                                            const market = String(c['Market'] || c.market || '').toLowerCase();
                                                                            const mediaType = String(c['Media Type'] || c.mediaType || '').toLowerCase();
                                                                            
                                                                            return advertiser.includes(search) ||
                                                                                campaignId.includes(search) ||
                                                                                flightName.includes(search) ||
                                                                                market.includes(search) ||
                                                                                mediaType.includes(search);
                                                                        });
                                                                        
                                                                        // De-duplicate by Campaign ID (keep first occurrence)
                                                                        const seen = new Set();
                                                                        const uniqueCampaigns = matchingCampaigns.filter(c => {
                                                                            const id = c['Campaign ID'] || c.id || '';
                                                                            if (seen.has(id)) return false;
                                                                            seen.add(id);
                                                                            return true;
                                                                        });
                                                                        
                                                                        console.log(`üîç "${search}" - Found ${uniqueCampaigns.length} unique campaigns (${matchingCampaigns.length} total matches)`);
                                                                        
                                                                        if (uniqueCampaigns.length === 0) {
                                                                            return (
                                                                                <div className="px-3 py-4 text-center text-gray-400 text-xs">
                                                                                    No campaigns found for "{campaignSearchTerm}"
                                                                                </div>
                                                                            );
                                                                        }
                                                                        
                                                                        // Debug: log first campaign's keys to see field names
                                                                        if (uniqueCampaigns.length > 0) {
                                                                            console.log('üìã Campaign fields:', Object.keys(uniqueCampaigns[0]));
                                                                            console.log('üìã First campaign:', uniqueCampaigns[0]);
                                                                        }
                                                                        
                                                                        return uniqueCampaigns.slice(0, 30).map((campaign, idx) => {
                                                                            // Try to find the best name/title for this campaign
                                                                            const campaignName = campaign['Flight Name'] || campaign['Campaign Name'] || campaign['Name'] || 
                                                                                campaign['Title'] || campaign.flightName || campaign.campaignName || 
                                                                                campaign.name || campaign.title || '';
                                                                            const advertiser = campaign['Advertiser'] || campaign.advertiser || campaign['Client'] || campaign.client || 'Unknown';
                                                                            const market = campaign['Market'] || campaign.market || '';
                                                                            const mediaType = campaign['Media Type'] || campaign['Product'] || campaign.mediaType || '';
                                                                            const campaignId = campaign['Campaign ID'] || campaign.id || '';
                                                                            
                                                                            return (
                                                                            <div
                                                                                key={`campaign-${idx}-${campaignId}`}
                                                                                onClick={() => {
                                                                                    setMaterials(prev => prev.map(m => 
                                                                                        m.id === material.id ? { 
                                                                                            ...m, 
                                                                                            campaignId: campaignId,
                                                                                            matchedCampaign: `${advertiser}${campaignName ? ' - ' + campaignName : ''}`,
                                                                                            // Auto-inherit production source from campaign
                                                                                            productionSource: campaign.productionProof || m.productionSource
                                                                                        } : m
                                                                                    ));
                                                                                    setEditingCell(null);
                                                                                    setCampaignSearchTerm('');
                                                                                }}
                                                                                className="px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-gray-100"
                                                                            >
                                                                                <div className="font-medium text-gray-800 flex items-center gap-2">
                                                                                    {advertiser}
                                                                                    {/* Show production source badge if available */}
                                                                                    {campaign.productionProof && (
                                                                                        <ProductionIcon type={campaign.productionProof} size={12} compact />
                                                                                    )}
                                                                                </div>
                                                                                <div className="text-[10px] text-gray-500 flex gap-2">
                                                                                    <span className="font-mono text-orange-600">{campaignId}</span>
                                                                                    {campaignName && (
                                                                                        <>
                                                                                            <span>‚Ä¢</span>
                                                                                            <span className="truncate">{campaignName}</span>
                                                                                        </>
                                                                                    )}
                                                                                </div>
                                                                                {(market || mediaType) && (
                                                                                    <div className="text-[9px] text-gray-400">
                                                                                        {market}{market && mediaType ? ' ‚Ä¢ ' : ''}{mediaType}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        )});
                                                                    })()
                                                                ) : (
                                                                    <div className="px-3 py-4 text-center text-gray-400 text-xs">
                                                                        Type at least 2 characters to search {data.length.toLocaleString()} campaigns
                                                                    </div>
                                                                )}
                                                            </div>
                                                            {/* Click outside to close */}
                                                            <div 
                                                                className="fixed inset-0" 
                                                                style={{ zIndex: 9998 }}
                                                                onClick={() => { setEditingCell(null); setCampaignSearchTerm(''); }}
                                                            ></div>
                                                        </div>
                                                    ) : (
                                                        <span 
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                startEditing(material.id, 'campaignId', material.campaignId || '');
                                                                setCampaignSearchTerm('');
                                                            }}
                                                            className={`px-2 py-0.5 rounded text-[10px] font-medium cursor-pointer block truncate max-w-[140px] ${
                                                                material.campaignId && material.campaignId !== '__PENDING__'
                                                                    ? 'bg-green-100 text-green-700 border border-green-300'
                                                                    : material.campaignId === '__PENDING__'
                                                                    ? 'bg-amber-100 text-amber-700 border border-amber-300'
                                                                    : 'bg-gray-100 text-gray-500 border border-gray-200 hover:bg-gray-200'
                                                            }`}
                                                            title={material.matchedCampaign || 'Click to assign campaign'}
                                                        >
                                                            {material.campaignId && material.campaignId !== '__PENDING__' 
                                                                ? (material.campaignId.length > 12 ? material.campaignId.substring(0, 12) + '...' : material.campaignId)
                                                                : material.campaignId === '__PENDING__'
                                                                ? '‚è≥ Pending'
                                                                : 'üîç Search...'}
                                                        </span>
                                                    )}
                                                    {material.matchedCampaign && material.campaignId !== '__PENDING__' && (
                                                        <div className="text-[9px] text-green-600 truncate mt-0.5" title={material.matchedCampaign}>
                                                            {material.matchedCampaign}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="p-2 text-xs">
                                                    <EditableCell material={material} field="comments" className="text-gray-500 text-xs" />
                                                </td>
                                                <td className="p-2 text-center">
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button
                                                            onClick={() => setSelectedReceipt(material)}
                                                            className="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"
                                                            title="View details"
                                                        >
                                                            <Icon name="Eye" size={14} />
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                if (confirm('Delete this receipt?')) {
                                                                    setMaterials(prev => prev.filter(m => m.id !== material.id));
                                                                }
                                                            }}
                                                            className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"
                                                            title="Delete"
                                                        >
                                                            <Icon name="Trash2" size={14} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filteredMaterials.length > 0 && (
                                    <div className="text-xs text-gray-500 p-2 bg-gray-50 border-t">
                                        üí° Click any cell to edit ‚Ä¢ Changes auto-save to localStorage {webhookUrl && '& sync to Google Sheet'}
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* Enhanced Timeline View with Journey Stages */
                            <div className="space-y-4">
                                {filteredMaterials.map((material, idx) => {
                                    // Determine journey stage based on status and campaign match
                                    const getJourneyStage = () => {
                                        // Check if linked to a campaign that's installed
                                        const linkedCampaign = material.campaignId && data.find(c => 
                                            (c['Campaign ID'] || c.id) === material.campaignId
                                        );
                                        const campaignStage = linkedCampaign?.['Install Stage']?.toLowerCase() || '';
                                        
                                        if (campaignStage.includes('installed') || campaignStage.includes('complete') || material.status === 'Installed') {
                                            return 4; // Installed
                                        }
                                        if (material.status === 'Deployed' || material.status === 'Fully Deployed' || material.status === 'Partially Deployed') return 3;
                                        if (material.status === 'Material Ready' || material.status === 'Material Ready for Install') return 2;
                                        return 1; // Received at Warehouse
                                    };
                                    
                                    const journeyStage = getJourneyStage();
                                    const isInHouse = material.productionSource === 'in-house';
                                    
                                    // Core stages (always shown) - Your warehouse workflow
                                    const coreStages = [
                                        { num: 1, label: 'Received', sublabel: 'At Warehouse', icon: 'üì•', color: 'blue' },
                                        { num: 2, label: 'Material Ready', sublabel: 'For Install', icon: 'üìã', color: 'amber' },
                                        { num: 3, label: 'Deployed', sublabel: 'Work Orders Sent', icon: 'üöö', color: 'purple' },
                                        { num: 4, label: 'Installed', sublabel: 'Complete', icon: '‚úÖ', color: 'green' }
                                    ];
                                    
                                    // Extended stages for in-house production (pre-warehouse)
                                    const inHousePreStages = [
                                        { num: -3, label: 'Proofs', sublabel: 'Approved', icon: '‚úì', color: 'slate', pre: true },
                                        { num: -2, label: 'Printing', sublabel: 'In Progress', icon: 'üñ®Ô∏è', color: 'slate', pre: true },
                                        { num: -1, label: 'Material', sublabel: 'Ready', icon: 'üì¶', color: 'slate', pre: true },
                                        { num: 0, label: 'Shipped', sublabel: 'To Warehouse', icon: 'üöõ', color: 'slate', pre: true },
                                    ];
                                    
                                    // Client workflow pre-stage
                                    const clientPreStages = [
                                        { num: 0, label: 'Contract', sublabel: 'Signed', icon: 'üìù', color: 'slate', pre: true },
                                    ];
                                    
                                    const allStages = isInHouse 
                                        ? [...inHousePreStages, ...coreStages]
                                        : [...clientPreStages, ...coreStages];
                                    
                                    const totalSteps = allStages.length - 1;
                                    const currentIndex = allStages.findIndex(s => s.num === Math.floor(journeyStage));
                                    const progressPercent = currentIndex >= 0 ? (currentIndex / totalSteps) * 100 : 0;
                                    
                                    return (
                                        <div 
                                            key={material.id}
                                            className="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg hover:border-orange-300 transition-all group"
                                        >
                                            {/* Header with client info */}
                                            <div className="bg-gradient-to-r from-slate-800 to-slate-700 px-4 py-3 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center">
                                                        <Icon name="Package" size={20} className="text-orange-400" />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-white">{material.client || 'Unknown Client'}</h4>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-slate-400 font-mono">{material.receiptNumber}</span>
                                                            {/* Production source badge */}
                                                            <span className={`text-[9px] px-1.5 py-0.5 rounded flex items-center gap-1 ${
                                                                isInHouse 
                                                                    ? 'bg-purple-500/30 text-purple-300' 
                                                                    : 'bg-blue-500/30 text-blue-300'
                                                            }`}>
                                                                <Icon name={isInHouse ? 'Home' : 'Upload'} size={10} />
                                                                {isInHouse ? 'In-House' : 'Client-Produced'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-2xl font-bold text-orange-400">{material.quantity}</div>
                                                    <div className="text-[10px] text-slate-400">units</div>
                                                </div>
                                            </div>
                                            
                                            {/* Journey Timeline */}
                                            <div className="px-4 py-4">
                                                <div className="relative">
                                                    {/* Progress line background */}
                                                    <div className="absolute top-5 left-0 right-0 h-1 bg-gray-200 rounded-full"></div>
                                                    {/* Progress line fill */}
                                                    <div 
                                                        className="absolute top-5 left-0 h-1 rounded-full transition-all duration-500"
                                                        style={{ 
                                                            width: `${Math.min(progressPercent, 100)}%`,
                                                            background: 'linear-gradient(to right, #94a3b8, #3b82f6, #f59e0b, #8b5cf6, #22c55e)'
                                                        }}
                                                    ></div>
                                                    
                                                    {/* Stage dots */}
                                                    <div className="relative flex justify-between">
                                                        {allStages.map((stage, i) => {
                                                            const isActive = journeyStage >= stage.num;
                                                            const isCurrent = Math.floor(journeyStage) === stage.num;
                                                            const isPre = stage.pre;
                                                            
                                                            return (
                                                                <div key={`${stage.num}-${stage.label}`} className="flex flex-col items-center" style={{ minWidth: isPre ? '50px' : '65px' }}>
                                                                    <div 
                                                                        className={`rounded-full flex items-center justify-center transition-all ${
                                                                            isPre ? 'w-7 h-7 text-xs' : 'w-10 h-10 text-lg'
                                                                        }`}
                                                                        style={{
                                                                            backgroundColor: isActive 
                                                                                ? stage.color === 'blue' ? '#3b82f6' 
                                                                                : stage.color === 'amber' ? '#f59e0b'
                                                                                : stage.color === 'purple' ? '#8b5cf6'
                                                                                : stage.color === 'green' ? '#22c55e'
                                                                                : '#64748b'
                                                                                : '#e5e7eb',
                                                                            color: isActive ? 'white' : '#9ca3af',
                                                                            boxShadow: isCurrent && !isPre ? `0 0 0 4px ${
                                                                                stage.color === 'blue' ? '#dbeafe' 
                                                                                : stage.color === 'amber' ? '#fef3c7'
                                                                                : stage.color === 'purple' ? '#ede9fe'
                                                                                : stage.color === 'green' ? '#dcfce7'
                                                                                : '#f1f5f9'
                                                                            }` : 'none',
                                                                            transform: isCurrent && !isPre ? 'scale(1.15)' : 'scale(1)',
                                                                            opacity: isPre && !isActive ? 0.5 : 1
                                                                        }}
                                                                    >
                                                                        {stage.icon}
                                                                    </div>
                                                                    <span className={`mt-1.5 font-medium text-center leading-tight ${isPre ? 'text-[8px]' : 'text-[9px]'} ${isActive ? 'text-gray-700' : 'text-gray-400'}`}>
                                                                        {stage.label}
                                                                    </span>
                                                                    <span className={`text-center leading-tight ${isPre ? 'text-[7px]' : 'text-[8px]'} ${isActive ? 'text-gray-500' : 'text-gray-300'}`}>
                                                                        {stage.sublabel}
                                                                    </span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Details section */}
                                            <div className="px-4 pb-4 border-t border-gray-100 pt-3">
                                                <div className="flex items-center justify-between flex-wrap gap-2">
                                                    <div className="flex items-center gap-4 text-xs text-gray-500">
                                                        <span className="flex items-center gap-1">
                                                            <Icon name="Calendar" size={12} />
                                                            {typeof material.dateReceived === 'string' 
                                                                ? material.dateReceived 
                                                                : (material.dateReceived?.toLocaleDateString?.() || 'N/A')}
                                                        </span>
                                                        {material.printer && (
                                                            <span className="flex items-center gap-1">
                                                                <Icon name="Printer" size={12} />
                                                                {material.printer}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {material.matchedCampaign ? (
                                                            <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-[10px] font-medium flex items-center gap-1">
                                                                <Icon name="Link" size={10} /> {material.matchedCampaign.length > 20 ? material.matchedCampaign.substring(0, 20) + '...' : material.matchedCampaign}
                                                            </span>
                                                        ) : (
                                                            <span className="px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-[10px]">
                                                                No campaign linked
                                                            </span>
                                                        )}
                                                        <button 
                                                            onClick={() => setSelectedReceipt(material)}
                                                            className="px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-xs font-medium transition-colors flex items-center gap-1"
                                                        >
                                                            <Icon name="Eye" size={12} /> Details
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {/* Description */}
                                                {material.description && (
                                                    <p className="text-xs text-gray-500 mt-2 truncate">{material.description}</p>
                                                )}
                                                
                                                {/* Deployment Progress Bar (if partially deployed) */}
                                                {material.deployedQty !== undefined && material.deployedQty > 0 && (
                                                    <div className="mt-3 bg-gray-50 rounded-lg p-2">
                                                        <div className="flex justify-between text-[10px] text-gray-600 mb-1">
                                                            <span className="font-medium">Deployment Progress</span>
                                                            <span>{material.deployedQty} / {material.quantity} units ({Math.round((material.deployedQty / material.quantity) * 100)}%)</span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className="h-2 rounded-full bg-gradient-to-r from-purple-500 to-green-500 transition-all"
                                                                style={{ width: `${(material.deployedQty / material.quantity) * 100}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Receipt Detail Modal */}
                    {selectedReceipt && (
                        <ReceiptModal 
                            receipt={selectedReceipt}
                            onClose={() => setSelectedReceipt(null)}
                        />
                    )}
                    
                    {/* Link Google Sheet Modal */}
                    <LinkSheetModal />
                    
                    {/* Webhook Setup Modal */}
                    <WebhookSetupModal />
                </div>
            );
        };

        const POPGallery = ({ data: rawData, onBack, setView, showDemoTips = false }) => {
            // Safety: ensure data is always an array
            const data = Array.isArray(rawData) ? rawData : [];
            
            const [viewMode, setViewMode] = useState('campaigns'); // 'campaigns', 'grid', or 'list'
            const [selectedMarket, setSelectedMarket] = useState('ALL');
            const [selectedAdvertiser, setSelectedAdvertiser] = useState('ALL');
            const [selectedCampaign, setSelectedCampaign] = useState('ALL');
            const [selectedStatus, setSelectedStatus] = useState('ALL'); // NEW: Status filter
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [sortBy, setSortBy] = useState('date-desc'); // 'date-desc', 'date-asc', 'advertiser', 'campaign'
            const [expandedCampaign, setExpandedCampaign] = useState(null); // For viewing all photos in a campaign
            
            // Local Folder State
            const [linkedFolder, setLinkedFolder] = useState(null); // Folder handle
            const [localPhotos, setLocalPhotos] = useState([]); // Photos from local folder
            const [scanningFolder, setScanningFolder] = useState(false);
            const [folderError, setFolderError] = useState(null);
            // Only show demo data if in demo mode (showDemoTips), otherwise start with empty/production mode
            const [showDemoData, setShowDemoData] = useState(showDemoTips);
            
            // Google Sheet POP Log State
            const [popSheetUrl, setPopSheetUrl] = useState(localStorage.getItem('stap_pop_sheet_url') || '');
            const [popCampaigns, setPopCampaigns] = useState([]);
            const [popLoading, setPopLoading] = useState(false);
            const [popError, setPopError] = useState('');
            const [popLastSync, setPopLastSync] = useState(null);
            const [showPopLinkModal, setShowPopLinkModal] = useState(false);
            
            // ============================================
            // PHOTO ANALYSIS STATE (OCR & Recognition)
            // ============================================
            const [photoAnalysis, setPhotoAnalysis] = useState({}); // { photoId: { text, matchScore, flags, analyzing } }
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysisQueue, setAnalysisQueue] = useState([]);
            const [showAnalysisPanel, setShowAnalysisPanel] = useState(false);

            // Fetch POP data from Google Sheet
            const handleConnectPopSheet = async () => {
                if (!popSheetUrl) return;
                
                setPopLoading(true);
                setPopError('');
                
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(popSheetUrl)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const text = await response.text();
                    const lines = text.split('\n').filter(l => l.trim());
                    
                    if (lines.length < 2) throw new Error('No data found in spreadsheet');
                    
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
                    const campaigns = lines.slice(1).map((line, idx) => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;
                        for (let char of line) {
                            if (char === '"') inQuotes = !inQuotes;
                            else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());
                        
                        // Map to object
                        const row = {};
                        headers.forEach((h, i) => row[h] = values[i] || '');
                        
                        // Find folder link
                        let folderLink = null;
                        for (const [key, value] of Object.entries(row)) {
                            if (value && typeof value === 'string' && (value.includes('drive.google.com') || value.includes('http'))) {
                                folderLink = value;
                                break;
                            }
                        }
                        
                        // Auto-detect fields
                        const getField = (keywords) => {
                            for (const [key, value] of Object.entries(row)) {
                                if (keywords.some(k => key.includes(k)) && value) return value;
                            }
                            return '';
                        };
                        
                        return {
                            id: `pop-${idx}`,
                            campaignNumber: getField(['campaign', 'id', 'number']) || `POP-${idx}`,
                            advertiser: getField(['advertiser', 'client', 'customer']) || 'Unknown',
                            description: getField(['desc', 'location', 'address', 'site']) || '',
                            market: getField(['market', 'city']) || 'Los Angeles',
                            installDate: getField(['date', 'install']),
                            folderLink: folderLink,
                            hasEvidence: !!folderLink
                        };
                    }).filter(c => c.campaignNumber || c.advertiser);
                    
                    setPopCampaigns(campaigns);
                    setPopLastSync(new Date());
                    localStorage.setItem('stap_pop_sheet_url', popSheetUrl);
                    setShowPopLinkModal(false);
                    
                    console.log(`üì∏ Loaded ${campaigns.length} POP campaigns from Google Sheet`);
                } catch (err) {
                    console.error('Failed to fetch POP sheet:', err);
                    setPopError(`Failed to connect: ${err.message}`);
                } finally {
                    setPopLoading(false);
                }
            };

            // Load saved POP sheet URL on mount and auto-reconnect
            useEffect(() => {
                const savedUrl = localStorage.getItem('stap_pop_sheet_url');
                if (savedUrl) {
                    setPopSheetUrl(savedUrl);
                    // Auto-fetch POP data
                    const autoFetchPOPs = async () => {
                        setPopLoading(true);
                        try {
                            let csvUrl = savedUrl;
                            const match = savedUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                            if (match) {
                                const sheetId = match[1];
                                const gidMatch = savedUrl.match(/gid=(\d+)/);
                                const gid = gidMatch ? gidMatch[1] : '0';
                                csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                            }
                            
                            const response = await fetch(csvUrl);
                            if (!response.ok) throw new Error('Failed to fetch');
                            const text = await response.text();
                            const lines = text.split('\n').filter(l => l.trim());
                            if (lines.length < 2) throw new Error('No data');
                            
                            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
                            const campaigns = lines.slice(1).map((line, idx) => {
                                const values = [];
                                let current = '';
                                let inQuotes = false;
                                for (const char of line) {
                                    if (char === '"') inQuotes = !inQuotes;
                                    else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
                                    else current += char;
                                }
                                values.push(current.trim());
                                
                                const row = {};
                                headers.forEach((h, i) => row[h] = values[i] || '');
                                
                                return {
                                    id: row['campaign id'] || row['id'] || `pop_${idx}`,
                                    advertiser: row['advertiser'] || row['client'] || '',
                                    campaign: row['campaign'] || row['campaign name'] || '',
                                    market: row['market'] || '',
                                    product: row['product type'] || row['product'] || '',
                                    startDate: row['start date'] || row['start'] || '',
                                    endDate: row['end date'] || row['end'] || '',
                                    address: row['address'] || row['location'] || '',
                                    popUrl: row['pop url'] || row['pop'] || row['image'] || '',
                                    status: row['status'] || 'Pending'
                                };
                            });
                            
                            setPopCampaigns(campaigns.filter(c => c.advertiser || c.campaign));
                            setPopLastSync(new Date());
                            console.log(`üì∑ Auto-reconnected: Loaded ${campaigns.length} POPs from Google Sheet`);
                        } catch (err) {
                            console.error('POP auto-reconnect failed:', err);
                        } finally {
                            setPopLoading(false);
                        }
                    };
                    autoFetchPOPs();
                }
            }, []);

            // Generate expected keywords from campaign data
            const getExpectedKeywords = (photo) => {
                const keywords = new Set();
                
                // Add advertiser name and variations
                if (photo.advertiser) {
                    photo.advertiser.split(/[\s-]+/).forEach(word => {
                        if (word.length > 2) keywords.add(word.toLowerCase());
                    });
                }
                
                // Add campaign name words
                if (photo.campaign) {
                    photo.campaign.split(/[\s-]+/).forEach(word => {
                        if (word.length > 2) keywords.add(word.toLowerCase());
                    });
                }
                
                // Add product type
                if (photo.product) {
                    photo.product.split(/[\s-]+/).forEach(word => {
                        if (word.length > 2) keywords.add(word.toLowerCase());
                    });
                }
                
                // Common ad-related words to look for
                const commonAdWords = ['sale', 'new', 'now', 'free', 'limited', 'exclusive', 'shop', 'buy', 'get', 'save', 'offer'];
                
                return {
                    primary: [...keywords], // Must match at least one
                    common: commonAdWords
                };
            };

            // Calculate match score between detected text and expected keywords
            const calculateMatchScore = (detectedText, expectedKeywords) => {
                if (!detectedText || detectedText.length < 3) {
                    return { score: 0, matched: [], unmatched: [], suspicious: [] };
                }
                
                const words = detectedText.toLowerCase().split(/[\s\n\r]+/).filter(w => w.length > 2);
                const matched = [];
                const suspicious = [];
                
                // Check for primary keyword matches
                expectedKeywords.primary.forEach(keyword => {
                    if (words.some(w => w.includes(keyword) || keyword.includes(w))) {
                        matched.push(keyword);
                    }
                });
                
                // Check for suspicious/graffiti words
                const graffitiPatterns = ['tag', 'crew', 'fuck', 'shit', 'dick', 'ass', 'hate', 'kill', 'gang'];
                words.forEach(word => {
                    if (graffitiPatterns.some(pattern => word.includes(pattern))) {
                        suspicious.push(word);
                    }
                });
                
                // Also flag random letter combinations (potential graffiti tags)
                words.forEach(word => {
                    // If word is 2-4 chars, all caps style, and not a known word
                    if (word.length >= 2 && word.length <= 5 && 
                        !expectedKeywords.primary.includes(word) && 
                        !expectedKeywords.common.includes(word) &&
                        /^[a-z]+$/.test(word)) {
                        // Could be a graffiti tag - flag if it seems random
                        const vowels = (word.match(/[aeiou]/g) || []).length;
                        if (vowels === 0 || vowels > 3) {
                            suspicious.push(word);
                        }
                    }
                });
                
                // Calculate score
                const primaryMatches = matched.length;
                const primaryTotal = expectedKeywords.primary.length || 1;
                const score = Math.min(100, Math.round((primaryMatches / primaryTotal) * 100));
                
                return {
                    score,
                    matched,
                    unmatched: expectedKeywords.primary.filter(k => !matched.includes(k)),
                    suspicious: [...new Set(suspicious)],
                    totalWords: words.length,
                    detectedText: detectedText.substring(0, 500) // Truncate for display
                };
            };

            // Analyze a single photo using Tesseract OCR
            const analyzePhoto = async (photo) => {
                if (!photo || !photo.photoUrl) return null;
                
                // Mark as analyzing
                setPhotoAnalysis(prev => ({
                    ...prev,
                    [photo.id]: { ...prev[photo.id], analyzing: true }
                }));
                
                try {
                    // Check if Tesseract is available
                    if (typeof Tesseract === 'undefined') {
                        throw new Error('Tesseract.js not loaded');
                    }
                    
                    console.log('Analyzing photo:', photo.id);
                    
                    // Run OCR
                    const result = await Tesseract.recognize(
                        photo.photoUrl,
                        'eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    // Could update progress here
                                    console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                                }
                            }
                        }
                    );
                    
                    const detectedText = result.data.text;
                    const expectedKeywords = getExpectedKeywords(photo);
                    const matchResult = calculateMatchScore(detectedText, expectedKeywords);
                    
                    // Determine flags
                    const flags = [];
                    if (matchResult.score < 30) flags.push('LOW_MATCH');
                    if (matchResult.score === 0 && detectedText.length > 10) flags.push('WRONG_POSTER');
                    if (matchResult.suspicious.length > 0) flags.push('GRAFFITI_DETECTED');
                    if (detectedText.length < 5) flags.push('NO_TEXT_FOUND');
                    if (matchResult.score >= 70) flags.push('VERIFIED');
                    
                    const analysis = {
                        analyzing: false,
                        timestamp: new Date(),
                        text: detectedText,
                        ...matchResult,
                        flags,
                        confidence: result.data.confidence,
                        expectedKeywords: expectedKeywords.primary
                    };
                    
                    setPhotoAnalysis(prev => ({
                        ...prev,
                        [photo.id]: analysis
                    }));
                    
                    return analysis;
                    
                } catch (error) {
                    console.error('OCR Error:', error);
                    
                    setPhotoAnalysis(prev => ({
                        ...prev,
                        [photo.id]: {
                            analyzing: false,
                            error: error.message,
                            flags: ['SCAN_ERROR']
                        }
                    }));
                    
                    return null;
                }
            };

            // Analyze all photos in a campaign
            const analyzeCampaign = async (campaign) => {
                if (!campaign || !campaign.photos) return;
                
                setIsAnalyzing(true);
                const results = [];
                
                for (let i = 0; i < campaign.photos.length; i++) {
                    const photo = campaign.photos[i];
                    // Skip already analyzed
                    if (photoAnalysis[photo.id] && !photoAnalysis[photo.id].error) {
                        results.push(photoAnalysis[photo.id]);
                        continue;
                    }
                    
                    const result = await analyzePhoto(photo);
                    if (result) results.push(result);
                    
                    // Small delay to prevent UI freeze
                    await new Promise(r => setTimeout(r, 100));
                }
                
                setIsAnalyzing(false);
                return results;
            };

            // Get campaign analysis summary
            const getCampaignAnalysisSummary = (campaign) => {
                if (!campaign || !campaign.photos) return null;
                
                const analyzed = campaign.photos.filter(p => photoAnalysis[p.id] && !photoAnalysis[p.id].analyzing);
                if (analyzed.length === 0) return null;
                
                const verified = analyzed.filter(p => photoAnalysis[p.id].flags?.includes('VERIFIED')).length;
                const issues = analyzed.filter(p => 
                    photoAnalysis[p.id].flags?.includes('GRAFFITI_DETECTED') ||
                    photoAnalysis[p.id].flags?.includes('LOW_MATCH') ||
                    photoAnalysis[p.id].flags?.includes('WRONG_POSTER')
                ).length;
                const avgScore = Math.round(analyzed.reduce((sum, p) => sum + (photoAnalysis[p.id].score || 0), 0) / analyzed.length);
                
                return {
                    analyzed: analyzed.length,
                    total: campaign.photos.length,
                    verified,
                    issues,
                    avgScore,
                    needsReview: issues > 0
                };
            };
            
            // Debug: Log data received
            console.log('POPGallery received data:', data.length, 'campaigns');

            // Debug: Log data received
            console.log('POPGallery received data:', data.length, 'campaigns');
            
            // NOTE: No pre-populated fake analysis - let real OCR run on actual photos
            // Demo photos are placeholders - real install photos would be scanned

            // Scan local folder for photos
            // Expected structure: Market / Campaign ID / Date (optional) / photos
            const scanFolder = async (dirHandle, path = '') => {
                const photos = [];
                
                try {
                    for await (const entry of dirHandle.values()) {
                        const entryPath = path ? `${path}/${entry.name}` : entry.name;
                        
                        if (entry.kind === 'directory') {
                            // Recurse into subdirectory
                            const subPhotos = await scanFolder(entry, entryPath);
                            photos.push(...subPhotos);
                        } else if (entry.kind === 'file') {
                            // Check if it's an image
                            const ext = entry.name.toLowerCase().split('.').pop();
                            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic'].includes(ext)) {
                                // Parse path: Market / Campaign ID / Date / photo
                                const pathParts = entryPath.split('/');
                                let market = '', campaignId = '', dateStr = '', fileName = entry.name;
                                
                                if (pathParts.length >= 2) {
                                    market = pathParts[0];
                                    campaignId = pathParts[1];
                                    if (pathParts.length >= 3) {
                                        // Check if 3rd part is a date or just the filename
                                        const possibleDate = pathParts[2];
                                        if (possibleDate.match(/^\d{4}-\d{2}-\d{2}$/) || possibleDate.match(/^\d{2}-\d{2}-\d{4}$/)) {
                                            dateStr = possibleDate;
                                            fileName = pathParts[3] || entry.name;
                                        } else if (pathParts.length === 3) {
                                            // No date folder, file is directly under campaign
                                            fileName = possibleDate;
                                        }
                                    }
                                }
                                
                                // Get file for creating object URL
                                const file = await entry.getFile();
                                const objectUrl = URL.createObjectURL(file);
                                
                                // Parse install date
                                let installDate = new Date();
                                if (dateStr) {
                                    const parsed = new Date(dateStr);
                                    if (!isNaN(parsed.getTime())) {
                                        installDate = parsed;
                                    }
                                }
                                
                                // Try to match campaign ID to uploaded data for more details
                                const matchedCampaign = data.find(d => d.campaignNumber === campaignId);
                                
                                photos.push({
                                    id: `local-${entryPath}`,
                                    campaignNumber: campaignId,
                                    market: market,
                                    advertiser: matchedCampaign?.advertiser || 'Unknown',
                                    campaign: matchedCampaign?.campaign || campaignId,
                                    product: matchedCampaign?.product || 'Unknown',
                                    quantity: matchedCampaign?.quantity || matchedCampaign?.totalQty || '-',
                                    installDate: installDate,
                                    stage: matchedCampaign?.stage || 'Installed',
                                    owner: matchedCampaign?.owner || '-',
                                    photoUrl: objectUrl,
                                    thumbnailUrl: objectUrl,
                                    fileName: fileName,
                                    filePath: entryPath,
                                    fileSize: file.size,
                                    isLocal: true,
                                    fileHandle: entry
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error scanning folder:', err);
                }
                
                return photos;
            };

            // Handle folder selection
            const handleLinkFolder = async () => {
                try {
                    // Check if File System Access API is supported
                    if (!window.showDirectoryPicker) {
                        setFolderError('Your browser does not support folder selection. Please use Chrome, Edge, or another Chromium-based browser.');
                        return;
                    }
                    
                    setScanningFolder(true);
                    setFolderError(null);
                    
                    // Open folder picker
                    const dirHandle = await window.showDirectoryPicker({
                        mode: 'read'
                    });
                    
                    setLinkedFolder(dirHandle);
                    
                    // Scan the folder
                    const photos = await scanFolder(dirHandle);
                    
                    // Group photos by campaign to get total counts
                    const campaignPhotoCounts = {};
                    photos.forEach(p => {
                        if (!campaignPhotoCounts[p.campaignNumber]) {
                            campaignPhotoCounts[p.campaignNumber] = 0;
                        }
                        campaignPhotoCounts[p.campaignNumber]++;
                    });
                    
                    // Add photo index info
                    const photosWithIndex = photos.map(p => {
                        const sameCapaign = photos.filter(pp => pp.campaignNumber === p.campaignNumber);
                        const idx = sameCapaign.findIndex(pp => pp.id === p.id);
                        return {
                            ...p,
                            photoIndex: idx + 1,
                            totalPhotos: campaignPhotoCounts[p.campaignNumber]
                        };
                    });
                    
                    setLocalPhotos(photosWithIndex);
                    setShowDemoData(false); // Switch to local data
                    setScanningFolder(false);
                    
                } catch (err) {
                    if (err.name === 'AbortError') {
                        // User cancelled - not an error
                        setScanningFolder(false);
                        return;
                    }
                    console.error('Error linking folder:', err);
                    setFolderError(`Failed to link folder: ${err.message}`);
                    setScanningFolder(false);
                }
            };

            // Refresh folder scan
            const handleRefreshFolder = async () => {
                if (!linkedFolder) return;
                
                setScanningFolder(true);
                const photos = await scanFolder(linkedFolder);
                
                const campaignPhotoCounts = {};
                photos.forEach(p => {
                    if (!campaignPhotoCounts[p.campaignNumber]) {
                        campaignPhotoCounts[p.campaignNumber] = 0;
                    }
                    campaignPhotoCounts[p.campaignNumber]++;
                });
                
                const photosWithIndex = photos.map(p => {
                    const sameCapaign = photos.filter(pp => pp.campaignNumber === p.campaignNumber);
                    const idx = sameCapaign.findIndex(pp => pp.id === p.id);
                    return {
                        ...p,
                        photoIndex: idx + 1,
                        totalPhotos: campaignPhotoCounts[p.campaignNumber]
                    };
                });
                
                setLocalPhotos(photosWithIndex);
                setScanningFolder(false);
            };

            // Extract unique values from MASTER TRACKER data for filters
            // Filters are driven by tracker data - photos will match via Campaign ID
            const markets = useMemo(() => {
                const trackerMarkets = data.map(d => d.market).filter(Boolean);
                // Also add markets from local photos if linked (for unmatched photos)
                const localMarkets = localPhotos.map(p => p.market).filter(Boolean);
                const unique = [...new Set([...trackerMarkets, ...localMarkets])];
                return unique.sort();
            }, [data, localPhotos]);

            const advertisers = useMemo(() => {
                let filtered = data;
                if (selectedMarket !== 'ALL') {
                    filtered = filtered.filter(d => d.market === selectedMarket);
                }
                const trackerAdvertisers = filtered.map(d => d.advertiser);
                // Add local photo advertisers
                const localAdvertisers = localPhotos
                    .filter(p => selectedMarket === 'ALL' || p.market === selectedMarket)
                    .map(p => p.advertiser);
                const unique = [...new Set([...trackerAdvertisers, ...localAdvertisers].filter(Boolean))];
                return unique.sort();
            }, [data, localPhotos, selectedMarket]);

            const campaigns = useMemo(() => {
                let filtered = data;
                if (selectedMarket !== 'ALL') {
                    filtered = filtered.filter(d => d.market === selectedMarket);
                }
                if (selectedAdvertiser !== 'ALL') {
                    filtered = filtered.filter(d => d.advertiser === selectedAdvertiser);
                }
                const trackerCampaigns = filtered.map(d => d.campaignNumber);
                // Add local photo campaigns
                const localCampaigns = localPhotos
                    .filter(p => selectedMarket === 'ALL' || p.market === selectedMarket)
                    .filter(p => selectedAdvertiser === 'ALL' || p.advertiser === selectedAdvertiser)
                    .map(p => p.campaignNumber);
                const unique = [...new Set([...trackerCampaigns, ...localCampaigns].filter(Boolean))];
                return unique.sort();
            }, [data, localPhotos, selectedMarket, selectedAdvertiser]);

            // Create a lookup for expected quantities from Master Tracker
            const campaignExpectedQty = useMemo(() => {
                const lookup = {};
                data.forEach(d => {
                    if (d.campaignNumber) {
                        lookup[d.campaignNumber] = {
                            expectedQty: parseInt(d.quantity) || parseInt(d.totalQty) || 0,
                            advertiser: d.advertiser,
                            product: d.product,
                            market: d.market,
                            startDate: d.date || d.dateObj,
                            stage: d.stage,
                            owner: d.owner
                        };
                    }
                });
                return lookup;
            }, [data]);

            // Generate mock POP data from campaign data
            // Structure: Market ‚Üí Campaign ID ‚Üí Date ‚Üí Photos
            const popData = useMemo(() => {
                const entries = [];
                
                // Only generate demo placeholder photos when in demo mode (showDemoTips is true)
                // In production mode, show empty state until real photos are linked
                if (!showDemoTips) {
                    return entries; // Return empty - no placeholder photos in production
                }
                
                // ============================================
                // COMPREHENSIVE DEMO DATA FOR PRESENTATION
                // Showcases all features: progress, analysis, statuses
                // ============================================
                
                const demoCampaigns = [
                    // NETFLIX - Big campaign with issues (graffiti, missing photos)
                    { 
                        campaignNumber: '258905855-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Netflix', 
                        campaign: 'Stranger Things Season 5 Launch', 
                        product: 'Transit Shelters-Domination', 
                        quantity: 250, // Expected
                        photoCount: 150, // Actual photos
                        stage: 'Photos Taken', 
                        owner: 'Emma Davis', 
                        installDate: new Date('2025-01-25'),
                        hasIssues: true // Will generate some graffiti flags
                    },
                    // APPLE - Complete and verified
                    { 
                        campaignNumber: '251115003-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Apple', 
                        campaign: 'iPhone 16 Pro Launch - LA', 
                        product: 'Transit Shelter-Digital Panel-Spot', 
                        quantity: 50,
                        photoCount: 50, // Complete!
                        stage: 'POP Completed', 
                        owner: 'Sarah Kim', 
                        installDate: new Date('2025-01-20'),
                        verified: true
                    },
                    // NIKE - In progress, some low matches
                    { 
                        campaignNumber: '250929011-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Nike', 
                        campaign: 'Air Max 2025 Campaign', 
                        product: 'Transit Shelters-Panel-Targeted', 
                        quantity: 75,
                        photoCount: 45,
                        stage: 'Installed', 
                        owner: 'Mike Johnson', 
                        installDate: new Date('2025-01-08'),
                        lowMatch: true
                    },
                    // DAVID YURMAN - Perfect small campaign
                    { 
                        campaignNumber: '250922043-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'David Yurman', 
                        campaign: 'FY2026 Jewelry Collection', 
                        product: 'Transit Shelters-Panel-Icon', 
                        quantity: 25,
                        photoCount: 25,
                        stage: 'POP Completed', 
                        owner: 'Tiffany Le', 
                        installDate: new Date('2025-01-15'),
                        verified: true
                    },
                    // LONGCHAMP - Medium campaign complete
                    { 
                        campaignNumber: '251021006-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Longchamp', 
                        campaign: 'Spring Collection 2025', 
                        product: 'Transit Shelter-Digital Network', 
                        quantity: 30,
                        photoCount: 30,
                        stage: 'POP Completed', 
                        owner: 'Angela Chen', 
                        installDate: new Date('2025-01-10'),
                        verified: true
                    },
                    // SAMSUNG - In progress
                    { 
                        campaignNumber: '250830022-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Samsung', 
                        campaign: 'Galaxy S25 Ultra Launch', 
                        product: 'Transit Shelters-Panel-Network', 
                        quantity: 100,
                        photoCount: 68,
                        stage: 'Photos Taken', 
                        owner: 'David Park', 
                        installDate: new Date('2025-01-05')
                    },
                    // COCA-COLA - Miami market
                    { 
                        campaignNumber: '251201044-0', 
                        market: 'Miami', 
                        advertiser: 'Coca-Cola', 
                        campaign: 'Summer Refresh 2025', 
                        product: 'Transit Buses-Full Side', 
                        quantity: 40,
                        photoCount: 32,
                        stage: 'Installed', 
                        owner: 'Maria Garcia', 
                        installDate: new Date('2025-01-18')
                    },
                    // TOYOTA - Miami
                    { 
                        campaignNumber: '251105018-0', 
                        market: 'Miami', 
                        advertiser: 'Toyota', 
                        campaign: 'Camry Hybrid 2025', 
                        product: 'Transit Buses-King', 
                        quantity: 25,
                        photoCount: 25,
                        stage: 'POP Completed', 
                        owner: 'Carlos Rodriguez', 
                        installDate: new Date('2025-01-12'),
                        verified: true
                    },
                    // AT&T - Dallas
                    { 
                        campaignNumber: '250918007-0', 
                        market: 'Dallas, TX', 
                        advertiser: 'AT&T', 
                        campaign: 'Fiber Network Expansion', 
                        product: 'Transit Buses-Kong', 
                        quantity: 20,
                        photoCount: 18,
                        stage: 'Photos Taken', 
                        owner: 'Jennifer Smith', 
                        installDate: new Date('2025-01-22')
                    },
                    // McDONALDS - Chicago
                    { 
                        campaignNumber: '251010033-0', 
                        market: 'Chicago, IL', 
                        advertiser: 'McDonalds', 
                        campaign: 'McRib Returns 2025', 
                        product: 'Transit Buses-Full Back', 
                        quantity: 35,
                        photoCount: 28,
                        stage: 'Installed', 
                        owner: 'Tom Wilson', 
                        installDate: new Date('2025-01-14'),
                        hasIssues: true
                    },
                    // GUCCI - Luxury
                    { 
                        campaignNumber: '251225001-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Gucci', 
                        campaign: 'Cruise Collection 2025', 
                        product: 'Transit Shelters-Panel-Icon', 
                        quantity: 15,
                        photoCount: 15,
                        stage: 'POP Completed', 
                        owner: 'Victoria Chen', 
                        installDate: new Date('2025-01-28'),
                        verified: true
                    },
                    // AMAZON - Prime Day
                    { 
                        campaignNumber: '251230055-0', 
                        market: 'Los Angeles - STAP', 
                        advertiser: 'Amazon', 
                        campaign: 'Prime Day 2025 Preview', 
                        product: 'Transit Shelter-Digital Panel-Spot', 
                        quantity: 60,
                        photoCount: 42,
                        stage: 'Installed', 
                        owner: 'James Lee', 
                        installDate: new Date('2025-01-30')
                    }
                ];

                // Generate photos for each demo campaign
                demoCampaigns.forEach((demo) => {
                    for (let i = 0; i < demo.photoCount; i++) {
                        const installDate = new Date(demo.installDate);
                        installDate.setDate(installDate.getDate() + Math.floor(i / 10)); // Spread over days
                        
                        entries.push({
                            id: `${demo.campaignNumber}-${i}`,
                            campaignNumber: demo.campaignNumber,
                            market: demo.market,
                            advertiser: demo.advertiser,
                            campaign: demo.campaign,
                            product: demo.product,
                            quantity: demo.quantity,
                            installDate: installDate,
                            stage: demo.stage,
                            owner: demo.owner,
                            // Use different image seeds for variety
                            photoUrl: `https://picsum.photos/seed/${demo.advertiser.toLowerCase()}-${i}/800/600`,
                            thumbnailUrl: `https://picsum.photos/seed/${demo.advertiser.toLowerCase()}-${i}/400/300`,
                            photoIndex: i + 1,
                            totalPhotos: demo.photoCount,
                            isDemo: true,
                            // Flags for pre-populated analysis
                            _hasIssues: demo.hasIssues && (i % 15 === 0), // Every 15th photo has issues
                            _lowMatch: demo.lowMatch && (i % 8 === 0), // Every 8th photo
                            _verified: demo.verified
                        });
                    }
                });

                // Also add any real installed campaigns from uploaded data
                const installed = data.filter(d => 
                    d.stage === 'Installed' || 
                    d.stage === 'POP Completed' || 
                    d.stage === 'Photos Taken' ||
                    d.progress?.includes('/')
                );
                
                // Load saved material data (includes photos links from DetailModal)
                const savedMaterialData = JSON.parse(localStorage.getItem('stap_material_data') || '{}');

                installed.forEach(campaign => {
                    const startDate = campaign.dateObj || new Date(campaign.date);
                    if (!startDate || isNaN(startDate.getTime())) return;
                    
                    // Check if we already have demo data for this campaign
                    if (entries.some(e => e.campaignNumber === campaign.campaignNumber)) return;
                    
                    // Check for saved photos link
                    const campaignKey = `${campaign.id}_${campaign.date}`;
                    const savedData = savedMaterialData[campaignKey];
                    const savedPhotosLink = savedData?.photosLink;

                    const photoCount = Math.floor(Math.random() * 4) + 1;
                    
                    for (let i = 0; i < photoCount; i++) {
                        const installDate = new Date(startDate);
                        installDate.setDate(installDate.getDate() + Math.floor(Math.random() * 7));
                        
                        // Use saved photo link if available, otherwise generate placeholder
                        const photoUrl = savedPhotosLink || `https://picsum.photos/seed/${campaign.campaignNumber}-${i}/800/600`;
                        
                        entries.push({
                            id: `${campaign.campaignNumber}-${i}`,
                            campaignNumber: campaign.campaignNumber,
                            market: campaign.market,
                            advertiser: campaign.advertiser,
                            campaign: campaign.campaign,
                            product: campaign.product,
                            quantity: campaign.quantity || campaign.totalQty,
                            installDate: installDate,
                            stage: campaign.stage,
                            owner: campaign.owner,
                            photoUrl: photoUrl,
                            thumbnailUrl: savedPhotosLink || `https://picsum.photos/seed/${campaign.campaignNumber}-${i}/400/300`,
                            photoIndex: i + 1,
                            totalPhotos: photoCount,
                            isDemo: false,
                            hasLinkedPhotos: !!savedPhotosLink,
                            savedPhotosLink: savedPhotosLink || null
                        });
                    }
                });

                return entries;
            }, [data, showDemoTips]);

            // Count photos per campaign (for comparison with expected qty)
            const photoCountByCampaign = useMemo(() => {
                const photoSource = (localPhotos.length > 0 && !showDemoData) ? localPhotos : popData;
                const counts = {};
                photoSource.forEach(p => {
                    if (p.campaignNumber) {
                        if (!counts[p.campaignNumber]) {
                            counts[p.campaignNumber] = 0;
                        }
                        counts[p.campaignNumber]++;
                    }
                });
                return counts;
            }, [localPhotos, popData, showDemoData]);

            // Filter POP data - use local photos if linked, otherwise demo data
            const filteredPOP = useMemo(() => {
                // Choose data source: local folder photos or demo data
                const sourceData = (localPhotos.length > 0 && !showDemoData) ? localPhotos : popData;
                let filtered = [...sourceData];

                // Market filter
                if (selectedMarket !== 'ALL') {
                    filtered = filtered.filter(p => p.market === selectedMarket);
                }

                // Advertiser filter
                if (selectedAdvertiser !== 'ALL') {
                    filtered = filtered.filter(p => p.advertiser === selectedAdvertiser);
                }

                // Campaign filter
                if (selectedCampaign !== 'ALL') {
                    filtered = filtered.filter(p => p.campaignNumber === selectedCampaign);
                }

                // Status filter (NEW)
                if (selectedStatus !== 'ALL') {
                    if (selectedStatus === 'POP Completed') {
                        filtered = filtered.filter(p => p.stage === 'POP Completed');
                    } else if (selectedStatus === 'Photos Taken') {
                        filtered = filtered.filter(p => p.stage === 'Photos Taken');
                    } else if (selectedStatus === 'Installed') {
                        filtered = filtered.filter(p => p.stage === 'Installed');
                    } else if (selectedStatus === 'Needs Photos') {
                        // Show installed campaigns that might need more photos
                        filtered = filtered.filter(p => p.stage === 'Installed' && !p.stage?.includes('POP'));
                    }
                }

                // Date filter
                if (dateFilter.start) {
                    const startDate = new Date(dateFilter.start);
                    filtered = filtered.filter(p => p.installDate >= startDate);
                }
                if (dateFilter.end) {
                    const endDate = new Date(dateFilter.end);
                    filtered = filtered.filter(p => p.installDate <= endDate);
                }

                // Search filter
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(p => 
                        p.campaignNumber?.toLowerCase().includes(term) ||
                        p.advertiser?.toLowerCase().includes(term) ||
                        p.campaign?.toLowerCase().includes(term) ||
                        p.product?.toLowerCase().includes(term) ||
                        p.market?.toLowerCase().includes(term) ||
                        p.fileName?.toLowerCase().includes(term)
                    );
                }

                // Sort
                switch (sortBy) {
                    case 'date-desc':
                        filtered.sort((a, b) => b.installDate - a.installDate);
                        break;
                    case 'date-asc':
                        filtered.sort((a, b) => a.installDate - b.installDate);
                        break;
                    case 'advertiser':
                        filtered.sort((a, b) => (a.advertiser || '').localeCompare(b.advertiser || ''));
                        break;
                    case 'campaign':
                        filtered.sort((a, b) => (a.campaignNumber || '').localeCompare(b.campaignNumber || ''));
                        break;
                }

                return filtered;
            }, [popData, localPhotos, showDemoData, selectedMarket, selectedAdvertiser, selectedCampaign, selectedStatus, dateFilter, searchTerm, sortBy]);

            // Campaign validation - compare photos vs Master Tracker expected quantities
            const campaignValidation = useMemo(() => {
                // Group photos by campaign
                const photosByCampaign = {};
                filteredPOP.forEach(p => {
                    if (!photosByCampaign[p.campaignNumber]) {
                        photosByCampaign[p.campaignNumber] = [];
                    }
                    photosByCampaign[p.campaignNumber].push(p);
                });

                // Check against master tracking data
                const validation = {
                    matched: [],      // Photo count matches expected
                    mismatched: [],   // Photo count doesn't match
                    notInTracker: [], // Campaign in photos but not in master tracker
                    missingPhotos: [] // Campaign in tracker but no photos yet
                };

                // Check each campaign in photos
                Object.keys(photosByCampaign).forEach(campaignId => {
                    const photos = photosByCampaign[campaignId];
                    const trackerEntry = data.find(d => d.campaignNumber === campaignId);
                    
                    if (!trackerEntry) {
                        validation.notInTracker.push({
                            campaignNumber: campaignId,
                            photoCount: photos.length,
                            photos: photos
                        });
                    } else {
                        const expectedQty = trackerEntry.quantity || trackerEntry.totalQty || 0;
                        // For now, we're just counting unique photo entries per campaign
                        // In real scenario, you might want different logic
                        const uniquePhotos = photos.length;
                        
                        if (uniquePhotos > 0) {
                            validation.matched.push({
                                campaignNumber: campaignId,
                                photoCount: uniquePhotos,
                                expectedQty: expectedQty,
                                advertiser: trackerEntry.advertiser,
                                status: trackerEntry.stage
                            });
                        }
                    }
                });

                // Check for campaigns in tracker that should have photos but don't
                const installedCampaigns = data.filter(d => 
                    d.stage === 'Installed' || d.stage === 'Photos Taken' || d.stage === 'POP Completed'
                );
                installedCampaigns.forEach(campaign => {
                    if (!photosByCampaign[campaign.campaignNumber]) {
                        validation.missingPhotos.push({
                            campaignNumber: campaign.campaignNumber,
                            advertiser: campaign.advertiser,
                            expectedQty: campaign.quantity || campaign.totalQty || 0,
                            status: campaign.stage
                        });
                    }
                });

                return validation;
            }, [filteredPOP, data]);

            // Group by campaign for summary stats
            const stats = useMemo(() => {
                const uniqueCampaigns = new Set(filteredPOP.map(p => p.campaignNumber));
                const uniqueAdvertisers = new Set(filteredPOP.map(p => p.advertiser));
                const uniqueMarkets = new Set(filteredPOP.map(p => p.market));
                const localCount = filteredPOP.filter(p => p.isLocal).length;
                
                return {
                    totalPhotos: filteredPOP.length,
                    campaigns: uniqueCampaigns.size,
                    advertisers: uniqueAdvertisers.size,
                    markets: uniqueMarkets.size,
                    localPhotos: localCount,
                    isShowingLocal: localPhotos.length > 0 && !showDemoData
                };
            }, [filteredPOP, localPhotos, showDemoData]);

            // Group photos by campaign for Campaign Cards view
            const campaignGroups = useMemo(() => {
                const groups = {};
                
                filteredPOP.forEach(photo => {
                    const cid = photo.campaignNumber;
                    if (!cid) return;
                    
                    if (!groups[cid]) {
                        // Get expected qty from tracker
                        const trackerInfo = campaignExpectedQty[cid] || {};
                        groups[cid] = {
                            campaignNumber: cid,
                            advertiser: photo.advertiser || trackerInfo.advertiser || 'Unknown',
                            campaign: photo.campaign || trackerInfo.campaign || cid,
                            market: photo.market || trackerInfo.market || 'Unknown',
                            product: photo.product || trackerInfo.product || 'Unknown',
                            stage: photo.stage || trackerInfo.stage || 'Unknown',
                            owner: photo.owner || trackerInfo.owner || '-',
                            expectedQty: trackerInfo.expectedQty || 0,
                            photos: [],
                            coverPhoto: null,
                            latestDate: null
                        };
                    }
                    
                    groups[cid].photos.push(photo);
                    
                    // Set cover photo (first photo)
                    if (!groups[cid].coverPhoto) {
                        groups[cid].coverPhoto = photo;
                    }
                    
                    // Track latest date
                    if (photo.installDate && (!groups[cid].latestDate || photo.installDate > groups[cid].latestDate)) {
                        groups[cid].latestDate = photo.installDate;
                    }
                });
                
                // Convert to array and calculate progress
                const groupArray = Object.values(groups).map(g => ({
                    ...g,
                    photoCount: g.photos.length,
                    progress: g.expectedQty > 0 ? Math.min(100, Math.round((g.photos.length / g.expectedQty) * 100)) : 0,
                    isComplete: g.expectedQty > 0 && g.photos.length >= g.expectedQty,
                    missing: g.expectedQty > 0 ? Math.max(0, g.expectedQty - g.photos.length) : 0
                }));
                
                // Sort by latest date or photo count
                groupArray.sort((a, b) => {
                    if (sortBy === 'date-desc') return (b.latestDate || 0) - (a.latestDate || 0);
                    if (sortBy === 'date-asc') return (a.latestDate || 0) - (b.latestDate || 0);
                    if (sortBy === 'advertiser') return (a.advertiser || '').localeCompare(b.advertiser || '');
                    return (a.campaignNumber || '').localeCompare(b.campaignNumber || '');
                });
                
                return groupArray;
            }, [filteredPOP, campaignExpectedQty, sortBy]);

            // Expanded Campaign Modal - shows all photos for a campaign
            const CampaignPhotosModal = ({ campaign, onClose }) => {
                if (!campaign) return null;
                
                const [photoIndex, setPhotoIndex] = useState(0);
                const [viewAllGrid, setViewAllGrid] = useState(true);
                const [showAnalysis, setShowAnalysis] = useState(false);
                const [scanProgress, setScanProgress] = useState({ current: 0, total: 0 });
                
                // Get analysis summary for this campaign
                const analysisSummary = getCampaignAnalysisSummary(campaign);
                
                // Run analysis on all photos
                const handleAnalyzeAll = async () => {
                    setScanProgress({ current: 0, total: campaign.photos.length });
                    setShowAnalysis(true);
                    
                    for (let i = 0; i < campaign.photos.length; i++) {
                        const photo = campaign.photos[i];
                        if (!photoAnalysis[photo.id] || photoAnalysis[photo.id].error) {
                            await analyzePhoto(photo);
                        }
                        setScanProgress({ current: i + 1, total: campaign.photos.length });
                    }
                };
                
                // Get flag badge color
                const getFlagColor = (flag) => {
                    switch(flag) {
                        case 'VERIFIED': return 'bg-green-500 text-white';
                        case 'GRAFFITI_DETECTED': return 'bg-red-500 text-white';
                        case 'LOW_MATCH': return 'bg-amber-500 text-white';
                        case 'WRONG_POSTER': return 'bg-red-600 text-white';
                        case 'NO_TEXT_FOUND': return 'bg-gray-500 text-white';
                        case 'SCAN_ERROR': return 'bg-gray-600 text-white';
                        default: return 'bg-gray-500 text-white';
                    }
                };
                
                return (
                    <div className="fixed inset-0 bg-black/95 z-50 flex flex-col" onClick={onClose}>
                        <div className="flex-1 flex flex-col max-h-screen" onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className="bg-gray-900 px-6 py-4 flex items-center justify-between border-b border-gray-700">
                                <div className="flex items-center gap-4">
                                    <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-lg text-white">
                                        <Icon name="ArrowLeft" size={20} />
                                    </button>
                                    <div>
                                        <h3 className="text-white font-bold text-lg">{campaign.advertiser}</h3>
                                        <p className="text-gray-400 text-sm">
                                            {campaign.campaignNumber} ‚Ä¢ {campaign.product?.split('-').slice(0, 2).join('-')}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    {/* Analysis Summary */}
                                    {analysisSummary && (
                                        <div className="flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-lg">
                                            <div className="flex items-center gap-1">
                                                <Icon name="CheckCircle" size={14} className="text-green-400" />
                                                <span className="text-green-400 text-sm font-bold">{analysisSummary.verified}</span>
                                            </div>
                                            {analysisSummary.issues > 0 && (
                                                <div className="flex items-center gap-1">
                                                    <Icon name="AlertTriangle" size={14} className="text-red-400" />
                                                    <span className="text-red-400 text-sm font-bold">{analysisSummary.issues}</span>
                                                </div>
                                            )}
                                            <span className="text-gray-400 text-xs">
                                                {analysisSummary.analyzed}/{analysisSummary.total} scanned
                                            </span>
                                        </div>
                                    )}
                                    
                                    {/* Analyze Button */}
                                    <button 
                                        onClick={handleAnalyzeAll}
                                        disabled={isAnalyzing}
                                        className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${
                                            isAnalyzing 
                                                ? 'bg-indigo-800 text-indigo-300 cursor-wait' 
                                                : 'bg-indigo-600 hover:bg-indigo-500 text-white'
                                        }`}
                                    >
                                        <Icon name={isAnalyzing ? "Loader" : "Scan"} size={16} className={isAnalyzing ? 'animate-spin' : ''} />
                                        {isAnalyzing 
                                            ? `Scanning ${scanProgress.current}/${scanProgress.total}...` 
                                            : analysisSummary ? 'Re-scan All' : 'üîç Analyze Photos'
                                        }
                                    </button>
                                    
                                    {/* Toggle Analysis Panel */}
                                    <button 
                                        onClick={() => setShowAnalysis(!showAnalysis)}
                                        className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${
                                            showAnalysis ? 'bg-purple-600 text-white' : 'bg-gray-800 text-gray-300 hover:text-white'
                                        }`}
                                    >
                                        <Icon name="FileSearch" size={16} />
                                        Analysis
                                    </button>
                                    
                                    {/* Progress */}
                                    <div className="flex items-center gap-3 bg-gray-800 px-4 py-2 rounded-lg">
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-white">{campaign.photoCount}</div>
                                            <div className="text-[10px] text-gray-400 uppercase">Photos</div>
                                        </div>
                                        <div className="text-gray-500 text-xl">/</div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-gray-400">{campaign.expectedQty || '?'}</div>
                                            <div className="text-[10px] text-gray-400 uppercase">Expected</div>
                                        </div>
                                        {campaign.expectedQty > 0 && (
                                            <div className={`px-3 py-1 rounded-full text-sm font-bold ${
                                                campaign.isComplete ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                                            }`}>
                                                {campaign.isComplete ? '‚úì Complete' : `${campaign.missing} missing`}
                                            </div>
                                        )}
                                    </div>
                                    {/* View toggle */}
                                    <div className="flex bg-gray-800 rounded-lg p-1">
                                        <button 
                                            onClick={() => setViewAllGrid(true)}
                                            className={`px-3 py-1.5 rounded text-sm font-medium ${viewAllGrid ? 'bg-indigo-500 text-white' : 'text-gray-400 hover:text-white'}`}
                                        >
                                            <Icon name="Grid" size={16} />
                                        </button>
                                        <button 
                                            onClick={() => setViewAllGrid(false)}
                                            className={`px-3 py-1.5 rounded text-sm font-medium ${!viewAllGrid ? 'bg-indigo-500 text-white' : 'text-gray-400 hover:text-white'}`}
                                        >
                                            <Icon name="Maximize" size={16} />
                                        </button>
                                    </div>
                                    <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded-lg text-white">
                                        <Icon name="X" size={24} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* DEMO MODE Banner */}
                            {showDemoData && (
                                <div className="bg-amber-500 px-4 py-2 flex items-center justify-center gap-3">
                                    <Icon name="AlertTriangle" size={16} className="text-amber-900" />
                                    <span className="text-amber-900 text-sm font-medium">
                                        <strong>DEMO MODE:</strong> These are placeholder images. In production, real install photos would be scanned by OCR to verify advertiser text and detect graffiti.
                                    </span>
                                    <button 
                                        onClick={() => setShowAnalysis(true)}
                                        className="px-2 py-1 bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold rounded"
                                    >
                                        Try OCR Anyway ‚Üí
                                    </button>
                                </div>
                            )}
                            
                            {/* Content */}
                            <div className="flex-1 flex overflow-hidden">
                                {/* Main Photo Area */}
                                <div className={`flex-1 overflow-auto p-4 ${showAnalysis ? 'w-2/3' : 'w-full'}`}>
                                    {viewAllGrid ? (
                                        /* Grid of all photos with analysis badges */
                                        <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2">
                                            {campaign.photos.map((photo, idx) => {
                                                const analysis = photoAnalysis[photo.id];
                                                return (
                                                    <div 
                                                        key={photo.id}
                                                        onClick={() => { setPhotoIndex(idx); setViewAllGrid(false); }}
                                                        className={`relative aspect-square bg-gray-800 rounded-lg overflow-hidden cursor-pointer transition-all group ${
                                                            analysis?.flags?.includes('GRAFFITI_DETECTED') || analysis?.flags?.includes('WRONG_POSTER') 
                                                                ? 'ring-2 ring-red-500' 
                                                                : analysis?.flags?.includes('VERIFIED') 
                                                                    ? 'ring-2 ring-green-500' 
                                                                    : 'hover:ring-2 hover:ring-indigo-500'
                                                        }`}
                                                    >
                                                        <img 
                                                            src={photo.thumbnailUrl || photo.photoUrl}
                                                            alt={`Photo ${idx + 1}`}
                                                            className="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                        />
                                                        {/* Photo number */}
                                                        <div className="absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded">
                                                            {idx + 1}
                                                        </div>
                                                        {/* Analysis status badge */}
                                                        {analysis && !analysis.analyzing && (
                                                            <div className={`absolute top-1 right-1 px-1.5 py-0.5 rounded text-[9px] font-bold ${
                                                                analysis.flags?.includes('VERIFIED') ? 'bg-green-500 text-white' :
                                                                analysis.flags?.includes('GRAFFITI_DETECTED') ? 'bg-red-500 text-white' :
                                                                analysis.flags?.includes('LOW_MATCH') ? 'bg-amber-500 text-white' :
                                                                'bg-gray-600 text-white'
                                                            }`}>
                                                                {analysis.flags?.includes('VERIFIED') ? '‚úì' :
                                                                 analysis.flags?.includes('GRAFFITI_DETECTED') ? '‚ö†Ô∏è' :
                                                                 analysis.flags?.includes('LOW_MATCH') ? '?' :
                                                                 `${analysis.score || 0}%`}
                                                            </div>
                                                        )}
                                                        {/* Analyzing spinner */}
                                                        {analysis?.analyzing && (
                                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                                                                <Icon name="Loader" size={20} className="text-white animate-spin" />
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        /* Single photo view with navigation */
                                        <div className="flex flex-col items-center justify-center h-full">
                                            <div className="relative max-w-4xl w-full">
                                                <img 
                                                    src={campaign.photos[photoIndex]?.photoUrl}
                                                    alt={`Photo ${photoIndex + 1}`}
                                                    className="max-h-[70vh] mx-auto object-contain rounded-lg"
                                                />
                                                {/* Navigation */}
                                                <button 
                                                    onClick={() => setPhotoIndex(i => i > 0 ? i - 1 : campaign.photos.length - 1)}
                                                    className="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 hover:bg-black/70 rounded-full text-white"
                                                >
                                                    <Icon name="ChevronLeft" size={24} />
                                                </button>
                                                <button 
                                                    onClick={() => setPhotoIndex(i => i < campaign.photos.length - 1 ? i + 1 : 0)}
                                                    className="absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 hover:bg-black/70 rounded-full text-white"
                                                >
                                                    <Icon name="ChevronRight" size={24} />
                                                </button>
                                                
                                                {/* Single photo analysis badge */}
                                                {photoAnalysis[campaign.photos[photoIndex]?.id] && (
                                                    <div className="absolute top-4 right-4 bg-gray-900/90 rounded-lg p-3 max-w-xs">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            {photoAnalysis[campaign.photos[photoIndex].id].flags?.map(flag => (
                                                                <span key={flag} className={`px-2 py-0.5 rounded text-[10px] font-bold ${getFlagColor(flag)}`}>
                                                                    {flag.replace(/_/g, ' ')}
                                                                </span>
                                                            ))}
                                                        </div>
                                                        <div className="text-white text-sm">
                                                            Match: <strong>{photoAnalysis[campaign.photos[photoIndex].id].score || 0}%</strong>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            {/* Photo counter */}
                                            <div className="mt-4 bg-gray-800 px-4 py-2 rounded-full text-white flex items-center gap-3">
                                                <span>{photoIndex + 1} / {campaign.photos.length}</span>
                                                {/* Quick analyze button for single photo */}
                                                {!photoAnalysis[campaign.photos[photoIndex]?.id] && (
                                                    <button 
                                                        onClick={() => analyzePhoto(campaign.photos[photoIndex])}
                                                        className="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs font-bold"
                                                    >
                                                        üîç Scan
                                                    </button>
                                                )}
                                            </div>
                                            {/* Thumbnail strip */}
                                            <div className="mt-4 flex gap-1 overflow-x-auto max-w-full pb-2">
                                                {campaign.photos.slice(0, 20).map((photo, idx) => (
                                                    <button
                                                        key={photo.id}
                                                        onClick={() => setPhotoIndex(idx)}
                                                        className={`relative flex-shrink-0 w-12 h-12 rounded overflow-hidden ${idx === photoIndex ? 'ring-2 ring-indigo-500' : 'opacity-60 hover:opacity-100'}`}
                                                    >
                                                        <img src={photo.thumbnailUrl || photo.photoUrl} alt="" className="w-full h-full object-cover" />
                                                        {photoAnalysis[photo.id]?.flags?.includes('GRAFFITI_DETECTED') && (
                                                            <div className="absolute inset-0 ring-2 ring-red-500 rounded"></div>
                                                        )}
                                                    </button>
                                                ))}
                                                {campaign.photos.length > 20 && (
                                                    <div className="flex-shrink-0 w-12 h-12 rounded bg-gray-700 flex items-center justify-center text-gray-400 text-xs">
                                                        +{campaign.photos.length - 20}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Analysis Panel (Sidebar) */}
                                {showAnalysis && (
                                    <div className="w-1/3 bg-gray-900 border-l border-gray-700 overflow-auto">
                                        <div className="p-4">
                                            <h4 className="text-white font-bold mb-4 flex items-center gap-2">
                                                <Icon name="FileSearch" size={18} />
                                                Photo Analysis
                                            </h4>
                                            
                                            {/* Demo Mode Explanation */}
                                            {showDemoData && !analysisSummary && (
                                                <div className="mb-4 p-3 bg-amber-900/30 border border-amber-700 rounded-lg">
                                                    <div className="text-amber-300 text-xs mb-2 font-bold">üìã HOW IT WORKS:</div>
                                                    <ol className="text-amber-200 text-[11px] space-y-1 list-decimal list-inside">
                                                        <li>OCR scans each photo for text</li>
                                                        <li>Compares found text to advertiser keywords</li>
                                                        <li>Flags graffiti or wrong posters</li>
                                                        <li>Generates match score %</li>
                                                    </ol>
                                                    <div className="mt-2 pt-2 border-t border-amber-700">
                                                        <div className="text-amber-400 text-[10px]">
                                                            ‚ö†Ô∏è Demo uses placeholder images. Real install photos would show actual OCR results.
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Summary Cards */}
                                            {analysisSummary && (
                                                <div className="grid grid-cols-2 gap-2 mb-4">
                                                    <div className="bg-green-900/30 border border-green-700 rounded-lg p-3 text-center">
                                                        <div className="text-2xl font-bold text-green-400">{analysisSummary.verified}</div>
                                                        <div className="text-[10px] text-green-300 uppercase">Verified</div>
                                                    </div>
                                                    <div className="bg-red-900/30 border border-red-700 rounded-lg p-3 text-center">
                                                        <div className="text-2xl font-bold text-red-400">{analysisSummary.issues}</div>
                                                        <div className="text-[10px] text-red-300 uppercase">Issues</div>
                                                    </div>
                                                    <div className="bg-blue-900/30 border border-blue-700 rounded-lg p-3 text-center">
                                                        <div className="text-2xl font-bold text-blue-400">{analysisSummary.avgScore}%</div>
                                                        <div className="text-[10px] text-blue-300 uppercase">Avg Match</div>
                                                    </div>
                                                    <div className="bg-gray-800 border border-gray-600 rounded-lg p-3 text-center">
                                                        <div className="text-2xl font-bold text-gray-300">{analysisSummary.analyzed}/{analysisSummary.total}</div>
                                                        <div className="text-[10px] text-gray-400 uppercase">Scanned</div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Expected Keywords */}
                                            <div className="mb-4 p-3 bg-gray-800 rounded-lg">
                                                <div className="text-xs text-gray-400 mb-2 font-bold uppercase">Looking For:</div>
                                                <div className="flex flex-wrap gap-1">
                                                    {getExpectedKeywords(campaign).primary.slice(0, 10).map(kw => (
                                                        <span key={kw} className="px-2 py-1 bg-indigo-600/50 text-indigo-200 rounded text-xs">
                                                            {kw}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Issue List */}
                                            <div className="mb-4">
                                                <div className="text-xs text-gray-400 mb-2 font-bold uppercase">‚ö†Ô∏è Photos Needing Review</div>
                                                <div className="space-y-2 max-h-64 overflow-auto">
                                                    {campaign.photos.filter(p => 
                                                        photoAnalysis[p.id]?.flags?.includes('GRAFFITI_DETECTED') ||
                                                        photoAnalysis[p.id]?.flags?.includes('LOW_MATCH') ||
                                                        photoAnalysis[p.id]?.flags?.includes('WRONG_POSTER')
                                                    ).map((photo, idx) => (
                                                        <div 
                                                            key={photo.id}
                                                            onClick={() => {
                                                                const realIdx = campaign.photos.findIndex(p => p.id === photo.id);
                                                                setPhotoIndex(realIdx);
                                                                setViewAllGrid(false);
                                                            }}
                                                            className="flex items-center gap-2 p-2 bg-red-900/30 border border-red-700 rounded-lg cursor-pointer hover:bg-red-900/50"
                                                        >
                                                            <img src={photo.thumbnailUrl || photo.photoUrl} className="w-10 h-10 rounded object-cover" />
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex flex-wrap gap-1">
                                                                    {photoAnalysis[photo.id]?.flags?.map(flag => (
                                                                        <span key={flag} className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${getFlagColor(flag)}`}>
                                                                            {flag.replace(/_/g, ' ')}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                                {photoAnalysis[photo.id]?.suspicious?.length > 0 && (
                                                                    <div className="text-[10px] text-red-300 mt-1 truncate">
                                                                        Found: {photoAnalysis[photo.id].suspicious.join(', ')}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {campaign.photos.filter(p => 
                                                        photoAnalysis[p.id]?.flags?.includes('GRAFFITI_DETECTED') ||
                                                        photoAnalysis[p.id]?.flags?.includes('LOW_MATCH') ||
                                                        photoAnalysis[p.id]?.flags?.includes('WRONG_POSTER')
                                                    ).length === 0 && (
                                                        <div className="text-center text-gray-500 text-sm py-4">
                                                            {analysisSummary ? 'No issues found ‚úì' : 'Run analysis to detect issues'}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Current Photo Analysis Details */}
                                            {!viewAllGrid && photoAnalysis[campaign.photos[photoIndex]?.id] && (
                                                <div className="p-3 bg-gray-800 rounded-lg">
                                                    <div className="text-xs text-gray-400 mb-2 font-bold uppercase">Current Photo Analysis</div>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400">Match Score:</span>
                                                            <span className={`font-bold ${
                                                                photoAnalysis[campaign.photos[photoIndex].id].score >= 70 ? 'text-green-400' :
                                                                photoAnalysis[campaign.photos[photoIndex].id].score >= 30 ? 'text-amber-400' :
                                                                'text-red-400'
                                                            }`}>
                                                                {photoAnalysis[campaign.photos[photoIndex].id].score}%
                                                            </span>
                                                        </div>
                                                        {photoAnalysis[campaign.photos[photoIndex].id].matched?.length > 0 && (
                                                            <div>
                                                                <span className="text-gray-400 text-xs">Matched:</span>
                                                                <div className="flex flex-wrap gap-1 mt-1">
                                                                    {photoAnalysis[campaign.photos[photoIndex].id].matched.map(m => (
                                                                        <span key={m} className="px-1.5 py-0.5 bg-green-600/50 text-green-200 rounded text-[10px]">{m}</span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {photoAnalysis[campaign.photos[photoIndex].id].suspicious?.length > 0 && (
                                                            <div>
                                                                <span className="text-red-400 text-xs">‚ö†Ô∏è Suspicious Text:</span>
                                                                <div className="flex flex-wrap gap-1 mt-1">
                                                                    {photoAnalysis[campaign.photos[photoIndex].id].suspicious.map(s => (
                                                                        <span key={s} className="px-1.5 py-0.5 bg-red-600/50 text-red-200 rounded text-[10px]">{s}</span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {photoAnalysis[campaign.photos[photoIndex].id].detectedText && (
                                                            <div className="mt-2">
                                                                <span className="text-gray-400 text-xs">Detected Text:</span>
                                                                <div className="mt-1 p-2 bg-gray-900 rounded text-[10px] text-gray-300 max-h-24 overflow-auto font-mono">
                                                                    {photoAnalysis[campaign.photos[photoIndex].id].detectedText || 'No text detected'}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };
            const PhotoModal = ({ photo, onClose, onNext, onPrev }) => {
                if (!photo) return null;

                // Find all photos from same campaign
                const campaignPhotos = filteredPOP.filter(p => p.campaignNumber === photo.campaignNumber);
                const currentIndex = campaignPhotos.findIndex(p => p.id === photo.id);

                return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center" onClick={onClose}>
                        <div className="relative max-w-6xl w-full mx-4" onClick={e => e.stopPropagation()}>
                            {/* Close button */}
                            <button 
                                onClick={onClose}
                                className="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors"
                            >
                                <Icon name="X" size={32} />
                            </button>

                            <div className="bg-gray-900 rounded-xl overflow-hidden">
                                <div className="flex flex-col lg:flex-row">
                                    {/* Photo */}
                                    <div className="flex-1 relative bg-black flex items-center justify-center min-h-[400px]">
                                        <img 
                                            src={photo.photoUrl} 
                                            alt={`${photo.advertiser} - ${photo.campaignNumber}`}
                                            className="max-w-full max-h-[70vh] object-contain"
                                        />
                                        
                                        {/* Navigation arrows */}
                                        {campaignPhotos.length > 1 && (
                                            <>
                                                <button 
                                                    onClick={() => {
                                                        const prevIndex = currentIndex > 0 ? currentIndex - 1 : campaignPhotos.length - 1;
                                                        setSelectedPhoto(campaignPhotos[prevIndex]);
                                                    }}
                                                    className="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 rounded-full text-white transition-colors"
                                                >
                                                    <Icon name="ChevronLeft" size={24} />
                                                </button>
                                                <button 
                                                    onClick={() => {
                                                        const nextIndex = currentIndex < campaignPhotos.length - 1 ? currentIndex + 1 : 0;
                                                        setSelectedPhoto(campaignPhotos[nextIndex]);
                                                    }}
                                                    className="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 rounded-full text-white transition-colors"
                                                >
                                                    <Icon name="ChevronRight" size={24} />
                                                </button>
                                            </>
                                        )}

                                        {/* Photo counter */}
                                        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 px-3 py-1 rounded-full text-white text-sm">
                                            {currentIndex + 1} / {campaignPhotos.length}
                                        </div>
                                    </div>

                                    {/* Details sidebar */}
                                    <div className="w-full lg:w-80 p-6 bg-gray-800 text-white">
                                        <h3 className="text-lg font-bold mb-1">{photo.advertiser}</h3>
                                        <p className="text-gray-400 text-sm mb-4">{photo.campaign}</p>

                                        <div className="space-y-3">
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Campaign #</span>
                                                <span className="font-mono">{photo.campaignNumber}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Market</span>
                                                <span>{photo.market?.split(',')[0] || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Media Type</span>
                                                <span className="text-right text-sm">{photo.product || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Quantity</span>
                                                <span>{photo.quantity || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Install Date</span>
                                                <span>{photo.installDate?.toLocaleDateString() || 'N/A'}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-700 pb-2">
                                                <span className="text-gray-400">Status</span>
                                                <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                    photo.stage === 'Installed' ? 'bg-green-600' :
                                                    photo.stage === 'POP Completed' ? 'bg-blue-600' :
                                                    'bg-gray-600'
                                                }`}>{photo.stage}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-400">Owner</span>
                                                <span>{photo.owner || 'N/A'}</span>
                                            </div>
                                        </div>

                                        <div className="mt-6 flex gap-2">
                                            <button className="flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-2">
                                                <Icon name="Download" size={16} /> Download
                                            </button>
                                            <button className="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-bold transition-colors">
                                                <Icon name="Share2" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    {/* Header */}
                    <div className="px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-purple-50 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <button onClick={onBack} className="p-1 hover:bg-indigo-200 rounded-full transition-colors" title="Back">
                                <Icon name="ArrowLeft" size={20} className="text-indigo-600" />
                            </button>
                            <div>
                                <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                    <Icon name="Camera" size={20} className="text-indigo-600" />
                                    Proof of Performance Gallery
                                </h3>
                                <p className="text-sm text-gray-500">
                                    Campaign evidence folders and installation documentation
                                    {popCampaigns.length > 0 && <span className="ml-2 text-xs text-green-600">(üìã {popCampaigns.length} from POP Log)</span>}
                                    {data.length > 0 && popCampaigns.length === 0 && <span className="ml-2 text-xs text-blue-600">(üìä {data.length} from tracker)</span>}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {/* POP Sheet Connection */}
                            <button 
                                onClick={() => setShowPopLinkModal(true)}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${
                                    popLastSync 
                                        ? 'bg-green-100 border border-green-300 text-green-700 hover:bg-green-200' 
                                        : 'bg-amber-100 border border-amber-300 text-amber-700 hover:bg-amber-200'
                                }`}
                            >
                                <Icon name={popLastSync ? "CheckCircle" : "Link"} size={16} />
                                {popLastSync ? 'POP Log Connected' : 'Connect POP Log'}
                            </button>
                            {popLastSync && (
                                <button 
                                    onClick={handleConnectPopSheet}
                                    disabled={popLoading}
                                    className="p-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-600 rounded-lg"
                                    title="Refresh data"
                                >
                                    <Icon name="RefreshCw" size={16} className={popLoading ? 'animate-spin' : ''} />
                                </button>
                            )}
                            <button 
                                onClick={() => setView && setView('performanceReport')}
                                className="px-3 py-1.5 bg-emerald-100 border border-emerald-300 hover:bg-emerald-200 text-emerald-700 rounded-lg text-sm font-medium flex items-center gap-2"
                            >
                                <Icon name="FileText" size={16} /> Report
                            </button>
                            <span className="text-sm text-gray-500 mr-2">{popCampaigns.length || stats.campaigns} campaigns</span>
                            <div className="flex bg-white border border-gray-300 rounded-lg p-0.5">
                                <button 
                                    onClick={() => setViewMode('campaigns')}
                                    className={`p-1.5 rounded transition-all ${viewMode === 'campaigns' ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="Campaign Cards (Grouped)"
                                >
                                    <Icon name="Layers" size={18} />
                                </button>
                                <button 
                                    onClick={() => setViewMode('timeline')}
                                    className={`p-1.5 rounded transition-all ${viewMode === 'timeline' ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="Installation Timeline"
                                >
                                    <Icon name="Calendar" size={18} />
                                </button>
                                <button 
                                    onClick={() => setViewMode('grid')}
                                    className={`p-1.5 rounded transition-all ${viewMode === 'grid' ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="All Photos Grid"
                                >
                                    <Icon name="Grid" size={18} />
                                </button>
                                <button 
                                    onClick={() => setViewMode('list')}
                                    className={`p-1.5 rounded transition-all ${viewMode === 'list' ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                    title="All Photos List"
                                >
                                    <Icon name="List" size={18} />
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* POP Sheet Link Modal */}
                    {showPopLinkModal && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setShowPopLinkModal(false)}>
                            <div className="bg-white rounded-xl max-w-xl w-full" onClick={e => e.stopPropagation()}>
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between rounded-t-xl">
                                    <div className="text-white">
                                        <h3 className="text-xl font-bold flex items-center gap-2">
                                            <Icon name="FileSpreadsheet" size={24} /> Connect POP Master Log
                                        </h3>
                                        <p className="text-indigo-100 text-sm">Link your Proof of Performance spreadsheet</p>
                                    </div>
                                    <button onClick={() => setShowPopLinkModal(false)} className="text-white/80 hover:text-white p-2">
                                        <Icon name="X" size={24} />
                                    </button>
                                </div>
                                
                                <div className="p-6">
                                    {popError && (
                                        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                            ‚ö†Ô∏è {popError}
                                        </div>
                                    )}
                                    
                                    {popLastSync && (
                                        <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center justify-between">
                                            <div className="flex items-center gap-2 text-green-700">
                                                <Icon name="CheckCircle" size={16} />
                                                <span className="text-sm">Connected ‚Ä¢ {popCampaigns.length} campaigns ‚Ä¢ Last sync: {popLastSync.toLocaleString()}</span>
                                            </div>
                                            <button 
                                                onClick={() => { setPopCampaigns([]); setPopLastSync(null); localStorage.removeItem('stap_pop_sheet_url'); }}
                                                className="text-red-600 hover:text-red-800 text-xs"
                                            >
                                                Disconnect
                                            </button>
                                        </div>
                                    )}
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Published Sheet URL</label>
                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 text-sm text-amber-800">
                                            <strong>How to publish:</strong> In Google Sheets ‚Üí File ‚Üí Share ‚Üí Publish to web ‚Üí Select CSV ‚Üí Copy link
                                        </div>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text"
                                                placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"
                                                value={popSheetUrl}
                                                onChange={e => setPopSheetUrl(e.target.value)}
                                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm"
                                            />
                                            <button 
                                                onClick={handleConnectPopSheet}
                                                disabled={!popSheetUrl || popLoading}
                                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 text-white rounded-lg font-medium text-sm flex items-center gap-2"
                                            >
                                                {popLoading ? <Icon name="Loader" size={16} className="animate-spin" /> : <Icon name="Link" size={16} />}
                                                Connect
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-50 rounded-lg p-3 text-xs text-gray-600">
                                        <strong>Expected columns:</strong> Campaign ID, Advertiser, Location/Description, Date, Folder Link (Google Drive URL)
                                    </div>
                                </div>
                                
                                <div className="px-6 py-4 bg-gray-50 border-t flex justify-end rounded-b-xl">
                                    <button onClick={() => setShowPopLinkModal(false)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Demo Tips for POP Gallery */}
                    {showDemoTips && (
                        <div className="px-6 py-3 bg-gradient-to-r from-indigo-50 to-purple-50 border-b">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div className="bg-white/80 rounded-lg p-3 border border-indigo-200">
                                    <div className="font-bold text-indigo-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üìö</span> Campaign Cards
                                    </div>
                                    <div className="text-[10px] text-indigo-700">
                                        Groups photos by campaign. Shows progress bars (150/250 installed). Click to see all photos.
                                    </div>
                                </div>
                                <div className="bg-white/80 rounded-lg p-3 border border-purple-200">
                                    <div className="font-bold text-purple-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üîç</span> OCR Analysis
                                    </div>
                                    <div className="text-[10px] text-purple-700">
                                        Scans photos for text. Verifies correct poster installed. Detects graffiti vandalism.
                                    </div>
                                </div>
                                <div className="bg-white/80 rounded-lg p-3 border border-amber-200">
                                    <div className="font-bold text-amber-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üìÅ</span> Link Real Photos
                                    </div>
                                    <div className="text-[10px] text-amber-700">
                                        Click "Link Real Photos" to connect your Google Drive folder. Real install photos load automatically.
                                    </div>
                                </div>
                                <div className="bg-white/80 rounded-lg p-3 border border-green-200">
                                    <div className="font-bold text-green-800 text-xs flex items-center gap-1 mb-1">
                                        <span>üìÑ</span> Performance Report
                                    </div>
                                    <div className="text-[10px] text-green-700">
                                        Generate city compliance reports. Shows completion %, by market, by advertiser. Export or print.
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Filters */}
                    <div className="px-6 py-4 border-b bg-gray-50">
                        <div className="flex flex-wrap items-center gap-3">
                            {/* Market Filter */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Market</label>
                                <select 
                                    value={selectedMarket}
                                    onChange={e => {
                                        setSelectedMarket(e.target.value);
                                        setSelectedAdvertiser('ALL');
                                        setSelectedCampaign('ALL');
                                    }}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white min-w-[200px]"
                                >
                                    <option value="ALL">All Markets ({markets.length})</option>
                                    {markets.map(m => {
                                        const marketCampaigns = data.filter(d => d.market === m).length;
                                        const marketPhotos = photoCountByCampaign ? Object.keys(photoCountByCampaign).filter(cid => {
                                            const photoSource = (localPhotos.length > 0 && !showDemoData) ? localPhotos : popData;
                                            return photoSource.some(p => p.campaignNumber === cid && p.market === m);
                                        }).length : 0;
                                        return (
                                            <option key={m} value={m}>
                                                {m.split(',')[0]} ({marketCampaigns} campaigns)
                                            </option>
                                        );
                                    })}
                                </select>
                            </div>

                            {/* Advertiser Filter */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Advertiser</label>
                                <select 
                                    value={selectedAdvertiser}
                                    onChange={e => {
                                        setSelectedAdvertiser(e.target.value);
                                        setSelectedCampaign('ALL');
                                    }}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white min-w-[200px]"
                                >
                                    <option value="ALL">All Advertisers ({advertisers.length})</option>
                                    {advertisers.map(a => {
                                        let filtered = data.filter(d => d.advertiser === a);
                                        if (selectedMarket !== 'ALL') {
                                            filtered = filtered.filter(d => d.market === selectedMarket);
                                        }
                                        return (
                                            <option key={a} value={a}>
                                                {a} ({filtered.length})
                                            </option>
                                        );
                                    })}
                                </select>
                            </div>

                            {/* Campaign Filter */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Campaign ID</label>
                                <select 
                                    value={selectedCampaign}
                                    onChange={e => setSelectedCampaign(e.target.value)}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white min-w-[220px]"
                                >
                                    <option value="ALL">All Campaigns ({campaigns.length})</option>
                                    {campaigns.map(c => {
                                        const expected = campaignExpectedQty[c];
                                        const photoCount = photoCountByCampaign[c] || 0;
                                        const expectedQty = expected?.expectedQty || '?';
                                        // Show comparison: photos/expected
                                        const comparison = expected 
                                            ? `üì∑${photoCount}/${expectedQty}` 
                                            : `üì∑${photoCount}`;
                                        const status = photoCount > 0 && expected && photoCount >= expectedQty ? '‚úì' : '';
                                        return (
                                            <option key={c} value={c}>
                                                {c} {comparison} {status}
                                            </option>
                                        );
                                    })}
                                </select>
                            </div>

                            {/* Date Range - Flight/Product Start Date */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Flight Date</label>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="date" 
                                        value={dateFilter.start}
                                        onChange={e => setDateFilter(prev => ({ ...prev, start: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                    <span className="text-gray-400">‚Üí</span>
                                    <input 
                                        type="date" 
                                        value={dateFilter.end}
                                        onChange={e => setDateFilter(prev => ({ ...prev, end: e.target.value }))}
                                        className="px-2 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                    />
                                </div>
                            </div>

                            {/* Search */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Search</label>
                                <div className="relative">
                                    <Icon name="Search" size={16} className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" />
                                    <input 
                                        type="text"
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        placeholder="Search campaigns..."
                                        className="pl-8 pr-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white w-48"
                                    />
                                </div>
                            </div>

                            {/* Status Filter (NEW) */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Status</label>
                                <div className="flex items-center gap-0.5 bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                                    <button 
                                        onClick={() => setSelectedStatus('ALL')}
                                        className={`px-2 py-1 text-[11px] font-bold rounded transition-all ${selectedStatus === 'ALL' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        All
                                    </button>
                                    <button 
                                        onClick={() => setSelectedStatus('Installed')}
                                        className={`px-2 py-1 text-[11px] font-bold rounded transition-all flex items-center gap-1 ${selectedStatus === 'Installed' ? 'bg-green-500 text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> Installed
                                    </button>
                                    <button 
                                        onClick={() => setSelectedStatus('Photos Taken')}
                                        className={`px-2 py-1 text-[11px] font-bold rounded transition-all flex items-center gap-1 ${selectedStatus === 'Photos Taken' ? 'bg-gray-600 text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        <span className="w-1.5 h-1.5 rounded-full bg-gray-500"></span> Photos
                                    </button>
                                    <button 
                                        onClick={() => setSelectedStatus('POP Completed')}
                                        className={`px-2 py-1 text-[11px] font-bold rounded transition-all flex items-center gap-1 ${selectedStatus === 'POP Completed' ? 'bg-blue-500 text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        <span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span> POP
                                    </button>
                                </div>
                            </div>

                            {/* Sort */}
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-gray-500 uppercase">Sort By</label>
                                <select 
                                    value={sortBy}
                                    onChange={e => setSortBy(e.target.value)}
                                    className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white"
                                >
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="advertiser">By Advertiser</option>
                                    <option value="campaign">By Campaign #</option>
                                </select>
                            </div>

                            {/* Reset */}
                            <button 
                                onClick={() => {
                                    setSelectedMarket('ALL');
                                    setSelectedAdvertiser('ALL');
                                    setSelectedCampaign('ALL');
                                    setSelectedStatus('ALL');
                                    setDateFilter({ start: '', end: '' });
                                    setSearchTerm('');
                                    setSortBy('date-desc');
                                }}
                                className="mt-5 px-3 py-1.5 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-1"
                            >
                                <Icon name="RotateCcw" size={14} /> Reset
                            </button>
                        </div>
                    </div>

                    {/* Campaign Detail Panel - Shows when a specific campaign is selected */}
                    {selectedCampaign !== 'ALL' && (
                        <div className="px-6 py-4 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-indigo-200">
                            <div className="flex items-start justify-between gap-6">
                                {/* Campaign Info */}
                                <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-2">
                                        <span className="font-mono text-lg font-bold text-indigo-800">{selectedCampaign}</span>
                                        {campaignExpectedQty[selectedCampaign] ? (
                                            <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded">
                                                ‚úì In Master Tracker
                                            </span>
                                        ) : (
                                            <span className="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-bold rounded">
                                                ‚ö† Not in Tracker
                                            </span>
                                        )}
                                    </div>
                                    {campaignExpectedQty[selectedCampaign] && (
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                            <div>
                                                <span className="text-gray-500">Advertiser:</span>
                                                <span className="ml-1 font-medium">{campaignExpectedQty[selectedCampaign].advertiser}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Product:</span>
                                                <span className="ml-1 font-medium text-xs">{campaignExpectedQty[selectedCampaign].product?.split('-')[0]}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Market:</span>
                                                <span className="ml-1 font-medium">{campaignExpectedQty[selectedCampaign].market?.split(',')[0]}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Status:</span>
                                                <span className={`ml-1 font-bold ${
                                                    campaignExpectedQty[selectedCampaign].stage === 'POP Completed' ? 'text-blue-600' :
                                                    campaignExpectedQty[selectedCampaign].stage === 'Installed' ? 'text-green-600' :
                                                    'text-gray-600'
                                                }`}>{campaignExpectedQty[selectedCampaign].stage}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Photo Count vs Expected */}
                                <div className="flex items-center gap-4">
                                    <div className="text-center px-4 py-2 bg-white rounded-lg border border-indigo-200">
                                        <div className="text-2xl font-bold text-indigo-600">
                                            {photoCountByCampaign[selectedCampaign] || 0}
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase font-bold">Photos</div>
                                    </div>
                                    <div className="text-gray-400 text-xl">/</div>
                                    <div className="text-center px-4 py-2 bg-white rounded-lg border border-gray-200">
                                        <div className="text-2xl font-bold text-gray-700">
                                            {campaignExpectedQty[selectedCampaign]?.expectedQty || '?'}
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase font-bold">Expected</div>
                                    </div>
                                    {/* Status indicator */}
                                    <div className={`p-3 rounded-lg ${
                                        !campaignExpectedQty[selectedCampaign] ? 'bg-amber-100' :
                                        (photoCountByCampaign[selectedCampaign] || 0) >= campaignExpectedQty[selectedCampaign].expectedQty ? 'bg-green-100' :
                                        (photoCountByCampaign[selectedCampaign] || 0) > 0 ? 'bg-blue-100' :
                                        'bg-gray-100'
                                    }`}>
                                        {!campaignExpectedQty[selectedCampaign] ? (
                                            <div className="text-center">
                                                <Icon name="AlertCircle" size={24} className="text-amber-600 mx-auto" />
                                                <div className="text-[10px] text-amber-700 font-bold mt-1">No Tracker Data</div>
                                            </div>
                                        ) : (photoCountByCampaign[selectedCampaign] || 0) >= campaignExpectedQty[selectedCampaign].expectedQty ? (
                                            <div className="text-center">
                                                <Icon name="CheckCircle" size={24} className="text-green-600 mx-auto" />
                                                <div className="text-[10px] text-green-700 font-bold mt-1">Complete!</div>
                                            </div>
                                        ) : (photoCountByCampaign[selectedCampaign] || 0) > 0 ? (
                                            <div className="text-center">
                                                <Icon name="Clock" size={24} className="text-blue-600 mx-auto" />
                                                <div className="text-[10px] text-blue-700 font-bold mt-1">In Progress</div>
                                            </div>
                                        ) : (
                                            <div className="text-center">
                                                <Icon name="Camera" size={24} className="text-gray-500 mx-auto" />
                                                <div className="text-[10px] text-gray-600 font-bold mt-1">No Photos</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stats Bar */}
                    <div className="px-6 py-3 bg-white border-b flex items-center justify-between flex-wrap gap-4">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2">
                                <Icon name="Image" size={16} className="text-indigo-500" />
                                <span className="text-sm"><strong>{stats.totalPhotos}</strong> photos</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Icon name="Briefcase" size={16} className="text-purple-500" />
                                <span className="text-sm"><strong>{stats.campaigns}</strong> campaigns</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Icon name="Building" size={16} className="text-blue-500" />
                                <span className="text-sm"><strong>{stats.advertisers}</strong> advertisers</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Icon name="MapPin" size={16} className="text-green-500" />
                                <span className="text-sm"><strong>{stats.markets}</strong> markets</span>
                            </div>
                        </div>
                        
                        {/* Validation Status - Soft warnings */}
                        <div className="flex items-center gap-3">
                            {campaignValidation.matched.length > 0 && (
                                <div className="flex items-center gap-1 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">
                                    <Icon name="CheckCircle" size={12} />
                                    <span>{campaignValidation.matched.length} matched</span>
                                </div>
                            )}
                            {campaignValidation.notInTracker.length > 0 && (
                                <div 
                                    className="flex items-center gap-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full cursor-help"
                                    title={`${campaignValidation.notInTracker.length} campaign(s) in photos not found in Master Tracker. This is OK during testing.`}
                                >
                                    <Icon name="AlertCircle" size={12} />
                                    <span>{campaignValidation.notInTracker.length} not in tracker</span>
                                </div>
                            )}
                            {campaignValidation.missingPhotos.length > 0 && showDemoData === false && (
                                <div 
                                    className="flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full cursor-help"
                                    title={`${campaignValidation.missingPhotos.length} installed campaign(s) don't have photos yet.`}
                                >
                                    <Icon name="Camera" size={12} />
                                    <span>{campaignValidation.missingPhotos.length} need photos</span>
                                </div>
                            )}
                            {stats.isShowingLocal && (
                                <div className="flex items-center gap-1 text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full">
                                    <Icon name="Folder" size={12} />
                                    <span>Local folder</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Validation Alert Banner - Only show if there are issues and using real data */}
                    {!showDemoData && (campaignValidation.notInTracker.length > 0 || campaignValidation.missingPhotos.length > 0) && (
                        <div className="px-6 py-2 bg-amber-50 border-b border-amber-200 flex items-center gap-3">
                            <Icon name="Info" size={16} className="text-amber-600 flex-shrink-0" />
                            <p className="text-xs text-amber-700">
                                <strong>Data Sync Notice:</strong> Some campaigns in your photos aren't in the Master Tracker yet, or some installed campaigns are missing photos. 
                                This is normal during testing - data will sync when both sources are fully connected.
                            </p>
                            <button 
                                onClick={() => {/* Could add a details modal here */}}
                                className="text-xs text-amber-700 underline hover:text-amber-900 flex-shrink-0"
                            >
                                View details
                            </button>
                        </div>
                    )}

                    {/* Content */}
                    <div className="p-6">
                        {filteredPOP.length === 0 ? (
                            <div className="text-center py-16">
                                <Icon name="Camera" size={48} className="mx-auto text-gray-300 mb-4" />
                                <h3 className="text-lg font-semibold text-gray-500">No photos found</h3>
                                <p className="text-gray-400 text-sm mt-1">Try adjusting your filters or upload POP photos</p>
                            </div>
                        ) : viewMode === 'campaigns' ? (
                            /* Campaign Cards View - Grouped by campaign */
                            <div>
                                {/* Demo Mode Banner */}
                                {showDemoData && (
                                    <div className="mb-4 p-3 bg-amber-50 border border-amber-300 rounded-lg flex items-center gap-3">
                                        <Icon name="AlertTriangle" size={20} className="text-amber-600 flex-shrink-0" />
                                        <div className="flex-1">
                                            <div className="text-amber-800 font-bold text-sm">Demo Mode - Placeholder Images</div>
                                            <div className="text-amber-700 text-xs">
                                                Campaign data is real from your tracker. Photos are placeholders (random stock images). 
                                                <strong> Connect your Google Drive folder</strong> to see actual install photos.
                                            </div>
                                        </div>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); handleLinkFolder(); }}
                                            className="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold rounded-lg flex items-center gap-1"
                                        >
                                            <Icon name="Folder" size={14} /> Link Real Photos
                                        </button>
                                    </div>
                                )}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {campaignGroups.map(campaign => (
                                    <div 
                                        key={campaign.campaignNumber}
                                        onClick={() => setExpandedCampaign(campaign)}
                                        className="group cursor-pointer bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl hover:border-indigo-400 transition-all"
                                    >
                                        {/* Cover Photo with Stack Effect */}
                                        <div className="relative h-48 bg-gray-100">
                                            {/* Stacked effect background */}
                                            <div className="absolute inset-0 bg-gray-300 rounded-lg transform rotate-2 translate-x-1 -translate-y-1 opacity-30"></div>
                                            <div className="absolute inset-0 bg-gray-200 rounded-lg transform -rotate-1 translate-x-0.5 opacity-50"></div>
                                            
                                            {/* Main cover photo */}
                                            <img 
                                                src={campaign.coverPhoto?.thumbnailUrl || campaign.coverPhoto?.photoUrl}
                                                alt={campaign.advertiser}
                                                className="relative w-full h-full object-cover group-hover:scale-105 transition-transform z-10"
                                            />
                                            
                                            {/* Photo count badge */}
                                            <div className="absolute top-3 right-3 bg-black/80 text-white px-2 py-1 rounded-lg flex items-center gap-1.5 z-20">
                                                <Icon name="Image" size={14} />
                                                <span className="font-bold">{campaign.photoCount}</span>
                                                <span className="text-gray-300 text-xs">photos</span>
                                            </div>
                                            
                                            {/* Progress overlay */}
                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3 z-20">
                                                <div className="flex items-center justify-between text-white mb-1">
                                                    <span className="text-xs font-medium">
                                                        {campaign.photoCount} / {campaign.expectedQty || '?'} installed
                                                    </span>
                                                    {campaign.expectedQty > 0 && (
                                                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${
                                                            campaign.isComplete ? 'bg-green-500' : 'bg-amber-500'
                                                        }`}>
                                                            {campaign.isComplete ? '‚úì Complete' : `${campaign.missing} missing`}
                                                        </span>
                                                    )}
                                                </div>
                                                {campaign.expectedQty > 0 && (
                                                    <div className="w-full bg-gray-600 rounded-full h-1.5">
                                                        <div 
                                                            className={`h-1.5 rounded-full transition-all ${campaign.isComplete ? 'bg-green-400' : 'bg-amber-400'}`}
                                                            style={{ width: `${campaign.progress}%` }}
                                                        ></div>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Hover overlay */}
                                            <div className="absolute inset-0 bg-indigo-600/0 group-hover:bg-indigo-600/20 transition-colors z-10 flex items-center justify-center">
                                                <div className="opacity-0 group-hover:opacity-100 transition-opacity bg-white px-4 py-2 rounded-lg shadow-lg">
                                                    <span className="text-indigo-700 font-bold text-sm">View All Photos ‚Üí</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Campaign Info */}
                                        <div className="p-4">
                                            <div className="flex items-start justify-between gap-2">
                                                <div className="flex-1 min-w-0">
                                                    <h4 className="font-bold text-gray-800 truncate">{campaign.advertiser}</h4>
                                                    <p className="text-xs text-gray-500 truncate">{campaign.product}</p>
                                                </div>
                                                <span className={`flex-shrink-0 px-2 py-1 rounded text-[10px] font-bold ${
                                                    campaign.stage === 'POP Completed' ? 'bg-blue-100 text-blue-700' :
                                                    campaign.stage === 'Photos Taken' ? 'bg-purple-100 text-purple-700' :
                                                    campaign.stage === 'Installed' ? 'bg-green-100 text-green-700' :
                                                    'bg-gray-100 text-gray-600'
                                                }`}>
                                                    {campaign.stage === 'POP Completed' ? '‚úì POP' : campaign.stage}
                                                </span>
                                            </div>
                                            <div className="mt-2 flex items-center justify-between text-xs text-gray-500">
                                                <span className="font-mono">{campaign.campaignNumber}</span>
                                                <span>{campaign.market?.split(',')[0]}</span>
                                            </div>
                                            {campaign.latestDate && (
                                                <div className="mt-1 text-[10px] text-gray-400">
                                                    Latest: {campaign.latestDate.toLocaleDateString()}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                </div>
                            </div>
                        ) : viewMode === 'timeline' ? (
                            /* Timeline View - Photos organized by date for selected campaign */
                            <div>
                                {/* Campaign selector for timeline */}
                                {selectedCampaign === 'ALL' ? (
                                    <div className="mb-6 p-6 bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl text-center">
                                        <Icon name="Calendar" size={48} className="mx-auto text-indigo-400 mb-3" />
                                        <h3 className="text-lg font-bold text-gray-800 mb-2">Select a Campaign to View Timeline</h3>
                                        <p className="text-gray-600 text-sm mb-4">Choose a specific campaign from the filter above to see installation photos organized by date.</p>
                                        <div className="flex flex-wrap justify-center gap-2">
                                            {campaignGroups.slice(0, 6).map(c => (
                                                <button
                                                    key={c.campaignNumber}
                                                    onClick={() => setSelectedCampaign(c.campaignNumber)}
                                                    className="px-3 py-2 bg-white border border-indigo-300 hover:bg-indigo-100 hover:border-indigo-400 rounded-lg text-sm font-medium text-indigo-700 transition-all"
                                                >
                                                    {c.advertiser} ({c.photoCount} photos)
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        {/* Timeline header */}
                                        <div className="mb-4 flex items-center justify-between">
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-800">
                                                    Installation Timeline: {campaignGroups.find(c => c.campaignNumber === selectedCampaign)?.advertiser || selectedCampaign}
                                                </h3>
                                                <p className="text-sm text-gray-500">
                                                    {filteredPOP.length} photos across {[...new Set(filteredPOP.map(p => p.installDate?.toDateString()))].filter(Boolean).length} days
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setSelectedCampaign('ALL')}
                                                className="px-3 py-1.5 text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg flex items-center gap-1"
                                            >
                                                <Icon name="X" size={14} /> Clear Selection
                                            </button>
                                        </div>
                                        
                                        {/* Timeline by date */}
                                        <div className="space-y-6">
                                            {(() => {
                                                // Group photos by date
                                                const photosByDate = {};
                                                filteredPOP.forEach(photo => {
                                                    const dateKey = photo.installDate?.toDateString() || 'Unknown Date';
                                                    if (!photosByDate[dateKey]) photosByDate[dateKey] = [];
                                                    photosByDate[dateKey].push(photo);
                                                });
                                                
                                                // Sort dates newest first
                                                const sortedDates = Object.keys(photosByDate).sort((a, b) => {
                                                    if (a === 'Unknown Date') return 1;
                                                    if (b === 'Unknown Date') return -1;
                                                    return new Date(b) - new Date(a);
                                                });
                                                
                                                return sortedDates.map((dateKey, idx) => (
                                                    <div key={dateKey} className="relative">
                                                        {/* Timeline connector */}
                                                        {idx < sortedDates.length - 1 && (
                                                            <div className="absolute left-6 top-12 bottom-0 w-0.5 bg-indigo-200"></div>
                                                        )}
                                                        
                                                        {/* Date header */}
                                                        <div className="flex items-center gap-4 mb-3">
                                                            <div className="w-12 h-12 rounded-full bg-indigo-500 text-white flex flex-col items-center justify-center flex-shrink-0 shadow-lg">
                                                                <span className="text-xs font-bold">
                                                                    {dateKey !== 'Unknown Date' ? new Date(dateKey).toLocaleDateString('en-US', { month: 'short' }) : '?'}
                                                                </span>
                                                                <span className="text-lg font-bold leading-none">
                                                                    {dateKey !== 'Unknown Date' ? new Date(dateKey).getDate() : '?'}
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <h4 className="font-bold text-gray-800">
                                                                    {dateKey !== 'Unknown Date' ? new Date(dateKey).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Unknown Date'}
                                                                </h4>
                                                                <p className="text-sm text-gray-500">{photosByDate[dateKey].length} photos installed</p>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Photos for this date */}
                                                        <div className="ml-16 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                            {photosByDate[dateKey].map(photo => (
                                                                <div 
                                                                    key={photo.id}
                                                                    onClick={() => setSelectedPhoto(photo)}
                                                                    className="group cursor-pointer bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg hover:border-indigo-300 transition-all"
                                                                >
                                                                    <div className="relative aspect-[4/3] bg-gray-100">
                                                                        <img 
                                                                            src={photo.thumbnailUrl}
                                                                            alt={photo.advertiser}
                                                                            className="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                                                        />
                                                                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                                                                            <Icon name="ZoomIn" size={20} className="text-white opacity-0 group-hover:opacity-100 transition-opacity" />
                                                                        </div>
                                                                    </div>
                                                                    <div className="p-2">
                                                                        <p className="text-xs text-gray-600 truncate">{photo.product || photo.mediaType}</p>
                                                                        <p className="text-[10px] text-gray-400">{photo.market}</p>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : viewMode === 'grid' ? (
                            /* Grid View */
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                {filteredPOP.map(photo => (
                                    <div 
                                        key={photo.id}
                                        onClick={() => setSelectedPhoto(photo)}
                                        className="group cursor-pointer bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg hover:border-indigo-300 transition-all"
                                    >
                                        <div className="relative aspect-[4/3] bg-gray-100">
                                            <img 
                                                src={photo.thumbnailUrl}
                                                alt={photo.advertiser}
                                                className="w-full h-full object-cover group-hover:scale-105 transition-transform"
                                            />
                                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                                                <Icon name="ZoomIn" size={24} className="text-white opacity-0 group-hover:opacity-100 transition-opacity" />
                                            </div>
                                            {/* Photo count badge */}
                                            {photo.totalPhotos > 1 && (
                                                <div className="absolute top-2 right-2 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1">
                                                    <Icon name="Image" size={10} /> {photo.totalPhotos}
                                                </div>
                                            )}
                                            {/* Status badge */}
                                            <div className={`absolute bottom-2 left-2 px-1.5 py-0.5 rounded text-[10px] font-bold ${
                                                photo.stage === 'Installed' ? 'bg-green-500 text-white' :
                                                photo.stage === 'POP Completed' ? 'bg-blue-500 text-white' :
                                                'bg-gray-500 text-white'
                                            }`}>
                                                {photo.stage === 'POP Completed' ? '‚úì POP' : photo.stage}
                                            </div>
                                        </div>
                                        <div className="p-2">
                                            <p className="font-semibold text-sm text-gray-800 truncate">{photo.advertiser}</p>
                                            <p className="text-[11px] text-gray-500 truncate">{photo.product}</p>
                                            <div className="flex items-center justify-between mt-1">
                                                <span className="text-[10px] text-gray-400 font-mono">{photo.campaignNumber}</span>
                                                <span className="text-[10px] text-gray-400">{photo.installDate?.toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            /* List View */
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="bg-gray-50 border-b">
                                            <th className="text-left p-3 font-semibold text-gray-600">Photo</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Campaign</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Advertiser</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Market</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Media</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Install Date</th>
                                            <th className="text-left p-3 font-semibold text-gray-600">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredPOP.map(photo => (
                                            <tr 
                                                key={photo.id}
                                                onClick={() => setSelectedPhoto(photo)}
                                                className="border-b hover:bg-indigo-50 cursor-pointer transition-colors"
                                            >
                                                <td className="p-3">
                                                    <img 
                                                        src={photo.thumbnailUrl}
                                                        alt={photo.advertiser}
                                                        className="w-16 h-12 object-cover rounded"
                                                    />
                                                </td>
                                                <td className="p-3 font-mono text-xs">{photo.campaignNumber}</td>
                                                <td className="p-3 font-medium">{photo.advertiser}</td>
                                                <td className="p-3 text-gray-600">{photo.market?.split(',')[0]}</td>
                                                <td className="p-3 text-gray-600 text-xs">{photo.product}</td>
                                                <td className="p-3 text-gray-600">{photo.installDate?.toLocaleDateString()}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                        photo.stage === 'Installed' ? 'bg-green-100 text-green-700' :
                                                        photo.stage === 'POP Completed' ? 'bg-blue-100 text-blue-700' :
                                                        'bg-gray-100 text-gray-700'
                                                    }`}>
                                                        {photo.stage}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* Local Folder Connection Banner */}
                    <div className="px-6 py-4 border-t bg-gradient-to-r from-blue-50 to-indigo-50">
                        {linkedFolder ? (
                            /* Connected State */
                            <div className="space-y-3">
                                <div className="flex items-center justify-between flex-wrap gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-green-100 rounded-lg shadow-sm flex items-center justify-center">
                                            <Icon name="FolderOpen" size={24} className="text-green-600" />
                                        </div>
                                        <div>
                                            <p className="font-semibold text-green-700 flex items-center gap-2">
                                                <Icon name="CheckCircle" size={16} /> Folder Linked
                                            </p>
                                            <p className="text-sm text-gray-600">
                                                <strong>{linkedFolder.name}</strong> ‚Ä¢ {localPhotos.length} photos found
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {/* Toggle Demo/Local */}
                                        <div className="flex items-center gap-1 bg-white rounded-lg p-0.5 border border-gray-200">
                                            <button 
                                                onClick={() => setShowDemoData(false)}
                                                className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${!showDemoData ? 'bg-green-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                            >
                                                üìÅ Local ({localPhotos.length})
                                            </button>
                                            <button 
                                                onClick={() => setShowDemoData(true)}
                                                className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${showDemoData ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:bg-gray-100'}`}
                                            >
                                                üé≠ Demo
                                            </button>
                                        </div>
                                        <button 
                                            onClick={handleRefreshFolder}
                                            disabled={scanningFolder}
                                            className="px-3 py-2 bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                                        >
                                            <Icon name="RefreshCw" size={14} className={scanningFolder ? 'animate-spin' : ''} />
                                            {scanningFolder ? 'Scanning...' : 'Refresh'}
                                        </button>
                                        <button 
                                            onClick={() => { setLinkedFolder(null); setLocalPhotos([]); setShowDemoData(true); }}
                                            className="px-3 py-2 bg-white hover:bg-red-50 border border-gray-300 text-red-600 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            Unlink
                                        </button>
                                    </div>
                                </div>
                                {!showDemoData && localPhotos.length > 0 && (
                                    <div className="p-2 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2">
                                        <Icon name="Info" size={14} className="text-green-600" />
                                        <span className="text-xs text-green-700">
                                            Showing <strong>{localPhotos.length}</strong> photos from your local Google Drive folder. Photos are NOT uploaded - they're read directly from your computer.
                                        </span>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* Disconnected State */
                            <div className="space-y-3">
                                <div className="flex items-center justify-between flex-wrap gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white rounded-lg shadow-sm flex items-center justify-center">
                                            <svg className="w-6 h-6" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
                                                <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
                                                <path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/>
                                                <path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"/>
                                                <path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/>
                                                <path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/>
                                                <path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <p className="font-semibold text-gray-800">Link Your POP Photos Folder</p>
                                            <p className="text-sm text-gray-500">
                                                Browse photos directly from your Google Drive (via Desktop app)
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={handleLinkFolder}
                                            disabled={scanningFolder}
                                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition-colors flex items-center gap-2"
                                        >
                                            {scanningFolder ? (
                                                <>
                                                    <Icon name="RefreshCw" size={16} className="animate-spin" /> Scanning...
                                                </>
                                            ) : (
                                                <>
                                                    <Icon name="FolderOpen" size={16} /> Select Folder
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                                {folderError && (
                                    <div className="p-2 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                                        <Icon name="AlertCircle" size={14} className="text-red-600" />
                                        <span className="text-xs text-red-700">{folderError}</span>
                                    </div>
                                )}
                                <div className="p-3 bg-white/50 rounded-lg border border-blue-200">
                                    <p className="text-xs text-gray-600 mb-2">
                                        <strong>üìÅ Expected folder structure:</strong>
                                    </p>
                                    <code className="text-xs text-indigo-600 block bg-white p-2 rounded border">
                                        POP Photos/<br/>
                                        ‚îú‚îÄ‚îÄ Los Angeles - STAP/<br/>
                                        ‚îÇ   ‚îú‚îÄ‚îÄ 250922043-0/<br/>
                                        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025-01-15/<br/>
                                        ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ install_1.jpg<br/>
                                        ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ install_2.jpg<br/>
                                        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2025-01-20/<br/>
                                        ‚îÇ   ‚îî‚îÄ‚îÄ 251021006-0/<br/>
                                        ‚îî‚îÄ‚îÄ Miami/
                                    </code>
                                    <p className="text-xs text-gray-500 mt-2">
                                        üí° <strong>Tip:</strong> Install <a href="https://www.google.com/drive/download/" target="_blank" className="text-indigo-600 underline">Google Drive for Desktop</a> to sync your Drive folder locally.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Photo Modal */}
                    {selectedPhoto && (
                        <PhotoModal 
                            photo={selectedPhoto}
                            onClose={() => setSelectedPhoto(null)}
                        />
                    )}

                    {/* Expanded Campaign Modal - All photos for a campaign */}
                    {expandedCampaign && (
                        <CampaignPhotosModal 
                            campaign={expandedCampaign}
                            onClose={() => setExpandedCampaign(null)}
                        />
                    )}
                </div>
            );
        };

        const AuthorizedDashboard = ({ onLogout, isDemoMode = false }) => {
            const [view, setView] = useState('upload');
            const [files, setFiles] = useState({ holds: null, install: null });
            const [processing, setProcessing] = useState(false);
            
            // ============================================
            // DATA PERSISTENCE & MANUAL OVERRIDES SYSTEM
            // ============================================
            /*
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ                    DATA FLOW ARCHITECTURE                           ‚îÇ
            ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
            ‚îÇ                                                                     ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
            ‚îÇ   ‚îÇ Google Sheet ‚îÇ     ‚îÇ  CSV Upload  ‚îÇ     ‚îÇ  Demo Data   ‚îÇ       ‚îÇ
            ‚îÇ   ‚îÇ   (Live)     ‚îÇ     ‚îÇ   (Manual)   ‚îÇ     ‚îÇ   (Mock)     ‚îÇ       ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
            ‚îÇ          ‚îÇ                    ‚îÇ                    ‚îÇ               ‚îÇ
            ‚îÇ          ‚ñº                    ‚ñº                    ‚ñº               ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ                    baseData (State)                      ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ         { holds: [], installs: [], specialty: [] }       ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ                                                          ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   üì¶ Auto-persisted to localStorage (stap_csv_data)      ‚îÇ      ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ                            ‚ñº                                       ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ              manualOverrides (State)                     ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   { campaignId: { stage, installed, pending, notes } }   ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ                                                          ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   ‚úèÔ∏è Auto-persisted to localStorage (stap_manual_overrides)‚îÇ     ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ                            ‚ñº                                       ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
            ‚îÇ   ‚îÇ              processedData (useMemo)                     ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   Combines baseData + manualOverrides                    ‚îÇ      ‚îÇ
            ‚îÇ   ‚îÇ   Categorizes into: delayed, inProgress, installed, etc. ‚îÇ      ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
            ‚îÇ                            ‚îÇ                                       ‚îÇ
            ‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
            ‚îÇ          ‚ñº                 ‚ñº                 ‚ñº                     ‚îÇ
            ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
            ‚îÇ   ‚îÇ Dashboard  ‚îÇ    ‚îÇ   Daily    ‚îÇ    ‚îÇ  Update    ‚îÇ              ‚îÇ
            ‚îÇ   ‚îÇ  Widgets   ‚îÇ    ‚îÇ   Digest   ‚îÇ    ‚îÇ  Stages    ‚îÇ              ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
            ‚îÇ                                                                    ‚îÇ
            ‚îÇ   SMART FALLBACK SYNC:                                            ‚îÇ
            ‚îÇ   1. Try Google Sheet via CORS proxies                            ‚îÇ
            ‚îÇ   2. If ALL fail ‚Üí Load from localStorage (persisted CSV)         ‚îÇ
            ‚îÇ   3. Show "Cached" indicator + warning                            ‚îÇ
            ‚îÇ                                                                    ‚îÇ
            ‚îÇ   PERSISTENCE RULES:                                              ‚îÇ
            ‚îÇ   ‚Ä¢ CSV data persists across sessions until new upload            ‚îÇ
            ‚îÇ   ‚Ä¢ Manual overrides persist indefinitely                         ‚îÇ
            ‚îÇ   ‚Ä¢ "Reset Data" clears session; "Clear All" clears storage       ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            */
            // Priority: Google Sheet (Live) > Manual Overrides > Persisted CSV > Empty
            
            // Load persisted CSV data from localStorage on init
            const [baseData, setBaseData] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_csv_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('üìÇ Loaded persisted CSV data:', parsed.holds?.length || 0, 'holds,', parsed.installs?.length || 0, 'installs');

                        return parsed;
                    }
                } catch (e) {
                    console.warn('Could not load persisted CSV data:', e);
                }
                return { holds: [], installs: [] };
            });
            
            // Extended manual overrides: { campaignId: { stage?, installed?, pending?, notes? } }
            const [manualOverrides, setManualOverrides] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_manual_overrides');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const count = Object.keys(parsed).length;
                        if (count > 0) {
                            console.log(`‚úèÔ∏è Loaded ${count} manual override(s) from localStorage`);
                        }
                        return parsed;
                    }
                    return {};
                } catch (e) {
                    console.warn('Could not load manual overrides:', e);
                    return {};
                }
            });

            // One-time migration: Move legacy stap_production_proof data into stap_manual_overrides
            useEffect(() => {
                try {
                    const legacyProofs = localStorage.getItem('stap_production_proof');
                    if (legacyProofs) {
                        const proofData = JSON.parse(legacyProofs);
                        const migratedCount = Object.keys(proofData).length;
                        if (migratedCount > 0) {
                            setManualOverrides(prev => {
                                const merged = { ...prev };
                                Object.entries(proofData).forEach(([key, value]) => {
                                    merged[key] = { ...(merged[key] || {}), productionProof: value };
                                });
                                return merged;
                            });
                            localStorage.removeItem('stap_production_proof'); // Clean up legacy key
                            console.log(`üîÑ Migrated ${migratedCount} production proof(s) to unified storage`);
                        }
                    }
                } catch (e) {
                    console.warn('Could not migrate production proofs:', e);
                }
            }, []);

            // Track data source for UI feedback
            const [dataSource, setDataSource] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_data_source');
                    return saved ? JSON.parse(saved) : { type: 'none', timestamp: null, error: null };
                } catch (e) {
                    return { type: 'none', timestamp: null, error: null };
                }
            });
            
            // Persist CSV data to localStorage whenever it changes
            // With quota handling and data optimization for large datasets
            const [storageWarning, setStorageWarning] = useState(null);
            
            useEffect(() => {
                if (baseData.holds?.length > 0 || baseData.installs?.length > 0) {
                    const saveToStorage = async () => {
                        try {
                            // Optimize data by removing redundant fields for storage
                            const optimizedData = {
                                holds: baseData.holds?.map(item => {
                                    // Keep essential fields only, remove computed/display fields
                                    const { 
                                        // Keep these
                                        id, date, endDate, productEndDate, programEndDate,
                                        advertiser, name, rawName, owner, market, product, media,
                                        stage, quantity, totalQty, installed, totalInstalled, pending,
                                        isGhost, ghostReason, isComplete, hasBonus, bonusNote,
                                        // Skip dateObj - we'll reconstruct from date string
                                        dateObj, endDateObj, productEndDateObj, programEndDateObj,
                                        ...rest 
                                    } = item;
                                    return {
                                        id, date, endDate, productEndDate, programEndDate,
                                        advertiser, name, rawName, owner, market, product, media,
                                        stage, quantity, totalQty, installed, totalInstalled, pending,
                                        isGhost, ghostReason, isComplete, hasBonus, bonusNote
                                    };
                                }) || [],
                                installs: baseData.installs?.map(item => {
                                    const { dateObj, endDateObj, productEndDateObj, programEndDateObj, ...rest } = item;
                                    return rest;
                                }) || [],
                                specialtyHolds: baseData.specialtyHolds?.map(item => {
                                    const { dateObj, endDateObj, ...rest } = item;
                                    return rest;
                                }) || [],
                                lost: baseData.lost?.map(item => {
                                    const { dateObj, endDateObj, ...rest } = item;
                                    return rest;
                                }) || []
                            };
                            
                            const jsonString = JSON.stringify(optimizedData);
                            const sizeInMB = (jsonString.length / (1024 * 1024)).toFixed(2);
                            
                            console.log(`üíæ Attempting to save ${baseData.holds?.length || 0} rows (${sizeInMB} MB)...`);
                            
                            // Check if data is too large (warn at 4MB, localStorage typically allows 5-10MB)
                            if (jsonString.length > 4 * 1024 * 1024) {
                                console.warn(`‚ö†Ô∏è Data size (${sizeInMB} MB) is large - may fail on some browsers`);
                                setStorageWarning(`Large dataset (${sizeInMB} MB) - persistence may be limited`);
                            } else {
                                setStorageWarning(null);
                            }
                            
                            // Try localStorage first
                            localStorage.setItem('stap_csv_data', jsonString);
                            console.log(`‚úÖ CSV data persisted to localStorage (${sizeInMB} MB, ${baseData.holds?.length || 0} rows)`);
                            
                        } catch (e) {
                            // Handle quota exceeded error
                            if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                                console.error('‚ùå localStorage quota exceeded!', e);
                                setStorageWarning('‚ö†Ô∏è Data too large for browser storage. Your session will not persist after refresh.');
                                
                                // Try to save at least the data source info so user knows data isn't persisted
                                try {
                                    localStorage.setItem('stap_storage_overflow', 'true');
                                } catch (e2) {
                                    // Storage completely full
                                }
                            } else {
                                console.warn('Could not persist CSV data:', e);
                                setStorageWarning('Storage error: ' + e.message);
                            }
                        }
                    };
                    
                    saveToStorage();
                }
            }, [baseData]);
            
            // Persist manual overrides to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('stap_manual_overrides', JSON.stringify(manualOverrides));
                } catch (e) {
                    console.warn('Could not persist manual overrides:', e);
                }
            }, [manualOverrides]);
            
            // Persist data source info
            useEffect(() => {
                try {
                    localStorage.setItem('stap_data_source', JSON.stringify(dataSource));
                } catch (e) {
                    console.warn('Could not persist data source info:', e);
                }
            }, [dataSource]);
            
            // Note: We no longer auto-navigate to dashboard on login.
            // Instead, we show a "Resume Previous Session" card on the upload screen
            // This gives users explicit control over whether to use cached data.
            
            // Function to update manual override for a campaign
            const updateManualOverride = (campaignId, updates) => {
                setManualOverrides(prev => ({
                    ...prev,
                    [campaignId]: {
                        ...(prev[campaignId] || {}),
                        ...updates,
                        lastModified: new Date().toISOString()
                    }
                }));
            };
            
            // Function to clear a specific override
            const clearManualOverride = (campaignId) => {
                setManualOverrides(prev => {
                    const updated = { ...prev };
                    delete updated[campaignId];
                    return updated;
                });
            };
            
            // Function to clear all overrides
            const clearAllOverrides = () => {
                setManualOverrides({});
            };
            
            // Function to explicitly clear persisted CSV (for new upload)
            const clearPersistedData = () => {
                try {
                    localStorage.removeItem('stap_csv_data');
                    localStorage.removeItem('stap_data_source');
                    setBaseData({ holds: [], installs: [] });
                    setDataSource({ type: 'none', timestamp: null, error: null });
                    console.log('üóëÔ∏è Persisted data cleared');
                } catch (e) {
                    console.warn('Could not clear persisted data:', e);
                }
            };
            
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [columnMappingInfo, setColumnMappingInfo] = useState(null); // NEW: Column mapping feedback
            
            // SIDEBAR COLLAPSE STATE - for magical appear/vanish
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            
            // DEMO MODE - Show helpful tips and explanations
            // When isLiveMode is true, all demo tips/guides are hidden (unless in demo mode)
            // isDemoMode prop from App determines if we're in demo presentation mode
            const [showDemoTips, setShowDemoTips] = useState(isDemoMode);
            const [isLiveMode, setIsLiveMode] = useState(false); // Set to true when real data is uploaded
            const [showWelcomeModal, setShowWelcomeModal] = useState(isDemoMode); // Show welcome on first demo entry
            
            // Material Receivers data (lifted to parent to persist across navigation)
            // Initialize from localStorage if available
            const [materialReceiverData, setMaterialReceiverData] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_materials_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('üì¶ Loaded', parsed.length, 'materials from localStorage');
                        return parsed;
                    }
                } catch (e) {
                    console.error('Failed to load materials from localStorage:', e);
                }
                return [];
            });
            const [materialReceiverLinkedSheet, setMaterialReceiverLinkedSheet] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_materials_sheet');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null;
                }
            });
            
            // Save materials to localStorage whenever they change
            React.useEffect(() => {
                if (materialReceiverData.length > 0) {
                    localStorage.setItem('stap_materials_data', JSON.stringify(materialReceiverData));
                    console.log('üíæ Saved', materialReceiverData.length, 'materials to localStorage');
                }
            }, [materialReceiverData]);
            
            // Save linked sheet info to localStorage
            React.useEffect(() => {
                if (materialReceiverLinkedSheet) {
                    localStorage.setItem('stap_materials_sheet', JSON.stringify(materialReceiverLinkedSheet));
                }
            }, [materialReceiverLinkedSheet]);
            
            // Auto-sync isLiveMode when materials data changes
            React.useEffect(() => {
                if (materialReceiverData.length > 0) {
                    setIsLiveMode(true);
                } else {
                    setIsLiveMode(false);
                }
            }, [materialReceiverData]);
            
            // NEW: Header Filter State - Now supports multiple selections
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [dateSort, setDateSort] = useState('desc'); // Default Descending (Newest to Oldest / Most Recent First)
            const [marketFilters, setMarketFilters] = useState([]); // Array of selected markets/groups
            const [productFilters, setProductFilters] = useState([]); // Array of selected products/groups
            const [productionFilter, setProductionFilter] = useState('ALL'); // 'ALL', 'in-house', 'client', 'mixed', 'unset'
            
            // SMART GROUPINGS - Market Regions
            const MARKET_GROUPS = {
                'West Coast': ['Los Angeles', 'San Francisco', 'Seattle', 'San Diego', 'Portland', 'Sacramento'],
                'East Coast': ['New York', 'Boston', 'Philadelphia', 'Washington', 'Baltimore', 'Newark'],
                'Southwest': ['Dallas', 'Houston', 'Phoenix', 'Austin', 'San Antonio', 'Denver'],
                'Southeast': ['Miami', 'Orlando', 'Atlanta', 'Tampa', 'Charlotte', 'Nashville'],
                'Midwest': ['Chicago', 'Detroit', 'Minneapolis', 'Cleveland', 'Indianapolis', 'Columbus']
            };
            
            // SMART GROUPINGS - Product Categories  
            const PRODUCT_GROUPS = {
                'All Digital': ['Digital Network-Spot', 'Digital Panel-Spot', 'Digital Network-Quarter Spot', 'Digital Domination', 'Digital Panel-Spot-Playlist'],
                'All Static Panels': ['Panel-Targeted', 'Panel-Network', 'Panel-Icon'],
                'Premium Units': ['Domination', 'Full Wrap', 'Production Embellishments']
            };
            
            // Customization State
            const [visibleStatKeys, setVisibleStatKeys] = useState(() => {
                try {
                    const saved = localStorage.getItem('stap_dashboard_prefs');
                    const parsed = saved ? JSON.parse(saved) : null;
                    // Validate that parsed is an array with valid keys
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('üìä Dashboard prefs loaded:', parsed);
                        return parsed;
                    }
                } catch (e) {
                    console.error('‚ùå Error loading dashboard prefs:', e);
                }
                console.log('üìä Using default dashboard cards');
                return DEFAULT_VISIBLE_CARDS;
            });
            const [isCustomizeModalOpen, setIsCustomizeModalOpen] = useState(false);
            
            // NEW: Custom Widgets State
            const [customWidgets, setCustomWidgets] = useState(() => {
                const saved = localStorage.getItem('stap_custom_widgets');
                return saved ? JSON.parse(saved) : [];
            });
            const [isCustomWidgetModalOpen, setIsCustomWidgetModalOpen] = useState(false);
            const [editingWidget, setEditingWidget] = useState(null);
            
            // Save custom widgets to localStorage
            useEffect(() => {
                localStorage.setItem('stap_custom_widgets', JSON.stringify(customWidgets));
            }, [customWidgets]);
            
            // NEW: Digest Modal State
            const [isDigestModalOpen, setIsDigestModalOpen] = useState(false);
            
            // NEW: Geopath Impressions Modal State
            const [isImpressionsModalOpen, setIsImpressionsModalOpen] = useState(false);

            // AI Pipeline Insight State
            const [pipelineInsight, setPipelineInsight] = useState('');
            const [isInsightLoading, setIsInsightLoading] = useState(false);

            // --- DEBUGGER STATE (Required for Console) ---
            const [debugLogs, setDebugLogs] = useState([]);
            // NEW: State to hide/show the console
            const [showDebug, setShowDebug] = useState(false); 
            const [secretClicks, setSecretClicks] = useState(0); // Track clicks

            const addLog = (msg) => {
                setDebugLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev]);
            };
            const clearLogs = () => setDebugLogs([]);

            // NEW: Secret Handler
            const handleSecretMode = () => {
                const newCount = secretClicks + 1;
                setSecretClicks(newCount);
                if (newCount === 5) {
                    setShowDebug(prev => !prev); // Toggle on/off
                    setSecretClicks(0); // Reset counter
                    // Optional: distinct visual cue
                    if (!showDebug) alert("üë®‚Äçüíª Developer Mode Enabled: Debug Console is now visible.");
                }
            };

            // --- EMAIL STATS LOGIC (NEW) ---
            const [emailStats, setEmailStats] = useState(() => {
                const saved = localStorage.getItem('stap_email_log');
                return saved ? JSON.parse(saved) : {};
            });

            useEffect(() => {
                localStorage.setItem('stap_email_log', JSON.stringify(emailStats));
            }, [emailStats]);

            const handleLogEmail = (key) => {
                setEmailStats(prev => ({
                    ...prev,
                    [key]: (prev[key] || 0) + 1
                }));
            };

            const handleResetEmailLogs = () => {
                if (confirm("Are you sure you want to clear all email sent logs? This cannot be undone.")) {
                    setEmailStats({});
                }
            };

            useEffect(() => {
                localStorage.setItem('stap_dashboard_prefs', JSON.stringify(visibleStatKeys));
            }, [visibleStatKeys]);

            const handleToggleStat = (key) => {
                setVisibleStatKeys(prev => 
                    prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]
                );
            };

            const handleResetStats = () => {
                setVisibleStatKeys(DEFAULT_VISIBLE_CARDS);
                // Also reset filters when resetting stats
                setMarketFilters([]);
                setProductFilters([]);
                setProductionFilter('ALL');
                console.log('üîÑ Dashboard reset to defaults');
            };

            // Production Proof Webhook for Google Sheet Sync
            const [proofWebhookUrl, setProofWebhookUrl] = useState(
                localStorage.getItem('stap_proof_webhook') || ''
            );

            const saveProofWebhookUrl = (url) => {
                setProofWebhookUrl(url);
                localStorage.setItem('stap_proof_webhook', url);
            };

            /**
             * Syncs production proof changes to Google Sheet via Apps Script webhook
             * @param {string} campaignKey - Composite key for the campaign
             * @param {string} productionProof - 'in-house', 'client', or 'mixed'
             */
            const syncProofToSheet = async (campaignKey, productionProof) => {
                if (!proofWebhookUrl) return; // No webhook configured

                try {
                    await fetch(proofWebhookUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateProof',
                            campaignKey,
                            productionProof,
                            timestamp: new Date().toISOString()
                        })
                    });
                    console.log(`üì§ Proof synced to Sheet: ${campaignKey} ‚Üí ${productionProof}`);
                } catch (e) {
                    console.warn('Proof sync failed:', e);
                }
            };

            /**
             * Updates campaign override data (stage, install counts, production proof, etc.)
             * @param {string} campaignKey - Composite key: `${campaignId}_${date}` for unique identification
             * @param {string} newStage - New stage value (can be same as current if only updating other fields)
             * @param {Object} additionalUpdates - Optional fields: { productionProof, installed, pending, notes, photosLink, receiverLink, materialBreakdown }
             */
            const handleUpdateStage = (campaignKey, newStage, additionalUpdates = {}) => {
                const updates = { stage: newStage, ...additionalUpdates };
                updateManualOverride(campaignKey, updates);

                // If material data is provided, also store it for Material Receiver sync
                if (additionalUpdates.materialBreakdown || additionalUpdates.photosLink || additionalUpdates.receiverLink) {
                    const materialData = JSON.parse(localStorage.getItem('stap_material_data') || '{}');
                    materialData[campaignKey] = {
                        materialBreakdown: additionalUpdates.materialBreakdown || [],
                        photosLink: additionalUpdates.photosLink || null,
                        receiverLink: additionalUpdates.receiverLink || null,
                        mediaType: additionalUpdates.mediaType || null,
                        totalQty: additionalUpdates.totalQty || null,
                        updatedAt: new Date().toISOString()
                    };
                    localStorage.setItem('stap_material_data', JSON.stringify(materialData));
                    console.log('üì¶ Material data synced for:', campaignKey);
                }

                // Sync production proof to Google Sheet if webhook is configured
                if (additionalUpdates.productionProof) {
                    syncProofToSheet(campaignKey, additionalUpdates.productionProof);
                }

                // Also update the selected item so the modal reflects changes instantly
                setSelectedItem(prev => {
                    if (!prev) return null;
                    const updated = { ...prev, stage: newStage, isOverridden: true };
                    if (additionalUpdates.installed !== undefined) {
                        updated.totalInstalled = additionalUpdates.installed;
                        updated.installed = additionalUpdates.installed;
                        const totalQty = prev.totalQty || prev.quantity || 0;
                        updated.pending = Math.max(0, totalQty - additionalUpdates.installed);
                    }
                    if (additionalUpdates.photosLink) updated.photosLink = additionalUpdates.photosLink;
                    if (additionalUpdates.receiverLink) updated.receiverLink = additionalUpdates.receiverLink;
                    if (additionalUpdates.materialBreakdown) updated.materialBreakdown = additionalUpdates.materialBreakdown;
                    if (additionalUpdates.productionProof) updated.productionProof = additionalUpdates.productionProof;
                    return updated;
                });
            };

            // Quick update for install count only (from inline edit)
            const handleUpdateInstallCount = (id, installedCount) => {
                updateManualOverride(id, { installed: installedCount });
            };

            // Handler for resetting data to be passed to Sidebar
            const handleResetData = (clearPersisted = false) => {
                setFiles({holds:null, install:null});
                setBaseData({ holds: [], installs: [] });
                setColumnMappingInfo(null); // Reset column mapping
                setView('upload');
                setDateFilter({ start: '', end: '' }); // Reset date filters
                setMarketFilters([]); // Reset market filters
                setProductFilters([]); // Reset product filters
                
                if (clearPersisted) {
                    clearPersistedData();
                    clearAllOverrides();
                }
            };

            // üëª GHOST BOOKING STATE
            const [ghostBookings, setGhostBookings] = useState([]);
            const [showGhostAlert, setShowGhostAlert] = useState(false);
            const [includeGhosts, setIncludeGhosts] = useState(false); // Toggle to include/exclude ghosts
            
            // üîß GOOGLE SHEET SETTINGS (Hidden Feature)
            const [showSheetSettings, setShowSheetSettings] = useState(false);

            // Main processing function (UPGRADED: Single Source of Truth)
            const runProcessingLogic = (rawData, rawInstalls = null) => {
                // Process using unified Master Export processor
                const result = processMasterExport(rawData);
                
                // Capture column mapping info for UI feedback
                if (window.__lastColumnMapping) {
                    setColumnMappingInfo(window.__lastColumnMapping);
                    const { matched, total, missingRequired } = window.__lastColumnMapping;
                    if (missingRequired.length > 0) {
                        addLog(`‚ö†Ô∏è Column mapping: ${matched}/${total} matched. Missing required: ${missingRequired.join(', ')}`);
                    } else {
                        addLog(`‚úÖ Smart column mapping: ${matched}/${total} columns matched successfully`);
                    }
                }
                
                const data = {
                    holds: result.regular,
                    installs: result.regular, // Same data source now
                    specialtyHolds: result.specialty,
                    lost: result.lost
                };

                // üëª Handle Ghost Bookings
                if (result.ghosts && result.ghosts.length > 0) {
                    setGhostBookings(result.ghosts);
                    setShowGhostAlert(true); // Trigger alert modal
                    addLog(`üëª WARNING: ${result.ghosts.length} ghost bookings detected (no sales owner or no stage)`);
                } else {
                    setGhostBookings([]);
                    setShowGhostAlert(false);
                }

                setBaseData(data);
                setView('dashboard');
            };

            // --- ‚úÑ LIVE SYNC IMPLEMENTATION ---
            
            // Google Sheet configuration - now uses saved URL from settings
            const getSavedSheetConfig = () => {
                const savedUrl = localStorage.getItem('stap_google_sheet_url');
                if (savedUrl) {
                    const sheetIdMatch = savedUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    const gidMatch = savedUrl.match(/gid=(\d+)/);
                    if (sheetIdMatch) {
                        return {
                            sheetId: sheetIdMatch[1],
                            gid: gidMatch ? gidMatch[1] : '0'
                        };
                    }
                }
                // Default fallback
                return {
                    sheetId: "1m02U3lviYB0W4Cqt77J-_0s4XwVBu-fGZXFfpawJqjM",
                    gid: "57794332"
                };
            };
            
            const sheetConfig = getSavedSheetConfig();
            const SHEET_ID = sheetConfig.sheetId;
            const SHEET_GID = sheetConfig.gid;
            
            // Using the 'export' endpoint
            const GOOGLE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

            const handleLiveSync = async () => {
                setProcessing(true);
                clearLogs();
                addLog("üöÄ Starting Live Sync sequence...");
                
                // Get fresh config in case it was updated
                const config = getSavedSheetConfig();
                const googleUrl = `https://docs.google.com/spreadsheets/d/${config.sheetId}/export?format=csv&gid=${config.gid}`;
                
                addLog(`üìã Sheet ID: ${config.sheetId.substring(0, 10)}...`);
                addLog(`üìã Tab GID: ${config.gid}`);
                addLog("üìã Strategy: Google Sheet ‚Üí Fallback to Persisted CSV");

                // List of proxies to try in order
                const gateways = [
                    { name: "Primary (AllOrigins)", url: `https://api.allorigins.win/raw?url=${encodeURIComponent(googleUrl)}` },
                    { name: "Backup 1 (CorsProxy)", url: `https://corsproxy.io/?${encodeURIComponent(googleUrl)}` },
                    { name: "Backup 2 (CodeTabs)",  url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(googleUrl)}` }
                ];

                let syncSuccess = false;

                try {
                    let csvText = null;

                    // Loop through gateways until one works
                    for (const gateway of gateways) {
                        try {
                            addLog(`üîÑ Connecting via ${gateway.name}...`);
                            const response = await fetch(gateway.url);
                            
                            if (response.ok) {
                                const text = await response.text();
                                // Validation: Ensure it's not an HTML error page
                                if (text && !text.trim().startsWith("<!DOCTYPE") && !text.includes("<html")) {
                                    csvText = text;
                                    addLog(`‚úÖ Success via ${gateway.name}!`);
                                    break; // Stop looping, we got the data
                                } else {
                                    addLog(`‚ö†Ô∏è ${gateway.name} returned HTML (Auth Error). Skipping...`);
                                }
                            } else {
                                addLog(`‚ö†Ô∏è ${gateway.name} HTTP ${response.status}. Skipping...`);
                            }
                        } catch (e) {
                            addLog(`‚ö†Ô∏è ${gateway.name} Error: ${e.message}`);
                        }
                    }

                    if (csvText) {
                        addLog(`üì¶ Payload received: ${csvText.length} bytes`);
                        
                        const rawMergedData = parseCSV(csvText);
                        addLog(`üìä CSV Parsed: ${rawMergedData.length} rows found`);

                        if (rawMergedData.length === 0) throw new Error("Parsed data is empty.");

                        // Debug: Verify we see the 'End' header now
                        const headers = Object.keys(rawMergedData[0]).join(", ").toLowerCase();
                        if (headers.includes("end")) {
                            addLog("‚úÖ 'End' column confirmed.");
                        } else {
                            addLog("‚ö†Ô∏è WARNING: 'End' column NOT found in headers.");
                        }

                        // Process Data from Google Sheet
                        addLog("‚öôÔ∏è Processing Google Sheet data...");
                        runProcessingLogic(rawMergedData, rawMergedData);
                        
                        // Update data source tracking
                        setDataSource({
                            type: 'google_sheet',
                            timestamp: new Date().toISOString(),
                            error: null,
                            rowCount: rawMergedData.length
                        });
                        
                        addLog("‚úÖ Live Sync Complete!");
                        syncSuccess = true;
                    } else {
                        throw new Error("All gateways failed to fetch Google Sheet.");
                    }

                } catch (error) {
                    console.error('Live sync error:', error);
                    addLog(`‚ùå Google Sheet sync failed: ${error.message}`);
                    
                    // ============================================
                    // SMART FALLBACK: Try persisted CSV data
                    // ============================================
                    addLog("üîÑ Attempting fallback to persisted CSV data...");
                    
                    try {
                        const persistedData = localStorage.getItem('stap_csv_data');
                        if (persistedData) {
                            const parsed = JSON.parse(persistedData);
                            if ((parsed.holds?.length > 0) || (parsed.installs?.length > 0)) {
                                addLog(`üìÇ Found persisted data: ${parsed.holds?.length || 0} holds, ${parsed.installs?.length || 0} installs`);
                                
                                // Use persisted data
                                setBaseData(parsed);
                                setDataSource({
                                    type: 'persisted_csv',
                                    timestamp: new Date().toISOString(),
                                    error: error.message,
                                    fallback: true
                                });
                                
                                addLog("‚úÖ Fallback successful! Using persisted CSV data.");
                                addLog("‚ÑπÔ∏è Note: Data may be outdated. Try Live Sync again when connection is stable.");
                                syncSuccess = true;
                            } else {
                                addLog("‚ö†Ô∏è No persisted CSV data available for fallback.");
                            }
                        } else {
                            addLog("‚ö†Ô∏è No persisted CSV data found in localStorage.");
                        }
                    } catch (fallbackError) {
                        addLog(`‚ùå Fallback also failed: ${fallbackError.message}`);
                    }
                    
                    if (!syncSuccess) {
                        setDataSource({
                            type: 'error',
                            timestamp: new Date().toISOString(),
                            error: error.message
                        });
                        alert("Sync Failed and no fallback data available. Please upload a CSV file manually.");
                    }
                } finally {
                    setProcessing(false);
                }
            };
            // ----------------------------------

            const processData = async () => {
                setProcessing(true);
                await new Promise(r => setTimeout(r, 800));

                try {
                    let rawHolds = [], rawInstalls = [];

                    if (files.install) {
                        const text = await files.install.text();
                        rawInstalls = parseCSV(text);
                    }

                    if (files.holds) {
                        const text = await files.holds.text();
                        rawHolds = parseCSV(text);
                    }
                    
                    runProcessingLogic(rawHolds, rawInstalls);
                    
                    // Track data source as CSV upload
                    setDataSource({
                        type: 'csv_upload',
                        timestamp: new Date().toISOString(),
                        error: null,
                        files: {
                            holds: files.holds?.name || null,
                            install: files.install?.name || null
                        },
                        rowCount: rawHolds.length + rawInstalls.length
                    });

                } catch (e) {
                    alert("Error processing files: " + e.message);
                    setDataSource({
                        type: 'error',
                        timestamp: new Date().toISOString(),
                        error: e.message
                    });
                } finally {
                    setProcessing(false);
                }
            };

            const loadDemo = async () => {
                setProcessing(true);
                await new Promise(r => setTimeout(r, 1000)); // Fake loading for effect
                const mockData = generateMockData();
                runProcessingLogic(mockData.holds, mockData.installs);
                setProcessing(false);
            };

            const generatePipelineInsight = async (allCampaigns) => {
                setIsInsightLoading(true);

                // --- 1. FETCH LIVE WEATHER ---
                let weatherData = [];
                let weatherContext = "Weather data unavailable.";
                let weatherRisk = "unknown";
                try {
                    weatherData = await fetchLiveWeather('Los Angeles, CA');
                    const next3Days = weatherData.slice(0, 3);
                    const maxRain = Math.max(...next3Days.map(d => d.rainChance));
                    const avgTemp = Math.round(next3Days.reduce((s, d) => s + d.temp, 0) / 3);
                    const rainDays = next3Days.filter(d => d.rainChance > 50).map(d => d.day).join(', ');
                    
                    if (maxRain > 85) {
                        weatherContext = `üö® CRITICAL: Heavy rain (${maxRain}% chance) expected${rainDays ? ` on ${rainDays}` : ''}. Recommend halting field installs.`;
                        weatherRisk = "critical";
                    } else if (maxRain > 60) {
                        weatherContext = `‚ö†Ô∏è CAUTION: Moderate rain risk (${maxRain}%)${rainDays ? ` on ${rainDays}` : ''}. Plan indoor work or backup dates.`;
                        weatherRisk = "warning";
                    } else if (maxRain > 30) {
                        weatherContext = `‚òÅÔ∏è WATCH: Some rain possible (${maxRain}%). Monitor conditions.`;
                        weatherRisk = "watch";
                    } else {
                        weatherContext = `‚úÖ CLEAR: Favorable conditions (${avgTemp}¬∞F, ${maxRain}% rain chance). Full operations OK.`;
                        weatherRisk = "good";
                    }
                } catch (e) {
                    console.error('Weather fetch failed:', e);
                }

                // --- 2. Calculate Holiday Risk ---
                const today = new Date();
                const nextHoliday = UPCOMING_HOLIDAYS.find(h => {
                    let hDate = new Date(h.date + " " + today.getFullYear());
                    if (hDate < today) hDate.setFullYear(today.getFullYear() + 1);
                    const diffDays = (hDate - today) / (1000 * 60 * 60 * 24);
                    return diffDays >= 0 && diffDays <= 14;
                });
                
                const holidayContext = nextHoliday 
                    ? `üìÖ ALERT: '${nextHoliday.name}' (${nextHoliday.type}) in <14 days. Crew availability may be reduced.` 
                    : "‚úÖ No immediate holiday constraints.";

                // --- 3. CALCULATE THIS WEEK'S METRICS (MAIN FOCUS) ---
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                // Calculate week bounds (Monday to Sunday)
                const dayOfWeek = now.getDay();
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const thisMonday = new Date(now); thisMonday.setDate(now.getDate() + diffToMonday); thisMonday.setHours(0,0,0,0);
                const thisSunday = new Date(thisMonday); thisSunday.setDate(thisMonday.getDate() + 6); thisSunday.setHours(23,59,59,999);
                
                // Also calculate Sunday-start week for "Installed This Week" logic
                const startOfFormulaWeek = new Date(now);
                startOfFormulaWeek.setDate(now.getDate() - now.getDay());
                startOfFormulaWeek.setHours(0,0,0,0);
                
                // For removals this week
                const nextWeekEnd = new Date(thisSunday); nextWeekEnd.setDate(thisSunday.getDate() + 7);

                const metrics = {
                    // THIS WEEK FOCUS
                    thisWeekInstalls: { total: 0, done: 0, inProgress: 0, notStarted: 0, campaigns: [] },
                    thisWeekRemovals: { total: 0, qty: 0, campaigns: [] },
                    
                    // HOLDS
                    holds: { count: 0, qty: 0, campaigns: [] },
                    
                    // BACKLOG (past due)
                    backlog: { count: 0, qty: 0, campaigns: [] },
                    
                    // INCOMING (Material Ready)
                    incoming: { count: 0, qty: 0 },
                    
                    // Stage breakdown
                    byStage: {}
                };

                const safeCampaigns = allCampaigns || [];
                const completedStages = ['Installed', 'Photos Taken', 'POP Completed'];
                const inProgressStages = ['Material Ready For Install'];
                const holdStages = ['Pending Hold', 'On Hold'];

                safeCampaigns.forEach(c => {
                    const stage = (c.stage || '').trim();
                    const stageLower = stage.toLowerCase();
                    const qty = parseFloat(c.quantity) || parseFloat(c.totalQty) || 0;
                    
                    let startDate = c.dateObj;
                    if (!startDate && c.date) startDate = new Date(c.date);
                    
                    let endDate = c.endDateObj;
                    if (!endDate && c.endDate) endDate = new Date(c.endDate);

                    // Track by stage
                    if (!metrics.byStage[stage]) metrics.byStage[stage] = { qty: 0, count: 0 };
                    metrics.byStage[stage].qty += qty;
                    metrics.byStage[stage].count++;

                    // --- THIS WEEK INSTALLS ---
                    // Campaigns scheduled to start this week OR in progress this week
                    if (startDate && startDate >= thisMonday && startDate <= thisSunday) {
                        metrics.thisWeekInstalls.total++;
                        metrics.thisWeekInstalls.campaigns.push({ 
                            advertiser: c.advertiser, 
                            stage: stage,
                            qty: qty,
                            market: c.market
                        });
                        
                        if (completedStages.includes(stage)) {
                            metrics.thisWeekInstalls.done++;
                        } else if (inProgressStages.includes(stage) || stageLower.includes('material ready')) {
                            metrics.thisWeekInstalls.inProgress++;
                        } else {
                            metrics.thisWeekInstalls.notStarted++;
                        }
                    }
                    
                    // Also count campaigns installed this week (Sunday-start week, stage = Installed)
                    if (stageLower === 'installed' && startDate && startDate >= startOfFormulaWeek) {
                        // Already counted above if within Mon-Sun, but capture any Sunday installs
                        if (startDate < thisMonday) {
                            metrics.thisWeekInstalls.done++;
                        }
                    }

                    // --- REMOVALS THIS WEEK (end dates) ---
                    if (endDate && endDate >= thisMonday && endDate <= thisSunday) {
                        metrics.thisWeekRemovals.total++;
                        metrics.thisWeekRemovals.qty += qty;
                        metrics.thisWeekRemovals.campaigns.push({
                            advertiser: c.advertiser,
                            endDate: c.endDate,
                            qty: qty
                        });
                    }

                    // --- HOLDS ---
                    if (holdStages.includes(stage)) {
                        metrics.holds.count++;
                        metrics.holds.qty += qty;
                        metrics.holds.campaigns.push({
                            advertiser: c.advertiser,
                            market: c.market,
                            qty: qty
                        });
                    }

                    // --- BACKLOG (Past Due) ---
                    if (startDate && startDate < now && !completedStages.includes(stage) && !holdStages.includes(stage) && stage !== 'Canceled' && stage !== 'Lost Opportunity') {
                        if (stageLower.includes('material ready') || stageLower.includes('proofs') || stageLower.includes('artwork') || stageLower.includes('contracted')) {
                            metrics.backlog.count++;
                            metrics.backlog.qty += qty;
                            metrics.backlog.campaigns.push({
                                advertiser: c.advertiser,
                                stage: stage,
                                date: c.date,
                                qty: qty
                            });
                        }
                    }

                    // --- INCOMING (Material Ready for Install) ---
                    if (stageLower === 'material ready for install') {
                        metrics.incoming.count++;
                        metrics.incoming.qty += qty;
                    }
                });

                // Calculate completion rate for this week
                const completionRate = metrics.thisWeekInstalls.total > 0 
                    ? Math.round((metrics.thisWeekInstalls.done / metrics.thisWeekInstalls.total) * 100) 
                    : 0;

                // Get top advertisers in backlog
                const backlogSummary = metrics.backlog.campaigns.length > 0
                    ? metrics.backlog.campaigns.slice(0, 3).map(c => `${c.advertiser} (${c.stage})`).join(', ')
                    : 'None';

                // --- 4. EXECUTIVE PROMPT FOR THIS WEEK'S OPERATIONS ---
                const prompt = `You are the Senior Director of Operations at Vector Media, an out-of-home advertising company. Generate a focused operational briefing for THIS WEEK's install activity.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÖ THIS WEEK'S INSTALLS (${thisMonday.toLocaleDateString()} - ${thisSunday.toLocaleDateString()})
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä INSTALL STATUS:
‚Ä¢ Total Scheduled: ${metrics.thisWeekInstalls.total} campaigns
‚Ä¢ ‚úÖ Completed: ${metrics.thisWeekInstalls.done} campaigns (${completionRate}% done)
‚Ä¢ üîÑ In Progress (Material Ready): ${metrics.thisWeekInstalls.inProgress} campaigns
‚Ä¢ ‚è≥ Not Started: ${metrics.thisWeekInstalls.notStarted} campaigns

üì¶ INCOMING QUEUE:
‚Ä¢ Material Ready to Install: ${metrics.incoming.count} campaigns / ${metrics.incoming.qty} units

üóëÔ∏è REMOVALS THIS WEEK:
‚Ä¢ Campaigns Ending: ${metrics.thisWeekRemovals.total} campaigns / ${metrics.thisWeekRemovals.qty} units

‚è∏Ô∏è ON HOLD:
‚Ä¢ ${metrics.holds.count} campaigns / ${metrics.holds.qty} units currently on hold
${metrics.holds.count > 0 ? '‚Ä¢ Top holds: ' + metrics.holds.campaigns.slice(0, 3).map(c => c.advertiser).join(', ') : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è EXTERNAL RISK FACTORS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${weatherContext}
${holidayContext}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã BACKLOG CHECK (Past Due - Review for Accuracy)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ ${metrics.backlog.count} campaigns with past start dates still not installed
${metrics.backlog.count > 0 ? '‚Ä¢ Examples: ' + backlogSummary : '‚Ä¢ ‚úÖ No concerning backlog'}
Note: Some may be data sync issues - recommend spot-checking these records.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã GENERATE OPERATIONAL BRIEFING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

As the Senior Director, provide a concise 4-6 sentence operational briefing covering:

1. **This Week's Progress** - How are we tracking? (${completionRate}% complete, ${metrics.thisWeekInstalls.total - metrics.thisWeekInstalls.done} remaining)
2. **Weather/Holiday Impact** - ${weatherRisk === 'critical' || weatherRisk === 'warning' ? 'IMPORTANT: Address the weather risk!' : 'Any scheduling concerns?'}
3. **Flow Balance** - ${metrics.incoming.count} incoming vs ${metrics.thisWeekRemovals.total} removals - what does this mean for crew capacity?
4. **Holds Status** - ${metrics.holds.count > 0 ? 'We have ' + metrics.holds.count + ' campaigns on hold. Any action needed?' : 'No holds - good.'}
5. **Backlog Note** - ${metrics.backlog.count > 3 ? 'Flag the backlog items that may need data cleanup' : 'Backlog looks manageable'}

Be direct, use the specific numbers provided, and focus on actionable insights for THIS WEEK. No fluff.`;

                try {
                    const text = await callGroq(prompt, 1500);
                    setPipelineInsight(text);
                } catch (e) {
                    setPipelineInsight("Analysis unavailable. Please check API configuration.");
                } finally {
                    setIsInsightLoading(false);
                }
            };

            // ADDED: Helper to format dates for display in the Title
            const formatDateShort = (d) => `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;

            const processedData = useMemo(() => {
                // This logic runs whenever baseData OR manualOverrides changes
                const categories = {
                    pastDue: [], thisWeek: [], nextMonth: [], upcoming: [], recentInstalls: [], 
                    pipelineSummary: [], activeInstalls: [], lostOpportunities: [], specialMedia: [], all: [], 
                    masterTracking: [], sixMonthHistory: [], inProgressFlights: [], delayedFlights: [],
                    fullyInstalledThisWeek: [], rotations: [], expiredFlights: [],
                    holdReport: [], // Simple pipeline view
                    ghostBookings: [], // Ghost bookings
                    materialReadyFuture: [], // Material Ready with future start dates
                    onHoldCampaigns: [] // Campaigns specifically on hold (Pending Hold / On Hold stage)
                };
                const pipelineCounts = {}; 
                
                // Map for Aggregating Expired Flights (Deduplication) - RESTORED
                const expiredMap = new Map(); 

                const today = new Date(); today.setHours(0,0,0,0);
                
                // Excluded stages for Hold Report
                const HOLD_EXCLUDED_STAGES = ['installed', 'material ready for install', 'photos taken', 'pop completed', 'takedown complete'];
                
                // Hold stages
                const HOLD_STAGES = ['pending hold', 'on hold'];
                
                // Helper Dates for In-Progress Flights Logic
                const twoMonthsAgo = new Date(today); twoMonthsAgo.setMonth(today.getMonth() - 2);
                const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(today.getDate() - 7);
                
                // Helper Date for Installed This Week (Sunday start)
                const startOfFormulaWeek = new Date(today);
                startOfFormulaWeek.setDate(today.getDate() - today.getDay());
                
                // --- NEW: ROTATION LOGIC HELPERS (UPDATED) ---
                // User Requirement: "No past dates, only current and upcoming (til year end)"
                const endOfYear = new Date(today.getFullYear(), 11, 31);
                endOfYear.setHours(23, 59, 59, 999);
                
                // Update: Include the full current posting week (starting Sunday)
                // e.g., if today is Mon 12/9, we want to see rotations that started Sun 12/8
                const startOfPostingWeek = new Date(today);
                startOfPostingWeek.setDate(today.getDate() - today.getDay()); // Go back to Sunday
                startOfPostingWeek.setHours(0, 0, 0, 0);
                
                // --- STRICT EXPIRED FLIGHTS LOGIC üí° (Per Spreadsheet Formula) ---
                const currentDay = today.getDay(); // 0-6
                const distanceToMonday = currentDay === 0 ? 6 : currentDay - 1;
                
                const currentMonday = new Date(today);
                currentMonday.setDate(today.getDate() - distanceToMonday);
                currentMonday.setHours(0,0,0,0); // Normalize time

                const expiredStartCutoff = new Date(currentMonday);
                expiredStartCutoff.setDate(currentMonday.getDate() - 45);
                expiredStartCutoff.setHours(0,0,0,0); // Normalize time
                
                // Expose these for title display
                categories.expiredRangeStart = formatDateShort(expiredStartCutoff);
                categories.expiredRangeEnd = formatDateShort(currentMonday);
                // -------------------------------------------------------------
                
                // --- NEW DELAYED FLIGHTS HELPER DATES ---
                const startOfCurrentWeekMonday = new Date(currentMonday); 
                const delayedLookbackDate = new Date(today);
                delayedLookbackDate.setMonth(today.getMonth() - 2);
                // ------------------------------------------

                const rotationKeywords = [
                    "the rideshare amigo", "jacob emrani", "boren law", 
                    "los angeles department of transportation", "call jacob", 
                    "adriana's insuranc", "la care", "filler"
                ];

                // 1. Install Report is used ONLY for lookup map in processHoldReport.
                
                // 2. Specialty Media - ALSO CHECK FOR GHOSTS
                if (baseData.specialtyHolds) {
                    baseData.specialtyHolds.forEach(item => {
                        const newItem = { ...item };
                        
                        // Reconvert dates from localStorage strings
                        if (newItem.dateObj && !(newItem.dateObj instanceof Date)) {
                            newItem.dateObj = new Date(newItem.dateObj);
                        }
                        if (newItem.endDateObj && !(newItem.endDateObj instanceof Date)) {
                            newItem.endDateObj = new Date(newItem.endDateObj);
                        }
                        if (!newItem.dateObj && newItem.date) {
                            newItem.dateObj = new Date(newItem.date);
                        }
                        
                        // üëª Collect ghosts from specialty items too
                        if (newItem.isGhost) {
                            categories.ghostBookings.push(newItem);
                            if (!includeGhosts) return; // Skip from specialty view if excluding
                        }
                        
                        // MODIFIED: Check composite key for extended overrides
                        const uniqueKey = `${newItem.id}_${newItem.date}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            if (override.stage) {
                                newItem.stage = override.stage;
                                newItem.isOverridden = true;
                            }
                            if (override.installed !== undefined) {
                                newItem.totalInstalled = override.installed;
                                newItem.installed = override.installed;
                                const totalQty = newItem.totalQty || newItem.quantity || 0;
                                newItem.pending = Math.max(0, totalQty - override.installed);
                                newItem.isOverridden = true;
                            }
                            if (override.productionProof) {
                                newItem.productionProof = override.productionProof;
                                newItem.isOverridden = true;
                            }
                        }
                        categories.specialMedia.push(newItem);
                    });
                }
                
                // 3. Lost Opportunities - ALSO CHECK FOR GHOSTS
                if (baseData.lost) {
                    baseData.lost.forEach(item => {
                        const newItem = { ...item };
                        
                        // Reconvert dates from localStorage strings
                        if (newItem.dateObj && !(newItem.dateObj instanceof Date)) {
                            newItem.dateObj = new Date(newItem.dateObj);
                        }
                        if (newItem.endDateObj && !(newItem.endDateObj instanceof Date)) {
                            newItem.endDateObj = new Date(newItem.endDateObj);
                        }
                        if (!newItem.dateObj && newItem.date) {
                            newItem.dateObj = new Date(newItem.date);
                        }
                        
                        // üëª Collect ghosts from lost items too
                        if (newItem.isGhost) {
                            categories.ghostBookings.push(newItem);
                        }
                        
                        // MODIFIED: Check composite key for extended overrides
                        const uniqueKey = `${newItem.id}_${newItem.date}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            if (override.stage) {
                                newItem.stage = override.stage;
                                newItem.isOverridden = true;
                            }
                            if (override.installed !== undefined) {
                                newItem.totalInstalled = override.installed;
                                newItem.installed = override.installed;
                                newItem.isOverridden = true;
                            }
                            if (override.productionProof) {
                                newItem.productionProof = override.productionProof;
                                newItem.isOverridden = true;
                            }
                        }
                        categories.lostOpportunities.push(newItem);
                    });
                }
                
                // 4. Dashboard / Pipeline (THE MAIN SOURCE LOOP)
                if (baseData.holds) {
                    // Helper Dates
                    const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay()); 
                    const dayOfWeek = today.getDay();
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    const thisMonday = new Date(today); thisMonday.setDate(today.getDate() + diffToMonday);
                    const thisSunday = new Date(thisMonday); thisSunday.setDate(thisMonday.getDate() + 6);
                    const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                    const weekday2 = dayOfWeek === 0 ? 7 : dayOfWeek; 
                    const nextWeekStart = new Date(today); nextWeekStart.setDate(today.getDate() - weekday2 + 8);
                    const nextWeekEnd = new Date(nextWeekStart); nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                    const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const recentLookbackDate = new Date(firstDayCurrentMonth); recentLookbackDate.setDate(firstDayCurrentMonth.getDate() - 7);
                    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const nextMonthStartPipeline = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    const lookbackDate = new Date(today); lookbackDate.setMonth(today.getMonth() - 14);

                    baseData.holds.forEach(originalItem => {
                        const item = { ...originalItem };
                        
                        // IMPORTANT: Reconvert dates from localStorage strings back to Date objects
                        if (item.dateObj && !(item.dateObj instanceof Date)) {
                            item.dateObj = new Date(item.dateObj);
                        }
                        if (item.endDateObj && !(item.endDateObj instanceof Date)) {
                            item.endDateObj = new Date(item.endDateObj);
                        }
                        if (item.productEndDateObj && !(item.productEndDateObj instanceof Date)) {
                            item.productEndDateObj = new Date(item.productEndDateObj);
                        }
                        if (item.programEndDateObj && !(item.programEndDateObj instanceof Date)) {
                            item.programEndDateObj = new Date(item.programEndDateObj);
                        }
                        // Fallback: create dateObj from date string if missing
                        if (!item.dateObj && item.date) {
                            item.dateObj = new Date(item.date);
                        }
                        if (!item.endDateObj && item.endDate) {
                            item.endDateObj = new Date(item.endDate);
                        }
                        
                        // üëª GHOST FILTER: Skip ghosts from main views unless explicitly included
                        if (item.isGhost) {
                            categories.ghostBookings.push(item);
                            if (!includeGhosts) return; // Skip from other categories
                        }
                        
                        // MODIFIED: Check composite key for extended manual overrides
                        const uniqueKey = `${item.id}_${item.date}`;
                        const override = manualOverrides[uniqueKey];
                        if (override) {
                            // Apply stage override
                            if (override.stage) {
                                item.stage = override.stage;
                                item.isOverridden = true;
                            }
                            // Apply installed count override
                            if (override.installed !== undefined) {
                                item.totalInstalled = override.installed;
                                item.installed = override.installed;
                                // Recalculate pending
                                const totalQty = item.totalQty || item.quantity || 0;
                                item.pending = Math.max(0, totalQty - override.installed);
                                // Update progress
                                if (totalQty > 0) {
                                    const pct = Math.round((override.installed / totalQty) * 100);
                                    item.progress = `${override.installed}/${totalQty} (${pct}%)`;
                                }
                                item.isOverridden = true;
                            }
                            // Apply pending override (if explicitly set)
                            if (override.pending !== undefined) {
                                item.pending = override.pending;
                                item.isOverridden = true;
                            }
                            // Apply notes
                            if (override.notes) {
                                item.overrideNotes = override.notes;
                            }
                            // Apply production proof override
                            if (override.productionProof) {
                                item.productionProof = override.productionProof;
                                item.isOverridden = true;
                            }
                        }

                        // INJECT EMAIL STATS
                        item.emailSentCount = emailStats[uniqueKey] || 0;

                        const stageLower = (item.stage || '').toLowerCase().trim();
                        const advName = (item.rawName || item.name || '').toLowerCase();
                        const campId = (item.id || '').toLowerCase();

                        // Skip Lost Opportunities to separate list
                        if (stageLower === 'lost opportunity' || stageLower === '- none -') {
                             categories.lostOpportunities.push(item);
                             return;
                        }
                        
                        // Empty stage rows go to Ghost Bookings - needs attention
                        if (!stageLower || stageLower === '') {
                            item.isGhost = true;
                            item.ghostReason = 'No Stage';
                            item.stage = 'No Stage'; // Set display value
                            categories.ghostBookings.push(item);
                            return; // Skip from other operational views
                        }
                        
                        // Empty product rows go to Ghost Bookings - needs attention
                        const productValue = (item.product || item.media || '').trim();
                        if (!productValue) {
                            item.isGhost = true;
                            item.ghostReason = 'No Product';
                            categories.ghostBookings.push(item);
                            return; // Skip from other operational views
                        }

                        // --- PRIMARY LIST POPULATION ---
                        categories.all.push(item);
                        
                        // Active Installs: Only stages that are ACTIVELY being worked on
                        // Installed (partially done) or Material Ready (ready to install)
                        const isActiveWorkStage = ['installed', 'material ready for install'].includes(stageLower);
                        if (isActiveWorkStage && item.pending > 0) {
                            categories.activeInstalls.push(item); 
                        }
                        
                        // üìã HOLD REPORT: Everything EXCEPT completed stages (unless pending > 0)
                        if (!HOLD_EXCLUDED_STAGES.includes(stageLower) || item.pending > 0) {
                            categories.holdReport.push(item);
                        }
                        
                        // ‚è∏Ô∏è ON HOLD CAMPAIGNS: Specifically Pending Hold or On Hold stage
                        if (HOLD_STAGES.includes(stageLower)) {
                            categories.onHoldCampaigns.push(item);
                        }
                        
                        // 6-Month History
                        const sixMonthsAgo = new Date(today); sixMonthsAgo.setMonth(today.getMonth() - 6);
                        if (item.dateObj >= sixMonthsAgo && item.dateObj <= today) {
                            categories.sixMonthHistory.push(item);
                        }

                        // --- FULLY INSTALLED THIS WEEK ü•á ---
                        // Show campaigns with stage "Installed" that STARTED this week
                        // Uses Product Start Date only
                        if (stageLower === 'installed') {
                            const isWarnerPerms = advName.includes("warner bros. | perms | stap");
                            
                            if (!isWarnerPerms && item.dateObj >= startOfFormulaWeek && item.dateObj <= today) {
                                categories.fullyInstalledThisWeek.push(item);
                            }
                        }

                        // --- IN-PROGRESS FLIGHTS LOGIC üöÄ ---
                        // Material Ready + past start date = actively being installed
                        // Lookback: 4 weeks for reasonable visibility
                        const isFiller = advName.includes('filler');
                        const isMaterialReady = stageLower === 'material ready for install';
                        const hasStarted = item.dateObj <= today;
                        
                        const inProgressLookback = new Date(today);
                        inProgressLookback.setDate(today.getDate() - 28); // 4 weeks
                        const isWithinInProgressWindow = item.dateObj >= inProgressLookback;
                        
                        if (isMaterialReady && !isFiller && hasStarted && isWithinInProgressWindow) {
                            categories.inProgressFlights.push(item);
                        }
                        
                        // --- MATERIAL READY - FUTURE üì¶ ---
                        // Material Ready but start date is in the future (upcoming installs)
                        if (isMaterialReady && !isFiller && item.dateObj > today) {
                            categories.materialReadyFuture.push(item);
                        }
                        
                        // --- ROTATIONS LOGIC üîÅ ---
                        const isRotationAdvertiser = rotationKeywords.some(k => advName.includes(k));
                        
                        if (isRotationAdvertiser) {
                            if (item.dateObj >= startOfPostingWeek && item.dateObj <= endOfYear) {
                                categories.rotations.push(item);
                            }
                        }
                        
                        // --- DELAYED / AT RISK FLIGHTS üî• ---
                        // Shows campaigns that are past their start date but not completed
                        // Lookback: 3 weeks - balances visibility with manageable list size
                        const isExcludedDelay = advName.includes("warner bros. | perms") ||
                                                advName.includes("adriana's insurance") ||
                                                campId.includes("filler campaign") ||
                                                isFiller;
                        
                        const isCompletedStage = ['installed', 'photos taken', 'pop completed', 'takedown complete', 'canceled', 'lost opportunity'].includes(stageLower);
                        const isPastStartDate = item.dateObj < today;
                        
                        // Lookback: 3 weeks (21 days) for delayed flights
                        const delayedLookback = new Date(today);
                        delayedLookback.setDate(today.getDate() - 21);
                        const isWithinDelayedWindow = item.dateObj >= delayedLookback;
                        
                        if (!isExcludedDelay && !isCompletedStage && isPastStartDate && isWithinDelayedWindow) {
                            categories.delayedFlights.push(item);
                        }

                        // --- PAST DUE (all older backlog - everything older than 3 weeks) ---
                        // Non-overlapping with Delayed Flights (which covers last 3 weeks)
                        const isExcludedPastDue = advName.includes("filler") || campId.includes("filler campaign");
                        const isOlderThanDelayedWindow = item.dateObj < delayedLookback; // Older than 3 weeks, no upper limit
                        
                        if (!isExcludedPastDue && !isCompletedStage && isPastStartDate && isOlderThanDelayedWindow) {
                            categories.pastDue.push(item);
                        }

                        // --- STRICT EXPIRED LOGIC + DEDUPLICATION (RESTORED) ---
                        // Only show INSTALLED campaigns - these are the ones that need physical removal
                        // Filter: End Date in last 45 days AND stage is Installed/Photos Taken/POP Completed
                        const isInstalledStage = ['installed', 'photos taken', 'pop completed'].includes(stageLower);
                        
                        if (item.endDateObj && isInstalledStage) {
                            const compEndDate = new Date(item.endDateObj);
                            compEndDate.setHours(0,0,0,0);

                            if (compEndDate >= expiredStartCutoff && compEndDate <= currentMonday) {
                                // Deduplicate Key: ID + Start Date + End Date
                                const key = `${item.id}|${item.date}|${item.endDate}`;
                                
                                if (expiredMap.has(key)) {
                                    const entry = expiredMap.get(key);
                                    // Merge Quantities
                                    entry.quantity += (item.quantity || 0);
                                    entry.totalInstalled += (item.totalInstalled || 0);
                                    
                                    // Indicate mixed media if strictly different
                                    if (entry.media !== item.media && !entry.media.includes('Mixed')) {
                                        entry.media = 'Mixed Media / Various'; 
                                    }
                                } else {
                                    // Clone specific for this map to avoid polluting other lists
                                    expiredMap.set(key, { ...item });
                                }
                            }
                        }
                        // -------------------------------------

                        if (item.dateObj >= thisMonday && item.dateObj <= thisSunday) { categories.thisWeek.push(item); }
                        if (item.dateObj >= nextMonthStart && item.dateObj <= nextMonthEnd) { categories.nextMonth.push(item); }
                        
                        // UPCOMING
                        if (item.dateObj >= nextWeekStart && item.dateObj <= nextWeekEnd && item.stage && !stageLower.includes('canceled')) {
                            categories.upcoming.push(item);
                        }

                        // Recent Installs: Stage='Installed' with start date in last 30 days
                        if (stageLower === 'installed') {
                            const thirtyDaysAgo = new Date(today);
                            thirtyDaysAgo.setDate(today.getDate() - 30);
                            
                            // Filter by Product Start Date within last 30 days
                            if (item.dateObj >= thirtyDaysAgo && item.dateObj <= today) {
                                categories.recentInstalls.push(item);
                            }
                        }
                        
                        // PIPELINE SUMMARY: Count campaigns by stage for CURRENT MONTH only
                        // Timeline-based view of what's happening this month
                        // Excludes: Lost Opportunities (already filtered above)
                        if (item.dateObj >= currentMonthStart && item.dateObj < nextMonthStartPipeline) {
                            const s = item.stage || 'Unknown';
                            pipelineCounts[s] = (pipelineCounts[s] || 0) + 1;
                        }
                    });
                    
                    // Finalize Expired List from Map (RESTORED)
                    categories.expiredFlights = Array.from(expiredMap.values());
                    
                    // Build Pipeline Summary from all counted stages
                    categories.pipelineSummary = Object.entries(pipelineCounts)
                        .map(([stage, count]) => ({ stage, count }))
                        .sort((a, b) => b.count - a.count);
                }

                categories.pastDue.sort((a, b) => a.dateObj - b.dateObj);
                categories.recentInstalls.sort((a, b) => b.dateObj - a.dateObj); // Most recent start date first
                categories.masterTracking.sort((a,b) => b.dateObj - a.dateObj);
                categories.sixMonthHistory.sort((a,b) => b.dateObj - a.dateObj);
                categories.inProgressFlights.sort((a,b) => b.dateObj - a.dateObj);
                categories.delayedFlights.sort((a,b) => a.dateObj - b.dateObj);
                categories.fullyInstalledThisWeek.sort((a,b) => a.dateObj - b.dateObj);
                categories.rotations.sort((a,b) => a.dateObj - b.dateObj); 
                categories.expiredFlights.sort((a,b) => a.endDateObj - b.endDateObj); // Sort by End Date ascending
                categories.holdReport.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending
                categories.ghostBookings.sort((a,b) => a.dateObj - b.dateObj); // Sort ghosts by date
                categories.materialReadyFuture.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending
                categories.onHoldCampaigns.sort((a,b) => a.dateObj - b.dateObj); // Sort by Start Date ascending

                // 2. Master Tracking: Everything EXCEPT Lost Opportunities and Ghosts (unless included)
                if (baseData.installs) {
                    categories.masterTracking = [...baseData.installs].filter(i => {
                        // Exclude ghosts unless explicitly included
                        if (i.isGhost && !includeGhosts) return false;
                        // Exclude Lost Opportunities
                        const stageLower = (i.stage || '').toLowerCase().trim();
                        if (stageLower === 'lost opportunity' || stageLower === '- none -') return false;
                        return true;
                    });
                    // Ensure sorting consistency
                    categories.masterTracking.sort((a,b) => b.dateObj - a.dateObj);
                }

                return categories;
            }, [baseData, manualOverrides, emailStats, includeGhosts]);

            // Extract unique markets and products for filters
            const filterOptions = useMemo(() => {
                if (!processedData?.all) return { markets: [], products: [], marketGroups: MARKET_GROUPS, productGroups: PRODUCT_GROUPS };
                
                const marketSet = new Set();
                const productSet = new Set();
                
                processedData.all.forEach(item => {
                    if (item.market) marketSet.add(item.market);
                    if (item.product || item.media) productSet.add(item.product || item.media);
                });
                
                return {
                    markets: Array.from(marketSet).sort(),
                    products: Array.from(productSet).sort(),
                    marketGroups: MARKET_GROUPS,
                    productGroups: PRODUCT_GROUPS
                };
            }, [processedData]);
            
            // Handle adding/removing filter chips
            const addFilter = (type, value) => {
                if (type === 'market') {
                    if (!marketFilters.includes(value)) {
                        setMarketFilters(prev => [...prev, value]);
                    }
                } else {
                    if (!productFilters.includes(value)) {
                        setProductFilters(prev => [...prev, value]);
                    }
                }
            };
            
            const removeFilter = (type, value) => {
                if (type === 'market') {
                    setMarketFilters(prev => prev.filter(f => f !== value));
                } else {
                    setProductFilters(prev => prev.filter(f => f !== value));
                }
            };
            
            const clearAllFilters = () => {
                setMarketFilters([]);
                setProductFilters([]);
            };

            // Filtered stats for dashboard cards - waterfall effect
            const filteredStats = useMemo(() => {
                if (!processedData) return null;
                
                // If no filters active, return original processedData
                if (marketFilters.length === 0 && productFilters.length === 0 && productionFilter === 'ALL') {
                    return processedData;
                }
                
                // Helper: Check if item matches any selected market filter
                const itemMatchesMarket = (item) => {
                    if (marketFilters.length === 0) return true;
                    
                    return marketFilters.some(filter => {
                        // Check if filter is a group
                        if (MARKET_GROUPS[filter]) {
                            return MARKET_GROUPS[filter].some(city => 
                                item.market?.toLowerCase().includes(city.toLowerCase())
                            );
                        }
                        // Individual market match
                        return item.market === filter;
                    });
                };
                
                // Helper: Check if item matches any selected product filter
                const itemMatchesProduct = (item) => {
                    if (productFilters.length === 0) return true;
                    const itemProduct = item.product || item.media || '';
                    
                    return productFilters.some(filter => {
                        // Check if filter is a group
                        if (PRODUCT_GROUPS[filter]) {
                            return PRODUCT_GROUPS[filter].some(prod => 
                                itemProduct.toLowerCase().includes(prod.toLowerCase())
                            );
                        }
                        // Individual product match
                        return itemProduct === filter;
                    });
                };
                
                // Helper: Check if item matches production filter
                const itemMatchesProduction = (item) => {
                    if (productionFilter === 'ALL') return true;
                    if (productionFilter === 'unset') return !item.productionProof;
                    return item.productionProof === productionFilter;
                };
                
                // Helper function to filter an array
                const filterArray = (arr) => {
                    if (!arr || !Array.isArray(arr)) return arr;
                    return arr.filter(item => {
                        return itemMatchesMarket(item) && itemMatchesProduct(item) && itemMatchesProduction(item);
                    });
                };
                
                // Create filtered copy of all categories
                return {
                    ...processedData,
                    pastDue: filterArray(processedData.pastDue),
                    thisWeek: filterArray(processedData.thisWeek),
                    nextMonth: filterArray(processedData.nextMonth),
                    upcoming: filterArray(processedData.upcoming),
                    recentInstalls: filterArray(processedData.recentInstalls),
                    activeInstalls: filterArray(processedData.activeInstalls),
                    lostOpportunities: filterArray(processedData.lostOpportunities),
                    specialMedia: filterArray(processedData.specialMedia),
                    all: filterArray(processedData.all),
                    masterTracking: filterArray(processedData.masterTracking),
                    sixMonthHistory: filterArray(processedData.sixMonthHistory),
                    inProgressFlights: filterArray(processedData.inProgressFlights),
                    delayedFlights: filterArray(processedData.delayedFlights),
                    fullyInstalledThisWeek: filterArray(processedData.fullyInstalledThisWeek),
                    rotations: filterArray(processedData.rotations),
                    expiredFlights: filterArray(processedData.expiredFlights),
                    holdReport: filterArray(processedData.holdReport),
                    ghostBookings: filterArray(processedData.ghostBookings),
                    materialReadyFuture: filterArray(processedData.materialReadyFuture),
                    onHoldCampaigns: filterArray(processedData.onHoldCampaigns),
                    pipelineSummary: processedData.pipelineSummary // Keep pipeline summary as-is (it's aggregated)
                };
            }, [processedData, marketFilters, productFilters, productionFilter]);

            const filteredData = useMemo(() => {
                if (!filteredStats) return [];
                
                // Use view-specific data - filters are already applied via filteredStats
                let activeSet = [];
                if (view === 'master') { activeSet = filteredStats.masterTracking; } 
                else if (view === 'dashboard') { 
                    // Show recent activity: recent installs + this week + upcoming, sorted by date desc
                    const recentInstalls = filteredStats.recentInstalls || [];
                    const thisWeek = filteredStats.thisWeek || [];
                    const upcoming = filteredStats.upcoming || [];
                    const inProgress = filteredStats.inProgressFlights || [];
                    
                    // Combine and deduplicate by unique key (id + date)
                    const seen = new Set();
                    const combined = [];
                    [...recentInstalls, ...inProgress, ...thisWeek, ...upcoming].forEach(item => {
                        const key = `${item.id}_${item.date}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            combined.push(item);
                        }
                    });
                    
                    // Sort by date descending (most recent first)
                    activeSet = combined.sort((a, b) => {
                        const dateA = a.dateObj || new Date(a.date);
                        const dateB = b.dateObj || new Date(b.date);
                        return dateB - dateA;
                    }).slice(0, 100); // Limit to 100 most recent
                } 
                else if (view === 'pipelineSummary') { return filteredStats.pipelineSummary; } 
                else if (view === 'history') { activeSet = filteredStats.sixMonthHistory; }
                else if (view === 'lostOpportunities') { activeSet = filteredStats.lostOpportunities; }
                else if (view === 'specialMedia') { activeSet = filteredStats.specialMedia; }
                else if (view === 'inProgressFlights') { activeSet = filteredStats.inProgressFlights; }
                else if (view === 'delayedFlights') { activeSet = filteredStats.delayedFlights; }
                else if (view === 'fullyInstalledThisWeek') { activeSet = filteredStats.fullyInstalledThisWeek; }
                else if (view === 'rotations') { activeSet = filteredStats.rotations; }
                else if (view === 'expiredFlights') { activeSet = filteredStats.expiredFlights; }
                else if (view === 'holdReport') { activeSet = filteredStats.holdReport; }
                else if (view === 'onHoldCampaigns') { activeSet = filteredStats.onHoldCampaigns; }
                else if (view === 'ghostBookings') { activeSet = filteredStats.ghostBookings; }
                else if (view === 'materialReadyFuture') { activeSet = filteredStats.materialReadyFuture; }
                else if (view === 'pastDue') { activeSet = filteredStats.pastDue; }
                else if (view === 'recentInstalls') { activeSet = filteredStats.recentInstalls; }
                else if (view === 'activeInstalls') { activeSet = filteredStats.activeInstalls; }
                else if (view === 'upcoming') { activeSet = filteredStats.upcoming; }
                else if (view === 'thisWeek') { activeSet = filteredStats.thisWeek; }
                else if (view === 'nextMonth') { activeSet = filteredStats.nextMonth; }
                else if (view.startsWith('custom_')) {
                    // Custom widget view - apply the widget's filters
                    const widget = customWidgets.find(w => w.id === view);
                    if (widget) {
                        let filtered = [...(filteredStats.all || [])];
                        
                        if (widget.stages?.length > 0) {
                            filtered = filtered.filter(d => widget.stages.includes(d.stage));
                        }
                        if (widget.owners?.length > 0) {
                            filtered = filtered.filter(d => widget.owners.includes(d.owner));
                        }
                        if (widget.products?.length > 0) {
                            filtered = filtered.filter(d => widget.products.includes(d.product || d.media));
                        }
                        if (widget.installStatus === 'fully') {
                            filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                        } else if (widget.installStatus === 'partial') {
                            filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                        } else if (widget.installStatus === 'notStarted') {
                            filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                        }
                        
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        if (widget.dateLogic === 'startingNext7') {
                            const next7 = new Date(today);
                            next7.setDate(today.getDate() + 7);
                            filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                        } else if (widget.dateLogic === 'endingNext7') {
                            const next7 = new Date(today);
                            next7.setDate(today.getDate() + 7);
                            filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                        } else if (widget.dateLogic === 'longRunning') {
                            filtered = filtered.filter(d => {
                                if (!d.dateObj || !d.endDateObj) return false;
                                return (d.endDateObj - d.dateObj) / (1000*60*60*24) > 30;
                            });
                        }
                        
                        if (widget.volumeFilter === 'high50') {
                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                        } else if (widget.volumeFilter === 'low10') {
                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                        }
                        
                        activeSet = filtered;
                    } else {
                        activeSet = [];
                    }
                }
                else { activeSet = filteredStats[view] || []; }
                
                // 1. Text Search Filter
                let result = activeSet;
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    result = result.filter(item => 
                        item.name.toLowerCase().includes(lower) || 
                        item.advertiser.toLowerCase().includes(lower) || 
                        item.id.toLowerCase().includes(lower) ||
                        (item.stage || '').toLowerCase().includes(lower) ||
                        (item.product || item.media || '').toLowerCase().includes(lower)
                    );
                }

                // 2. Date Range Filter (Global)
                if (dateFilter.start || dateFilter.end) {
                    const startDate = dateFilter.start ? new Date(dateFilter.start) : null;
                    const endDate = dateFilter.end ? new Date(dateFilter.end) : null;
                    // Determine which date to filter on (expired flights use End Date, others Start Date)
                    const keyToUse = view === 'expiredFlights' ? 'endDateObj' : 'dateObj';
                    
                    result = result.filter(item => {
                        const itemDate = item[keyToUse];
                        if (!itemDate) return false;
                        if (startDate && itemDate < startDate) return false;
                        if (endDate && itemDate > endDate) return false;
                        return true;
                    });
                }

                // 3. Global Date Sort
                // Default logic: This week first? Or purely chronological?
                // User asked for "filter dates up or down" -> implying simple Asc/Desc toggle.
                // We will respect the 'dateSort' state ('asc' or 'desc')
                const keyToUse = view === 'expiredFlights' ? 'endDateObj' : 'dateObj';
                
                result.sort((a, b) => {
                    const dateA = a[keyToUse] || new Date(0);
                    const dateB = b[keyToUse] || new Date(0);
                    
                    if (dateSort === 'asc') {
                        return dateA - dateB;
                    } else {
                        return dateB - dateA;
                    }
                });

                return result;
            }, [filteredStats, view, searchTerm, dateFilter, dateSort, customWidgets]);

            const toggleSort = () => {
                setDateSort(prev => prev === 'asc' ? 'desc' : 'asc');
            };

            const clearDateFilters = () => {
                setDateFilter({ start: '', end: '' });
                setDateSort('asc');
                setMarketFilters([]);
                setProductFilters([]);
            };

            if (view === 'upload') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 md:p-6">
                        {/* üëª GHOST BOOKING ALERT MODAL */}
                        {showGhostAlert && ghostBookings.length > 0 && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
                                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-scale-in">
                                    <div className="px-6 py-4 bg-orange-500 text-white flex items-center gap-3">
                                        <Icon name="AlertTriangle" size={24} />
                                        <h3 className="font-bold text-lg">üëª Ghost Bookings Detected</h3>
                                    </div>
                                    <div className="p-6">
                                        <p className="text-gray-700 mb-4">
                                            <strong>{ghostBookings.length} bookings</strong> have no sales owner or no stage assigned. 
                                            These need attention in Salesforce before being tracked.
                                        </p>
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4 max-h-40 overflow-y-auto">
                                            {ghostBookings.slice(0, 5).map((g, i) => (
                                                <div key={i} className="text-sm py-1 border-b border-orange-100 last:border-0 flex justify-between">
                                                    <span><span className="font-mono text-orange-700">{g.id}</span> - {g.advertiser}</span>
                                                    <span className="text-xs text-orange-500">{g.ghostReason || 'Unknown'}</span>
                                                </div>
                                            ))}
                                            {ghostBookings.length > 5 && (
                                                <div className="text-xs text-orange-600 pt-2">...and {ghostBookings.length - 5} more</div>
                                            )}
                                        </div>
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => { setShowGhostAlert(false); setView('ghostBookings'); }}
                                                className="flex-1 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition-colors"
                                            >
                                                Review Ghost Bookings
                                            </button>
                                            <button 
                                                onClick={() => { setShowGhostAlert(false); setIncludeGhosts(false); }}
                                                className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors"
                                            >
                                                Exclude & Continue
                                            </button>
                                        </div>
                                        <button 
                                            onClick={() => { setShowGhostAlert(false); setIncludeGhosts(true); }}
                                            className="w-full mt-2 py-2 text-sm text-gray-500 hover:text-gray-700"
                                        >
                                            Include anyway (not recommended)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="max-w-2xl w-full bg-white rounded-xl shadow-lg p-5 mb-4">
                            <div className="text-center mb-4">
                                {/* Added onClick and cursor-pointer to the H1 */}
                                <h1 
                                    onClick={handleSecretMode}
                                    className="text-2xl font-bold mb-1 text-gray-900 cursor-pointer select-none"
                                    title="v3.0 - Single Source of Truth - Click 5 times for Dev Mode"
                                >
                                    Los Angeles Ops<span className="bg-gradient-to-r from-pink-500 to-yellow-500 bg-clip-text text-transparent">Hub Vector Media</span>
                                </h1>
                                <p className="text-gray-500 text-sm">Dashboard & Master Tracking Portal</p>
                                <span className="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">
                                    v3.0
                                </span>
                            </div>

                            {/* --- LIVE SYNC BUTTON --- */}
                            <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-100 text-center">
                                <button 
                                    onClick={handleLiveSync}
                                    disabled={processing}
                                    className={`w-full max-w-sm mx-auto py-2.5 rounded-lg text-white font-bold flex items-center justify-center gap-2 transition-all shadow-sm ${processing ? 'bg-blue-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    {processing ? <><Icon name="RefreshCw" size={18} className="animate-spin" /> Syncing...</> : <><Icon name="Cloud" size={18} /> Sync Live Data</>}
                                </button>
                                <p className="text-xs text-blue-600 mt-1.5">Google Sheet ‚Üí Cached fallback</p>
                            </div>

                            {/* --- RESTORE PREVIOUS SESSION (if persisted data exists) --- */}
                            {baseData.holds?.length > 0 && (
                                <div className={`mb-4 p-3 rounded-lg border ${storageWarning ? 'bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200' : 'bg-gradient-to-r from-purple-50 to-indigo-50 border-purple-200'}`}>
                                    <div className="flex items-center justify-between gap-3">
                                        <div className="flex items-center gap-2 min-w-0">
                                            <div className={`p-1.5 rounded-lg flex-shrink-0 ${storageWarning ? 'bg-amber-100' : 'bg-purple-100'}`}>
                                                <Icon name={storageWarning ? "AlertTriangle" : "Database"} size={16} className={storageWarning ? 'text-amber-600' : 'text-purple-600'} />
                                            </div>
                                            <div className="min-w-0">
                                                <h4 className={`font-bold text-sm ${storageWarning ? 'text-amber-900' : 'text-purple-900'}`}>
                                                    {storageWarning ? 'Session (Limited)' : 'Previous Session'}
                                                </h4>
                                                <p className={`text-xs truncate ${storageWarning ? 'text-amber-600' : 'text-purple-600'}`}>
                                                    {baseData.holds.length.toLocaleString()} campaigns
                                                    {dataSource.timestamp && ` ‚Ä¢ ${new Date(dataSource.timestamp).toLocaleDateString()}`}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-1.5 flex-shrink-0">
                                            <button 
                                                onClick={() => {
                                                    setView('dashboard');
                                                    setDataSource(prev => ({ ...prev, type: 'persisted_csv', autoRestored: true }));
                                                }}
                                                className={`px-3 py-1.5 text-white rounded-lg font-bold text-xs transition-colors flex items-center gap-1.5 ${storageWarning ? 'bg-amber-600 hover:bg-amber-700' : 'bg-purple-600 hover:bg-purple-700'}`}
                                            >
                                                <Icon name="Play" size={12} /> Resume
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    if (confirm('Clear all cached data?')) {
                                                        handleResetData(true);
                                                    }
                                                }}
                                                className="p-1.5 bg-white text-red-500 border border-red-200 rounded-lg hover:bg-red-50 transition-colors"
                                                title="Clear cache"
                                            >
                                                <Icon name="Trash2" size={12} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- ‚úÑ DEBUG CONSOLE UI (Hidden by Default) --- */}
                            {showDebug && (
                                <div className="mb-4 border border-gray-800 bg-gray-900 rounded-lg overflow-hidden shadow-inner animate-fade-in">
                                    <div className="bg-gray-800 px-3 py-1.5 flex justify-between items-center border-b border-gray-700">
                                        <span className="text-xs font-mono text-gray-400 font-bold uppercase">Terminal</span>
                                        <button onClick={clearLogs} className="text-xs text-gray-500 hover:text-white">Clear</button>
                                    </div>
                                    <div className="p-3 h-24 overflow-y-auto font-mono text-xs space-y-0.5">
                                        {debugLogs.length === 0 ? (
                                            <span className="text-gray-600 italic">Waiting...</span>
                                        ) : (
                                            debugLogs.map((log, i) => (
                                                <div key={i} className={`${log.includes('ERROR') ? 'text-red-400' : log.includes('‚úÖ') ? 'text-green-400' : log.includes('üëª') ? 'text-orange-400' : 'text-gray-300'}`}>
                                                    {log}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* --- MANUAL UPLOAD SECTION (SINGLE FILE) --- */}
                            <div className="relative border-t border-gray-200 pt-4">
                                <span className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    Manual Upload
                                </span>
                                <div className="mb-3">
                                    <FileUploader 
                                        title="üìä Master Tracking Export" 
                                        onFileSelect={(f) => setFiles({ holds: f, install: f })} 
                                        status={files.holds ? 'done' : 'waiting'} 
                                    />
                                </div>
                                <button onClick={processData} disabled={!files.holds || processing} className="w-full py-2 rounded-lg bg-gray-800 text-white font-bold text-sm hover:bg-gray-900 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Process File <Icon name="ArrowRight" size={16} />
                                </button>
                            </div>
                            
                            {/* Footer with demo link and dedication */}
                            <div className="mt-4 pt-3 border-t border-gray-100 flex items-center justify-between">
                                <button onClick={loadDemo} className="text-xs font-medium text-gray-400 hover:text-gray-600 underline">Load Demo</button>
                                <p className="text-xs text-gray-400">Made with üíô for Charting</p>
                            </div>
                        </div>

                        <div className="max-w-2xl w-full grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-2"><WeatherWidget /></div>
                            <div><HolidaysWidget /></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex font-sans bg-gray-50 text-gray-900">
                    <Sidebar 
                        view={view} 
                        setView={setView} 
                        onReset={handleResetData} 
                        onOpenDigest={() => setIsDigestModalOpen(true)}
                        onOpenImpressions={() => setIsImpressionsModalOpen(true)}
                        onResetEmailLogs={handleResetEmailLogs}
                        onOpenSheetSettings={() => setShowSheetSettings(true)}
                        onLogout={onLogout}
                        ghostCount={processedData?.ghostBookings?.length || 0}
                        isCollapsed={sidebarCollapsed}
                        setIsCollapsed={setSidebarCollapsed}
                    />
                    <DetailModal 
                        item={selectedItem} 
                        onClose={() => setSelectedItem(null)} 
                        onSave={handleUpdateStage} 
                        onLogEmail={handleLogEmail}
                    />
                    <GoogleSheetSettingsModal
                        isOpen={showSheetSettings}
                        onClose={() => setShowSheetSettings(false)}
                        currentSheetUrl={localStorage.getItem('stap_google_sheet_url') || ''}
                        onSave={(url) => {
                            addLog(`üîß Google Sheet URL updated`);
                        }}
                    />
                    <CustomizeModal 
                        isOpen={isCustomizeModalOpen} 
                        onClose={() => setIsCustomizeModalOpen(false)}
                        visibleKeys={visibleStatKeys}
                        onToggle={handleToggleStat}
                        onReset={handleResetStats}
                        cardConfig={STAT_CARD_CONFIG}
                        activeFilters={{ markets: marketFilters, products: productFilters }}
                        onClearFilters={clearAllFilters}
                        customWidgets={customWidgets}
                        onAddWidget={() => { setEditingWidget(null); setIsCustomWidgetModalOpen(true); }}
                        onEditWidget={(widget) => { setEditingWidget(widget); setIsCustomWidgetModalOpen(true); }}
                        onDeleteWidget={(id) => { if(confirm('Delete this widget?')) setCustomWidgets(prev => prev.filter(w => w.id !== id)); }}
                    />
                    <DigestModal 
                        isOpen={isDigestModalOpen} 
                        onClose={() => setIsDigestModalOpen(false)}
                        processedData={processedData}
                        filterOptions={filterOptions}
                        currentMarket={marketFilters.length > 0 ? marketFilters[0] : 'Los Angeles, CA'}
                    />
                    <ImpressionsModal
                        isOpen={isImpressionsModalOpen}
                        onClose={() => setIsImpressionsModalOpen(false)}
                    />
                    <CustomWidgetModal
                        isOpen={isCustomWidgetModalOpen}
                        onClose={() => { setIsCustomWidgetModalOpen(false); setEditingWidget(null); }}
                        onSave={(widget) => {
                            if (editingWidget) {
                                setCustomWidgets(prev => prev.map(w => w.id === widget.id ? widget : w));
                            } else {
                                setCustomWidgets(prev => [...prev, widget]);
                            }
                        }}
                        editWidget={editingWidget}
                        allData={processedData?.all || []}
                    />
                    
                    <div 
                        className={`flex-1 flex flex-col transition-all duration-500 ease-in-out ${sidebarCollapsed ? 'main-content-collapsed' : 'main-content-expanded'}`}
                    >
                        {/* Demo Mode Banner - Only visible in Demo Mode */}
                        {isDemoMode && (
                            <div className="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 text-white px-4 py-2.5 flex items-center justify-between text-sm shadow-lg">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full">
                                        <span className="text-lg">üéì</span>
                                        <span className="font-bold">Demo Mode</span>
                                    </div>
                                    <span className="text-purple-100 text-xs hidden sm:inline">
                                        Explore features with sample data ‚Ä¢ Purple highlights show key areas
                                    </span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => setShowWelcomeModal(true)}
                                        className="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg font-medium transition-colors flex items-center gap-1.5"
                                        title="Show welcome guide"
                                    >
                                        <Icon name="HelpCircle" size={14} />
                                        <span className="hidden sm:inline">Help</span>
                                    </button>
                                    <button 
                                        onClick={() => setShowDemoTips(!showDemoTips)}
                                        className={`text-xs px-3 py-1.5 rounded-lg font-medium transition-colors flex items-center gap-1.5 ${
                                            showDemoTips 
                                                ? 'bg-amber-400 text-amber-900 hover:bg-amber-300' 
                                                : 'bg-white/10 hover:bg-white/20'
                                        }`}
                                        title={showDemoTips ? 'Hide guide panel' : 'Show guide panel'}
                                    >
                                        <Icon name={showDemoTips ? 'Eye' : 'EyeOff'} size={14} />
                                        <span className="hidden sm:inline">Guide {showDemoTips ? 'ON' : 'OFF'}</span>
                                    </button>
                                    <button 
                                        onClick={onLogout}
                                        className="text-xs bg-white/20 hover:bg-red-500 px-3 py-1.5 rounded-lg font-medium transition-colors flex items-center gap-1.5"
                                    >
                                        <Icon name="LogOut" size={14} />
                                        Exit
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <header className="bg-white border-b border-gray-200 px-8 py-4 flex flex-col sticky top-0 z-20 gap-3">
                            {/* Simplified header for Availability and Risk Analysis views */}
                            {(view === 'availability' || view === 'riskAnalysis') ? (
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            {view === 'availability' ? (
                                                <>
                                                    <span className="p-1.5 rounded-lg border-2 border-teal-500 bg-teal-50">
                                                        <Icon name="BarChart3" size={18} className="text-teal-600" />
                                                    </span>
                                                    Availability Charting
                                                </>
                                            ) : (
                                                <>
                                                    <span className="p-1.5 rounded-lg border-2 border-amber-500 bg-amber-50">
                                                        <Icon name="AlertTriangle" size={18} className="text-amber-600" />
                                                    </span>
                                                    Install Risk Center
                                                </>
                                            )}
                                        </h1>
                                        <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                            Use filters below
                                        </span>
                                    </div>
                                    <div className="relative w-64">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="Search" size={16} /></div>
                                        <input 
                                            type="text" 
                                            placeholder="Search campaigns..." 
                                            className="w-full pl-9 pr-4 py-1.5 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                </div>
                            ) : (
                            <>
                            {/* Top Row: Search + Filters */}
                            <div className="flex flex-col sm:flex-row items-center justify-between gap-3">
                                <div className="flex items-center gap-3 w-full max-w-md">
                                    <div className="relative w-full">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="Search" size={16} /></div>
                                        <input 
                                            type="text" 
                                            placeholder="Search..." 
                                            className="w-full pl-9 pr-4 py-1.5 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    {/* Filter count indicator */}
                                    {(marketFilters.length > 0 || productFilters.length > 0) && filteredStats && (
                                        <div className="flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-medium whitespace-nowrap">
                                            <Icon name="Filter" size={12} />
                                            <span>{filteredStats.all?.length || 0} results</span>
                                        </div>
                                    )}
                                    {/* Column Mapping Status */}
                                    {columnMappingInfo && (
                                        <div 
                                            className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap cursor-help ${
                                                columnMappingInfo.missingRequired.length > 0 
                                                    ? 'bg-amber-100 text-amber-700' 
                                                    : 'bg-green-100 text-green-700'
                                            }`}
                                            title={`Column Mapping: ${columnMappingInfo.matched}/${columnMappingInfo.total} matched\n\nMatched columns:\n${
                                                columnMappingInfo.mappingResults
                                                    .filter(r => r.found)
                                                    .map(r => `‚úì ${r.field} ‚Üí ${r.mappedTo}`)
                                                    .join('\n')
                                            }${columnMappingInfo.missingRequired.length > 0 ? '\n\nMissing required:\n' + columnMappingInfo.missingRequired.map(f => `‚úó ${f}`).join('\n') : ''}`}
                                        >
                                            <Icon name={columnMappingInfo.missingRequired.length > 0 ? "AlertTriangle" : "CheckCircle"} size={12} />
                                            <span>{columnMappingInfo.matched}/{columnMappingInfo.total} cols</span>
                                        </div>
                                    )}
                                    {/* Data Source Indicator */}
                                    {dataSource.type !== 'none' && (
                                        <div 
                                            className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap cursor-help ${
                                                storageWarning ? 'bg-red-100 text-red-700' :
                                                dataSource.type === 'google_sheet' ? 'bg-green-100 text-green-700' :
                                                dataSource.type === 'csv_upload' ? 'bg-blue-100 text-blue-700' :
                                                dataSource.type === 'persisted_csv' ? 'bg-amber-100 text-amber-700' :
                                                'bg-red-100 text-red-700'
                                            }`}
                                            title={`Data Source: ${
                                                dataSource.type === 'google_sheet' ? 'Live Google Sheet' :
                                                dataSource.type === 'csv_upload' ? 'CSV Upload' :
                                                dataSource.type === 'persisted_csv' ? 'Cached CSV (Fallback)' : 'Error'
                                            }\nLast sync: ${dataSource.timestamp ? new Date(dataSource.timestamp).toLocaleString() : 'N/A'}${
                                                dataSource.fallback ? '\n‚ö†Ô∏è Using fallback data - Google Sheet unavailable' : ''
                                            }${storageWarning ? '\n‚ö†Ô∏è ' + storageWarning : ''}${
                                                Object.keys(manualOverrides).length > 0 ? `\n‚úèÔ∏è ${Object.keys(manualOverrides).length} manual override(s) active` : ''
                                            }\n\nüìä ${processedData?.all?.length?.toLocaleString() || 0} total campaigns`}
                                        >
                                            <Icon name={
                                                storageWarning ? 'AlertTriangle' :
                                                dataSource.type === 'google_sheet' ? 'Wifi' :
                                                dataSource.type === 'csv_upload' ? 'FileSpreadsheet' :
                                                dataSource.type === 'persisted_csv' ? 'Database' : 'AlertCircle'
                                            } size={12} />
                                            <span>
                                                {storageWarning ? 'No Save' :
                                                 dataSource.type === 'google_sheet' ? 'Live' :
                                                 dataSource.type === 'csv_upload' ? 'CSV' :
                                                 dataSource.type === 'persisted_csv' ? 'Cached' : 'Error'}
                                            </span>
                                            {(dataSource.fallback || storageWarning) && <span className="text-amber-600">‚ö†</span>}
                                            {Object.keys(manualOverrides).length > 0 && (
                                                <span className="ml-1 px-1 bg-purple-200 text-purple-700 rounded text-[10px]">
                                                    +{Object.keys(manualOverrides).length}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* --- HEADER FILTERS --- */}
                                <div className="flex items-center gap-2 flex-wrap justify-end">
                                    {/* Market Filter Dropdown with Smart Groups */}
                                    <select 
                                        value=""
                                        onChange={(e) => {
                                            if (e.target.value) addFilter('market', e.target.value);
                                        }}
                                        className="text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100 border-gray-200"
                                        title="Add Market Filter"
                                    >
                                        <option value="">‚¨° Add Market</option>
                                        <optgroup label="üìç Regions">
                                            {Object.keys(MARKET_GROUPS).map(group => (
                                                <option key={group} value={group} disabled={marketFilters.includes(group)}>
                                                    {group}
                                                </option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="üìå Individual Markets">
                                            {filterOptions.markets.map(m => (
                                                <option key={m} value={m} disabled={marketFilters.includes(m)}>
                                                    {m.split(',')[0]}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                    
                                    {/* Product Filter Dropdown with Smart Groups */}
                                    <select 
                                        value=""
                                        onChange={(e) => {
                                            if (e.target.value) addFilter('product', e.target.value);
                                        }}
                                        className="text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100 border-gray-200"
                                        title="Add Product Filter"
                                    >
                                        <option value="">‚óà Add Product</option>
                                        <optgroup label="üì¶ Categories">
                                            {Object.keys(PRODUCT_GROUPS).map(group => (
                                                <option key={group} value={group} disabled={productFilters.includes(group)}>
                                                    {group}
                                                </option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="üìã Individual Products">
                                            {filterOptions.products.map(p => (
                                                <option key={p} value={p} disabled={productFilters.includes(p)}>
                                                    {p.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                    
                                    {/* Production Source Filter */}
                                    <select 
                                        value={productionFilter}
                                        onChange={(e) => setProductionFilter(e.target.value)}
                                        className={`text-xs font-medium border rounded-lg px-2 py-1.5 outline-none focus:ring-2 focus:ring-purple-500 ${
                                            productionFilter !== 'ALL' 
                                                ? 'bg-purple-100 border-purple-300 text-purple-700' 
                                                : 'bg-gray-100 border-gray-200'
                                        }`}
                                        title="Filter by Production Source"
                                    >
                                        <option value="ALL">‚åÇ Production: All</option>
                                        <option value="in-house">‚åÇ In-House Only</option>
                                        <option value="client">‚Üë Client Only</option>
                                        <option value="mixed">‚Üª Mixed Only</option>
                                        <option value="unset">? Not Set</option>
                                    </select>
                                    
                                    {/* Date Range */}
                                    <div className="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                                        <input 
                                            type="date" 
                                            className="bg-transparent text-xs font-medium text-gray-600 px-2 py-1 outline-none w-28"
                                            value={dateFilter.start}
                                            onChange={(e) => setDateFilter(prev => ({...prev, start: e.target.value}))}
                                            title="Start Date"
                                        />
                                        <span className="text-gray-400 text-xs">-</span>
                                        <input 
                                            type="date" 
                                            className="bg-transparent text-xs font-medium text-gray-600 px-2 py-1 outline-none w-28"
                                            value={dateFilter.end}
                                            onChange={(e) => setDateFilter(prev => ({...prev, end: e.target.value}))}
                                            title="End Date"
                                        />
                                    </div>
                                    
                                    {/* Sort Button */}
                                    <button 
                                        onClick={toggleSort} 
                                        className="p-1.5 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center justify-center"
                                        title={`Sort Dates ${dateSort === 'asc' ? 'Oldest to Newest' : 'Newest to Oldest'}`}
                                    >
                                        <Icon name={dateSort === 'asc' ? 'ArrowUp' : 'ArrowDown'} size={16} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* Filter Chips Bar */}
                            {(marketFilters.length > 0 || productFilters.length > 0 || productionFilter !== 'ALL') && (
                                <div className="flex items-center gap-2 flex-wrap">
                                    <span className="text-xs text-gray-500 font-medium">Active Filters:</span>
                                    
                                    {/* Market Chips */}
                                    {marketFilters.map(filter => (
                                        <span 
                                            key={`market-${filter}`}
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name="MapPin" size={12} />
                                            {filter}
                                            <button 
                                                onClick={() => removeFilter('market', filter)}
                                                className="ml-1 hover:bg-blue-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    ))}
                                    
                                    {/* Product Chips */}
                                    {productFilters.map(filter => (
                                        <span 
                                            key={`product-${filter}`}
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name="Package" size={12} />
                                            {filter.replace('Transit Shelter-', '').replace('Transit Shelters-', '')}
                                            <button 
                                                onClick={() => removeFilter('product', filter)}
                                                className="ml-1 hover:bg-purple-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    ))}
                                    
                                    {/* Production Filter Chip */}
                                    {productionFilter !== 'ALL' && (
                                        <span 
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium"
                                        >
                                            <Icon name={productionFilter === 'in-house' ? 'Home' : productionFilter === 'client' ? 'Upload' : productionFilter === 'mixed' ? 'RefreshCw' : 'HelpCircle'} size={12} />
                                            {productionFilter === 'in-house' ? 'In-House' : productionFilter === 'client' ? 'Client' : productionFilter === 'mixed' ? 'Mixed' : 'Not Set'}
                                            <button 
                                                onClick={() => setProductionFilter('ALL')}
                                                className="ml-1 hover:bg-purple-200 rounded-full p-0.5"
                                            >
                                                <Icon name="X" size={10} />
                                            </button>
                                        </span>
                                    )}
                                    
                                    {/* Clear All Button */}
                                    <button 
                                        onClick={() => { clearAllFilters(); setProductionFilter('ALL'); }}
                                        className="text-xs text-red-600 hover:text-red-700 hover:underline font-medium"
                                    >
                                        Clear All
                                    </button>
                                </div>
                            )}
                            </>
                            )}
                        </header>

                        <main className="p-8 flex-1 overflow-y-auto">
                            {/* --- VIEW SWITCHER --- */}
                            {view === 'riskAnalysis' ? (
                                <InstallationRiskCommandCenter allData={processedData?.all || []} />
                            ) : view === 'availability' ? (
                                <AvailabilityComponent allData={processedData.all} />
                            ) : (
                                <>
                                    {/* --- DASHBOARD VIEW --- */}
                                    {view === 'dashboard' && filteredStats && (
                                        <div>
                                            {/* Demo Tips for Dashboard - Only show in Demo Mode when NOT in live mode */}
                                            {isDemoMode && showDemoTips && !isLiveMode && (
                                                <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-3">
                                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                        <div className="font-bold text-blue-800 text-sm flex items-center gap-2 mb-1">
                                                            <span>üìä</span> Dashboard Cards
                                                        </div>
                                                        <div className="text-xs text-blue-700">
                                                            Click any stat card to filter the table. Colors indicate urgency: red = past due, amber = soon, green = on track.
                                                        </div>
                                                    </div>
                                                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                                        <div className="font-bold text-purple-800 text-sm flex items-center gap-2 mb-1">
                                                            <span>‚ú®</span> AI Insights
                                                        </div>
                                                        <div className="text-xs text-purple-700">
                                                            Click "AI Pipeline Insights" for smart analysis of your data. Identifies risks and suggests actions.
                                                        </div>
                                                    </div>
                                                    <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                                        <div className="font-bold text-green-800 text-sm flex items-center gap-2 mb-1">
                                                            <span>üìß</span> Email Digest
                                                        </div>
                                                        <div className="text-xs text-green-700">
                                                            Use sidebar "Email Digest" to send daily summaries to stakeholders. Fully customizable.
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div className="flex justify-between items-center mb-4">
                                                <h2 className="text-lg font-bold text-gray-800">Overview</h2>
                                                <div className="flex items-center gap-3">
                                                    {/* AI Pipeline Health Button */}
                                                    <button 
                                                        onClick={() => generatePipelineInsight(filteredStats.all)}
                                                        disabled={isInsightLoading}
                                                        className={`text-sm flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium transition-all ${isInsightLoading ? 'bg-gray-100 text-gray-400' : 'bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 hover:from-purple-200 hover:to-blue-200'}`}
                                                    >
                                                        <Icon name="Sparkles" size={16} className={isInsightLoading ? "animate-spin" : ""} />
                                                        {isInsightLoading ? "Analyzing..." : "AI Pipeline Insights"}
                                                    </button>
                                                    <button 
                                                        onClick={() => setIsCustomizeModalOpen(true)} 
                                                        className="text-sm flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium transition-colors"
                                                    >
                                                        <Icon name="Settings" size={16} /> Customize
                                                    </button>
                                                </div>
                                            </div>

                                            {/* AI Pipeline Insight Display - Executive Summary */}
                                            {pipelineInsight && (
                                                <div className="mb-6 p-5 bg-gradient-to-r from-purple-50 via-blue-50 to-indigo-50 border border-purple-200 rounded-xl relative shadow-sm">
                                                    <div className="flex items-start gap-4">
                                                        <div className="p-3 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl shadow-md text-white">
                                                            <Icon name="Sparkles" size={24} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <h4 className="text-base font-bold text-purple-900">Executive Briefing</h4>
                                                                <span className="text-xs bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full font-medium">AI-Generated</span>
                                                            </div>
                                                            <div className="text-sm text-gray-700 leading-relaxed whitespace-pre-line prose prose-sm max-w-none">
                                                                {pipelineInsight.split('\n').map((line, i) => {
                                                                    // Format bold text
                                                                    const formattedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                                                    // Check for bullet points or numbered lists
                                                                    if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-') || /^\d+\./.test(line.trim())) {
                                                                        return <p key={i} className="ml-4 my-1" dangerouslySetInnerHTML={{ __html: formattedLine }} />;
                                                                    }
                                                                    return <p key={i} className="my-1" dangerouslySetInnerHTML={{ __html: formattedLine }} />;
                                                                })}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => setPipelineInsight('')} className="text-gray-400 hover:text-gray-600 p-1">
                                                            <Icon name="X" size={18} />
                                                        </button>
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-purple-100 flex items-center justify-end">
                                                        <button 
                                                            onClick={() => generatePipelineInsight(filteredStats.all)}
                                                            className="text-xs text-purple-600 hover:text-purple-800 font-medium flex items-center gap-1"
                                                        >
                                                            <Icon name="RefreshCw" size={12} /> Refresh Analysis
                                                        </button>
                                                    </div>
                                                </div>
                                            )}

                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                                {/* Debug: Log what's being rendered */}
                                                {console.log('üéØ Dashboard rendering:', { 
                                                    visibleStatKeys, 
                                                    hasFilteredStats: !!filteredStats,
                                                    categories: filteredStats ? Object.keys(filteredStats).filter(k => Array.isArray(filteredStats[k]) && filteredStats[k].length > 0) : []
                                                })}
                                                {visibleStatKeys.map(key => {
                                                    const config = STAT_CARD_CONFIG[key];
                                                    let data = filteredStats[key];
                                                    
                                                    // Active Installs widget: limit to last 30 days
                                                    if (key === 'activeInstalls' && data) {
                                                        const today = new Date();
                                                        today.setHours(0,0,0,0);
                                                        const oneMonthAgo = new Date(today);
                                                        oneMonthAgo.setDate(today.getDate() - 30);
                                                        data = data.filter(i => i.dateObj >= oneMonthAgo);
                                                    }
                                                    
                                                    if (!config || !data) return null;
                                                    
                                                    // Installed widget: show sum of Qty (faces), not campaign count
                                                    let displayValue = data.length;
                                                    if (key === 'recentInstalls' && data) {
                                                        displayValue = data.reduce((sum, item) => sum + (item.quantity || item.totalQty || 0), 0);
                                                    }

                                                    return (
                                                        <StatCard 
                                                            key={key}
                                                            title={config.title} 
                                                            value={displayValue} 
                                                            subtitle={config.subtitle} 
                                                            color={config.color} 
                                                            icon={config.icon} 
                                                            onClick={() => setView(key)}
                                                        />
                                                    );
                                                })}
                                                
                                                {/* Custom Widgets */}
                                                {customWidgets.map(widget => {
                                                    // Calculate custom widget value
                                                    const getCustomWidgetData = () => {
                                                        let filtered = [...(filteredStats.all || [])];
                                                        
                                                        if (widget.stages?.length > 0) {
                                                            filtered = filtered.filter(d => widget.stages.includes(d.stage));
                                                        }
                                                        if (widget.owners?.length > 0) {
                                                            filtered = filtered.filter(d => widget.owners.includes(d.owner));
                                                        }
                                                        if (widget.products?.length > 0) {
                                                            filtered = filtered.filter(d => widget.products.includes(d.product || d.media));
                                                        }
                                                        if (widget.installStatus === 'fully') {
                                                            filtered = filtered.filter(d => (d.pending || 0) === 0 && (d.totalInstalled || d.installed || 0) > 0);
                                                        } else if (widget.installStatus === 'partial') {
                                                            filtered = filtered.filter(d => (d.pending || 0) > 0 && (d.totalInstalled || d.installed || 0) > 0);
                                                        } else if (widget.installStatus === 'notStarted') {
                                                            filtered = filtered.filter(d => (d.totalInstalled || d.installed || 0) === 0);
                                                        }
                                                        
                                                        const today = new Date();
                                                        today.setHours(0,0,0,0);
                                                        if (widget.dateLogic === 'startingNext7') {
                                                            const next7 = new Date(today);
                                                            next7.setDate(today.getDate() + 7);
                                                            filtered = filtered.filter(d => d.dateObj && d.dateObj >= today && d.dateObj <= next7);
                                                        } else if (widget.dateLogic === 'endingNext7') {
                                                            const next7 = new Date(today);
                                                            next7.setDate(today.getDate() + 7);
                                                            filtered = filtered.filter(d => d.endDateObj && d.endDateObj >= today && d.endDateObj <= next7);
                                                        } else if (widget.dateLogic === 'longRunning') {
                                                            filtered = filtered.filter(d => {
                                                                if (!d.dateObj || !d.endDateObj) return false;
                                                                return (d.endDateObj - d.dateObj) / (1000*60*60*24) > 30;
                                                            });
                                                        }
                                                        
                                                        if (widget.volumeFilter === 'high50') {
                                                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) >= 50);
                                                        } else if (widget.volumeFilter === 'low10') {
                                                            filtered = filtered.filter(d => (d.quantity || d.totalQty || 0) < 10);
                                                        }
                                                        
                                                        return filtered;
                                                    };
                                                    
                                                    const widgetData = getCustomWidgetData();
                                                    let displayValue = widgetData.length;
                                                    if (widget.displayValue === 'qty') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.quantity || d.totalQty || 0), 0);
                                                    } else if (widget.displayValue === 'pending') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.pending || 0), 0);
                                                    } else if (widget.displayValue === 'installed') {
                                                        displayValue = widgetData.reduce((sum, d) => sum + (d.totalInstalled || d.installed || 0), 0);
                                                    }
                                                    
                                                    return (
                                                        <div key={widget.id} className="relative">
                                                            <StatCard 
                                                                title={widget.title} 
                                                                value={displayValue} 
                                                                subtitle={widget.subtitle} 
                                                                color={widget.color} 
                                                                icon={widget.icon} 
                                                                onClick={() => setView(widget.id)}
                                                            />
                                                            {/* Custom widget indicator */}
                                                            <div className="absolute top-2 right-2">
                                                                <span className="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium">Custom</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* Dashboard view: CampaignTable inside dashboard container for alignment */}
                                            <CampaignTable 
                                                data={filteredData} 
                                                title={(marketFilters.length > 0 || productFilters.length > 0) ? 'Filtered Results' : 'Recent Activity'}
                                                onRowClick={setSelectedItem}
                                                dateLabel="Start Date"
                                                dateKey="date"
                                                view={view}
                                                onBack={() => setView('dashboard')}
                                            />
                                        </div>
                                    )}

                                    {/* --- DATA TABLES (Non-Dashboard Views) --- */}
                                    {view !== 'dashboard' && (
                                    (view === 'master' || view === 'activeInstalls' || view === 'history') ? (
                                        <MasterTrackingTable 
                                            data={filteredData} 
                                            onRowClick={setSelectedItem}
                                            onBack={() => setView('dashboard')}
                                            onOpenSettings={() => setShowSheetSettings(true)}
                                        />
                                    ) : view === 'pipelineSummary' ? (
                                        <PipelineSummaryTable data={filteredData} />
                                    ) : view === 'holdReport' ? (
                                        <HoldReportTable data={filteredData} onRowClick={setSelectedItem} onBack={() => setView('dashboard')} />
                                    ) : view === 'ghostBookings' ? (
                                        <GhostBookingsTable data={filteredData} onRowClick={setSelectedItem} onBack={() => setView('dashboard')} />
                                    ) : view === 'materialReceivers' ? (
                                        <MaterialReceivers 
                                            data={processedData.all} 
                                            onBack={() => setView('dashboard')} 
                                            setView={setView} 
                                            showDemoTips={isDemoMode && showDemoTips && !isLiveMode} 
                                            setIsLiveMode={setIsLiveMode}
                                            materials={materialReceiverData}
                                            setMaterials={setMaterialReceiverData}
                                            linkedSheet={materialReceiverLinkedSheet}
                                            setLinkedSheet={setMaterialReceiverLinkedSheet}
                                        />
                                    ) : view === 'popGallery' ? (
                                        <POPGallery data={processedData.all} onBack={() => setView('dashboard')} setView={setView} showDemoTips={isDemoMode && showDemoTips && !isLiveMode} />
                                    ) : view === 'performanceReport' ? (
                                        <PerformanceReport data={processedData.all} onBack={() => setView('dashboard')} setView={setView} showDemoTips={isDemoMode && showDemoTips && !isLiveMode} />
                                    ) : (
                                        <CampaignTable 
                                            data={filteredData} 
                                            title={
                                                // Show view-specific title, add filter indicator if filters active
                                                view === 'dashboard' ? ((marketFilters.length > 0 || productFilters.length > 0) ? 'Filtered Results üîç' : 'Recent Activity üìÖ') :
                                                view === 'thisWeek' ? 'Scheduled This Week' :
                                                view === 'nextMonth' ? 'Scheduled Next Month' :
                                                view === 'upcoming' ? 'Upcoming (Next 7 Days) üå§Ô∏è' :
                                                view === 'recentInstalls' ? 'Installed ‚úÖ (Last 30 Days)' :
                                                view === 'activeInstalls' ? 'Active Installs üî® (Last 30 Days)' :
                                                view === 'history' ? 'Install History (6 Months)' :
                                                view === 'lostOpportunities' ? 'Lost Opportunities' :
                                                view === 'specialMedia' ? 'Specialty Media Pipeline' :
                                                view === 'inProgressFlights' ? 'In-Progress Flights üöÄ (Material Ready - Last 4 Weeks)' :
                                                view === 'delayedFlights' ? 'Delayed / Overdue üî• (Last 3 Weeks)' :
                                                view === 'onHoldCampaigns' ? 'On Hold Campaigns ‚è∏Ô∏è' :
                                                view === 'fullyInstalledThisWeek' ? 'Installed This Week ü•á' :
                                                view === 'rotations' ? 'Rotations üîÅ' :
                                                view === 'materialReadyFuture' ? 'Material Ready üì¶' :
                                                view === 'expiredFlights' ? `Expired Flights üí° (${processedData.expiredRangeStart} - ${processedData.expiredRangeEnd})` :
                                                view === 'pastDue' ? 'Past Due ‚ö†Ô∏è (Older Backlog 3+ Weeks)' :
                                                view.startsWith('custom_') ? (customWidgets.find(w => w.id === view)?.title || 'Custom Widget') + ' ‚≠ê' :
                                                'Campaigns'
                                            } 
                                            onRowClick={setSelectedItem}
                                            dateLabel={view === 'expiredFlights' ? "End Date" : "Start Date"}
                                            dateKey={view === 'expiredFlights' ? "endDate" : "date"}
                                            view={view}
                                            onBack={() => setView('dashboard')}
                                        />
                                    ))}
                                </>
                            )}
                        </main>
                    </div>
                    
                    {/* Floating Demo/Live Mode Toggle - Bottom Right - Only visible in Demo Mode */}
                    {isDemoMode && (
                        <div className="fixed bottom-4 right-4 z-40 flex flex-col items-end gap-2">
                            {!isLiveMode ? (
                                <button 
                                    onClick={() => setShowDemoTips(!showDemoTips)}
                                    className={`px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-all shadow-lg ${
                                        showDemoTips 
                                            ? 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white' 
                                            : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50'
                                    }`}
                                    title={showDemoTips ? 'Hide Demo Tips' : 'Show Demo Tips'}
                                >
                                    <span>üéì</span>
                                    {showDemoTips ? 'Demo ON' : 'Demo OFF'}
                                </button>
                            ) : (
                                <div className="flex items-center gap-2">
                                    <span className="px-3 py-2 bg-green-500 text-white rounded-full text-xs font-bold flex items-center gap-2 shadow-lg">
                                        <span>‚úì</span> Live
                                    </span>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Welcome Modal - Shows on first demo entry */}
                    {isDemoMode && (
                        <DemoWelcomeModal 
                            isOpen={showWelcomeModal}
                            onClose={() => setShowWelcomeModal(false)}
                            onStartTour={() => {
                                // Optionally load demo data automatically
                                if (view === 'upload') {
                                    loadDemo();
                                }
                            }}
                        />
                    )}
                    
                    {/* Floating Demo Guide Panel - Only show in Demo Mode when NOT in live mode */}
                    {isDemoMode && !isLiveMode && !showWelcomeModal && (
                        <DemoGuidePanel 
                            isOpen={showDemoTips} 
                            onClose={() => setShowDemoTips(false)}
                            currentView={view}
                            onNavigate={(newView) => setView(newView)}
                        />
                    )}
                </div>
            );
        };

        // --- MASTER APPLICATION WRAPPER ---
        const App = () => {
            // Initialize user from localStorage (persist login across refreshes)
            const [user, setUser] = useState(() => {
                try {
                    const saved = localStorage.getItem('opshub_user');
                    return saved ? JSON.parse(saved) : null;
                } catch {
                    return null;
                }
            });
            
            // Demo mode state - separate from regular auth
            const [isDemoMode, setIsDemoMode] = useState(false);

            // Handle login - save to localStorage
            const handleLogin = (userData) => {
                setUser(userData);
                setIsDemoMode(false); // Regular login = no demo mode
                try {
                    localStorage.setItem('opshub_user', JSON.stringify(userData));
                } catch (e) {
                    console.warn('Could not save login to localStorage');
                }
            };
            
            // Handle demo mode - no auth required
            const handleDemoMode = () => {
                setUser({ email: 'demo@vectormedia.com', isDemo: true });
                setIsDemoMode(true);
            };

            // Handle logout - clear localStorage
            const handleLogout = () => {
                setUser(null);
                setIsDemoMode(false);
                try {
                    localStorage.removeItem('opshub_user');
                } catch (e) {
                    console.warn('Could not clear localStorage');
                }
            };

            // If not authenticated, show the Ghost Login
            if (!user) {
                return <LoginScreen onLogin={handleLogin} onDemoMode={handleDemoMode} />;
            }

            // If authenticated, show your original Dashboard
            return <AuthorizedDashboard onLogout={handleLogout} isDemoMode={isDemoMode} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>